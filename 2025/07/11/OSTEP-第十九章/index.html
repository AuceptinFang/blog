<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>OSTEP-第十九章 | Auceptin's Blog</title><meta name="author" content="Auceptin"><meta name="copyright" content="Auceptin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="本次作业要测算一下 TLB 的容量和访问 TLB 的开销。这个想法参考了 Saavedra-Barrera 的工作[SB92]，他设计了一个简单而漂亮的用户级程序，来测算缓存层级结构的方方面面。更多细节请阅读他的论文。 基本原理就是访问一个跨多个内存页的大尺寸数据结构（例如数组），然后统计访问时间。例如，假设一个机器的 TLB 大小为 4（这很小，但对这个讨论有用）。如果写一个程序访问 4 个或">
<meta property="og:type" content="article">
<meta property="og:title" content="OSTEP-第十九章">
<meta property="og:url" content="https://aucept.in/2025/07/11/OSTEP-%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0/index.html">
<meta property="og:site_name" content="Auceptin&#39;s Blog">
<meta property="og:description" content="本次作业要测算一下 TLB 的容量和访问 TLB 的开销。这个想法参考了 Saavedra-Barrera 的工作[SB92]，他设计了一个简单而漂亮的用户级程序，来测算缓存层级结构的方方面面。更多细节请阅读他的论文。 基本原理就是访问一个跨多个内存页的大尺寸数据结构（例如数组），然后统计访问时间。例如，假设一个机器的 TLB 大小为 4（这很小，但对这个讨论有用）。如果写一个程序访问 4 个或">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aucept.in/image/cover23_music.jpg">
<meta property="article:published_time" content="2025-07-11T00:55:59.000Z">
<meta property="article:modified_time" content="2025-07-11T04:33:51.074Z">
<meta property="article:author" content="Auceptin">
<meta property="article:tag" content="OSTEP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aucept.in/image/cover23_music.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "OSTEP-第十九章",
  "url": "https://aucept.in/2025/07/11/OSTEP-%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0/",
  "image": "https://aucept.in/image/cover23_music.jpg",
  "datePublished": "2025-07-11T00:55:59.000Z",
  "dateModified": "2025-07-11T04:33:51.074Z",
  "author": [
    {
      "@type": "Person",
      "name": "Auceptin",
      "url": "https://aucept.in/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aucept.in/2025/07/11/OSTEP-%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OSTEP-第十九章',
  isHighlightShrink: false,
  isToc: false,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-dracula.min.css" id="prism-light-theme"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-twilight.min.css" id="prism-dark-theme" disabled><style>
  /* 根据 Butterfly 主题切换代码高亮样式 */
  [data-theme="dark"] #prism-light-theme {
    display: none !important;
  }
  [data-theme="light"] #prism-dark-theme {
    display: block !important;
  }
  html:not([data-theme]) #prism-dark-theme {
    display: none !important;

  
  /* 数学公式美化样式 */
  .MathJax_Display {
    margin: 1.5em 0 !important;
    text-align: center !important;
  }
  
  .MathJax {
    font-size: 1.1em !important;
  }
  
  /* 行内公式样式 */
  .MathJax_Preview {
    color: inherit;
  }
  
  /* 块级公式容器美化 */
  .MathJax_Display {
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
    padding: 15px 20px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #49b1f5;
  }
  
  /* 暗色模式下的公式样式 */
  [data-theme="dark"] .MathJax_Display {
    background: rgba(255,255,255,0.05);
    border-left-color: #1f2937;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  
  /* 公式编号样式 */
  .MathJax .mjx-math .mjx-mrow .mjx-mtable .mjx-label {
    color: #666;
    font-size: 0.9em;
  }
  
  /* 提升公式清晰度 */
  .MathJax svg {
    max-width: 100% !important;
    height: auto !important;
  }
</style>
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Auceptin's Blog" type="application/atom+xml">
</head><body><div id="web_bg" style="background-color: #f5f5f5;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/auceptin-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><span> Friends</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/image/cover2_square.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Auceptin's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">OSTEP-第十九章</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><span> Friends</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">OSTEP-第十九章</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-11T00:55:59.000Z" title="发表于 2025-07-11 08:55:59">2025-07-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-11T04:33:51.074Z" title="更新于 2025-07-11 12:33:51">2025-07-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OSTEP/">OSTEP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p>本次作业要测算一下 TLB 的容量和访问 TLB 的开销。这个想法参考了 Saavedra-Barrera 的工作[SB92]，他设计了一个简单而漂亮的用户级程序，来测算缓存层级结构的方方面面。更多细节请阅读他的论文。</p>
<p>基本原理就是访问一个跨多个内存页的大尺寸数据结构（例如数组），然后统计访问时间。例如，假设一个机器的 TLB 大小为 4（这很小，但对这个讨论有用）。如果写一个程序访问 4 个或更少的页，每次访问都会命中 TLB，因此相对较快。但是，如果在一个循环里反复访问 5 个或者更多的页，每次访问的开销就会突然跃升，因为发生 TLB 未命中。</p>
<p><strong>问题</strong>：</p>
<ul>
<li>为了计时，可能需要一个计时器，例如gettimeofday()提供的。这种计时器的精度如何？操作要花多少时间，才能让你对它精确计时？</li>
<li>写一个程序，命名为tlb.c，大体测算一下每个页的平均访问时间。程序的输入参数有：页的数目和尝试的次数</li>
<li>用你喜欢的脚本语言写一段脚本来运行这个程序，当访问量从1增长到几千，也许每次迭代都乘2。在不同的机器上运行这段脚本，同时收集相应的数据。需要试多少次才能获得可信的测量结果？</li>
<li>接下来将结果绘图</li>
<li>要注意编译器优化带来的影响。编译器做各种聪明的事情，包括优化掉循环，如果循环中增加的变量后续没有使用，如何确保编译器不优化掉你写的TLB大小测算程序的主循环</li>
<li>还有一个需要注意的地方，今天的计算机系统大多有多个CPU，每个CPU当然有自己的TLB结构。为了得到准确的测量数据，我们只需要在一个CPU上运行程序，避免调度器把进程从一个CPU调度到另一个去运行。如何做到？（提示，在Google上搜索“pinning a thread”相关的信息）如果没有这样做，代码从一个CPU移到了另一个，会发生什么情况？</li>
<li>另一个可能发生的问题与初始化相关。如果在访问数组a之前没有初始化，第一次访问将非常耗时，由于初始访问开销，比如要求置0。这会影响你的代码及其计时吗？如何抵消这些潜在的开销？</li>
</ul>
</blockquote>
<p>先考虑一下可能遇到的这些问题：对于计时，第六章的作业已经接触过，可以用rdtsc系统调用。脚本语言自然是我最熟悉的lua了，对于计时，也许可以继续使用C的系统调用，绘图有些麻烦，可能不像py那样方便。编译器的优化问题，可以在编译时指定-O0，查看汇编代码是否有不必要的优化。CPU调度的话，pin指令已经不陌生了。初始化问题，如果没有初始化，因为很多操作都是lazy的，访问时才分配物理内存，建立映射，就增加了额外的延迟</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;x86intrin.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAGES</span> <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX</span> <span class="token expression"><span class="token number">17</span></span></span>

<span class="token keyword">int</span> a<span class="token punctuation">[</span>PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// +1好习惯</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">//初始化</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//改变步长</span>
      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//重复多次以取平均值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token punctuation">(</span>PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> time <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> N<span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"步长为%d,测量%d次取平均值，访问%d次平均用时为%lf时钟周期\n"</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i <span class="token punctuation">,</span> N <span class="token punctuation">,</span>PAGES<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>gcc tlb.c -O0 -o tlb</code>O0保证没被优化掉<br>wsl里的运行结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">步长为1,测量1000次取平均值，访问1000次平均用时为4257.000000时钟周期
步长为2,测量1000次取平均值，访问1000次平均用时为4290.000000时钟周期
步长为4,测量1000次取平均值，访问1000次平均用时为4398.000000时钟周期
步长为8,测量1000次取平均值，访问1000次平均用时为4429.000000时钟周期
步长为16,测量1000次取平均值，访问1000次平均用时为5063.000000时钟周期
步长为32,测量1000次取平均值，访问1000次平均用时为4432.000000时钟周期
步长为64,测量1000次取平均值，访问1000次平均用时为4508.000000时钟周期
步长为128,测量1000次取平均值，访问1000次平均用时为4375.000000时钟周期
步长为256,测量1000次取平均值，访问1000次平均用时为4537.000000时钟周期
步长为512,测量1000次取平均值，访问1000次平均用时为20244.000000时钟周期
步长为1024,测量1000次取平均值，访问1000次平均用时为26971.000000时钟周期
步长为2048,测量1000次取平均值，访问1000次平均用时为18894.000000时钟周期
步长为4096,测量1000次取平均值，访问1000次平均用时为20321.000000时钟周期
步长为8192,测量1000次取平均值，访问1000次平均用时为21044.000000时钟周期
步长为16384,测量1000次取平均值，访问1000次平均用时为26365.000000时钟周期
步长为32768,测量1000次取平均值，访问1000次平均用时为42513.000000时钟周期
步长为65536,测量1000次取平均值，访问1000次平均用时为86202.000000时钟周期
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>在512的位置有明显的时钟周期增长，而后趋于稳定，过大时继续明显增长</p>
<p><code>taskset -c 0 ./tlb</code>绑定CPU0<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">步长为1,测量1000次取平均值，访问1000次平均用时为4352.000000时钟周期
步长为2,测量1000次取平均值，访问1000次平均用时为4282.000000时钟周期
步长为4,测量1000次取平均值，访问1000次平均用时为4426.000000时钟周期
步长为8,测量1000次取平均值，访问1000次平均用时为4200.000000时钟周期
步长为16,测量1000次取平均值，访问1000次平均用时为4399.000000时钟周期
步长为32,测量1000次取平均值，访问1000次平均用时为4457.000000时钟周期
步长为64,测量1000次取平均值，访问1000次平均用时为4636.000000时钟周期
步长为128,测量1000次取平均值，访问1000次平均用时为4521.000000时钟周期
步长为256,测量1000次取平均值，访问1000次平均用时为4580.000000时钟周期
步长为512,测量1000次取平均值，访问1000次平均用时为18783.000000时钟周期
步长为1024,测量1000次取平均值，访问1000次平均用时为28484.000000时钟周期
步长为2048,测量1000次取平均值，访问1000次平均用时为41077.000000时钟周期
步长为4096,测量1000次取平均值，访问1000次平均用时为37400.000000时钟周期
步长为8192,测量1000次取平均值，访问1000次平均用时为35532.000000时钟周期
步长为16384,测量1000次取平均值，访问1000次平均用时为28906.000000时钟周期
步长为32768,测量1000次取平均值，访问1000次平均用时为28843.000000时钟周期
步长为65536,测量1000次取平均值，访问1000次平均用时为27293.000000时钟周期
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来是用lua控制，也就是说我需要把C的版本改成可以接受参数的，再把数组放在堆上，输出也改成平均每次访问的时钟周期<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> PAGES <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> MAX<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ……
  <span class="token keyword">double</span> time <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>N <span class="token operator">*</span> PAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"步长为%d,测量%d次取平均值，访问%d次平均每次用时为%lf时钟周期\n"</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i <span class="token punctuation">,</span> N <span class="token punctuation">,</span>PAGES<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>然后用lua控制，每次改变的是访问的数组次数<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> N <span class="token operator">=</span> <span class="token number">16</span>
<span class="token keyword">local</span> result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> N <span class="token keyword">do</span>
    <span class="token keyword">local</span> times <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i
    <span class="token keyword">local</span> cmd <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"taskset -c 0 ./tlb %d %d"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span>
    <span class="token keyword">local</span> handle <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">popen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
    <span class="token keyword">local</span> output <span class="token operator">=</span> handle<span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"*a"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>  <span class="token comment">-- 打印输出</span>
    handle<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 关闭文件句柄</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">步长为1,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为2,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为4,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为8,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为16,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为32,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为64,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为128,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为256,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为512,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为1024,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为2048,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为4096,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为8192,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为16384,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为32768,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为65536,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
……
步长为1,测量1000次取平均值，访问128次平均每次用时为4.000000时钟周期
步长为2,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为4,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为8,测量1000次取平均值，访问128次平均每次用时为4.000000时钟周期
步长为16,测量1000次取平均值，访问128次平均每次用时为4.000000时钟周期
步长为32,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为64,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为128,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为256,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为512,测量1000次取平均值，访问128次平均每次用时为13.000000时钟周期
步长为1024,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为2048,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为4096,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为8192,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为16384,测量1000次取平均值，访问128次平均每次用时为14.000000时钟周期
步长为32768,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为65536,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
……
步长为1,测量1000次取平均值，访问8192次平均每次用时为4.000000时钟周期
步长为2,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为4,测量1000次取平均值，访问8192次平均每次用时为4.000000时钟周期
步长为8,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为16,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为32,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为64,测量1000次取平均值，访问8192次平均每次用时为6.000000时钟周期
步长为128,测量1000次取平均值，访问8192次平均每次用时为19.000000时钟周期
步长为256,测量1000次取平均值，访问8192次平均每次用时为17.000000时钟周期
步长为512,测量1000次取平均值，访问8192次平均每次用时为24.000000时钟周期
步长为1024,测量1000次取平均值，访问8192次平均每次用时为38.000000时钟周期
步长为2048,测量1000次取平均值，访问8192次平均每次用时为44.000000时钟周期
步长为4096,测量1000次取平均值，访问8192次平均每次用时为40.000000时钟周期
步长为8192,测量1000次取平均值，访问8192次平均每次用时为47.000000时钟周期
步长为16384,测量1000次取平均值，访问8192次平均每次用时为54.000000时钟周期
步长为32768,测量1000次取平均值，访问8192次平均每次用时为66.000000时钟周期
步长为65536,测量1000次取平均值，访问8192次平均每次用时为85.000000时钟周期<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>分析结果的话，只访问一次也无所谓局部性了，128次在512步长处出现了明显的增长，8192次责是从128开始，后续增长也很明显</p>
<p>在不同的设备上运行：<br><code>Ubuntu</code><br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">……
步长为1,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为2,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为4,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为8,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为16,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为32,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为64,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为128,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为256,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为512,测量1000次取平均值，访问64次平均每次用时为8.000000时钟周期
步长为1024,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为2048,测量1000次取平均值，访问64次平均每次用时为23.000000时钟周期
步长为4096,测量1000次取平均值，访问64次平均每次用时为23.000000时钟周期
步长为8192,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为16384,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为32768,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为65536,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
……
步长为1,测量1000次取平均值，访问2048次平均每次用时为11.000000时钟周期
步长为2,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为4,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为8,测量1000次取平均值，访问2048次平均每次用时为6.000000时钟周期
步长为16,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为32,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为64,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为128,测量1000次取平均值，访问2048次平均每次用时为11.000000时钟周期
步长为256,测量1000次取平均值，访问2048次平均每次用时为15.000000时钟周期
步长为512,测量1000次取平均值，访问2048次平均每次用时为15.000000时钟周期
步长为1024,测量1000次取平均值，访问2048次平均每次用时为21.000000时钟周期
步长为2048,测量1000次取平均值，访问2048次平均每次用时为22.000000时钟周期
步长为4096,测量1000次取平均值，访问2048次平均每次用时为22.000000时钟周期
步长为8192,测量1000次取平均值，访问2048次平均每次用时为23.000000时钟周期
步长为16384,测量1000次取平均值，访问2048次平均每次用时为25.000000时钟周期
步长为32768,测量1000次取平均值，访问2048次平均每次用时为27.000000时钟周期
步长为65536,测量1000次取平均值，访问2048次平均每次用时为37.000000时钟周期

Killed

Segmentation fault <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>最后出现了段错误，没有那么多堆上空间分给此程序</p>
<p>然后是可视化，在本机做的,让o3用python写一个：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token triple-quoted-string string">"""
visualize_tlb.py
----------------
运行 `./tlb` 不同参数组合的测试并将结果可视化。

使用方法：
    python3 visualize_tlb.py        # 直接运行脚本即可

脚本会：
1. 按照 tlb.lua 中的逻辑，对 pages = 2**i, i = 0..13 依次调用
   `taskset -c 0 ./tlb 1000 &lt;pages>`。
2. 解析每次调用产生的输出（中文），提取步长(step_size) 和
   平均时钟周期(time)。
3. 使用 matplotlib 绘制“步长 vs 平均时钟周期”的折线图，
   不同 pages 值对应不同曲线，并自动添加图例。

注意事项：
- 需要预先安装 matplotlib: `pip install matplotlib`。
- 建议在 Linux/WSL 环境下运行；若在 Windows 原生环境运行请移除
  `taskset -c 0` 前缀或者改为相应的绑核命令。
"""</span>

<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> re
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"[错误] 未找到 matplotlib，请先执行: pip install matplotlib\n"</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 与 tlb.c 输出格式匹配的正则</span>
LINE_RE <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r"步长为(\d+).*平均每次用时为([0-9\.]+)时钟周期"</span><span class="token punctuation">)</span>

N_MEASURE <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token comment"># 与 tlb.lua 中保持一致</span>
MAX_POW   <span class="token operator">=</span> <span class="token number">13</span>    <span class="token comment"># pages = 2**i, i in [0, 13]</span>


<span class="token keyword">def</span> <span class="token function">run_tlb</span><span class="token punctuation">(</span>pages<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""运行一次 tlb 并返回标准输出。"""</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"taskset"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"./tlb"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>N_MEASURE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        completed <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> completed<span class="token punctuation">.</span>stdout
    <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>CalledProcessError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[错误] 运行 </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 失败\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">.</span>stderr<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">parse_output</span><span class="token punctuation">(</span>output<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    解析 tlb.c 的输出文本。
    返回 list[(step_size:int, time:float)]，长度应为 16 (对应 0..15 的步长指数)。
    """</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> output<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> LINE_RE<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
        <span class="token keyword">if</span> m<span class="token punctuation">:</span>
            step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            time_cycle <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> time_cycle<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> results<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"[警告] 未能解析任何数据，请检查 tlb 输出格式\n"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> results


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># pages -> list of (step, time)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>MAX_POW <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pages <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[信息] 运行 ./tlb </span><span class="token interpolation"><span class="token punctuation">&#123;</span>N_MEASURE<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>pages<span class="token punctuation">&#125;</span></span><span class="token string"> ..."</span></span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> run_tlb<span class="token punctuation">(</span>pages<span class="token punctuation">)</span>
        parsed <span class="token operator">=</span> parse_output<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">if</span> parsed<span class="token punctuation">:</span>
            <span class="token comment"># 按 step 升序排序，确保绘图时一致</span>
            parsed<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            data<span class="token punctuation">[</span>pages<span class="token punctuation">]</span> <span class="token operator">=</span> parsed

    <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"[错误] 未获取到任何数据，程序终止\n"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 绘图</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> pages<span class="token punctuation">,</span> records <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        steps<span class="token punctuation">,</span> times <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>records<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>steps<span class="token punctuation">,</span> times<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'o'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>pages<span class="token punctuation">&#125;</span></span><span class="token string"> pages'</span></span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Stride (bytes)'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Average cycles per access'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'TLB Experiment: Stride vs Access Latency'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xscale<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>yscale<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> which<span class="token operator">=</span><span class="token string">'both'</span><span class="token punctuation">,</span> ls<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 先保存图片，方便在无图形界面的环境下查看</span>
    output_png <span class="token operator">=</span> <span class="token string">'tlb.png'</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>output_png<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[信息] 图形已保存至 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>output_png<span class="token punctuation">&#125;</span></span><span class="token string">，如未弹出窗口可手动查看该文件。"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 如果图形后端支持交互，再尝试弹窗</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br> <img src="/image/tlb.png" alt=""></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OSTEP/">OSTEP</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/07/10/Docker%E4%B8%8ENAT/" title="Docker与NAT"><img class="cover" src="/image/cover22_cat.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Docker与NAT</div></div><div class="info-2"><div class="info-item-1">昨天在火山云上抢到了29/年的一台小云服务器，今天用它做一下重做一下内网穿透的实验，顺便系统学习一遍docker的使用方法 实验说明：  目标：借助云服务器完成内网穿透，学习docker的使用 技术选择：frp与vaala的开源项目frp-panel 参考资料：frp-panel的文档 与 B站上的docker入门教程 环境说明：Linux iv-ydzvaocdmobw80cjj4s4 5.15.120-5.ve2.x86_64 #1 SMP Fri Nov 15 10:09:38 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux  Docker基本概念容器：一个为特定应用程序封装的独立的运行环境，包含程序本体、依赖库和文件系统。相比于虚拟机没有操作系统部分。 镜像：容器的“安装包”，存在docker仓库以供分享，官方的仓库为dockerhub 安装Docker技术是基于Linux系统的，所以windows和Mac上需要特殊处理（运行一个linux子系统），centOS直接来即可 第0步，更新：sudo yum update 然后，curl...</div></div></div></a><a class="pagination-related" href="/2025/07/28/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="CSAPP-第四章"><img class="cover" src="/image/cover24_joy.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">CSAPP-第四章</div></div><div class="info-2"><div class="info-item-1">*4.45 在3.4.2节中，x86-64 pushq 指令被描述成要减少栈指针，然后将寄存器存储在栈指针的位置。因此，如果我们有一条指令形如对于某个寄存器 REG, pushq REG, 它等价千下面的代码序列：subq $8,%rsp  Decrement stack pointer movq REG, (%rsp)  Store REG on stackA. 借助于练习题 4.7中所做的分析，这段代码序列正确地描述了指令 pushq %rsp 的行为吗？请解释。 B. 你该如何改写这段代码序列，使得它能够像对 REG 是其他寄存器时一样，正确地描述 REG 是%rsp 的情况？  正常来说入栈是栈指针下移，把值放到栈上，但是pushq %rsp时，如果真的有这行代码，存的值是下移前还是后就产生了歧义。4.7告诉我们存的是没有减小的栈指针，所以题目所给的汇编代码是不正确的 修改的话：movq REG, (%rsp-8) subq $8,%rsp  *4.46 3.4.2节中， x86-64 popq...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/06/25/OSTEP-%E7%AC%AC%E4%BA%94%E7%AB%A0/" title="OSTEP-第五章"><img class="cover" src="/image/cover12_detective.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-25</div><div class="info-item-2">OSTEP-第五章</div></div><div class="info-2"><div class="info-item-1">第五章课后题第1题 编写一个调用 fork()的程序。在调用 fork()之前，让主进程访问一个变量（例如 x）并将其值设置为某个值（例如 100）。子进程中的变量有什么值？当子进程和父进程都改变x的值时，变量会发生什么？   x = 100是fork前的，fork后的x彼此独立#include&lt;stdio.h> #include&lt;stdlib.h> #include &lt;unistd.h>  int main()&#123;   int x ;   x = 100;   int rc = fork();   if(rc == 0)&#123;     printf("子进程的x:%d\n",x);     x = 30;     printf("子进程的新x:%d\n",x);   &#125;else if(rc > 0)&#123;     printf("父进程的x:%d\n",x);     x = 13;     printf("父进程的新x:%d\n",x);  ...</div></div></div></a><a class="pagination-related" href="/2025/06/26/OSTEP-%E7%AC%AC%E5%85%AD%E7%AB%A0/" title="OSTEP-第六章"><img class="cover" src="/image/cover13_doll.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-26</div><div class="info-item-2">OSTEP-第六章</div></div><div class="info-2"><div class="info-item-1">题目： 在这个作业中，你将测量系统调用和上下文切换的成本。测量系统调用的成本相对容易。例如，你可以重复调用一个简单的系统调用（例如，执行 0 字节读取）并记下所花的时间。将时间除以迭代次数，就可以估计系统调用的成本。 你必须考虑的一件事是时钟的精确性和准确性。你可以使用的典型时钟是 gettimeofday()。详细信息请阅读手册页。你会看到，gettimeofday()返回自 1970 年以来的微秒时间。然而，这并不意味着时钟精确到微秒。测量 gettimeofday()的连续调用，以了解时钟的精确度。这会告诉你为了获得一个好的测量结果，需要让空系统调用测试的迭代运行多少次。如果gettimeofday()对你来说不够精确，可以考虑利用 x86 机器提供的 rdtsc 指令。 测量上下文切换的成本有点棘手。lmbench 基准测试的实现方法，是在单个 CPU 上运行两个进程并在它们之间设置两个 UNIX 管道。管道只是 UNIX 系统中的进程可以相互通信的许多方式之一。第一个进程向第一个管道写入数据，然后等待第二个数据的读取。由于看到第一个进程等待从第二个管道读取的内容，OS...</div></div></div></a><a class="pagination-related" href="/2025/06/24/OSTEP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="OSTEP-第四章"><img class="cover" src="/image/cover8_soar.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-24</div><div class="info-item-2">OSTEP-第四章</div></div><div class="info-2"><div class="info-item-1">第四章课后题 课后实验在github上——指导书纯英文无汉化，罢了罢了  第1题&gt;  用以下标志运行程序：./process-run.py -l 5:100,5:100 CPU 利用率（CPU 使用时间的百分比）应该是多少？为什么你知道这一点？ 利用 -c 标记查看你的答案是否正确。  先看一眼README，说此程序是用来看进程状态是如何随着运行变化的，列出了四种状态，running ready blocked done，输入操作数和CPU占比，模拟os的实际时间片分配 回到题目，指令的意思是两个进程，各5条指令，不涉及io操作，cpu使用率还是100%Time        PID: 0        PID: 1           CPU           IOs   1        RUN:cpu         READY             1   2        RUN:cpu         READY             1   3        RUN:cpu         READY             1   4       ...</div></div></div></a><a class="pagination-related" href="/2025/06/29/OSTEP-%E7%AC%AC%E5%8D%81%E5%9B%9B%E7%AB%A0/" title="OSTEP-第十四章"><img class="cover" src="/image/cover15_ghost.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-29</div><div class="info-item-2">OSTEP-第十四章</div></div><div class="info-2"><div class="info-item-1">14.1 首先，编写一个名为null.c的简单程序，它创建一个指向整数的指针，将其设置为NULL，然后尝试对其进行释放内存操作。把它编译成一个名为null的可执行文件。当你运行这个程序时会发生什么?  #include&lt;stdio.h> #include&lt;stdlib.h>  int main() &#123;   int *null = NULL;   free(null); &#125; gcc null.c -o null ./null 什么也没发生 如果是用clion自带的构建输出，倒是会提示：cannot open output file null.exe: Invalid argument 14.2 接下来，编译该程序，其中包含符号信息(使用-g标志)。这样做可以将更多信息放入可执行文件中,使调试器可以访问有关变量名称等的更多有用信息。通过输入 gdb null,在调试器下运行该程序，然后，一旦 gdb运行，输入run。gdb显示什么信息?gcc null.c -o null -g gdb null结果是：(gdb) run Starting...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/auceptin-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Auceptin</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/auceptinFang"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">welcome to my blog! <br> Contact：me@aucept.in</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/02/03/UniCTF/" title="UniCTF 2026"><img src="/image/cover48_shooting_star.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UniCTF 2026"/></a><div class="content"><a class="title" href="/2026/02/03/UniCTF/" title="UniCTF 2026">UniCTF 2026</a><time datetime="2026-02-03T02:00:17.000Z" title="发表于 2026-02-03 10:00:17">2026-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/" title="tauri-2 自动更新"><img src="/image/cover47_puzzle.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tauri-2 自动更新"/></a><div class="content"><a class="title" href="/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/" title="tauri-2 自动更新">tauri-2 自动更新</a><time datetime="2026-01-18T15:09:19.000Z" title="发表于 2026-01-18 23:09:19">2026-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/" title="数据结构-排序实验"><img src="/image/cover44_glimpse.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构-排序实验"/></a><div class="content"><a class="title" href="/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/" title="数据结构-排序实验">数据结构-排序实验</a><time datetime="2025-12-22T05:03:55.000Z" title="发表于 2025-12-22 13:03:55">2025-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/" title="锈化的大作业"><img src="/image/cover46_pray.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="锈化的大作业"/></a><div class="content"><a class="title" href="/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/" title="锈化的大作业">锈化的大作业</a><time datetime="2025-12-16T04:11:59.000Z" title="发表于 2025-12-16 12:11:59">2025-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/12/Oauth2-%E4%B8%8E-OIDC/" title="OAuth 2.0 与 OIDC"><img src="/image/cover43_together.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OAuth 2.0 与 OIDC"/></a><div class="content"><a class="title" href="/2025/12/12/Oauth2-%E4%B8%8E-OIDC/" title="OAuth 2.0 与 OIDC">OAuth 2.0 与 OIDC</a><time datetime="2025-12-12T11:31:14.000Z" title="发表于 2025-12-12 19:31:14">2025-12-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/foot.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2025 - 2026 By Auceptin</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'AuceptinFang/blog',
      'data-repo-id': 'R_kgDOO_UAjA',
      'data-category-id': 'DIC_kwDOO_UAjM4Cr3mL',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script>
  // 动态切换代码高亮主题
  function switchPrismTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const lightTheme = document.getElementById('prism-light-theme');
    const darkTheme = document.getElementById('prism-dark-theme');
    
    if (lightTheme && darkTheme) {
      lightTheme.disabled = isDark;
      darkTheme.disabled = !isDark;
    }
  }
  
  // 页面加载时执行
  document.addEventListener('DOMContentLoaded', switchPrismTheme);
  
  // 监听主题切换
  const observer = new MutationObserver(switchPrismTheme);
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>
<script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>